(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{368:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-ç®€è¿°"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-ç®€è¿°"}},[t._v("#")]),t._v(" 1. ç®€è¿°")]),t._v(" "),s("p",[t._v("JUC åŒ…ä¸‹çš„å¾ˆå¤šç±»éƒ½ä¾é  AQSï¼Œåœ¨çŸ¥é“ AQS æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ä¹‹åï¼Œæˆ‘ä¸€åº¦ä»¥ä¸º "),s("code",[t._v("AQSæ˜¯JUCçš„åŸºçŸ³")]),t._v(" è¿™å¥è¯çš„æ„æ€æ˜¯ï¼šJUCåŒ…ä¸‹å¾ˆå¤šç±»éƒ½å®ç°/ç»§æ‰¿äº† AQSï¼Œæ¯”å¦‚ ReentrantLock å®ç°äº† AQS... ä½†æ˜¯æˆ‘é”™äº†ã€‚")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230726160739381.png",alt:"image-20230726160739381"}})]),t._v(" "),s("p",[t._v("å¯ä»¥çœ‹åˆ°ï¼ŒAQS æœ‰å¾ˆå¤šåä¸º "),s("code",[t._v("Sync")]),t._v("çš„å®ç°ç±»ï¼Œè¿™äº› Sync åˆ†å¸ƒåœ¨ä¸åŒçš„ç±»ä¸­ï¼Œé‚£ä¹ˆ  "),s("code",[t._v("AQSæ˜¯JUCçš„åŸºçŸ³")]),t._v(" çš„æ„æ€å°±åº”è¯¥æ˜¯ï¼š"),s("strong",[t._v("å½“ä¸€ä¸ªå·¥å…·ç±»æƒ³è¦ä½¿ç”¨ AQS æä¾›çš„åŸºæœ¬åŠŸèƒ½æ—¶ï¼Œä¼šå†™ä¸€ä¸ªå†…éƒ¨ç±» Sync ç»§æ‰¿ AQS")]),t._v("ã€‚")]),t._v(" "),s("p",[t._v("å†æ¬¡å¼ºè°ƒ ï¼š"),s("font",{attrs:{color:"green"}},[s("strong",[t._v("AQS æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæ²¡æœ‰åŠ é”åŠŸèƒ½")])]),t._v("ã€‚å®ƒçš„è®¸å¤šå®ç°ç±»ï¼ˆå¤§å¤šå«åš Syncï¼‰å®ç°äº†åŠ é”åŠŸèƒ½ï¼Œæ¯”å¦‚å…¬å¹³åŠ é”ã€éå…¬å¹³åŠ é”ã€åŠ è¯»å†™é”ã€åŠ å…¬å¹³é”.....")],1),t._v(" "),s("p",[t._v("AQS æä¾›äº†ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ"),s("font",{attrs:{color:"green"}},[s("strong",[t._v("å¦‚æœæ²¡æœ‰æŠ¢åˆ°é”å°±ä¼šè®©çº¿ç¨‹é˜»å¡ç­‰å¾…")])]),t._v("ã€‚")],1),t._v(" "),s("p",[t._v("å½“æŸä¸ªç±»æƒ³è¦ä½¿ç”¨ AQS æä¾›çš„åŸºæœ¬åŠŸèƒ½æ—¶ï¼Œåªéœ€è¦ç»§æ‰¿å®ƒå¹¶å®ç°é‚£äº›è¿˜æ²¡æœ‰å®ç°çš„æ–¹æ³•å°±å¯ä»¥ï¼Œè¿™æ˜¯å…¸å‹çš„"),s("code",[t._v("æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼")]),t._v("ã€‚")]),t._v(" "),s("p",[t._v("AQS æœ¬èº«æ²¡æœ‰æŠ¢é”åŠŸèƒ½ï¼Œå¤§å¤šæ•°æ–‡ç« ä¼šä» ReentrantLock å…¥æ‰‹ï¼Œä½†æ˜¯è¿™ä¼šè®©è¯»è€…ä¹±å¥—ï¼Œåˆå­¦è€…å¾ˆå®¹æ˜“å¯¹ ReentrantLock ä¸ AQS è¿·è¿·ç³Šç³Šåˆ†ä¸æ¸…ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¼šæŠ½è±¡è¡¨è¾¾ â€œåŠ é”â€ è¿™ä¸ªæ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯ä¸è®²è§£åŠ é”åŠŸèƒ½ï¼Œè€Œæ˜¯ç®€ç•¥çš„ä»¥ â€œæŸçº¿ç¨‹æŠ¢é”å¤±è´¥â€ æ¥è¡¨è¾¾ã€‚")]),t._v(" "),s("p",[t._v("ç­‰æŠŠ AQS æä¾›çš„åŠŸèƒ½ä»‹ç»æ¸…æ¥šäº†å†ä»‹ç» ReentrantLockã€CountDownLatch å¯¹å®ƒçš„å®ç°ã€‚")]),t._v(" "),s("h2",{attrs:{id:"_2-aqs-çš„ä¸€äº›é‡è¦å±æ€§"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-aqs-çš„ä¸€äº›é‡è¦å±æ€§"}},[t._v("#")]),t._v(" 2. AQS çš„ä¸€äº›é‡è¦å±æ€§")]),t._v(" "),s("h3",{attrs:{id:"_2-1-node"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-node"}},[t._v("#")]),t._v(" 2.1 Node")]),t._v(" "),s("p",[t._v("ç°åœ¨å¯ä»¥æŠ½ç©ºçœ‹ä¸€ä¸‹ç›®å½•ï¼Œæ˜¯ä¸æ˜¯æœ‰"),s("code",[t._v("åŒæ­¥é˜Ÿåˆ—")]),t._v("å’Œ"),s("code",[t._v("ç­‰å¾…é˜Ÿåˆ—")]),t._v("è¿™ä¸¤ä¸ªå°æ ‡é¢˜ï¼Ÿè¿™ä¸ªNodeç±»å°±æ˜¯ç»„æˆåŒæ­¥é˜Ÿåˆ—å’Œé˜»å¡é˜Ÿåˆ—çš„èŠ‚ç‚¹ã€‚åŸæœ¬æƒ³è¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç›´æ¥å°† Node å¼•å‡ºï¼Œä½†æ˜¯ä¼šå› æ­¤è®©æ–‡ç« å˜å¾—æ··ä¹±ï¼Œæ‰€ä»¥æˆ‘å†³å®šå…ˆä»‹ç»Nodeã€‚")]),t._v(" "),s("p",[t._v("AQSä¸­æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼š"),s("code",[t._v("Node")]),t._v("ã€‚è¿™ä¸ªNodeå¯ä»¥æŠ½è±¡ä¸ºçº¿ç¨‹ï¼Œä¹Ÿè®¸è¯´å®ƒå°±ä»£è¡¨ç€çº¿ç¨‹æ›´åŠ å¦¥å½“ã€‚")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤Nodeä»£è¡¨çš„çº¿ç¨‹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),t._v(" thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pre å’Œ next æ„æˆäº†åŒå‘é“¾è¡¨ï¼Œç»„æˆAQSçš„åŒæ­¥é˜Ÿåˆ—")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤Nodeçš„å‰ä¸€ä¸ªç»“ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" prev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤Nodeçš„åä¸€ä¸ªèŠ‚ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// nextWaiter æ„æˆäº†å•å‘é“¾è¡¨ï¼Œç»„æˆäº†AQSçš„ç­‰å¾…é˜Ÿåˆ—")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" nextWaiter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// èŠ‚ç‚¹çš„çŠ¶æ€")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" waitStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ul",[s("li",[t._v("next å’Œ prev ç”¨äºå®ç°åŒæ­¥é˜Ÿåˆ—ï¼ˆåŸºäºåŒå‘é“¾è¡¨ï¼‰")]),t._v(" "),s("li",[t._v("nextWaiter ç”¨äºå®ç°ç­‰å¾…é˜Ÿåˆ—ï¼ˆåŸºäºå•é“¾è¡¨ï¼‰ï¼Œè¿™ä¸ª nextWaiter ç”¨äº Condition.await()")])]),t._v(" "),s("p",[t._v("å› ä¸º Node ä»£è¡¨ç€çº¿ç¨‹ï¼Œæ‰€ä»¥å®ƒæä¾›äº†å‡ ä¸ªçŠ¶æ€å€¼æ¥ä»£è¡¨çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ ï¼š")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Nodeçš„çŠ¶æ€é»˜è®¤ä¸º 0")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤ä»»åŠ¡å·²å–æ¶ˆ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CANCELLED")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‚èµ·äº†")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SIGNAL")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å½“å‰èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CONDITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸å…±äº«æ¨¡å¼ç›¸å…³ï¼Œåœ¨å…±äº«æ¨¡å¼ä¸­ï¼Œè¯¥çŠ¶æ€æ ‡è¯†ç»“ç‚¹çš„çº¿ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€ã€‚")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PROPAGATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("è°æ‹¥æœ‰è¿™äº›çŠ¶æ€å€¼å‘¢ï¼Ÿ"),s("strong",[t._v("waitStatus")])]),t._v(" "),s("p",[t._v("çº¿ç¨‹éƒ½æ˜¯ä»¥ Node å½¢å¼ä¿å­˜åœ¨ AQS ä¸­çš„ï¼ŒNodeä¸­æä¾›äº†å‡ ç§çŠ¶æ€ä¾›çº¿ç¨‹ä½¿ç”¨ï¼Œä¾‹å¦‚ å·²å–æ¶ˆï¼ˆ1ï¼‰ã€é»˜è®¤ï¼ˆ0ï¼‰ã€æŒ‚èµ·ï¼ˆ-1ï¼‰ã€ç­‰å¾…ï¼ˆ-2ï¼‰....")]),t._v(" "),s("p",[t._v("åŒæ—¶ï¼Œå¦‚æœä½ æ­£åœ¨çœ‹æºç ï¼Œè¿˜ä¼šçœ‹åˆ°ä¸¤ä¸ªå±æ€§ :")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å…±äº«æ¨¡å¼")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SHARED")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç‹¬å æ¨¡å¼")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("EXCLUSIVE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("SHARED å’Œ EXCLUSIVE ä¸¤ä¸ªå•è¯çš„æ„æ€å¾ˆæ˜æ˜¾ ï¼šå…±äº«å’Œç‹¬å ã€‚")]),t._v(" "),s("ol",[s("li",[t._v("ç‹¬å æ¨¡å¼å³å½“é”è¢«æŸä¸ªçº¿ç¨‹æˆåŠŸè·å–æ—¶ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å–åˆ°è¯¥é”ï¼Œ"),s("strong",[t._v("åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‹¿åˆ°é”æ‰§è¡Œ")]),t._v("ï¼Œé”çš„çŠ¶æ€åªæœ‰0å’Œ1ä¸¤ç§æƒ…å†µã€‚ä¾‹å¦‚ ReentrantLockï¼Œä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å·¥ä½œã€‚")]),t._v(" "),s("li",[t._v("å…±äº«æ¨¡å¼å³å½“é”è¢«æŸä¸ªçº¿ç¨‹æˆåŠŸè·å–æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä»ç„¶å¯èƒ½è·å–åˆ°è¯¥é”ï¼Œ"),s("strong",[t._v("åŒä¸€æ—¶é—´æœ‰å¤šä¸ªçº¿ç¨‹å¯ä»¥æ‹¿åˆ°é”ååŒå·¥ä½œ")]),t._v("ï¼Œé”çš„çŠ¶æ€å¤§äºæˆ–ç­‰äº0ã€‚ä¾‹å¦‚ CountDownLatchï¼Œä¸€æ¬¡å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å·¥ä½œã€‚")])]),t._v(" "),s("h3",{attrs:{id:"_2-2-åŒæ­¥é˜Ÿåˆ—"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-åŒæ­¥é˜Ÿåˆ—"}},[t._v("#")]),t._v(" 2.2 åŒæ­¥é˜Ÿåˆ—")]),t._v(" "),s("p",[t._v("è¿™ä¸ªåŒæ­¥é˜Ÿåˆ—æ˜¯ç”±åŒå‘é“¾è¡¨å®ç°çš„ã€‚ä»ä¸Šé¢æ‰€è¯´çš„å¯ä»¥çŸ¥é“ï¼ŒAQSä¸­çš„åŒæ­¥é˜Ÿåˆ—æ˜¯ç”±Nodeç»„æˆã€Nodeä¸­çš„prevå’Œnextè¿æ¥ã€‚")]),t._v(" "),s("p",[t._v("åªæœ‰èŠ‚ç‚¹è‚¯å®šä¸è¡Œï¼ŒAQSä¸­æœ‰ä¸¤ä¸ªå±æ€§æ§åˆ¶è¿™ä¸ªåŒå‘é“¾è¡¨ï¼Œhead å’Œ tail ã€‚å³å¤´å’Œå°¾ã€‚å¤´æ˜¯ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå®ƒé‡Œé¢çš„ threadå˜é‡ ä¸€ç›´æ˜¯NULLå¹¶ä¸ä¼šä»£è¡¨å“ªä¸ªçº¿ç¨‹ï¼›å°¾æ˜¯æœ‰å…·ä½“æ„ä¹‰çš„ï¼Œä¼šä»£è¡¨æŸä¸€ä¸ªçº¿ç¨‹ã€‚å³ï¼šå¤´èŠ‚ç‚¹æ— æ„ä¹‰ï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½ä»£è¡¨ä¸€ä¸ªçº¿ç¨‹ã€‚")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230726171337940.png",alt:"åŒæ­¥é˜Ÿåˆ—"}})]),t._v(" "),s("p",[t._v("æ³¨æ„å–½ï¼ŒåŒæ­¥é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹æ˜¯æ— æ„ä¹‰çš„ï¼Œçº¿ç¨‹å°è£…çš„èŠ‚ç‚¹ä¸èƒ½æˆä¸ºå¤´èŠ‚ç‚¹ï¼Œåªèƒ½æˆä¸ºå¤´èŠ‚ç‚¹åçš„èŠ‚ç‚¹ã€‚")]),t._v(" "),s("h3",{attrs:{id:"_2-3-ç­‰å¾…é˜Ÿåˆ—"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-ç­‰å¾…é˜Ÿåˆ—"}},[t._v("#")]),t._v(" 2.3 ç­‰å¾…é˜Ÿåˆ—")]),t._v(" "),s("p",[t._v("Nodeç»„æˆç­‰å¾…é˜Ÿåˆ—ï¼ŒNodeä¸­çš„"),s("code",[t._v("nextWaiter")]),t._v("è¿æ¥æˆä¸ºç­‰å¾…é˜Ÿåˆ—ã€‚")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230726172213584.png",alt:"image-20230726172213584"}})]),t._v(" "),s("p",[t._v("å¥‡æ€ªçš„æ˜¯ï¼Œå½“æˆ‘åœ¨AQSä¸­å¯»æ‰¾ä¸ç®¡ç†åŒæ­¥é˜Ÿåˆ—çš„headå’Œtailç±»ä¼¼çš„å±æ€§æ—¶å¹¶æ²¡æœ‰æ‰¾åˆ°ï¼Œä½†æˆ‘è¿˜æ˜¯æ‰¾åˆ°äº†ç®¡ç†ç­‰å¾…é˜Ÿåˆ—çš„å±æ€§ï¼š"),s("code",[t._v("firstWaiter")]),t._v("ã€"),s("code",[t._v("lastWaiter")])]),t._v(" "),s("p",[t._v("å®ƒåœ¨AQSå¦ä¸€ä¸ªå†…éƒ¨ç±»ä¸­ ï¼š"),s("code",[t._v("ConditionObject")]),t._v("ã€‚")]),t._v(" "),s("p",[t._v("è¯´æ¥ä¹Ÿæ˜¯ï¼Œå°± â€œç­‰å¾…é˜Ÿåˆ—â€ è¿™ä¸ªè¯è€Œè¨€ï¼Œ"),s("code",[t._v("ç­‰å¾…")]),t._v("è‚¯å®šæ˜¯å®ƒçš„ä¸€å¤§ç‰¹ç‚¹ã€‚é‚£ä¹ˆå¦‚ä½•å®ç°ç­‰å¾…ï¼Ÿä¸€ä¸ªæ˜¯Objectç±»ä¸­çš„waitæ–¹æ³•ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ Condition çš„ await æ–¹æ³•ã€‚é‚£ä¹ˆå°±å¥½è§£é‡Šäº†ï¼š")]),t._v(" "),s("blockquote",[s("p",[t._v("ConditionObject æä¾›äº†è®© Node ç­‰å¾…çš„æ–¹æ³•ï¼Œä¾‹å¦‚ awaitã€signal...é€šè¿‡ Node.nextWaiter å°†çº¿ç¨‹ä¸²ä¸ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶ä¸”ä½¿ç”¨ firstWaiter å’Œ lastWaiter æ§åˆ¶/ç®¡ç† ç­‰å¾…é˜Ÿåˆ—ã€‚")])]),t._v(" "),s("p",[t._v("æ³¨æ„å–½ï¼Œç­‰å¾…é˜Ÿåˆ—çš„ firstWaiter å¯ä¸æ˜¯æ— æ„ä¹‰çš„å“¦ï¼Œçº¿ç¨‹å°è£…ä¸º Node åå¯ä»¥æˆä¸º firstWaiter")]),t._v(" "),s("h3",{attrs:{id:"_2-4-stateçŠ¶æ€å€¼"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-stateçŠ¶æ€å€¼"}},[t._v("#")]),t._v(" 2.4 stateçŠ¶æ€å€¼")]),t._v(" "),s("p",[t._v("è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å±æ€§ã€‚")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" state"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("æ¯•ç«ŸAQSæä¾›çš„æ˜¯å¹¶å‘æ”¯æŒï¼Œæœ‰å¹¶å‘å°±è¦æœ‰é”ï¼Œé‚£ä¹ˆä¸€ä¸ªçº¿ç¨‹æ€æ ·æ‰ç®—æ‹¿åˆ°é”å‘¢ï¼Ÿ")]),t._v(" "),s("p",[t._v("state ä¸ä¸º 0 çš„æ—¶å€™è¯æ˜è¿™ä¸ªé”è¢«å æœ‰äº†ã€‚")]),t._v(" "),s("p",[t._v("åŒæ—¶ï¼Œç”±äº AQS å¹¶æ²¡æœ‰è¦æ±‚å®ç°ç±»å¿…é¡»æ€æ ·æ€æ ·ï¼Œæ‰€ä»¥å®ç°ç±»ä»¬ä¹ŸæŠŠ state ç”¨çš„èŠ±é‡Œèƒ¡å“¨ï¼Œä¾‹å¦‚ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("åœ¨ ReentrantLock ä¸­ï¼Œstate ä¸º 0 ä»£è¡¨é”è¿˜æœªè¢«å æœ‰ï¼Œå¦‚æœä¸º 1 ä»£è¡¨è¢«å æœ‰ï¼Œå¦‚æœå¤§äº 1 ä»£è¡¨é‡å…¥ã€‚")]),t._v(" "),s("li",[t._v("åœ¨ CountDownLatch ä¸­ï¼Œstate ä»£è¡¨ç€ä»»åŠ¡æ•°é‡ã€‚")]),t._v(" "),s("li",[t._v("åœ¨ ReentrantReadWriteLock ä¸­ï¼Œå°† state çš„ 32 ä¸ªå­—èŠ‚å‡åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†è¡¨ç¤ºè¯»é”ï¼Œä¸€éƒ¨è¡¨ç¤ºå†™é”ã€‚")])]),t._v(" "),s("h3",{attrs:{id:"_2-5-å°ç»“"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-å°ç»“"}},[t._v("#")]),t._v(" 2.5 å°ç»“")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("AQSæœ‰ä¸¤ä¸ªé‡è¦çš„å±æ€§ï¼šNodeå’Œstateã€‚")])]),t._v(" "),s("li",[s("p",[t._v("state æ˜¯çŠ¶æ€å€¼ï¼Œä¸€èˆ¬æ¥è¯´ä»£è¡¨é”æ˜¯å¦è¢«æŒæœ‰ï¼Œä¸è¿‡å…·ä½“å«ä¹‰è¦çœ‹å®ç°ç±»å¦‚ä½•æ“ä½œã€‚")])]),t._v(" "),s("li",[s("p",[t._v("å…±äº«å’Œç‹¬å  ï¼šå…±äº«æ˜¯å…è®¸å¤šä¸ªçº¿ç¨‹å…±åŒæ‰§è¡Œä»»åŠ¡ï¼Œç‹¬å æ˜¯åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ")])]),t._v(" "),s("li",[s("p",[t._v("Nodeï¼šæ˜¯çº¿ç¨‹çš„ä»£è¡¨ï¼Œçº¿ç¨‹ä¼šè¢«å°è£…ä¸ºNodeåœ¨AQSä¸­å­˜åœ¨ã€‚")]),t._v(" "),s("p",[t._v("Nodeä¸­æœ‰ä¸‰ä¸ªå±æ€§ï¼šnextã€prevã€nextWaiterã€‚")]),t._v(" "),s("ul",[s("li",[t._v("nextå’Œprevè¿æ¥Nodeæˆä¸º"),s("code",[t._v("åŒæ­¥é˜Ÿåˆ—")]),t._v("ã€‚æ§åˆ¶åŒæ­¥é˜Ÿåˆ—çš„å±æ€§ head å’Œ tail åœ¨AQSä¸­ã€‚")]),t._v(" "),s("li",[t._v("nextWaiterè¿æ¥Nodeæˆä¸º"),s("code",[t._v("ç­‰å¾…é˜Ÿåˆ—")]),t._v("ã€‚æ§åˆ¶ç­‰å¾…é˜Ÿåˆ—çš„å±æ€§ firstWaiter å’Œ lastWaiter åœ¨ ConditionObject ä¸­ï¼ˆAQSçš„å†…éƒ¨ç±»ï¼‰")]),t._v(" "),s("li",[t._v("ï¼ˆè‡³äºåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—åˆ°åº•æœ‰ä»€ä¹ˆç”¨ï¼Œæˆ‘æƒ³åœ¨åç»­æ…¢æ…¢å±•å¼€ã€‚ï¼‰")])])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20230726212426652.png",alt:"image-20230726212426652"}})]),t._v(" "),s("h2",{attrs:{id:"_3-çº¿ç¨‹åŠ é”å¤±è´¥å"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-çº¿ç¨‹åŠ é”å¤±è´¥å"}},[t._v("#")]),t._v(" 3. çº¿ç¨‹åŠ é”å¤±è´¥å")]),t._v(" "),s("p",[t._v("åœ¨ä¸Šé¢è¯´è¿‡ï¼ŒAQS è‡ªèº«å¹¶ä¸æä¾›åŠ é”åŠŸèƒ½ï¼Œè€Œæ˜¯å®ç°äº†åŠ é”å¤±è´¥åçš„é€»è¾‘ã€‚è¿™ä¹ˆåšæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ")]),t._v(" "),s("p",[t._v("ç¨‹åºå‘˜å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡ŒåŠ é”ï¼Œæ¯”å¦‚ä»¥ä¸‹å„ç§é”å®ç°æ—¶ï¼Œæƒ³è¦åŠ é”è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("ä¸å¯é‡å…¥é” ï¼šé”ä¸è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰æ—¶æ‰èƒ½åŠ é”æˆåŠŸ")]),t._v(" "),s("li",[t._v("å¯é‡å…¥é” ï¼šé”ä¸è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ï¼Œä½†æ˜¯å¦‚æœæ˜¯è‡ªå·±æŒæœ‰ï¼Œè¿˜å¯ä»¥åŠ é”")]),t._v(" "),s("li",[t._v("å…¬å¹³é” ï¼šçº¿ç¨‹æŠ¢é”ä¹‹å‰å…ˆçœ‹çœ‹æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ç­‰å¾…ï¼Œæ²¡æœ‰å†æŠ¢é”ï¼Œæœ‰å°±è·Ÿåœ¨ä»–ä»¬åé¢")]),t._v(" "),s("li",[t._v("éå…¬å¹³é” ï¼šç®¡å®ƒå‘¢ç›´æ¥æŠ¢ï¼ŒæŠ¢ä¸åˆ°å†è¯´")]),t._v(" "),s("li",[t._v("è¯»å†™é” ï¼šè¯»é”å¯å…±äº«ï¼Œå†™é”éœ€æ’æ–¥ã€‚")])]),t._v(" "),s("p",[t._v("å¦‚æœæ²¡æœ‰ AQSï¼Œè¿™äº›é”åœ¨å®ç°çš„æ—¶å€™éƒ½è¦å†™ä¸€é â€œçº¿ç¨‹æŠ¢é”å¤±è´¥åéœ€è¦é˜»å¡ç­‰å¾…â€ çš„é€»è¾‘ï¼Œä»£ç å¤ªå†—ä½™äº†ï¼AQS å¤§æ‰‹ä¸€æŒ¥ï¼Œæˆ‘å¸®ä½ ä»¬å®ç°ï¼Œç¨‹åºå‘˜åªè¦æ ¹æ®ç°åœ¨çš„æƒ…å†µåˆ¤æ–­æ˜¯å¦æŠ¢é”æˆåŠŸå°±è¡Œäº†ï¼ŒæŠ¢é”å¤±è´¥çš„çº¿ç¨‹äº¤ç»™æˆ‘ã€‚")]),t._v(" "),s("p",[t._v("é‚£ä¹ˆç°åœ¨å°±æ¥çœ‹çœ‹ AQS å¦‚ä½•å¯¹å¾…æŠ¢é”å¤±è´¥çš„çº¿ç¨‹çš„å§ã€‚")]),t._v(" "),s("p",[t._v("AQS éœ€è¦å®ƒçš„å­ç±»å®ç°çš„æ–¹æ³•æ˜¯ ï¼štryAcquire()ï¼Œä¹Ÿå°±æ˜¯å°è¯•è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸäº†å°±æ²¡ AQS è¦å¹²çš„äº‹äº†ï¼Œä½†æ˜¯å¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆå°±è¦å¤„ç†å½“å‰çº¿ç¨‹äº†ï¼š")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("acquire")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// tryAcquireè®©å­ç±»å»å®ç°")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœè·å–é”å¤±è´¥ï¼Œæ‰§è¡Œåé¢çš„é€»è¾‘")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tryAcquire")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å°†çº¿ç¨‹é˜»å¡")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("acquireQueued")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addWaiter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("EXCLUSIVE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// é˜»å¡åœæ­¢åï¼Œè°ƒç”¨è¯¥çº¿ç¨‹çš„ interruptæ–¹æ³•")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("selfInterrupt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("tryAcquire æ–¹æ³•ç”±å­ç±»å®ç°ï¼Œé‚£ä¹ˆç°åœ¨æ¥çœ‹çœ‹ addWaiter ä¸ acquireQueued è¿™ä¸¤ä¸ªæ–¹æ³•")]),t._v(" "),s("ol",[s("li",[t._v("addWaiter ï¼šå°†å½“å‰çº¿ç¨‹å°è£…ä¸º Node å¹¶æ”¾å…¥åŒæ­¥é˜Ÿåˆ—")]),t._v(" "),s("li",[t._v("acquireQueued ï¼š")])]),t._v(" "),s("h3",{attrs:{id:"_3-1-å°†å½“å‰çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-å°†å½“å‰çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—"}},[t._v("#")]),t._v(" 3.1 å°†å½“å‰çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—")]),t._v(" "),s("p",[t._v("æ­¥éª¤åˆ†ä¸ºä¸¤å¤§æ­¥ï¼šæ„å»ºä¸€ä¸ª Nodeã€æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚")]),t._v(" "),s("p",[t._v("ä½ æƒ³æŠŠä¸€ä¸ª Node æ”¾åˆ°åŒå‘é“¾è¡¨çš„å°¾éƒ¨ï¼Œå¤§æŠµæ˜¯è¿™ä¸‰æ­¥ï¼š")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("tail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nnode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pre "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nnode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tail\n")])])]),s("p",[t._v("ä¹Ÿå°±æ˜¯å°†é“¾è¡¨å°¾èŠ‚ç‚¹çš„ next æŒ‡é’ˆæŒ‡å‘è‡ªå·±ï¼Œè‡ªå·±çš„ pre æŒ‡é’ˆæŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œæœ€åè‡ªå·±å˜æˆäº†å°¾èŠ‚ç‚¹ã€‚")]),t._v(" "),s("p",[t._v("ä½†æ˜¯æ”¾å…¥é˜Ÿåˆ—å°¾éƒ¨è¿™ä¸ªåŠ¨ä½œè¯´å¾—è½»å·§ï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™é‡Œï¼Œå½“å¤šä¸ª Node æƒ³è¦æŒ‚åœ¨åŒä¸€ä¸ªå°¾èŠ‚ç‚¹ä¸Šæ—¶ï¼Œä¼šå‡ºç°å¹¶å‘æƒ…å†µã€‚ä½†æ˜¯æˆ‘æ‡’å¾—ç”»å›¾äº†ğŸ˜œ")]),t._v(" "),s("p",[t._v("AQS è§£å†³å¹¶å‘æƒ…å†µæ˜¯è¿™æ ·åšçš„ ï¼šå…ˆå°† node.pre = tailï¼Œå†ä½¿ç”¨ CAS å°† node æˆä¸ºå°¾èŠ‚ç‚¹ï¼Œæœ€åå°† node.pre.next = nodeï¼Œå¦‚æœ CAS å¤±è´¥ï¼Œè¯´æ˜ç°åœ¨å‡ºç°å¹¶å‘æƒ…å†µäº†ï¼Œåˆ«çš„çº¿ç¨‹æŠ¢å…ˆä¸€æ­¥å°† Node å˜æˆäº†å°¾èŠ‚ç‚¹ï¼Œæ­¤çº¿ç¨‹çš„ node åªèƒ½æŒ‚åœ¨é‚£ä¸ª node åé¢äº†ã€‚")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è°ƒç”¨æ¥æº : addWaiter(Node.EXCLUSIVE)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä½¿ç”¨ Node.EXCLUSIVE ä½œä¸º mode çš„å…¥å‚ï¼Œmodeä¸ºç©ºã€‚")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addWaiter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" mode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†æ­¤çº¿ç¨‹å°è£…ä¸ºç‹¬å æ¨¡å¼çš„ Node")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" node "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentThread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è·å–é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" pred "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pred "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœå°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼ŒæŠŠæ­¤èŠ‚ç‚¹æŒ‚åœ¨å°¾èŠ‚ç‚¹åé¢")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// é¦–å…ˆæ‰§è¡Œ node.pre = pred")]),t._v("\n        node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prev "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pred"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç„¶åä½¿ç”¨CASçš„æ–¹å¼å°†nodeè®¾ç½®ä¸ºå°¾èŠ‚ç‚¹")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœè®¾ç½®æˆåŠŸï¼Œå°±å¯ä»¥å°†ä¹‹å‰å°¾èŠ‚ç‚¹çš„nextæŒ‡å‘ç°åœ¨çš„å°¾èŠ‚ç‚¹: pred.next = node")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSetTail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pred"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            pred"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸€èˆ¬æƒ…å†µä¸‹ä¼šåœ¨è¿™é‡Œreturn")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœå‰é¢æ²¡æœ‰returnï¼Œè¯´æ˜ä»€ä¹ˆï¼Ÿ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¯´æ˜CASå¤±è´¥äº†ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†å¹¶å‘è®¾ç½®å°¾èŠ‚ç‚¹çš„æƒ…å†µï¼Œå³: å¤šä¸ªçº¿ç¨‹è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œè¿™ä¸ªçº¿ç¨‹è®¾ç½®å¤±è´¥äº†ã€‚")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è™½ç„¶å¤±è´¥äº†ï¼Œé‚£è¿™ä¸ªèŠ‚ç‚¹å¯ä»¥æŒ‚åœ¨æ–°æ¥çš„å°¾èŠ‚ç‚¹ä¸Šå•Š~ ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å°±æ˜¯å°†æ­¤èŠ‚ç‚¹æŒ‚åœ¨æ–°æ¥çš„å°¾èŠ‚ç‚¹ä¸Šï¼Œå°±ä¸å†è¯¦ç»†è§£é‡Šäº†")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enq")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç”¨ CAS å°†å°¾èŠ‚ç‚¹çš„å€¼ä» expect æ¢æˆ update")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSetTail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" expect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" unsafe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSwapObject")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tailOffset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" expect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_3-2-å°†å½“å‰çº¿ç¨‹é˜»å¡"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-å°†å½“å‰çº¿ç¨‹é˜»å¡"}},[t._v("#")]),t._v(" 3.2 å°†å½“å‰çº¿ç¨‹é˜»å¡")]),t._v(" "),s("p",[t._v("æ­¤æ—¶ï¼Œnode å·²ç»æˆä¸ºåŒæ­¥é˜Ÿåˆ—ä¸­çš„å°¾èŠ‚ç‚¹äº†ï¼Œä½†æ˜¯çº¿ç¨‹è¿˜æ²¡æœ‰é˜»å¡ï¼ŒAQS è¦åšçš„å°±æ˜¯è®©æŠ¢é”å¤±è´¥çš„çº¿ç¨‹é˜»å¡ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•è‡³å…³é‡è¦ã€‚")]),t._v(" "),s("p",[t._v("ä¸€ä¸Šæ¥å°±æ˜¯æ­»å¾ªç¯ï¼Œå½“å‰èŠ‚ç‚¹è™½ç„¶æ˜¯å°¾èŠ‚ç‚¹ï¼Œä½†æ˜¯å¦‚æœå®ƒçš„ pre æ˜¯å¤´èŠ‚ç‚¹ä»£è¡¨å•¥ï¼Ÿä»£è¡¨åŒæ­¥é˜Ÿåˆ—ä¸­åªæœ‰å®ƒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£æˆ‘å°±å¾—é‡æ–°æŠ¢ä¸€ä¸‹é”äº†ï¼Œå¦‚æœæŠ¢å¤±è´¥äº†æˆ‘å†é˜»å¡ã€‚")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("acquireQueued")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" failed "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" interrupted "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ‹¿åˆ°å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœæ˜¯headèŠ‚ç‚¹ï¼Œå¯ä»¥å°è¯•æŠ¢ä¸€ä¸‹é”")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("predecessor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹ï¼Œå°è¯•æŠ¢é”")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" head "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tryAcquire")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å¦‚æœæŠ¢é”æˆåŠŸï¼Œå°†æ­¤èŠ‚ç‚¹å˜æˆheadå‚€å„¡èŠ‚ç‚¹")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// setHead() æ–¹æ³•é¦–å…ˆä¼šå°† Nodeå†…éƒ¨çš„çº¿ç¨‹ç½®ä¸ºç©ºï¼Œä¸ºå•¥ç½®ä¸ºç©ºï¼Ÿ")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// éƒ½æŠ¢åˆ°é”äº†ï¼Œè¿™ä¸ªçº¿ç¨‹è‚¯å®šä¸éœ€è¦å­˜åœ¨äºAQSä¸­äº†ã€‚")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHead")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¹‹å‰çš„headèŠ‚ç‚¹ç½®ä¸ºç©ºï¼Œæ–¹ä¾¿GC")]),t._v("\n                p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n                failed "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" interrupted"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€…æŠ¢é”å¤±è´¥ï¼Œå°†å½“å‰çº¿ç¨‹ park èµ·æ¥")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ£€æŸ¥ä¸€ä¸‹èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœå·²å–æ¶ˆå°±æ²¡å¿…è¦é˜»å¡ç­‰å¾…")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("shouldParkAfterFailedAcquire")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿™ä¸ªæ–¹æ³•å°†å½“å‰çº¿ç¨‹parkèµ·æ¥")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parkAndCheckInterrupt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n               "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                interrupted "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("failed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cancelAcquire")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†nodeå†…éƒ¨çš„çº¿ç¨‹ç½®ä¸ºç©ºï¼Œå˜æˆæ— æ„ä¹‰çš„ head èŠ‚ç‚¹")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setHead")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    head "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("thread "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prev "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†å½“å‰çº¿ç¨‹parkèµ·æ¥")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parkAndCheckInterrupt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// â˜… çº¿ç¨‹é˜»å¡åœ¨æ­¤å¤„ç­‰å¾…å”¤é†’ ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LockSupport")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("park")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿”å›å¯¹åº”çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ï¼Œå¹¶ä¸”å°†ä¸­æ–­æ ‡å¿—ä½é‡ç½®å˜ä¸ºfalse")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("interrupted")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("æ³¨æ„ ï¼šå½“é”è¢«é‡Šæ”¾æ—¶ï¼Œåªä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ head.nextã€‚ï¼ˆè¿™ä¸ªä¼šåœ¨é‡Šæ”¾é”çš„é€»è¾‘ä¸­è¯´ï¼‰")]),t._v(" "),s("p",[t._v("å½“é˜»å¡çš„çº¿ç¨‹è¢«å”¤é†’ï¼Œä¹Ÿå°±ä»£è¡¨æ­¤èŠ‚ç‚¹æ˜¯ head.nextï¼Œé‚£ä¹ˆæ­»å¾ªç¯ä¸­çš„ if æ¡ä»¶å°±å¯ä»¥èµ°é€šäº†ï¼Œäºæ˜¯æ­¤èŠ‚ç‚¹ä¼šä½¿ç”¨ tryAcquire å°è¯•è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸå°±é€€å‡ºå¾ªç¯ï¼Œå¦‚æœè·å–å¤±è´¥å°±è¿˜è¦é˜»å¡ã€‚")]),t._v(" "),s("h2",{attrs:{id:"_4-é‡Šæ”¾é”å"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡Šæ”¾é”å"}},[t._v("#")]),t._v(" 4. é‡Šæ”¾é”å")]),t._v(" "),s("p",[t._v("AQSå½“ç„¶ä¸ä¼šç®¡æ€ä¹ˆé‡Šæ”¾é”ï¼Œé‡Šæ”¾é”çš„é€»è¾‘è®©å­ç±»å»å®ç°ï¼Œæ¯”å¦‚ä¸å¯é‡å…¥é”ç›´æ¥é‡Šæ”¾ï¼Œå¯é‡å…¥é”è¿˜è¦åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦é‡å…¥ã€‚")]),t._v(" "),s("p",[t._v("AQS å®ç°çš„æ˜¯ä¹‹å‰è¢«é˜»å¡çš„çº¿ç¨‹æ€ä¹ˆåŠçš„é€»è¾‘ã€‚")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("release")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// é‡Šæ”¾é”çš„é€»è¾‘è®©å­ç±»å®ç°")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸€æ—¦é‡Šæ”¾æˆåŠŸï¼ŒAQSå°±å¼€å§‹å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tryRelease")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("arg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ‹¿åˆ°å¤´èŠ‚ç‚¹")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" h "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" head"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("h "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" h"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("waitStatus "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å”¤é†’å¤´èŠ‚ç‚¹åé¢é‚£ä¸ªèŠ‚ç‚¹")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unparkSuccessor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("h"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("ä¸å‡ºæ„å¤–çš„æƒ…å†µä¸‹æ˜¯ç›´æ¥å”¤é†’ head.next é‚£ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä¸å‡ºæ„å¤–çš„æƒ…å†µä¸‹è¦å‡ºæ„å¤–äº† ï¼š")]),t._v(" "),s("p",[t._v("head åçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼æˆ–è€…è¯´å®ƒçš„çŠ¶æ€ä¸ºå–æ¶ˆï¼é‚£ä¹ˆå°±ä»åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨å‘å‰å¯»æ‰¾ä¸€ä¸ªæœ‰æ„ä¹‰çš„èŠ‚ç‚¹å°†å®ƒå”¤é†’ï¼Œæ³¨æ„åªæ‰¾ä¸€ä¸ªå“¦ã€‚")]),t._v(" "),s("p",[t._v("å¹¶ä¸”æœ‰ä¸€ä¸ªå°ç»†èŠ‚ ï¼šå¦‚æœNodeçš„çŠ¶æ€ä¸ºå–æ¶ˆï¼Œå®ƒä¸ä¼šä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œè¿™ä¸ªç»†èŠ‚åœ¨ Condition ä¸­ä¼šæ¶‰åŠ")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤æ—¶ä¼ å…¥çš„Nodeä¸ºå¤´èŠ‚ç‚¹")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unparkSuccessor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" ws "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("waitStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ws "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSetWaitStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ‹¿åˆ°å¤´èŠ‚ç‚¹åé¢çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸€èˆ¬æ¥è¯´ä¸ä¼šèµ°è¿™é‡Œï¼Œè€Œæ˜¯ä¸‹é¢é‚£ä¸ªifï¼Œç›´æ¥å°†çº¿ç¨‹å”¤é†’ã€‚")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä½†æ˜¯èµ°è¿™é‡Œçš„é€»è¾‘æ˜¯å› ä¸ºå•¥å‘¢ï¼Ÿ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// waitStatusåœ¨ä¸Šé¢æœ‰è®²è§£ï¼ŒèŠ‚ç‚¹çš„ waitStatus > 0ä»£è¡¨æ­¤èŠ‚ç‚¹å·²ç»å–æ¶ˆ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ‰€ä»¥é€»è¾‘å°±æ˜¯ï¼šå¦‚æœ head.next ä¸ºç©ºæˆ–è€…å·²ç»å–æ¶ˆï¼Œå°±ä»åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨å¼€å§‹å¾€å‰å¯»æ‰¾ï¼Œ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰å–æ¶ˆçš„èŠ‚ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("waitStatus "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("waitStatus "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç›´æ¥å°†è¿™ä¸ªçº¿ç¨‹å”¤é†’äº†")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LockSupport")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unpark")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("æ­¥éª¤ ï¼šæ‹¿åˆ°å¤´èŠ‚ç‚¹åçš„ç¬¬ä¸€ä¸ªæœ‰æ„ä¹‰çš„èŠ‚ç‚¹ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¸ºå–æ¶ˆï¼Œè¯´æ˜è¿™ä¸ªèŠ‚ç‚¹åˆšä»ç­‰å¾…é˜Ÿåˆ—æ”¾åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè·³è¿‡å®ƒä»é˜Ÿåˆ—çš„å°¾éƒ¨å¼€å§‹æ‰¾çŠ¶æ€æ­£å¸¸çš„ï¼Œæ‰¾åˆ°ä¹‹åå°†å®ƒå”¤é†’")]),t._v(" "),s("p",[t._v("æ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œéƒ½é˜»å¡åœ¨ acquireQueued æ–¹æ³•å†…éƒ¨ï¼Œè¿™ä¸ªä½ å¯ä»¥å‘ä¸Šç¿»ï¼Œæˆ‘æœ‰è¯´ã€‚")]),t._v(" "),s("h2",{attrs:{id:"_5-condition"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-condition"}},[t._v("#")]),t._v(" 5. Condition")]),t._v(" "),s("p",[t._v("å¯èƒ½åˆšè¯´å®Œ AQS å°±è¯´ Condition ä¼šæœ‰äº›å‰²è£‚æ„Ÿï¼Œå› ä¸ºå¾ˆéš¾æƒ³è±¡ Condition ä¸ AQS æœ‰å•¥å…³ç³»ï¼Œå¯¹ï¼Œæœ‰å…³ç³»ï¼Œè¿˜è®°å¾— AQS çš„ Node ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ ï¼šnextWaiter")]),t._v(" "),s("p",[t._v("æˆ‘åœ¨ä¹‹å‰è¯´è¿‡ï¼ŒAQS æœ¬èº«çš„é€»è¾‘å¹¶æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªå˜é‡ï¼Œè€Œæ˜¯åœ¨ ConditionObject ä¸­ä½¿ç”¨åˆ°äº†ï¼Œæ‰€ä»¥ AQS ä¸­ç¬¬äºŒä¸ªé˜Ÿåˆ—å‡ºç°äº† ï¼šç­‰å¾…é˜Ÿåˆ—")]),t._v(" "),s("div",{staticClass:"custom-block note"},[s("p",{staticClass:"custom-block-title"},[t._v("ç¬”è®°")]),t._v(" "),s("p",[t._v("è¯·ä½ æ³¨æ„ç­‰å¾…é˜Ÿåˆ—ä¸åŒæ­¥é˜Ÿåˆ—çš„åŒºåˆ«ã€‚ä¸è¦å°†äºŒè€…æ··ä¸ºä¸€è°ˆ")])]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// æ­¤Nodeä»£è¡¨çš„çº¿ç¨‹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),t._v(" thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç”¨äºåŒæ­¥é˜Ÿåˆ—ï¼Œæ­¤Nodeçš„å‰ä¸€ä¸ªç»“ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" prev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç”¨äºåŒæ­¥é˜Ÿåˆ—ï¼Œæ­¤Nodeçš„åä¸€ä¸ªèŠ‚ç‚¹")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" next"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç”¨äºç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ç»„æˆçš„é˜Ÿåˆ—")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" nextWaiter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// èŠ‚ç‚¹çš„çŠ¶æ€")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("volatile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" waitStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// çœç•¥å…¶ä»–å˜é‡")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("å¸¸ç”¨çš„è®©çº¿ç¨‹ç­‰å¾…çš„æ–¹æ³•æœ‰ä¸¤ç§ ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("Object.wait()")]),t._v(" "),s("li",[t._v("Condition.await()")])]),t._v(" "),s("p",[t._v("è™½ç„¶å®ç°ä¸ä¸€æ ·ï¼Œä½†æ˜¯åŸç†æ˜¯ä¸€æ ·çš„ï¼Œçº¿ç¨‹ç­‰å¾…çš„å‰æè‚¯å®šæ˜¯å·²ç»æ‹¥æœ‰é”äº†ï¼Œè°ƒç”¨ wait åä¼šé‡Šæ”¾é”ç„¶åé˜»å¡ã€‚è°ƒç”¨ signal å°†çº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€å”¤é†’ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå¯ä»¥æŠ¢é”ã€‚")]),t._v(" "),s("h3",{attrs:{id:"_5-1-condition-await"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-condition-await"}},[t._v("#")]),t._v(" 5.1 Condition.await()")]),t._v(" "),s("p",[t._v("å¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šå¦‚ä½•å€ŸåŠ© AQS æ¥å®ç° Condition.await() å‘¢ï¼Ÿä¸å°±æ˜¯é‡Šæ”¾é”ä¹‹åé˜»å¡å˜›~")]),t._v(" "),s("ol",[s("li",[t._v("å°†æ­¤çº¿ç¨‹å°è£…ä¸º Node å¹¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—")]),t._v(" "),s("li",[t._v("è°ƒç”¨ AQS çš„ release é‡Šæ”¾é”")]),t._v(" "),s("li",[t._v("å°†å½“å‰çº¿ç¨‹é˜»å¡")])]),t._v(" "),s("p",[t._v("å¯¹ï¼Œå°±æ˜¯è¿™ä¸‰æ­¥ï¼Œæ¥çœ‹çœ‹ AQS ä¸­çš„ ConditionObject å¦‚ä½•å®ç°è¿™ä¸‰æ­¥çš„ ï¼š")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("await")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InterruptedException")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("interrupted")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("InterruptedException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºNodeï¼ŒNodeçš„çŠ¶æ€ä¸º-2ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…ï¼Œç„¶åæ”¾å…¥ç­‰å¾…é˜Ÿåˆ—")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿™æ—¶ä¼šå°† node.waitStatus æ”¹ä¸º CONDITION")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" node "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addConditionWaiter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è°ƒç”¨ release æ–¹æ³•é‡Šæ”¾é”")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// è¿™æ—¶ä¼šå°† node.waitStatus æ”¹ä¸º CANCELLED â˜… è¿™é‡Œç‰¹åˆ«é‡è¦ï¼ï¼ï¼ï¼ï¼")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å†æ¬¡å¼ºè°ƒï¼Œè¿™é‡Œä¼šå°† node.waitStatus æ”¹ä¸º CANCELLED ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" savedState "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fullyRelease")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" interruptMode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆ¤æ–­ Node èŠ‚ç‚¹çš„çŠ¶æ€")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶éƒ½ä¼šè¿”å›falseï¼Œå–ååä¼šè¿›å…¥æ–¹æ³•å°†çº¿ç¨‹é˜»å¡")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isOnSyncQueue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LockSupport")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("park")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interruptMode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkInterruptWhileWaiting")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// çº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€æ¢å¤åï¼Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…æŠ¢é”ï¼Œè¿™é‡Œçš„é€»è¾‘å°±æ˜¯ä¸Šé¢è¯´è¿‡äº†çš„ã€‚")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("acquireQueued")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" savedState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" interruptMode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("THROW_IE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        interruptMode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REINTERRUPT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextWaiter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// clean up if cancelled")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unlinkCancelledWaiters")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interruptMode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reportInterruptAfterWait")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interruptMode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_5-2-condition-signal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-condition-signal"}},[t._v("#")]),t._v(" 5.2 Condition.signal()")]),t._v(" "),s("p",[t._v("å¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šå¦‚ä½•å€ŸåŠ© AQS æ¥å®ç° Condition.signal() å‘¢ï¼Ÿä¸å°±æ˜¯å”¤é†’é”ã€æŠŠå®ƒåŠ å…¥åŒæ­¥é˜Ÿåˆ—å˜›~")]),t._v(" "),s("p",[t._v("Condition.signal() ä¼šå”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰")]),t._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¼ å…¥çš„æ˜¯ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼ˆçº¿ç¨‹æ˜¯å¯ä»¥æˆä¸ºå¤´èŠ‚ç‚¹çš„ï¼‰")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("doSignal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" first"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¸€èˆ¬ä¸ä¼šèµ°è¿™é‡Œ")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("firstWaiter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" first"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextWaiter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            lastWaiter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†å¤´èŠ‚ç‚¹çš„nextæŒ‡é’ˆç½®ä¸ºç©º")]),t._v("\n        first"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextWaiter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transferForSignal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("first"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n             "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("first "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" firstWaiter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transferForSignal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSetWaitStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CONDITION")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// å°†è¯¥èŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),t._v(" p "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enq")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// åˆšåˆšåœ¨ awaitæ–¹æ³•ä¸­ï¼Œæˆ‘ç‰¹åˆ«å¼ºè°ƒäº†ï¼ŒfullyRelease æ–¹æ³•ä¼šå°†èŠ‚ç‚¹çš„çŠ¶æ€æ”¹ä¸ºå–æ¶ˆ")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ä¹Ÿå°±æ˜¯ node.waitStatus = 1, å³ ws = 1")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" ws "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("waitStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ws "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareAndSetWaitStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Node")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SIGNAL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LockSupport")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unpark")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("thread"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("æ€è€ƒ ï¼šä¸ºå•¥è°ƒç”¨ await() æ–¹æ³•è®©çº¿ç¨‹é‡Šæ”¾é”åï¼Œçº¿ç¨‹ Node çš„çŠ¶æ€ä¼šå˜æˆå–æ¶ˆï¼ˆnode.waitStatus = 1ï¼‰å‘¢ï¼Ÿ")]),t._v(" "),s("p",[t._v("å› ä¸º signal æ–¹æ³•çš„æ­¥éª¤ä¸º ï¼š")]),t._v(" "),s("ol",[s("li",[t._v("å°† node æ”¾å…¥åŒæ­¥é˜Ÿåˆ—")]),t._v(" "),s("li",[t._v("å°†çº¿ç¨‹å”¤é†’")])]),t._v(" "),s("p",[t._v("å°† node æ”¾å…¥åŒæ­¥é˜Ÿåˆ—åï¼Œä¸‡ä¸€è¢«å”¤é†’äº†æ€ä¹ˆåŠï¼Ÿé‚£å°±è¦é€šè¿‡ä¸€äº›æ‰‹æ®µé˜²æ­¢è¿™ç§æ¦‚ç‡ç‰¹åˆ«å°çš„æƒ…å†µå‡ºç°ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹è°ƒç”¨ await() è¿›å…¥ç­‰å¾…ä¹‹å‰å…ˆå°† Node çš„çŠ¶æ€å˜æˆ å–æ¶ˆï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«è¯¯å”¤é†’ï¼çœŸå¼å•Šã€‚")]),t._v(" "),s("p",[t._v("Condition çš„ singalAll æ–¹æ³•ï¼Œç›¸å½“äºå¯¹ç­‰å¾…é˜Ÿåˆ—çš„æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œä¸€æ¬¡ singal æ–¹æ³•ï¼Œæ•ˆæœå°±æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ¨ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œå¹¶å”¤é†’æ¯ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ã€‚")]),t._v(" "),s("h2",{attrs:{id:"_5-æ€»ç»“"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-æ€»ç»“"}},[t._v("#")]),t._v(" 5. æ€»ç»“")]),t._v(" "),s("p",[t._v("è‡³æ­¤ï¼ŒAQS çš„æ ¸å¿ƒåŠŸèƒ½å·²ç»è¯´å®Œäº†ï¼Œæ²¡æœ‰è®²åŠ é”ã€é‡Šæ”¾é”ï¼Ÿå› ä¸ºåŠ é”ã€é‡Šæ”¾é”çš„é€»è¾‘æœ¬æ¥å°±ä¸æ˜¯ AQS è¦å®Œæˆçš„å‘€ã€‚")]),t._v(" "),s("p",[t._v("æ‰€ä»¥åŠ é”ä¸é‡Šæ”¾é”æˆ‘ä¼šåœ¨ ReentrantLockã€CountDownLatchã€ReadWriteLock ä¸­è®²ã€‚")])])}),[],!1,null,null,null);s.default=e.exports}}]);