(window.webpackJsonp=window.webpackJsonp||[]).push([[0],[]]);!function(n){function e(e){for(var r,i,l=e[0],s=e[1],c=e[2],u=0,p=[];u<l.length;u++)i=l[u],Object.prototype.hasOwnProperty.call(o,i)&&o[i]&&p.push(o[i][0]),o[i]=0;for(r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r]);for(d&&d(e);p.length;)p.shift()();return a.push.apply(a,c||[]),t()}function t(){for(var n,e=0;e<a.length;e++){for(var t=a[e],r=!0,l=1;l<t.length;l++){var s=t[l];0!==o[s]&&(r=!1)}r&&(a.splice(e--,1),n=i(i.s=t[0]))}return n}var r={},o={1:0},a=[];function i(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}i.e=function(n){var e=[],t=o[n];if(0!==t)if(t)e.push(t[2]);else{var r=new Promise((function(e,r){t=o[n]=[e,r]}));e.push(t[2]=r);var a,l=document.createElement("script");l.charset="utf-8",l.timeout=120,i.nc&&l.setAttribute("nonce",i.nc),l.src=function(n){return i.p+"assets/js/"+({}[n]||n)+"."+{2:"73d4029d",3:"ceab01f3",4:"a6d97bd6",5:"2729aef4",6:"18289d2c",7:"9ce784ab",8:"5a0ba8cc",9:"e78313b5",10:"2b19092b",11:"5d2d3328",12:"758d1773",13:"83080798",14:"cad064bf",15:"ce67be64",16:"7c331707",17:"353aa3a5",18:"812e388f",19:"bea0f1aa",20:"ae2220ed",21:"8b82ed1e",22:"97d63dbe",23:"79033cfd",24:"96ca227f",25:"90813872",26:"b18aba27",27:"f9995d4b",28:"31b6825c",29:"94237f71",30:"8269ef59",31:"c18e7c44",32:"06171ecb",33:"a33f1b11",34:"3e39f435",35:"6d245714",36:"c4063459",37:"5bbb13b5",38:"924e8c19",39:"e99c2fc3",40:"b8d5bbf4",41:"ea4edc48",42:"772aa8ee",43:"bb7e9285",44:"45df278e",45:"d55cceca",46:"0c8c51d9",47:"0e96e931",48:"7cd0eba4",49:"e46e4b79",50:"92ba3da6",51:"0202291b",52:"f92048a9",53:"07ceccc9",54:"4e07b215",55:"2e2bb8d4",56:"45e214fe",57:"4ce4a530",58:"f5cb3725",59:"d876d40f",60:"23938f5e",61:"80196175",62:"5f2ced9c",63:"424361b5",64:"63e35c1a",65:"dc44ac45",66:"bac24f77",67:"f2e38f54",68:"8eab7a58",69:"73bfbfca"}[n]+".js"}(n);var s=new Error;a=function(e){l.onerror=l.onload=null,clearTimeout(c);var t=o[n];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),a=e&&e.target&&e.target.src;s.message="Loading chunk "+n+" failed.\n("+r+": "+a+")",s.name="ChunkLoadError",s.type=r,s.request=a,t[1](s)}o[n]=void 0}};var c=setTimeout((function(){a({type:"timeout",target:l})}),12e4);l.onerror=l.onload=a,document.head.appendChild(l)}return Promise.all(e)},i.m=n,i.c=r,i.d=function(n,e,t){i.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:t})},i.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},i.t=function(n,e){if(1&e&&(n=i(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var t=Object.create(null);if(i.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var r in n)i.d(t,r,function(e){return n[e]}.bind(null,r));return t},i.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return i.d(e,"a",e),e},i.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},i.p="/",i.oe=function(n){throw console.error(n),n};var l=window.webpackJsonp=window.webpackJsonp||[],s=l.push.bind(l);l.push=e,l=l.slice();for(var c=0;c<l.length;c++)e(l[c]);var d=s;a.push([103,0]),t()}([function(n,e,t){var r=t(55),o=r.all;n.exports=r.IS_HTMLDDA?function(n){return"function"==typeof n||n===o}:function(n){return"function"==typeof n}},function(n,e,t){var r=t(27),o=Function.prototype,a=o.call,i=r&&o.bind.bind(a,a);n.exports=r?i:function(n){return function(){return a.apply(n,arguments)}}},function(n,e){var t=function(n){return n&&n.Math==Math&&n};n.exports=t("object"==typeof globalThis&&globalThis)||t("object"==typeof window&&window)||t("object"==typeof self&&self)||t("object"==typeof global&&global)||function(){return this}()||this||Function("return this")()},function(n,e){n.exports=function(n){try{return!!n()}catch(n){return!0}}},function(n,e,t){var r=t(3);n.exports=!r((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}))},function(n,e){var t=Array.isArray;n.exports=t},function(n,e,t){var r=t(69),o="object"==typeof self&&self&&self.Object===Object&&self,a=r||o||Function("return this")();n.exports=a},function(n,e,t){"use strict";function r(n,e,t,r,o,a,i,l){var s,c="function"==typeof n?n.options:n;if(e&&(c.render=e,c.staticRenderFns=t,c._compiled=!0),r&&(c.functional=!0),a&&(c._scopeId="data-v-"+a),i?(s=function(n){(n=n||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(n=__VUE_SSR_CONTEXT__),o&&o.call(this,n),n&&n._registeredComponents&&n._registeredComponents.add(i)},c._ssrRegister=s):o&&(s=l?function(){o.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:o),s)if(c.functional){c._injectStyles=s;var d=c.render;c.render=function(n,e){return s.call(e),d(n,e)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,s):[s]}return{exports:n,options:c}}t.d(e,"a",(function(){return r}))},function(n,e,t){var r=t(1),o=t(32),a=r({}.hasOwnProperty);n.exports=Object.hasOwn||function(n,e){return a(o(n),e)}},function(n,e,t){var r=t(0),o=t(55),a=o.all;n.exports=o.IS_HTMLDDA?function(n){return"object"==typeof n?null!==n:r(n)||n===a}:function(n){return"object"==typeof n?null!==n:r(n)}},function(n,e,t){var r=t(163),o=t(166);n.exports=function(n,e){var t=o(n,e);return r(t)?t:void 0}},function(n,e,t){"use strict";t.d(e,"e",(function(){return r})),t.d(e,"b",(function(){return a})),t.d(e,"j",(function(){return i})),t.d(e,"g",(function(){return s})),t.d(e,"h",(function(){return c})),t.d(e,"i",(function(){return d})),t.d(e,"c",(function(){return u})),t.d(e,"f",(function(){return p})),t.d(e,"l",(function(){return g})),t.d(e,"m",(function(){return h})),t.d(e,"d",(function(){return m})),t.d(e,"k",(function(){return b})),t.d(e,"n",(function(){return x})),t.d(e,"a",(function(){return y}));t(16);const r=/#.*$/,o=/\.(md|html)$/,a=/\/$/,i=/^[a-z]+:/i;function l(n){return decodeURI(n).replace(r,"").replace(o,"")}function s(n){return i.test(n)}function c(n){return/^mailto:/.test(n)}function d(n){return/^tel:/.test(n)}function u(n){if(s(n))return n;if(!n)return"404";const e=n.match(r),t=e?e[0]:"",o=l(n);return a.test(o)?n:o+".html"+t}function p(n,e){const t=n.hash,o=function(n){const e=n&&n.match(r);if(e)return e[0]}(e);if(o&&t!==o)return!1;return l(n.path)===l(e)}function g(n,e,t){if(s(e))return{type:"external",path:e};t&&(e=function(n,e,t){const r=n.charAt(0);if("/"===r)return n;if("?"===r||"#"===r)return e+n;const o=e.split("/");t&&o[o.length-1]||o.pop();const a=n.replace(/^\//,"").split("/");for(let n=0;n<a.length;n++){const e=a[n];".."===e?o.pop():"."!==e&&o.push(e)}""!==o[0]&&o.unshift("");return o.join("/")}(e,t));const r=l(e);for(let e=0;e<n.length;e++)if(l(n[e].regularPath)===r)return Object.assign({},n[e],{type:"page",path:u(n[e].path)});return console.error(`[vuepress] No matching page found for sidebar item "${e}"`),{}}function h(n,e,t,r){const{pages:o,themeConfig:a}=t,i=r&&a.locales&&a.locales[r]||a;if("auto"===(n.frontmatter.sidebar||i.sidebar||a.sidebar))return f(n);const l=i.sidebar||a.sidebar;if(l){const{base:t,config:r}=function(n,e){if(Array.isArray(e))return{base:"/",config:e};for(const r in e)if(0===(t=n,/(\.html|\/)$/.test(t)?t:t+"/").indexOf(encodeURI(r)))return{base:r,config:e[r]};var t;return{}}(e,l);return"auto"===r?f(n):r?r.map(n=>function n(e,t,r,o=1){if("string"==typeof e)return g(t,e,r);if(Array.isArray(e))return Object.assign(g(t,e[0],r),{title:e[1]});{o>3&&console.error("[vuepress] detected a too deep nested sidebar group.");const a=e.children||[];return 0===a.length&&e.path?Object.assign(g(t,e.path,r),{title:e.title}):{type:"group",path:e.path,title:e.title,sidebarDepth:e.sidebarDepth,initialOpenGroupIndex:e.initialOpenGroupIndex,children:a.map(e=>n(e,t,r,o+1)),collapsable:!1!==e.collapsable}}}(n,o,t)):[]}return[]}function f(n){const e=m(n.headers||[]);return[{type:"group",collapsable:!1,title:n.title,path:null,children:e.map(e=>({type:"auto",title:e.title,basePath:n.path,path:n.path+"#"+e.slug,children:e.children||[]}))}]}function m(n){let e;return(n=n.map(n=>Object.assign({},n))).forEach(n=>{2===n.level?e=n:e&&(e.children||(e.children=[])).push(n)}),n.filter(n=>2===n.level)}function b(n){return Object.assign(n,{type:n.items&&n.items.length?"links":"link"})}function x(n){return Object.prototype.toString.call(n).match(/\[object (.*?)\]/)[1].toLowerCase()}function v(n){let e=n.frontmatter.date||n.lastUpdated||new Date,t=new Date(e);return"Invalid Date"==t&&e&&(t=new Date(e.replace(/-/g,"/"))),t.getTime()}function y(n,e){return v(e)-v(n)}},function(n,e){n.exports=function(n){return null!=n&&"object"==typeof n}},function(n,e,t){var r=t(15),o=t(148),a=t(149),i=r?r.toStringTag:void 0;n.exports=function(n){return null==n?void 0===n?"[object Undefined]":"[object Null]":i&&i in Object(n)?o(n):a(n)}},function(n,e,t){var r=t(4),o=t(17),a=t(35);n.exports=r?function(n,e,t){return o.f(n,e,a(1,t))}:function(n,e,t){return n[e]=t,n}},function(n,e,t){var r=t(6).Symbol;n.exports=r},function(n,e,t){"use strict";var r=t(26),o=t(32),a=t(33),i=t(127),l=t(129);r({target:"Array",proto:!0,arity:1,forced:t(3)((function(){return 4294967297!==[].push.call({length:4294967296},1)}))||!function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(n){return n instanceof TypeError}}()},{push:function(n){var e=o(this),t=a(e),r=arguments.length;l(t+r);for(var s=0;s<r;s++)e[t]=arguments[s],t++;return i(e,t),t}})},function(n,e,t){var r=t(4),o=t(64),a=t(98),i=t(25),l=t(54),s=TypeError,c=Object.defineProperty,d=Object.getOwnPropertyDescriptor;e.f=r?a?function(n,e,t){if(i(n),e=l(e),i(t),"function"==typeof n&&"prototype"===e&&"value"in t&&"writable"in t&&!t.writable){var r=d(n,e);r&&r.writable&&(n[e]=t.value,t={configurable:"configurable"in t?t.configurable:r.configurable,enumerable:"enumerable"in t?t.enumerable:r.enumerable,writable:!1})}return c(n,e,t)}:c:function(n,e,t){if(i(n),e=l(e),i(t),o)try{return c(n,e,t)}catch(n){}if("get"in t||"set"in t)throw s("Accessors not supported");return"value"in t&&(n[e]=t.value),n}},function(n,e,t){var r=t(1),o=r({}.toString),a=r("".slice);n.exports=function(n){return a(o(n),8,-1)}},function(n,e,t){var r=t(153),o=t(154),a=t(155),i=t(156),l=t(157);function s(n){var e=-1,t=null==n?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}s.prototype.clear=r,s.prototype.delete=o,s.prototype.get=a,s.prototype.has=i,s.prototype.set=l,n.exports=s},function(n,e,t){var r=t(71);n.exports=function(n,e){for(var t=n.length;t--;)if(r(n[t][0],e))return t;return-1}},function(n,e,t){var r=t(10)(Object,"create");n.exports=r},function(n,e,t){var r=t(175);n.exports=function(n,e){var t=n.__data__;return r(e)?t["string"==typeof e?"string":"hash"]:t.map}},function(n,e,t){var r=t(45);n.exports=function(n){if("string"==typeof n||r(n))return n;var e=n+"";return"0"==e&&1/n==-1/0?"-0":e}},function(n,e,t){var r,o;
/* NProgress, (c) 2013, 2014 Rico Sta. Cruz - http://ricostacruz.com/nprogress
 * @license MIT */void 0===(o="function"==typeof(r=function(){var n,e,t={version:"0.2.0"},r=t.settings={minimum:.08,easing:"ease",positionUsing:"",speed:200,trickle:!0,trickleRate:.02,trickleSpeed:800,showSpinner:!0,barSelector:'[role="bar"]',spinnerSelector:'[role="spinner"]',parent:"body",template:'<div class="bar" role="bar"><div class="peg"></div></div><div class="spinner" role="spinner"><div class="spinner-icon"></div></div>'};function o(n,e,t){return n<e?e:n>t?t:n}function a(n){return 100*(-1+n)}t.configure=function(n){var e,t;for(e in n)void 0!==(t=n[e])&&n.hasOwnProperty(e)&&(r[e]=t);return this},t.status=null,t.set=function(n){var e=t.isStarted();n=o(n,r.minimum,1),t.status=1===n?null:n;var s=t.render(!e),c=s.querySelector(r.barSelector),d=r.speed,u=r.easing;return s.offsetWidth,i((function(e){""===r.positionUsing&&(r.positionUsing=t.getPositioningCSS()),l(c,function(n,e,t){var o;return(o="translate3d"===r.positionUsing?{transform:"translate3d("+a(n)+"%,0,0)"}:"translate"===r.positionUsing?{transform:"translate("+a(n)+"%,0)"}:{"margin-left":a(n)+"%"}).transition="all "+e+"ms "+t,o}(n,d,u)),1===n?(l(s,{transition:"none",opacity:1}),s.offsetWidth,setTimeout((function(){l(s,{transition:"all "+d+"ms linear",opacity:0}),setTimeout((function(){t.remove(),e()}),d)}),d)):setTimeout(e,d)})),this},t.isStarted=function(){return"number"==typeof t.status},t.start=function(){t.status||t.set(0);var n=function(){setTimeout((function(){t.status&&(t.trickle(),n())}),r.trickleSpeed)};return r.trickle&&n(),this},t.done=function(n){return n||t.status?t.inc(.3+.5*Math.random()).set(1):this},t.inc=function(n){var e=t.status;return e?("number"!=typeof n&&(n=(1-e)*o(Math.random()*e,.1,.95)),e=o(e+n,0,.994),t.set(e)):t.start()},t.trickle=function(){return t.inc(Math.random()*r.trickleRate)},n=0,e=0,t.promise=function(r){return r&&"resolved"!==r.state()?(0===e&&t.start(),n++,e++,r.always((function(){0==--e?(n=0,t.done()):t.set((n-e)/n)})),this):this},t.render=function(n){if(t.isRendered())return document.getElementById("nprogress");c(document.documentElement,"nprogress-busy");var e=document.createElement("div");e.id="nprogress",e.innerHTML=r.template;var o,i=e.querySelector(r.barSelector),s=n?"-100":a(t.status||0),d=document.querySelector(r.parent);return l(i,{transition:"all 0 linear",transform:"translate3d("+s+"%,0,0)"}),r.showSpinner||(o=e.querySelector(r.spinnerSelector))&&p(o),d!=document.body&&c(d,"nprogress-custom-parent"),d.appendChild(e),e},t.remove=function(){d(document.documentElement,"nprogress-busy"),d(document.querySelector(r.parent),"nprogress-custom-parent");var n=document.getElementById("nprogress");n&&p(n)},t.isRendered=function(){return!!document.getElementById("nprogress")},t.getPositioningCSS=function(){var n=document.body.style,e="WebkitTransform"in n?"Webkit":"MozTransform"in n?"Moz":"msTransform"in n?"ms":"OTransform"in n?"O":"";return e+"Perspective"in n?"translate3d":e+"Transform"in n?"translate":"margin"};var i=function(){var n=[];function e(){var t=n.shift();t&&t(e)}return function(t){n.push(t),1==n.length&&e()}}(),l=function(){var n=["Webkit","O","Moz","ms"],e={};function t(t){return t=t.replace(/^-ms-/,"ms-").replace(/-([\da-z])/gi,(function(n,e){return e.toUpperCase()})),e[t]||(e[t]=function(e){var t=document.body.style;if(e in t)return e;for(var r,o=n.length,a=e.charAt(0).toUpperCase()+e.slice(1);o--;)if((r=n[o]+a)in t)return r;return e}(t))}function r(n,e,r){e=t(e),n.style[e]=r}return function(n,e){var t,o,a=arguments;if(2==a.length)for(t in e)void 0!==(o=e[t])&&e.hasOwnProperty(t)&&r(n,t,o);else r(n,a[1],a[2])}}();function s(n,e){return("string"==typeof n?n:u(n)).indexOf(" "+e+" ")>=0}function c(n,e){var t=u(n),r=t+e;s(t,e)||(n.className=r.substring(1))}function d(n,e){var t,r=u(n);s(n,e)&&(t=r.replace(" "+e+" "," "),n.className=t.substring(1,t.length-1))}function u(n){return(" "+(n.className||"")+" ").replace(/\s+/gi," ")}function p(n){n&&n.parentNode&&n.parentNode.removeChild(n)}return t})?r.call(e,t,e,n):r)||(n.exports=o)},function(n,e,t){var r=t(9),o=String,a=TypeError;n.exports=function(n){if(r(n))return n;throw a(o(n)+" is not an object")}},function(n,e,t){var r=t(2),o=t(51).f,a=t(14),i=t(111),l=t(37),s=t(65),c=t(123);n.exports=function(n,e){var t,d,u,p,g,h=n.target,f=n.global,m=n.stat;if(t=f?r:m?r[h]||l(h,{}):(r[h]||{}).prototype)for(d in e){if(p=e[d],u=n.dontCallGetSet?(g=o(t,d))&&g.value:t[d],!c(f?d:h+(m?".":"#")+d,n.forced)&&void 0!==u){if(typeof p==typeof u)continue;s(p,u)}(n.sham||u&&u.sham)&&a(p,"sham",!0),i(t,d,p,n)}}},function(n,e,t){var r=t(3);n.exports=!r((function(){var n=function(){}.bind();return"function"!=typeof n||n.hasOwnProperty("prototype")}))},function(n,e,t){var r=t(47),o=t(52);n.exports=function(n){return r(o(n))}},function(n,e,t){var r=t(2),o=t(0),a=function(n){return o(n)?n:void 0};n.exports=function(n,e){return arguments.length<2?a(r[n]):r[n]&&r[n][e]}},function(n,e,t){var r=t(0),o=t(109),a=TypeError;n.exports=function(n){if(r(n))return n;throw a(o(n)+" is not a function")}},function(n,e,t){var r=t(2),o=t(61),a=t(8),i=t(63),l=t(59),s=t(58),c=r.Symbol,d=o("wks"),u=s?c.for||c:c&&c.withoutSetter||i;n.exports=function(n){return a(d,n)||(d[n]=l&&a(c,n)?c[n]:u("Symbol."+n)),d[n]}},function(n,e,t){var r=t(52),o=Object;n.exports=function(n){return o(r(n))}},function(n,e,t){var r=t(121);n.exports=function(n){return r(n.length)}},function(n,e,t){var r=t(27),o=Function.prototype.call;n.exports=r?o.bind(o):function(){return o.apply(o,arguments)}},function(n,e){n.exports=function(n,e){return{enumerable:!(1&n),configurable:!(2&n),writable:!(4&n),value:e}}},function(n,e,t){var r=t(2),o=t(37),a=r["__core-js_shared__"]||o("__core-js_shared__",{});n.exports=a},function(n,e,t){var r=t(2),o=Object.defineProperty;n.exports=function(n,e){try{o(r,n,{value:e,configurable:!0,writable:!0})}catch(t){r[n]=e}return e}},function(n,e,t){var r=t(147),o=t(12),a=Object.prototype,i=a.hasOwnProperty,l=a.propertyIsEnumerable,s=r(function(){return arguments}())?r:function(n){return o(n)&&i.call(n,"callee")&&!l.call(n,"callee")};n.exports=s},function(n,e,t){var r=t(10)(t(6),"Map");n.exports=r},function(n,e){n.exports=function(n){var e=typeof n;return null!=n&&("object"==e||"function"==e)}},function(n,e,t){var r=t(167),o=t(174),a=t(176),i=t(177),l=t(178);function s(n){var e=-1,t=null==n?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}s.prototype.clear=r,s.prototype.delete=o,s.prototype.get=a,s.prototype.has=i,s.prototype.set=l,n.exports=s},function(n,e){n.exports=function(n){var e=-1,t=Array(n.size);return n.forEach((function(n){t[++e]=n})),t}},function(n,e){n.exports=function(n){return"number"==typeof n&&n>-1&&n%1==0&&n<=9007199254740991}},function(n,e,t){var r=t(5),o=t(45),a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,i=/^\w*$/;n.exports=function(n,e){if(r(n))return!1;var t=typeof n;return!("number"!=t&&"symbol"!=t&&"boolean"!=t&&null!=n&&!o(n))||(i.test(n)||!a.test(n)||null!=e&&n in Object(e))}},function(n,e,t){var r=t(13),o=t(12);n.exports=function(n){return"symbol"==typeof n||o(n)&&"[object Symbol]"==r(n)}},function(n,e){n.exports=function(n){return n}},function(n,e,t){var r=t(1),o=t(3),a=t(18),i=Object,l=r("".split);n.exports=o((function(){return!i("z").propertyIsEnumerable(0)}))?function(n){return"String"==a(n)?l(n,""):i(n)}:i},function(n,e){n.exports={}},function(n,e){n.exports=function(n){return n.webpackPolyfill||(n.deprecate=function(){},n.paths=[],n.children||(n.children=[]),Object.defineProperty(n,"loaded",{enumerable:!0,get:function(){return n.l}}),Object.defineProperty(n,"id",{enumerable:!0,get:function(){return n.i}}),n.webpackPolyfill=1),n}},function(n,e){var t=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,o=/^0b[01]+$/i,a=/^0o[0-7]+$/i,i=parseInt,l="object"==typeof global&&global&&global.Object===Object&&global,s="object"==typeof self&&self&&self.Object===Object&&self,c=l||s||Function("return this")(),d=Object.prototype.toString,u=Math.max,p=Math.min,g=function(){return c.Date.now()};function h(n){var e=typeof n;return!!n&&("object"==e||"function"==e)}function f(n){if("number"==typeof n)return n;if(function(n){return"symbol"==typeof n||function(n){return!!n&&"object"==typeof n}(n)&&"[object Symbol]"==d.call(n)}(n))return NaN;if(h(n)){var e="function"==typeof n.valueOf?n.valueOf():n;n=h(e)?e+"":e}if("string"!=typeof n)return 0===n?n:+n;n=n.replace(t,"");var l=o.test(n);return l||a.test(n)?i(n.slice(2),l?2:8):r.test(n)?NaN:+n}n.exports=function(n,e,t){var r,o,a,i,l,s,c=0,d=!1,m=!1,b=!0;if("function"!=typeof n)throw new TypeError("Expected a function");function x(e){var t=r,a=o;return r=o=void 0,c=e,i=n.apply(a,t)}function v(n){return c=n,l=setTimeout(k,e),d?x(n):i}function y(n){var t=n-s;return void 0===s||t>=e||t<0||m&&n-c>=a}function k(){var n=g();if(y(n))return w(n);l=setTimeout(k,function(n){var t=e-(n-s);return m?p(t,a-(n-c)):t}(n))}function w(n){return l=void 0,b&&r?x(n):(r=o=void 0,i)}function S(){var n=g(),t=y(n);if(r=arguments,o=this,s=n,t){if(void 0===l)return v(s);if(m)return l=setTimeout(k,e),x(s)}return void 0===l&&(l=setTimeout(k,e)),i}return e=f(e)||0,h(t)&&(d=!!t.leading,a=(m="maxWait"in t)?u(f(t.maxWait)||0,e):a,b="trailing"in t?!!t.trailing:b),S.cancel=function(){void 0!==l&&clearTimeout(l),c=0,r=s=o=l=void 0},S.flush=function(){return void 0===l?i:w(g())},S}},function(n,e,t){var r=t(4),o=t(34),a=t(105),i=t(35),l=t(28),s=t(54),c=t(8),d=t(64),u=Object.getOwnPropertyDescriptor;e.f=r?u:function(n,e){if(n=l(n),e=s(e),d)try{return u(n,e)}catch(n){}if(c(n,e))return i(!o(a.f,n,e),n[e])}},function(n,e,t){var r=t(53),o=TypeError;n.exports=function(n){if(r(n))throw o("Can't call method on "+n);return n}},function(n,e){n.exports=function(n){return null==n}},function(n,e,t){var r=t(106),o=t(56);n.exports=function(n){var e=r(n,"string");return o(e)?e:e+""}},function(n,e){var t="object"==typeof document&&document.all,r=void 0===t&&void 0!==t;n.exports={all:t,IS_HTMLDDA:r}},function(n,e,t){var r=t(29),o=t(0),a=t(57),i=t(58),l=Object;n.exports=i?function(n){return"symbol"==typeof n}:function(n){var e=r("Symbol");return o(e)&&a(e.prototype,l(n))}},function(n,e,t){var r=t(1);n.exports=r({}.isPrototypeOf)},function(n,e,t){var r=t(59);n.exports=r&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},function(n,e,t){var r=t(60),o=t(3),a=t(2).String;n.exports=!!Object.getOwnPropertySymbols&&!o((function(){var n=Symbol();return!a(n)||!(Object(n)instanceof Symbol)||!Symbol.sham&&r&&r<41}))},function(n,e,t){var r,o,a=t(2),i=t(107),l=a.process,s=a.Deno,c=l&&l.versions||s&&s.version,d=c&&c.v8;d&&(o=(r=d.split("."))[0]>0&&r[0]<4?1:+(r[0]+r[1])),!o&&i&&(!(r=i.match(/Edge\/(\d+)/))||r[1]>=74)&&(r=i.match(/Chrome\/(\d+)/))&&(o=+r[1]),n.exports=o},function(n,e,t){var r=t(62),o=t(36);(n.exports=function(n,e){return o[n]||(o[n]=void 0!==e?e:{})})("versions",[]).push({version:"3.30.2",mode:r?"pure":"global",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.30.2/LICENSE",source:"https://github.com/zloirock/core-js"})},function(n,e){n.exports=!1},function(n,e,t){var r=t(1),o=0,a=Math.random(),i=r(1..toString);n.exports=function(n){return"Symbol("+(void 0===n?"":n)+")_"+i(++o+a,36)}},function(n,e,t){var r=t(4),o=t(3),a=t(97);n.exports=!r&&!o((function(){return 7!=Object.defineProperty(a("div"),"a",{get:function(){return 7}}).a}))},function(n,e,t){var r=t(8),o=t(116),a=t(51),i=t(17);n.exports=function(n,e,t){for(var l=o(e),s=i.f,c=a.f,d=0;d<l.length;d++){var u=l[d];r(n,u)||t&&r(t,u)||s(n,u,c(e,u))}}},function(n,e,t){var r=t(120);n.exports=function(n){var e=+n;return e!=e||0===e?0:r(e)}},function(n,e,t){var r=t(133),o=t(25),a=t(134);n.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var n,e=!1,t={};try{(n=r(Object.prototype,"__proto__","set"))(t,[]),e=t instanceof Array}catch(n){}return function(t,r){return o(t),a(r),e?n(t,r):t.__proto__=r,t}}():void 0)},function(n,e){n.exports=function(n,e){for(var t=-1,r=e.length,o=n.length;++t<r;)n[o+t]=e[t];return n}},function(n,e){var t="object"==typeof global&&global&&global.Object===Object&&global;n.exports=t},function(n,e,t){var r=t(19),o=t(158),a=t(159),i=t(160),l=t(161),s=t(162);function c(n){var e=this.__data__=new r(n);this.size=e.size}c.prototype.clear=o,c.prototype.delete=a,c.prototype.get=i,c.prototype.has=l,c.prototype.set=s,n.exports=c},function(n,e){n.exports=function(n,e){return n===e||n!=n&&e!=e}},function(n,e,t){var r=t(13),o=t(40);n.exports=function(n){if(!o(n))return!1;var e=r(n);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}},function(n,e){var t=Function.prototype.toString;n.exports=function(n){if(null!=n){try{return t.call(n)}catch(n){}try{return n+""}catch(n){}}return""}},function(n,e,t){var r=t(179),o=t(12);n.exports=function n(e,t,a,i,l){return e===t||(null==e||null==t||!o(e)&&!o(t)?e!=e&&t!=t:r(e,t,a,i,n,l))}},function(n,e,t){var r=t(76),o=t(182),a=t(77);n.exports=function(n,e,t,i,l,s){var c=1&t,d=n.length,u=e.length;if(d!=u&&!(c&&u>d))return!1;var p=s.get(n),g=s.get(e);if(p&&g)return p==e&&g==n;var h=-1,f=!0,m=2&t?new r:void 0;for(s.set(n,e),s.set(e,n);++h<d;){var b=n[h],x=e[h];if(i)var v=c?i(x,b,h,e,n,s):i(b,x,h,n,e,s);if(void 0!==v){if(v)continue;f=!1;break}if(m){if(!o(e,(function(n,e){if(!a(m,e)&&(b===n||l(b,n,t,i,s)))return m.push(e)}))){f=!1;break}}else if(b!==x&&!l(b,x,t,i,s)){f=!1;break}}return s.delete(n),s.delete(e),f}},function(n,e,t){var r=t(41),o=t(180),a=t(181);function i(n){var e=-1,t=null==n?0:n.length;for(this.__data__=new r;++e<t;)this.add(n[e])}i.prototype.add=i.prototype.push=o,i.prototype.has=a,n.exports=i},function(n,e){n.exports=function(n,e){return n.has(e)}},function(n,e,t){var r=t(192),o=t(198),a=t(82);n.exports=function(n){return a(n)?r(n):o(n)}},function(n,e,t){(function(n){var r=t(6),o=t(194),a=e&&!e.nodeType&&e,i=a&&"object"==typeof n&&n&&!n.nodeType&&n,l=i&&i.exports===a?r.Buffer:void 0,s=(l?l.isBuffer:void 0)||o;n.exports=s}).call(this,t(49)(n))},function(n,e){var t=/^(?:0|[1-9]\d*)$/;n.exports=function(n,e){var r=typeof n;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&t.test(n))&&n>-1&&n%1==0&&n<e}},function(n,e,t){var r=t(195),o=t(196),a=t(197),i=a&&a.isTypedArray,l=i?o(i):r;n.exports=l},function(n,e,t){var r=t(72),o=t(43);n.exports=function(n){return null!=n&&o(n.length)&&!r(n)}},function(n,e,t){var r=t(10)(t(6),"Set");n.exports=r},function(n,e,t){var r=t(40);n.exports=function(n){return n==n&&!r(n)}},function(n,e){n.exports=function(n,e){return function(t){return null!=t&&(t[n]===e&&(void 0!==e||n in Object(t)))}}},function(n,e,t){var r=t(87),o=t(23);n.exports=function(n,e){for(var t=0,a=(e=r(e,n)).length;null!=n&&t<a;)n=n[o(e[t++])];return t&&t==a?n:void 0}},function(n,e,t){var r=t(5),o=t(44),a=t(209),i=t(212);n.exports=function(n,e){return r(n)?n:o(n,e)?[n]:a(i(n))}},function(n,e,t){},function(n,e,t){},function(n,e,t){},function(n,e,t){},function(n,e,t){var r=t(145),o=t(150),a=t(221),i=t(229),l=t(238),s=t(102),c=a((function(n){var e=s(n);return l(e)&&(e=void 0),i(r(n,1,l,!0),o(e,2))}));n.exports=c},function(n,e,t){"use strict";
/*!
 * escape-html
 * Copyright(c) 2012-2013 TJ Holowaychuk
 * Copyright(c) 2015 Andreas Lubbe
 * Copyright(c) 2015 Tiancheng "Timothy" Gu
 * MIT Licensed
 */var r=/["'&<>]/;n.exports=function(n){var e,t=""+n,o=r.exec(t);if(!o)return t;var a="",i=0,l=0;for(i=o.index;i<t.length;i++){switch(t.charCodeAt(i)){case 34:e="&quot;";break;case 38:e="&amp;";break;case 39:e="&#39;";break;case 60:e="&lt;";break;case 62:e="&gt;";break;default:continue}l!==i&&(a+=t.substring(l,i)),l=i+1,a+=e}return l!==i?a+t.substring(l,i):a}},function(n,e,t){"use strict";t.r(e);var r={name:"CodeBlock",props:{title:{type:String,required:!0},active:{type:Boolean,default:!1}}},o=(t(241),t(7)),a=Object(o.a)(r,(function(){return(0,this._self._c)("div",{staticClass:"theme-code-block",class:{"theme-code-block__active":this.active}},[this._t("default")],2)}),[],!1,null,"4f1e9d0c",null);e.default=a.exports},function(n,e,t){"use strict";t.r(e);var r={name:"CodeGroup",data:()=>({codeTabs:[],activeCodeTabIndex:-1}),watch:{activeCodeTabIndex(n){this.codeTabs.forEach(n=>{n.elm.classList.remove("theme-code-block__active")}),this.codeTabs[n].elm.classList.add("theme-code-block__active")}},mounted(){this.codeTabs=(this.$slots.default||[]).filter(n=>Boolean(n.componentOptions)).map((n,e)=>(""===n.componentOptions.propsData.active&&(this.activeCodeTabIndex=e),{title:n.componentOptions.propsData.title,elm:n.elm})),-1===this.activeCodeTabIndex&&this.codeTabs.length>0&&(this.activeCodeTabIndex=0)},methods:{changeCodeTab(n){this.activeCodeTabIndex=n}}},o=(t(242),t(7)),a=Object(o.a)(r,(function(){var n=this,e=n._self._c;return e("div",{staticClass:"theme-code-group"},[e("div",{staticClass:"theme-code-group__nav"},[e("ul",{staticClass:"theme-code-group__ul"},n._l(n.codeTabs,(function(t,r){return e("li",{key:t.title,staticClass:"theme-code-group__li"},[e("button",{staticClass:"theme-code-group__nav-tab",class:{"theme-code-group__nav-tab-active":r===n.activeCodeTabIndex},on:{click:function(e){return n.changeCodeTab(r)}}},[n._v("\n            "+n._s(t.title)+"\n          ")])])})),0)]),n._v(" "),n._t("default"),n._v(" "),n.codeTabs.length<1?e("pre",{staticClass:"pre-blank"},[n._v("// Make sure to add code blocks to your code group")]):n._e()],2)}),[],!1,null,"2f5f1757",null);e.default=a.exports},function(n,e){n.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},function(n,e,t){var r=t(2),o=t(9),a=r.document,i=o(a)&&o(a.createElement);n.exports=function(n){return i?a.createElement(n):{}}},function(n,e,t){var r=t(4),o=t(3);n.exports=r&&o((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))},function(n,e,t){var r=t(1),o=t(3),a=t(0),i=t(8),l=t(4),s=t(112).CONFIGURABLE,c=t(113),d=t(114),u=d.enforce,p=d.get,g=String,h=Object.defineProperty,f=r("".slice),m=r("".replace),b=r([].join),x=l&&!o((function(){return 8!==h((function(){}),"length",{value:8}).length})),v=String(String).split("String"),y=n.exports=function(n,e,t){"Symbol("===f(g(e),0,7)&&(e="["+m(g(e),/^Symbol\(([^)]*)\)/,"$1")+"]"),t&&t.getter&&(e="get "+e),t&&t.setter&&(e="set "+e),(!i(n,"name")||s&&n.name!==e)&&(l?h(n,"name",{value:e,configurable:!0}):n.name=e),x&&t&&i(t,"arity")&&n.length!==t.arity&&h(n,"length",{value:t.arity});try{t&&i(t,"constructor")&&t.constructor?l&&h(n,"prototype",{writable:!1}):n.prototype&&(n.prototype=void 0)}catch(n){}var r=u(n);return i(r,"source")||(r.source=b(v,"string"==typeof e?e:"")),n};Function.prototype.toString=y((function(){return a(this)&&p(this).source||c(this)}),"toString")},function(n,e,t){var r=t(61),o=t(63),a=r("keys");n.exports=function(n){return a[n]||(a[n]=o(n))}},function(n,e,t){var r=t(1),o=t(8),a=t(28),i=t(118).indexOf,l=t(48),s=r([].push);n.exports=function(n,e){var t,r=a(n),c=0,d=[];for(t in r)!o(l,t)&&o(r,t)&&s(d,t);for(;e.length>c;)o(r,t=e[c++])&&(~i(d,t)||s(d,t));return d}},function(n,e){n.exports=function(n){var e=null==n?0:n.length;return e?n[e-1]:void 0}},function(n,e,t){n.exports=t(247)},function(n,e,t){"use strict";var r=t(26),o=t(124).left,a=t(125),i=t(60);r({target:"Array",proto:!0,forced:!t(126)&&i>79&&i<83||!a("reduce")},{reduce:function(n){var e=arguments.length;return o(this,n,e,e>1?arguments[1]:void 0)}})},function(n,e,t){"use strict";var r={}.propertyIsEnumerable,o=Object.getOwnPropertyDescriptor,a=o&&!r.call({1:2},1);e.f=a?function(n){var e=o(this,n);return!!e&&e.enumerable}:r},function(n,e,t){var r=t(34),o=t(9),a=t(56),i=t(108),l=t(110),s=t(31),c=TypeError,d=s("toPrimitive");n.exports=function(n,e){if(!o(n)||a(n))return n;var t,s=i(n,d);if(s){if(void 0===e&&(e="default"),t=r(s,n,e),!o(t)||a(t))return t;throw c("Can't convert object to primitive value")}return void 0===e&&(e="number"),l(n,e)}},function(n,e){n.exports="undefined"!=typeof navigator&&String(navigator.userAgent)||""},function(n,e,t){var r=t(30),o=t(53);n.exports=function(n,e){var t=n[e];return o(t)?void 0:r(t)}},function(n,e){var t=String;n.exports=function(n){try{return t(n)}catch(n){return"Object"}}},function(n,e,t){var r=t(34),o=t(0),a=t(9),i=TypeError;n.exports=function(n,e){var t,l;if("string"===e&&o(t=n.toString)&&!a(l=r(t,n)))return l;if(o(t=n.valueOf)&&!a(l=r(t,n)))return l;if("string"!==e&&o(t=n.toString)&&!a(l=r(t,n)))return l;throw i("Can't convert object to primitive value")}},function(n,e,t){var r=t(0),o=t(17),a=t(99),i=t(37);n.exports=function(n,e,t,l){l||(l={});var s=l.enumerable,c=void 0!==l.name?l.name:e;if(r(t)&&a(t,c,l),l.global)s?n[e]=t:i(e,t);else{try{l.unsafe?n[e]&&(s=!0):delete n[e]}catch(n){}s?n[e]=t:o.f(n,e,{value:t,enumerable:!1,configurable:!l.nonConfigurable,writable:!l.nonWritable})}return n}},function(n,e,t){var r=t(4),o=t(8),a=Function.prototype,i=r&&Object.getOwnPropertyDescriptor,l=o(a,"name"),s=l&&"something"===function(){}.name,c=l&&(!r||r&&i(a,"name").configurable);n.exports={EXISTS:l,PROPER:s,CONFIGURABLE:c}},function(n,e,t){var r=t(1),o=t(0),a=t(36),i=r(Function.toString);o(a.inspectSource)||(a.inspectSource=function(n){return i(n)}),n.exports=a.inspectSource},function(n,e,t){var r,o,a,i=t(115),l=t(2),s=t(9),c=t(14),d=t(8),u=t(36),p=t(100),g=t(48),h=l.TypeError,f=l.WeakMap;if(i||u.state){var m=u.state||(u.state=new f);m.get=m.get,m.has=m.has,m.set=m.set,r=function(n,e){if(m.has(n))throw h("Object already initialized");return e.facade=n,m.set(n,e),e},o=function(n){return m.get(n)||{}},a=function(n){return m.has(n)}}else{var b=p("state");g[b]=!0,r=function(n,e){if(d(n,b))throw h("Object already initialized");return e.facade=n,c(n,b,e),e},o=function(n){return d(n,b)?n[b]:{}},a=function(n){return d(n,b)}}n.exports={set:r,get:o,has:a,enforce:function(n){return a(n)?o(n):r(n,{})},getterFor:function(n){return function(e){var t;if(!s(e)||(t=o(e)).type!==n)throw h("Incompatible receiver, "+n+" required");return t}}}},function(n,e,t){var r=t(2),o=t(0),a=r.WeakMap;n.exports=o(a)&&/native code/.test(String(a))},function(n,e,t){var r=t(29),o=t(1),a=t(117),i=t(122),l=t(25),s=o([].concat);n.exports=r("Reflect","ownKeys")||function(n){var e=a.f(l(n)),t=i.f;return t?s(e,t(n)):e}},function(n,e,t){var r=t(101),o=t(96).concat("length","prototype");e.f=Object.getOwnPropertyNames||function(n){return r(n,o)}},function(n,e,t){var r=t(28),o=t(119),a=t(33),i=function(n){return function(e,t,i){var l,s=r(e),c=a(s),d=o(i,c);if(n&&t!=t){for(;c>d;)if((l=s[d++])!=l)return!0}else for(;c>d;d++)if((n||d in s)&&s[d]===t)return n||d||0;return!n&&-1}};n.exports={includes:i(!0),indexOf:i(!1)}},function(n,e,t){var r=t(66),o=Math.max,a=Math.min;n.exports=function(n,e){var t=r(n);return t<0?o(t+e,0):a(t,e)}},function(n,e){var t=Math.ceil,r=Math.floor;n.exports=Math.trunc||function(n){var e=+n;return(e>0?r:t)(e)}},function(n,e,t){var r=t(66),o=Math.min;n.exports=function(n){return n>0?o(r(n),9007199254740991):0}},function(n,e){e.f=Object.getOwnPropertySymbols},function(n,e,t){var r=t(3),o=t(0),a=/#|\.prototype\./,i=function(n,e){var t=s[l(n)];return t==d||t!=c&&(o(e)?r(e):!!e)},l=i.normalize=function(n){return String(n).replace(a,".").toLowerCase()},s=i.data={},c=i.NATIVE="N",d=i.POLYFILL="P";n.exports=i},function(n,e,t){var r=t(30),o=t(32),a=t(47),i=t(33),l=TypeError,s=function(n){return function(e,t,s,c){r(t);var d=o(e),u=a(d),p=i(d),g=n?p-1:0,h=n?-1:1;if(s<2)for(;;){if(g in u){c=u[g],g+=h;break}if(g+=h,n?g<0:p<=g)throw l("Reduce of empty array with no initial value")}for(;n?g>=0:p>g;g+=h)g in u&&(c=t(c,u[g],g,d));return c}};n.exports={left:s(!1),right:s(!0)}},function(n,e,t){"use strict";var r=t(3);n.exports=function(n,e){var t=[][n];return!!t&&r((function(){t.call(null,e||function(){return 1},1)}))}},function(n,e,t){var r=t(18);n.exports="undefined"!=typeof process&&"process"==r(process)},function(n,e,t){"use strict";var r=t(4),o=t(128),a=TypeError,i=Object.getOwnPropertyDescriptor,l=r&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(n){return n instanceof TypeError}}();n.exports=l?function(n,e){if(o(n)&&!i(n,"length").writable)throw a("Cannot set read only .length");return n.length=e}:function(n,e){return n.length=e}},function(n,e,t){var r=t(18);n.exports=Array.isArray||function(n){return"Array"==r(n)}},function(n,e){var t=TypeError;n.exports=function(n){if(n>9007199254740991)throw t("Maximum allowed index exceeded");return n}},function(n,e,t){var r=t(26),o=t(2),a=t(131),i=t(132),l=o.WebAssembly,s=7!==Error("e",{cause:7}).cause,c=function(n,e){var t={};t[n]=i(n,e,s),r({global:!0,constructor:!0,arity:1,forced:s},t)},d=function(n,e){if(l&&l[n]){var t={};t[n]=i("WebAssembly."+n,e,s),r({target:"WebAssembly",stat:!0,constructor:!0,arity:1,forced:s},t)}};c("Error",(function(n){return function(e){return a(n,this,arguments)}})),c("EvalError",(function(n){return function(e){return a(n,this,arguments)}})),c("RangeError",(function(n){return function(e){return a(n,this,arguments)}})),c("ReferenceError",(function(n){return function(e){return a(n,this,arguments)}})),c("SyntaxError",(function(n){return function(e){return a(n,this,arguments)}})),c("TypeError",(function(n){return function(e){return a(n,this,arguments)}})),c("URIError",(function(n){return function(e){return a(n,this,arguments)}})),d("CompileError",(function(n){return function(e){return a(n,this,arguments)}})),d("LinkError",(function(n){return function(e){return a(n,this,arguments)}})),d("RuntimeError",(function(n){return function(e){return a(n,this,arguments)}}))},function(n,e,t){var r=t(27),o=Function.prototype,a=o.apply,i=o.call;n.exports="object"==typeof Reflect&&Reflect.apply||(r?i.bind(a):function(){return i.apply(a,arguments)})},function(n,e,t){"use strict";var r=t(29),o=t(8),a=t(14),i=t(57),l=t(67),s=t(65),c=t(135),d=t(136),u=t(137),p=t(141),g=t(142),h=t(4),f=t(62);n.exports=function(n,e,t,m){var b=m?2:1,x=n.split("."),v=x[x.length-1],y=r.apply(null,x);if(y){var k=y.prototype;if(!f&&o(k,"cause")&&delete k.cause,!t)return y;var w=r("Error"),S=e((function(n,e){var t=u(m?e:n,void 0),r=m?new y(n):new y;return void 0!==t&&a(r,"message",t),g(r,S,r.stack,2),this&&i(k,this)&&d(r,this,S),arguments.length>b&&p(r,arguments[b]),r}));if(S.prototype=k,"Error"!==v?l?l(S,w):s(S,w,{name:!0}):h&&"stackTraceLimit"in y&&(c(S,y,"stackTraceLimit"),c(S,y,"prepareStackTrace")),s(S,y),!f)try{k.name!==v&&a(k,"name",v),k.constructor=S}catch(n){}return S}}},function(n,e,t){var r=t(1),o=t(30);n.exports=function(n,e,t){try{return r(o(Object.getOwnPropertyDescriptor(n,e)[t]))}catch(n){}}},function(n,e,t){var r=t(0),o=String,a=TypeError;n.exports=function(n){if("object"==typeof n||r(n))return n;throw a("Can't set "+o(n)+" as a prototype")}},function(n,e,t){var r=t(17).f;n.exports=function(n,e,t){t in n||r(n,t,{configurable:!0,get:function(){return e[t]},set:function(n){e[t]=n}})}},function(n,e,t){var r=t(0),o=t(9),a=t(67);n.exports=function(n,e,t){var i,l;return a&&r(i=e.constructor)&&i!==t&&o(l=i.prototype)&&l!==t.prototype&&a(n,l),n}},function(n,e,t){var r=t(138);n.exports=function(n,e){return void 0===n?arguments.length<2?"":e:r(n)}},function(n,e,t){var r=t(139),o=String;n.exports=function(n){if("Symbol"===r(n))throw TypeError("Cannot convert a Symbol value to a string");return o(n)}},function(n,e,t){var r=t(140),o=t(0),a=t(18),i=t(31)("toStringTag"),l=Object,s="Arguments"==a(function(){return arguments}());n.exports=r?a:function(n){var e,t,r;return void 0===n?"Undefined":null===n?"Null":"string"==typeof(t=function(n,e){try{return n[e]}catch(n){}}(e=l(n),i))?t:s?a(e):"Object"==(r=a(e))&&o(e.callee)?"Arguments":r}},function(n,e,t){var r={};r[t(31)("toStringTag")]="z",n.exports="[object z]"===String(r)},function(n,e,t){var r=t(9),o=t(14);n.exports=function(n,e){r(e)&&"cause"in e&&o(n,"cause",e.cause)}},function(n,e,t){var r=t(14),o=t(143),a=t(144),i=Error.captureStackTrace;n.exports=function(n,e,t,l){a&&(i?i(n,e):r(n,"stack",o(t,l)))}},function(n,e,t){var r=t(1),o=Error,a=r("".replace),i=String(o("zxcasd").stack),l=/\n\s*at [^:]*:[^\n]*/,s=l.test(i);n.exports=function(n,e){if(s&&"string"==typeof n&&!o.prepareStackTrace)for(;e--;)n=a(n,l,"");return n}},function(n,e,t){var r=t(3),o=t(35);n.exports=!r((function(){var n=Error("a");return!("stack"in n)||(Object.defineProperty(n,"stack",o(1,7)),7!==n.stack)}))},function(n,e,t){var r=t(68),o=t(146);n.exports=function n(e,t,a,i,l){var s=-1,c=e.length;for(a||(a=o),l||(l=[]);++s<c;){var d=e[s];t>0&&a(d)?t>1?n(d,t-1,a,i,l):r(l,d):i||(l[l.length]=d)}return l}},function(n,e,t){var r=t(15),o=t(38),a=t(5),i=r?r.isConcatSpreadable:void 0;n.exports=function(n){return a(n)||o(n)||!!(i&&n&&n[i])}},function(n,e,t){var r=t(13),o=t(12);n.exports=function(n){return o(n)&&"[object Arguments]"==r(n)}},function(n,e,t){var r=t(15),o=Object.prototype,a=o.hasOwnProperty,i=o.toString,l=r?r.toStringTag:void 0;n.exports=function(n){var e=a.call(n,l),t=n[l];try{n[l]=void 0;var r=!0}catch(n){}var o=i.call(n);return r&&(e?n[l]=t:delete n[l]),o}},function(n,e){var t=Object.prototype.toString;n.exports=function(n){return t.call(n)}},function(n,e,t){var r=t(151),o=t(207),a=t(46),i=t(5),l=t(218);n.exports=function(n){return"function"==typeof n?n:null==n?a:"object"==typeof n?i(n)?o(n[0],n[1]):r(n):l(n)}},function(n,e,t){var r=t(152),o=t(206),a=t(85);n.exports=function(n){var e=o(n);return 1==e.length&&e[0][2]?a(e[0][0],e[0][1]):function(t){return t===n||r(t,n,e)}}},function(n,e,t){var r=t(70),o=t(74);n.exports=function(n,e,t,a){var i=t.length,l=i,s=!a;if(null==n)return!l;for(n=Object(n);i--;){var c=t[i];if(s&&c[2]?c[1]!==n[c[0]]:!(c[0]in n))return!1}for(;++i<l;){var d=(c=t[i])[0],u=n[d],p=c[1];if(s&&c[2]){if(void 0===u&&!(d in n))return!1}else{var g=new r;if(a)var h=a(u,p,d,n,e,g);if(!(void 0===h?o(p,u,3,a,g):h))return!1}}return!0}},function(n,e){n.exports=function(){this.__data__=[],this.size=0}},function(n,e,t){var r=t(20),o=Array.prototype.splice;n.exports=function(n){var e=this.__data__,t=r(e,n);return!(t<0)&&(t==e.length-1?e.pop():o.call(e,t,1),--this.size,!0)}},function(n,e,t){var r=t(20);n.exports=function(n){var e=this.__data__,t=r(e,n);return t<0?void 0:e[t][1]}},function(n,e,t){var r=t(20);n.exports=function(n){return r(this.__data__,n)>-1}},function(n,e,t){var r=t(20);n.exports=function(n,e){var t=this.__data__,o=r(t,n);return o<0?(++this.size,t.push([n,e])):t[o][1]=e,this}},function(n,e,t){var r=t(19);n.exports=function(){this.__data__=new r,this.size=0}},function(n,e){n.exports=function(n){var e=this.__data__,t=e.delete(n);return this.size=e.size,t}},function(n,e){n.exports=function(n){return this.__data__.get(n)}},function(n,e){n.exports=function(n){return this.__data__.has(n)}},function(n,e,t){var r=t(19),o=t(39),a=t(41);n.exports=function(n,e){var t=this.__data__;if(t instanceof r){var i=t.__data__;if(!o||i.length<199)return i.push([n,e]),this.size=++t.size,this;t=this.__data__=new a(i)}return t.set(n,e),this.size=t.size,this}},function(n,e,t){var r=t(72),o=t(164),a=t(40),i=t(73),l=/^\[object .+?Constructor\]$/,s=Function.prototype,c=Object.prototype,d=s.toString,u=c.hasOwnProperty,p=RegExp("^"+d.call(u).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");n.exports=function(n){return!(!a(n)||o(n))&&(r(n)?p:l).test(i(n))}},function(n,e,t){var r,o=t(165),a=(r=/[^.]+$/.exec(o&&o.keys&&o.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";n.exports=function(n){return!!a&&a in n}},function(n,e,t){var r=t(6)["__core-js_shared__"];n.exports=r},function(n,e){n.exports=function(n,e){return null==n?void 0:n[e]}},function(n,e,t){var r=t(168),o=t(19),a=t(39);n.exports=function(){this.size=0,this.__data__={hash:new r,map:new(a||o),string:new r}}},function(n,e,t){var r=t(169),o=t(170),a=t(171),i=t(172),l=t(173);function s(n){var e=-1,t=null==n?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}s.prototype.clear=r,s.prototype.delete=o,s.prototype.get=a,s.prototype.has=i,s.prototype.set=l,n.exports=s},function(n,e,t){var r=t(21);n.exports=function(){this.__data__=r?r(null):{},this.size=0}},function(n,e){n.exports=function(n){var e=this.has(n)&&delete this.__data__[n];return this.size-=e?1:0,e}},function(n,e,t){var r=t(21),o=Object.prototype.hasOwnProperty;n.exports=function(n){var e=this.__data__;if(r){var t=e[n];return"__lodash_hash_undefined__"===t?void 0:t}return o.call(e,n)?e[n]:void 0}},function(n,e,t){var r=t(21),o=Object.prototype.hasOwnProperty;n.exports=function(n){var e=this.__data__;return r?void 0!==e[n]:o.call(e,n)}},function(n,e,t){var r=t(21);n.exports=function(n,e){var t=this.__data__;return this.size+=this.has(n)?0:1,t[n]=r&&void 0===e?"__lodash_hash_undefined__":e,this}},function(n,e,t){var r=t(22);n.exports=function(n){var e=r(this,n).delete(n);return this.size-=e?1:0,e}},function(n,e){n.exports=function(n){var e=typeof n;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==n:null===n}},function(n,e,t){var r=t(22);n.exports=function(n){return r(this,n).get(n)}},function(n,e,t){var r=t(22);n.exports=function(n){return r(this,n).has(n)}},function(n,e,t){var r=t(22);n.exports=function(n,e){var t=r(this,n),o=t.size;return t.set(n,e),this.size+=t.size==o?0:1,this}},function(n,e,t){var r=t(70),o=t(75),a=t(183),i=t(186),l=t(202),s=t(5),c=t(79),d=t(81),u="[object Object]",p=Object.prototype.hasOwnProperty;n.exports=function(n,e,t,g,h,f){var m=s(n),b=s(e),x=m?"[object Array]":l(n),v=b?"[object Array]":l(e),y=(x="[object Arguments]"==x?u:x)==u,k=(v="[object Arguments]"==v?u:v)==u,w=x==v;if(w&&c(n)){if(!c(e))return!1;m=!0,y=!1}if(w&&!y)return f||(f=new r),m||d(n)?o(n,e,t,g,h,f):a(n,e,x,t,g,h,f);if(!(1&t)){var S=y&&p.call(n,"__wrapped__"),j=k&&p.call(e,"__wrapped__");if(S||j){var T=S?n.value():n,_=j?e.value():e;return f||(f=new r),h(T,_,t,g,f)}}return!!w&&(f||(f=new r),i(n,e,t,g,h,f))}},function(n,e){n.exports=function(n){return this.__data__.set(n,"__lodash_hash_undefined__"),this}},function(n,e){n.exports=function(n){return this.__data__.has(n)}},function(n,e){n.exports=function(n,e){for(var t=-1,r=null==n?0:n.length;++t<r;)if(e(n[t],t,n))return!0;return!1}},function(n,e,t){var r=t(15),o=t(184),a=t(71),i=t(75),l=t(185),s=t(42),c=r?r.prototype:void 0,d=c?c.valueOf:void 0;n.exports=function(n,e,t,r,c,u,p){switch(t){case"[object DataView]":if(n.byteLength!=e.byteLength||n.byteOffset!=e.byteOffset)return!1;n=n.buffer,e=e.buffer;case"[object ArrayBuffer]":return!(n.byteLength!=e.byteLength||!u(new o(n),new o(e)));case"[object Boolean]":case"[object Date]":case"[object Number]":return a(+n,+e);case"[object Error]":return n.name==e.name&&n.message==e.message;case"[object RegExp]":case"[object String]":return n==e+"";case"[object Map]":var g=l;case"[object Set]":var h=1&r;if(g||(g=s),n.size!=e.size&&!h)return!1;var f=p.get(n);if(f)return f==e;r|=2,p.set(n,e);var m=i(g(n),g(e),r,c,u,p);return p.delete(n),m;case"[object Symbol]":if(d)return d.call(n)==d.call(e)}return!1}},function(n,e,t){var r=t(6).Uint8Array;n.exports=r},function(n,e){n.exports=function(n){var e=-1,t=Array(n.size);return n.forEach((function(n,r){t[++e]=[r,n]})),t}},function(n,e,t){var r=t(187),o=Object.prototype.hasOwnProperty;n.exports=function(n,e,t,a,i,l){var s=1&t,c=r(n),d=c.length;if(d!=r(e).length&&!s)return!1;for(var u=d;u--;){var p=c[u];if(!(s?p in e:o.call(e,p)))return!1}var g=l.get(n),h=l.get(e);if(g&&h)return g==e&&h==n;var f=!0;l.set(n,e),l.set(e,n);for(var m=s;++u<d;){var b=n[p=c[u]],x=e[p];if(a)var v=s?a(x,b,p,e,n,l):a(b,x,p,n,e,l);if(!(void 0===v?b===x||i(b,x,t,a,l):v)){f=!1;break}m||(m="constructor"==p)}if(f&&!m){var y=n.constructor,k=e.constructor;y==k||!("constructor"in n)||!("constructor"in e)||"function"==typeof y&&y instanceof y&&"function"==typeof k&&k instanceof k||(f=!1)}return l.delete(n),l.delete(e),f}},function(n,e,t){var r=t(188),o=t(189),a=t(78);n.exports=function(n){return r(n,a,o)}},function(n,e,t){var r=t(68),o=t(5);n.exports=function(n,e,t){var a=e(n);return o(n)?a:r(a,t(n))}},function(n,e,t){var r=t(190),o=t(191),a=Object.prototype.propertyIsEnumerable,i=Object.getOwnPropertySymbols,l=i?function(n){return null==n?[]:(n=Object(n),r(i(n),(function(e){return a.call(n,e)})))}:o;n.exports=l},function(n,e){n.exports=function(n,e){for(var t=-1,r=null==n?0:n.length,o=0,a=[];++t<r;){var i=n[t];e(i,t,n)&&(a[o++]=i)}return a}},function(n,e){n.exports=function(){return[]}},function(n,e,t){var r=t(193),o=t(38),a=t(5),i=t(79),l=t(80),s=t(81),c=Object.prototype.hasOwnProperty;n.exports=function(n,e){var t=a(n),d=!t&&o(n),u=!t&&!d&&i(n),p=!t&&!d&&!u&&s(n),g=t||d||u||p,h=g?r(n.length,String):[],f=h.length;for(var m in n)!e&&!c.call(n,m)||g&&("length"==m||u&&("offset"==m||"parent"==m)||p&&("buffer"==m||"byteLength"==m||"byteOffset"==m)||l(m,f))||h.push(m);return h}},function(n,e){n.exports=function(n,e){for(var t=-1,r=Array(n);++t<n;)r[t]=e(t);return r}},function(n,e){n.exports=function(){return!1}},function(n,e,t){var r=t(13),o=t(43),a=t(12),i={};i["[object Float32Array]"]=i["[object Float64Array]"]=i["[object Int8Array]"]=i["[object Int16Array]"]=i["[object Int32Array]"]=i["[object Uint8Array]"]=i["[object Uint8ClampedArray]"]=i["[object Uint16Array]"]=i["[object Uint32Array]"]=!0,i["[object Arguments]"]=i["[object Array]"]=i["[object ArrayBuffer]"]=i["[object Boolean]"]=i["[object DataView]"]=i["[object Date]"]=i["[object Error]"]=i["[object Function]"]=i["[object Map]"]=i["[object Number]"]=i["[object Object]"]=i["[object RegExp]"]=i["[object Set]"]=i["[object String]"]=i["[object WeakMap]"]=!1,n.exports=function(n){return a(n)&&o(n.length)&&!!i[r(n)]}},function(n,e){n.exports=function(n){return function(e){return n(e)}}},function(n,e,t){(function(n){var r=t(69),o=e&&!e.nodeType&&e,a=o&&"object"==typeof n&&n&&!n.nodeType&&n,i=a&&a.exports===o&&r.process,l=function(){try{var n=a&&a.require&&a.require("util").types;return n||i&&i.binding&&i.binding("util")}catch(n){}}();n.exports=l}).call(this,t(49)(n))},function(n,e,t){var r=t(199),o=t(200),a=Object.prototype.hasOwnProperty;n.exports=function(n){if(!r(n))return o(n);var e=[];for(var t in Object(n))a.call(n,t)&&"constructor"!=t&&e.push(t);return e}},function(n,e){var t=Object.prototype;n.exports=function(n){var e=n&&n.constructor;return n===("function"==typeof e&&e.prototype||t)}},function(n,e,t){var r=t(201)(Object.keys,Object);n.exports=r},function(n,e){n.exports=function(n,e){return function(t){return n(e(t))}}},function(n,e,t){var r=t(203),o=t(39),a=t(204),i=t(83),l=t(205),s=t(13),c=t(73),d=c(r),u=c(o),p=c(a),g=c(i),h=c(l),f=s;(r&&"[object DataView]"!=f(new r(new ArrayBuffer(1)))||o&&"[object Map]"!=f(new o)||a&&"[object Promise]"!=f(a.resolve())||i&&"[object Set]"!=f(new i)||l&&"[object WeakMap]"!=f(new l))&&(f=function(n){var e=s(n),t="[object Object]"==e?n.constructor:void 0,r=t?c(t):"";if(r)switch(r){case d:return"[object DataView]";case u:return"[object Map]";case p:return"[object Promise]";case g:return"[object Set]";case h:return"[object WeakMap]"}return e}),n.exports=f},function(n,e,t){var r=t(10)(t(6),"DataView");n.exports=r},function(n,e,t){var r=t(10)(t(6),"Promise");n.exports=r},function(n,e,t){var r=t(10)(t(6),"WeakMap");n.exports=r},function(n,e,t){var r=t(84),o=t(78);n.exports=function(n){for(var e=o(n),t=e.length;t--;){var a=e[t],i=n[a];e[t]=[a,i,r(i)]}return e}},function(n,e,t){var r=t(74),o=t(208),a=t(215),i=t(44),l=t(84),s=t(85),c=t(23);n.exports=function(n,e){return i(n)&&l(e)?s(c(n),e):function(t){var i=o(t,n);return void 0===i&&i===e?a(t,n):r(e,i,3)}}},function(n,e,t){var r=t(86);n.exports=function(n,e,t){var o=null==n?void 0:r(n,e);return void 0===o?t:o}},function(n,e,t){var r=t(210),o=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,a=/\\(\\)?/g,i=r((function(n){var e=[];return 46===n.charCodeAt(0)&&e.push(""),n.replace(o,(function(n,t,r,o){e.push(r?o.replace(a,"$1"):t||n)})),e}));n.exports=i},function(n,e,t){var r=t(211);n.exports=function(n){var e=r(n,(function(n){return 500===t.size&&t.clear(),n})),t=e.cache;return e}},function(n,e,t){var r=t(41);function o(n,e){if("function"!=typeof n||null!=e&&"function"!=typeof e)throw new TypeError("Expected a function");var t=function(){var r=arguments,o=e?e.apply(this,r):r[0],a=t.cache;if(a.has(o))return a.get(o);var i=n.apply(this,r);return t.cache=a.set(o,i)||a,i};return t.cache=new(o.Cache||r),t}o.Cache=r,n.exports=o},function(n,e,t){var r=t(213);n.exports=function(n){return null==n?"":r(n)}},function(n,e,t){var r=t(15),o=t(214),a=t(5),i=t(45),l=r?r.prototype:void 0,s=l?l.toString:void 0;n.exports=function n(e){if("string"==typeof e)return e;if(a(e))return o(e,n)+"";if(i(e))return s?s.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(n,e){n.exports=function(n,e){for(var t=-1,r=null==n?0:n.length,o=Array(r);++t<r;)o[t]=e(n[t],t,n);return o}},function(n,e,t){var r=t(216),o=t(217);n.exports=function(n,e){return null!=n&&o(n,e,r)}},function(n,e){n.exports=function(n,e){return null!=n&&e in Object(n)}},function(n,e,t){var r=t(87),o=t(38),a=t(5),i=t(80),l=t(43),s=t(23);n.exports=function(n,e,t){for(var c=-1,d=(e=r(e,n)).length,u=!1;++c<d;){var p=s(e[c]);if(!(u=null!=n&&t(n,p)))break;n=n[p]}return u||++c!=d?u:!!(d=null==n?0:n.length)&&l(d)&&i(p,d)&&(a(n)||o(n))}},function(n,e,t){var r=t(219),o=t(220),a=t(44),i=t(23);n.exports=function(n){return a(n)?r(i(n)):o(n)}},function(n,e){n.exports=function(n){return function(e){return null==e?void 0:e[n]}}},function(n,e,t){var r=t(86);n.exports=function(n){return function(e){return r(e,n)}}},function(n,e,t){var r=t(46),o=t(222),a=t(224);n.exports=function(n,e){return a(o(n,e,r),n+"")}},function(n,e,t){var r=t(223),o=Math.max;n.exports=function(n,e,t){return e=o(void 0===e?n.length-1:e,0),function(){for(var a=arguments,i=-1,l=o(a.length-e,0),s=Array(l);++i<l;)s[i]=a[e+i];i=-1;for(var c=Array(e+1);++i<e;)c[i]=a[i];return c[e]=t(s),r(n,this,c)}}},function(n,e){n.exports=function(n,e,t){switch(t.length){case 0:return n.call(e);case 1:return n.call(e,t[0]);case 2:return n.call(e,t[0],t[1]);case 3:return n.call(e,t[0],t[1],t[2])}return n.apply(e,t)}},function(n,e,t){var r=t(225),o=t(228)(r);n.exports=o},function(n,e,t){var r=t(226),o=t(227),a=t(46),i=o?function(n,e){return o(n,"toString",{configurable:!0,enumerable:!1,value:r(e),writable:!0})}:a;n.exports=i},function(n,e){n.exports=function(n){return function(){return n}}},function(n,e,t){var r=t(10),o=function(){try{var n=r(Object,"defineProperty");return n({},"",{}),n}catch(n){}}();n.exports=o},function(n,e){var t=Date.now;n.exports=function(n){var e=0,r=0;return function(){var o=t(),a=16-(o-r);if(r=o,a>0){if(++e>=800)return arguments[0]}else e=0;return n.apply(void 0,arguments)}}},function(n,e,t){var r=t(76),o=t(230),a=t(235),i=t(77),l=t(236),s=t(42);n.exports=function(n,e,t){var c=-1,d=o,u=n.length,p=!0,g=[],h=g;if(t)p=!1,d=a;else if(u>=200){var f=e?null:l(n);if(f)return s(f);p=!1,d=i,h=new r}else h=e?[]:g;n:for(;++c<u;){var m=n[c],b=e?e(m):m;if(m=t||0!==m?m:0,p&&b==b){for(var x=h.length;x--;)if(h[x]===b)continue n;e&&h.push(b),g.push(m)}else d(h,b,t)||(h!==g&&h.push(b),g.push(m))}return g}},function(n,e,t){var r=t(231);n.exports=function(n,e){return!!(null==n?0:n.length)&&r(n,e,0)>-1}},function(n,e,t){var r=t(232),o=t(233),a=t(234);n.exports=function(n,e,t){return e==e?a(n,e,t):r(n,o,t)}},function(n,e){n.exports=function(n,e,t,r){for(var o=n.length,a=t+(r?1:-1);r?a--:++a<o;)if(e(n[a],a,n))return a;return-1}},function(n,e){n.exports=function(n){return n!=n}},function(n,e){n.exports=function(n,e,t){for(var r=t-1,o=n.length;++r<o;)if(n[r]===e)return r;return-1}},function(n,e){n.exports=function(n,e,t){for(var r=-1,o=null==n?0:n.length;++r<o;)if(t(e,n[r]))return!0;return!1}},function(n,e,t){var r=t(83),o=t(237),a=t(42),i=r&&1/a(new r([,-0]))[1]==1/0?function(n){return new r(n)}:o;n.exports=i},function(n,e){n.exports=function(){}},function(n,e,t){var r=t(82),o=t(12);n.exports=function(n){return o(n)&&r(n)}},function(n,e,t){},function(n,e,t){},function(n,e,t){"use strict";t(88)},function(n,e,t){"use strict";t(89)},function(n,e,t){},function(n,e,t){},function(n,e,t){"use strict";t(90)},function(n,e,t){"use strict";t(91)},function(n,e,t){"use strict";t.r(e);
/*!
 * Vue.js v2.7.14
 * (c) 2014-2022 Evan You
 * Released under the MIT License.
 */
var r=Object.freeze({}),o=Array.isArray;function a(n){return null==n}function i(n){return null!=n}function l(n){return!0===n}function s(n){return"string"==typeof n||"number"==typeof n||"symbol"==typeof n||"boolean"==typeof n}function c(n){return"function"==typeof n}function d(n){return null!==n&&"object"==typeof n}var u=Object.prototype.toString;function p(n){return"[object Object]"===u.call(n)}function g(n){return"[object RegExp]"===u.call(n)}function h(n){var e=parseFloat(String(n));return e>=0&&Math.floor(e)===e&&isFinite(n)}function f(n){return i(n)&&"function"==typeof n.then&&"function"==typeof n.catch}function m(n){return null==n?"":Array.isArray(n)||p(n)&&n.toString===u?JSON.stringify(n,null,2):String(n)}function b(n){var e=parseFloat(n);return isNaN(e)?n:e}function x(n,e){for(var t=Object.create(null),r=n.split(","),o=0;o<r.length;o++)t[r[o]]=!0;return e?function(n){return t[n.toLowerCase()]}:function(n){return t[n]}}x("slot,component",!0);var v=x("key,ref,slot,slot-scope,is");function y(n,e){var t=n.length;if(t){if(e===n[t-1])return void(n.length=t-1);var r=n.indexOf(e);if(r>-1)return n.splice(r,1)}}var k=Object.prototype.hasOwnProperty;function w(n,e){return k.call(n,e)}function S(n){var e=Object.create(null);return function(t){return e[t]||(e[t]=n(t))}}var j=/-(\w)/g,T=S((function(n){return n.replace(j,(function(n,e){return e?e.toUpperCase():""}))})),_=S((function(n){return n.charAt(0).toUpperCase()+n.slice(1)})),C=/\B([A-Z])/g,E=S((function(n){return n.replace(C,"-$1").toLowerCase()}));var I=Function.prototype.bind?function(n,e){return n.bind(e)}:function(n,e){function t(t){var r=arguments.length;return r?r>1?n.apply(e,arguments):n.call(e,t):n.call(e)}return t._length=n.length,t};function A(n,e){e=e||0;for(var t=n.length-e,r=new Array(t);t--;)r[t]=n[t+e];return r}function P(n,e){for(var t in e)n[t]=e[t];return n}function L(n){for(var e={},t=0;t<n.length;t++)n[t]&&P(e,n[t]);return e}function R(n,e,t){}var B=function(n,e,t){return!1},O=function(n){return n};function N(n,e){if(n===e)return!0;var t=d(n),r=d(e);if(!t||!r)return!t&&!r&&String(n)===String(e);try{var o=Array.isArray(n),a=Array.isArray(e);if(o&&a)return n.length===e.length&&n.every((function(n,t){return N(n,e[t])}));if(n instanceof Date&&e instanceof Date)return n.getTime()===e.getTime();if(o||a)return!1;var i=Object.keys(n),l=Object.keys(e);return i.length===l.length&&i.every((function(t){return N(n[t],e[t])}))}catch(n){return!1}}function M(n,e){for(var t=0;t<n.length;t++)if(N(n[t],e))return t;return-1}function z(n){var e=!1;return function(){e||(e=!0,n.apply(this,arguments))}}function D(n,e){return n===e?0===n&&1/n!=1/e:n==n||e==e}var q=["component","directive","filter"],J=["beforeCreate","created","beforeMount","mounted","beforeUpdate","updated","beforeDestroy","destroyed","activated","deactivated","errorCaptured","serverPrefetch","renderTracked","renderTriggered"],F={optionMergeStrategies:Object.create(null),silent:!1,productionTip:!1,devtools:!1,performance:!1,errorHandler:null,warnHandler:null,ignoredElements:[],keyCodes:Object.create(null),isReservedTag:B,isReservedAttr:B,isUnknownElement:B,getTagNamespace:R,parsePlatformTagName:O,mustUseProp:B,async:!0,_lifecycleHooks:J},U=/a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD/;function H(n){var e=(n+"").charCodeAt(0);return 36===e||95===e}function X(n,e,t,r){Object.defineProperty(n,e,{value:t,enumerable:!!r,writable:!0,configurable:!0})}var $=new RegExp("[^".concat(U.source,".$_\\d]"));var W="__proto__"in{},Q="undefined"!=typeof window,G=Q&&window.navigator.userAgent.toLowerCase(),V=G&&/msie|trident/.test(G),K=G&&G.indexOf("msie 9.0")>0,Z=G&&G.indexOf("edge/")>0;G&&G.indexOf("android");var Y=G&&/iphone|ipad|ipod|ios/.test(G);G&&/chrome\/\d+/.test(G),G&&/phantomjs/.test(G);var nn,en=G&&G.match(/firefox\/(\d+)/),tn={}.watch,rn=!1;if(Q)try{var on={};Object.defineProperty(on,"passive",{get:function(){rn=!0}}),window.addEventListener("test-passive",null,on)}catch(n){}var an=function(){return void 0===nn&&(nn=!Q&&"undefined"!=typeof global&&(global.process&&"server"===global.process.env.VUE_ENV)),nn},ln=Q&&window.__VUE_DEVTOOLS_GLOBAL_HOOK__;function sn(n){return"function"==typeof n&&/native code/.test(n.toString())}var cn,dn="undefined"!=typeof Symbol&&sn(Symbol)&&"undefined"!=typeof Reflect&&sn(Reflect.ownKeys);cn="undefined"!=typeof Set&&sn(Set)?Set:function(){function n(){this.set=Object.create(null)}return n.prototype.has=function(n){return!0===this.set[n]},n.prototype.add=function(n){this.set[n]=!0},n.prototype.clear=function(){this.set=Object.create(null)},n}();var un=null;function pn(n){void 0===n&&(n=null),n||un&&un._scope.off(),un=n,n&&n._scope.on()}var gn=function(){function n(n,e,t,r,o,a,i,l){this.tag=n,this.data=e,this.children=t,this.text=r,this.elm=o,this.ns=void 0,this.context=a,this.fnContext=void 0,this.fnOptions=void 0,this.fnScopeId=void 0,this.key=e&&e.key,this.componentOptions=i,this.componentInstance=void 0,this.parent=void 0,this.raw=!1,this.isStatic=!1,this.isRootInsert=!0,this.isComment=!1,this.isCloned=!1,this.isOnce=!1,this.asyncFactory=l,this.asyncMeta=void 0,this.isAsyncPlaceholder=!1}return Object.defineProperty(n.prototype,"child",{get:function(){return this.componentInstance},enumerable:!1,configurable:!0}),n}(),hn=function(n){void 0===n&&(n="");var e=new gn;return e.text=n,e.isComment=!0,e};function fn(n){return new gn(void 0,void 0,void 0,String(n))}function mn(n){var e=new gn(n.tag,n.data,n.children&&n.children.slice(),n.text,n.elm,n.context,n.componentOptions,n.asyncFactory);return e.ns=n.ns,e.isStatic=n.isStatic,e.key=n.key,e.isComment=n.isComment,e.fnContext=n.fnContext,e.fnOptions=n.fnOptions,e.fnScopeId=n.fnScopeId,e.asyncMeta=n.asyncMeta,e.isCloned=!0,e}var bn=0,xn=[],vn=function(){function n(){this._pending=!1,this.id=bn++,this.subs=[]}return n.prototype.addSub=function(n){this.subs.push(n)},n.prototype.removeSub=function(n){this.subs[this.subs.indexOf(n)]=null,this._pending||(this._pending=!0,xn.push(this))},n.prototype.depend=function(e){n.target&&n.target.addDep(this)},n.prototype.notify=function(n){var e=this.subs.filter((function(n){return n}));for(var t=0,r=e.length;t<r;t++){0,e[t].update()}},n}();vn.target=null;var yn=[];function kn(n){yn.push(n),vn.target=n}function wn(){yn.pop(),vn.target=yn[yn.length-1]}var Sn=Array.prototype,jn=Object.create(Sn);["push","pop","shift","unshift","splice","sort","reverse"].forEach((function(n){var e=Sn[n];X(jn,n,(function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o,a=e.apply(this,t),i=this.__ob__;switch(n){case"push":case"unshift":o=t;break;case"splice":o=t.slice(2)}return o&&i.observeArray(o),i.dep.notify(),a}))}));var Tn=Object.getOwnPropertyNames(jn),_n={},Cn=!0;function En(n){Cn=n}var In={notify:R,depend:R,addSub:R,removeSub:R},An=function(){function n(n,e,t){if(void 0===e&&(e=!1),void 0===t&&(t=!1),this.value=n,this.shallow=e,this.mock=t,this.dep=t?In:new vn,this.vmCount=0,X(n,"__ob__",this),o(n)){if(!t)if(W)n.__proto__=jn;else for(var r=0,a=Tn.length;r<a;r++){X(n,l=Tn[r],jn[l])}e||this.observeArray(n)}else{var i=Object.keys(n);for(r=0;r<i.length;r++){var l;Ln(n,l=i[r],_n,void 0,e,t)}}}return n.prototype.observeArray=function(n){for(var e=0,t=n.length;e<t;e++)Pn(n[e],!1,this.mock)},n}();function Pn(n,e,t){return n&&w(n,"__ob__")&&n.__ob__ instanceof An?n.__ob__:!Cn||!t&&an()||!o(n)&&!p(n)||!Object.isExtensible(n)||n.__v_skip||Dn(n)||n instanceof gn?void 0:new An(n,e,t)}function Ln(n,e,t,r,a,i){var l=new vn,s=Object.getOwnPropertyDescriptor(n,e);if(!s||!1!==s.configurable){var c=s&&s.get,d=s&&s.set;c&&!d||t!==_n&&2!==arguments.length||(t=n[e]);var u=!a&&Pn(t,!1,i);return Object.defineProperty(n,e,{enumerable:!0,configurable:!0,get:function(){var e=c?c.call(n):t;return vn.target&&(l.depend(),u&&(u.dep.depend(),o(e)&&On(e))),Dn(e)&&!a?e.value:e},set:function(e){var r=c?c.call(n):t;if(D(r,e)){if(d)d.call(n,e);else{if(c)return;if(!a&&Dn(r)&&!Dn(e))return void(r.value=e);t=e}u=!a&&Pn(e,!1,i),l.notify()}}}),l}}function Rn(n,e,t){if(!zn(n)){var r=n.__ob__;return o(n)&&h(e)?(n.length=Math.max(n.length,e),n.splice(e,1,t),r&&!r.shallow&&r.mock&&Pn(t,!1,!0),t):e in n&&!(e in Object.prototype)?(n[e]=t,t):n._isVue||r&&r.vmCount?t:r?(Ln(r.value,e,t,void 0,r.shallow,r.mock),r.dep.notify(),t):(n[e]=t,t)}}function Bn(n,e){if(o(n)&&h(e))n.splice(e,1);else{var t=n.__ob__;n._isVue||t&&t.vmCount||zn(n)||w(n,e)&&(delete n[e],t&&t.dep.notify())}}function On(n){for(var e=void 0,t=0,r=n.length;t<r;t++)(e=n[t])&&e.__ob__&&e.__ob__.dep.depend(),o(e)&&On(e)}function Nn(n){return Mn(n,!0),X(n,"__v_isShallow",!0),n}function Mn(n,e){if(!zn(n)){Pn(n,e,an());0}}function zn(n){return!(!n||!n.__v_isReadonly)}function Dn(n){return!(!n||!0!==n.__v_isRef)}function qn(n,e,t){Object.defineProperty(n,t,{enumerable:!0,configurable:!0,get:function(){var n=e[t];if(Dn(n))return n.value;var r=n&&n.__ob__;return r&&r.dep.depend(),n},set:function(n){var r=e[t];Dn(r)&&!Dn(n)?r.value=n:e[t]=n}})}"".concat("watcher"," callback"),"".concat("watcher"," getter"),"".concat("watcher"," cleanup");var Jn;var Fn=function(){function n(n){void 0===n&&(n=!1),this.detached=n,this.active=!0,this.effects=[],this.cleanups=[],this.parent=Jn,!n&&Jn&&(this.index=(Jn.scopes||(Jn.scopes=[])).push(this)-1)}return n.prototype.run=function(n){if(this.active){var e=Jn;try{return Jn=this,n()}finally{Jn=e}}else 0},n.prototype.on=function(){Jn=this},n.prototype.off=function(){Jn=this.parent},n.prototype.stop=function(n){if(this.active){var e=void 0,t=void 0;for(e=0,t=this.effects.length;e<t;e++)this.effects[e].teardown();for(e=0,t=this.cleanups.length;e<t;e++)this.cleanups[e]();if(this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].stop(!0);if(!this.detached&&this.parent&&!n){var r=this.parent.scopes.pop();r&&r!==this&&(this.parent.scopes[this.index]=r,r.index=this.index)}this.parent=void 0,this.active=!1}},n}();function Un(n){var e=n._provided,t=n.$parent&&n.$parent._provided;return t===e?n._provided=Object.create(t):e}var Hn=S((function(n){var e="&"===n.charAt(0),t="~"===(n=e?n.slice(1):n).charAt(0),r="!"===(n=t?n.slice(1):n).charAt(0);return{name:n=r?n.slice(1):n,once:t,capture:r,passive:e}}));function Xn(n,e){function t(){var n=t.fns;if(!o(n))return Ce(n,null,arguments,e,"v-on handler");for(var r=n.slice(),a=0;a<r.length;a++)Ce(r[a],null,arguments,e,"v-on handler")}return t.fns=n,t}function $n(n,e,t,r,o,i){var s,c,d,u;for(s in n)c=n[s],d=e[s],u=Hn(s),a(c)||(a(d)?(a(c.fns)&&(c=n[s]=Xn(c,i)),l(u.once)&&(c=n[s]=o(u.name,c,u.capture)),t(u.name,c,u.capture,u.passive,u.params)):c!==d&&(d.fns=c,n[s]=d));for(s in e)a(n[s])&&r((u=Hn(s)).name,e[s],u.capture)}function Wn(n,e,t){var r;n instanceof gn&&(n=n.data.hook||(n.data.hook={}));var o=n[e];function s(){t.apply(this,arguments),y(r.fns,s)}a(o)?r=Xn([s]):i(o.fns)&&l(o.merged)?(r=o).fns.push(s):r=Xn([o,s]),r.merged=!0,n[e]=r}function Qn(n,e,t,r,o){if(i(e)){if(w(e,t))return n[t]=e[t],o||delete e[t],!0;if(w(e,r))return n[t]=e[r],o||delete e[r],!0}return!1}function Gn(n){return s(n)?[fn(n)]:o(n)?function n(e,t){var r,c,d,u,p=[];for(r=0;r<e.length;r++)a(c=e[r])||"boolean"==typeof c||(d=p.length-1,u=p[d],o(c)?c.length>0&&(Vn((c=n(c,"".concat(t||"","_").concat(r)))[0])&&Vn(u)&&(p[d]=fn(u.text+c[0].text),c.shift()),p.push.apply(p,c)):s(c)?Vn(u)?p[d]=fn(u.text+c):""!==c&&p.push(fn(c)):Vn(c)&&Vn(u)?p[d]=fn(u.text+c.text):(l(e._isVList)&&i(c.tag)&&a(c.key)&&i(t)&&(c.key="__vlist".concat(t,"_").concat(r,"__")),p.push(c)));return p}(n):void 0}function Vn(n){return i(n)&&i(n.text)&&!1===n.isComment}function Kn(n,e){var t,r,a,l,s=null;if(o(n)||"string"==typeof n)for(s=new Array(n.length),t=0,r=n.length;t<r;t++)s[t]=e(n[t],t);else if("number"==typeof n)for(s=new Array(n),t=0;t<n;t++)s[t]=e(t+1,t);else if(d(n))if(dn&&n[Symbol.iterator]){s=[];for(var c=n[Symbol.iterator](),u=c.next();!u.done;)s.push(e(u.value,s.length)),u=c.next()}else for(a=Object.keys(n),s=new Array(a.length),t=0,r=a.length;t<r;t++)l=a[t],s[t]=e(n[l],l,t);return i(s)||(s=[]),s._isVList=!0,s}function Zn(n,e,t,r){var o,a=this.$scopedSlots[n];a?(t=t||{},r&&(t=P(P({},r),t)),o=a(t)||(c(e)?e():e)):o=this.$slots[n]||(c(e)?e():e);var i=t&&t.slot;return i?this.$createElement("template",{slot:i},o):o}function Yn(n){return At(this.$options,"filters",n,!0)||O}function ne(n,e){return o(n)?-1===n.indexOf(e):n!==e}function ee(n,e,t,r,o){var a=F.keyCodes[e]||t;return o&&r&&!F.keyCodes[e]?ne(o,r):a?ne(a,n):r?E(r)!==e:void 0===n}function te(n,e,t,r,a){if(t)if(d(t)){o(t)&&(t=L(t));var i=void 0,l=function(o){if("class"===o||"style"===o||v(o))i=n;else{var l=n.attrs&&n.attrs.type;i=r||F.mustUseProp(e,l,o)?n.domProps||(n.domProps={}):n.attrs||(n.attrs={})}var s=T(o),c=E(o);s in i||c in i||(i[o]=t[o],a&&((n.on||(n.on={}))["update:".concat(o)]=function(n){t[o]=n}))};for(var s in t)l(s)}else;return n}function re(n,e){var t=this._staticTrees||(this._staticTrees=[]),r=t[n];return r&&!e||ae(r=t[n]=this.$options.staticRenderFns[n].call(this._renderProxy,this._c,this),"__static__".concat(n),!1),r}function oe(n,e,t){return ae(n,"__once__".concat(e).concat(t?"_".concat(t):""),!0),n}function ae(n,e,t){if(o(n))for(var r=0;r<n.length;r++)n[r]&&"string"!=typeof n[r]&&ie(n[r],"".concat(e,"_").concat(r),t);else ie(n,e,t)}function ie(n,e,t){n.isStatic=!0,n.key=e,n.isOnce=t}function le(n,e){if(e)if(p(e)){var t=n.on=n.on?P({},n.on):{};for(var r in e){var o=t[r],a=e[r];t[r]=o?[].concat(o,a):a}}else;return n}function se(n,e,t,r){e=e||{$stable:!t};for(var a=0;a<n.length;a++){var i=n[a];o(i)?se(i,e,t):i&&(i.proxy&&(i.fn.proxy=!0),e[i.key]=i.fn)}return r&&(e.$key=r),e}function ce(n,e){for(var t=0;t<e.length;t+=2){var r=e[t];"string"==typeof r&&r&&(n[e[t]]=e[t+1])}return n}function de(n,e){return"string"==typeof n?e+n:n}function ue(n){n._o=oe,n._n=b,n._s=m,n._l=Kn,n._t=Zn,n._q=N,n._i=M,n._m=re,n._f=Yn,n._k=ee,n._b=te,n._v=fn,n._e=hn,n._u=se,n._g=le,n._d=ce,n._p=de}function pe(n,e){if(!n||!n.length)return{};for(var t={},r=0,o=n.length;r<o;r++){var a=n[r],i=a.data;if(i&&i.attrs&&i.attrs.slot&&delete i.attrs.slot,a.context!==e&&a.fnContext!==e||!i||null==i.slot)(t.default||(t.default=[])).push(a);else{var l=i.slot,s=t[l]||(t[l]=[]);"template"===a.tag?s.push.apply(s,a.children||[]):s.push(a)}}for(var c in t)t[c].every(ge)&&delete t[c];return t}function ge(n){return n.isComment&&!n.asyncFactory||" "===n.text}function he(n){return n.isComment&&n.asyncFactory}function fe(n,e,t,o){var a,i=Object.keys(t).length>0,l=e?!!e.$stable:!i,s=e&&e.$key;if(e){if(e._normalized)return e._normalized;if(l&&o&&o!==r&&s===o.$key&&!i&&!o.$hasNormal)return o;for(var c in a={},e)e[c]&&"$"!==c[0]&&(a[c]=me(n,t,c,e[c]))}else a={};for(var d in t)d in a||(a[d]=be(t,d));return e&&Object.isExtensible(e)&&(e._normalized=a),X(a,"$stable",l),X(a,"$key",s),X(a,"$hasNormal",i),a}function me(n,e,t,r){var a=function(){var e=un;pn(n);var t=arguments.length?r.apply(null,arguments):r({}),a=(t=t&&"object"==typeof t&&!o(t)?[t]:Gn(t))&&t[0];return pn(e),t&&(!a||1===t.length&&a.isComment&&!he(a))?void 0:t};return r.proxy&&Object.defineProperty(e,t,{get:a,enumerable:!0,configurable:!0}),a}function be(n,e){return function(){return n[e]}}function xe(n){return{get attrs(){if(!n._attrsProxy){var e=n._attrsProxy={};X(e,"_v_attr_proxy",!0),ve(e,n.$attrs,r,n,"$attrs")}return n._attrsProxy},get listeners(){n._listenersProxy||ve(n._listenersProxy={},n.$listeners,r,n,"$listeners");return n._listenersProxy},get slots(){return function(n){n._slotsProxy||ke(n._slotsProxy={},n.$scopedSlots);return n._slotsProxy}(n)},emit:I(n.$emit,n),expose:function(e){e&&Object.keys(e).forEach((function(t){return qn(n,e,t)}))}}}function ve(n,e,t,r,o){var a=!1;for(var i in e)i in n?e[i]!==t[i]&&(a=!0):(a=!0,ye(n,i,r,o));for(var i in n)i in e||(a=!0,delete n[i]);return a}function ye(n,e,t,r){Object.defineProperty(n,e,{enumerable:!0,configurable:!0,get:function(){return t[r][e]}})}function ke(n,e){for(var t in e)n[t]=e[t];for(var t in n)t in e||delete n[t]}var we=null;function Se(n,e){return(n.__esModule||dn&&"Module"===n[Symbol.toStringTag])&&(n=n.default),d(n)?e.extend(n):n}function je(n){if(o(n))for(var e=0;e<n.length;e++){var t=n[e];if(i(t)&&(i(t.componentOptions)||he(t)))return t}}function Te(n,e,t,r,u,p){return(o(t)||s(t))&&(u=r,r=t,t=void 0),l(p)&&(u=2),function(n,e,t,r,s){if(i(t)&&i(t.__ob__))return hn();i(t)&&i(t.is)&&(e=t.is);if(!e)return hn();0;o(r)&&c(r[0])&&((t=t||{}).scopedSlots={default:r[0]},r.length=0);2===s?r=Gn(r):1===s&&(r=function(n){for(var e=0;e<n.length;e++)if(o(n[e]))return Array.prototype.concat.apply([],n);return n}(r));var u,p;if("string"==typeof e){var g=void 0;p=n.$vnode&&n.$vnode.ns||F.getTagNamespace(e),u=F.isReservedTag(e)?new gn(F.parsePlatformTagName(e),t,r,void 0,void 0,n):t&&t.pre||!i(g=At(n.$options,"components",e))?new gn(e,t,r,void 0,void 0,n):yt(g,t,n,r,e)}else u=yt(e,t,n,r);return o(u)?u:i(u)?(i(p)&&function n(e,t,r){e.ns=t,"foreignObject"===e.tag&&(t=void 0,r=!0);if(i(e.children))for(var o=0,s=e.children.length;o<s;o++){var c=e.children[o];i(c.tag)&&(a(c.ns)||l(r)&&"svg"!==c.tag)&&n(c,t,r)}}(u,p),i(t)&&function(n){d(n.style)&&Fe(n.style);d(n.class)&&Fe(n.class)}(t),u):hn()}(n,e,t,r,u)}function _e(n,e,t){kn();try{if(e)for(var r=e;r=r.$parent;){var o=r.$options.errorCaptured;if(o)for(var a=0;a<o.length;a++)try{if(!1===o[a].call(r,n,e,t))return}catch(n){Ee(n,r,"errorCaptured hook")}}Ee(n,e,t)}finally{wn()}}function Ce(n,e,t,r,o){var a;try{(a=t?n.apply(e,t):n.call(e))&&!a._isVue&&f(a)&&!a._handled&&(a.catch((function(n){return _e(n,r,o+" (Promise/async)")})),a._handled=!0)}catch(n){_e(n,r,o)}return a}function Ee(n,e,t){if(F.errorHandler)try{return F.errorHandler.call(null,n,e,t)}catch(e){e!==n&&Ie(e,null,"config.errorHandler")}Ie(n,e,t)}function Ie(n,e,t){if(!Q||"undefined"==typeof console)throw n;console.error(n)}var Ae,Pe=!1,Le=[],Re=!1;function Be(){Re=!1;var n=Le.slice(0);Le.length=0;for(var e=0;e<n.length;e++)n[e]()}if("undefined"!=typeof Promise&&sn(Promise)){var Oe=Promise.resolve();Ae=function(){Oe.then(Be),Y&&setTimeout(R)},Pe=!0}else if(V||"undefined"==typeof MutationObserver||!sn(MutationObserver)&&"[object MutationObserverConstructor]"!==MutationObserver.toString())Ae="undefined"!=typeof setImmediate&&sn(setImmediate)?function(){setImmediate(Be)}:function(){setTimeout(Be,0)};else{var Ne=1,Me=new MutationObserver(Be),ze=document.createTextNode(String(Ne));Me.observe(ze,{characterData:!0}),Ae=function(){Ne=(Ne+1)%2,ze.data=String(Ne)},Pe=!0}function De(n,e){var t;if(Le.push((function(){if(n)try{n.call(e)}catch(n){_e(n,e,"nextTick")}else t&&t(e)})),Re||(Re=!0,Ae()),!n&&"undefined"!=typeof Promise)return new Promise((function(n){t=n}))}function qe(n){return function(e,t){if(void 0===t&&(t=un),t)return function(n,e,t){var r=n.$options;r[e]=_t(r[e],t)}(t,n,e)}}qe("beforeMount"),qe("mounted"),qe("beforeUpdate"),qe("updated"),qe("beforeDestroy"),qe("destroyed"),qe("activated"),qe("deactivated"),qe("serverPrefetch"),qe("renderTracked"),qe("renderTriggered"),qe("errorCaptured");var Je=new cn;function Fe(n){return function n(e,t){var r,a,i=o(e);if(!i&&!d(e)||e.__v_skip||Object.isFrozen(e)||e instanceof gn)return;if(e.__ob__){var l=e.__ob__.dep.id;if(t.has(l))return;t.add(l)}if(i)for(r=e.length;r--;)n(e[r],t);else if(Dn(e))n(e.value,t);else for(a=Object.keys(e),r=a.length;r--;)n(e[a[r]],t)}(n,Je),Je.clear(),n}var Ue,He=0,Xe=function(){function n(n,e,t,r,o){var a,i;a=this,void 0===(i=Jn&&!Jn._vm?Jn:n?n._scope:void 0)&&(i=Jn),i&&i.active&&i.effects.push(a),(this.vm=n)&&o&&(n._watcher=this),r?(this.deep=!!r.deep,this.user=!!r.user,this.lazy=!!r.lazy,this.sync=!!r.sync,this.before=r.before):this.deep=this.user=this.lazy=this.sync=!1,this.cb=t,this.id=++He,this.active=!0,this.post=!1,this.dirty=this.lazy,this.deps=[],this.newDeps=[],this.depIds=new cn,this.newDepIds=new cn,this.expression="",c(e)?this.getter=e:(this.getter=function(n){if(!$.test(n)){var e=n.split(".");return function(n){for(var t=0;t<e.length;t++){if(!n)return;n=n[e[t]]}return n}}}(e),this.getter||(this.getter=R)),this.value=this.lazy?void 0:this.get()}return n.prototype.get=function(){var n;kn(this);var e=this.vm;try{n=this.getter.call(e,e)}catch(n){if(!this.user)throw n;_e(n,e,'getter for watcher "'.concat(this.expression,'"'))}finally{this.deep&&Fe(n),wn(),this.cleanupDeps()}return n},n.prototype.addDep=function(n){var e=n.id;this.newDepIds.has(e)||(this.newDepIds.add(e),this.newDeps.push(n),this.depIds.has(e)||n.addSub(this))},n.prototype.cleanupDeps=function(){for(var n=this.deps.length;n--;){var e=this.deps[n];this.newDepIds.has(e.id)||e.removeSub(this)}var t=this.depIds;this.depIds=this.newDepIds,this.newDepIds=t,this.newDepIds.clear(),t=this.deps,this.deps=this.newDeps,this.newDeps=t,this.newDeps.length=0},n.prototype.update=function(){this.lazy?this.dirty=!0:this.sync?this.run():pt(this)},n.prototype.run=function(){if(this.active){var n=this.get();if(n!==this.value||d(n)||this.deep){var e=this.value;if(this.value=n,this.user){var t='callback for watcher "'.concat(this.expression,'"');Ce(this.cb,this.vm,[n,e],this.vm,t)}else this.cb.call(this.vm,n,e)}}},n.prototype.evaluate=function(){this.value=this.get(),this.dirty=!1},n.prototype.depend=function(){for(var n=this.deps.length;n--;)this.deps[n].depend()},n.prototype.teardown=function(){if(this.vm&&!this.vm._isBeingDestroyed&&y(this.vm._scope.effects,this),this.active){for(var n=this.deps.length;n--;)this.deps[n].removeSub(this);this.active=!1,this.onStop&&this.onStop()}},n}();function $e(n,e){Ue.$on(n,e)}function We(n,e){Ue.$off(n,e)}function Qe(n,e){var t=Ue;return function r(){var o=e.apply(null,arguments);null!==o&&t.$off(n,r)}}function Ge(n,e,t){Ue=n,$n(e,t||{},$e,We,Qe,n),Ue=void 0}var Ve=null;function Ke(n){var e=Ve;return Ve=n,function(){Ve=e}}function Ze(n){for(;n&&(n=n.$parent);)if(n._inactive)return!0;return!1}function Ye(n,e){if(e){if(n._directInactive=!1,Ze(n))return}else if(n._directInactive)return;if(n._inactive||null===n._inactive){n._inactive=!1;for(var t=0;t<n.$children.length;t++)Ye(n.$children[t]);nt(n,"activated")}}function nt(n,e,t,r){void 0===r&&(r=!0),kn();var o=un;r&&pn(n);var a=n.$options[e],i="".concat(e," hook");if(a)for(var l=0,s=a.length;l<s;l++)Ce(a[l],n,t||null,n,i);n._hasHookEvent&&n.$emit("hook:"+e),r&&pn(o),wn()}var et=[],tt=[],rt={},ot=!1,at=!1,it=0;var lt=0,st=Date.now;if(Q&&!V){var ct=window.performance;ct&&"function"==typeof ct.now&&st()>document.createEvent("Event").timeStamp&&(st=function(){return ct.now()})}var dt=function(n,e){if(n.post){if(!e.post)return 1}else if(e.post)return-1;return n.id-e.id};function ut(){var n,e;for(lt=st(),at=!0,et.sort(dt),it=0;it<et.length;it++)(n=et[it]).before&&n.before(),e=n.id,rt[e]=null,n.run();var t=tt.slice(),r=et.slice();it=et.length=tt.length=0,rt={},ot=at=!1,function(n){for(var e=0;e<n.length;e++)n[e]._inactive=!0,Ye(n[e],!0)}(t),function(n){var e=n.length;for(;e--;){var t=n[e],r=t.vm;r&&r._watcher===t&&r._isMounted&&!r._isDestroyed&&nt(r,"updated")}}(r),function(){for(var n=0;n<xn.length;n++){var e=xn[n];e.subs=e.subs.filter((function(n){return n})),e._pending=!1}xn.length=0}(),ln&&F.devtools&&ln.emit("flush")}function pt(n){var e=n.id;if(null==rt[e]&&(n!==vn.target||!n.noRecurse)){if(rt[e]=!0,at){for(var t=et.length-1;t>it&&et[t].id>n.id;)t--;et.splice(t+1,0,n)}else et.push(n);ot||(ot=!0,De(ut))}}function gt(n,e){if(n){for(var t=Object.create(null),r=dn?Reflect.ownKeys(n):Object.keys(n),o=0;o<r.length;o++){var a=r[o];if("__ob__"!==a){var i=n[a].from;if(i in e._provided)t[a]=e._provided[i];else if("default"in n[a]){var l=n[a].default;t[a]=c(l)?l.call(e):l}else 0}}return t}}function ht(n,e,t,a,i){var s,c=this,d=i.options;w(a,"_uid")?(s=Object.create(a))._original=a:(s=a,a=a._original);var u=l(d._compiled),p=!u;this.data=n,this.props=e,this.children=t,this.parent=a,this.listeners=n.on||r,this.injections=gt(d.inject,a),this.slots=function(){return c.$slots||fe(a,n.scopedSlots,c.$slots=pe(t,a)),c.$slots},Object.defineProperty(this,"scopedSlots",{enumerable:!0,get:function(){return fe(a,n.scopedSlots,this.slots())}}),u&&(this.$options=d,this.$slots=this.slots(),this.$scopedSlots=fe(a,n.scopedSlots,this.$slots)),d._scopeId?this._c=function(n,e,t,r){var i=Te(s,n,e,t,r,p);return i&&!o(i)&&(i.fnScopeId=d._scopeId,i.fnContext=a),i}:this._c=function(n,e,t,r){return Te(s,n,e,t,r,p)}}function ft(n,e,t,r,o){var a=mn(n);return a.fnContext=t,a.fnOptions=r,e.slot&&((a.data||(a.data={})).slot=e.slot),a}function mt(n,e){for(var t in e)n[T(t)]=e[t]}function bt(n){return n.name||n.__name||n._componentTag}ue(ht.prototype);var xt={init:function(n,e){if(n.componentInstance&&!n.componentInstance._isDestroyed&&n.data.keepAlive){var t=n;xt.prepatch(t,t)}else{(n.componentInstance=function(n,e){var t={_isComponent:!0,_parentVnode:n,parent:e},r=n.data.inlineTemplate;i(r)&&(t.render=r.render,t.staticRenderFns=r.staticRenderFns);return new n.componentOptions.Ctor(t)}(n,Ve)).$mount(e?n.elm:void 0,e)}},prepatch:function(n,e){var t=e.componentOptions;!function(n,e,t,o,a){var i=o.data.scopedSlots,l=n.$scopedSlots,s=!!(i&&!i.$stable||l!==r&&!l.$stable||i&&n.$scopedSlots.$key!==i.$key||!i&&n.$scopedSlots.$key),c=!!(a||n.$options._renderChildren||s),d=n.$vnode;n.$options._parentVnode=o,n.$vnode=o,n._vnode&&(n._vnode.parent=o),n.$options._renderChildren=a;var u=o.data.attrs||r;n._attrsProxy&&ve(n._attrsProxy,u,d.data&&d.data.attrs||r,n,"$attrs")&&(c=!0),n.$attrs=u,t=t||r;var p=n.$options._parentListeners;if(n._listenersProxy&&ve(n._listenersProxy,t,p||r,n,"$listeners"),n.$listeners=n.$options._parentListeners=t,Ge(n,t,p),e&&n.$options.props){En(!1);for(var g=n._props,h=n.$options._propKeys||[],f=0;f<h.length;f++){var m=h[f],b=n.$options.props;g[m]=Pt(m,b,e,n)}En(!0),n.$options.propsData=e}c&&(n.$slots=pe(a,o.context),n.$forceUpdate())}(e.componentInstance=n.componentInstance,t.propsData,t.listeners,e,t.children)},insert:function(n){var e,t=n.context,r=n.componentInstance;r._isMounted||(r._isMounted=!0,nt(r,"mounted")),n.data.keepAlive&&(t._isMounted?((e=r)._inactive=!1,tt.push(e)):Ye(r,!0))},destroy:function(n){var e=n.componentInstance;e._isDestroyed||(n.data.keepAlive?function n(e,t){if(!(t&&(e._directInactive=!0,Ze(e))||e._inactive)){e._inactive=!0;for(var r=0;r<e.$children.length;r++)n(e.$children[r]);nt(e,"deactivated")}}(e,!0):e.$destroy())}},vt=Object.keys(xt);function yt(n,e,t,s,c){if(!a(n)){var u=t.$options._base;if(d(n)&&(n=u.extend(n)),"function"==typeof n){var p;if(a(n.cid)&&void 0===(n=function(n,e){if(l(n.error)&&i(n.errorComp))return n.errorComp;if(i(n.resolved))return n.resolved;var t=we;if(t&&i(n.owners)&&-1===n.owners.indexOf(t)&&n.owners.push(t),l(n.loading)&&i(n.loadingComp))return n.loadingComp;if(t&&!i(n.owners)){var r=n.owners=[t],o=!0,s=null,c=null;t.$on("hook:destroyed",(function(){return y(r,t)}));var u=function(n){for(var e=0,t=r.length;e<t;e++)r[e].$forceUpdate();n&&(r.length=0,null!==s&&(clearTimeout(s),s=null),null!==c&&(clearTimeout(c),c=null))},p=z((function(t){n.resolved=Se(t,e),o?r.length=0:u(!0)})),g=z((function(e){i(n.errorComp)&&(n.error=!0,u(!0))})),h=n(p,g);return d(h)&&(f(h)?a(n.resolved)&&h.then(p,g):f(h.component)&&(h.component.then(p,g),i(h.error)&&(n.errorComp=Se(h.error,e)),i(h.loading)&&(n.loadingComp=Se(h.loading,e),0===h.delay?n.loading=!0:s=setTimeout((function(){s=null,a(n.resolved)&&a(n.error)&&(n.loading=!0,u(!1))}),h.delay||200)),i(h.timeout)&&(c=setTimeout((function(){c=null,a(n.resolved)&&g(null)}),h.timeout)))),o=!1,n.loading?n.loadingComp:n.resolved}}(p=n,u)))return function(n,e,t,r,o){var a=hn();return a.asyncFactory=n,a.asyncMeta={data:e,context:t,children:r,tag:o},a}(p,e,t,s,c);e=e||{},Xt(n),i(e.model)&&function(n,e){var t=n.model&&n.model.prop||"value",r=n.model&&n.model.event||"input";(e.attrs||(e.attrs={}))[t]=e.model.value;var a=e.on||(e.on={}),l=a[r],s=e.model.callback;i(l)?(o(l)?-1===l.indexOf(s):l!==s)&&(a[r]=[s].concat(l)):a[r]=s}(n.options,e);var g=function(n,e,t){var r=e.options.props;if(!a(r)){var o={},l=n.attrs,s=n.props;if(i(l)||i(s))for(var c in r){var d=E(c);Qn(o,s,c,d,!0)||Qn(o,l,c,d,!1)}return o}}(e,n);if(l(n.options.functional))return function(n,e,t,a,l){var s=n.options,c={},d=s.props;if(i(d))for(var u in d)c[u]=Pt(u,d,e||r);else i(t.attrs)&&mt(c,t.attrs),i(t.props)&&mt(c,t.props);var p=new ht(t,c,l,a,n),g=s.render.call(null,p._c,p);if(g instanceof gn)return ft(g,t,p.parent,s,p);if(o(g)){for(var h=Gn(g)||[],f=new Array(h.length),m=0;m<h.length;m++)f[m]=ft(h[m],t,p.parent,s,p);return f}}(n,g,e,t,s);var h=e.on;if(e.on=e.nativeOn,l(n.options.abstract)){var m=e.slot;e={},m&&(e.slot=m)}!function(n){for(var e=n.hook||(n.hook={}),t=0;t<vt.length;t++){var r=vt[t],o=e[r],a=xt[r];o===a||o&&o._merged||(e[r]=o?kt(a,o):a)}}(e);var b=bt(n.options)||c;return new gn("vue-component-".concat(n.cid).concat(b?"-".concat(b):""),e,void 0,void 0,void 0,t,{Ctor:n,propsData:g,listeners:h,tag:c,children:s},p)}}}function kt(n,e){var t=function(t,r){n(t,r),e(t,r)};return t._merged=!0,t}var wt=R,St=F.optionMergeStrategies;function jt(n,e,t){if(void 0===t&&(t=!0),!e)return n;for(var r,o,a,i=dn?Reflect.ownKeys(e):Object.keys(e),l=0;l<i.length;l++)"__ob__"!==(r=i[l])&&(o=n[r],a=e[r],t&&w(n,r)?o!==a&&p(o)&&p(a)&&jt(o,a):Rn(n,r,a));return n}function Tt(n,e,t){return t?function(){var r=c(e)?e.call(t,t):e,o=c(n)?n.call(t,t):n;return r?jt(r,o):o}:e?n?function(){return jt(c(e)?e.call(this,this):e,c(n)?n.call(this,this):n)}:e:n}function _t(n,e){var t=e?n?n.concat(e):o(e)?e:[e]:n;return t?function(n){for(var e=[],t=0;t<n.length;t++)-1===e.indexOf(n[t])&&e.push(n[t]);return e}(t):t}function Ct(n,e,t,r){var o=Object.create(n||null);return e?P(o,e):o}St.data=function(n,e,t){return t?Tt(n,e,t):e&&"function"!=typeof e?n:Tt(n,e)},J.forEach((function(n){St[n]=_t})),q.forEach((function(n){St[n+"s"]=Ct})),St.watch=function(n,e,t,r){if(n===tn&&(n=void 0),e===tn&&(e=void 0),!e)return Object.create(n||null);if(!n)return e;var a={};for(var i in P(a,n),e){var l=a[i],s=e[i];l&&!o(l)&&(l=[l]),a[i]=l?l.concat(s):o(s)?s:[s]}return a},St.props=St.methods=St.inject=St.computed=function(n,e,t,r){if(!n)return e;var o=Object.create(null);return P(o,n),e&&P(o,e),o},St.provide=function(n,e){return n?function(){var t=Object.create(null);return jt(t,c(n)?n.call(this):n),e&&jt(t,c(e)?e.call(this):e,!1),t}:e};var Et=function(n,e){return void 0===e?n:e};function It(n,e,t){if(c(e)&&(e=e.options),function(n,e){var t=n.props;if(t){var r,a,i={};if(o(t))for(r=t.length;r--;)"string"==typeof(a=t[r])&&(i[T(a)]={type:null});else if(p(t))for(var l in t)a=t[l],i[T(l)]=p(a)?a:{type:a};else 0;n.props=i}}(e),function(n,e){var t=n.inject;if(t){var r=n.inject={};if(o(t))for(var a=0;a<t.length;a++)r[t[a]]={from:t[a]};else if(p(t))for(var i in t){var l=t[i];r[i]=p(l)?P({from:i},l):{from:l}}else 0}}(e),function(n){var e=n.directives;if(e)for(var t in e){var r=e[t];c(r)&&(e[t]={bind:r,update:r})}}(e),!e._base&&(e.extends&&(n=It(n,e.extends,t)),e.mixins))for(var r=0,a=e.mixins.length;r<a;r++)n=It(n,e.mixins[r],t);var i,l={};for(i in n)s(i);for(i in e)w(n,i)||s(i);function s(r){var o=St[r]||Et;l[r]=o(n[r],e[r],t,r)}return l}function At(n,e,t,r){if("string"==typeof t){var o=n[e];if(w(o,t))return o[t];var a=T(t);if(w(o,a))return o[a];var i=_(a);return w(o,i)?o[i]:o[t]||o[a]||o[i]}}function Pt(n,e,t,r){var o=e[n],a=!w(t,n),i=t[n],l=Ot(Boolean,o.type);if(l>-1)if(a&&!w(o,"default"))i=!1;else if(""===i||i===E(n)){var s=Ot(String,o.type);(s<0||l<s)&&(i=!0)}if(void 0===i){i=function(n,e,t){if(!w(e,"default"))return;var r=e.default;0;if(n&&n.$options.propsData&&void 0===n.$options.propsData[t]&&void 0!==n._props[t])return n._props[t];return c(r)&&"Function"!==Rt(e.type)?r.call(n):r}(r,o,n);var d=Cn;En(!0),Pn(i),En(d)}return i}var Lt=/^\s*function (\w+)/;function Rt(n){var e=n&&n.toString().match(Lt);return e?e[1]:""}function Bt(n,e){return Rt(n)===Rt(e)}function Ot(n,e){if(!o(e))return Bt(e,n)?0:-1;for(var t=0,r=e.length;t<r;t++)if(Bt(e[t],n))return t;return-1}var Nt={enumerable:!0,configurable:!0,get:R,set:R};function Mt(n,e,t){Nt.get=function(){return this[e][t]},Nt.set=function(n){this[e][t]=n},Object.defineProperty(n,t,Nt)}function zt(n){var e=n.$options;if(e.props&&function(n,e){var t=n.$options.propsData||{},r=n._props=Nn({}),o=n.$options._propKeys=[];n.$parent&&En(!1);var a=function(a){o.push(a);var i=Pt(a,e,t,n);Ln(r,a,i),a in n||Mt(n,"_props",a)};for(var i in e)a(i);En(!0)}(n,e.props),function(n){var e=n.$options,t=e.setup;if(t){var r=n._setupContext=xe(n);pn(n),kn();var o=Ce(t,null,[n._props||Nn({}),r],n,"setup");if(wn(),pn(),c(o))e.render=o;else if(d(o))if(n._setupState=o,o.__sfc){var a=n._setupProxy={};for(var i in o)"__sfc"!==i&&qn(a,o,i)}else for(var i in o)H(i)||qn(n,o,i);else 0}}(n),e.methods&&function(n,e){n.$options.props;for(var t in e)n[t]="function"!=typeof e[t]?R:I(e[t],n)}(n,e.methods),e.data)!function(n){var e=n.$options.data;p(e=n._data=c(e)?function(n,e){kn();try{return n.call(e,e)}catch(n){return _e(n,e,"data()"),{}}finally{wn()}}(e,n):e||{})||(e={});var t=Object.keys(e),r=n.$options.props,o=(n.$options.methods,t.length);for(;o--;){var a=t[o];0,r&&w(r,a)||H(a)||Mt(n,"_data",a)}var i=Pn(e);i&&i.vmCount++}(n);else{var t=Pn(n._data={});t&&t.vmCount++}e.computed&&function(n,e){var t=n._computedWatchers=Object.create(null),r=an();for(var o in e){var a=e[o],i=c(a)?a:a.get;0,r||(t[o]=new Xe(n,i||R,R,Dt)),o in n||qt(n,o,a)}}(n,e.computed),e.watch&&e.watch!==tn&&function(n,e){for(var t in e){var r=e[t];if(o(r))for(var a=0;a<r.length;a++)Ut(n,t,r[a]);else Ut(n,t,r)}}(n,e.watch)}var Dt={lazy:!0};function qt(n,e,t){var r=!an();c(t)?(Nt.get=r?Jt(e):Ft(t),Nt.set=R):(Nt.get=t.get?r&&!1!==t.cache?Jt(e):Ft(t.get):R,Nt.set=t.set||R),Object.defineProperty(n,e,Nt)}function Jt(n){return function(){var e=this._computedWatchers&&this._computedWatchers[n];if(e)return e.dirty&&e.evaluate(),vn.target&&e.depend(),e.value}}function Ft(n){return function(){return n.call(this,this)}}function Ut(n,e,t,r){return p(t)&&(r=t,t=t.handler),"string"==typeof t&&(t=n[t]),n.$watch(e,t,r)}var Ht=0;function Xt(n){var e=n.options;if(n.super){var t=Xt(n.super);if(t!==n.superOptions){n.superOptions=t;var r=function(n){var e,t=n.options,r=n.sealedOptions;for(var o in t)t[o]!==r[o]&&(e||(e={}),e[o]=t[o]);return e}(n);r&&P(n.extendOptions,r),(e=n.options=It(t,n.extendOptions)).name&&(e.components[e.name]=n)}}return e}function $t(n){this._init(n)}function Wt(n){n.cid=0;var e=1;n.extend=function(n){n=n||{};var t=this,r=t.cid,o=n._Ctor||(n._Ctor={});if(o[r])return o[r];var a=bt(n)||bt(t.options);var i=function(n){this._init(n)};return(i.prototype=Object.create(t.prototype)).constructor=i,i.cid=e++,i.options=It(t.options,n),i.super=t,i.options.props&&function(n){var e=n.options.props;for(var t in e)Mt(n.prototype,"_props",t)}(i),i.options.computed&&function(n){var e=n.options.computed;for(var t in e)qt(n.prototype,t,e[t])}(i),i.extend=t.extend,i.mixin=t.mixin,i.use=t.use,q.forEach((function(n){i[n]=t[n]})),a&&(i.options.components[a]=i),i.superOptions=t.options,i.extendOptions=n,i.sealedOptions=P({},i.options),o[r]=i,i}}function Qt(n){return n&&(bt(n.Ctor.options)||n.tag)}function Gt(n,e){return o(n)?n.indexOf(e)>-1:"string"==typeof n?n.split(",").indexOf(e)>-1:!!g(n)&&n.test(e)}function Vt(n,e){var t=n.cache,r=n.keys,o=n._vnode;for(var a in t){var i=t[a];if(i){var l=i.name;l&&!e(l)&&Kt(t,a,r,o)}}}function Kt(n,e,t,r){var o=n[e];!o||r&&o.tag===r.tag||o.componentInstance.$destroy(),n[e]=null,y(t,e)}!function(n){n.prototype._init=function(n){var e=this;e._uid=Ht++,e._isVue=!0,e.__v_skip=!0,e._scope=new Fn(!0),e._scope._vm=!0,n&&n._isComponent?function(n,e){var t=n.$options=Object.create(n.constructor.options),r=e._parentVnode;t.parent=e.parent,t._parentVnode=r;var o=r.componentOptions;t.propsData=o.propsData,t._parentListeners=o.listeners,t._renderChildren=o.children,t._componentTag=o.tag,e.render&&(t.render=e.render,t.staticRenderFns=e.staticRenderFns)}(e,n):e.$options=It(Xt(e.constructor),n||{},e),e._renderProxy=e,e._self=e,function(n){var e=n.$options,t=e.parent;if(t&&!e.abstract){for(;t.$options.abstract&&t.$parent;)t=t.$parent;t.$children.push(n)}n.$parent=t,n.$root=t?t.$root:n,n.$children=[],n.$refs={},n._provided=t?t._provided:Object.create(null),n._watcher=null,n._inactive=null,n._directInactive=!1,n._isMounted=!1,n._isDestroyed=!1,n._isBeingDestroyed=!1}(e),function(n){n._events=Object.create(null),n._hasHookEvent=!1;var e=n.$options._parentListeners;e&&Ge(n,e)}(e),function(n){n._vnode=null,n._staticTrees=null;var e=n.$options,t=n.$vnode=e._parentVnode,o=t&&t.context;n.$slots=pe(e._renderChildren,o),n.$scopedSlots=t?fe(n.$parent,t.data.scopedSlots,n.$slots):r,n._c=function(e,t,r,o){return Te(n,e,t,r,o,!1)},n.$createElement=function(e,t,r,o){return Te(n,e,t,r,o,!0)};var a=t&&t.data;Ln(n,"$attrs",a&&a.attrs||r,null,!0),Ln(n,"$listeners",e._parentListeners||r,null,!0)}(e),nt(e,"beforeCreate",void 0,!1),function(n){var e=gt(n.$options.inject,n);e&&(En(!1),Object.keys(e).forEach((function(t){Ln(n,t,e[t])})),En(!0))}(e),zt(e),function(n){var e=n.$options.provide;if(e){var t=c(e)?e.call(n):e;if(!d(t))return;for(var r=Un(n),o=dn?Reflect.ownKeys(t):Object.keys(t),a=0;a<o.length;a++){var i=o[a];Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))}}}(e),nt(e,"created"),e.$options.el&&e.$mount(e.$options.el)}}($t),function(n){var e={get:function(){return this._data}},t={get:function(){return this._props}};Object.defineProperty(n.prototype,"$data",e),Object.defineProperty(n.prototype,"$props",t),n.prototype.$set=Rn,n.prototype.$delete=Bn,n.prototype.$watch=function(n,e,t){if(p(e))return Ut(this,n,e,t);(t=t||{}).user=!0;var r=new Xe(this,n,e,t);if(t.immediate){var o='callback for immediate watcher "'.concat(r.expression,'"');kn(),Ce(e,this,[r.value],this,o),wn()}return function(){r.teardown()}}}($t),function(n){var e=/^hook:/;n.prototype.$on=function(n,t){var r=this;if(o(n))for(var a=0,i=n.length;a<i;a++)r.$on(n[a],t);else(r._events[n]||(r._events[n]=[])).push(t),e.test(n)&&(r._hasHookEvent=!0);return r},n.prototype.$once=function(n,e){var t=this;function r(){t.$off(n,r),e.apply(t,arguments)}return r.fn=e,t.$on(n,r),t},n.prototype.$off=function(n,e){var t=this;if(!arguments.length)return t._events=Object.create(null),t;if(o(n)){for(var r=0,a=n.length;r<a;r++)t.$off(n[r],e);return t}var i,l=t._events[n];if(!l)return t;if(!e)return t._events[n]=null,t;for(var s=l.length;s--;)if((i=l[s])===e||i.fn===e){l.splice(s,1);break}return t},n.prototype.$emit=function(n){var e=this,t=e._events[n];if(t){t=t.length>1?A(t):t;for(var r=A(arguments,1),o='event handler for "'.concat(n,'"'),a=0,i=t.length;a<i;a++)Ce(t[a],e,r,e,o)}return e}}($t),function(n){n.prototype._update=function(n,e){var t=this,r=t.$el,o=t._vnode,a=Ke(t);t._vnode=n,t.$el=o?t.__patch__(o,n):t.__patch__(t.$el,n,e,!1),a(),r&&(r.__vue__=null),t.$el&&(t.$el.__vue__=t);for(var i=t;i&&i.$vnode&&i.$parent&&i.$vnode===i.$parent._vnode;)i.$parent.$el=i.$el,i=i.$parent},n.prototype.$forceUpdate=function(){this._watcher&&this._watcher.update()},n.prototype.$destroy=function(){var n=this;if(!n._isBeingDestroyed){nt(n,"beforeDestroy"),n._isBeingDestroyed=!0;var e=n.$parent;!e||e._isBeingDestroyed||n.$options.abstract||y(e.$children,n),n._scope.stop(),n._data.__ob__&&n._data.__ob__.vmCount--,n._isDestroyed=!0,n.__patch__(n._vnode,null),nt(n,"destroyed"),n.$off(),n.$el&&(n.$el.__vue__=null),n.$vnode&&(n.$vnode.parent=null)}}}($t),function(n){ue(n.prototype),n.prototype.$nextTick=function(n){return De(n,this)},n.prototype._render=function(){var n,e=this,t=e.$options,r=t.render,a=t._parentVnode;a&&e._isMounted&&(e.$scopedSlots=fe(e.$parent,a.data.scopedSlots,e.$slots,e.$scopedSlots),e._slotsProxy&&ke(e._slotsProxy,e.$scopedSlots)),e.$vnode=a;try{pn(e),we=e,n=r.call(e._renderProxy,e.$createElement)}catch(t){_e(t,e,"render"),n=e._vnode}finally{we=null,pn()}return o(n)&&1===n.length&&(n=n[0]),n instanceof gn||(n=hn()),n.parent=a,n}}($t);var Zt=[String,RegExp,Array],Yt={KeepAlive:{name:"keep-alive",abstract:!0,props:{include:Zt,exclude:Zt,max:[String,Number]},methods:{cacheVNode:function(){var n=this.cache,e=this.keys,t=this.vnodeToCache,r=this.keyToCache;if(t){var o=t.tag,a=t.componentInstance,i=t.componentOptions;n[r]={name:Qt(i),tag:o,componentInstance:a},e.push(r),this.max&&e.length>parseInt(this.max)&&Kt(n,e[0],e,this._vnode),this.vnodeToCache=null}}},created:function(){this.cache=Object.create(null),this.keys=[]},destroyed:function(){for(var n in this.cache)Kt(this.cache,n,this.keys)},mounted:function(){var n=this;this.cacheVNode(),this.$watch("include",(function(e){Vt(n,(function(n){return Gt(e,n)}))})),this.$watch("exclude",(function(e){Vt(n,(function(n){return!Gt(e,n)}))}))},updated:function(){this.cacheVNode()},render:function(){var n=this.$slots.default,e=je(n),t=e&&e.componentOptions;if(t){var r=Qt(t),o=this.include,a=this.exclude;if(o&&(!r||!Gt(o,r))||a&&r&&Gt(a,r))return e;var i=this.cache,l=this.keys,s=null==e.key?t.Ctor.cid+(t.tag?"::".concat(t.tag):""):e.key;i[s]?(e.componentInstance=i[s].componentInstance,y(l,s),l.push(s)):(this.vnodeToCache=e,this.keyToCache=s),e.data.keepAlive=!0}return e||n&&n[0]}}};!function(n){var e={get:function(){return F}};Object.defineProperty(n,"config",e),n.util={warn:wt,extend:P,mergeOptions:It,defineReactive:Ln},n.set=Rn,n.delete=Bn,n.nextTick=De,n.observable=function(n){return Pn(n),n},n.options=Object.create(null),q.forEach((function(e){n.options[e+"s"]=Object.create(null)})),n.options._base=n,P(n.options.components,Yt),function(n){n.use=function(n){var e=this._installedPlugins||(this._installedPlugins=[]);if(e.indexOf(n)>-1)return this;var t=A(arguments,1);return t.unshift(this),c(n.install)?n.install.apply(n,t):c(n)&&n.apply(null,t),e.push(n),this}}(n),function(n){n.mixin=function(n){return this.options=It(this.options,n),this}}(n),Wt(n),function(n){q.forEach((function(e){n[e]=function(n,t){return t?("component"===e&&p(t)&&(t.name=t.name||n,t=this.options._base.extend(t)),"directive"===e&&c(t)&&(t={bind:t,update:t}),this.options[e+"s"][n]=t,t):this.options[e+"s"][n]}}))}(n)}($t),Object.defineProperty($t.prototype,"$isServer",{get:an}),Object.defineProperty($t.prototype,"$ssrContext",{get:function(){return this.$vnode&&this.$vnode.ssrContext}}),Object.defineProperty($t,"FunctionalRenderContext",{value:ht}),$t.version="2.7.14";var nr=x("style,class"),er=x("input,textarea,option,select,progress"),tr=x("contenteditable,draggable,spellcheck"),rr=x("events,caret,typing,plaintext-only"),or=x("allowfullscreen,async,autofocus,autoplay,checked,compact,controls,declare,default,defaultchecked,defaultmuted,defaultselected,defer,disabled,enabled,formnovalidate,hidden,indeterminate,inert,ismap,itemscope,loop,multiple,muted,nohref,noresize,noshade,novalidate,nowrap,open,pauseonexit,readonly,required,reversed,scoped,seamless,selected,sortable,truespeed,typemustmatch,visible"),ar="http://www.w3.org/1999/xlink",ir=function(n){return":"===n.charAt(5)&&"xlink"===n.slice(0,5)},lr=function(n){return ir(n)?n.slice(6,n.length):""},sr=function(n){return null==n||!1===n};function cr(n){for(var e=n.data,t=n,r=n;i(r.componentInstance);)(r=r.componentInstance._vnode)&&r.data&&(e=dr(r.data,e));for(;i(t=t.parent);)t&&t.data&&(e=dr(e,t.data));return function(n,e){if(i(n)||i(e))return ur(n,pr(e));return""}(e.staticClass,e.class)}function dr(n,e){return{staticClass:ur(n.staticClass,e.staticClass),class:i(n.class)?[n.class,e.class]:e.class}}function ur(n,e){return n?e?n+" "+e:n:e||""}function pr(n){return Array.isArray(n)?function(n){for(var e,t="",r=0,o=n.length;r<o;r++)i(e=pr(n[r]))&&""!==e&&(t&&(t+=" "),t+=e);return t}(n):d(n)?function(n){var e="";for(var t in n)n[t]&&(e&&(e+=" "),e+=t);return e}(n):"string"==typeof n?n:""}var gr={svg:"http://www.w3.org/2000/svg",math:"http://www.w3.org/1998/Math/MathML"},hr=x("html,body,base,head,link,meta,style,title,address,article,aside,footer,header,h1,h2,h3,h4,h5,h6,hgroup,nav,section,div,dd,dl,dt,figcaption,figure,picture,hr,img,li,main,ol,p,pre,ul,a,b,abbr,bdi,bdo,br,cite,code,data,dfn,em,i,kbd,mark,q,rp,rt,rtc,ruby,s,samp,small,span,strong,sub,sup,time,u,var,wbr,area,audio,map,track,video,embed,object,param,source,canvas,script,noscript,del,ins,caption,col,colgroup,table,thead,tbody,td,th,tr,button,datalist,fieldset,form,input,label,legend,meter,optgroup,option,output,progress,select,textarea,details,dialog,menu,menuitem,summary,content,element,shadow,template,blockquote,iframe,tfoot"),fr=x("svg,animate,circle,clippath,cursor,defs,desc,ellipse,filter,font-face,foreignobject,g,glyph,image,line,marker,mask,missing-glyph,path,pattern,polygon,polyline,rect,switch,symbol,text,textpath,tspan,use,view",!0),mr=function(n){return hr(n)||fr(n)};var br=Object.create(null);var xr=x("text,number,password,search,email,tel,url");var vr=Object.freeze({__proto__:null,createElement:function(n,e){var t=document.createElement(n);return"select"!==n||e.data&&e.data.attrs&&void 0!==e.data.attrs.multiple&&t.setAttribute("multiple","multiple"),t},createElementNS:function(n,e){return document.createElementNS(gr[n],e)},createTextNode:function(n){return document.createTextNode(n)},createComment:function(n){return document.createComment(n)},insertBefore:function(n,e,t){n.insertBefore(e,t)},removeChild:function(n,e){n.removeChild(e)},appendChild:function(n,e){n.appendChild(e)},parentNode:function(n){return n.parentNode},nextSibling:function(n){return n.nextSibling},tagName:function(n){return n.tagName},setTextContent:function(n,e){n.textContent=e},setStyleScope:function(n,e){n.setAttribute(e,"")}}),yr={create:function(n,e){kr(e)},update:function(n,e){n.data.ref!==e.data.ref&&(kr(n,!0),kr(e))},destroy:function(n){kr(n,!0)}};function kr(n,e){var t=n.data.ref;if(i(t)){var r=n.context,a=n.componentInstance||n.elm,l=e?null:a,s=e?void 0:a;if(c(t))Ce(t,r,[l],r,"template ref function");else{var d=n.data.refInFor,u="string"==typeof t||"number"==typeof t,p=Dn(t),g=r.$refs;if(u||p)if(d){var h=u?g[t]:t.value;e?o(h)&&y(h,a):o(h)?h.includes(a)||h.push(a):u?(g[t]=[a],wr(r,t,g[t])):t.value=[a]}else if(u){if(e&&g[t]!==a)return;g[t]=s,wr(r,t,l)}else if(p){if(e&&t.value!==a)return;t.value=l}else 0}}}function wr(n,e,t){var r=n._setupState;r&&w(r,e)&&(Dn(r[e])?r[e].value=t:r[e]=t)}var Sr=new gn("",{},[]),jr=["create","activate","update","remove","destroy"];function Tr(n,e){return n.key===e.key&&n.asyncFactory===e.asyncFactory&&(n.tag===e.tag&&n.isComment===e.isComment&&i(n.data)===i(e.data)&&function(n,e){if("input"!==n.tag)return!0;var t,r=i(t=n.data)&&i(t=t.attrs)&&t.type,o=i(t=e.data)&&i(t=t.attrs)&&t.type;return r===o||xr(r)&&xr(o)}(n,e)||l(n.isAsyncPlaceholder)&&a(e.asyncFactory.error))}function _r(n,e,t){var r,o,a={};for(r=e;r<=t;++r)i(o=n[r].key)&&(a[o]=r);return a}var Cr={create:Er,update:Er,destroy:function(n){Er(n,Sr)}};function Er(n,e){(n.data.directives||e.data.directives)&&function(n,e){var t,r,o,a=n===Sr,i=e===Sr,l=Ar(n.data.directives,n.context),s=Ar(e.data.directives,e.context),c=[],d=[];for(t in s)r=l[t],o=s[t],r?(o.oldValue=r.value,o.oldArg=r.arg,Lr(o,"update",e,n),o.def&&o.def.componentUpdated&&d.push(o)):(Lr(o,"bind",e,n),o.def&&o.def.inserted&&c.push(o));if(c.length){var u=function(){for(var t=0;t<c.length;t++)Lr(c[t],"inserted",e,n)};a?Wn(e,"insert",u):u()}d.length&&Wn(e,"postpatch",(function(){for(var t=0;t<d.length;t++)Lr(d[t],"componentUpdated",e,n)}));if(!a)for(t in l)s[t]||Lr(l[t],"unbind",n,n,i)}(n,e)}var Ir=Object.create(null);function Ar(n,e){var t,r,o=Object.create(null);if(!n)return o;for(t=0;t<n.length;t++){if((r=n[t]).modifiers||(r.modifiers=Ir),o[Pr(r)]=r,e._setupState&&e._setupState.__sfc){var a=r.def||At(e,"_setupState","v-"+r.name);r.def="function"==typeof a?{bind:a,update:a}:a}r.def=r.def||At(e.$options,"directives",r.name)}return o}function Pr(n){return n.rawName||"".concat(n.name,".").concat(Object.keys(n.modifiers||{}).join("."))}function Lr(n,e,t,r,o){var a=n.def&&n.def[e];if(a)try{a(t.elm,n,t,r,o)}catch(r){_e(r,t.context,"directive ".concat(n.name," ").concat(e," hook"))}}var Rr=[yr,Cr];function Br(n,e){var t=e.componentOptions;if(!(i(t)&&!1===t.Ctor.options.inheritAttrs||a(n.data.attrs)&&a(e.data.attrs))){var r,o,s=e.elm,c=n.data.attrs||{},d=e.data.attrs||{};for(r in(i(d.__ob__)||l(d._v_attr_proxy))&&(d=e.data.attrs=P({},d)),d)o=d[r],c[r]!==o&&Or(s,r,o,e.data.pre);for(r in(V||Z)&&d.value!==c.value&&Or(s,"value",d.value),c)a(d[r])&&(ir(r)?s.removeAttributeNS(ar,lr(r)):tr(r)||s.removeAttribute(r))}}function Or(n,e,t,r){r||n.tagName.indexOf("-")>-1?Nr(n,e,t):or(e)?sr(t)?n.removeAttribute(e):(t="allowfullscreen"===e&&"EMBED"===n.tagName?"true":e,n.setAttribute(e,t)):tr(e)?n.setAttribute(e,function(n,e){return sr(e)||"false"===e?"false":"contenteditable"===n&&rr(e)?e:"true"}(e,t)):ir(e)?sr(t)?n.removeAttributeNS(ar,lr(e)):n.setAttributeNS(ar,e,t):Nr(n,e,t)}function Nr(n,e,t){if(sr(t))n.removeAttribute(e);else{if(V&&!K&&"TEXTAREA"===n.tagName&&"placeholder"===e&&""!==t&&!n.__ieph){var r=function(e){e.stopImmediatePropagation(),n.removeEventListener("input",r)};n.addEventListener("input",r),n.__ieph=!0}n.setAttribute(e,t)}}var Mr={create:Br,update:Br};function zr(n,e){var t=e.elm,r=e.data,o=n.data;if(!(a(r.staticClass)&&a(r.class)&&(a(o)||a(o.staticClass)&&a(o.class)))){var l=cr(e),s=t._transitionClasses;i(s)&&(l=ur(l,pr(s))),l!==t._prevClass&&(t.setAttribute("class",l),t._prevClass=l)}}var Dr,qr={create:zr,update:zr};function Jr(n,e,t){var r=Dr;return function o(){var a=e.apply(null,arguments);null!==a&&Hr(n,o,t,r)}}var Fr=Pe&&!(en&&Number(en[1])<=53);function Ur(n,e,t,r){if(Fr){var o=lt,a=e;e=a._wrapper=function(n){if(n.target===n.currentTarget||n.timeStamp>=o||n.timeStamp<=0||n.target.ownerDocument!==document)return a.apply(this,arguments)}}Dr.addEventListener(n,e,rn?{capture:t,passive:r}:t)}function Hr(n,e,t,r){(r||Dr).removeEventListener(n,e._wrapper||e,t)}function Xr(n,e){if(!a(n.data.on)||!a(e.data.on)){var t=e.data.on||{},r=n.data.on||{};Dr=e.elm||n.elm,function(n){if(i(n.__r)){var e=V?"change":"input";n[e]=[].concat(n.__r,n[e]||[]),delete n.__r}i(n.__c)&&(n.change=[].concat(n.__c,n.change||[]),delete n.__c)}(t),$n(t,r,Ur,Hr,Jr,e.context),Dr=void 0}}var $r,Wr={create:Xr,update:Xr,destroy:function(n){return Xr(n,Sr)}};function Qr(n,e){if(!a(n.data.domProps)||!a(e.data.domProps)){var t,r,o=e.elm,s=n.data.domProps||{},c=e.data.domProps||{};for(t in(i(c.__ob__)||l(c._v_attr_proxy))&&(c=e.data.domProps=P({},c)),s)t in c||(o[t]="");for(t in c){if(r=c[t],"textContent"===t||"innerHTML"===t){if(e.children&&(e.children.length=0),r===s[t])continue;1===o.childNodes.length&&o.removeChild(o.childNodes[0])}if("value"===t&&"PROGRESS"!==o.tagName){o._value=r;var d=a(r)?"":String(r);Gr(o,d)&&(o.value=d)}else if("innerHTML"===t&&fr(o.tagName)&&a(o.innerHTML)){($r=$r||document.createElement("div")).innerHTML="<svg>".concat(r,"</svg>");for(var u=$r.firstChild;o.firstChild;)o.removeChild(o.firstChild);for(;u.firstChild;)o.appendChild(u.firstChild)}else if(r!==s[t])try{o[t]=r}catch(n){}}}}function Gr(n,e){return!n.composing&&("OPTION"===n.tagName||function(n,e){var t=!0;try{t=document.activeElement!==n}catch(n){}return t&&n.value!==e}(n,e)||function(n,e){var t=n.value,r=n._vModifiers;if(i(r)){if(r.number)return b(t)!==b(e);if(r.trim)return t.trim()!==e.trim()}return t!==e}(n,e))}var Vr={create:Qr,update:Qr},Kr=S((function(n){var e={},t=/:(.+)/;return n.split(/;(?![^(]*\))/g).forEach((function(n){if(n){var r=n.split(t);r.length>1&&(e[r[0].trim()]=r[1].trim())}})),e}));function Zr(n){var e=Yr(n.style);return n.staticStyle?P(n.staticStyle,e):e}function Yr(n){return Array.isArray(n)?L(n):"string"==typeof n?Kr(n):n}var no,eo=/^--/,to=/\s*!important$/,ro=function(n,e,t){if(eo.test(e))n.style.setProperty(e,t);else if(to.test(t))n.style.setProperty(E(e),t.replace(to,""),"important");else{var r=ao(e);if(Array.isArray(t))for(var o=0,a=t.length;o<a;o++)n.style[r]=t[o];else n.style[r]=t}},oo=["Webkit","Moz","ms"],ao=S((function(n){if(no=no||document.createElement("div").style,"filter"!==(n=T(n))&&n in no)return n;for(var e=n.charAt(0).toUpperCase()+n.slice(1),t=0;t<oo.length;t++){var r=oo[t]+e;if(r in no)return r}}));function io(n,e){var t=e.data,r=n.data;if(!(a(t.staticStyle)&&a(t.style)&&a(r.staticStyle)&&a(r.style))){var o,l,s=e.elm,c=r.staticStyle,d=r.normalizedStyle||r.style||{},u=c||d,p=Yr(e.data.style)||{};e.data.normalizedStyle=i(p.__ob__)?P({},p):p;var g=function(n,e){var t,r={};if(e)for(var o=n;o.componentInstance;)(o=o.componentInstance._vnode)&&o.data&&(t=Zr(o.data))&&P(r,t);(t=Zr(n.data))&&P(r,t);for(var a=n;a=a.parent;)a.data&&(t=Zr(a.data))&&P(r,t);return r}(e,!0);for(l in u)a(g[l])&&ro(s,l,"");for(l in g)(o=g[l])!==u[l]&&ro(s,l,null==o?"":o)}}var lo={create:io,update:io},so=/\s+/;function co(n,e){if(e&&(e=e.trim()))if(n.classList)e.indexOf(" ")>-1?e.split(so).forEach((function(e){return n.classList.add(e)})):n.classList.add(e);else{var t=" ".concat(n.getAttribute("class")||""," ");t.indexOf(" "+e+" ")<0&&n.setAttribute("class",(t+e).trim())}}function uo(n,e){if(e&&(e=e.trim()))if(n.classList)e.indexOf(" ")>-1?e.split(so).forEach((function(e){return n.classList.remove(e)})):n.classList.remove(e),n.classList.length||n.removeAttribute("class");else{for(var t=" ".concat(n.getAttribute("class")||""," "),r=" "+e+" ";t.indexOf(r)>=0;)t=t.replace(r," ");(t=t.trim())?n.setAttribute("class",t):n.removeAttribute("class")}}function po(n){if(n){if("object"==typeof n){var e={};return!1!==n.css&&P(e,go(n.name||"v")),P(e,n),e}return"string"==typeof n?go(n):void 0}}var go=S((function(n){return{enterClass:"".concat(n,"-enter"),enterToClass:"".concat(n,"-enter-to"),enterActiveClass:"".concat(n,"-enter-active"),leaveClass:"".concat(n,"-leave"),leaveToClass:"".concat(n,"-leave-to"),leaveActiveClass:"".concat(n,"-leave-active")}})),ho=Q&&!K,fo="transition",mo="transitionend",bo="animation",xo="animationend";ho&&(void 0===window.ontransitionend&&void 0!==window.onwebkittransitionend&&(fo="WebkitTransition",mo="webkitTransitionEnd"),void 0===window.onanimationend&&void 0!==window.onwebkitanimationend&&(bo="WebkitAnimation",xo="webkitAnimationEnd"));var vo=Q?window.requestAnimationFrame?window.requestAnimationFrame.bind(window):setTimeout:function(n){return n()};function yo(n){vo((function(){vo(n)}))}function ko(n,e){var t=n._transitionClasses||(n._transitionClasses=[]);t.indexOf(e)<0&&(t.push(e),co(n,e))}function wo(n,e){n._transitionClasses&&y(n._transitionClasses,e),uo(n,e)}function So(n,e,t){var r=To(n,e),o=r.type,a=r.timeout,i=r.propCount;if(!o)return t();var l="transition"===o?mo:xo,s=0,c=function(){n.removeEventListener(l,d),t()},d=function(e){e.target===n&&++s>=i&&c()};setTimeout((function(){s<i&&c()}),a+1),n.addEventListener(l,d)}var jo=/\b(transform|all)(,|$)/;function To(n,e){var t,r=window.getComputedStyle(n),o=(r[fo+"Delay"]||"").split(", "),a=(r[fo+"Duration"]||"").split(", "),i=_o(o,a),l=(r[bo+"Delay"]||"").split(", "),s=(r[bo+"Duration"]||"").split(", "),c=_o(l,s),d=0,u=0;return"transition"===e?i>0&&(t="transition",d=i,u=a.length):"animation"===e?c>0&&(t="animation",d=c,u=s.length):u=(t=(d=Math.max(i,c))>0?i>c?"transition":"animation":null)?"transition"===t?a.length:s.length:0,{type:t,timeout:d,propCount:u,hasTransform:"transition"===t&&jo.test(r[fo+"Property"])}}function _o(n,e){for(;n.length<e.length;)n=n.concat(n);return Math.max.apply(null,e.map((function(e,t){return Co(e)+Co(n[t])})))}function Co(n){return 1e3*Number(n.slice(0,-1).replace(",","."))}function Eo(n,e){var t=n.elm;i(t._leaveCb)&&(t._leaveCb.cancelled=!0,t._leaveCb());var r=po(n.data.transition);if(!a(r)&&!i(t._enterCb)&&1===t.nodeType){for(var o=r.css,l=r.type,s=r.enterClass,u=r.enterToClass,p=r.enterActiveClass,g=r.appearClass,h=r.appearToClass,f=r.appearActiveClass,m=r.beforeEnter,x=r.enter,v=r.afterEnter,y=r.enterCancelled,k=r.beforeAppear,w=r.appear,S=r.afterAppear,j=r.appearCancelled,T=r.duration,_=Ve,C=Ve.$vnode;C&&C.parent;)_=C.context,C=C.parent;var E=!_._isMounted||!n.isRootInsert;if(!E||w||""===w){var I=E&&g?g:s,A=E&&f?f:p,P=E&&h?h:u,L=E&&k||m,R=E&&c(w)?w:x,B=E&&S||v,O=E&&j||y,N=b(d(T)?T.enter:T);0;var M=!1!==o&&!K,D=Po(R),q=t._enterCb=z((function(){M&&(wo(t,P),wo(t,A)),q.cancelled?(M&&wo(t,I),O&&O(t)):B&&B(t),t._enterCb=null}));n.data.show||Wn(n,"insert",(function(){var e=t.parentNode,r=e&&e._pending&&e._pending[n.key];r&&r.tag===n.tag&&r.elm._leaveCb&&r.elm._leaveCb(),R&&R(t,q)})),L&&L(t),M&&(ko(t,I),ko(t,A),yo((function(){wo(t,I),q.cancelled||(ko(t,P),D||(Ao(N)?setTimeout(q,N):So(t,l,q)))}))),n.data.show&&(e&&e(),R&&R(t,q)),M||D||q()}}}function Io(n,e){var t=n.elm;i(t._enterCb)&&(t._enterCb.cancelled=!0,t._enterCb());var r=po(n.data.transition);if(a(r)||1!==t.nodeType)return e();if(!i(t._leaveCb)){var o=r.css,l=r.type,s=r.leaveClass,c=r.leaveToClass,u=r.leaveActiveClass,p=r.beforeLeave,g=r.leave,h=r.afterLeave,f=r.leaveCancelled,m=r.delayLeave,x=r.duration,v=!1!==o&&!K,y=Po(g),k=b(d(x)?x.leave:x);0;var w=t._leaveCb=z((function(){t.parentNode&&t.parentNode._pending&&(t.parentNode._pending[n.key]=null),v&&(wo(t,c),wo(t,u)),w.cancelled?(v&&wo(t,s),f&&f(t)):(e(),h&&h(t)),t._leaveCb=null}));m?m(S):S()}function S(){w.cancelled||(!n.data.show&&t.parentNode&&((t.parentNode._pending||(t.parentNode._pending={}))[n.key]=n),p&&p(t),v&&(ko(t,s),ko(t,u),yo((function(){wo(t,s),w.cancelled||(ko(t,c),y||(Ao(k)?setTimeout(w,k):So(t,l,w)))}))),g&&g(t,w),v||y||w())}}function Ao(n){return"number"==typeof n&&!isNaN(n)}function Po(n){if(a(n))return!1;var e=n.fns;return i(e)?Po(Array.isArray(e)?e[0]:e):(n._length||n.length)>1}function Lo(n,e){!0!==e.data.show&&Eo(e)}var Ro=function(n){var e,t,r={},c=n.modules,d=n.nodeOps;for(e=0;e<jr.length;++e)for(r[jr[e]]=[],t=0;t<c.length;++t)i(c[t][jr[e]])&&r[jr[e]].push(c[t][jr[e]]);function u(n){var e=d.parentNode(n);i(e)&&d.removeChild(e,n)}function p(n,e,t,o,a,s,c){if(i(n.elm)&&i(s)&&(n=s[c]=mn(n)),n.isRootInsert=!a,!function(n,e,t,o){var a=n.data;if(i(a)){var s=i(n.componentInstance)&&a.keepAlive;if(i(a=a.hook)&&i(a=a.init)&&a(n,!1),i(n.componentInstance))return g(n,e),h(t,n.elm,o),l(s)&&function(n,e,t,o){var a,l=n;for(;l.componentInstance;)if(l=l.componentInstance._vnode,i(a=l.data)&&i(a=a.transition)){for(a=0;a<r.activate.length;++a)r.activate[a](Sr,l);e.push(l);break}h(t,n.elm,o)}(n,e,t,o),!0}}(n,e,t,o)){var u=n.data,p=n.children,m=n.tag;i(m)?(n.elm=n.ns?d.createElementNS(n.ns,m):d.createElement(m,n),v(n),f(n,p,e),i(u)&&b(n,e),h(t,n.elm,o)):l(n.isComment)?(n.elm=d.createComment(n.text),h(t,n.elm,o)):(n.elm=d.createTextNode(n.text),h(t,n.elm,o))}}function g(n,e){i(n.data.pendingInsert)&&(e.push.apply(e,n.data.pendingInsert),n.data.pendingInsert=null),n.elm=n.componentInstance.$el,m(n)?(b(n,e),v(n)):(kr(n),e.push(n))}function h(n,e,t){i(n)&&(i(t)?d.parentNode(t)===n&&d.insertBefore(n,e,t):d.appendChild(n,e))}function f(n,e,t){if(o(e)){0;for(var r=0;r<e.length;++r)p(e[r],t,n.elm,null,!0,e,r)}else s(n.text)&&d.appendChild(n.elm,d.createTextNode(String(n.text)))}function m(n){for(;n.componentInstance;)n=n.componentInstance._vnode;return i(n.tag)}function b(n,t){for(var o=0;o<r.create.length;++o)r.create[o](Sr,n);i(e=n.data.hook)&&(i(e.create)&&e.create(Sr,n),i(e.insert)&&t.push(n))}function v(n){var e;if(i(e=n.fnScopeId))d.setStyleScope(n.elm,e);else for(var t=n;t;)i(e=t.context)&&i(e=e.$options._scopeId)&&d.setStyleScope(n.elm,e),t=t.parent;i(e=Ve)&&e!==n.context&&e!==n.fnContext&&i(e=e.$options._scopeId)&&d.setStyleScope(n.elm,e)}function y(n,e,t,r,o,a){for(;r<=o;++r)p(t[r],a,n,e,!1,t,r)}function k(n){var e,t,o=n.data;if(i(o))for(i(e=o.hook)&&i(e=e.destroy)&&e(n),e=0;e<r.destroy.length;++e)r.destroy[e](n);if(i(e=n.children))for(t=0;t<n.children.length;++t)k(n.children[t])}function w(n,e,t){for(;e<=t;++e){var r=n[e];i(r)&&(i(r.tag)?(S(r),k(r)):u(r.elm))}}function S(n,e){if(i(e)||i(n.data)){var t,o=r.remove.length+1;for(i(e)?e.listeners+=o:e=function(n,e){function t(){0==--t.listeners&&u(n)}return t.listeners=e,t}(n.elm,o),i(t=n.componentInstance)&&i(t=t._vnode)&&i(t.data)&&S(t,e),t=0;t<r.remove.length;++t)r.remove[t](n,e);i(t=n.data.hook)&&i(t=t.remove)?t(n,e):e()}else u(n.elm)}function j(n,e,t,r){for(var o=t;o<r;o++){var a=e[o];if(i(a)&&Tr(n,a))return o}}function T(n,e,t,o,s,c){if(n!==e){i(e.elm)&&i(o)&&(e=o[s]=mn(e));var u=e.elm=n.elm;if(l(n.isAsyncPlaceholder))i(e.asyncFactory.resolved)?E(n.elm,e,t):e.isAsyncPlaceholder=!0;else if(l(e.isStatic)&&l(n.isStatic)&&e.key===n.key&&(l(e.isCloned)||l(e.isOnce)))e.componentInstance=n.componentInstance;else{var g,h=e.data;i(h)&&i(g=h.hook)&&i(g=g.prepatch)&&g(n,e);var f=n.children,b=e.children;if(i(h)&&m(e)){for(g=0;g<r.update.length;++g)r.update[g](n,e);i(g=h.hook)&&i(g=g.update)&&g(n,e)}a(e.text)?i(f)&&i(b)?f!==b&&function(n,e,t,r,o){var l,s,c,u=0,g=0,h=e.length-1,f=e[0],m=e[h],b=t.length-1,x=t[0],v=t[b],k=!o;for(0;u<=h&&g<=b;)a(f)?f=e[++u]:a(m)?m=e[--h]:Tr(f,x)?(T(f,x,r,t,g),f=e[++u],x=t[++g]):Tr(m,v)?(T(m,v,r,t,b),m=e[--h],v=t[--b]):Tr(f,v)?(T(f,v,r,t,b),k&&d.insertBefore(n,f.elm,d.nextSibling(m.elm)),f=e[++u],v=t[--b]):Tr(m,x)?(T(m,x,r,t,g),k&&d.insertBefore(n,m.elm,f.elm),m=e[--h],x=t[++g]):(a(l)&&(l=_r(e,u,h)),a(s=i(x.key)?l[x.key]:j(x,e,u,h))?p(x,r,n,f.elm,!1,t,g):Tr(c=e[s],x)?(T(c,x,r,t,g),e[s]=void 0,k&&d.insertBefore(n,c.elm,f.elm)):p(x,r,n,f.elm,!1,t,g),x=t[++g]);u>h?y(n,a(t[b+1])?null:t[b+1].elm,t,g,b,r):g>b&&w(e,u,h)}(u,f,b,t,c):i(b)?(i(n.text)&&d.setTextContent(u,""),y(u,null,b,0,b.length-1,t)):i(f)?w(f,0,f.length-1):i(n.text)&&d.setTextContent(u,""):n.text!==e.text&&d.setTextContent(u,e.text),i(h)&&i(g=h.hook)&&i(g=g.postpatch)&&g(n,e)}}}function _(n,e,t){if(l(t)&&i(n.parent))n.parent.data.pendingInsert=e;else for(var r=0;r<e.length;++r)e[r].data.hook.insert(e[r])}var C=x("attrs,class,staticClass,staticStyle,key");function E(n,e,t,r){var o,a=e.tag,s=e.data,c=e.children;if(r=r||s&&s.pre,e.elm=n,l(e.isComment)&&i(e.asyncFactory))return e.isAsyncPlaceholder=!0,!0;if(i(s)&&(i(o=s.hook)&&i(o=o.init)&&o(e,!0),i(o=e.componentInstance)))return g(e,t),!0;if(i(a)){if(i(c))if(n.hasChildNodes())if(i(o=s)&&i(o=o.domProps)&&i(o=o.innerHTML)){if(o!==n.innerHTML)return!1}else{for(var d=!0,u=n.firstChild,p=0;p<c.length;p++){if(!u||!E(u,c[p],t,r)){d=!1;break}u=u.nextSibling}if(!d||u)return!1}else f(e,c,t);if(i(s)){var h=!1;for(var m in s)if(!C(m)){h=!0,b(e,t);break}!h&&s.class&&Fe(s.class)}}else n.data!==e.text&&(n.data=e.text);return!0}return function(n,e,t,o){if(!a(e)){var s,c=!1,u=[];if(a(n))c=!0,p(e,u);else{var g=i(n.nodeType);if(!g&&Tr(n,e))T(n,e,u,null,null,o);else{if(g){if(1===n.nodeType&&n.hasAttribute("data-server-rendered")&&(n.removeAttribute("data-server-rendered"),t=!0),l(t)&&E(n,e,u))return _(e,u,!0),n;s=n,n=new gn(d.tagName(s).toLowerCase(),{},[],void 0,s)}var h=n.elm,f=d.parentNode(h);if(p(e,u,h._leaveCb?null:f,d.nextSibling(h)),i(e.parent))for(var b=e.parent,x=m(e);b;){for(var v=0;v<r.destroy.length;++v)r.destroy[v](b);if(b.elm=e.elm,x){for(var y=0;y<r.create.length;++y)r.create[y](Sr,b);var S=b.data.hook.insert;if(S.merged)for(var j=1;j<S.fns.length;j++)S.fns[j]()}else kr(b);b=b.parent}i(f)?w([n],0,0):i(n.tag)&&k(n)}}return _(e,u,c),e.elm}i(n)&&k(n)}}({nodeOps:vr,modules:[Mr,qr,Wr,Vr,lo,Q?{create:Lo,activate:Lo,remove:function(n,e){!0!==n.data.show?Io(n,e):e()}}:{}].concat(Rr)});K&&document.addEventListener("selectionchange",(function(){var n=document.activeElement;n&&n.vmodel&&Jo(n,"input")}));var Bo={inserted:function(n,e,t,r){"select"===t.tag?(r.elm&&!r.elm._vOptions?Wn(t,"postpatch",(function(){Bo.componentUpdated(n,e,t)})):Oo(n,e,t.context),n._vOptions=[].map.call(n.options,zo)):("textarea"===t.tag||xr(n.type))&&(n._vModifiers=e.modifiers,e.modifiers.lazy||(n.addEventListener("compositionstart",Do),n.addEventListener("compositionend",qo),n.addEventListener("change",qo),K&&(n.vmodel=!0)))},componentUpdated:function(n,e,t){if("select"===t.tag){Oo(n,e,t.context);var r=n._vOptions,o=n._vOptions=[].map.call(n.options,zo);if(o.some((function(n,e){return!N(n,r[e])})))(n.multiple?e.value.some((function(n){return Mo(n,o)})):e.value!==e.oldValue&&Mo(e.value,o))&&Jo(n,"change")}}};function Oo(n,e,t){No(n,e,t),(V||Z)&&setTimeout((function(){No(n,e,t)}),0)}function No(n,e,t){var r=e.value,o=n.multiple;if(!o||Array.isArray(r)){for(var a,i,l=0,s=n.options.length;l<s;l++)if(i=n.options[l],o)a=M(r,zo(i))>-1,i.selected!==a&&(i.selected=a);else if(N(zo(i),r))return void(n.selectedIndex!==l&&(n.selectedIndex=l));o||(n.selectedIndex=-1)}}function Mo(n,e){return e.every((function(e){return!N(e,n)}))}function zo(n){return"_value"in n?n._value:n.value}function Do(n){n.target.composing=!0}function qo(n){n.target.composing&&(n.target.composing=!1,Jo(n.target,"input"))}function Jo(n,e){var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!0),n.dispatchEvent(t)}function Fo(n){return!n.componentInstance||n.data&&n.data.transition?n:Fo(n.componentInstance._vnode)}var Uo={model:Bo,show:{bind:function(n,e,t){var r=e.value,o=(t=Fo(t)).data&&t.data.transition,a=n.__vOriginalDisplay="none"===n.style.display?"":n.style.display;r&&o?(t.data.show=!0,Eo(t,(function(){n.style.display=a}))):n.style.display=r?a:"none"},update:function(n,e,t){var r=e.value;!r!=!e.oldValue&&((t=Fo(t)).data&&t.data.transition?(t.data.show=!0,r?Eo(t,(function(){n.style.display=n.__vOriginalDisplay})):Io(t,(function(){n.style.display="none"}))):n.style.display=r?n.__vOriginalDisplay:"none")},unbind:function(n,e,t,r,o){o||(n.style.display=n.__vOriginalDisplay)}}},Ho={name:String,appear:Boolean,css:Boolean,mode:String,type:String,enterClass:String,leaveClass:String,enterToClass:String,leaveToClass:String,enterActiveClass:String,leaveActiveClass:String,appearClass:String,appearActiveClass:String,appearToClass:String,duration:[Number,String,Object]};function Xo(n){var e=n&&n.componentOptions;return e&&e.Ctor.options.abstract?Xo(je(e.children)):n}function $o(n){var e={},t=n.$options;for(var r in t.propsData)e[r]=n[r];var o=t._parentListeners;for(var r in o)e[T(r)]=o[r];return e}function Wo(n,e){if(/\d-keep-alive$/.test(e.tag))return n("keep-alive",{props:e.componentOptions.propsData})}var Qo=function(n){return n.tag||he(n)},Go=function(n){return"show"===n.name},Vo={name:"transition",props:Ho,abstract:!0,render:function(n){var e=this,t=this.$slots.default;if(t&&(t=t.filter(Qo)).length){0;var r=this.mode;0;var o=t[0];if(function(n){for(;n=n.parent;)if(n.data.transition)return!0}(this.$vnode))return o;var a=Xo(o);if(!a)return o;if(this._leaving)return Wo(n,o);var i="__transition-".concat(this._uid,"-");a.key=null==a.key?a.isComment?i+"comment":i+a.tag:s(a.key)?0===String(a.key).indexOf(i)?a.key:i+a.key:a.key;var l=(a.data||(a.data={})).transition=$o(this),c=this._vnode,d=Xo(c);if(a.data.directives&&a.data.directives.some(Go)&&(a.data.show=!0),d&&d.data&&!function(n,e){return e.key===n.key&&e.tag===n.tag}(a,d)&&!he(d)&&(!d.componentInstance||!d.componentInstance._vnode.isComment)){var u=d.data.transition=P({},l);if("out-in"===r)return this._leaving=!0,Wn(u,"afterLeave",(function(){e._leaving=!1,e.$forceUpdate()})),Wo(n,o);if("in-out"===r){if(he(a))return c;var p,g=function(){p()};Wn(l,"afterEnter",g),Wn(l,"enterCancelled",g),Wn(u,"delayLeave",(function(n){p=n}))}}return o}}},Ko=P({tag:String,moveClass:String},Ho);function Zo(n){n.elm._moveCb&&n.elm._moveCb(),n.elm._enterCb&&n.elm._enterCb()}function Yo(n){n.data.newPos=n.elm.getBoundingClientRect()}function na(n){var e=n.data.pos,t=n.data.newPos,r=e.left-t.left,o=e.top-t.top;if(r||o){n.data.moved=!0;var a=n.elm.style;a.transform=a.WebkitTransform="translate(".concat(r,"px,").concat(o,"px)"),a.transitionDuration="0s"}}delete Ko.mode;var ea={Transition:Vo,TransitionGroup:{props:Ko,beforeMount:function(){var n=this,e=this._update;this._update=function(t,r){var o=Ke(n);n.__patch__(n._vnode,n.kept,!1,!0),n._vnode=n.kept,o(),e.call(n,t,r)}},render:function(n){for(var e=this.tag||this.$vnode.data.tag||"span",t=Object.create(null),r=this.prevChildren=this.children,o=this.$slots.default||[],a=this.children=[],i=$o(this),l=0;l<o.length;l++){if((d=o[l]).tag)if(null!=d.key&&0!==String(d.key).indexOf("__vlist"))a.push(d),t[d.key]=d,(d.data||(d.data={})).transition=i;else;}if(r){var s=[],c=[];for(l=0;l<r.length;l++){var d;(d=r[l]).data.transition=i,d.data.pos=d.elm.getBoundingClientRect(),t[d.key]?s.push(d):c.push(d)}this.kept=n(e,null,s),this.removed=c}return n(e,null,a)},updated:function(){var n=this.prevChildren,e=this.moveClass||(this.name||"v")+"-move";n.length&&this.hasMove(n[0].elm,e)&&(n.forEach(Zo),n.forEach(Yo),n.forEach(na),this._reflow=document.body.offsetHeight,n.forEach((function(n){if(n.data.moved){var t=n.elm,r=t.style;ko(t,e),r.transform=r.WebkitTransform=r.transitionDuration="",t.addEventListener(mo,t._moveCb=function n(r){r&&r.target!==t||r&&!/transform$/.test(r.propertyName)||(t.removeEventListener(mo,n),t._moveCb=null,wo(t,e))})}})))},methods:{hasMove:function(n,e){if(!ho)return!1;if(this._hasMove)return this._hasMove;var t=n.cloneNode();n._transitionClasses&&n._transitionClasses.forEach((function(n){uo(t,n)})),co(t,e),t.style.display="none",this.$el.appendChild(t);var r=To(t);return this.$el.removeChild(t),this._hasMove=r.hasTransform}}}};function ta(n,e){for(var t in e)n[t]=e[t];return n}$t.config.mustUseProp=function(n,e,t){return"value"===t&&er(n)&&"button"!==e||"selected"===t&&"option"===n||"checked"===t&&"input"===n||"muted"===t&&"video"===n},$t.config.isReservedTag=mr,$t.config.isReservedAttr=nr,$t.config.getTagNamespace=function(n){return fr(n)?"svg":"math"===n?"math":void 0},$t.config.isUnknownElement=function(n){if(!Q)return!0;if(mr(n))return!1;if(n=n.toLowerCase(),null!=br[n])return br[n];var e=document.createElement(n);return n.indexOf("-")>-1?br[n]=e.constructor===window.HTMLUnknownElement||e.constructor===window.HTMLElement:br[n]=/HTMLUnknownElement/.test(e.toString())},P($t.options.directives,Uo),P($t.options.components,ea),$t.prototype.__patch__=Q?Ro:R,$t.prototype.$mount=function(n,e){return function(n,e,t){var r;n.$el=e,n.$options.render||(n.$options.render=hn),nt(n,"beforeMount"),r=function(){n._update(n._render(),t)},new Xe(n,r,R,{before:function(){n._isMounted&&!n._isDestroyed&&nt(n,"beforeUpdate")}},!0),t=!1;var o=n._preWatchers;if(o)for(var a=0;a<o.length;a++)o[a].run();return null==n.$vnode&&(n._isMounted=!0,nt(n,"mounted")),n}(this,n=n&&Q?function(n){if("string"==typeof n){var e=document.querySelector(n);return e||document.createElement("div")}return n}(n):void 0,e)},Q&&setTimeout((function(){F.devtools&&ln&&ln.emit("init",$t)}),0);var ra=/[!'()*]/g,oa=function(n){return"%"+n.charCodeAt(0).toString(16)},aa=/%2C/g,ia=function(n){return encodeURIComponent(n).replace(ra,oa).replace(aa,",")};function la(n){try{return decodeURIComponent(n)}catch(n){0}return n}var sa=function(n){return null==n||"object"==typeof n?n:String(n)};function ca(n){var e={};return(n=n.trim().replace(/^(\?|#|&)/,""))?(n.split("&").forEach((function(n){var t=n.replace(/\+/g," ").split("="),r=la(t.shift()),o=t.length>0?la(t.join("=")):null;void 0===e[r]?e[r]=o:Array.isArray(e[r])?e[r].push(o):e[r]=[e[r],o]})),e):e}function da(n){var e=n?Object.keys(n).map((function(e){var t=n[e];if(void 0===t)return"";if(null===t)return ia(e);if(Array.isArray(t)){var r=[];return t.forEach((function(n){void 0!==n&&(null===n?r.push(ia(e)):r.push(ia(e)+"="+ia(n)))})),r.join("&")}return ia(e)+"="+ia(t)})).filter((function(n){return n.length>0})).join("&"):null;return e?"?"+e:""}var ua=/\/?$/;function pa(n,e,t,r){var o=r&&r.options.stringifyQuery,a=e.query||{};try{a=ga(a)}catch(n){}var i={name:e.name||n&&n.name,meta:n&&n.meta||{},path:e.path||"/",hash:e.hash||"",query:a,params:e.params||{},fullPath:ma(e,o),matched:n?fa(n):[]};return t&&(i.redirectedFrom=ma(t,o)),Object.freeze(i)}function ga(n){if(Array.isArray(n))return n.map(ga);if(n&&"object"==typeof n){var e={};for(var t in n)e[t]=ga(n[t]);return e}return n}var ha=pa(null,{path:"/"});function fa(n){for(var e=[];n;)e.unshift(n),n=n.parent;return e}function ma(n,e){var t=n.path,r=n.query;void 0===r&&(r={});var o=n.hash;return void 0===o&&(o=""),(t||"/")+(e||da)(r)+o}function ba(n,e,t){return e===ha?n===e:!!e&&(n.path&&e.path?n.path.replace(ua,"")===e.path.replace(ua,"")&&(t||n.hash===e.hash&&xa(n.query,e.query)):!(!n.name||!e.name)&&(n.name===e.name&&(t||n.hash===e.hash&&xa(n.query,e.query)&&xa(n.params,e.params))))}function xa(n,e){if(void 0===n&&(n={}),void 0===e&&(e={}),!n||!e)return n===e;var t=Object.keys(n).sort(),r=Object.keys(e).sort();return t.length===r.length&&t.every((function(t,o){var a=n[t];if(r[o]!==t)return!1;var i=e[t];return null==a||null==i?a===i:"object"==typeof a&&"object"==typeof i?xa(a,i):String(a)===String(i)}))}function va(n){for(var e=0;e<n.matched.length;e++){var t=n.matched[e];for(var r in t.instances){var o=t.instances[r],a=t.enteredCbs[r];if(o&&a){delete t.enteredCbs[r];for(var i=0;i<a.length;i++)o._isBeingDestroyed||a[i](o)}}}}var ya={name:"RouterView",functional:!0,props:{name:{type:String,default:"default"}},render:function(n,e){var t=e.props,r=e.children,o=e.parent,a=e.data;a.routerView=!0;for(var i=o.$createElement,l=t.name,s=o.$route,c=o._routerViewCache||(o._routerViewCache={}),d=0,u=!1;o&&o._routerRoot!==o;){var p=o.$vnode?o.$vnode.data:{};p.routerView&&d++,p.keepAlive&&o._directInactive&&o._inactive&&(u=!0),o=o.$parent}if(a.routerViewDepth=d,u){var g=c[l],h=g&&g.component;return h?(g.configProps&&ka(h,a,g.route,g.configProps),i(h,a,r)):i()}var f=s.matched[d],m=f&&f.components[l];if(!f||!m)return c[l]=null,i();c[l]={component:m},a.registerRouteInstance=function(n,e){var t=f.instances[l];(e&&t!==n||!e&&t===n)&&(f.instances[l]=e)},(a.hook||(a.hook={})).prepatch=function(n,e){f.instances[l]=e.componentInstance},a.hook.init=function(n){n.data.keepAlive&&n.componentInstance&&n.componentInstance!==f.instances[l]&&(f.instances[l]=n.componentInstance),va(s)};var b=f.props&&f.props[l];return b&&(ta(c[l],{route:s,configProps:b}),ka(m,a,s,b)),i(m,a,r)}};function ka(n,e,t,r){var o=e.props=function(n,e){switch(typeof e){case"undefined":return;case"object":return e;case"function":return e(n);case"boolean":return e?n.params:void 0;default:0}}(t,r);if(o){o=e.props=ta({},o);var a=e.attrs=e.attrs||{};for(var i in o)n.props&&i in n.props||(a[i]=o[i],delete o[i])}}function wa(n,e,t){var r=n.charAt(0);if("/"===r)return n;if("?"===r||"#"===r)return e+n;var o=e.split("/");t&&o[o.length-1]||o.pop();for(var a=n.replace(/^\//,"").split("/"),i=0;i<a.length;i++){var l=a[i];".."===l?o.pop():"."!==l&&o.push(l)}return""!==o[0]&&o.unshift(""),o.join("/")}function Sa(n){return n.replace(/\/(?:\s*\/)+/g,"/")}var ja=Array.isArray||function(n){return"[object Array]"==Object.prototype.toString.call(n)},Ta=Da,_a=Pa,Ca=function(n,e){return Ra(Pa(n,e),e)},Ea=Ra,Ia=za,Aa=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))"].join("|"),"g");function Pa(n,e){for(var t,r=[],o=0,a=0,i="",l=e&&e.delimiter||"/";null!=(t=Aa.exec(n));){var s=t[0],c=t[1],d=t.index;if(i+=n.slice(a,d),a=d+s.length,c)i+=c[1];else{var u=n[a],p=t[2],g=t[3],h=t[4],f=t[5],m=t[6],b=t[7];i&&(r.push(i),i="");var x=null!=p&&null!=u&&u!==p,v="+"===m||"*"===m,y="?"===m||"*"===m,k=t[2]||l,w=h||f;r.push({name:g||o++,prefix:p||"",delimiter:k,optional:y,repeat:v,partial:x,asterisk:!!b,pattern:w?Oa(w):b?".*":"[^"+Ba(k)+"]+?"})}}return a<n.length&&(i+=n.substr(a)),i&&r.push(i),r}function La(n){return encodeURI(n).replace(/[\/?#]/g,(function(n){return"%"+n.charCodeAt(0).toString(16).toUpperCase()}))}function Ra(n,e){for(var t=new Array(n.length),r=0;r<n.length;r++)"object"==typeof n[r]&&(t[r]=new RegExp("^(?:"+n[r].pattern+")$",Ma(e)));return function(e,r){for(var o="",a=e||{},i=(r||{}).pretty?La:encodeURIComponent,l=0;l<n.length;l++){var s=n[l];if("string"!=typeof s){var c,d=a[s.name];if(null==d){if(s.optional){s.partial&&(o+=s.prefix);continue}throw new TypeError('Expected "'+s.name+'" to be defined')}if(ja(d)){if(!s.repeat)throw new TypeError('Expected "'+s.name+'" to not repeat, but received `'+JSON.stringify(d)+"`");if(0===d.length){if(s.optional)continue;throw new TypeError('Expected "'+s.name+'" to not be empty')}for(var u=0;u<d.length;u++){if(c=i(d[u]),!t[l].test(c))throw new TypeError('Expected all "'+s.name+'" to match "'+s.pattern+'", but received `'+JSON.stringify(c)+"`");o+=(0===u?s.prefix:s.delimiter)+c}}else{if(c=s.asterisk?encodeURI(d).replace(/[?#]/g,(function(n){return"%"+n.charCodeAt(0).toString(16).toUpperCase()})):i(d),!t[l].test(c))throw new TypeError('Expected "'+s.name+'" to match "'+s.pattern+'", but received "'+c+'"');o+=s.prefix+c}}else o+=s}return o}}function Ba(n){return n.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function Oa(n){return n.replace(/([=!:$\/()])/g,"\\$1")}function Na(n,e){return n.keys=e,n}function Ma(n){return n&&n.sensitive?"":"i"}function za(n,e,t){ja(e)||(t=e||t,e=[]);for(var r=(t=t||{}).strict,o=!1!==t.end,a="",i=0;i<n.length;i++){var l=n[i];if("string"==typeof l)a+=Ba(l);else{var s=Ba(l.prefix),c="(?:"+l.pattern+")";e.push(l),l.repeat&&(c+="(?:"+s+c+")*"),a+=c=l.optional?l.partial?s+"("+c+")?":"(?:"+s+"("+c+"))?":s+"("+c+")"}}var d=Ba(t.delimiter||"/"),u=a.slice(-d.length)===d;return r||(a=(u?a.slice(0,-d.length):a)+"(?:"+d+"(?=$))?"),a+=o?"$":r&&u?"":"(?="+d+"|$)",Na(new RegExp("^"+a,Ma(t)),e)}function Da(n,e,t){return ja(e)||(t=e||t,e=[]),t=t||{},n instanceof RegExp?function(n,e){var t=n.source.match(/\((?!\?)/g);if(t)for(var r=0;r<t.length;r++)e.push({name:r,prefix:null,delimiter:null,optional:!1,repeat:!1,partial:!1,asterisk:!1,pattern:null});return Na(n,e)}(n,e):ja(n)?function(n,e,t){for(var r=[],o=0;o<n.length;o++)r.push(Da(n[o],e,t).source);return Na(new RegExp("(?:"+r.join("|")+")",Ma(t)),e)}(n,e,t):function(n,e,t){return za(Pa(n,t),e,t)}(n,e,t)}Ta.parse=_a,Ta.compile=Ca,Ta.tokensToFunction=Ea,Ta.tokensToRegExp=Ia;var qa=Object.create(null);function Ja(n,e,t){e=e||{};try{var r=qa[n]||(qa[n]=Ta.compile(n));return"string"==typeof e.pathMatch&&(e[0]=e.pathMatch),r(e,{pretty:!0})}catch(n){return""}finally{delete e[0]}}function Fa(n,e,t,r){var o="string"==typeof n?{path:n}:n;if(o._normalized)return o;if(o.name){var a=(o=ta({},n)).params;return a&&"object"==typeof a&&(o.params=ta({},a)),o}if(!o.path&&o.params&&e){(o=ta({},o))._normalized=!0;var i=ta(ta({},e.params),o.params);if(e.name)o.name=e.name,o.params=i;else if(e.matched.length){var l=e.matched[e.matched.length-1].path;o.path=Ja(l,i,e.path)}else 0;return o}var s=function(n){var e="",t="",r=n.indexOf("#");r>=0&&(e=n.slice(r),n=n.slice(0,r));var o=n.indexOf("?");return o>=0&&(t=n.slice(o+1),n=n.slice(0,o)),{path:n,query:t,hash:e}}(o.path||""),c=e&&e.path||"/",d=s.path?wa(s.path,c,t||o.append):c,u=function(n,e,t){void 0===e&&(e={});var r,o=t||ca;try{r=o(n||"")}catch(n){r={}}for(var a in e){var i=e[a];r[a]=Array.isArray(i)?i.map(sa):sa(i)}return r}(s.query,o.query,r&&r.options.parseQuery),p=o.hash||s.hash;return p&&"#"!==p.charAt(0)&&(p="#"+p),{_normalized:!0,path:d,query:u,hash:p}}var Ua,Ha=function(){},Xa={name:"RouterLink",props:{to:{type:[String,Object],required:!0},tag:{type:String,default:"a"},custom:Boolean,exact:Boolean,exactPath:Boolean,append:Boolean,replace:Boolean,activeClass:String,exactActiveClass:String,ariaCurrentValue:{type:String,default:"page"},event:{type:[String,Array],default:"click"}},render:function(n){var e=this,t=this.$router,r=this.$route,o=t.resolve(this.to,r,this.append),a=o.location,i=o.route,l=o.href,s={},c=t.options.linkActiveClass,d=t.options.linkExactActiveClass,u=null==c?"router-link-active":c,p=null==d?"router-link-exact-active":d,g=null==this.activeClass?u:this.activeClass,h=null==this.exactActiveClass?p:this.exactActiveClass,f=i.redirectedFrom?pa(null,Fa(i.redirectedFrom),null,t):i;s[h]=ba(r,f,this.exactPath),s[g]=this.exact||this.exactPath?s[h]:function(n,e){return 0===n.path.replace(ua,"/").indexOf(e.path.replace(ua,"/"))&&(!e.hash||n.hash===e.hash)&&function(n,e){for(var t in e)if(!(t in n))return!1;return!0}(n.query,e.query)}(r,f);var m=s[h]?this.ariaCurrentValue:null,b=function(n){$a(n)&&(e.replace?t.replace(a,Ha):t.push(a,Ha))},x={click:$a};Array.isArray(this.event)?this.event.forEach((function(n){x[n]=b})):x[this.event]=b;var v={class:s},y=!this.$scopedSlots.$hasNormal&&this.$scopedSlots.default&&this.$scopedSlots.default({href:l,route:i,navigate:b,isActive:s[g],isExactActive:s[h]});if(y){if(1===y.length)return y[0];if(y.length>1||!y.length)return 0===y.length?n():n("span",{},y)}if("a"===this.tag)v.on=x,v.attrs={href:l,"aria-current":m};else{var k=function n(e){var t;if(e)for(var r=0;r<e.length;r++){if("a"===(t=e[r]).tag)return t;if(t.children&&(t=n(t.children)))return t}}(this.$slots.default);if(k){k.isStatic=!1;var w=k.data=ta({},k.data);for(var S in w.on=w.on||{},w.on){var j=w.on[S];S in x&&(w.on[S]=Array.isArray(j)?j:[j])}for(var T in x)T in w.on?w.on[T].push(x[T]):w.on[T]=b;var _=k.data.attrs=ta({},k.data.attrs);_.href=l,_["aria-current"]=m}else v.on=x}return n(this.tag,v,this.$slots.default)}};function $a(n){if(!(n.metaKey||n.altKey||n.ctrlKey||n.shiftKey||n.defaultPrevented||void 0!==n.button&&0!==n.button)){if(n.currentTarget&&n.currentTarget.getAttribute){var e=n.currentTarget.getAttribute("target");if(/\b_blank\b/i.test(e))return}return n.preventDefault&&n.preventDefault(),!0}}var Wa="undefined"!=typeof window;function Qa(n,e,t,r,o){var a=e||[],i=t||Object.create(null),l=r||Object.create(null);n.forEach((function(n){!function n(e,t,r,o,a,i){var l=o.path,s=o.name;0;var c=o.pathToRegexpOptions||{},d=function(n,e,t){t||(n=n.replace(/\/$/,""));if("/"===n[0])return n;if(null==e)return n;return Sa(e.path+"/"+n)}(l,a,c.strict);"boolean"==typeof o.caseSensitive&&(c.sensitive=o.caseSensitive);var u={path:d,regex:Ga(d,c),components:o.components||{default:o.component},alias:o.alias?"string"==typeof o.alias?[o.alias]:o.alias:[],instances:{},enteredCbs:{},name:s,parent:a,matchAs:i,redirect:o.redirect,beforeEnter:o.beforeEnter,meta:o.meta||{},props:null==o.props?{}:o.components?o.props:{default:o.props}};o.children&&o.children.forEach((function(o){var a=i?Sa(i+"/"+o.path):void 0;n(e,t,r,o,u,a)}));t[u.path]||(e.push(u.path),t[u.path]=u);if(void 0!==o.alias)for(var p=Array.isArray(o.alias)?o.alias:[o.alias],g=0;g<p.length;++g){0;var h={path:p[g],children:o.children};n(e,t,r,h,a,u.path||"/")}s&&(r[s]||(r[s]=u))}(a,i,l,n,o)}));for(var s=0,c=a.length;s<c;s++)"*"===a[s]&&(a.push(a.splice(s,1)[0]),c--,s--);return{pathList:a,pathMap:i,nameMap:l}}function Ga(n,e){return Ta(n,[],e)}function Va(n,e){var t=Qa(n),r=t.pathList,o=t.pathMap,a=t.nameMap;function i(n,t,i){var l=Fa(n,t,!1,e),c=l.name;if(c){var d=a[c];if(!d)return s(null,l);var u=d.regex.keys.filter((function(n){return!n.optional})).map((function(n){return n.name}));if("object"!=typeof l.params&&(l.params={}),t&&"object"==typeof t.params)for(var p in t.params)!(p in l.params)&&u.indexOf(p)>-1&&(l.params[p]=t.params[p]);return l.path=Ja(d.path,l.params),s(d,l,i)}if(l.path){l.params={};for(var g=0;g<r.length;g++){var h=r[g],f=o[h];if(Ka(f.regex,l.path,l.params))return s(f,l,i)}}return s(null,l)}function l(n,t){var r=n.redirect,o="function"==typeof r?r(pa(n,t,null,e)):r;if("string"==typeof o&&(o={path:o}),!o||"object"!=typeof o)return s(null,t);var l=o,c=l.name,d=l.path,u=t.query,p=t.hash,g=t.params;if(u=l.hasOwnProperty("query")?l.query:u,p=l.hasOwnProperty("hash")?l.hash:p,g=l.hasOwnProperty("params")?l.params:g,c){a[c];return i({_normalized:!0,name:c,query:u,hash:p,params:g},void 0,t)}if(d){var h=function(n,e){return wa(n,e.parent?e.parent.path:"/",!0)}(d,n);return i({_normalized:!0,path:Ja(h,g),query:u,hash:p},void 0,t)}return s(null,t)}function s(n,t,r){return n&&n.redirect?l(n,r||t):n&&n.matchAs?function(n,e,t){var r=i({_normalized:!0,path:Ja(t,e.params)});if(r){var o=r.matched,a=o[o.length-1];return e.params=r.params,s(a,e)}return s(null,e)}(0,t,n.matchAs):pa(n,t,r,e)}return{match:i,addRoute:function(n,e){var t="object"!=typeof n?a[n]:void 0;Qa([e||n],r,o,a,t),t&&t.alias.length&&Qa(t.alias.map((function(n){return{path:n,children:[e]}})),r,o,a,t)},getRoutes:function(){return r.map((function(n){return o[n]}))},addRoutes:function(n){Qa(n,r,o,a)}}}function Ka(n,e,t){var r=e.match(n);if(!r)return!1;if(!t)return!0;for(var o=1,a=r.length;o<a;++o){var i=n.keys[o-1];i&&(t[i.name||"pathMatch"]="string"==typeof r[o]?la(r[o]):r[o])}return!0}var Za=Wa&&window.performance&&window.performance.now?window.performance:Date;function Ya(){return Za.now().toFixed(3)}var ni=Ya();function ei(){return ni}function ti(n){return ni=n}var ri=Object.create(null);function oi(){"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var n=window.location.protocol+"//"+window.location.host,e=window.location.href.replace(n,""),t=ta({},window.history.state);return t.key=ei(),window.history.replaceState(t,"",e),window.addEventListener("popstate",li),function(){window.removeEventListener("popstate",li)}}function ai(n,e,t,r){if(n.app){var o=n.options.scrollBehavior;o&&n.app.$nextTick((function(){var a=function(){var n=ei();if(n)return ri[n]}(),i=o.call(n,e,t,r?a:null);i&&("function"==typeof i.then?i.then((function(n){pi(n,a)})).catch((function(n){0})):pi(i,a))}))}}function ii(){var n=ei();n&&(ri[n]={x:window.pageXOffset,y:window.pageYOffset})}function li(n){ii(),n.state&&n.state.key&&ti(n.state.key)}function si(n){return di(n.x)||di(n.y)}function ci(n){return{x:di(n.x)?n.x:window.pageXOffset,y:di(n.y)?n.y:window.pageYOffset}}function di(n){return"number"==typeof n}var ui=/^#\d/;function pi(n,e){var t,r="object"==typeof n;if(r&&"string"==typeof n.selector){var o=ui.test(n.selector)?document.getElementById(n.selector.slice(1)):document.querySelector(n.selector);if(o){var a=n.offset&&"object"==typeof n.offset?n.offset:{};e=function(n,e){var t=document.documentElement.getBoundingClientRect(),r=n.getBoundingClientRect();return{x:r.left-t.left-e.x,y:r.top-t.top-e.y}}(o,a={x:di((t=a).x)?t.x:0,y:di(t.y)?t.y:0})}else si(n)&&(e=ci(n))}else r&&si(n)&&(e=ci(n));e&&("scrollBehavior"in document.documentElement.style?window.scrollTo({left:e.x,top:e.y,behavior:n.behavior}):window.scrollTo(e.x,e.y))}var gi,hi=Wa&&((-1===(gi=window.navigator.userAgent).indexOf("Android 2.")&&-1===gi.indexOf("Android 4.0")||-1===gi.indexOf("Mobile Safari")||-1!==gi.indexOf("Chrome")||-1!==gi.indexOf("Windows Phone"))&&window.history&&"function"==typeof window.history.pushState);function fi(n,e){ii();var t=window.history;try{if(e){var r=ta({},t.state);r.key=ei(),t.replaceState(r,"",n)}else t.pushState({key:ti(Ya())},"",n)}catch(t){window.location[e?"replace":"assign"](n)}}function mi(n){fi(n,!0)}var bi={redirected:2,aborted:4,cancelled:8,duplicated:16};function xi(n,e){return yi(n,e,bi.redirected,'Redirected when going from "'+n.fullPath+'" to "'+function(n){if("string"==typeof n)return n;if("path"in n)return n.path;var e={};return ki.forEach((function(t){t in n&&(e[t]=n[t])})),JSON.stringify(e,null,2)}(e)+'" via a navigation guard.')}function vi(n,e){return yi(n,e,bi.cancelled,'Navigation cancelled from "'+n.fullPath+'" to "'+e.fullPath+'" with a new navigation.')}function yi(n,e,t,r){var o=new Error(r);return o._isRouter=!0,o.from=n,o.to=e,o.type=t,o}var ki=["params","query","hash"];function wi(n){return Object.prototype.toString.call(n).indexOf("Error")>-1}function Si(n,e){return wi(n)&&n._isRouter&&(null==e||n.type===e)}function ji(n,e,t){var r=function(o){o>=n.length?t():n[o]?e(n[o],(function(){r(o+1)})):r(o+1)};r(0)}function Ti(n){return function(e,t,r){var o=!1,a=0,i=null;_i(n,(function(n,e,t,l){if("function"==typeof n&&void 0===n.cid){o=!0,a++;var s,c=Ii((function(e){var o;((o=e).__esModule||Ei&&"Module"===o[Symbol.toStringTag])&&(e=e.default),n.resolved="function"==typeof e?e:Ua.extend(e),t.components[l]=e,--a<=0&&r()})),d=Ii((function(n){var e="Failed to resolve async component "+l+": "+n;i||(i=wi(n)?n:new Error(e),r(i))}));try{s=n(c,d)}catch(n){d(n)}if(s)if("function"==typeof s.then)s.then(c,d);else{var u=s.component;u&&"function"==typeof u.then&&u.then(c,d)}}})),o||r()}}function _i(n,e){return Ci(n.map((function(n){return Object.keys(n.components).map((function(t){return e(n.components[t],n.instances[t],n,t)}))})))}function Ci(n){return Array.prototype.concat.apply([],n)}var Ei="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag;function Ii(n){var e=!1;return function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];if(!e)return e=!0,n.apply(this,t)}}var Ai=function(n,e){this.router=n,this.base=function(n){if(!n)if(Wa){var e=document.querySelector("base");n=(n=e&&e.getAttribute("href")||"/").replace(/^https?:\/\/[^\/]+/,"")}else n="/";"/"!==n.charAt(0)&&(n="/"+n);return n.replace(/\/$/,"")}(e),this.current=ha,this.pending=null,this.ready=!1,this.readyCbs=[],this.readyErrorCbs=[],this.errorCbs=[],this.listeners=[]};function Pi(n,e,t,r){var o=_i(n,(function(n,r,o,a){var i=function(n,e){"function"!=typeof n&&(n=Ua.extend(n));return n.options[e]}(n,e);if(i)return Array.isArray(i)?i.map((function(n){return t(n,r,o,a)})):t(i,r,o,a)}));return Ci(r?o.reverse():o)}function Li(n,e){if(e)return function(){return n.apply(e,arguments)}}Ai.prototype.listen=function(n){this.cb=n},Ai.prototype.onReady=function(n,e){this.ready?n():(this.readyCbs.push(n),e&&this.readyErrorCbs.push(e))},Ai.prototype.onError=function(n){this.errorCbs.push(n)},Ai.prototype.transitionTo=function(n,e,t){var r,o=this;try{r=this.router.match(n,this.current)}catch(n){throw this.errorCbs.forEach((function(e){e(n)})),n}var a=this.current;this.confirmTransition(r,(function(){o.updateRoute(r),e&&e(r),o.ensureURL(),o.router.afterHooks.forEach((function(n){n&&n(r,a)})),o.ready||(o.ready=!0,o.readyCbs.forEach((function(n){n(r)})))}),(function(n){t&&t(n),n&&!o.ready&&(Si(n,bi.redirected)&&a===ha||(o.ready=!0,o.readyErrorCbs.forEach((function(e){e(n)}))))}))},Ai.prototype.confirmTransition=function(n,e,t){var r=this,o=this.current;this.pending=n;var a,i,l=function(n){!Si(n)&&wi(n)&&(r.errorCbs.length?r.errorCbs.forEach((function(e){e(n)})):console.error(n)),t&&t(n)},s=n.matched.length-1,c=o.matched.length-1;if(ba(n,o)&&s===c&&n.matched[s]===o.matched[c])return this.ensureURL(),n.hash&&ai(this.router,o,n,!1),l(((i=yi(a=o,n,bi.duplicated,'Avoided redundant navigation to current location: "'+a.fullPath+'".')).name="NavigationDuplicated",i));var d=function(n,e){var t,r=Math.max(n.length,e.length);for(t=0;t<r&&n[t]===e[t];t++);return{updated:e.slice(0,t),activated:e.slice(t),deactivated:n.slice(t)}}(this.current.matched,n.matched),u=d.updated,p=d.deactivated,g=d.activated,h=[].concat(function(n){return Pi(n,"beforeRouteLeave",Li,!0)}(p),this.router.beforeHooks,function(n){return Pi(n,"beforeRouteUpdate",Li)}(u),g.map((function(n){return n.beforeEnter})),Ti(g)),f=function(e,t){if(r.pending!==n)return l(vi(o,n));try{e(n,o,(function(e){!1===e?(r.ensureURL(!0),l(function(n,e){return yi(n,e,bi.aborted,'Navigation aborted from "'+n.fullPath+'" to "'+e.fullPath+'" via a navigation guard.')}(o,n))):wi(e)?(r.ensureURL(!0),l(e)):"string"==typeof e||"object"==typeof e&&("string"==typeof e.path||"string"==typeof e.name)?(l(xi(o,n)),"object"==typeof e&&e.replace?r.replace(e):r.push(e)):t(e)}))}catch(n){l(n)}};ji(h,f,(function(){ji(function(n){return Pi(n,"beforeRouteEnter",(function(n,e,t,r){return function(n,e,t){return function(r,o,a){return n(r,o,(function(n){"function"==typeof n&&(e.enteredCbs[t]||(e.enteredCbs[t]=[]),e.enteredCbs[t].push(n)),a(n)}))}}(n,t,r)}))}(g).concat(r.router.resolveHooks),f,(function(){if(r.pending!==n)return l(vi(o,n));r.pending=null,e(n),r.router.app&&r.router.app.$nextTick((function(){va(n)}))}))}))},Ai.prototype.updateRoute=function(n){this.current=n,this.cb&&this.cb(n)},Ai.prototype.setupListeners=function(){},Ai.prototype.teardown=function(){this.listeners.forEach((function(n){n()})),this.listeners=[],this.current=ha,this.pending=null};var Ri=function(n){function e(e,t){n.call(this,e,t),this._startLocation=Bi(this.base)}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.setupListeners=function(){var n=this;if(!(this.listeners.length>0)){var e=this.router,t=e.options.scrollBehavior,r=hi&&t;r&&this.listeners.push(oi());var o=function(){var t=n.current,o=Bi(n.base);n.current===ha&&o===n._startLocation||n.transitionTo(o,(function(n){r&&ai(e,n,t,!0)}))};window.addEventListener("popstate",o),this.listeners.push((function(){window.removeEventListener("popstate",o)}))}},e.prototype.go=function(n){window.history.go(n)},e.prototype.push=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){fi(Sa(r.base+n.fullPath)),ai(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.replace=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){mi(Sa(r.base+n.fullPath)),ai(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.ensureURL=function(n){if(Bi(this.base)!==this.current.fullPath){var e=Sa(this.base+this.current.fullPath);n?fi(e):mi(e)}},e.prototype.getCurrentLocation=function(){return Bi(this.base)},e}(Ai);function Bi(n){var e=window.location.pathname,t=e.toLowerCase(),r=n.toLowerCase();return!n||t!==r&&0!==t.indexOf(Sa(r+"/"))||(e=e.slice(n.length)),(e||"/")+window.location.search+window.location.hash}var Oi=function(n){function e(e,t,r){n.call(this,e,t),r&&function(n){var e=Bi(n);if(!/^\/#/.test(e))return window.location.replace(Sa(n+"/#"+e)),!0}(this.base)||Ni()}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.setupListeners=function(){var n=this;if(!(this.listeners.length>0)){var e=this.router.options.scrollBehavior,t=hi&&e;t&&this.listeners.push(oi());var r=function(){var e=n.current;Ni()&&n.transitionTo(Mi(),(function(r){t&&ai(n.router,r,e,!0),hi||qi(r.fullPath)}))},o=hi?"popstate":"hashchange";window.addEventListener(o,r),this.listeners.push((function(){window.removeEventListener(o,r)}))}},e.prototype.push=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){Di(n.fullPath),ai(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.replace=function(n,e,t){var r=this,o=this.current;this.transitionTo(n,(function(n){qi(n.fullPath),ai(r.router,n,o,!1),e&&e(n)}),t)},e.prototype.go=function(n){window.history.go(n)},e.prototype.ensureURL=function(n){var e=this.current.fullPath;Mi()!==e&&(n?Di(e):qi(e))},e.prototype.getCurrentLocation=function(){return Mi()},e}(Ai);function Ni(){var n=Mi();return"/"===n.charAt(0)||(qi("/"+n),!1)}function Mi(){var n=window.location.href,e=n.indexOf("#");return e<0?"":n=n.slice(e+1)}function zi(n){var e=window.location.href,t=e.indexOf("#");return(t>=0?e.slice(0,t):e)+"#"+n}function Di(n){hi?fi(zi(n)):window.location.hash=n}function qi(n){hi?mi(zi(n)):window.location.replace(zi(n))}var Ji=function(n){function e(e,t){n.call(this,e,t),this.stack=[],this.index=-1}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.push=function(n,e,t){var r=this;this.transitionTo(n,(function(n){r.stack=r.stack.slice(0,r.index+1).concat(n),r.index++,e&&e(n)}),t)},e.prototype.replace=function(n,e,t){var r=this;this.transitionTo(n,(function(n){r.stack=r.stack.slice(0,r.index).concat(n),e&&e(n)}),t)},e.prototype.go=function(n){var e=this,t=this.index+n;if(!(t<0||t>=this.stack.length)){var r=this.stack[t];this.confirmTransition(r,(function(){var n=e.current;e.index=t,e.updateRoute(r),e.router.afterHooks.forEach((function(e){e&&e(r,n)}))}),(function(n){Si(n,bi.duplicated)&&(e.index=t)}))}},e.prototype.getCurrentLocation=function(){var n=this.stack[this.stack.length-1];return n?n.fullPath:"/"},e.prototype.ensureURL=function(){},e}(Ai),Fi=function(n){void 0===n&&(n={}),this.app=null,this.apps=[],this.options=n,this.beforeHooks=[],this.resolveHooks=[],this.afterHooks=[],this.matcher=Va(n.routes||[],this);var e=n.mode||"hash";switch(this.fallback="history"===e&&!hi&&!1!==n.fallback,this.fallback&&(e="hash"),Wa||(e="abstract"),this.mode=e,e){case"history":this.history=new Ri(this,n.base);break;case"hash":this.history=new Oi(this,n.base,this.fallback);break;case"abstract":this.history=new Ji(this,n.base);break;default:0}},Ui={currentRoute:{configurable:!0}};Fi.prototype.match=function(n,e,t){return this.matcher.match(n,e,t)},Ui.currentRoute.get=function(){return this.history&&this.history.current},Fi.prototype.init=function(n){var e=this;if(this.apps.push(n),n.$once("hook:destroyed",(function(){var t=e.apps.indexOf(n);t>-1&&e.apps.splice(t,1),e.app===n&&(e.app=e.apps[0]||null),e.app||e.history.teardown()})),!this.app){this.app=n;var t=this.history;if(t instanceof Ri||t instanceof Oi){var r=function(n){t.setupListeners(),function(n){var r=t.current,o=e.options.scrollBehavior;hi&&o&&"fullPath"in n&&ai(e,n,r,!1)}(n)};t.transitionTo(t.getCurrentLocation(),r,r)}t.listen((function(n){e.apps.forEach((function(e){e._route=n}))}))}},Fi.prototype.beforeEach=function(n){return Xi(this.beforeHooks,n)},Fi.prototype.beforeResolve=function(n){return Xi(this.resolveHooks,n)},Fi.prototype.afterEach=function(n){return Xi(this.afterHooks,n)},Fi.prototype.onReady=function(n,e){this.history.onReady(n,e)},Fi.prototype.onError=function(n){this.history.onError(n)},Fi.prototype.push=function(n,e,t){var r=this;if(!e&&!t&&"undefined"!=typeof Promise)return new Promise((function(e,t){r.history.push(n,e,t)}));this.history.push(n,e,t)},Fi.prototype.replace=function(n,e,t){var r=this;if(!e&&!t&&"undefined"!=typeof Promise)return new Promise((function(e,t){r.history.replace(n,e,t)}));this.history.replace(n,e,t)},Fi.prototype.go=function(n){this.history.go(n)},Fi.prototype.back=function(){this.go(-1)},Fi.prototype.forward=function(){this.go(1)},Fi.prototype.getMatchedComponents=function(n){var e=n?n.matched?n:this.resolve(n).route:this.currentRoute;return e?[].concat.apply([],e.matched.map((function(n){return Object.keys(n.components).map((function(e){return n.components[e]}))}))):[]},Fi.prototype.resolve=function(n,e,t){var r=Fa(n,e=e||this.history.current,t,this),o=this.match(r,e),a=o.redirectedFrom||o.fullPath;return{location:r,route:o,href:function(n,e,t){var r="hash"===t?"#"+e:e;return n?Sa(n+"/"+r):r}(this.history.base,a,this.mode),normalizedTo:r,resolved:o}},Fi.prototype.getRoutes=function(){return this.matcher.getRoutes()},Fi.prototype.addRoute=function(n,e){this.matcher.addRoute(n,e),this.history.current!==ha&&this.history.transitionTo(this.history.getCurrentLocation())},Fi.prototype.addRoutes=function(n){this.matcher.addRoutes(n),this.history.current!==ha&&this.history.transitionTo(this.history.getCurrentLocation())},Object.defineProperties(Fi.prototype,Ui);var Hi=Fi;function Xi(n,e){return n.push(e),function(){var t=n.indexOf(e);t>-1&&n.splice(t,1)}}Fi.install=function n(e){if(!n.installed||Ua!==e){n.installed=!0,Ua=e;var t=function(n){return void 0!==n},r=function(n,e){var r=n.$options._parentVnode;t(r)&&t(r=r.data)&&t(r=r.registerRouteInstance)&&r(n,e)};e.mixin({beforeCreate:function(){t(this.$options.router)?(this._routerRoot=this,this._router=this.$options.router,this._router.init(this),e.util.defineReactive(this,"_route",this._router.history.current)):this._routerRoot=this.$parent&&this.$parent._routerRoot||this,r(this,this)},destroyed:function(){r(this)}}),Object.defineProperty(e.prototype,"$router",{get:function(){return this._routerRoot._router}}),Object.defineProperty(e.prototype,"$route",{get:function(){return this._routerRoot._route}}),e.component("RouterView",ya),e.component("RouterLink",Xa);var o=e.config.optionMergeStrategies;o.beforeRouteEnter=o.beforeRouteLeave=o.beforeRouteUpdate=o.created}},Fi.version="3.6.5",Fi.isNavigationFailure=Si,Fi.NavigationFailureType=bi,Fi.START_LOCATION=ha,Wa&&window.Vue&&window.Vue.use(Fi);t(104);t(16),t(130);var $i={NotFound:()=>Promise.all([t.e(0),t.e(4)]).then(t.bind(null,330)),Layout:()=>Promise.all([t.e(0),t.e(2)]).then(t.bind(null,329))},Wi={"v-68ba2172":()=>t.e(5).then(t.bind(null,331)),"v-9f98b88c":()=>t.e(7).then(t.bind(null,332)),"v-eb6aaeb6":()=>t.e(6).then(t.bind(null,333)),"v-f0607dd8":()=>t.e(10).then(t.bind(null,334)),"v-062f8431":()=>t.e(11).then(t.bind(null,335)),"v-afa30cfc":()=>t.e(9).then(t.bind(null,336)),"v-e1c868da":()=>t.e(8).then(t.bind(null,337)),"v-2e7dd8a7":()=>t.e(13).then(t.bind(null,338)),"v-38cc1f4f":()=>t.e(14).then(t.bind(null,339)),"v-c8c76474":()=>t.e(17).then(t.bind(null,340)),"v-1dab0d7c":()=>t.e(15).then(t.bind(null,341)),"v-4a5e1071":()=>t.e(12).then(t.bind(null,342)),"v-6890b777":()=>t.e(19).then(t.bind(null,343)),"v-6db7c258":()=>t.e(16).then(t.bind(null,344)),"v-f8cd9c4a":()=>t.e(18).then(t.bind(null,345)),"v-1ca94746":()=>t.e(20).then(t.bind(null,346)),"v-87b51ada":()=>t.e(21).then(t.bind(null,347)),"v-0d72e0be":()=>t.e(22).then(t.bind(null,348)),"v-689aeb6e":()=>t.e(23).then(t.bind(null,349)),"v-30dbcc76":()=>t.e(24).then(t.bind(null,350)),"v-aebcce32":()=>t.e(26).then(t.bind(null,351)),"v-59982f2a":()=>t.e(27).then(t.bind(null,352)),"v-54af3d7f":()=>t.e(28).then(t.bind(null,353)),"v-5b394e2a":()=>t.e(25).then(t.bind(null,354)),"v-f080616e":()=>t.e(29).then(t.bind(null,355)),"v-e594d938":()=>t.e(30).then(t.bind(null,356)),"v-619d565d":()=>t.e(31).then(t.bind(null,357)),"v-c1afabda":()=>t.e(32).then(t.bind(null,358)),"v-62c5b9aa":()=>t.e(33).then(t.bind(null,359)),"v-04afedb8":()=>t.e(34).then(t.bind(null,360)),"v-4cfac2ae":()=>t.e(36).then(t.bind(null,361)),"v-366aefd3":()=>t.e(35).then(t.bind(null,362)),"v-11139ae4":()=>t.e(38).then(t.bind(null,363)),"v-98ff3c9c":()=>t.e(37).then(t.bind(null,364)),"v-d0b615f8":()=>t.e(39).then(t.bind(null,365)),"v-040c55f4":()=>t.e(41).then(t.bind(null,366)),"v-9062bd3c":()=>t.e(40).then(t.bind(null,367)),"v-230aad5c":()=>t.e(42).then(t.bind(null,368)),"v-b5de3650":()=>t.e(44).then(t.bind(null,369)),"v-ff4b2134":()=>t.e(43).then(t.bind(null,370)),"v-68f17928":()=>t.e(45).then(t.bind(null,371)),"v-20c514cb":()=>t.e(46).then(t.bind(null,372)),"v-ed0ea22a":()=>t.e(47).then(t.bind(null,373)),"v-218f759f":()=>t.e(48).then(t.bind(null,374)),"v-1a0380cd":()=>t.e(49).then(t.bind(null,375)),"v-2232d43f":()=>t.e(50).then(t.bind(null,376)),"v-75b72c80":()=>t.e(51).then(t.bind(null,377)),"v-64094560":()=>t.e(53).then(t.bind(null,378)),"v-49c73577":()=>t.e(52).then(t.bind(null,379)),"v-2a546378":()=>t.e(54).then(t.bind(null,380)),"v-849ebb74":()=>t.e(55).then(t.bind(null,381)),"v-18bfcd63":()=>t.e(57).then(t.bind(null,382)),"v-55669653":()=>t.e(58).then(t.bind(null,383)),"v-72a09f4a":()=>t.e(59).then(t.bind(null,384)),"v-0000769a":()=>t.e(60).then(t.bind(null,385)),"v-0112e9f6":()=>t.e(56).then(t.bind(null,386)),"v-40abcda6":()=>t.e(62).then(t.bind(null,387)),"v-7512a88a":()=>t.e(61).then(t.bind(null,388)),"v-fa2c9a0c":()=>t.e(63).then(t.bind(null,389)),"v-d47ce5a2":()=>t.e(64).then(t.bind(null,390)),"v-6f97f076":()=>t.e(65).then(t.bind(null,391)),"v-34b36bf8":()=>t.e(66).then(t.bind(null,392)),"v-c3e06076":()=>t.e(67).then(t.bind(null,393)),"v-391a0836":()=>t.e(68).then(t.bind(null,394)),"v-5f6c1111":()=>t.e(69).then(t.bind(null,395))};function Qi(n){const e=Object.create(null);return function(t){return e[t]||(e[t]=n(t))}}const Gi=/-(\w)/g,Vi=Qi(n=>n.replace(Gi,(n,e)=>e?e.toUpperCase():"")),Ki=/\B([A-Z])/g,Zi=Qi(n=>n.replace(Ki,"-$1").toLowerCase()),Yi=Qi(n=>n.charAt(0).toUpperCase()+n.slice(1));function nl(n,e){if(!e)return;if(n(e))return n(e);return e.includes("-")?n(Yi(Vi(e))):n(Yi(e))||n(Zi(e))}const el=Object.assign({},$i,Wi),tl=n=>el[n],rl=n=>Wi[n],ol=n=>$i[n],al=n=>$t.component(n);function il(n){return nl(rl,n)}function ll(n){return nl(ol,n)}function sl(n){return nl(tl,n)}function cl(n){return nl(al,n)}function dl(...n){return Promise.all(n.filter(n=>n).map(async n=>{if(!cl(n)&&sl(n)){const e=await sl(n)();$t.component(n,e.default)}}))}function ul(n,e){"undefined"!=typeof window&&window.__VUEPRESS__&&(window.__VUEPRESS__[n]=e)}var pl=t(92),gl=t.n(pl),hl=t(93),fl=t.n(hl),ml={created(){if(this.siteMeta=this.$site.headTags.filter(([n])=>"meta"===n).map(([n,e])=>e),this.$ssrContext){const e=this.getMergedMetaTags();this.$ssrContext.title=this.$title,this.$ssrContext.lang=this.$lang,this.$ssrContext.pageMeta=(n=e)?n.map(n=>{let e="<meta";return Object.keys(n).forEach(t=>{e+=` ${t}="${fl()(n[t])}"`}),e+">"}).join("\n    "):"",this.$ssrContext.canonicalLink=xl(this.$canonicalUrl)}var n},mounted(){this.currentMetaTags=[...document.querySelectorAll("meta")],this.updateMeta(),this.updateCanonicalLink()},methods:{updateMeta(){document.title=this.$title,document.documentElement.lang=this.$lang;const n=this.getMergedMetaTags();this.currentMetaTags=vl(n,this.currentMetaTags)},getMergedMetaTags(){const n=this.$page.frontmatter.meta||[];return gl()([{name:"description",content:this.$description}],n,this.siteMeta,yl)},updateCanonicalLink(){bl(),this.$canonicalUrl&&document.head.insertAdjacentHTML("beforeend",xl(this.$canonicalUrl))}},watch:{$page(){this.updateMeta(),this.updateCanonicalLink()}},beforeDestroy(){vl(null,this.currentMetaTags),bl()}};function bl(){const n=document.querySelector("link[rel='canonical']");n&&n.remove()}function xl(n=""){return n?`<link href="${n}" rel="canonical" />`:""}function vl(n,e){if(e&&[...e].filter(n=>n.parentNode===document.head).forEach(n=>document.head.removeChild(n)),n)return n.map(n=>{const e=document.createElement("meta");return Object.keys(n).forEach(t=>{e.setAttribute(t,n[t])}),document.head.appendChild(e),e})}function yl(n){for(const e of["name","property","itemprop"])if(n.hasOwnProperty(e))return n[e]+e;return JSON.stringify(n)}var kl=t(50),wl={mounted(){window.addEventListener("scroll",this.onScroll)},methods:{onScroll:t.n(kl)()((function(){this.setActiveHash()}),300),setActiveHash(){const n=[].slice.call(document.querySelectorAll(".sidebar-link")),e=[].slice.call(document.querySelectorAll(".header-anchor")).filter(e=>n.some(n=>n.hash===e.hash)),t=Math.max(window.pageYOffset,document.documentElement.scrollTop,document.body.scrollTop),r=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight),o=window.innerHeight+t;for(let n=0;n<e.length;n++){const a=e[n],i=e[n+1],l=0===n&&0===t||t>=a.parentElement.offsetTop+10&&(!i||t<i.parentElement.offsetTop-10),s=decodeURIComponent(this.$route.hash);if(l&&s!==decodeURIComponent(a.hash)){const t=a;if(o===r)for(let t=n+1;t<e.length;t++)if(s===decodeURIComponent(e[t].hash))return;return this.$vuepress.$set("disableScrollBehavior",!0),void this.$router.replace(decodeURIComponent(t.hash),()=>{this.$nextTick(()=>{this.$vuepress.$set("disableScrollBehavior",!1)})})}}}},beforeDestroy(){window.removeEventListener("scroll",this.onScroll)}},Sl=t(24),jl=t.n(Sl),Tl={mounted(){jl.a.configure({showSpinner:!1}),this.$router.beforeEach((n,e,t)=>{n.path===e.path||$t.component(n.name)||jl.a.start(),t()}),this.$router.afterEach(()=>{jl.a.done(),this.isSidebarOpen=!1})}};t(239),t(240);class _l{constructor(){this.containerEl=document.getElementById("message-container"),this.containerEl||(this.containerEl=document.createElement("div"),this.containerEl.id="message-container",document.body.appendChild(this.containerEl))}show({text:n="",duration:e=3e3}){let t=document.createElement("div");t.className="message move-in",t.innerHTML=`\n      <i style="fill: #06a35a;font-size: 14px;display:inline-flex;align-items: center;">\n        <svg style="fill: #06a35a;font-size: 14px;" t="1572421810237" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2323" width="16" height="16"><path d="M822.811993 824.617989c-83.075838 81.99224-188.546032 124.613757-316.049383 127.86455-122.085362-3.250794-223.943563-45.87231-305.935802-127.86455s-124.613757-184.21164-127.86455-305.935802c3.250794-127.503351 45.87231-232.973545 127.86455-316.049383 81.99224-83.075838 184.21164-126.058554 305.935802-129.309347 127.503351 3.250794 232.973545 46.23351 316.049383 129.309347 83.075838 83.075838 126.058554 188.546032 129.309347 316.049383C949.231746 640.406349 905.887831 742.62575 822.811993 824.617989zM432.716755 684.111464c3.973192 3.973192 8.307584 5.779189 13.364374 6.140388 5.05679 0.361199 9.752381-1.444797 13.364374-5.417989l292.571429-287.514638c3.973192-3.973192 5.779189-8.307584 5.779189-13.364374 0-5.05679-1.805996-9.752381-5.779189-13.364374l1.805996 1.805996c-3.973192-3.973192-8.668783-5.779189-14.086772-6.140388-5.417989-0.361199-10.47478 1.444797-14.809171 5.417989l-264.397884 220.33157c-3.973192 3.250794-8.668783 4.695591-14.447972 4.695591-5.779189 0-10.835979-1.444797-15.53157-3.973192l-94.273016-72.962257c-4.334392-3.250794-9.391182-4.334392-14.447972-3.973192s-9.391182 3.250794-12.641975 7.585185l-2.889594 3.973192c-3.250794 4.334392-4.334392 9.391182-3.973192 14.809171 0.722399 5.417989 2.528395 10.11358 5.779189 14.086772L432.716755 684.111464z" p-id="2324"></path></svg>\n      </i>\n      <div class="text">${n}</div>\n    `,this.containerEl.appendChild(t),e>0&&setTimeout(()=>{this.close(t)},e)}close(n){n.className=n.className.replace("move-in",""),n.className+="move-out",n.addEventListener("animationend",()=>{n.remove()})}}var Cl={mounted(){!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||this.updateCopy()},updated(){!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||this.updateCopy()},methods:{updateCopy(){setTimeout(()=>{(['div[class*="language-"] pre','div[class*="aside-code"] aside']instanceof Array||Array.isArray(['div[class*="language-"] pre','div[class*="aside-code"] aside']))&&['div[class*="language-"] pre','div[class*="aside-code"] aside'].forEach(n=>{document.querySelectorAll(n).forEach(this.generateCopyButton)})},1e3)},generateCopyButton(n){if(n.classList.contains("codecopy-enabled"))return;const e=document.createElement("i");e.className="code-copy",e.innerHTML='<svg  style="color:#aaa;font-size:14px" t="1572422231464" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3201" width="14" height="14"><path d="M866.461538 39.384615H354.461538c-43.323077 0-78.769231 35.446154-78.76923 78.769231v39.384616h472.615384c43.323077 0 78.769231 35.446154 78.769231 78.76923v551.384616h39.384615c43.323077 0 78.769231-35.446154 78.769231-78.769231V118.153846c0-43.323077-35.446154-78.769231-78.769231-78.769231z m-118.153846 275.692308c0-43.323077-35.446154-78.769231-78.76923-78.769231H157.538462c-43.323077 0-78.769231 35.446154-78.769231 78.769231v590.769231c0 43.323077 35.446154 78.769231 78.769231 78.769231h512c43.323077 0 78.769231-35.446154 78.76923-78.769231V315.076923z m-354.461538 137.846154c0 11.815385-7.876923 19.692308-19.692308 19.692308h-157.538461c-11.815385 0-19.692308-7.876923-19.692308-19.692308v-39.384615c0-11.815385 7.876923-19.692308 19.692308-19.692308h157.538461c11.815385 0 19.692308 7.876923 19.692308 19.692308v39.384615z m157.538461 315.076923c0 11.815385-7.876923 19.692308-19.692307 19.692308H216.615385c-11.815385 0-19.692308-7.876923-19.692308-19.692308v-39.384615c0-11.815385 7.876923-19.692308 19.692308-19.692308h315.076923c11.815385 0 19.692308 7.876923 19.692307 19.692308v39.384615z m78.769231-157.538462c0 11.815385-7.876923 19.692308-19.692308 19.692308H216.615385c-11.815385 0-19.692308-7.876923-19.692308-19.692308v-39.384615c0-11.815385 7.876923-19.692308 19.692308-19.692308h393.846153c11.815385 0 19.692308 7.876923 19.692308 19.692308v39.384615z" p-id="3202"></path></svg>',e.title="Copy to clipboard",e.addEventListener("click",()=>{this.copyToClipboard(n.innerText)}),n.appendChild(e),n.classList.add("codecopy-enabled")},copyToClipboard(n){const e=document.createElement("textarea");e.value=n,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e);const t=document.getSelection().rangeCount>0&&document.getSelection().getRangeAt(0);e.select(),document.execCommand("copy");(new _l).show({text:"å¤å¶æå",duration:1e3}),document.body.removeChild(e),t&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(t))}}};!function(n,e){void 0===e&&(e={});var t=e.insertAt;if(n&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===t&&r.firstChild?r.insertBefore(o,r.firstChild):r.appendChild(o),o.styleSheet?o.styleSheet.cssText=n:o.appendChild(document.createTextNode(n))}}("@media (max-width: 1000px) {\n  .vuepress-plugin-demo-block__h_code {\n    display: none;\n  }\n  .vuepress-plugin-demo-block__app {\n    margin-left: auto !important;\n    margin-right: auto !important;\n  }\n}\n.vuepress-plugin-demo-block__wrapper {\n  margin-top: 10px;\n  border: 1px solid #ebebeb;\n  border-radius: 4px;\n  transition: all 0.2s;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display {\n  height: 400px;\n  display: flex;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display .vuepress-plugin-demo-block__app {\n  width: 300px;\n  border: 1px solid #ebebeb;\n  box-shadow: 1px 1px 3px #ebebeb;\n  margin-right: 5px;\n  overflow: auto;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display .vuepress-plugin-demo-block__h_code {\n  flex: 1;\n  overflow: auto;\n  height: 100%;\n}\n.vuepress-plugin-demo-block__wrapper.vuepress-plugin-demo-block__horizontal .vuepress-plugin-demo-block__display .vuepress-plugin-demo-block__h_code > pre {\n  overflow: visible;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__display {\n  max-height: 400px;\n  overflow: auto;\n}\n.vuepress-plugin-demo-block__wrapper div {\n  box-sizing: border-box;\n}\n.vuepress-plugin-demo-block__wrapper:hover {\n  box-shadow: 0 0 11px rgba(33, 33, 33, 0.2);\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__code {\n  overflow: hidden;\n  height: 0;\n  padding: 0 !important;\n  background-color: #282c34;\n  border-radius: 0 !important;\n  transition: height 0.5s;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__code pre {\n  margin: 0 !important;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__display {\n  padding: 20px;\n  border-bottom: 1px solid #ebebeb;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer {\n  position: relative;\n  text-align: center;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer.vuepress-plugin-demo-block__show-link .vuepress-plugin-demo-block__jsfiddle,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer.vuepress-plugin-demo-block__show-link .vuepress-plugin-demo-block__codepen {\n  opacity: 1;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer.vuepress-plugin-demo-block__show-link .vuepress-plugin-demo-block__expand::before {\n  border-top: none;\n  border-right: 6px solid transparent;\n  border-bottom: 6px solid #ccc;\n  border-left: 6px solid transparent;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__jsfiddle,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__codepen,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__expand span,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__expand {\n  opacity: 1;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover .vuepress-plugin-demo-block__expand::before {\n  border-top-color: #3eaf7c !important;\n  border-bottom-color: #3eaf7c !important;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer:hover svg {\n  fill: #3eaf7c !important;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__expand-text {\n  transition: all 0.5s;\n  opacity: 0;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer form:nth-last-child(2) {\n  right: 50px;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer form:last-child {\n  right: 10px;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button {\n  border-color: transparent;\n  background-color: transparent;\n  font-size: 14px;\n  color: #3eaf7c;\n  cursor: pointer;\n  outline: none;\n  margin: 0;\n  width: 46px;\n  position: relative;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button:hover::before {\n  content: attr(data-tip);\n  white-space: nowrap;\n  position: absolute;\n  top: -30px;\n  left: 50%;\n  color: #eee;\n  line-height: 1;\n  z-index: 1000;\n  border-radius: 4px;\n  padding: 6px;\n  -webkit-transform: translateX(-50%);\n          transform: translateX(-50%);\n  background-color: rgba(0, 0, 0, 0.8);\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button:hover::after {\n  content: '' !important;\n  display: block;\n  position: absolute;\n  left: 50%;\n  top: -5px;\n  -webkit-transform: translateX(-50%);\n          transform: translateX(-50%);\n  border: 5px solid transparent;\n  border-top-color: rgba(0, 0, 0, 0.8);\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__button svg {\n  width: 34px;\n  height: 20px;\n  fill: #ccc;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__jsfiddle,\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__codepen {\n  position: absolute;\n  top: 10px;\n  transition: all 0.5s;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__expand {\n  position: relative;\n  width: 100px;\n  height: 40px;\n  margin: 0;\n  color: #3eaf7c;\n  font-size: 14px;\n  background-color: transparent;\n  border-color: transparent;\n  outline: none;\n  transition: all 0.5s;\n  cursor: pointer;\n}\n.vuepress-plugin-demo-block__wrapper .vuepress-plugin-demo-block__footer .vuepress-plugin-demo-block__expand::before {\n  content: \"\";\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 0;\n  height: 0;\n  border-top: 6px solid #ccc;\n  border-right: 6px solid transparent;\n  border-left: 6px solid transparent;\n  -webkit-transform: translate(-50%, -50%);\n          transform: translate(-50%, -50%);\n}\n");var El={jsLib:[],cssLib:[],jsfiddle:!0,codepen:!0,codepenLayout:"left",codepenJsProcessor:"babel",codepenEditors:"101",horizontal:!1,vue:"https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js",react:"https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js",reactDOM:"https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"},Il={},Al=function(n){return'<div id="app">\n'.concat(n,"\n</div>")},Pl=function(n){return window.$VUEPRESS_DEMO_BLOCK&&void 0!==window.$VUEPRESS_DEMO_BLOCK[n]?window.$VUEPRESS_DEMO_BLOCK[n]:El[n]},Ll=function n(e,t,r){var o=document.createElement(e);return t&&Object.keys(t).forEach((function(n){if(n.indexOf("data"))o[n]=t[n];else{var e=n.replace("data","");o.dataset[e]=t[n]}})),r&&r.forEach((function(e){var t=e.tag,r=e.attrs,a=e.children;o.appendChild(n(t,r,a))})),o},Rl=function(n,e,t){var r,o=(r=n.querySelectorAll(".".concat(e)),Array.prototype.slice.call(r));return 1!==o.length||t?o:o[0]},Bl=function(n,e){var t,r,o=n.match(/<style>([\s\S]+)<\/style>/),a=n.match(/<template>([\s\S]+)<\/template>/),i=n.match(/<script>([\s\S]+)<\/script>/),l={css:o&&o[1].replace(/^\n|\n$/g,""),html:a&&a[1].replace(/^\n|\n$/g,""),js:i&&i[1].replace(/^\n|\n$/g,""),jsLib:e.jsLib||[],cssLib:e.cssLib||[]};l.htmlTpl=Al(l.html),l.jsTpl=(t=l.js,r=t.replace(/export\s+default\s*?\{\n*/,"").replace(/\n*\}\s*$/,"").trim(),"new Vue({\n  el: '#app',\n  ".concat(r,"\n})")),l.script=function(n,e){var t=n.split(/export\s+default/),r="(function() {".concat(t[0]," ; return ").concat(t[1],"})()"),o=window.Babel?window.Babel.transform(r,{presets:["es2015"]}).code:r,a=[eval][0](o);return a.template=e,a}(l.js,l.html);var s=Pl("vue");return l.jsLib.unshift(s),l},Ol=function(n,e){var t,r=n.match(/<style>([\s\S]+)<\/style>/),o=n.match(/<html>([\s\S]+)<\/html>/),a=n.match(/<script>([\s\S]+)<\/script>/),i={css:r&&r[1].replace(/^\n|\n$/g,""),html:o&&o[1].replace(/^\n|\n$/g,""),js:a&&a[1].replace(/^\n|\n$/g,""),jsLib:e.jsLib||[],cssLib:e.cssLib||[]};return i.htmlTpl=i.html,i.jsTpl=i.js,i.script=(t=i.js,window.Babel?window.Babel.transform(t,{presets:["es2015"]}).code:t),i},Nl=function(n){return n=n.replace("export default ","").replace(/App\.__style__(\s*)=(\s*)`([\s\S]*)?`/,""),n+='ReactDOM.render(React.createElement(App), document.getElementById("app"))'};function Ml(){var n=Rl(document,"vuepress-plugin-demo-block__wrapper",!0);n.length?n.forEach((function(n){if("true"!==n.dataset.created){n.style.display="block";var e=Rl(n,"vuepress-plugin-demo-block__code"),t=Rl(n,"vuepress-plugin-demo-block__display"),r=Rl(n,"vuepress-plugin-demo-block__footer"),o=Rl(t,"vuepress-plugin-demo-block__app"),a=decodeURIComponent(n.dataset.code),i=decodeURIComponent(n.dataset.config),l=decodeURIComponent(n.dataset.type);i=i?JSON.parse(i):{};var s=e.querySelector("div").clientHeight,c="react"===l?function(n,e){var t=(0,window.Babel.transform)(n,{presets:["es2015","react"]}).code,r="(function(exports){var module={};module.exports=exports;".concat(t,";return module.exports.__esModule?module.exports.default:module.exports;})({})"),o=new Function("return ".concat(r))(),a={js:o,css:o.__style__||"",jsLib:e.jsLib||[],cssLib:e.cssLib||[],jsTpl:Nl(n),htmlTpl:Al("")},i=Pl("react"),l=Pl("reactDOM");return a.jsLib.unshift(i,l),a}(a,i):"vanilla"===l?Ol(a,i):Bl(a,i),d=Ll("button",{className:"".concat("vuepress-plugin-demo-block__expand")});if(r.appendChild(d),d.addEventListener("click",zl.bind(null,d,s,e,r)),Pl("jsfiddle")&&r.appendChild(function(n){var e=n.css,t=n.htmlTpl,r=n.jsTpl,o=n.jsLib,a=n.cssLib,i=o.concat(a).concat(Pl("cssLib")).concat(Pl("jsLib")).join(",");return Ll("form",{className:"vuepress-plugin-demo-block__jsfiddle",target:"_blank",action:"https://jsfiddle.net/api/post/library/pure/",method:"post"},[{tag:"input",attrs:{type:"hidden",name:"css",value:e}},{tag:"input",attrs:{type:"hidden",name:"html",value:t}},{tag:"input",attrs:{type:"hidden",name:"js",value:r}},{tag:"input",attrs:{type:"hidden",name:"panel_js",value:3}},{tag:"input",attrs:{type:"hidden",name:"wrap",value:1}},{tag:"input",attrs:{type:"hidden",name:"resources",value:i}},{tag:"button",attrs:{type:"submit",className:"vuepress-plugin-demo-block__button",innerHTML:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1547088289967" class="icon" style="" viewBox="0 0 1170 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1952" xmlns:xlink="http://www.w3.org/1999/xlink" width="228.515625" height="200"><defs><style type="text/css"></style></defs><path d="M1028.571429 441.142857q63.428571 26.285714 102.571428 83.142857T1170.285714 650.857143q0 93.714286-67.428571 160.285714T940 877.714286q-2.285714 0-6.571429-0.285715t-6-0.285714H232q-97.142857-5.714286-164.571429-71.714286T0 645.142857q0-62.857143 31.428571-116t84-84q-6.857143-22.285714-6.857142-46.857143 0-65.714286 46.857142-112t113.714286-46.285714q54.285714 0 98.285714 33.142857 42.857143-88 127.142858-141.714286t186.571428-53.714285q94.857143 0 174.857143 46T982.571429 248.571429t46.571428 172q0 3.428571-0.285714 10.285714t-0.285714 10.285714zM267.428571 593.142857q0 69.714286 48 110.285714t118.857143 40.571429q78.285714 0 137.142857-56.571429-9.142857-11.428571-27.142857-32.285714T519.428571 626.285714q-38.285714 37.142857-82.285714 37.142857-31.428571 0-53.428571-19.142857T361.714286 594.285714q0-30.285714 22-49.714285t52.285714-19.428572q25.142857 0 48.285714 12t41.714286 31.428572 37.142857 42.857142 39.428572 46.857143 44 42.857143 55.428571 31.428572 69.428571 12q69.142857 0 116.857143-40.857143T936 594.857143q0-69.142857-48-109.714286t-118.285714-40.571428q-81.714286 0-137.714286 55.428571l53.142857 61.714286q37.714286-36.571429 81.142857-36.571429 29.714286 0 52.571429 18.857143t22.857143 48q0 32.571429-21.142857 52.285714t-53.714286 19.714286q-24.571429 0-47.142857-12t-41.142857-31.428571-37.428572-42.857143-39.714286-46.857143-44.285714-42.857143-55.142857-31.428571T434.285714 444.571429q-69.714286 0-118.285714 40.285714T267.428571 593.142857z" p-id="1953"></path></svg>',datatip:"JSFiddle"}}])}(c)),Pl("codepen")&&r.appendChild(function(n){var e=n.css,t=n.htmlTpl,r=n.jsTpl,o=n.jsLib,a=n.cssLib,i=JSON.stringify({css:e,html:t,js:r,js_external:o.concat(Pl("jsLib")).join(";"),css_external:a.concat(Pl("cssLib")).join(";"),layout:Pl("codepenLayout"),js_pre_processor:Pl("codepenJsProcessor"),editors:Pl("codepenEditors")});return Ll("form",{className:"vuepress-plugin-demo-block__codepen",target:"_blank",action:"https://codepen.io/pen/define",method:"post"},[{tag:"input",attrs:{type:"hidden",name:"data",value:i}},{tag:"button",attrs:{type:"submit",innerHTML:'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1547088271207" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1737" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M123.428571 668l344.571429 229.714286v-205.142857L277.142857 565.142857z m-35.428571-82.285714l110.285714-73.714286-110.285714-73.714286v147.428572z m468 312l344.571429-229.714286-153.714286-102.857143-190.857143 127.428572v205.142857z m-44-281.714286l155.428571-104-155.428571-104-155.428571 104zM277.142857 458.857143l190.857143-127.428572V126.285714L123.428571 356z m548.571429 53.142857l110.285714 73.714286V438.285714z m-78.857143-53.142857l153.714286-102.857143-344.571429-229.714286v205.142857z m277.142857-102.857143v312q0 23.428571-19.428571 36.571429l-468 312q-12 7.428571-24.571429 7.428571t-24.571429-7.428571L19.428571 704.571429q-19.428571-13.142857-19.428571-36.571429V356q0-23.428571 19.428571-36.571429L487.428571 7.428571q12-7.428571 24.571429-7.428571t24.571429 7.428571l468 312q19.428571 13.142857 19.428571 36.571429z" p-id="1738"></path></svg>',className:"vuepress-plugin-demo-block__button",datatip:"Codepen"}}])}(c)),void 0!==i.horizontal?i.horizontal:Pl("horizontal")){n.classList.add("vuepress-plugin-demo-block__horizontal");var u=e.firstChild.cloneNode(!0);u.classList.add("vuepress-plugin-demo-block__h_code"),t.appendChild(u)}if(c.css&&function(n){if(!Il[n]){var e=Ll("style",{innerHTML:n});document.body.appendChild(e),Il[n]=!0}}(c.css),"react"===l)ReactDOM.render(React.createElement(c.js),o);else if("vue"===l){var p=(new(Vue.extend(c.script))).$mount();o.appendChild(p.$el)}else"vanilla"===l&&(o.innerHTML=c.html,new Function("return (function(){".concat(c.script,"})()"))());n.dataset.created="true"}})):setTimeout((function(n){Ml()}),300)}function zl(n,e,t,r){var o="1"!==n.dataset.isExpand;t.style.height=o?"".concat(e,"px"):0,o?r.classList.add("vuepress-plugin-demo-block__show-link"):r.classList.remove("vuepress-plugin-demo-block__show-link"),n.dataset.isExpand=o?"1":"0"}var Dl={mounted:function(){window.$VUEPRESS_DEMO_BLOCK={jsfiddle:!1,codepen:!0,horizontal:!1},Ml()},updated:function(){Ml()}},ql="auto",Jl="zoom-in",Fl="zoom-out",Ul="grab",Hl="move";function Xl(n,e,t){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o={passive:!1};r?n.addEventListener(e,t,o):n.removeEventListener(e,t,o)}function $l(n,e){if(n){var t=new Image;t.onload=function(){e&&e(t)},t.src=n}}function Wl(n){return n.dataset.original?n.dataset.original:"A"===n.parentNode.tagName?n.parentNode.getAttribute("href"):null}function Ql(n,e,t){!function(n){var e=Gl,t=Vl;if(n.transition){var r=n.transition;delete n.transition,n[e]=r}if(n.transform){var o=n.transform;delete n.transform,n[t]=o}}(e);var r=n.style,o={};for(var a in e)t&&(o[a]=r[a]||""),r[a]=e[a];return o}var Gl="transition",Vl="transform",Kl="transform",Zl="transitionend";var Yl=function(){},ns={enableGrab:!0,preloadImage:!1,closeOnWindowResize:!0,transitionDuration:.4,transitionTimingFunction:"cubic-bezier(0.4, 0, 0, 1)",bgColor:"rgb(255, 255, 255)",bgOpacity:1,scaleBase:1,scaleExtra:.5,scrollThreshold:40,zIndex:998,customSize:null,onOpen:Yl,onClose:Yl,onGrab:Yl,onMove:Yl,onRelease:Yl,onBeforeOpen:Yl,onBeforeClose:Yl,onBeforeGrab:Yl,onBeforeRelease:Yl,onImageLoading:Yl,onImageLoaded:Yl},es={init:function(n){var e,t;e=this,t=n,Object.getOwnPropertyNames(Object.getPrototypeOf(e)).forEach((function(n){e[n]=e[n].bind(t)}))},click:function(n){if(n.preventDefault(),rs(n))return window.open(this.target.srcOriginal||n.currentTarget.src,"_blank");this.shown?this.released?this.close():this.release():this.open(n.currentTarget)},scroll:function(){var n=document.documentElement||document.body.parentNode||document.body,e=window.pageXOffset||n.scrollLeft,t=window.pageYOffset||n.scrollTop;null===this.lastScrollPosition&&(this.lastScrollPosition={x:e,y:t});var r=this.lastScrollPosition.x-e,o=this.lastScrollPosition.y-t,a=this.options.scrollThreshold;(Math.abs(o)>=a||Math.abs(r)>=a)&&(this.lastScrollPosition=null,this.close())},keydown:function(n){(function(n){return"Escape"===(n.key||n.code)||27===n.keyCode})(n)&&(this.released?this.close():this.release(this.close))},mousedown:function(n){if(ts(n)&&!rs(n)){n.preventDefault();var e=n.clientX,t=n.clientY;this.pressTimer=setTimeout(function(){this.grab(e,t)}.bind(this),200)}},mousemove:function(n){this.released||this.move(n.clientX,n.clientY)},mouseup:function(n){ts(n)&&!rs(n)&&(clearTimeout(this.pressTimer),this.released?this.close():this.release())},touchstart:function(n){n.preventDefault();var e=n.touches[0],t=e.clientX,r=e.clientY;this.pressTimer=setTimeout(function(){this.grab(t,r)}.bind(this),200)},touchmove:function(n){if(!this.released){var e=n.touches[0],t=e.clientX,r=e.clientY;this.move(t,r)}},touchend:function(n){(function(n){n.targetTouches.length})(n)||(clearTimeout(this.pressTimer),this.released?this.close():this.release())},clickOverlay:function(){this.close()},resizeWindow:function(){this.close()}};function ts(n){return 0===n.button}function rs(n){return n.metaKey||n.ctrlKey}var os={init:function(n){this.el=document.createElement("div"),this.instance=n,this.parent=document.body,Ql(this.el,{position:"fixed",top:0,left:0,right:0,bottom:0,opacity:0}),this.updateStyle(n.options),Xl(this.el,"click",n.handler.clickOverlay.bind(n))},updateStyle:function(n){Ql(this.el,{zIndex:n.zIndex,backgroundColor:n.bgColor,transition:"opacity\n        "+n.transitionDuration+"s\n        "+n.transitionTimingFunction})},insert:function(){this.parent.appendChild(this.el)},remove:function(){this.parent.removeChild(this.el)},fadeIn:function(){this.el.offsetWidth,this.el.style.opacity=this.instance.options.bgOpacity},fadeOut:function(){this.el.style.opacity=0}},as="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},is=function(){function n(n,e){for(var t=0;t<e.length;t++){var r=e[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),ls=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},ss={init:function(n,e){this.el=n,this.instance=e,this.srcThumbnail=this.el.getAttribute("src"),this.srcset=this.el.getAttribute("srcset"),this.srcOriginal=Wl(this.el),this.rect=this.el.getBoundingClientRect(),this.translate=null,this.scale=null,this.styleOpen=null,this.styleClose=null},zoomIn:function(){var n=this.instance.options,e=n.zIndex,t=n.enableGrab,r=n.transitionDuration,o=n.transitionTimingFunction;this.translate=this.calculateTranslate(),this.scale=this.calculateScale(),this.styleOpen={position:"relative",zIndex:e+1,cursor:t?Ul:Fl,transition:Kl+"\n        "+r+"s\n        "+o,transform:"translate3d("+this.translate.x+"px, "+this.translate.y+"px, 0px)\n        scale("+this.scale.x+","+this.scale.y+")",height:this.rect.height+"px",width:this.rect.width+"px"},this.el.offsetWidth,this.styleClose=Ql(this.el,this.styleOpen,!0)},zoomOut:function(){this.el.offsetWidth,Ql(this.el,{transform:"none"})},grab:function(n,e,t){var r=cs(),o=r.x-n,a=r.y-e;Ql(this.el,{cursor:Hl,transform:"translate3d(\n        "+(this.translate.x+o)+"px, "+(this.translate.y+a)+"px, 0px)\n        scale("+(this.scale.x+t)+","+(this.scale.y+t)+")"})},move:function(n,e,t){var r=cs(),o=r.x-n,a=r.y-e;Ql(this.el,{transition:Kl,transform:"translate3d(\n        "+(this.translate.x+o)+"px, "+(this.translate.y+a)+"px, 0px)\n        scale("+(this.scale.x+t)+","+(this.scale.y+t)+")"})},restoreCloseStyle:function(){Ql(this.el,this.styleClose)},restoreOpenStyle:function(){Ql(this.el,this.styleOpen)},upgradeSource:function(){if(this.srcOriginal){var n=this.el.parentNode;this.srcset&&this.el.removeAttribute("srcset");var e=this.el.cloneNode(!1);e.setAttribute("src",this.srcOriginal),e.style.position="fixed",e.style.visibility="hidden",n.appendChild(e),setTimeout(function(){this.el.setAttribute("src",this.srcOriginal),n.removeChild(e)}.bind(this),50)}},downgradeSource:function(){this.srcOriginal&&(this.srcset&&this.el.setAttribute("srcset",this.srcset),this.el.setAttribute("src",this.srcThumbnail))},calculateTranslate:function(){var n=cs(),e=this.rect.left+this.rect.width/2,t=this.rect.top+this.rect.height/2;return{x:n.x-e,y:n.y-t}},calculateScale:function(){var n=this.el.dataset,e=n.zoomingHeight,t=n.zoomingWidth,r=this.instance.options,o=r.customSize,a=r.scaleBase;if(!o&&e&&t)return{x:t/this.rect.width,y:e/this.rect.height};if(o&&"object"===(void 0===o?"undefined":as(o)))return{x:o.width/this.rect.width,y:o.height/this.rect.height};var i=this.rect.width/2,l=this.rect.height/2,s=cs(),c={x:s.x-i,y:s.y-l},d=c.x/i,u=c.y/l,p=a+Math.min(d,u);if(o&&"string"==typeof o){var g=t||this.el.naturalWidth,h=e||this.el.naturalHeight,f=parseFloat(o)*g/(100*this.rect.width),m=parseFloat(o)*h/(100*this.rect.height);if(p>f||p>m)return{x:f,y:m}}return{x:p,y:p}}};function cs(){var n=document.documentElement;return{x:Math.min(n.clientWidth,window.innerWidth)/2,y:Math.min(n.clientHeight,window.innerHeight)/2}}function ds(n,e,t){["mousedown","mousemove","mouseup","touchstart","touchmove","touchend"].forEach((function(r){Xl(n,r,e[r],t)}))}var us=function(){function n(e){!function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.target=Object.create(ss),this.overlay=Object.create(os),this.handler=Object.create(es),this.body=document.body,this.shown=!1,this.lock=!1,this.released=!0,this.lastScrollPosition=null,this.pressTimer=null,this.options=ls({},ns,e),this.overlay.init(this),this.handler.init(this)}return is(n,[{key:"listen",value:function(n){if("string"==typeof n)for(var e=document.querySelectorAll(n),t=e.length;t--;)this.listen(e[t]);else"IMG"===n.tagName&&(n.style.cursor=Jl,Xl(n,"click",this.handler.click),this.options.preloadImage&&$l(Wl(n)));return this}},{key:"config",value:function(n){return n?(ls(this.options,n),this.overlay.updateStyle(this.options),this):this.options}},{key:"open",value:function(n){var e=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.onOpen;if(!this.shown&&!this.lock){var r="string"==typeof n?document.querySelector(n):n;if("IMG"===r.tagName){if(this.options.onBeforeOpen(r),this.target.init(r,this),!this.options.preloadImage){var o=this.target.srcOriginal;null!=o&&(this.options.onImageLoading(r),$l(o,this.options.onImageLoaded))}this.shown=!0,this.lock=!0,this.target.zoomIn(),this.overlay.insert(),this.overlay.fadeIn(),Xl(document,"scroll",this.handler.scroll),Xl(document,"keydown",this.handler.keydown),this.options.closeOnWindowResize&&Xl(window,"resize",this.handler.resizeWindow);var a=function n(){Xl(r,Zl,n,!1),e.lock=!1,e.target.upgradeSource(),e.options.enableGrab&&ds(document,e.handler,!0),t(r)};return Xl(r,Zl,a),this}}}},{key:"close",value:function(){var n=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.options.onClose;if(this.shown&&!this.lock){var t=this.target.el;this.options.onBeforeClose(t),this.lock=!0,this.body.style.cursor=ql,this.overlay.fadeOut(),this.target.zoomOut(),Xl(document,"scroll",this.handler.scroll,!1),Xl(document,"keydown",this.handler.keydown,!1),this.options.closeOnWindowResize&&Xl(window,"resize",this.handler.resizeWindow,!1);var r=function r(){Xl(t,Zl,r,!1),n.shown=!1,n.lock=!1,n.target.downgradeSource(),n.options.enableGrab&&ds(document,n.handler,!1),n.target.restoreCloseStyle(),n.overlay.remove(),e(t)};return Xl(t,Zl,r),this}}},{key:"grab",value:function(n,e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.scaleExtra,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.options.onGrab;if(this.shown&&!this.lock){var o=this.target.el;this.options.onBeforeGrab(o),this.released=!1,this.target.grab(n,e,t);var a=function n(){Xl(o,Zl,n,!1),r(o)};return Xl(o,Zl,a),this}}},{key:"move",value:function(n,e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.scaleExtra,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.options.onMove;if(this.shown&&!this.lock){this.released=!1,this.body.style.cursor=Hl,this.target.move(n,e,t);var o=this.target.el,a=function n(){Xl(o,Zl,n,!1),r(o)};return Xl(o,Zl,a),this}}},{key:"release",value:function(){var n=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.options.onRelease;if(this.shown&&!this.lock){var t=this.target.el;this.options.onBeforeRelease(t),this.lock=!0,this.body.style.cursor=ql,this.target.restoreOpenStyle();var r=function r(){Xl(t,Zl,r,!1),n.lock=!1,n.released=!0,e(t)};return Xl(t,Zl,r),this}}}]),n}();const ps=JSON.parse('{"bgColor":"rgba(0,0,0,0.6)"}'),gs=Number("500");class hs{constructor(){this.instance=new us(ps)}update(n=".theme-vdoing-content img:not(.no-zoom)"){"undefined"!=typeof window&&this.instance.listen(n)}updateDelay(n=".theme-vdoing-content img:not(.no-zoom)",e=gs){setTimeout(()=>this.update(n),e)}}var fs=[ml,wl,Tl,Cl,Dl,{watch:{"$page.path"(){void 0!==this.$vuepress.zooming&&this.$vuepress.zooming.updateDelay()}},mounted(){this.$vuepress.zooming=new hs,this.$vuepress.zooming.updateDelay()}}],ms={name:"GlobalLayout",computed:{layout(){const n=this.getLayout();return ul("layout",n),$t.component(n)}},methods:{getLayout(){if(this.$page.path){const n=this.$page.frontmatter.layout;return n&&(this.$vuepress.getLayoutAsyncComponent(n)||this.$vuepress.getVueComponent(n))?n:"Layout"}return"NotFound"}}},bs=t(7),xs=Object(bs.a)(ms,(function(){return(0,this._self._c)(this.layout,{tag:"component"})}),[],!1,null,null,null).exports;!function(n,e,t){switch(e){case"components":n[e]||(n[e]={}),Object.assign(n[e],t);break;case"mixins":n[e]||(n[e]=[]),n[e].push(...t);break;default:throw new Error("Unknown option name.")}}(xs,"mixins",fs);const vs=[{name:"v-68ba2172",path:"/pages/259a4b/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-68ba2172").then(t)}},{path:"/pages/259a4b/index.html",redirect:"/pages/259a4b/"},{path:"/02.æç« /00.è¯´æ.html",redirect:"/pages/259a4b/"},{name:"v-9f98b88c",path:"/pages/a5b563/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-9f98b88c").then(t)}},{path:"/pages/a5b563/index.html",redirect:"/pages/a5b563/"},{path:"/02.æç« /01.Javaåºç¡/1000.Javaå¯¹äºé¶æ·è´çå®ç°.html",redirect:"/pages/a5b563/"},{name:"v-eb6aaeb6",path:"/pages/5c396f/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-eb6aaeb6").then(t)}},{path:"/pages/5c396f/index.html",redirect:"/pages/5c396f/"},{path:"/02.æç« /01.Javaåºç¡/100.Java NIO.html",redirect:"/pages/5c396f/"},{name:"v-f0607dd8",path:"/pages/493ffc/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-f0607dd8").then(t)}},{path:"/pages/493ffc/index.html",redirect:"/pages/493ffc/"},{path:"/02.æç« /02.MySQL/01.InnoDB - è¡æ ¼å¼.html",redirect:"/pages/493ffc/"},{name:"v-062f8431",path:"/pages/b3086d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-062f8431").then(t)}},{path:"/pages/b3086d/index.html",redirect:"/pages/b3086d/"},{path:"/02.æç« /02.MySQL/05.InnoDB - é¡µç»æ.html",redirect:"/pages/b3086d/"},{name:"v-afa30cfc",path:"/pages/d8c9ba/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-afa30cfc").then(t)}},{path:"/pages/d8c9ba/index.html",redirect:"/pages/d8c9ba/"},{path:"/02.æç« /01.Javaåºç¡/300.åæºå®æ¶ä»»å¡çå®ç°.html",redirect:"/pages/d8c9ba/"},{name:"v-e1c868da",path:"/pages/0c2518/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-e1c868da").then(t)}},{path:"/pages/0c2518/index.html",redirect:"/pages/0c2518/"},{path:"/02.æç« /01.Javaåºç¡/150.Reactoræ¨¡å¼.html",redirect:"/pages/0c2518/"},{name:"v-2e7dd8a7",path:"/pages/495592/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-2e7dd8a7").then(t)}},{path:"/pages/495592/index.html",redirect:"/pages/495592/"},{path:"/02.æç« /02.MySQL/15.InnoDB - redo log å undo log.html",redirect:"/pages/495592/"},{name:"v-38cc1f4f",path:"/pages/31e077/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-38cc1f4f").then(t)}},{path:"/pages/31e077/index.html",redirect:"/pages/31e077/"},{path:"/02.æç« /02.MySQL/17.InnoDB - Buffer Pool.html",redirect:"/pages/31e077/"},{name:"v-c8c76474",path:"/pages/4e0b96/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-c8c76474").then(t)}},{path:"/pages/4e0b96/index.html",redirect:"/pages/4e0b96/"},{path:"/02.æç« /10.Redis/20.Redis æä¹åæºå¶.html",redirect:"/pages/4e0b96/"},{name:"v-1dab0d7c",path:"/pages/2e3013/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-1dab0d7c").then(t)}},{path:"/pages/2e3013/index.html",redirect:"/pages/2e3013/"},{path:"/02.æç« /02.MySQL/20.InnoDB - é.html",redirect:"/pages/2e3013/"},{name:"v-4a5e1071",path:"/pages/26e2d2/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-4a5e1071").then(t)}},{path:"/pages/26e2d2/index.html",redirect:"/pages/26e2d2/"},{path:"/02.æç« /02.MySQL/10.InnoDB - B+æ ç´¢å¼.html",redirect:"/pages/26e2d2/"},{name:"v-6890b777",path:"/pages/db45e7/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-6890b777").then(t)}},{path:"/pages/db45e7/index.html",redirect:"/pages/db45e7/"},{path:"/02.æç« /10.Redis/40.Redisä¸»ä»éç¾¤åç.html",redirect:"/pages/db45e7/"},{name:"v-6db7c258",path:"/pages/77c4c7/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-6db7c258").then(t)}},{path:"/pages/77c4c7/index.html",redirect:"/pages/77c4c7/"},{path:"/02.æç« /10.Redis/10.Redisæ°æ®ç»æä¸æ°æ®ç±»å.html",redirect:"/pages/77c4c7/"},{name:"v-f8cd9c4a",path:"/pages/73749d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-f8cd9c4a").then(t)}},{path:"/pages/73749d/index.html",redirect:"/pages/73749d/"},{path:"/02.æç« /10.Redis/30.Redisåå­åæ¶.html",redirect:"/pages/73749d/"},{name:"v-1ca94746",path:"/pages/3743cc/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-1ca94746").then(t)}},{path:"/pages/3743cc/index.html",redirect:"/pages/3743cc/"},{path:"/02.æç« /10.Redis/50.Rediså¨åµéç¾¤.html",redirect:"/pages/3743cc/"},{name:"v-87b51ada",path:"/pages/70ea3d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-87b51ada").then(t)}},{path:"/pages/70ea3d/index.html",redirect:"/pages/70ea3d/"},{path:"/02.æç« /100.å¶ä»/100.å¸¸ç¨å·¥å·ç±».html",redirect:"/pages/70ea3d/"},{name:"v-0d72e0be",path:"/pages/7ca562/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-0d72e0be").then(t)}},{path:"/pages/7ca562/index.html",redirect:"/pages/7ca562/"},{path:"/02.æç« /100.å¶ä»/1000.Javaå­¦ä¹ è·¯çº¿.html",redirect:"/pages/7ca562/"},{name:"v-689aeb6e",path:"/pages/ad5a8e/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-689aeb6e").then(t)}},{path:"/pages/ad5a8e/index.html",redirect:"/pages/ad5a8e/"},{path:"/02.æç« /100.å¶ä»/5.å¦ä½å°IPå°åå­å¥MySQL.html",redirect:"/pages/ad5a8e/"},{name:"v-30dbcc76",path:"/pages/f63fe9/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-30dbcc76").then(t)}},{path:"/pages/f63fe9/index.html",redirect:"/pages/f63fe9/"},{path:"/02.æç« /1000.å®ä¹ å°ç»/1.Gitè¸©å.html",redirect:"/pages/f63fe9/"},{name:"v-aebcce32",path:"/pages/65cd6f/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-aebcce32").then(t)}},{path:"/pages/65cd6f/index.html",redirect:"/pages/65cd6f/"},{path:"/02.æç« /200.è¸©å/10.xxl job Access token is wrong.html",redirect:"/pages/65cd6f/"},{name:"v-59982f2a",path:"/pages/3cac9b/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-59982f2a").then(t)}},{path:"/pages/3cac9b/index.html",redirect:"/pages/3cac9b/"},{path:"/02.æç« /200.è¸©å/20.å½éåæ¶éè¦è¿åç»åç«¯ä¸æ®µjsonï¼jsonå·¥å·ä¸åç»ææ¥é.html",redirect:"/pages/3cac9b/"},{name:"v-54af3d7f",path:"/pages/0e629c/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-54af3d7f").then(t)}},{path:"/pages/0e629c/index.html",redirect:"/pages/0e629c/"},{path:"/02.æç« /200.è¸©å/30.mpä½¿ç¨@TableFieldæ³¨è§£æªçæåèæ¥é.html",redirect:"/pages/0e629c/"},{name:"v-5b394e2a",path:"/pages/99f624/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-5b394e2a").then(t)}},{path:"/pages/99f624/index.html",redirect:"/pages/99f624/"},{path:"/02.æç« /1000.å®ä¹ å°ç»/150.å¼åè§è.html",redirect:"/pages/99f624/"},{name:"v-f080616e",path:"/pages/e96a9e/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-f080616e").then(t)}},{path:"/pages/e96a9e/index.html",redirect:"/pages/e96a9e/"},{path:"/02.æç« /200.è¸©å/40.ä½¿ç¨@Validatedæ³¨è§£è¿è¡åæ°æ ¡éªæ¶æ¥éï¼UnexpectedTypeException.html",redirect:"/pages/e96a9e/"},{name:"v-e594d938",path:"/pages/4e379b/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-e594d938").then(t)}},{path:"/pages/4e379b/index.html",redirect:"/pages/4e379b/"},{path:"/02.æç« /200.è¸©å/50.connection.setReadTimeout.html",redirect:"/pages/4e379b/"},{name:"v-619d565d",path:"/pages/c6965c/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-619d565d").then(t)}},{path:"/pages/c6965c/index.html",redirect:"/pages/c6965c/"},{path:"/02.æç« /60.æä½ç³»ç»/10.ç¨æ·æååæ ¸æ.html",redirect:"/pages/c6965c/"},{name:"v-c1afabda",path:"/pages/dbd03e/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-c1afabda").then(t)}},{path:"/pages/dbd03e/index.html",redirect:"/pages/dbd03e/"},{path:"/02.æç« /60.æä½ç³»ç»/110.é¶æ·è´.html",redirect:"/pages/dbd03e/"},{name:"v-62c5b9aa",path:"/pages/ee38bc/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-62c5b9aa").then(t)}},{path:"/pages/ee38bc/index.html",redirect:"/pages/ee38bc/"},{path:"/02.æç« /60.æä½ç³»ç»/20.ç¼å­ä¸è´æ§åè®®ï¼MESI.html",redirect:"/pages/ee38bc/"},{name:"v-04afedb8",path:"/pages/424c75/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-04afedb8").then(t)}},{path:"/pages/424c75/index.html",redirect:"/pages/424c75/"},{path:"/02.æç« /70.è®¡ç®æºç½ç»/10.TCPãUDPåè®®.html",redirect:"/pages/424c75/"},{name:"v-4cfac2ae",path:"/pages/0776e3/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-4cfac2ae").then(t)}},{path:"/pages/0776e3/index.html",redirect:"/pages/0776e3/"},{path:"/02.æç« /75.Javaå¹¶å/100.åå­ç±».html",redirect:"/pages/0776e3/"},{name:"v-366aefd3",path:"/pages/71bea1/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-366aefd3").then(t)}},{path:"/pages/71bea1/index.html",redirect:"/pages/71bea1/"},{path:"/02.æç« /70.è®¡ç®æºç½ç»/4.è®¡ç®æºç½ç»äºå±ç½ç»æ¨¡å.html",redirect:"/pages/71bea1/"},{name:"v-11139ae4",path:"/pages/c1826d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-11139ae4").then(t)}},{path:"/pages/c1826d/index.html",redirect:"/pages/c1826d/"},{path:"/02.æç« /75.Javaå¹¶å/250.FutureTaskä¸­çééå¨æ¨¡å¼.html",redirect:"/pages/c1826d/"},{name:"v-98ff3c9c",path:"/pages/937dd3/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-98ff3c9c").then(t)}},{path:"/pages/937dd3/index.html",redirect:"/pages/937dd3/"},{path:"/02.æç« /75.Javaå¹¶å/200.FutureTaskæºç è§£æ.html",redirect:"/pages/937dd3/"},{name:"v-d0b615f8",path:"/pages/671511/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-d0b615f8").then(t)}},{path:"/pages/671511/index.html",redirect:"/pages/671511/"},{path:"/02.æç« /75.Javaå¹¶å/300.çº¿ç¨æ± .html",redirect:"/pages/671511/"},{name:"v-040c55f4",path:"/pages/56d8fa/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-040c55f4").then(t)}},{path:"/pages/56d8fa/index.html",redirect:"/pages/56d8fa/"},{path:"/02.æç« /75.Javaå¹¶å/50.CAS.html",redirect:"/pages/56d8fa/"},{name:"v-9062bd3c",path:"/pages/79cb1d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-9062bd3c").then(t)}},{path:"/pages/79cb1d/index.html",redirect:"/pages/79cb1d/"},{path:"/02.æç« /75.Javaå¹¶å/400.çº¿ç¨æ± æºç è§£æ.html",redirect:"/pages/79cb1d/"},{name:"v-230aad5c",path:"/pages/6c8c00/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-230aad5c").then(t)}},{path:"/pages/6c8c00/index.html",redirect:"/pages/6c8c00/"},{path:"/02.æç« /75.Javaå¹¶å/60.AQSæºç è§£æ.html",redirect:"/pages/6c8c00/"},{name:"v-b5de3650",path:"/pages/6cfda5/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-b5de3650").then(t)}},{path:"/pages/6cfda5/index.html",redirect:"/pages/6cfda5/"},{path:"/02.æç« /75.Javaå¹¶å/70.ReentrantReadWriteLock.html",redirect:"/pages/6cfda5/"},{name:"v-ff4b2134",path:"/pages/5031c2/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-ff4b2134").then(t)}},{path:"/pages/5031c2/index.html",redirect:"/pages/5031c2/"},{path:"/02.æç« /75.Javaå¹¶å/65.ReentrantLock.html",redirect:"/pages/5031c2/"},{name:"v-68f17928",path:"/pages/97a05f/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-68f17928").then(t)}},{path:"/pages/97a05f/index.html",redirect:"/pages/97a05f/"},{path:"/02.æç« /85.ç®æ³/1.è´è½½åè¡¡ç®æ³.html",redirect:"/pages/97a05f/"},{name:"v-20c514cb",path:"/pages/5dba8e/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-20c514cb").then(t)}},{path:"/pages/5dba8e/index.html",redirect:"/pages/5dba8e/"},{path:"/02.æç« /85.ç®æ³/20.éæµç®æ³.html",redirect:"/pages/5dba8e/"},{name:"v-ed0ea22a",path:"/pages/7e25cb/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-ed0ea22a").then(t)}},{path:"/pages/7e25cb/index.html",redirect:"/pages/7e25cb/"},{path:"/02.æç« /85.ç®æ³/30.ä¸è´æ§åå¸ç®æ³.html",redirect:"/pages/7e25cb/"},{name:"v-218f759f",path:"/pages/3fe609/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-218f759f").then(t)}},{path:"/pages/3fe609/index.html",redirect:"/pages/3fe609/"},{path:"/02.æç« /85.ç®æ³/40.éªè±ç®æ³.html",redirect:"/pages/3fe609/"},{name:"v-1a0380cd",path:"/pages/db9f45/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-1a0380cd").then(t)}},{path:"/pages/db9f45/index.html",redirect:"/pages/db9f45/"},{path:"/02.æç« /91.æ¡æ¶/1.çè®º/10.CAPçè®º.html",redirect:"/pages/db9f45/"},{name:"v-2232d43f",path:"/pages/793cbb/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-2232d43f").then(t)}},{path:"/pages/793cbb/index.html",redirect:"/pages/793cbb/"},{path:"/02.æç« /91.æ¡æ¶/1.çè®º/20.BASEçè®º.html",redirect:"/pages/793cbb/"},{name:"v-75b72c80",path:"/pages/208bb3/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-75b72c80").then(t)}},{path:"/pages/208bb3/index.html",redirect:"/pages/208bb3/"},{path:"/02.æç« /91.æ¡æ¶/1.çè®º/30.Raftç®æ³.html",redirect:"/pages/208bb3/"},{name:"v-64094560",path:"/pages/fcb98f/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-64094560").then(t)}},{path:"/pages/fcb98f/index.html",redirect:"/pages/fcb98f/"},{path:"/02.æç« /91.æ¡æ¶/100.XXL-JOB/2.XXL-JOBçä½¿ç¨.html",redirect:"/pages/fcb98f/"},{name:"v-49c73577",path:"/pages/bb013b/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-49c73577").then(t)}},{path:"/pages/bb013b/index.html",redirect:"/pages/bb013b/"},{path:"/02.æç« /91.æ¡æ¶/100.XXL-JOB/1.XXL-JOBçå®è£.html",redirect:"/pages/bb013b/"},{name:"v-2a546378",path:"/pages/75326c/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-2a546378").then(t)}},{path:"/pages/75326c/index.html",redirect:"/pages/75326c/"},{path:"/02.æç« /91.æ¡æ¶/100.XXL-JOB/20.XXL-JOBè´è½½åè¡¡ç­ç¥.html",redirect:"/pages/75326c/"},{name:"v-849ebb74",path:"/pages/ac1d9d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-849ebb74").then(t)}},{path:"/pages/ac1d9d/index.html",redirect:"/pages/ac1d9d/"},{path:"/02.æç« /91.æ¡æ¶/100.XXL-JOB/4.XXL-JOBæ°æ®åºå­æ®µè®²è§£.html",redirect:"/pages/ac1d9d/"},{name:"v-18bfcd63",path:"/pages/a25535/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-18bfcd63").then(t)}},{path:"/pages/a25535/index.html",redirect:"/pages/a25535/"},{path:"/02.æç« /91.æ¡æ¶/100.XXL-JOB/6.æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶.html",redirect:"/pages/a25535/"},{name:"v-55669653",path:"/pages/243013/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-55669653").then(t)}},{path:"/pages/243013/index.html",redirect:"/pages/243013/"},{path:"/02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/10.Nacos.html",redirect:"/pages/243013/"},{name:"v-72a09f4a",path:"/pages/afe80c/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-72a09f4a").then(t)}},{path:"/pages/afe80c/index.html",redirect:"/pages/afe80c/"},{path:"/02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/20.Ribbon.html",redirect:"/pages/afe80c/"},{name:"v-0000769a",path:"/pages/e020ec/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-0000769a").then(t)}},{path:"/pages/e020ec/index.html",redirect:"/pages/e020ec/"},{path:"/02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/30.OpenFeign.html",redirect:"/pages/e020ec/"},{name:"v-0112e9f6",path:"/pages/5531a6/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-0112e9f6").then(t)}},{path:"/pages/5531a6/index.html",redirect:"/pages/5531a6/"},{path:"/02.æç« /91.æ¡æ¶/100.XXL-JOB/5.å®æ¶ä»»å¡æ¯å¦ä½æ§è¡ç.html",redirect:"/pages/5531a6/"},{name:"v-40abcda6",path:"/pages/b4dd7e/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-40abcda6").then(t)}},{path:"/pages/b4dd7e/index.html",redirect:"/pages/b4dd7e/"},{path:"/02.æç« /91.æ¡æ¶/5.Spring/100.Springäºå¡.html",redirect:"/pages/b4dd7e/"},{name:"v-7512a88a",path:"/pages/a7a70b/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-7512a88a").then(t)}},{path:"/pages/a7a70b/index.html",redirect:"/pages/a7a70b/"},{path:"/02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/40.Sentinel.html",redirect:"/pages/a7a70b/"},{name:"v-fa2c9a0c",path:"/pages/3d8a71/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-fa2c9a0c").then(t)}},{path:"/pages/3d8a71/index.html",redirect:"/pages/3d8a71/"},{path:"/02.æç« /91.æ¡æ¶/60.Sentinel/3. Sentinelä¸­çä¸äºæ¦å¿µ.html",redirect:"/pages/3d8a71/"},{name:"v-d47ce5a2",path:"/pages/51db55/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-d47ce5a2").then(t)}},{path:"/pages/51db55/index.html",redirect:"/pages/51db55/"},{path:"/02.æç« /91.æ¡æ¶/60.Sentinel/4. Sentinel è´£ä»»é¾æµç¨.html",redirect:"/pages/51db55/"},{name:"v-6f97f076",path:"/pages/f4866d/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-6f97f076").then(t)}},{path:"/pages/f4866d/index.html",redirect:"/pages/f4866d/"},{path:"/02.æç« /91.æ¡æ¶/60.Sentinel/5. Sentinel - NodeSelectorSlot.html",redirect:"/pages/f4866d/"},{name:"v-34b36bf8",path:"/pages/df7ccb/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-34b36bf8").then(t)}},{path:"/pages/df7ccb/index.html",redirect:"/pages/df7ccb/"},{path:"/02.æç« /91.æ¡æ¶/60.Sentinel/6. Sentinel - ClusterBuilderSlot.html",redirect:"/pages/df7ccb/"},{name:"v-c3e06076",path:"/pages/1b12ed/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-c3e06076").then(t)}},{path:"/pages/1b12ed/index.html",redirect:"/pages/1b12ed/"},{path:"/06.èç³»æ/01.èç³»æ.html",redirect:"/pages/1b12ed/"},{name:"v-391a0836",path:"/blog/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-391a0836").then(t)}},{path:"/blog/index.html",redirect:"/blog/"},{path:"/@pages/archivesPage.html",redirect:"/blog/"},{name:"v-5f6c1111",path:"/",component:xs,beforeEnter:(n,e,t)=>{dl("Layout","v-5f6c1111").then(t)}},{path:"/index.html",redirect:"/"},{path:"*",component:xs}],ys={title:"",description:"ä¸ä¸ªåºäºVuePressç ç¥è¯ç®¡ç&åå®¢ ä¸»é¢",base:"/",headTags:[["link",{rel:"icon",href:"/img/favicon.ico"}],["meta",{name:"keywords",content:"vuepress,theme,blog,vdoing"}],["meta",{name:"theme-color",content:"#11a8cd"}]],pages:[{title:"è¯´æ",frontmatter:{title:"è¯´æ",date:"2023-06-08T21:45:52.000Z",permalink:"/pages/259a4b/"},regularPath:"/02.%E6%96%87%E7%AB%A0/00.%E8%AF%B4%E6%98%8E.html",relativePath:"02.æç« /00.è¯´æ.md",key:"v-68ba2172",path:"/pages/259a4b/",headersStr:null,content:"è¿éæ¯æå¹³æ¶å­¦ä¹ è®°å½çç¬è®°ãæäºæ¯çå®ä¸äºè§é¢/åå®¢/ç¬è®°éä¾¿ååï¼æäºæ¯çä¹¦åçç¬è®°ã",normalizedContent:"è¿éæ¯æå¹³æ¶å­¦ä¹ è®°å½çç¬è®°ãæäºæ¯çå®ä¸äºè§é¢/åå®¢/ç¬è®°éä¾¿ååï¼æäºæ¯çä¹¦åçç¬è®°ã",charsets:{cjk:!0},lastUpdated:"2023/08/02, 01:36:29",lastUpdatedTimestamp:1690911389e3},{title:"Javaå¯¹äºé¶æ·è´çå®ç°",frontmatter:{title:"Javaå¯¹äºé¶æ·è´çå®ç°",date:"2023-11-02T16:33:02.000Z",permalink:"/pages/a5b563/"},regularPath:"/02.%E6%96%87%E7%AB%A0/01.Java%E5%9F%BA%E7%A1%80/1000.Java%E5%AF%B9%E4%BA%8E%E9%9B%B6%E6%8B%B7%E8%B4%9D%E7%9A%84%E5%AE%9E%E7%8E%B0.html",relativePath:"02.æç« /01.Javaåºç¡/1000.Javaå¯¹äºé¶æ·è´çå®ç°.md",key:"v-9f98b88c",path:"/pages/a5b563/",headers:[{level:2,title:"1. MMAP",slug:"_1-mmap",normalizedTitle:"1. mmap",charIndex:221},{level:2,title:"2. å å¤åå­",slug:"_2-å å¤åå­",normalizedTitle:"2. å å¤åå­",charIndex:566},{level:2,title:"3. send file",slug:"_3-send-file",normalizedTitle:"3. send file",charIndex:1054},{level:3,title:"3.1 transferFrom ç»è",slug:"_3-1-transferfrom-ç»è",normalizedTitle:"3.1 transferfrom ç»è",charIndex:1247},{level:4,title:"3.1.1 MMAP",slug:"_3-1-1-mmap",normalizedTitle:"3.1.1 mmap",charIndex:1454},{level:4,title:"3.1.2 å å¤åå­",slug:"_3-1-2-å å¤åå­",normalizedTitle:"3.1.2 å å¤åå­",charIndex:2091},{level:4,title:"3.1.3 transferFrom æ¹æ³å°ç»",slug:"_3-1-3-transferfrom-æ¹æ³å°ç»",normalizedTitle:"3.1.3 transferfrom æ¹æ³å°ç»",charIndex:2195},{level:3,title:"3.2 transferTo ç»è",slug:"_3-2-transferto-ç»è",normalizedTitle:"3.2 transferto ç»è",charIndex:2486}],headersStr:"1. MMAP 2. å å¤åå­ 3. send file 3.1 transferFrom ç»è 3.1.1 MMAP 3.1.2 å å¤åå­ 3.1.3 transferFrom æ¹æ³å°ç» 3.2 transferTo ç»è",content:"å³äº mmapãsendfile çç¥è¯ï¼åè§ ï¼é¶æ·è´ãè¿ç¯æç« ä»ç»äºé¶æ·è´çç¥è¯ï¼ä¹è®²è§£äº mmapãsendfile å¯¹äºæ°æ®ä¼ è¾çä¼å ä»¥å å®ä¿©çåºå«ã\n\nJava sendfile ç api æ¯ transferTo å transferFrom æ¹æ³ã\n\næ³¨æ ï¼send file æ¯ä¸ä¸ªä»ç£çå°ç½å¡é©±å¨ç IO ä¼åãåè¿æ¥ï¼ç½å¡å°ç£çï¼æ¯æ²¡æè¿ä¸ªä¼åçãä¹å°±æ¯è¯´ transferFrom æ¹æ³å¹¶æ²¡æè¿ç§ç¦å©ã\n\n\n# 1. MMAP\n\nMMAP ï¼å°ç¨æ·ç¼å²åºä¸åæ ¸ç¼å²åºåæ å°ï¼åå°ä¸æ¬¡CPUæ·è´ã\n\nå¨ Java ä¸­è°ç¨ MMAP ä¸º ï¼\n\nMappedByteBuffer mappedBuffer = \n    fileChannel.map(FileChannel.MapMode.READ_WRITE, 0, fileChannel.size());\n\n\nfileChannel.map() åå³å¯è·å¾æ å°åç bufferï¼æ¥çå°±å¯ä»¥ä½¿ç¨ MMAP æ¹å¼è¿è¡æä»¶æ·è´ã\n\nå¯ä»¥ä½¿ç¨ mappedBuffer.put() æ¹æ³åç¼å²åºå­æ¾æ°æ®ï¼åä½¿ç¨ mappedBuffer.force() å·æ°å°ç£çã\n\nmmapä¸ºä½å¯ä»¥åå°ä¸æ¬¡CPUæ·è´ï¼å¨é¶æ·è´é£ä¸ç« å·²ç»ä»ç»è¿äºï¼ä¸å¨ä»ç»äºã\n\n\n# 2. å å¤åå­\n\nJava ä¸­è¿æä¸ç§æ¹å¼å¯ä»¥æé«æä»¶æ·è´çæç ï¼å å¤åå­ã\n\nå®éä¸è¿ç§æ¹å¼å¹¶ä¸æ¯é¶æ·è´ï¼æä»¬ç¥éï¼Javaä¸­ä½¿ç¨çåå­å¤§é¨åé½å¨å ä¸­ï¼å åJavaå åå­ç®¡ççæ§å¶ã\n\nèå å¤åå­æ¯ç´æ¥å¨å çå¤é¢åéåå­ç»ä½ ç¨ï¼ä¸åå Javaå åå­ç®¡çæºå¶ççº¦æï¼ä¸å­å¨é¢ç¹çç§»å¨æèæ¸çãéå¸¸ä¼ä¸mmapç»åå¨ä¸èµ·ä½¿ç¨ï¼æä»¥Java æä¾äºä¸ä¸ªç±» ï¼DirectBuffer\n\npublic interface DirectBuffer {\n    long address();\n\n    Object attachment();\n\n    Cleaner cleaner();\n}\n\n\nè¿æ¯ä¸ä¸ªæ¥å£ï¼å¶ä¸­ address æ¯ç³è¯·çå å¤åå­çå°åãè¿ä¸ªç±»æ¥æå¾å¤å®ç°ç±»ï¼æ¿æå¸åç DirectByteBufferæ¥è¯´ï¼å®æ¢å®ç°äº DirectBufferï¼æ¥æåéå å¤åå­çè½åï¼åå®ç°äºMappedByteBufferï¼æ¥æäºåå­æ å°çè½åã\n\nå å¤åå­æä¹åéå¢ï¼ç¨å­¦è¿çCè¯­è¨æ¥è¯´ï¼å¤§æ¦å°±æ¯ malloc ä¸ä¸ï¼æç³è¯·çå°åç» addressåéã\n\n\n# 3. send file\n\nè¯´ senfile å¶å®ä¹ä¸åéï¼Javaå¯¹äºsend file çå®ç°ä¸­ï¼æç§ä¸åçä½¿ç¨æåµä½¿ç¨äºä¸åçé¶æ·è´æ¹å¼ï¼å¶ä¸­ä¸¤ä¸ªå³é®ç api ï¼transferToãtransferFromãå®ä¿©å¨ FileChannel ä¸­ã\n\nå¶ä¸­åªæ transferTo ç¨å°äºsend fileï¼èä¸æ³è¦è§¦å send file æ¯ææ¡ä»¶çï¼å·ä½å¾ä¸çã\n\n\n# 3.1 transferFrom ç»è\n\ntransferFromçåºå±å¶å®æ¯ä¸¤ç§å®ç°æ¹å¼ ï¼\n\n 1. MMAP\n 2. å å¤åå­\n\n\n\nä»ä»£ç å¯ä»¥çåºæ¥ï¼ä½¿ç¨transferFromåï¼å¤æ­ä¼ å¥ç channel ç±»åï¼\n\n * å¦ææ¯æ®éç FileChannel å®ç°ç±»ï¼é£ä¹ä½¿ç¨mmapåæ å°ã\n * å¦æç¨çæ¯ éFileChannelï¼å³SocketChannelç¸å³å®ç°ç±»ï¼ç¨å å¤åå­å®æã\n\n# 3.1.1 MMAP\n\n\n\næ¹æ³çåå­å«å transferFromFileChannel\n\nç®åæ¥è®²ï¼å¨ä¸ä¸ªå¾ªç¯ä¸­ï¼æ¯æ¬¡é½æ¯å°æºæä»¶æ ¹æ® position æ å°ä¸ºä¸ä¸ª mmapï¼æå¤§8Mï¼éæ¬¡çå°æ°æ®åå¥ç®æ æä»¶ä¸­ã\n\nprivatet long transferFromFileChannel(FileChannelImpl src, long position, long count) {\n    // çç¥é¨åä»£ç \n    // remaining: éè¦æ·è´çæ°æ®å©ä½çå­èã\n    while (remaining > 0L) {\n        long size = Math.min(remaining, 8 * 1024 * 1024);\n        MappedByteBuffer bb = src.map(MapMode.READ_ONLY, p, size);\n        try {\n            // åå¥nä¸ªå­èï¼å¹¶å°æºæä»¶åç®æ æä»¶çä¸æ æ´æ¹\n            long n = write(bb, position); \n            position += n; \n            remaining -= n; \n        } finally {\n            // åæ¶æ å°\n            unmap(bb); \n        }\n    }\n}\n\n\n# 3.1.2 å å¤åå­\n\ntransferFromå å¤åå­çç»èï¼\n\n\n\nå¦ææä»¬ä½¿ç¨çæ¯ SocketChannelImplï¼å°±ä¼èµ°å å¤åå­ï¼ä¹æ¯å¨ä¸ä¸ªå¾ªç¯ä¸­åå¥ï¼æ¯æ¬¡æå¤§8kãç¨å®å°½éåæ¶éæ°å©ç¨ã\n\n# 3.1.3 transferFrom æ¹æ³å°ç»\n\n 1. å¦ææ¯æºæ¯ FileChannelImpl ç±»åï¼ å°±èµ° mmap ï¼å¾ªç¯æ å° 8MB å·è¿ç£çã\n 2. å¦ææºæ¯ SocketChannelImpl ç±»åï¼å°±èµ°å å¤åå­ãç®åæ¥è¯´ï¼å°±æ¯å¾ªç¯æ¾è¿å å¤åå­ï¼æ¯æ¬¡ 8kb å·è¿ç£çãæ³¨æï¼å³äºè¿ä¸ªå å¤åå­ï¼æ¯ç¨å°äºç¼å­æ± å­çï¼å å¤åå­æ± åæ¯å¸¸ç¨ä¼åææ®µï¼ï¼è¿ä¸ªæ± å­æ¯ä¸ªæ°ç»ï¼é¿åº¦æ¯ 16ï¼ä½¿ç¨ ThreadLocal æåæ§è½ï¼æ¯æ¬¡è·åï¼åªè¦ç®æ æ°ç»æ¯æ± å­ä¸­ç ByteBuffer ç capacity å°å³å¯ä½¿ç¨ï¼ç¨å®å°±è¿ï¼å¦ææ»¡äºï¼å°±è°ç¨ unsafe éæ¾ã\n\n\n# 3.2 transferTo ç»è\n\ntransferTo æ¹æ³å¾æææï¼åç®åè¯´ä¸ç»è®ºï¼\n\n 1. å¦æ OS æ¯æ send fileï¼windows ä¸æ¯æï¼ï¼å°±æ§è¡ system callã\n 2. å¦æ OS ä¸æ¯æï¼å°±èµ° mmapã\n 3. å¦æ mmap å¤±è´¥ï¼å°±èµ° å å¤åå­ã\n\n\n\n> çäº send file ç Java å±é¢å®ç°ï¼è¿éæ»ç»ä¸ä¸ï¼åªæ transferTo ç¨å°äº send fileï¼èä¸è¿æ¯ææ¡ä»¶çï¼å·ä½ï¼æ¬æç¬¬äºé¨åå·²ç»ç»åºã\n> \n> è transferFrom æ¹æ³åæ¯å¾æ®éçä½¿ç¨ mmap æè å å¤åå­ï¼ä¼¼ä¹æä»¬æå¯ä»¥èªå·±å®ç°ï¼åèæ§è½å¯è½ä¼æ´å¥½ï¼ä¾å¦æä»¬ä½¿ç¨æ´å¤§çç¼å­ï¼èä¸å¿å¾ªç¯å¤æ¬¡ï¼æä»¬å¯ä»¥ä½¿ç¨æ´å¤§ç mmap æ å°ï¼èä¸æ¯ 8Mbï¼æ¯æ¬¡é½éè¦ clean åéæ° mappingã",normalizedContent:"å³äº mmapãsendfile çç¥è¯ï¼åè§ ï¼é¶æ·è´ãè¿ç¯æç« ä»ç»äºé¶æ·è´çç¥è¯ï¼ä¹è®²è§£äº mmapãsendfile å¯¹äºæ°æ®ä¼ è¾çä¼å ä»¥å å®ä¿©çåºå«ã\n\njava sendfile ç api æ¯ transferto å transferfrom æ¹æ³ã\n\næ³¨æ ï¼send file æ¯ä¸ä¸ªä»ç£çå°ç½å¡é©±å¨ç io ä¼åãåè¿æ¥ï¼ç½å¡å°ç£çï¼æ¯æ²¡æè¿ä¸ªä¼åçãä¹å°±æ¯è¯´ transferfrom æ¹æ³å¹¶æ²¡æè¿ç§ç¦å©ã\n\n\n# 1. mmap\n\nmmap ï¼å°ç¨æ·ç¼å²åºä¸åæ ¸ç¼å²åºåæ å°ï¼åå°ä¸æ¬¡cpuæ·è´ã\n\nå¨ java ä¸­è°ç¨ mmap ä¸º ï¼\n\nmappedbytebuffer mappedbuffer = \n    filechannel.map(filechannel.mapmode.read_write, 0, filechannel.size());\n\n\nfilechannel.map() åå³å¯è·å¾æ å°åç bufferï¼æ¥çå°±å¯ä»¥ä½¿ç¨ mmap æ¹å¼è¿è¡æä»¶æ·è´ã\n\nå¯ä»¥ä½¿ç¨ mappedbuffer.put() æ¹æ³åç¼å²åºå­æ¾æ°æ®ï¼åä½¿ç¨ mappedbuffer.force() å·æ°å°ç£çã\n\nmmapä¸ºä½å¯ä»¥åå°ä¸æ¬¡cpuæ·è´ï¼å¨é¶æ·è´é£ä¸ç« å·²ç»ä»ç»è¿äºï¼ä¸å¨ä»ç»äºã\n\n\n# 2. å å¤åå­\n\njava ä¸­è¿æä¸ç§æ¹å¼å¯ä»¥æé«æä»¶æ·è´çæç ï¼å å¤åå­ã\n\nå®éä¸è¿ç§æ¹å¼å¹¶ä¸æ¯é¶æ·è´ï¼æä»¬ç¥éï¼javaä¸­ä½¿ç¨çåå­å¤§é¨åé½å¨å ä¸­ï¼å åjavaå åå­ç®¡ççæ§å¶ã\n\nèå å¤åå­æ¯ç´æ¥å¨å çå¤é¢åéåå­ç»ä½ ç¨ï¼ä¸åå javaå åå­ç®¡çæºå¶ççº¦æï¼ä¸å­å¨é¢ç¹çç§»å¨æèæ¸çãéå¸¸ä¼ä¸mmapç»åå¨ä¸èµ·ä½¿ç¨ï¼æä»¥java æä¾äºä¸ä¸ªç±» ï¼directbuffer\n\npublic interface directbuffer {\n    long address();\n\n    object attachment();\n\n    cleaner cleaner();\n}\n\n\nè¿æ¯ä¸ä¸ªæ¥å£ï¼å¶ä¸­ address æ¯ç³è¯·çå å¤åå­çå°åãè¿ä¸ªç±»æ¥æå¾å¤å®ç°ç±»ï¼æ¿æå¸åç directbytebufferæ¥è¯´ï¼å®æ¢å®ç°äº directbufferï¼æ¥æåéå å¤åå­çè½åï¼åå®ç°äºmappedbytebufferï¼æ¥æäºåå­æ å°çè½åã\n\nå å¤åå­æä¹åéå¢ï¼ç¨å­¦è¿çcè¯­è¨æ¥è¯´ï¼å¤§æ¦å°±æ¯ malloc ä¸ä¸ï¼æç³è¯·çå°åç» addressåéã\n\n\n# 3. send file\n\nè¯´ senfile å¶å®ä¹ä¸åéï¼javaå¯¹äºsend file çå®ç°ä¸­ï¼æç§ä¸åçä½¿ç¨æåµä½¿ç¨äºä¸åçé¶æ·è´æ¹å¼ï¼å¶ä¸­ä¸¤ä¸ªå³é®ç api ï¼transfertoãtransferfromãå®ä¿©å¨ filechannel ä¸­ã\n\nå¶ä¸­åªæ transferto ç¨å°äºsend fileï¼èä¸æ³è¦è§¦å send file æ¯ææ¡ä»¶çï¼å·ä½å¾ä¸çã\n\n\n# 3.1 transferfrom ç»è\n\ntransferfromçåºå±å¶å®æ¯ä¸¤ç§å®ç°æ¹å¼ ï¼\n\n 1. mmap\n 2. å å¤åå­\n\n\n\nä»ä»£ç å¯ä»¥çåºæ¥ï¼ä½¿ç¨transferfromåï¼å¤æ­ä¼ å¥ç channel ç±»åï¼\n\n * å¦ææ¯æ®éç filechannel å®ç°ç±»ï¼é£ä¹ä½¿ç¨mmapåæ å°ã\n * å¦æç¨çæ¯ éfilechannelï¼å³socketchannelç¸å³å®ç°ç±»ï¼ç¨å å¤åå­å®æã\n\n# 3.1.1 mmap\n\n\n\næ¹æ³çåå­å«å transferfromfilechannel\n\nç®åæ¥è®²ï¼å¨ä¸ä¸ªå¾ªç¯ä¸­ï¼æ¯æ¬¡é½æ¯å°æºæä»¶æ ¹æ® position æ å°ä¸ºä¸ä¸ª mmapï¼æå¤§8mï¼éæ¬¡çå°æ°æ®åå¥ç®æ æä»¶ä¸­ã\n\nprivatet long transferfromfilechannel(filechannelimpl src, long position, long count) {\n    // çç¥é¨åä»£ç \n    // remaining: éè¦æ·è´çæ°æ®å©ä½çå­èã\n    while (remaining > 0l) {\n        long size = math.min(remaining, 8 * 1024 * 1024);\n        mappedbytebuffer bb = src.map(mapmode.read_only, p, size);\n        try {\n            // åå¥nä¸ªå­èï¼å¹¶å°æºæä»¶åç®æ æä»¶çä¸æ æ´æ¹\n            long n = write(bb, position); \n            position += n; \n            remaining -= n; \n        } finally {\n            // åæ¶æ å°\n            unmap(bb); \n        }\n    }\n}\n\n\n# 3.1.2 å å¤åå­\n\ntransferfromå å¤åå­çç»èï¼\n\n\n\nå¦ææä»¬ä½¿ç¨çæ¯ socketchannelimplï¼å°±ä¼èµ°å å¤åå­ï¼ä¹æ¯å¨ä¸ä¸ªå¾ªç¯ä¸­åå¥ï¼æ¯æ¬¡æå¤§8kãç¨å®å°½éåæ¶éæ°å©ç¨ã\n\n# 3.1.3 transferfrom æ¹æ³å°ç»\n\n 1. å¦ææ¯æºæ¯ filechannelimpl ç±»åï¼ å°±èµ° mmap ï¼å¾ªç¯æ å° 8mb å·è¿ç£çã\n 2. å¦ææºæ¯ socketchannelimpl ç±»åï¼å°±èµ°å å¤åå­ãç®åæ¥è¯´ï¼å°±æ¯å¾ªç¯æ¾è¿å å¤åå­ï¼æ¯æ¬¡ 8kb å·è¿ç£çãæ³¨æï¼å³äºè¿ä¸ªå å¤åå­ï¼æ¯ç¨å°äºç¼å­æ± å­çï¼å å¤åå­æ± åæ¯å¸¸ç¨ä¼åææ®µï¼ï¼è¿ä¸ªæ± å­æ¯ä¸ªæ°ç»ï¼é¿åº¦æ¯ 16ï¼ä½¿ç¨ threadlocal æåæ§è½ï¼æ¯æ¬¡è·åï¼åªè¦ç®æ æ°ç»æ¯æ± å­ä¸­ç bytebuffer ç capacity å°å³å¯ä½¿ç¨ï¼ç¨å®å°±è¿ï¼å¦ææ»¡äºï¼å°±è°ç¨ unsafe éæ¾ã\n\n\n# 3.2 transferto ç»è\n\ntransferto æ¹æ³å¾æææï¼åç®åè¯´ä¸ç»è®ºï¼\n\n 1. å¦æ os æ¯æ send fileï¼windows ä¸æ¯æï¼ï¼å°±æ§è¡ system callã\n 2. å¦æ os ä¸æ¯æï¼å°±èµ° mmapã\n 3. å¦æ mmap å¤±è´¥ï¼å°±èµ° å å¤åå­ã\n\n\n\n> çäº send file ç java å±é¢å®ç°ï¼è¿éæ»ç»ä¸ä¸ï¼åªæ transferto ç¨å°äº send fileï¼èä¸è¿æ¯ææ¡ä»¶çï¼å·ä½ï¼æ¬æç¬¬äºé¨åå·²ç»ç»åºã\n> \n> è transferfrom æ¹æ³åæ¯å¾æ®éçä½¿ç¨ mmap æè å å¤åå­ï¼ä¼¼ä¹æä»¬æå¯ä»¥èªå·±å®ç°ï¼åèæ§è½å¯è½ä¼æ´å¥½ï¼ä¾å¦æä»¬ä½¿ç¨æ´å¤§çç¼å­ï¼èä¸å¿å¾ªç¯å¤æ¬¡ï¼æä»¬å¯ä»¥ä½¿ç¨æ´å¤§ç mmap æ å°ï¼èä¸æ¯ 8mbï¼æ¯æ¬¡é½éè¦ clean åéæ° mappingã",charsets:{cjk:!0},lastUpdated:"2023/11/08, 21:26:21",lastUpdatedTimestamp:1699449981e3},{title:"Java NIO",frontmatter:{title:"Java NIO",date:"2023-08-02T00:53:14.000Z",permalink:"/pages/5c396f/"},regularPath:"/02.%E6%96%87%E7%AB%A0/01.Java%E5%9F%BA%E7%A1%80/100.Java%20NIO.html",relativePath:"02.æç« /01.Javaåºç¡/100.Java NIO.md",key:"v-eb6aaeb6",path:"/pages/5c396f/",headers:[{level:2,title:"1. IOæ¦è¿°",slug:"_1-ioæ¦è¿°",normalizedTitle:"1. ioæ¦è¿°",charIndex:2},{level:2,title:"2. Buffer",slug:"_2-buffer",normalizedTitle:"2. buffer",charIndex:1387},{level:3,title:"2.1 allocate()",slug:"_2-1-allocate",normalizedTitle:"2.1 allocate()",charIndex:2411},{level:3,title:"2.2 position() limit()",slug:"_2-2-position-limit",normalizedTitle:"2.2 position() limit()",charIndex:2903},{level:3,title:"2.3 flip()",slug:"_2-3-flip",normalizedTitle:"2.3 flip()",charIndex:4463},{level:3,title:"2.4 clear() rewind()",slug:"_2-4-clear-rewind",normalizedTitle:"2.4 clear() rewind()",charIndex:5311},{level:3,title:"2.5 compact()",slug:"_2-5-compact",normalizedTitle:"2.5 compact()",charIndex:5716},{level:3,title:"2.6 remaining()",slug:"_2-6-remaining",normalizedTitle:"2.6 remaining()",charIndex:6304},{level:2,title:"3. Channel",slug:"_3-channel",normalizedTitle:"3. channel",charIndex:7724},{level:3,title:"3.1 æä»¶ IO éé",slug:"_3-1-æä»¶-io-éé",normalizedTitle:"3.1 æä»¶ io éé",charIndex:8025},{level:3,title:"3.2 ç½ç» IO éé",slug:"_3-2-ç½ç»-io-éé",normalizedTitle:"3.2 ç½ç» io éé",charIndex:9877},{level:4,title:"3.2.1 ServerSocketChannel",slug:"_3-2-1-serversocketchannel",normalizedTitle:"3.2.1 serversocketchannel",charIndex:10400},{level:4,title:"3.2.2 SocketChannel",slug:"_3-2-2-socketchannel",normalizedTitle:"3.2.2 socketchannel",charIndex:11896},{level:4,title:"3.2.3 DatagramChannel",slug:"_3-2-3-datagramchannel",normalizedTitle:"3.2.3 datagramchannel",charIndex:16782},{level:2,title:"4. Selector",slug:"_4-selector",normalizedTitle:"4. selector",charIndex:19449},{level:3,title:"4.1 SelectableChannel",slug:"_4-1-selectablechannel",normalizedTitle:"4.1 selectablechannel",charIndex:19810},{level:3,title:"4.2 SelectionKey",slug:"_4-2-selectionkey",normalizedTitle:"4.2 selectionkey",charIndex:20142},{level:3,title:"4.3 Selector",slug:"_4-3-selector",normalizedTitle:"4.3 selector",charIndex:21084},{level:2,title:"5. IOå¤è·¯å¤ç¨çå ç§æ¨¡å¼",slug:"_5-ioå¤è·¯å¤ç¨çå ç§æ¨¡å¼",normalizedTitle:"5. ioå¤è·¯å¤ç¨çå ç§æ¨¡å¼",charIndex:23816},{level:2,title:"6. æ»ç»",slug:"_6-æ»ç»",normalizedTitle:"6. æ»ç»",charIndex:24698}],headersStr:"1. IOæ¦è¿° 2. Buffer 2.1 allocate() 2.2 position() limit() 2.3 flip() 2.4 clear() rewind() 2.5 compact() 2.6 remaining() 3. Channel 3.1 æä»¶ IO éé 3.2 ç½ç» IO éé 3.2.1 ServerSocketChannel 3.2.2 SocketChannel 3.2.3 DatagramChannel 4. Selector 4.1 SelectableChannel 4.2 SelectionKey 4.3 Selector 5. IOå¤è·¯å¤ç¨çå ç§æ¨¡å¼ 6. æ»ç»",content:'# 1. IOæ¦è¿°\n\nå¨ä»ç»Java NIO ä¹åï¼åæ¥è¯´ä¸ä¸ä»ä¹æ¯IOã\n\nä»ä¹æ¯IOï¼\n\nç®èè¨ä¹ï¼InputåOutPutï¼è¾å¥åè¾åºå°±æ¯IOã\n\næ ¹æ®æä½ç³»ç»çç¥è¯ ï¼ä¸ä¸ªè¿ç¨çå°åç©ºé´ååä¸º ç¨æ·ç©ºé´ãåæ ¸ç©ºé´ãæä»¬å¹³æ¶è¿è¡çåºç¨ç¨åºæ¯å¨ç¨æ·ç©ºé´ä¸­çï¼åªæå½åºç°åå­åéãæä»¶æä½ç­æä½æ¶ æä¼åæ¢ä¸ºåæ ¸ç©ºé´ï¼å¹¶ä¸ç¨æ·ç©ºé´æ¯æ æ³è®¿é®è¿äºèµæºçï¼ç¨æ·è¿ç¨æ³è¦è®¿é®ç³»ç»èµæºå°±å¿é¡»è¦ è¿è¡ç³»ç»è°ç¨ä»ç¨æ·ç©ºé´åæ¢å°åæ ¸ç©ºé´ã\n\nä¸å±ä¸ºä¸ä¸ªæ­¥éª¤ ï¼\n\n 1. ç¨æ·ç©ºé´åèµ·ç³»ç»è°ç¨ï¼ä¾å¦è¿è¡è¯»æä»¶æ¶æ§è¡çreadæ¹æ³ï¼ï¼äº§çä¸­æ­\n 2. åæ ¸ç­å¾ I/O è®¾å¤åå¤å¥½æ°æ®\n 3. åæ ¸å°æ°æ®ä» åæ ¸ç©ºé´ æ·è´å°ç¨æ·ç©ºé´ãï¼æ´åç¡®ç¹æ¯ä»åæ ¸ç©ºé´çç¼å²åºæ·è´å°ç¨æ·ç©ºé´çç¼å²åºï¼\n\né£ä¹å¨ç¨æ·ç©ºé´åèµ·ç³»ç»è°ç¨ç´å°åæ ¸ç©ºé´æ¿å°å¼è¿åç»ä½ è¿ä¸ªæ¶é´æ®µï¼ç¨æ·ç©ºé´æ¯ é»å¡ç­å¾ è¿æ¯ ä¸æ­è½®è¯¢ï¼å°±äº§çäºé»å¡IOãéé»å¡IOè¿äºä¸åçIOæ¹å¼ãLinuxä¸­åä¸ºäºç§IOæ¹å¼ ï¼\n\n 1. åæ­¥é»å¡ I/O ï¼åºç¨ç¨åºåèµ· read è°ç¨åï¼ä¼ä¸ç´é»å¡ï¼ç´å°åæ ¸ææ°æ®æ·è´å°ç¨æ·ç©ºé´ã\n 2. åæ­¥éé»å¡ I/O ï¼åºç¨ç¨åºåèµ·readåç«å»è¿åå¹¶ä¸æ­è¯¢é®ã\n 3. I/O å¤è·¯å¤ç¨ ï¼çº¿ç¨é¦ååèµ· select è°ç¨ï¼è¯¢é®åæ ¸æ°æ®æ¯å¦åå¤å°±ç»ªï¼ç­åæ ¸ææ°æ®åå¤å¥½äºï¼ç¨æ·çº¿ç¨ååèµ· read è°ç¨ãread è°ç¨çè¿ç¨ï¼æ°æ®ä»åæ ¸ç©ºé´ -> ç¨æ·ç©ºé´ï¼è¿æ¯é»å¡çã\n 4. ä¿¡å·é©±å¨ I/O ï¼åºç¨ç¨åºåèµ·readè°ç¨åå»åèªå·±çäºæï¼åæ ¸åå¤å¥½æ°æ®åååºSIGIOä¿¡å·éç¥åºç¨ç¨åºå·²ç»åå¤å¥½æ°æ®ï¼ åºç¨è¿ç¨æ¶å°ä¹åå¨ä¿¡å·å¤çç¨åºä¸­è°ç¨ recvfrom å°æ°æ®ä»åæ ¸å¤å¶å°åºç¨è¿ç¨ä¸­ã\n 5. å¼æ­¥ I/O ï¼åºç¨ç¨åºåèµ·readè°ç¨åå»åèªå·±çäºæï¼åæ ¸å°æ°æ®ä»åæ ¸ç©ºé´æ·è´å°ç¨æ·ç©ºé´ååèµ·signalä¿¡å·éç¥åºç¨ç¨åºå·²ç»åå¤å¥½æ°æ®ã\n\nä¹ä¸çä¿¡å·é©±å¨IOåå¼æ­¥IOä¸æ¯ä¸æ ·åï¼å¶å®ä¸ç¶ï¼\n\n * ä¿¡å·é©±å¨IO ï¼åèµ·ä¿¡å·éç¥æ¶ï¼æ°æ®å¨åæ ¸æï¼åºç¨ç¨åºéè¦ææ°æ®æ·è´å°ç¨æ·æ\n * å¼æ­¥IO ï¼åèµ·ä¿¡å·æ¶æ°æ®å·²ç»å¨ç¨æ·æäºã\n\nå¨Javaéé¢æ²¡æè¿ä¹å¤IOæ¨¡å¼ï¼åªæBIOãNIOãAIOã\n\n 1. BIO ï¼å¯¹åº åæ­¥é»å¡I/Oã\n 2. NIO ï¼å¯¹åº I/Oå¤è·¯å¤ç¨ã\n 3. AIO ï¼å¯¹åºå¼æ­¥I/Oã\n\nBIOæ¯FileInputStreamãOutputStreamè¿ç§ï¼NIOæ¯ Buffer + Channel + Selector è¿ä¸å¥ã\n\næ¬ç¯æç« å°±æ¯éå¯¹äº Java NIO ç API è¿è¡è®²è§£ã\n\n> åå²çº¿\n\nJava ç NIO æ¨¡åå¯¹åºæä½ç³»ç»ç IO å¤è·¯å¤ç¨æ¨¡åï¼java.nioåä¸æä¾çç±»ä¸ä»å¯ä»¥å®ç°é»å¡IOãéé»å¡IOï¼è¿å¯ä»¥å®ç°IOå¤è·¯å¤ç¨ã\n\n\n\n> JavaçIOå¤è·¯å¤ç¨ï¼å¯ä»¥ä½¿ç¨ä¸ä¸ªçº¿ç¨å¤çå¤ä¸ªå®¢æ·ç«¯è¯·æ±ãå®¢æ·ç«¯åéçè¯·æ±ä¼æ³¨åå°å¤è·¯å¤ç¨å¨ Selector ä¸ï¼ç± Selector è½®è¯¢åä¸ªå®¢æ·ç«¯çè¯·æ±å¹¶è¿è¡å¤çã\n\nJava ç NIO æä¾äºå ä¸ªéè¦çç»ä»¶ï¼\n\n * Buffer ï¼ç¼å²åº\n * Channel ï¼ç®¡é\n * Selector ï¼å¤è·¯å¤ç¨å¨ï¼å¹¶ä¸æ¯ææç io é½å¯ä»¥ä½¿ç¨ Selectorï¼\n\n\n# 2. Buffer\n\nå¨ä¸ä¸ç¯ä¸­æä»¬æå°ï¼BIO çæä½é½æ¯åºäºæµçï¼è NIO çæä½é½æ¯åºäºç¼å­çã\n\nä¹å°±æ¯è¯´ï¼å¨ NIO ä¸­ææçæä½é½æ¯ç¨ç¼å²å¤ççï¼ä¸ç®¡æ¯è¯»è¿æ¯åï¼é½ä½¿ç¨ Buffer å®æã\n\nå¨ NIO ä¸­ï¼ææçç¼å²åºç±»åé½ç»§æ¿äºæ½è±¡ç±» Bufferï¼æå¸¸ç¨çæ¯ ByteBufferï¼å¯¹äº Java çåºæ¬æ°æ®ç±»åï¼åºæ¬é½æä¸ä¸ªå·ä½ç Buffer å®ç°ç±» ä¸ä¹å¯¹åºãæå¸¸ç¨çæ¯ ByteBufferã\n\n\n\nå¶å® Buffer æ¯ä½¿ç¨æ°ç»å®ç°çï¼ä¹å°±æ¯è¯´æä»¬è¯»åºæ¥çæèåå¥çæ°æ®ï¼é½æ¯åå­è¿æ°ç»éé¢ã\n\nä¸¾ä¾ï¼å¦ä¸ä¸º IntBuffer éé¢å­æ¾æ°æ®çæ°ç»ã\n\n\n\nç°å¨åå° Bufferï¼Buffer ä¸­æå ä¸ªéå¸¸éè¦çåéï¼\n\n 1. capacity ï¼è¿ä¸ª Buffer çå®¹éï¼ä¹å°±æ¯ä¸æ¬¡æå¤æ¾è¿å»å¤å°ä¸è¥¿ãè¿ä¸ªåéå¨ Buffer åå»ºæ¶æå®ï¼ä¸æ æ³æ¹åã\n 2. position ï¼å½åæä½æ°æ®çä¸æ ã\n 3. limit ï¼å½åæä½æå¤§æä½å°åªä¸ªä¸æ ï¼é»è®¤ä¸º capacityã\n 4. mark ï¼æ è®°\n\nä¹å¾å¥½çè§£ï¼ç±äºæ°æ®æ¾å¨æ°ç»ä¸­ï¼æä»¬å¿é¡»ä½¿ç¨å ä¸ªåéè®°å½ä¸ä¸ç°å¨æä½å°åªãæå¤æä½å°åªãæ°ç»æå¤§å®¹éã\n\nBuffer å¸¸ç¨çæ¹æ³ï¼\n\næ¹æ³                     ä½ç¨\nxxxBuffer.allocate()   åå»ºä¸ä¸ª Buffer å¯¹è±¡ï¼å¦ ByteBufferãIntBuffer...ï¼\nget()                  è·å position ä½ç½®çæ°æ®ï¼è·åæ°æ®å position++\nput()                  å¾ position ä½ç½®æ¾ç½®æ°æ®\nposition()             è®¾ç½® position çå¼\nlimit()                è®¾ç½® limit çå¼\nflip()                 åæ¢ä¸ºè¯»æ¨¡å¼\nclear()                åæ¢ä¸ºåæ¨¡å¼ï¼ä¸¢å¼å©ä½æ°æ®ï¼\ncompact()              åæ¢ä¸ºåæ¨¡å¼ï¼ä¿çå©ä½æ°æ®ï¼\nremaining()            return limit - positionï¼ä¸è¬ç¨ä½æ¥ç Buffer ä¸­æ¯å¦è¿ææ°æ®\nhasRemaining()         å¦æææ®çæ°æ®ï¼è¿å true\n\n\n# 2.1 allocate()\n\nå½æ³åå»ºä¸ä¸ª Buffer æ¶ï¼ä½¿ç¨çæ¯ å¯¹åº Buffer.allocate(int capacity)ã\n\nä¾å¦æ³åå»ºä¸ä¸ªå¤§å°ä¸º 10 å­èç Bufferï¼ï¼ä¸ºäºæ¹ä¾¿ï¼æ¬ç¯ä¸é¢å°±ä½¿ç¨ ByteBuffer ä¸¾ä¾ãï¼\n\npublic class TestNIO {\n    public static void main(String[] args) {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(10);\n        IntBuffer intBuffer = IntBuffer.allocate(10);\n        CharBuffer charBuffer = CharBuffer.allocate(10);\n        LongBuffer longBuffer = LongBuffer.allocate(10);\n    }\n}\n\n\nåæè¯´çåä¸ªå±æ§æ»æ¯éµå¾ªä»¥ä¸è§å¾ï¼\n\nmark <= pasition <= limit <= capacity\n\n\n# 2.2 position() limit()\n\nåæ¶ï¼Buffer æä¾äºå ä¸ªæ¹æ³æ¥æ¹åè¿å ä¸ªå±æ§çå¼ï¼\n\nbyteBuffer.position(int position);\nbyteBuffer.mark(int mark);\nbyteBuffer.limit(int limit);\n\n\nå¦ä¸ä¸ºæ°åå»ºç ByteBufferï¼\n\n\n\nç°å¨çå¯æä½èå´ä¸ºï¼position - limitï¼0 - 10ï¼\n\nä½¿ç¨ put æ¹æ³åæ°ç»ä¸­æ¾å¥å ä¸ªåç´ åï¼\n\npublic class TestNIO {\n    public static void main(String[] args) {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(10);\n        // putæ¹æ³çæä½ï¼å°æ°æ®æ¾å°positionä½ç½®ï¼position++\n        byteBuffer.put((byte)5);\n        byteBuffer.put((byte)7);\n        byteBuffer.put((byte)2);\n        byteBuffer.put((byte)6);\n        byteBuffer.put((byte)4);\n    }\n}\n\n\nååå¡«åæ°æ®åï¼position éä¹ç§»å¨ï¼å¯æä½èå´ä¸º 5 - 10ã\n\n\n\nåå¦æç°å¨ä¸æ³å­æ°æ®äºï¼ææ³åæ°æ®æä¹åï¼\n\nç±äºæä½èå´ä¸º position - limitï¼æä»¬æ³è¦æ°ç»ä¸æ ä¸º 0 å° 4 çæ°æ®ï¼é£ä¹é¦åè¦ææä½èå´æ¹ä¸º 0-4.\n\nå·ä½ä¸ç¹å°±æ¯ limit = positionï¼position = 0\n\npublic class TestNIO {\n    public static void main(String[] args) {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(10);\n\n        byteBuffer.put((byte)5);\n        byteBuffer.put((byte)7);\n        byteBuffer.put((byte)2);\n        byteBuffer.put((byte)6);\n        byteBuffer.put((byte)4);\n\t// è·åæ­¤æ¶limitåpositionçå¼\n        int limit = byteBuffer.limit();\n        int position = byteBuffer.position();\n\n        // å°limit = position\n        // å°position = 0\n        byteBuffer.limit(position);\n        byteBuffer.position(0);\n\t// get()æä½ï¼è·åæ°ç»ä¸­positionä½ç½®çåç´ ï¼position++\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n    }\n}\n\n\næå°ä¹åï¼\n\n\n\n\n# 2.3 flip()\n\nä½æ¯è¿æ ·ä¼ä¸ä¼å¾éº»ç¦ï¼é¾éææ¯æ¬¡æ³è¦è¯»åæ°æ®çæ¶åé½éè¦ limit=position, position=0 ï¼\n\nè¯å®ä¸å¦ï¼äººå®¶æç°æçæ¹æ³ä¾æä»¬è°ç¨ï¼byteBuffer.flip()\n\npublic final Buffer flip() {\n    limit = position;\n    position = 0;\n    mark = -1;\n    return this;\n}\n\n\nè¿ä¸ªæ¹æ³å¸®æä»¬æ position å limit å±æ§èµå¼ï¼ç´æ¥è°ç¨å°±å¯ä»¥è¯»åæ°æ®ï¼æä»¥æä»¬ç§°å®ä¸ºè¯»æ¨¡å¼ã\n\npublic class TestNIO {\n    public static void main(String[] args) {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(10);\n        byteBuffer.put((byte)5);\n        byteBuffer.put((byte)7);\n        byteBuffer.put((byte)2);\n        byteBuffer.put((byte)6);\n        byteBuffer.put((byte)4);\n        // è¿å¥è¯»æ¨¡å¼\n        byteBuffer.flip();\n\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n        System.out.println(byteBuffer.get());\n    }\n}\n\n\n\n# 2.4 clear() rewind()\n\næ¢ç¶æè¯»æ¨¡å¼ï¼èªæçä½ è¯å®æ³å°äºåæ¨¡å¼ï¼æ²¡éï¼ç¡®å®æï¼byteBuffer.clear()\n\npublic final Buffer clear() {\n    position = 0;\n    limit = capacity;\n    mark = -1;\n    return this;\n}\n\n\nåæ¨¡å¼å° position ç½®ä¸º 0ï¼limit åå° capacity å¤ï¼å°±å¯ä»¥éæ°åå¥æ°æ®äºã\n\nå½ç¶ï¼è¿æä¸ä¸ª API ä¹å¯ä»¥å®ç°ç±»ä¼¼åæ¨¡å¼çä½ç¨ï¼byteBuffer.rewind();\n\npublic final Buffer rewind() {\n    position = 0;\n    mark = -1;\n    return this;\n}\n\n\nclear ä¸ rewind çåºå«æ¯ï¼rewind ä¸æ¹å limit çå¼ã\n\n\n# 2.5 compact()\n\nä½æ¯ç°å¨åè½è¿ä¸æ¯å¾å®åï¼å¦ææ°ç»ä¸­è¿ææ°æ®ï¼ä½æ¯æä»¬ä¾æ§æ³åæ°ç»ä¸­åå¥æ°æ®è¯¥æä¹åå¢ï¼ä½¿ç¨ flip æ¹æ³å clear æ¹æ³ï¼\n\n\n\nå¦å¾æç¤ºï¼position å¨ä¸æ ä¸º 3 çå°æ¹ï¼è°ç¨ clear æ¹æ³åä¼å° position ç½® 0ï¼ååå¥æ°æ®æ¶å°±ä¼åç°ï¼ä¹åç 6 å 4 è¢«è¦çäºï¼æè¿æ²¡æç¨å®å¢æä¹è½è®©å®ä¸¢å¼å¢ï¼\n\nBuffer ä¹æä¾äºæ¹æ³ä¿çè¿å ä¸ªå­èçæ°æ®ï¼byteBuffer.compact()\n\npublic ByteBuffer compact() {\n    System.arraycopy(hb, ix(position()), hb, ix(0), remaining());\n    position(remaining());\n    limit(capacity());\n    discardMark();\n    return this;\n}\n\n\nç®èè¨ä¹ï¼åæ position ~ limit çæ°æ®æ·è´å°æ°ç»çé¦é¨ï¼åå° position æ¾å°å©ä½æ°æ®çåä¸ä¸ªå­èï¼æå limit=capacityã\n\nå¨è¿ä¸ªæ°ç»ä¸­ï¼å°±æ¯å° 6 å 4 æ¾å°åä¸¤ä¸ªå­èï¼position = 3ï¼limit = 10ã\n\n\n\nç¶ååè¿è¡åæä½ï¼å°±ä¼å° 2ã6ã4 è¦çï¼å®ç°äºä¿çå©ä½æ°æ®çåè½ã\n\n\n# 2.6 remaining()\n\nå¦ææä»¬ä¸ç¥é ByteBuffer ä¸­æå¤å°æ°æ®ï¼ä½æ¯æä»¬æ³ä¸æ¬¡å¨é¨è·åè¯¥å¦ä½æä½ï¼è¯´å°åºæä»¬åªæ¯æ³è·å position ~ limit ä¹é´çæ°æ®ï¼åªéè¦åä¸ä¸ªå¾ªç¯ limit > position å°±ä¸ç´è·åå°±è¡äº\n\nwhile (byteBuffer.limit() > byteBuffer.position()) {\n\tSystem.out.println(byteBuffer.get());\n}\n\n\nä½æ¯è¿ç§æä½ä¹å¤ªç¹çäºï¼Buffer ä¹ä¸ºæä»¬æä¾äºç¸å³ç APIã\n\nremaining()ï¼è¿åçç»ææ¯ limit - positionãé£æä»¬å¨å¾ªç¯ä¸­åªéè¦ remaining() > 0 å°±å¯ä»¥äºã\n\npublic class TestBuffer {\n    public static void main(String[] args) {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(10);\n\n\n        byteBuffer.put((byte)5);\n        byteBuffer.put((byte)7);\n        byteBuffer.put((byte)2);\n        byteBuffer.put((byte)6);\n        byteBuffer.put((byte)4);\n\n\n        // å°limit = position\n        // å°position = 0\n        byteBuffer.flip();\n\n\t// å¦ælimit-positionä¸ä¸º0å°±ä¸ç´æå°\n        while (byteBuffer.remaining() > 0) {\n            System.out.println(byteBuffer.get());\n        }\n\n    }\n}\n\n\nhasRemainingä¹å°±æ¯ return remaining() > 0\n\npublic class TestBuffer {\n    public static void main(String[] args) {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(10);\n\n\n        byteBuffer.put((byte)5);\n        byteBuffer.put((byte)7);\n        byteBuffer.put((byte)2);\n        byteBuffer.put((byte)6);\n        byteBuffer.put((byte)4);\n\n\n        // å°limit = position\n        // å°position = 0\n        byteBuffer.flip();\n\t// å¦ælimit-positionä¸ä¸º0å°±ä¸ç´æå°\n        while (byteBuffer.hasRemaining()) {\n            System.out.println(byteBuffer.get());\n        }\n    }\n}\n\n\n\n# 3. Channel\n\nåæä»ç»äº Bufferï¼æä»¬ç¥éäº io æ¶çæ°æ®é½æ¯æ¾å¨ Buffer ä¸­çï¼é£ä¹æ°æ®ä»åªéæ¥ï¼NIO ç io æ¯åºäºåçï¼é£å°±è¯å®ä¸è½ä½¿ç¨ stream äºï¼è¿éä½¿ç¨çæ¯ Channelï¼ééï¼\n\nNIO å®ç°äºåç§ééï¼\n\n 1. FIleChannel ï¼æä»¶ééï¼ç¨äºæä»¶ ioï¼æ æ³ä½¿ç¨ io å¤è·¯å¤ç¨ã\n 2. DatagramChannel ï¼UDP ééï¼éè¿ UDP è¯»åç½ç»ä¸­çæ°æ®ã\n 3. SocketChannel ï¼TCP ééï¼éè¿ TCP è¯»åç½ç»ä¸­çæ°æ®ã\n 4. ServerSocketChannel ï¼çå¬ TCP ééã\n\n\n# 3.1 æä»¶ IO éé\n\nNIO åä¸éå¯¹æä»¶ IO ç Channel åªæ FileChannel\n\njava.nio åä¸ç FileChannel æä¾äºå¾å¤è· java.io åç±»ä¼¼çåè½ï¼æ¬è´¨ä¸é½æ¯è¯»åæä»¶ï¼åºå«å°±æ¯ä¸ä¸ªåºäºåï¼ä¸ä¸ªåºäºæµã\n\né¦åï¼FileChannel æ¯éè¿æä»¶è·åçï¼Channel ä¹æä»¥å«åééä¸æ¯æ²¡æåå çï¼å®ä¸ä»éè¦è¿æ¥æä»¶è·ååå®¹ï¼è¿éè¦è¿æ¥ç¼å­ï¼åªæå°æ°æ®ç»ç¼å­ï¼å¼åäººåæè½éè¿ç¼å­æ¥æä½æä»¶ãé£ä¹ä½¿ç¨ FileChannel æä¸¤æ­¥ï¼\n\n 1. éè¿æä»¶è·å FileChannel\n 2. å°ééï¼FileChannelï¼ä¸ç¼å­ï¼ByteBufferï¼è¿æ¥ã\n\nFileChannel fileChannel = new RandomAccessFile("NIOæµè¯.txt", "rw").getChannel();\nByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n\n// å°æä»¶ä¸­çåå®¹è¯»åå°ByteBufferä¸­\nfileChannel.read(byteBuffer);\n\n// å°ByteBufferä¸­çåå®¹åå¥å°ééä¸­\nfileChannel.write(byteBuffer);\n\n\næ³¨æ ï¼å¨ä½¿ç¨ Buffer å®æè¯»åæä½æ¶ï¼è¯·æ³¨æè¯»åæ¨¡å¼çè½¬æ¢ã\n\nä»¥ä¸ä»£ç ä¸ºè¯»åä¸ä¸ªæä»¶ä¸­çåå®¹ï¼å°å®ä»¬æå°åºæ¥ï¼\n\npublic class TestFileChannel {\n    public static void main(String[] args) throws Exception {\n        FileChannel fileChannel = new RandomAccessFile("NIOæµè¯.txt", "rw").getChannel();\n        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n\n\t// å°fileChannelä¸­çåå®¹è¯»åå°byteBuffer\n        while (fileChannel.read(byteBuffer) != -1) {\n\t    // åæ¢ä¸ºè¯»æ¨¡å¼ \n            byteBuffer.flip();\n            while (byteBuffer.hasRemaining()) {\n                char b = (char) byteBuffer.get();\n                if (b == \' \') {\n                    continue;\n                }\n                System.out.print(b);\n            }\n\t    // åæ¢ä¸ºåæ¨¡å¼\n            byteBuffer.clear();\n        }\n\t// æä½æ°æ®åè®°å¾å³é­å¦.\n\tfileChannel.close();\n    }\n}\n\n\næ³¨æï¼FileChannel æ¯æ²¡æå¤è·¯å¤ç¨è¿ä¸ªåè½çï¼ä¸ºå¥ï¼\n\né¦åççå¤è·¯å¤ç¨æ¯ä¸ºäºè§£å³ä»ä¹é®é¢ï¼å¤è·¯å¤ç¨ä½¿å¾ä¸ä¸ªçº¿ç¨å¯ä»¥çæ§å¤ä¸ªè¿æ¥ï¼å¦æä¸ä¸ªå®¢æ·è¿æ¥å°æå¡ç«¯ç»æå¥äºä¹ä¸å¹²å°±å¹²ç­ï¼é£ä¹çº¿ç¨å°±ä¸æ­çå®ï¼å¦ææå¶ä»çè¿æ¥åèµ·äºè¯»äºä»¶æèåäºä»¶ï¼çº¿ç¨å°±å»å¤çææ´»çè¿æ¥ãå¯ä»¥çå°å¤è·¯å¤ç¨æ¯ä¸ºäºè§£å³æµæ°å®¢æ·ç«¯è¿æ¥åä¸è¿è¡æä½çé®é¢ï¼èæä»¶ io æ¯å®å¨å¼åäººåæä½çï¼ä½ æ³ä»ä¹æ¶åè¯»åå°±ä»ä¹æ¶åè¯»åï¼ä¸»å¨æå¨ä½ ï¼ä¸ç®¡å«äººçäºï¼æä»¥è¯´æä»¶ io æ²¡æå¤è·¯å¤ç¨çåè½ã\n\nFileChannel é¤äºç®åç read å write æ¹æ³ä¹å¤è¿æå¶ä»çæ¹æ³ï¼\n\næ¹æ³                       åè½\nposition(int position)   æå®ä½ç½®è¯»åï¼ä¾å¦æ³å¨æä»¶çç¬¬åä¸ªå­èå¼å§æä½: fileChannel.position(10)\nsize()                   è·åæä»¶çå¤§å°\ntruncate(int size)       æªåæä»¶ï¼truncate(100)ï¼åªè·åæä»¶çå 100 ä¸ªå­è\nforce()                  å¼ºå¶åå¥ï¼å°ééä¸­æªåå¥çæ°æ®å¼ºå¶åå¥æä»¶ã\n\n\n# 3.2 ç½ç» IO éé\n\nNIO åä¸éå¯¹ç½ç» IO æä¾äºä¸ä¸ªééï¼\n\n 1. ServerSocketChannel\n 2. SocketChannel\n 3. DatagramChannel\n\nå®ä»¬é½æ¯åæ­¥éé»å¡ç socket æä½ï¼å¯¹äºåæ­¥éé»å¡ socket æä½å®ç°çç»ä»¶ï¼å®å®éä¸æ¯åºäº socket çï¼åé¨é½æå¯¹åºç socket å¯¹è±¡ï¼æ¬è´¨è¿æ¯æä½ socketï¼ï¼åªæ¯å°è£ä¸ä¸ï¼å¤äºåæ­¥éé»å¡ãååæ°æ®ä¼ è¾è¿ä¸¤ä¸ªç¹ç¹ãä¸æ¹é¢æ¯å ä¸ºééæä»¥æ¥æäºæ°æ®ååä¼ è¾çåè½ï¼åæ¶å®ä»¬é½ç»§æ¿äº SelectableChannelï¼å æ­¤æ¥æäºå¤è·¯å¤ç¨çåè½ã\n\nSelectableChannel ä¸­æä¾äºéç½®æ¹æ³ï¼configureBlocking(boolean block)ï¼è§åç¥æï¼è¿ä¸ªéç½®æ¹æ³æ¯æ§å¶å­ç±»æ¯å¦ä¸ºé»å¡ socket çï¼configBloking(true)ï¼é»å¡ï¼configBloking(false)ï¼éé»å¡ã\n\næä»¥å¨ç¼ç¨æ¶éè¦æ³¨æä¸¤ä¸ªç¹ï¼\n\n 1. åå»ºå¯¹åº Channel åè¦è·ååé¨ç Socket åè¿è¡æä½\n 2. è·å Socket åè®¾ç½®ä¸ä¸è¿ä¸ª Socket é»å¡è¿æ¯éé»å¡ã\n\n# 3.2.1 ServerSocketChannel\n\nServerSocketChannel æä¾äºå ä¸ª API ç¨äºç½ç» IO æä½ï¼\n\næ¹æ³                         ä½ç¨\nServerSocketChannel.open   åå»º ServerSocketChannel\nconfigBloking              ç»§æ¿äº SelectableChannelï¼å³å® socket æ¯å¦é»å¡\nclose                      å³é­ ServerSocketChannel\naccept                     æ¥æ¶è¿æ¥ï¼è¿å SocketChannel å¯¹è±¡\nregister(Selector)         å° ServerSocketChannel æ³¨åå° Selector ä¸\n\n// åå»ºServerSocketChannel\nServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n// è·ååé¨çsocket\nServerSocket socket = serverSocketChannel.socket();\n// è®©socketçå¬8989ç«¯å£\nsocket.bind(new InetSocketAddress(8989));\n// è®¾ç½®serverSocketChannelä¸ºéé»å¡\nserverSocketChannel.configureBlocking(false);\n// å¤çè¿æ¥\n\n// å³é­\n\n\n> é»å¡åéé»å¡æä»ä¹åºå«å¢ï¼\n\nä»¥ä¸æ¯é»å¡ä»£ç ï¼\n\nserverSocketChannel.configureBlocking(true);\nwhile (true) {\n    // è¿æ¥socketChannel\n    SocketChannel socketChannel = serverSocketChannel.accept();\n    if (socketChannel == null) {\n        continue;\n    }\n    System.out.println("æè¿æ¥è¿æ¥äº");\n}\n\n\nå ä¸ºæ¯é»å¡ socketChannelï¼é£ä¹ä»£ç æ§è¡å° accept ä¼å¡çï¼ç´å°æçæ­£ç socket è¿æ¥ãæ¢å¥è¯è¯´ï¼socketChannel æ°¸è¿ä¸ä¼ä¸ºç©ºãè¦ä¹æ°¸è¿ç­å¾ï¼è¦ä¹å°±æ§è¡ æè¿æ¥è¿æ¥äº\n\nä½æ¯éé»å¡ä»£ç ï¼\n\nserverSocketChannel.configureBlocking(false);\nwhile (true) {\n    // è¿æ¥socketChannel\n    SocketChannel socketChannel = serverSocketChannel.accept();\n    if (socketChannel == null) {\n\tSystem.out.println("socketChannelä¸ºç©º");\n        continue;\n    }\n    System.out.println("æè¿æ¥è¿æ¥äº");\n}\n\n\nä»£ç ä¸ä¼é»å¡ï¼åªè¦æ§è¡å° acceptï¼æç®¡ä½ ææ²¡æè¿æ¥å¢ç´æ¥æ§è¡ï¼æ²¡è¿æ¥å°±è¿å Nullï¼ç»§ç»­æ§è¡ä¸é¢çæä½ï¼æä»¥ä»£ç éå¯è½ä¼æå°å¾å¤ socketChannelä¸ºç©ºã\n\næ³¨æï¼è¿åªæ¯ NIO åå¯¹äºé»å¡ IO ä¸éé»å¡ IO çå®ç°ï¼è¿ä¸æ¯ IO å¤è·¯å¤ç¨ã\n\n# 3.2.2 SocketChannel\n\nServerSocketChannel æ¯æå¡ç«¯ï¼SocketChannel æ¯å®¢æ·ç«¯ã\n\næ¢è¨ä¹ï¼ServerSocketChannel è¢«å¨ç­å¾ SocketChannel è¿æ¥ï¼SocketChannel ä¸»å¨è¯·æ± ServerScoketChannel çè¿æ¥ã\n\nSocketChannel çç¹ç¹ï¼\n\n * åºäº TCP çéé\n * å ä¸ºå®ç°äº SelectableChannelï¼æä»¥æ IO å¤è·¯å¤ç¨çåè½\n\nSocketChannel æä¾ç APIï¼\n\næ¹æ³                                  åè½\nSocketChannel.open()                è·å SocketChannel\nSocketChannel.open(SocketAddress)   è·å SocketChannel å¹¶è¿æ¥å°æå¡ç«¯\nconnect(SocketAddress)              å°å¯¹åº socketChannel è¿æ¥å°æå¡ç«¯\nregister(Selector)                  å° SocketChannel æ³¨åå° Selector ä¸\n\n// å¼å¯ä¸ä¸ªSocketChannelå¹¶æå®è¿æ¥å°æ¬æº8989ç«¯å£ä¸ã\nSocketChannel socketChannel = SocketChannel.open();\nsocketChannel.connect(new InetSocketAddress("localhost", 8989));\n\n\næ¹æ³                      åè½\nisOpen()                æµè¯ SocketChannel æ¯å¦ä¸º open ç¶æ\nisConnected()           æµè¯ SocketChannel æ¯å¦å·²ç»è¿æ¥ä¸äº\nisConnectionPending()   æµè¯ SocketChannel æ¯å¦æ­£å¨è¿è¡è¿æ¥\nfinishConnect()         æ ¡éªæ­£å¨è¿è¡å¥æ¥å­è¿æ¥ç SocketChannel æ¯å¦å·²ç»å®æäºè¿æ¥ã\n\nsocketChannel.isOpen(); // æµè¯ SocketChannel æ¯å¦ä¸º open ç¶æ\nsocketChannel.isConnected(); //æµè¯ SocketChannel æ¯å¦å·²ç»è¢«è¿æ¥\nsocketChannel.isConnectionPending(); //æµè¯ SocketChannel æ¯å¦æ­£å¨è¿è¡\nè¿æ¥\nsocketChannel.finishConnect(); //æ ¡éªæ­£å¨è¿è¡å¥æ¥å­è¿æ¥ç SocketChannelæ¯å¦å·²ç»å®æè¿æ¥\n\n\næ¹æ³                  åè½\nread(ByteBuffer)    å° socket ä¸­çæ°æ®è¯»å¥ç¼å­ä¸­\nwirte(ByteBuffer)   å°ç¼å­ä¸­çæ°æ®åå¥ socket\n\nå¦æå¨åé¢è®¾ç½®ä¸ºé»å¡æ¨¡å¼ï¼é£ä¹ read æ¹æ³å wirte æ¹æ³ä¹ä¼æ¯é»å¡çï¼å°±æ¯è¿ä¸ªçº¿ç¨ä¸ç´ç­å¾ç´å° socket ä¸­ææ°æ®äºæååºãå¦ææ¯éé»å¡ï¼æ ¹æ¬ä¸å¸¦ç­çç´æ¥è¿åã\n\nè¿ä¸¤ä¸ªChannelè¯´å®å°±å¯ä»¥æ¥ä¸ä¸ªå°æ¡ä¾äºï¼å¦ä¸ä¸ºNIOçå·ä½ä¾å­ï¼\n\n\n\nNIOæ¯å¤è·¯å¤ç¨ï¼ä¹å°±æ¯æå¡ç«¯éè¿ selector æ¥éæ©ä¸åçå®¢æ·ç«¯ãæ³è¦selectoréæ©å®¢æ·ç«¯ï¼è¯å®è¦å®¢æ·ç«¯åselectorç»å®ãä»å¾ä¸å¯ä»¥çå°ï¼ç»å®è¿ä»¶äºå¹¶ä¸æ¯å®¢æ·ç«¯åçï¼èæ¯å®¢æ·ç«¯è¿æ¥åï¼æå¡ç«¯æ¿å°å®¢æ·ç«¯çsocketä¹åï¼å°å¶ç»å®å¨selectorä¸ã\n\næå¡ç«¯ä»£ç  ï¼\n\npackage nio.ss;\n \nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.*;\nimport java.util.Iterator;\n \npublic class Server {\n    public static void main(String[] args) {\n        try {\n            //1.è·åç®¡é\n            ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n            //2.è®¾ç½®éé»å¡æ¨¡å¼\n            serverSocketChannel.configureBlocking(false);\n            //3.ç»å®ç«¯å£\n            serverSocketChannel.bind(new InetSocketAddress(8888));\n            //4.è·åéæ©å¨\n            Selector selector = Selector.open();\n            //5.å°ééæ³¨åå°éæ©å¨ä¸ï¼å¹¶ä¸å¼å§æå®çå¬çæ¥æ¶äºä»¶\n            serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\n            //6.è½®è¯¢å·²ç»å°±ç»ªçäºä»¶\n            while (selector.select() > 0){\n                System.out.println("å¼å¯äºä»¶å¤ç");\n                //7.è·åéæ©å¨ä¸­æææ³¨åçééä¸­å·²åå¤å¥½çäºä»¶\n                Iterator<SelectionKey> it = selector.selectedKeys().iterator();\n                //8.å¼å§éåäºä»¶\n                while (it.hasNext()){\n                    SelectionKey selectionKey = it.next();\n                    System.out.println("---\x3e"+selectionKey);\n                    //9.å¤æ­è¿ä¸ªäºä»¶å·ä½æ¯å¥\n                    if (selectionKey.isAcceptable()){\n                        //10.è·åå½åæ¥å¥äºä»¶çå®¢æ·ç«¯éé\n                        SocketChannel socketChannel = serverSocketChannel.accept();\n                        //11.åæ¢æéé»å¡æ¨¡å¼\n                        socketChannel.configureBlocking(false);\n                        //12.å°æ¬å®¢æ·ç«¯æ³¨åå°éæ©å¨\n                        socketChannel.register(selector,SelectionKey.OP_READ);\n                    }else if (selectionKey.isReadable()){\n                        //13.è·åå½åéæ©å¨ä¸çè¯»\n                        SocketChannel socketChannel = (SocketChannel) selectionKey.channel();\n                        //14.è¯»å\n                        ByteBuffer buffer = ByteBuffer.allocate(1024);\n                        int len;\n                        while ((len = socketChannel.read(buffer)) > 0){\n                            buffer.flip();\n                            System.out.println(new String(buffer.array(),0,len));\n                            //æ¸é¤ä¹åçæ°æ®ï¼è¦çåå¥ï¼\n                            buffer.clear();\n                        }\n                    }\n                    //15.å¤çå®æ¯åï¼ç§»é¤å½åäºä»¶\n                    it.remove();\n                }\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n}\n\n\nå®¢æ·ç«¯ï¼\n\npackage nio.ss;\n \nimport java.io.IOException;\nimport java.net.InetSocketAddress;\nimport java.nio.ByteBuffer;\nimport java.nio.channels.SocketChannel;\nimport java.util.Scanner;\n \npublic class Client {\n    public static void main(String[] args) {\n        try {\n            SocketChannel socketChannel = SocketChannel.open(new InetSocketAddress("127.0.0.1",8888));\n            socketChannel.configureBlocking(false);\n            ByteBuffer buffer = ByteBuffer.allocate(1024);\n            Scanner scanner = new Scanner(System.in);\n            while (true){\n                System.out.print("è¯·è¾å¥:");\n                String msg = scanner.nextLine();\n                buffer.put(msg.getBytes());\n                buffer.flip();\n                socketChannel.write(buffer);\n                buffer.clear();\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n}\n\n\n# 3.2.3 DatagramChannel\n\næ¯ä¸ä¸ª SocketChannel å¯¹åºä¸ä¸ª Socketï¼æ¯ä¸ä¸ª SewrverSocketChannel å¯¹åºä¸ä¸ª ServerSocket\n\næ¯ä¸ä¸ª DatagramChannel ä¹å¯¹åºä¸ä¸ª DatagramSocketã\n\nDatagramChannel æ¯ NIO æä¾çåºäº UDP çè¿æ¥ééã\n\nAPI ï¼\n\næ¹æ³                                åè½\nDatagramChannel.open()            åå»ºä¸ä¸ª DatagramChannel\nsocket()                          è¿å DatagramChannel åé¨ç DatagramSocket\nconnect(SocketAddress)            è¿æ¥ï¼UDP å¹¶æ²¡æ è¿æ¥ è¿ä¸è¯´ï¼è¿éåªæ¯å£°æä¸ä¸å¾åªéåéæ°æ®\nreceive(ByteBuffer)               æ¥æ¶æ°æ®ï¼å°æ°æ®æ¾å° ByteBuffer ä¸­ï¼æ³¨ææ¯ ByteBuffer ä¸æ¯ Bufferï¼\nsend(ByteBuffer, SocketAddress)   å SocketAddress å¯¹åºç IP&ç«¯å£åé ByteBuffer ä¸­çæ°æ®\nregister(Selector)                å° DatagramChannel æ³¨åå° Selector ä¸\n\nä¾å­ï¼ä½¿ç¨å°ç¡è°·çä¾å­ï¼ï¼\n\npublic class TestDatagramChannel {\n    /**\n     * ååç datagram\n     *\n     * @throws IOException\n     * @throws InterruptedException\n     */\n    @Test\n    public void sendDatagram() throws IOException, InterruptedException {\n        DatagramChannel sendChannel= DatagramChannel.open();\n        InetSocketAddress sendAddress= new InetSocketAddress("127.0.0.1", 9999);\n        while (true) {\n            sendChannel.send(ByteBuffer.wrap("åå".getBytes("UTF-8")), sendAddress);\n            System.out.println("ååç«¯åå");\n            Thread.sleep(1000);\n        }\n    }\n    /**\n     * æ¶åç«¯\n     *\n     * @throws IOException\n     */\n    @Test\n    public void receive() throws IOException {\n        DatagramChannel receiveChannel= DatagramChannel.open();\n        InetSocketAddress receiveAddress= new InetSocketAddress(9999);\n        receiveChannel.bind(receiveAddress);\n        ByteBuffer receiveBuffer= ByteBuffer.allocate(512);\n        while (true) {\n            receiveBuffer.clear();\n            SocketAddress sendAddress= receiveChannel.receive(receiveBuffer);\n            receiveBuffer.flip();\n            System.out.print(sendAddress.toString() + " ");\n            System.out.println(Charset.forName("UTF-8").decode(receiveBuffer));\n        }\n    }\n    /**\n     * åªæ¥æ¶ååé 9999 çæ°æ®å\n     *\n     * @throws IOException\n     */\n    @Test\n    public void testConect1() throws IOException {\n        DatagramChannel connChannel= DatagramChannel.open();\n        connChannel.bind(new InetSocketAddress(9998));\n        connChannel.connect(new InetSocketAddress("127.0.0.1",9999));\n        connChannel.write(ByteBuffer.wrap("åå".getBytes("UTF-8")));\n        ByteBuffer readBuffer= ByteBuffer.allocate(512);\n        while (true) {\n            try {\n                readBuffer.clear();\n                connChannel.read(readBuffer);\n                readBuffer.flip();\n                System.out.println(Charset.forName("UTF-8").decode(readBuffer));\n            }catch(Exception e) {\n            }\n        }\n    }\n}\n\n\n\n# 4. Selector\n\nè³æ­¤ï¼java.nio åä¸çä¸¤ä¸ªéè¦ç»ä»¶å·²ç»ä»ç»å®æ¯ï¼ä½æ¯ä½ ä¼åç°å¶å®å¹¶æ²¡æä»ç» IO å¤è·¯å¤ç¨ï¼åªæ¯æµæµæäºä¸ä¸é»å¡ä¸éé»å¡ãæ¯å ä¸º Java ç NIO çå¤è·¯å¤ç¨æ¯åºäº Selector å®ç°çã\n\nSelector ä¸è¬ç§°ä¸ºéæ©å¨ï¼ä¹å¯ä»¥ç¿»è¯ä¸ºå¤è·¯å¤ç¨å¨ãå®æ¯ Java NIO æ ¸å¿ç»ä»¶ä¸­çä¸ä¸ªï¼ç¨äºæ£æ¥å¤ä¸ª Channel æ¯å¦åç è¯»/å æä½ï¼å¯ä»¥å®ç°ä¸ä¸ªçº¿ç¨çå¬å¤ä¸ªè¿æ¥çåè½ï¼ä¹å°±æ¯ IO å¤è·¯å¤ç¨ã\n\næ¦è¿°ï¼åå¦ç°å¨æå¡ç«¯ä¸æ 5 ä¸ªå®¢æ·ç«¯è¿æ¥ï¼ä½æ¯å®ä»¬ 5 ä¸ªå¹¶ä¸æ¯ä¸ç´é½æäºä»¶éè¦å¤ççï¼å¾æå¯è½ä¸ç´ç©ºç¼ºï¼å¦ææ¯ä¸ªè¿æ¥é½åå»ºä¸ä¸ªçº¿ç¨ï¼é£ä¹å®å¨å¤ªæµªè´¹äºãå°±åªä½¿ç¨ä¸ä¸ªçº¿ç¨çå¬å®ä»¬å°±è¡äºãæ²¡æè¯»ãåäºä»¶çè¿æ¥æä»¬ä¸ç®¡å®ï¼æä¸ªè¿æ¥æè¯»åæä½æ¶å°±ä¼éç¥çº¿ç¨è®©å®å¤çã\n\n\n# 4.1 SelectableChannel\n\nåé¢è¯´äºï¼åªæå®ç°äº SelectableChannel ç Channel ééææå¤è·¯å¤ç¨çåè½ï¼èå¤è·¯å¤ç¨çåè½æ¯ Selector å®ç°çï¼é£ä¹ç«å¨å¼åèçè§åº¦ï¼è¯´ç½äºå°±æ¯ï¼FileChannel æ²¡æç»å® Selector ç register æ¹æ³ã\n\npublic abstract class SelectableChannel {\n\t// ç»å®\n\tpublic abstract SelectionKey register(Selector sel, int ops, Object att)\n        \t\t\t\t\tthrows ClosedChannelException;\n}\n\n\n\n\n\n# 4.2 SelectionKey\n\nChannel æ³¨åå° Selector ä¸ä¹åå¹¶ä¸æ¯åçä»»ä½äºé½ä¼å¼èµ· Selector çæ³¨æï¼è¿æ¯ Channel èªå·±å³å®çï¼ä¾å¦ å¯è¯»ãå¯åãå¯è¿æ¥ãå¯æ¥å è¿åç§ç¶æï¼å½ Channel éæ©ä»¥å¯è¯»äºä»¶æ³¨åå° Selector ä¸æ¶ï¼åªæå½ Channel åçè¯»äºä»¶æ¶æä¼éç¥ Selector æ¥å¤çã\n\nè¿åç§ç¶æé½å¯¹åºå¸¸éï¼\n\nç¶æ           ç¶æ     å¸¸é       è¡¨ç¤º\nOP_READ      è¯»æä½    1 << 0   è¯»å°±ç»ªäºä»¶ï¼è¡¨ç¤ºééä¸­å·²ç»æäºå¯è¯»çæ°æ®ï¼å¯ä»¥æ§è¡è¯»æä½äº\nOP_WRITE     åæä½    1 << 2   åå°±ç»ªäºä»¶ï¼è¡¨ç¤ºå·²ç»å¯ä»¥åééåæ°æ®äº\nOP_CONNECT   è¿æ¥æä½   1 << 3   è¿æ¥å°±ç»ªäºä»¶ï¼è¡¨ç¤ºå®¢æ·ç«¯ä¸æå¡å¨çè¿æ¥å·²ç»å»ºç«æå\nOP_ACCEPT    æ¥æ¶æä½   1 << 4   æ¥æ¶è¿æ¥ç»§ç»­äºä»¶ï¼è¡¨ç¤ºæå¡å¨çå¬å°äºå®¢æ·è¿æ¥ï¼æå¡å¨å¯ä»¥æ¥æ¶è¿ä¸ªè¿æ¥äº\n\néè¦è®°åï¼ä¸éè¦ï¼æä¸ä¸ªç±»éé¢æè¿äºå¸¸éï¼\n\npublic abstract class SelectionKey {\n\t// è¯»æä½\n\tpublic static final int OP_READ = 1 << 0;\n\t// åæä½\n\tpublic static final int OP_WRITE = 1 << 2;\n\t// è¿æ¥æä½\n\tpublic static final int OP_CONNECT = 1 << 3;\n\t// æ¥åæä½\n\tpublic static final int OP_ACCEPT = 1 << 4;\n}\n\n\næä»¥åªéè¦è°ç¨ channel.register(Selector, SelectionKey.OP_xxx)å°±å¯ä»¥å° Channel ç»å®å° Selector ä¸ã\n\nSelectionKey è¿ä¸ªç±»çä¸ä¸åç§°å«åéæ©é®ï¼å½Selectoréæ©åï¼ææçå°±ç»ªè¿æ¥é½ä¼è¢«å°è£ä¸ºSelectionKey ï¼æä»¬æ¿å°SelectionKeyä¹åå¯ä»¥å¤æ­ä»ä¹äºä»¶åå¤å¥½äºï¼ç¶åå°±å¯ä»¥è·åSocketChannelè¿è¡å¤çã\n\n\n# 4.3 Selector\n\nä»ç»äºåç½®ç¥è¯åï¼ç»äºè¿æ¥äºSelectorãå¨è¿éæä¼ä½¿ç¨ServerSocketChannelåSocketChannelä¸¾ä¾ã\n\nSelectorçå·¥ä½åçåé¢å·²ç»ä»ç»äºå¾å¤éäº ï¼ä½¿ç¨ä¸ä¸ªçº¿ç¨å¯¹å¤ä¸ªè¿æ¥è¿è¡çå¬ï¼æäºä»¶å°±å¤çï¼æ²¡äºä»¶å°±ç­å¾ã\n\n\n\nSelectoræä¾çAPIï¼\n\næ¹æ³                         ä½ç¨\nSelector.open()            åå»ºä¸ä¸ªéæ©å¨\nint select()               éæ©åå¤å¥½çè¿æ¥ï¼æ²¡æè¿æ¥ä¼é»å¡\nint select(long timeout)   å¨timeoutæ¶é´åéæ©åå¤å¥½çè¿æ¥\nint selectNow()            éæ©åå¤å¥½çè¿æ¥ï¼æ²¡æè¿æ¥ä¸ä¼é»å¡\nSet selectedKey()          è¿åå°±ç»ªçè¿æ¥\n\n> select()æ¹æ³è¿åç int å¼ï¼è¡¨ç¤ºæå¤å°ééå·²ç»å°±ç»ªï¼æ´åç¡®çè¯´ï¼æ¯ä¸ä¸æ¬¡selectä¸è¿ä¸æ¬¡selectæ¹æ³ä¹é´æå¤å°æ°çè¿æ¥è¿å¥å°±ç»ªç¶æã\n\nä¸æ¦è°ç¨selectæ¹æ³å¹¶ä¸è¿åå¼ä¸ä¸º0ï¼æå°±ç»ªçè¿æ¥ï¼æ¶ï¼å¯ä»¥è°ç¨selectedKey()æ¹æ³è·å¾å°±ç»ªè¿æ¥ã\n\næ¿å°è¿æ¥çéåä¹åå²ä¸æ¯éå¿ææ¬²ä¸ºææ¬²ä¸ºï¼ä½ å¯ä»¥ä½¿ç¨if else æ¥è¯¢é®æ¯ä¸ä¸ªè¿æ¥å¯¹åºçäºä»¶ï¼âä½ çè¯»å°±ç»ªäºåï¼ââä½ çåå°±ç»ªäºåï¼ââä½ çè¿æ¥å°±ç»ªäºåï¼â......\n\næä»¥ï¼Java NIOçç¼ç¨æ­¥éª¤ï¼\n\npublic class TestSelector {\n    public static void main(String[] args) throws IOException {\n        // è·åè¿æ¥\n        Selector selector = Selector.open();\n        // è·åæå¡ç«¯\n        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n        // æå¡ç«¯çå¬8989ç«¯å£\n        serverSocketChannel.bind(new InetSocketAddress("127.0.0.1", 8989));\n        // ä¸ Selector ä¸èµ·ä½¿ç¨æ¶ï¼Channel å¿é¡»å¤äºéé»å¡æ¨¡å¼ä¸\n        serverSocketChannel.configureBlocking(false);\n        // å°æå¡ç«¯ç»å®å°éæ©å¨ä¸ï¼æå´è¶£çäºä»¶ä¸º è¿æ¥ã\n        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);\n        System.out.println("æå¡ç«¯å°±ç»ª");\n        while (true) {\n            // æ¥çæ¯å¦æå°±ç»ªè¿æ¥\n            int select = selector.select();\n\n            // è·åè¿1såçææå°±ç»ªè¿æ¥ï¼éå\n            Set<SelectionKey> selectionKeys = selector.selectedKeys();\n            Iterator<SelectionKey> iterator = selectionKeys.iterator();\n            \n            while (iterator.hasNext()) {\n                SelectionKey selectionKey = iterator.next();\n                // å¦æéæ©é®æ¥æ¶äºä»¶å°±ç»ª\n                if (selectionKey.isAcceptable()) {\n                    SocketChannel socketChannel = serverSocketChannel.accept();\n                    // å¤çsocketé»è¾\n\n                } else if (selectionKey.isConnectable()) {\n                    // å¦æéæ©é®è¿æ¥äºä»¶å°±ç»ª\n                    SocketChannel channel = (SocketChannel) selectionKey.channel();\n                    // å¤çSocketChanneläºä»¶\n\n                } else if (selectionKey.isReadable()) {\n                    // å¦æéæ©é®è¯»äºä»¶å°±ç»ª\n                    SocketChannel channel = (SocketChannel) selectionKey.channel();\n                    ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n                    channel.read(byteBuffer);\n                    // ä»bufferä¸­è¯»åæ°æ®\n                    // ......\n\n                } else if (selectionKey.isWritable()) {\n                    // å¦æéæ©é®åäºä»¶å°±ç»ª\n\n                }\n                // å¤çå®è¿ä¸ªè¿æ¥åå°å®ç§»é¤ã\n                iterator.remove();\n            }\n        }\n\n    }\n}\n\n\n> ä¸ Selector ä¸èµ·ä½¿ç¨æ¶ï¼Channel å¿é¡»å¤äºéé»å¡æ¨¡å¼ä¸ï¼ä¸ºä»ä¹ï¼\n> \n> åå¦ç°å¨å5ä¸ªå°±ç»ªçè¿æ¥è¢«æ¿åºæ¥äºï¼éåç¬¬ä¸ä¸ªsocketChannelæ¶ï¼è°ç¨acceptçªç¶é»å¡äºï¼ä½ è®©å¶ä»çSocketChannelæä¹æ§è¡ï¼\n\n\n\n\n# 5. IOå¤è·¯å¤ç¨çå ç§æ¨¡å¼\n\nä½ å¨è¯»ä¸é¢IOå¤è·¯å¤ç¨ä»£ç çæ¶åæ¯å¦ä¼æè§éµéµæ åï¼å®éä¸æåçä¹å¾æ åï¼ä¸ºä»ä¹ï¼éå + if/elseï¼tmdå¤ªæ¶å¿äºï¼ä¸ºä»ä¹è¦æææå°±ç»ªçè¿æ¥æ¿è¿æ¥éåå¢ï¼èä¸è¿æ¯è¾¹éåè¾¹if/elseå°±æ´æ¶å¿äºã\n\nè¿æ¶åå°±å¼åºäºIOå¤è·¯å¤ç¨çå ç§æ¨¡å¼ï¼selectãpollãepoll\n\n 1. selectæ¨¡å¼ ï¼å½è¿äºè¿æ¥åºç°æç§ç¶ææ¶ï¼æä»¬å¹¶ä¸ç¥éåºç°äºä»ä¹ç¶æï¼ï¼åªè½å°ææå°±ç»ªè¿æ¥æ¿åºæ¥éåè¯¢é®ï¼âä½ å°±ç»ªäºï¼ä½ æ¯ä»ä¹ç¶æåï¼âï¼âä½ ä¹å°±ç»ªäºï¼ä½ æ¯ä»ä¹ç¶æåï¼â....å ä¸ºéè¦éåææè¿æ¥ï¼æä»¥æ¶é´å¤æåº¦ä¸ºO(n)ï¼åæ¶å­å¨æå¤§è¿æ¥æ°éå¶ã\n 2. pollæ¨¡å¼ ï¼åä¸ï¼ä½æ¯ç±äºä½¿ç¨é¾è¡¨æä»¥æ²¡ææå¤§è¿æ¥æ°éå¶ã\n 3. epollæ¨¡å¼ ï¼éç¨äºä»¶éç¥æ¹å¼ï¼ä¸æ¯æå¡ç«¯å»è¯¢é®è¿æ¥çç¶æï¼èæ¯è¿æ¥å°±ç»ªåè§¦ååè°å½æ°ç²¾åéç¥æå¡ç«¯ï¼âæçè¯»äºä»¶å¥½äºï¼ä½ åå¤è¯»å§âï¼âæçåäºä»¶å¥½äºï¼ä½ åå¤åå§âã è¿æ¯å ä¸ºå¨åæ ¸å®ç°ä¸­epollæ¯æ ¹æ®æ¯ä¸ªæä»¶æè¿°ç¬¦ä¸é¢çcallbackå½æ°å®ç°çï¼åªè¦å°±ç»ªå°±ä¼ç´æ¥è°ç¨åè°callbackå½æ°ï¼å®ç°ç²¾åéç¥ï¼è¾¾å°O(1)çæ¶é´å¤æåº¦ã\n\n       SELECT ï¼æ©æçæ¬ï¼         POLL ï¼1.4ï¼              EPOLL ï¼1.5ä¹åï¼\næä½æ¹å¼   éå                    éå                      åè°\nåºå±å®ç°   æ°ç»                    é¾è¡¨                      åå¸è¡¨\nIOæç   éåæ°ç»ä¸­ææChannelï¼æ§è½è¾å·®   éåé¾è¡¨ä¸­ææççChannelï¼æ§è½è¾å·®   ç±æä½ç³»ç»å°åçäºä»¶çChannelå­å°æå¡ç«¯çå°±ç»ªäºä»¶åè¡¨ä¸­ï¼Selectorç´æ¥ä»å°±ç»ªäºä»¶åè¡¨ä¸­è·åæå´è¶£çäºä»¶ï¼ä¸éè¦éåææChannelï¼æ¶é´å¤æåº¦ä¸ºO(1)\næå¤§è¿æ¥   æä¸é                   æ ä¸é                     æ ä¸é\n\n\n# 6. æ»ç»\n\nå¯¹äºJava NIOçä»ç»å°è¿éå°±ç»æäºï¼è³äºjava.nioåä¸çå¶ä»ç±»å°±éè¦ä½ èªå·±å»æ©å±äºãæ»ç»ä¸ä¸æ¬ç¯çåå®¹ï¼\n\n 1. Java NIO çæææ¯New IOï¼æææ¯æä¾çæ°IOåï¼å¯ä»¥å®ç°åæ­¥é»å¡IOãåæ­¥éé»å¡IOãIOå¤è·¯å¤ç¨ã\n    \n    æä½ç³»ç»NIOçæææ¯Non bloking IOï¼åªæ¯åæ­¥éé»å¡IOã\n\n 2. Java çIOå¤è·¯å¤ç¨æ¯ä½¿ç¨ Selectorå®ç°çï¼ä¸ä¸ªChannelé¦åè¦æ³¨åå°Selectoræå¯ä»¥è¢«åç°ã\n\n 3. Selectoréæ©æ¶æ¯æç§âæå´è¶£çäºä»¶âéæ©çï¼æä»¥æä»¬å°æå¡ç«¯ç»å®å°Selectorä¸æ¶å¤§å¤æ°é½ä¼æå®è¿æ¥äºä»¶ã',normalizedContent:'# 1. ioæ¦è¿°\n\nå¨ä»ç»java nio ä¹åï¼åæ¥è¯´ä¸ä¸ä»ä¹æ¯ioã\n\nä»ä¹æ¯ioï¼\n\nç®èè¨ä¹ï¼inputåoutputï¼è¾å¥åè¾åºå°±æ¯ioã\n\næ ¹æ®æä½ç³»ç»çç¥è¯ ï¼ä¸ä¸ªè¿ç¨çå°åç©ºé´ååä¸º ç¨æ·ç©ºé´ãåæ ¸ç©ºé´ãæä»¬å¹³æ¶è¿è¡çåºç¨ç¨åºæ¯å¨ç¨æ·ç©ºé´ä¸­çï¼åªæå½åºç°åå­åéãæä»¶æä½ç­æä½æ¶ æä¼åæ¢ä¸ºåæ ¸ç©ºé´ï¼å¹¶ä¸ç¨æ·ç©ºé´æ¯æ æ³è®¿é®è¿äºèµæºçï¼ç¨æ·è¿ç¨æ³è¦è®¿é®ç³»ç»èµæºå°±å¿é¡»è¦ è¿è¡ç³»ç»è°ç¨ä»ç¨æ·ç©ºé´åæ¢å°åæ ¸ç©ºé´ã\n\nä¸å±ä¸ºä¸ä¸ªæ­¥éª¤ ï¼\n\n 1. ç¨æ·ç©ºé´åèµ·ç³»ç»è°ç¨ï¼ä¾å¦è¿è¡è¯»æä»¶æ¶æ§è¡çreadæ¹æ³ï¼ï¼äº§çä¸­æ­\n 2. åæ ¸ç­å¾ i/o è®¾å¤åå¤å¥½æ°æ®\n 3. åæ ¸å°æ°æ®ä» åæ ¸ç©ºé´ æ·è´å°ç¨æ·ç©ºé´ãï¼æ´åç¡®ç¹æ¯ä»åæ ¸ç©ºé´çç¼å²åºæ·è´å°ç¨æ·ç©ºé´çç¼å²åºï¼\n\né£ä¹å¨ç¨æ·ç©ºé´åèµ·ç³»ç»è°ç¨ç´å°åæ ¸ç©ºé´æ¿å°å¼è¿åç»ä½ è¿ä¸ªæ¶é´æ®µï¼ç¨æ·ç©ºé´æ¯ é»å¡ç­å¾ è¿æ¯ ä¸æ­è½®è¯¢ï¼å°±äº§çäºé»å¡ioãéé»å¡ioè¿äºä¸åçioæ¹å¼ãlinuxä¸­åä¸ºäºç§ioæ¹å¼ ï¼\n\n 1. åæ­¥é»å¡ i/o ï¼åºç¨ç¨åºåèµ· read è°ç¨åï¼ä¼ä¸ç´é»å¡ï¼ç´å°åæ ¸ææ°æ®æ·è´å°ç¨æ·ç©ºé´ã\n 2. åæ­¥éé»å¡ i/o ï¼åºç¨ç¨åºåèµ·readåç«å»è¿åå¹¶ä¸æ­è¯¢é®ã\n 3. i/o å¤è·¯å¤ç¨ ï¼çº¿ç¨é¦ååèµ· select è°ç¨ï¼è¯¢é®åæ ¸æ°æ®æ¯å¦åå¤å°±ç»ªï¼ç­åæ ¸ææ°æ®åå¤å¥½äºï¼ç¨æ·çº¿ç¨ååèµ· read è°ç¨ãread è°ç¨çè¿ç¨ï¼æ°æ®ä»åæ ¸ç©ºé´ -> ç¨æ·ç©ºé´ï¼è¿æ¯é»å¡çã\n 4. ä¿¡å·é©±å¨ i/o ï¼åºç¨ç¨åºåèµ·readè°ç¨åå»åèªå·±çäºæï¼åæ ¸åå¤å¥½æ°æ®åååºsigioä¿¡å·éç¥åºç¨ç¨åºå·²ç»åå¤å¥½æ°æ®ï¼ åºç¨è¿ç¨æ¶å°ä¹åå¨ä¿¡å·å¤çç¨åºä¸­è°ç¨ recvfrom å°æ°æ®ä»åæ ¸å¤å¶å°åºç¨è¿ç¨ä¸­ã\n 5. å¼æ­¥ i/o ï¼åºç¨ç¨åºåèµ·readè°ç¨åå»åèªå·±çäºæï¼åæ ¸å°æ°æ®ä»åæ ¸ç©ºé´æ·è´å°ç¨æ·ç©ºé´ååèµ·signalä¿¡å·éç¥åºç¨ç¨åºå·²ç»åå¤å¥½æ°æ®ã\n\nä¹ä¸çä¿¡å·é©±å¨ioåå¼æ­¥ioä¸æ¯ä¸æ ·åï¼å¶å®ä¸ç¶ï¼\n\n * ä¿¡å·é©±å¨io ï¼åèµ·ä¿¡å·éç¥æ¶ï¼æ°æ®å¨åæ ¸æï¼åºç¨ç¨åºéè¦ææ°æ®æ·è´å°ç¨æ·æ\n * å¼æ­¥io ï¼åèµ·ä¿¡å·æ¶æ°æ®å·²ç»å¨ç¨æ·æäºã\n\nå¨javaéé¢æ²¡æè¿ä¹å¤ioæ¨¡å¼ï¼åªæbioãnioãaioã\n\n 1. bio ï¼å¯¹åº åæ­¥é»å¡i/oã\n 2. nio ï¼å¯¹åº i/oå¤è·¯å¤ç¨ã\n 3. aio ï¼å¯¹åºå¼æ­¥i/oã\n\nbioæ¯fileinputstreamãoutputstreamè¿ç§ï¼nioæ¯ buffer + channel + selector è¿ä¸å¥ã\n\næ¬ç¯æç« å°±æ¯éå¯¹äº java nio ç api è¿è¡è®²è§£ã\n\n> åå²çº¿\n\njava ç nio æ¨¡åå¯¹åºæä½ç³»ç»ç io å¤è·¯å¤ç¨æ¨¡åï¼java.nioåä¸æä¾çç±»ä¸ä»å¯ä»¥å®ç°é»å¡ioãéé»å¡ioï¼è¿å¯ä»¥å®ç°ioå¤è·¯å¤ç¨ã\n\n\n\n> javaçioå¤è·¯å¤ç¨ï¼å¯ä»¥ä½¿ç¨ä¸ä¸ªçº¿ç¨å¤çå¤ä¸ªå®¢æ·ç«¯è¯·æ±ãå®¢æ·ç«¯åéçè¯·æ±ä¼æ³¨åå°å¤è·¯å¤ç¨å¨ selector ä¸ï¼ç± selector è½®è¯¢åä¸ªå®¢æ·ç«¯çè¯·æ±å¹¶è¿è¡å¤çã\n\njava ç nio æä¾äºå ä¸ªéè¦çç»ä»¶ï¼\n\n * buffer ï¼ç¼å²åº\n * channel ï¼ç®¡é\n * selector ï¼å¤è·¯å¤ç¨å¨ï¼å¹¶ä¸æ¯ææç io é½å¯ä»¥ä½¿ç¨ selectorï¼\n\n\n# 2. buffer\n\nå¨ä¸ä¸ç¯ä¸­æä»¬æå°ï¼bio çæä½é½æ¯åºäºæµçï¼è nio çæä½é½æ¯åºäºç¼å­çã\n\nä¹å°±æ¯è¯´ï¼å¨ nio ä¸­ææçæä½é½æ¯ç¨ç¼å²å¤ççï¼ä¸ç®¡æ¯è¯»è¿æ¯åï¼é½ä½¿ç¨ buffer å®æã\n\nå¨ nio ä¸­ï¼ææçç¼å²åºç±»åé½ç»§æ¿äºæ½è±¡ç±» bufferï¼æå¸¸ç¨çæ¯ bytebufferï¼å¯¹äº java çåºæ¬æ°æ®ç±»åï¼åºæ¬é½æä¸ä¸ªå·ä½ç buffer å®ç°ç±» ä¸ä¹å¯¹åºãæå¸¸ç¨çæ¯ bytebufferã\n\n\n\nå¶å® buffer æ¯ä½¿ç¨æ°ç»å®ç°çï¼ä¹å°±æ¯è¯´æä»¬è¯»åºæ¥çæèåå¥çæ°æ®ï¼é½æ¯åå­è¿æ°ç»éé¢ã\n\nä¸¾ä¾ï¼å¦ä¸ä¸º intbuffer éé¢å­æ¾æ°æ®çæ°ç»ã\n\n\n\nç°å¨åå° bufferï¼buffer ä¸­æå ä¸ªéå¸¸éè¦çåéï¼\n\n 1. capacity ï¼è¿ä¸ª buffer çå®¹éï¼ä¹å°±æ¯ä¸æ¬¡æå¤æ¾è¿å»å¤å°ä¸è¥¿ãè¿ä¸ªåéå¨ buffer åå»ºæ¶æå®ï¼ä¸æ æ³æ¹åã\n 2. position ï¼å½åæä½æ°æ®çä¸æ ã\n 3. limit ï¼å½åæä½æå¤§æä½å°åªä¸ªä¸æ ï¼é»è®¤ä¸º capacityã\n 4. mark ï¼æ è®°\n\nä¹å¾å¥½çè§£ï¼ç±äºæ°æ®æ¾å¨æ°ç»ä¸­ï¼æä»¬å¿é¡»ä½¿ç¨å ä¸ªåéè®°å½ä¸ä¸ç°å¨æä½å°åªãæå¤æä½å°åªãæ°ç»æå¤§å®¹éã\n\nbuffer å¸¸ç¨çæ¹æ³ï¼\n\næ¹æ³                     ä½ç¨\nxxxbuffer.allocate()   åå»ºä¸ä¸ª buffer å¯¹è±¡ï¼å¦ bytebufferãintbuffer...ï¼\nget()                  è·å position ä½ç½®çæ°æ®ï¼è·åæ°æ®å position++\nput()                  å¾ position ä½ç½®æ¾ç½®æ°æ®\nposition()             è®¾ç½® position çå¼\nlimit()                è®¾ç½® limit çå¼\nflip()                 åæ¢ä¸ºè¯»æ¨¡å¼\nclear()                åæ¢ä¸ºåæ¨¡å¼ï¼ä¸¢å¼å©ä½æ°æ®ï¼\ncompact()              åæ¢ä¸ºåæ¨¡å¼ï¼ä¿çå©ä½æ°æ®ï¼\nremaining()            return limit - positionï¼ä¸è¬ç¨ä½æ¥ç buffer ä¸­æ¯å¦è¿ææ°æ®\nhasremaining()         å¦æææ®çæ°æ®ï¼è¿å true\n\n\n# 2.1 allocate()\n\nå½æ³åå»ºä¸ä¸ª buffer æ¶ï¼ä½¿ç¨çæ¯ å¯¹åº buffer.allocate(int capacity)ã\n\nä¾å¦æ³åå»ºä¸ä¸ªå¤§å°ä¸º 10 å­èç bufferï¼ï¼ä¸ºäºæ¹ä¾¿ï¼æ¬ç¯ä¸é¢å°±ä½¿ç¨ bytebuffer ä¸¾ä¾ãï¼\n\npublic class testnio {\n    public static void main(string[] args) {\n        bytebuffer bytebuffer = bytebuffer.allocate(10);\n        intbuffer intbuffer = intbuffer.allocate(10);\n        charbuffer charbuffer = charbuffer.allocate(10);\n        longbuffer longbuffer = longbuffer.allocate(10);\n    }\n}\n\n\nåæè¯´çåä¸ªå±æ§æ»æ¯éµå¾ªä»¥ä¸è§å¾ï¼\n\nmark <= pasition <= limit <= capacity\n\n\n# 2.2 position() limit()\n\nåæ¶ï¼buffer æä¾äºå ä¸ªæ¹æ³æ¥æ¹åè¿å ä¸ªå±æ§çå¼ï¼\n\nbytebuffer.position(int position);\nbytebuffer.mark(int mark);\nbytebuffer.limit(int limit);\n\n\nå¦ä¸ä¸ºæ°åå»ºç bytebufferï¼\n\n\n\nç°å¨çå¯æä½èå´ä¸ºï¼position - limitï¼0 - 10ï¼\n\nä½¿ç¨ put æ¹æ³åæ°ç»ä¸­æ¾å¥å ä¸ªåç´ åï¼\n\npublic class testnio {\n    public static void main(string[] args) {\n        bytebuffer bytebuffer = bytebuffer.allocate(10);\n        // putæ¹æ³çæä½ï¼å°æ°æ®æ¾å°positionä½ç½®ï¼position++\n        bytebuffer.put((byte)5);\n        bytebuffer.put((byte)7);\n        bytebuffer.put((byte)2);\n        bytebuffer.put((byte)6);\n        bytebuffer.put((byte)4);\n    }\n}\n\n\nååå¡«åæ°æ®åï¼position éä¹ç§»å¨ï¼å¯æä½èå´ä¸º 5 - 10ã\n\n\n\nåå¦æç°å¨ä¸æ³å­æ°æ®äºï¼ææ³åæ°æ®æä¹åï¼\n\nç±äºæä½èå´ä¸º position - limitï¼æä»¬æ³è¦æ°ç»ä¸æ ä¸º 0 å° 4 çæ°æ®ï¼é£ä¹é¦åè¦ææä½èå´æ¹ä¸º 0-4.\n\nå·ä½ä¸ç¹å°±æ¯ limit = positionï¼position = 0\n\npublic class testnio {\n    public static void main(string[] args) {\n        bytebuffer bytebuffer = bytebuffer.allocate(10);\n\n        bytebuffer.put((byte)5);\n        bytebuffer.put((byte)7);\n        bytebuffer.put((byte)2);\n        bytebuffer.put((byte)6);\n        bytebuffer.put((byte)4);\n\t// è·åæ­¤æ¶limitåpositionçå¼\n        int limit = bytebuffer.limit();\n        int position = bytebuffer.position();\n\n        // å°limit = position\n        // å°position = 0\n        bytebuffer.limit(position);\n        bytebuffer.position(0);\n\t// get()æä½ï¼è·åæ°ç»ä¸­positionä½ç½®çåç´ ï¼position++\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n    }\n}\n\n\næå°ä¹åï¼\n\n\n\n\n# 2.3 flip()\n\nä½æ¯è¿æ ·ä¼ä¸ä¼å¾éº»ç¦ï¼é¾éææ¯æ¬¡æ³è¦è¯»åæ°æ®çæ¶åé½éè¦ limit=position, position=0 ï¼\n\nè¯å®ä¸å¦ï¼äººå®¶æç°æçæ¹æ³ä¾æä»¬è°ç¨ï¼bytebuffer.flip()\n\npublic final buffer flip() {\n    limit = position;\n    position = 0;\n    mark = -1;\n    return this;\n}\n\n\nè¿ä¸ªæ¹æ³å¸®æä»¬æ position å limit å±æ§èµå¼ï¼ç´æ¥è°ç¨å°±å¯ä»¥è¯»åæ°æ®ï¼æä»¥æä»¬ç§°å®ä¸ºè¯»æ¨¡å¼ã\n\npublic class testnio {\n    public static void main(string[] args) {\n        bytebuffer bytebuffer = bytebuffer.allocate(10);\n        bytebuffer.put((byte)5);\n        bytebuffer.put((byte)7);\n        bytebuffer.put((byte)2);\n        bytebuffer.put((byte)6);\n        bytebuffer.put((byte)4);\n        // è¿å¥è¯»æ¨¡å¼\n        bytebuffer.flip();\n\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n        system.out.println(bytebuffer.get());\n    }\n}\n\n\n\n# 2.4 clear() rewind()\n\næ¢ç¶æè¯»æ¨¡å¼ï¼èªæçä½ è¯å®æ³å°äºåæ¨¡å¼ï¼æ²¡éï¼ç¡®å®æï¼bytebuffer.clear()\n\npublic final buffer clear() {\n    position = 0;\n    limit = capacity;\n    mark = -1;\n    return this;\n}\n\n\nåæ¨¡å¼å° position ç½®ä¸º 0ï¼limit åå° capacity å¤ï¼å°±å¯ä»¥éæ°åå¥æ°æ®äºã\n\nå½ç¶ï¼è¿æä¸ä¸ª api ä¹å¯ä»¥å®ç°ç±»ä¼¼åæ¨¡å¼çä½ç¨ï¼bytebuffer.rewind();\n\npublic final buffer rewind() {\n    position = 0;\n    mark = -1;\n    return this;\n}\n\n\nclear ä¸ rewind çåºå«æ¯ï¼rewind ä¸æ¹å limit çå¼ã\n\n\n# 2.5 compact()\n\nä½æ¯ç°å¨åè½è¿ä¸æ¯å¾å®åï¼å¦ææ°ç»ä¸­è¿ææ°æ®ï¼ä½æ¯æä»¬ä¾æ§æ³åæ°ç»ä¸­åå¥æ°æ®è¯¥æä¹åå¢ï¼ä½¿ç¨ flip æ¹æ³å clear æ¹æ³ï¼\n\n\n\nå¦å¾æç¤ºï¼position å¨ä¸æ ä¸º 3 çå°æ¹ï¼è°ç¨ clear æ¹æ³åä¼å° position ç½® 0ï¼ååå¥æ°æ®æ¶å°±ä¼åç°ï¼ä¹åç 6 å 4 è¢«è¦çäºï¼æè¿æ²¡æç¨å®å¢æä¹è½è®©å®ä¸¢å¼å¢ï¼\n\nbuffer ä¹æä¾äºæ¹æ³ä¿çè¿å ä¸ªå­èçæ°æ®ï¼bytebuffer.compact()\n\npublic bytebuffer compact() {\n    system.arraycopy(hb, ix(position()), hb, ix(0), remaining());\n    position(remaining());\n    limit(capacity());\n    discardmark();\n    return this;\n}\n\n\nç®èè¨ä¹ï¼åæ position ~ limit çæ°æ®æ·è´å°æ°ç»çé¦é¨ï¼åå° position æ¾å°å©ä½æ°æ®çåä¸ä¸ªå­èï¼æå limit=capacityã\n\nå¨è¿ä¸ªæ°ç»ä¸­ï¼å°±æ¯å° 6 å 4 æ¾å°åä¸¤ä¸ªå­èï¼position = 3ï¼limit = 10ã\n\n\n\nç¶ååè¿è¡åæä½ï¼å°±ä¼å° 2ã6ã4 è¦çï¼å®ç°äºä¿çå©ä½æ°æ®çåè½ã\n\n\n# 2.6 remaining()\n\nå¦ææä»¬ä¸ç¥é bytebuffer ä¸­æå¤å°æ°æ®ï¼ä½æ¯æä»¬æ³ä¸æ¬¡å¨é¨è·åè¯¥å¦ä½æä½ï¼è¯´å°åºæä»¬åªæ¯æ³è·å position ~ limit ä¹é´çæ°æ®ï¼åªéè¦åä¸ä¸ªå¾ªç¯ limit > position å°±ä¸ç´è·åå°±è¡äº\n\nwhile (bytebuffer.limit() > bytebuffer.position()) {\n\tsystem.out.println(bytebuffer.get());\n}\n\n\nä½æ¯è¿ç§æä½ä¹å¤ªç¹çäºï¼buffer ä¹ä¸ºæä»¬æä¾äºç¸å³ç apiã\n\nremaining()ï¼è¿åçç»ææ¯ limit - positionãé£æä»¬å¨å¾ªç¯ä¸­åªéè¦ remaining() > 0 å°±å¯ä»¥äºã\n\npublic class testbuffer {\n    public static void main(string[] args) {\n        bytebuffer bytebuffer = bytebuffer.allocate(10);\n\n\n        bytebuffer.put((byte)5);\n        bytebuffer.put((byte)7);\n        bytebuffer.put((byte)2);\n        bytebuffer.put((byte)6);\n        bytebuffer.put((byte)4);\n\n\n        // å°limit = position\n        // å°position = 0\n        bytebuffer.flip();\n\n\t// å¦ælimit-positionä¸ä¸º0å°±ä¸ç´æå°\n        while (bytebuffer.remaining() > 0) {\n            system.out.println(bytebuffer.get());\n        }\n\n    }\n}\n\n\nhasremainingä¹å°±æ¯ return remaining() > 0\n\npublic class testbuffer {\n    public static void main(string[] args) {\n        bytebuffer bytebuffer = bytebuffer.allocate(10);\n\n\n        bytebuffer.put((byte)5);\n        bytebuffer.put((byte)7);\n        bytebuffer.put((byte)2);\n        bytebuffer.put((byte)6);\n        bytebuffer.put((byte)4);\n\n\n        // å°limit = position\n        // å°position = 0\n        bytebuffer.flip();\n\t// å¦ælimit-positionä¸ä¸º0å°±ä¸ç´æå°\n        while (bytebuffer.hasremaining()) {\n            system.out.println(bytebuffer.get());\n        }\n    }\n}\n\n\n\n# 3. channel\n\nåæä»ç»äº bufferï¼æä»¬ç¥éäº io æ¶çæ°æ®é½æ¯æ¾å¨ buffer ä¸­çï¼é£ä¹æ°æ®ä»åªéæ¥ï¼nio ç io æ¯åºäºåçï¼é£å°±è¯å®ä¸è½ä½¿ç¨ stream äºï¼è¿éä½¿ç¨çæ¯ channelï¼ééï¼\n\nnio å®ç°äºåç§ééï¼\n\n 1. filechannel ï¼æä»¶ééï¼ç¨äºæä»¶ ioï¼æ æ³ä½¿ç¨ io å¤è·¯å¤ç¨ã\n 2. datagramchannel ï¼udp ééï¼éè¿ udp è¯»åç½ç»ä¸­çæ°æ®ã\n 3. socketchannel ï¼tcp ééï¼éè¿ tcp è¯»åç½ç»ä¸­çæ°æ®ã\n 4. serversocketchannel ï¼çå¬ tcp ééã\n\n\n# 3.1 æä»¶ io éé\n\nnio åä¸éå¯¹æä»¶ io ç channel åªæ filechannel\n\njava.nio åä¸ç filechannel æä¾äºå¾å¤è· java.io åç±»ä¼¼çåè½ï¼æ¬è´¨ä¸é½æ¯è¯»åæä»¶ï¼åºå«å°±æ¯ä¸ä¸ªåºäºåï¼ä¸ä¸ªåºäºæµã\n\né¦åï¼filechannel æ¯éè¿æä»¶è·åçï¼channel ä¹æä»¥å«åééä¸æ¯æ²¡æåå çï¼å®ä¸ä»éè¦è¿æ¥æä»¶è·ååå®¹ï¼è¿éè¦è¿æ¥ç¼å­ï¼åªæå°æ°æ®ç»ç¼å­ï¼å¼åäººåæè½éè¿ç¼å­æ¥æä½æä»¶ãé£ä¹ä½¿ç¨ filechannel æä¸¤æ­¥ï¼\n\n 1. éè¿æä»¶è·å filechannel\n 2. å°ééï¼filechannelï¼ä¸ç¼å­ï¼bytebufferï¼è¿æ¥ã\n\nfilechannel filechannel = new randomaccessfile("nioæµè¯.txt", "rw").getchannel();\nbytebuffer bytebuffer = bytebuffer.allocate(1024);\n\n// å°æä»¶ä¸­çåå®¹è¯»åå°bytebufferä¸­\nfilechannel.read(bytebuffer);\n\n// å°bytebufferä¸­çåå®¹åå¥å°ééä¸­\nfilechannel.write(bytebuffer);\n\n\næ³¨æ ï¼å¨ä½¿ç¨ buffer å®æè¯»åæä½æ¶ï¼è¯·æ³¨æè¯»åæ¨¡å¼çè½¬æ¢ã\n\nä»¥ä¸ä»£ç ä¸ºè¯»åä¸ä¸ªæä»¶ä¸­çåå®¹ï¼å°å®ä»¬æå°åºæ¥ï¼\n\npublic class testfilechannel {\n    public static void main(string[] args) throws exception {\n        filechannel filechannel = new randomaccessfile("nioæµè¯.txt", "rw").getchannel();\n        bytebuffer bytebuffer = bytebuffer.allocate(1024);\n\n\t// å°filechannelä¸­çåå®¹è¯»åå°bytebuffer\n        while (filechannel.read(bytebuffer) != -1) {\n\t    // åæ¢ä¸ºè¯»æ¨¡å¼ \n            bytebuffer.flip();\n            while (bytebuffer.hasremaining()) {\n                char b = (char) bytebuffer.get();\n                if (b == \' \') {\n                    continue;\n                }\n                system.out.print(b);\n            }\n\t    // åæ¢ä¸ºåæ¨¡å¼\n            bytebuffer.clear();\n        }\n\t// æä½æ°æ®åè®°å¾å³é­å¦.\n\tfilechannel.close();\n    }\n}\n\n\næ³¨æï¼filechannel æ¯æ²¡æå¤è·¯å¤ç¨è¿ä¸ªåè½çï¼ä¸ºå¥ï¼\n\né¦åççå¤è·¯å¤ç¨æ¯ä¸ºäºè§£å³ä»ä¹é®é¢ï¼å¤è·¯å¤ç¨ä½¿å¾ä¸ä¸ªçº¿ç¨å¯ä»¥çæ§å¤ä¸ªè¿æ¥ï¼å¦æä¸ä¸ªå®¢æ·è¿æ¥å°æå¡ç«¯ç»æå¥äºä¹ä¸å¹²å°±å¹²ç­ï¼é£ä¹çº¿ç¨å°±ä¸æ­çå®ï¼å¦ææå¶ä»çè¿æ¥åèµ·äºè¯»äºä»¶æèåäºä»¶ï¼çº¿ç¨å°±å»å¤çææ´»çè¿æ¥ãå¯ä»¥çå°å¤è·¯å¤ç¨æ¯ä¸ºäºè§£å³æµæ°å®¢æ·ç«¯è¿æ¥åä¸è¿è¡æä½çé®é¢ï¼èæä»¶ io æ¯å®å¨å¼åäººåæä½çï¼ä½ æ³ä»ä¹æ¶åè¯»åå°±ä»ä¹æ¶åè¯»åï¼ä¸»å¨æå¨ä½ ï¼ä¸ç®¡å«äººçäºï¼æä»¥è¯´æä»¶ io æ²¡æå¤è·¯å¤ç¨çåè½ã\n\nfilechannel é¤äºç®åç read å write æ¹æ³ä¹å¤è¿æå¶ä»çæ¹æ³ï¼\n\næ¹æ³                       åè½\nposition(int position)   æå®ä½ç½®è¯»åï¼ä¾å¦æ³å¨æä»¶çç¬¬åä¸ªå­èå¼å§æä½: filechannel.position(10)\nsize()                   è·åæä»¶çå¤§å°\ntruncate(int size)       æªåæä»¶ï¼truncate(100)ï¼åªè·åæä»¶çå 100 ä¸ªå­è\nforce()                  å¼ºå¶åå¥ï¼å°ééä¸­æªåå¥çæ°æ®å¼ºå¶åå¥æä»¶ã\n\n\n# 3.2 ç½ç» io éé\n\nnio åä¸éå¯¹ç½ç» io æä¾äºä¸ä¸ªééï¼\n\n 1. serversocketchannel\n 2. socketchannel\n 3. datagramchannel\n\nå®ä»¬é½æ¯åæ­¥éé»å¡ç socket æä½ï¼å¯¹äºåæ­¥éé»å¡ socket æä½å®ç°çç»ä»¶ï¼å®å®éä¸æ¯åºäº socket çï¼åé¨é½æå¯¹åºç socket å¯¹è±¡ï¼æ¬è´¨è¿æ¯æä½ socketï¼ï¼åªæ¯å°è£ä¸ä¸ï¼å¤äºåæ­¥éé»å¡ãååæ°æ®ä¼ è¾è¿ä¸¤ä¸ªç¹ç¹ãä¸æ¹é¢æ¯å ä¸ºééæä»¥æ¥æäºæ°æ®ååä¼ è¾çåè½ï¼åæ¶å®ä»¬é½ç»§æ¿äº selectablechannelï¼å æ­¤æ¥æäºå¤è·¯å¤ç¨çåè½ã\n\nselectablechannel ä¸­æä¾äºéç½®æ¹æ³ï¼configureblocking(boolean block)ï¼è§åç¥æï¼è¿ä¸ªéç½®æ¹æ³æ¯æ§å¶å­ç±»æ¯å¦ä¸ºé»å¡ socket çï¼configbloking(true)ï¼é»å¡ï¼configbloking(false)ï¼éé»å¡ã\n\næä»¥å¨ç¼ç¨æ¶éè¦æ³¨æä¸¤ä¸ªç¹ï¼\n\n 1. åå»ºå¯¹åº channel åè¦è·ååé¨ç socket åè¿è¡æä½\n 2. è·å socket åè®¾ç½®ä¸ä¸è¿ä¸ª socket é»å¡è¿æ¯éé»å¡ã\n\n# 3.2.1 serversocketchannel\n\nserversocketchannel æä¾äºå ä¸ª api ç¨äºç½ç» io æä½ï¼\n\næ¹æ³                         ä½ç¨\nserversocketchannel.open   åå»º serversocketchannel\nconfigbloking              ç»§æ¿äº selectablechannelï¼å³å® socket æ¯å¦é»å¡\nclose                      å³é­ serversocketchannel\naccept                     æ¥æ¶è¿æ¥ï¼è¿å socketchannel å¯¹è±¡\nregister(selector)         å° serversocketchannel æ³¨åå° selector ä¸\n\n// åå»ºserversocketchannel\nserversocketchannel serversocketchannel = serversocketchannel.open();\n// è·ååé¨çsocket\nserversocket socket = serversocketchannel.socket();\n// è®©socketçå¬8989ç«¯å£\nsocket.bind(new inetsocketaddress(8989));\n// è®¾ç½®serversocketchannelä¸ºéé»å¡\nserversocketchannel.configureblocking(false);\n// å¤çè¿æ¥\n\n// å³é­\n\n\n> é»å¡åéé»å¡æä»ä¹åºå«å¢ï¼\n\nä»¥ä¸æ¯é»å¡ä»£ç ï¼\n\nserversocketchannel.configureblocking(true);\nwhile (true) {\n    // è¿æ¥socketchannel\n    socketchannel socketchannel = serversocketchannel.accept();\n    if (socketchannel == null) {\n        continue;\n    }\n    system.out.println("æè¿æ¥è¿æ¥äº");\n}\n\n\nå ä¸ºæ¯é»å¡ socketchannelï¼é£ä¹ä»£ç æ§è¡å° accept ä¼å¡çï¼ç´å°æçæ­£ç socket è¿æ¥ãæ¢å¥è¯è¯´ï¼socketchannel æ°¸è¿ä¸ä¼ä¸ºç©ºãè¦ä¹æ°¸è¿ç­å¾ï¼è¦ä¹å°±æ§è¡ æè¿æ¥è¿æ¥äº\n\nä½æ¯éé»å¡ä»£ç ï¼\n\nserversocketchannel.configureblocking(false);\nwhile (true) {\n    // è¿æ¥socketchannel\n    socketchannel socketchannel = serversocketchannel.accept();\n    if (socketchannel == null) {\n\tsystem.out.println("socketchannelä¸ºç©º");\n        continue;\n    }\n    system.out.println("æè¿æ¥è¿æ¥äº");\n}\n\n\nä»£ç ä¸ä¼é»å¡ï¼åªè¦æ§è¡å° acceptï¼æç®¡ä½ ææ²¡æè¿æ¥å¢ç´æ¥æ§è¡ï¼æ²¡è¿æ¥å°±è¿å nullï¼ç»§ç»­æ§è¡ä¸é¢çæä½ï¼æä»¥ä»£ç éå¯è½ä¼æå°å¾å¤ socketchannelä¸ºç©ºã\n\næ³¨æï¼è¿åªæ¯ nio åå¯¹äºé»å¡ io ä¸éé»å¡ io çå®ç°ï¼è¿ä¸æ¯ io å¤è·¯å¤ç¨ã\n\n# 3.2.2 socketchannel\n\nserversocketchannel æ¯æå¡ç«¯ï¼socketchannel æ¯å®¢æ·ç«¯ã\n\næ¢è¨ä¹ï¼serversocketchannel è¢«å¨ç­å¾ socketchannel è¿æ¥ï¼socketchannel ä¸»å¨è¯·æ± serverscoketchannel çè¿æ¥ã\n\nsocketchannel çç¹ç¹ï¼\n\n * åºäº tcp çéé\n * å ä¸ºå®ç°äº selectablechannelï¼æä»¥æ io å¤è·¯å¤ç¨çåè½\n\nsocketchannel æä¾ç apiï¼\n\næ¹æ³                                  åè½\nsocketchannel.open()                è·å socketchannel\nsocketchannel.open(socketaddress)   è·å socketchannel å¹¶è¿æ¥å°æå¡ç«¯\nconnect(socketaddress)              å°å¯¹åº socketchannel è¿æ¥å°æå¡ç«¯\nregister(selector)                  å° socketchannel æ³¨åå° selector ä¸\n\n// å¼å¯ä¸ä¸ªsocketchannelå¹¶æå®è¿æ¥å°æ¬æº8989ç«¯å£ä¸ã\nsocketchannel socketchannel = socketchannel.open();\nsocketchannel.connect(new inetsocketaddress("localhost", 8989));\n\n\næ¹æ³                      åè½\nisopen()                æµè¯ socketchannel æ¯å¦ä¸º open ç¶æ\nisconnected()           æµè¯ socketchannel æ¯å¦å·²ç»è¿æ¥ä¸äº\nisconnectionpending()   æµè¯ socketchannel æ¯å¦æ­£å¨è¿è¡è¿æ¥\nfinishconnect()         æ ¡éªæ­£å¨è¿è¡å¥æ¥å­è¿æ¥ç socketchannel æ¯å¦å·²ç»å®æäºè¿æ¥ã\n\nsocketchannel.isopen(); // æµè¯ socketchannel æ¯å¦ä¸º open ç¶æ\nsocketchannel.isconnected(); //æµè¯ socketchannel æ¯å¦å·²ç»è¢«è¿æ¥\nsocketchannel.isconnectionpending(); //æµè¯ socketchannel æ¯å¦æ­£å¨è¿è¡\nè¿æ¥\nsocketchannel.finishconnect(); //æ ¡éªæ­£å¨è¿è¡å¥æ¥å­è¿æ¥ç socketchannelæ¯å¦å·²ç»å®æè¿æ¥\n\n\næ¹æ³                  åè½\nread(bytebuffer)    å° socket ä¸­çæ°æ®è¯»å¥ç¼å­ä¸­\nwirte(bytebuffer)   å°ç¼å­ä¸­çæ°æ®åå¥ socket\n\nå¦æå¨åé¢è®¾ç½®ä¸ºé»å¡æ¨¡å¼ï¼é£ä¹ read æ¹æ³å wirte æ¹æ³ä¹ä¼æ¯é»å¡çï¼å°±æ¯è¿ä¸ªçº¿ç¨ä¸ç´ç­å¾ç´å° socket ä¸­ææ°æ®äºæååºãå¦ææ¯éé»å¡ï¼æ ¹æ¬ä¸å¸¦ç­çç´æ¥è¿åã\n\nè¿ä¸¤ä¸ªchannelè¯´å®å°±å¯ä»¥æ¥ä¸ä¸ªå°æ¡ä¾äºï¼å¦ä¸ä¸ºnioçå·ä½ä¾å­ï¼\n\n\n\nnioæ¯å¤è·¯å¤ç¨ï¼ä¹å°±æ¯æå¡ç«¯éè¿ selector æ¥éæ©ä¸åçå®¢æ·ç«¯ãæ³è¦selectoréæ©å®¢æ·ç«¯ï¼è¯å®è¦å®¢æ·ç«¯åselectorç»å®ãä»å¾ä¸å¯ä»¥çå°ï¼ç»å®è¿ä»¶äºå¹¶ä¸æ¯å®¢æ·ç«¯åçï¼èæ¯å®¢æ·ç«¯è¿æ¥åï¼æå¡ç«¯æ¿å°å®¢æ·ç«¯çsocketä¹åï¼å°å¶ç»å®å¨selectorä¸ã\n\næå¡ç«¯ä»£ç  ï¼\n\npackage nio.ss;\n \nimport java.io.ioexception;\nimport java.net.inetsocketaddress;\nimport java.nio.bytebuffer;\nimport java.nio.channels.*;\nimport java.util.iterator;\n \npublic class server {\n    public static void main(string[] args) {\n        try {\n            //1.è·åç®¡é\n            serversocketchannel serversocketchannel = serversocketchannel.open();\n            //2.è®¾ç½®éé»å¡æ¨¡å¼\n            serversocketchannel.configureblocking(false);\n            //3.ç»å®ç«¯å£\n            serversocketchannel.bind(new inetsocketaddress(8888));\n            //4.è·åéæ©å¨\n            selector selector = selector.open();\n            //5.å°ééæ³¨åå°éæ©å¨ä¸ï¼å¹¶ä¸å¼å§æå®çå¬çæ¥æ¶äºä»¶\n            serversocketchannel.register(selector, selectionkey.op_accept);\n            //6.è½®è¯¢å·²ç»å°±ç»ªçäºä»¶\n            while (selector.select() > 0){\n                system.out.println("å¼å¯äºä»¶å¤ç");\n                //7.è·åéæ©å¨ä¸­æææ³¨åçééä¸­å·²åå¤å¥½çäºä»¶\n                iterator<selectionkey> it = selector.selectedkeys().iterator();\n                //8.å¼å§éåäºä»¶\n                while (it.hasnext()){\n                    selectionkey selectionkey = it.next();\n                    system.out.println("---\x3e"+selectionkey);\n                    //9.å¤æ­è¿ä¸ªäºä»¶å·ä½æ¯å¥\n                    if (selectionkey.isacceptable()){\n                        //10.è·åå½åæ¥å¥äºä»¶çå®¢æ·ç«¯éé\n                        socketchannel socketchannel = serversocketchannel.accept();\n                        //11.åæ¢æéé»å¡æ¨¡å¼\n                        socketchannel.configureblocking(false);\n                        //12.å°æ¬å®¢æ·ç«¯æ³¨åå°éæ©å¨\n                        socketchannel.register(selector,selectionkey.op_read);\n                    }else if (selectionkey.isreadable()){\n                        //13.è·åå½åéæ©å¨ä¸çè¯»\n                        socketchannel socketchannel = (socketchannel) selectionkey.channel();\n                        //14.è¯»å\n                        bytebuffer buffer = bytebuffer.allocate(1024);\n                        int len;\n                        while ((len = socketchannel.read(buffer)) > 0){\n                            buffer.flip();\n                            system.out.println(new string(buffer.array(),0,len));\n                            //æ¸é¤ä¹åçæ°æ®ï¼è¦çåå¥ï¼\n                            buffer.clear();\n                        }\n                    }\n                    //15.å¤çå®æ¯åï¼ç§»é¤å½åäºä»¶\n                    it.remove();\n                }\n            }\n        } catch (ioexception e) {\n            e.printstacktrace();\n        }\n    }\n}\n\n\nå®¢æ·ç«¯ï¼\n\npackage nio.ss;\n \nimport java.io.ioexception;\nimport java.net.inetsocketaddress;\nimport java.nio.bytebuffer;\nimport java.nio.channels.socketchannel;\nimport java.util.scanner;\n \npublic class client {\n    public static void main(string[] args) {\n        try {\n            socketchannel socketchannel = socketchannel.open(new inetsocketaddress("127.0.0.1",8888));\n            socketchannel.configureblocking(false);\n            bytebuffer buffer = bytebuffer.allocate(1024);\n            scanner scanner = new scanner(system.in);\n            while (true){\n                system.out.print("è¯·è¾å¥:");\n                string msg = scanner.nextline();\n                buffer.put(msg.getbytes());\n                buffer.flip();\n                socketchannel.write(buffer);\n                buffer.clear();\n            }\n        } catch (ioexception e) {\n            e.printstacktrace();\n        }\n    }\n}\n\n\n# 3.2.3 datagramchannel\n\næ¯ä¸ä¸ª socketchannel å¯¹åºä¸ä¸ª socketï¼æ¯ä¸ä¸ª sewrversocketchannel å¯¹åºä¸ä¸ª serversocket\n\næ¯ä¸ä¸ª datagramchannel ä¹å¯¹åºä¸ä¸ª datagramsocketã\n\ndatagramchannel æ¯ nio æä¾çåºäº udp çè¿æ¥ééã\n\napi ï¼\n\næ¹æ³                                åè½\ndatagramchannel.open()            åå»ºä¸ä¸ª datagramchannel\nsocket()                          è¿å datagramchannel åé¨ç datagramsocket\nconnect(socketaddress)            è¿æ¥ï¼udp å¹¶æ²¡æ è¿æ¥ è¿ä¸è¯´ï¼è¿éåªæ¯å£°æä¸ä¸å¾åªéåéæ°æ®\nreceive(bytebuffer)               æ¥æ¶æ°æ®ï¼å°æ°æ®æ¾å° bytebuffer ä¸­ï¼æ³¨ææ¯ bytebuffer ä¸æ¯ bufferï¼\nsend(bytebuffer, socketaddress)   å socketaddress å¯¹åºç ip&ç«¯å£åé bytebuffer ä¸­çæ°æ®\nregister(selector)                å° datagramchannel æ³¨åå° selector ä¸\n\nä¾å­ï¼ä½¿ç¨å°ç¡è°·çä¾å­ï¼ï¼\n\npublic class testdatagramchannel {\n    /**\n     * ååç datagram\n     *\n     * @throws ioexception\n     * @throws interruptedexception\n     */\n    @test\n    public void senddatagram() throws ioexception, interruptedexception {\n        datagramchannel sendchannel= datagramchannel.open();\n        inetsocketaddress sendaddress= new inetsocketaddress("127.0.0.1", 9999);\n        while (true) {\n            sendchannel.send(bytebuffer.wrap("åå".getbytes("utf-8")), sendaddress);\n            system.out.println("ååç«¯åå");\n            thread.sleep(1000);\n        }\n    }\n    /**\n     * æ¶åç«¯\n     *\n     * @throws ioexception\n     */\n    @test\n    public void receive() throws ioexception {\n        datagramchannel receivechannel= datagramchannel.open();\n        inetsocketaddress receiveaddress= new inetsocketaddress(9999);\n        receivechannel.bind(receiveaddress);\n        bytebuffer receivebuffer= bytebuffer.allocate(512);\n        while (true) {\n            receivebuffer.clear();\n            socketaddress sendaddress= receivechannel.receive(receivebuffer);\n            receivebuffer.flip();\n            system.out.print(sendaddress.tostring() + " ");\n            system.out.println(charset.forname("utf-8").decode(receivebuffer));\n        }\n    }\n    /**\n     * åªæ¥æ¶ååé 9999 çæ°æ®å\n     *\n     * @throws ioexception\n     */\n    @test\n    public void testconect1() throws ioexception {\n        datagramchannel connchannel= datagramchannel.open();\n        connchannel.bind(new inetsocketaddress(9998));\n        connchannel.connect(new inetsocketaddress("127.0.0.1",9999));\n        connchannel.write(bytebuffer.wrap("åå".getbytes("utf-8")));\n        bytebuffer readbuffer= bytebuffer.allocate(512);\n        while (true) {\n            try {\n                readbuffer.clear();\n                connchannel.read(readbuffer);\n                readbuffer.flip();\n                system.out.println(charset.forname("utf-8").decode(readbuffer));\n            }catch(exception e) {\n            }\n        }\n    }\n}\n\n\n\n# 4. selector\n\nè³æ­¤ï¼java.nio åä¸çä¸¤ä¸ªéè¦ç»ä»¶å·²ç»ä»ç»å®æ¯ï¼ä½æ¯ä½ ä¼åç°å¶å®å¹¶æ²¡æä»ç» io å¤è·¯å¤ç¨ï¼åªæ¯æµæµæäºä¸ä¸é»å¡ä¸éé»å¡ãæ¯å ä¸º java ç nio çå¤è·¯å¤ç¨æ¯åºäº selector å®ç°çã\n\nselector ä¸è¬ç§°ä¸ºéæ©å¨ï¼ä¹å¯ä»¥ç¿»è¯ä¸ºå¤è·¯å¤ç¨å¨ãå®æ¯ java nio æ ¸å¿ç»ä»¶ä¸­çä¸ä¸ªï¼ç¨äºæ£æ¥å¤ä¸ª channel æ¯å¦åç è¯»/å æä½ï¼å¯ä»¥å®ç°ä¸ä¸ªçº¿ç¨çå¬å¤ä¸ªè¿æ¥çåè½ï¼ä¹å°±æ¯ io å¤è·¯å¤ç¨ã\n\næ¦è¿°ï¼åå¦ç°å¨æå¡ç«¯ä¸æ 5 ä¸ªå®¢æ·ç«¯è¿æ¥ï¼ä½æ¯å®ä»¬ 5 ä¸ªå¹¶ä¸æ¯ä¸ç´é½æäºä»¶éè¦å¤ççï¼å¾æå¯è½ä¸ç´ç©ºç¼ºï¼å¦ææ¯ä¸ªè¿æ¥é½åå»ºä¸ä¸ªçº¿ç¨ï¼é£ä¹å®å¨å¤ªæµªè´¹äºãå°±åªä½¿ç¨ä¸ä¸ªçº¿ç¨çå¬å®ä»¬å°±è¡äºãæ²¡æè¯»ãåäºä»¶çè¿æ¥æä»¬ä¸ç®¡å®ï¼æä¸ªè¿æ¥æè¯»åæä½æ¶å°±ä¼éç¥çº¿ç¨è®©å®å¤çã\n\n\n# 4.1 selectablechannel\n\nåé¢è¯´äºï¼åªæå®ç°äº selectablechannel ç channel ééææå¤è·¯å¤ç¨çåè½ï¼èå¤è·¯å¤ç¨çåè½æ¯ selector å®ç°çï¼é£ä¹ç«å¨å¼åèçè§åº¦ï¼è¯´ç½äºå°±æ¯ï¼filechannel æ²¡æç»å® selector ç register æ¹æ³ã\n\npublic abstract class selectablechannel {\n\t// ç»å®\n\tpublic abstract selectionkey register(selector sel, int ops, object att)\n        \t\t\t\t\tthrows closedchannelexception;\n}\n\n\n\n\n\n# 4.2 selectionkey\n\nchannel æ³¨åå° selector ä¸ä¹åå¹¶ä¸æ¯åçä»»ä½äºé½ä¼å¼èµ· selector çæ³¨æï¼è¿æ¯ channel èªå·±å³å®çï¼ä¾å¦ å¯è¯»ãå¯åãå¯è¿æ¥ãå¯æ¥å è¿åç§ç¶æï¼å½ channel éæ©ä»¥å¯è¯»äºä»¶æ³¨åå° selector ä¸æ¶ï¼åªæå½ channel åçè¯»äºä»¶æ¶æä¼éç¥ selector æ¥å¤çã\n\nè¿åç§ç¶æé½å¯¹åºå¸¸éï¼\n\nç¶æ           ç¶æ     å¸¸é       è¡¨ç¤º\nop_read      è¯»æä½    1 << 0   è¯»å°±ç»ªäºä»¶ï¼è¡¨ç¤ºééä¸­å·²ç»æäºå¯è¯»çæ°æ®ï¼å¯ä»¥æ§è¡è¯»æä½äº\nop_write     åæä½    1 << 2   åå°±ç»ªäºä»¶ï¼è¡¨ç¤ºå·²ç»å¯ä»¥åééåæ°æ®äº\nop_connect   è¿æ¥æä½   1 << 3   è¿æ¥å°±ç»ªäºä»¶ï¼è¡¨ç¤ºå®¢æ·ç«¯ä¸æå¡å¨çè¿æ¥å·²ç»å»ºç«æå\nop_accept    æ¥æ¶æä½   1 << 4   æ¥æ¶è¿æ¥ç»§ç»­äºä»¶ï¼è¡¨ç¤ºæå¡å¨çå¬å°äºå®¢æ·è¿æ¥ï¼æå¡å¨å¯ä»¥æ¥æ¶è¿ä¸ªè¿æ¥äº\n\néè¦è®°åï¼ä¸éè¦ï¼æä¸ä¸ªç±»éé¢æè¿äºå¸¸éï¼\n\npublic abstract class selectionkey {\n\t// è¯»æä½\n\tpublic static final int op_read = 1 << 0;\n\t// åæä½\n\tpublic static final int op_write = 1 << 2;\n\t// è¿æ¥æä½\n\tpublic static final int op_connect = 1 << 3;\n\t// æ¥åæä½\n\tpublic static final int op_accept = 1 << 4;\n}\n\n\næä»¥åªéè¦è°ç¨ channel.register(selector, selectionkey.op_xxx)å°±å¯ä»¥å° channel ç»å®å° selector ä¸ã\n\nselectionkey è¿ä¸ªç±»çä¸ä¸åç§°å«åéæ©é®ï¼å½selectoréæ©åï¼ææçå°±ç»ªè¿æ¥é½ä¼è¢«å°è£ä¸ºselectionkey ï¼æä»¬æ¿å°selectionkeyä¹åå¯ä»¥å¤æ­ä»ä¹äºä»¶åå¤å¥½äºï¼ç¶åå°±å¯ä»¥è·åsocketchannelè¿è¡å¤çã\n\n\n# 4.3 selector\n\nä»ç»äºåç½®ç¥è¯åï¼ç»äºè¿æ¥äºselectorãå¨è¿éæä¼ä½¿ç¨serversocketchannelåsocketchannelä¸¾ä¾ã\n\nselectorçå·¥ä½åçåé¢å·²ç»ä»ç»äºå¾å¤éäº ï¼ä½¿ç¨ä¸ä¸ªçº¿ç¨å¯¹å¤ä¸ªè¿æ¥è¿è¡çå¬ï¼æäºä»¶å°±å¤çï¼æ²¡äºä»¶å°±ç­å¾ã\n\n\n\nselectoræä¾çapiï¼\n\næ¹æ³                         ä½ç¨\nselector.open()            åå»ºä¸ä¸ªéæ©å¨\nint select()               éæ©åå¤å¥½çè¿æ¥ï¼æ²¡æè¿æ¥ä¼é»å¡\nint select(long timeout)   å¨timeoutæ¶é´åéæ©åå¤å¥½çè¿æ¥\nint selectnow()            éæ©åå¤å¥½çè¿æ¥ï¼æ²¡æè¿æ¥ä¸ä¼é»å¡\nset selectedkey()          è¿åå°±ç»ªçè¿æ¥\n\n> select()æ¹æ³è¿åç int å¼ï¼è¡¨ç¤ºæå¤å°ééå·²ç»å°±ç»ªï¼æ´åç¡®çè¯´ï¼æ¯ä¸ä¸æ¬¡selectä¸è¿ä¸æ¬¡selectæ¹æ³ä¹é´æå¤å°æ°çè¿æ¥è¿å¥å°±ç»ªç¶æã\n\nä¸æ¦è°ç¨selectæ¹æ³å¹¶ä¸è¿åå¼ä¸ä¸º0ï¼æå°±ç»ªçè¿æ¥ï¼æ¶ï¼å¯ä»¥è°ç¨selectedkey()æ¹æ³è·å¾å°±ç»ªè¿æ¥ã\n\næ¿å°è¿æ¥çéåä¹åå²ä¸æ¯éå¿ææ¬²ä¸ºææ¬²ä¸ºï¼ä½ å¯ä»¥ä½¿ç¨if else æ¥è¯¢é®æ¯ä¸ä¸ªè¿æ¥å¯¹åºçäºä»¶ï¼âä½ çè¯»å°±ç»ªäºåï¼ââä½ çåå°±ç»ªäºåï¼ââä½ çè¿æ¥å°±ç»ªäºåï¼â......\n\næä»¥ï¼java nioçç¼ç¨æ­¥éª¤ï¼\n\npublic class testselector {\n    public static void main(string[] args) throws ioexception {\n        // è·åè¿æ¥\n        selector selector = selector.open();\n        // è·åæå¡ç«¯\n        serversocketchannel serversocketchannel = serversocketchannel.open();\n        // æå¡ç«¯çå¬8989ç«¯å£\n        serversocketchannel.bind(new inetsocketaddress("127.0.0.1", 8989));\n        // ä¸ selector ä¸èµ·ä½¿ç¨æ¶ï¼channel å¿é¡»å¤äºéé»å¡æ¨¡å¼ä¸\n        serversocketchannel.configureblocking(false);\n        // å°æå¡ç«¯ç»å®å°éæ©å¨ä¸ï¼æå´è¶£çäºä»¶ä¸º è¿æ¥ã\n        serversocketchannel.register(selector, selectionkey.op_accept);\n        system.out.println("æå¡ç«¯å°±ç»ª");\n        while (true) {\n            // æ¥çæ¯å¦æå°±ç»ªè¿æ¥\n            int select = selector.select();\n\n            // è·åè¿1såçææå°±ç»ªè¿æ¥ï¼éå\n            set<selectionkey> selectionkeys = selector.selectedkeys();\n            iterator<selectionkey> iterator = selectionkeys.iterator();\n            \n            while (iterator.hasnext()) {\n                selectionkey selectionkey = iterator.next();\n                // å¦æéæ©é®æ¥æ¶äºä»¶å°±ç»ª\n                if (selectionkey.isacceptable()) {\n                    socketchannel socketchannel = serversocketchannel.accept();\n                    // å¤çsocketé»è¾\n\n                } else if (selectionkey.isconnectable()) {\n                    // å¦æéæ©é®è¿æ¥äºä»¶å°±ç»ª\n                    socketchannel channel = (socketchannel) selectionkey.channel();\n                    // å¤çsocketchanneläºä»¶\n\n                } else if (selectionkey.isreadable()) {\n                    // å¦æéæ©é®è¯»äºä»¶å°±ç»ª\n                    socketchannel channel = (socketchannel) selectionkey.channel();\n                    bytebuffer bytebuffer = bytebuffer.allocate(1024);\n                    channel.read(bytebuffer);\n                    // ä»bufferä¸­è¯»åæ°æ®\n                    // ......\n\n                } else if (selectionkey.iswritable()) {\n                    // å¦æéæ©é®åäºä»¶å°±ç»ª\n\n                }\n                // å¤çå®è¿ä¸ªè¿æ¥åå°å®ç§»é¤ã\n                iterator.remove();\n            }\n        }\n\n    }\n}\n\n\n> ä¸ selector ä¸èµ·ä½¿ç¨æ¶ï¼channel å¿é¡»å¤äºéé»å¡æ¨¡å¼ä¸ï¼ä¸ºä»ä¹ï¼\n> \n> åå¦ç°å¨å5ä¸ªå°±ç»ªçè¿æ¥è¢«æ¿åºæ¥äºï¼éåç¬¬ä¸ä¸ªsocketchannelæ¶ï¼è°ç¨acceptçªç¶é»å¡äºï¼ä½ è®©å¶ä»çsocketchannelæä¹æ§è¡ï¼\n\n\n\n\n# 5. ioå¤è·¯å¤ç¨çå ç§æ¨¡å¼\n\nä½ å¨è¯»ä¸é¢ioå¤è·¯å¤ç¨ä»£ç çæ¶åæ¯å¦ä¼æè§éµéµæ åï¼å®éä¸æåçä¹å¾æ åï¼ä¸ºä»ä¹ï¼éå + if/elseï¼tmdå¤ªæ¶å¿äºï¼ä¸ºä»ä¹è¦æææå°±ç»ªçè¿æ¥æ¿è¿æ¥éåå¢ï¼èä¸è¿æ¯è¾¹éåè¾¹if/elseå°±æ´æ¶å¿äºã\n\nè¿æ¶åå°±å¼åºäºioå¤è·¯å¤ç¨çå ç§æ¨¡å¼ï¼selectãpollãepoll\n\n 1. selectæ¨¡å¼ ï¼å½è¿äºè¿æ¥åºç°æç§ç¶ææ¶ï¼æä»¬å¹¶ä¸ç¥éåºç°äºä»ä¹ç¶æï¼ï¼åªè½å°ææå°±ç»ªè¿æ¥æ¿åºæ¥éåè¯¢é®ï¼âä½ å°±ç»ªäºï¼ä½ æ¯ä»ä¹ç¶æåï¼âï¼âä½ ä¹å°±ç»ªäºï¼ä½ æ¯ä»ä¹ç¶æåï¼â....å ä¸ºéè¦éåææè¿æ¥ï¼æä»¥æ¶é´å¤æåº¦ä¸ºo(n)ï¼åæ¶å­å¨æå¤§è¿æ¥æ°éå¶ã\n 2. pollæ¨¡å¼ ï¼åä¸ï¼ä½æ¯ç±äºä½¿ç¨é¾è¡¨æä»¥æ²¡ææå¤§è¿æ¥æ°éå¶ã\n 3. epollæ¨¡å¼ ï¼éç¨äºä»¶éç¥æ¹å¼ï¼ä¸æ¯æå¡ç«¯å»è¯¢é®è¿æ¥çç¶æï¼èæ¯è¿æ¥å°±ç»ªåè§¦ååè°å½æ°ç²¾åéç¥æå¡ç«¯ï¼âæçè¯»äºä»¶å¥½äºï¼ä½ åå¤è¯»å§âï¼âæçåäºä»¶å¥½äºï¼ä½ åå¤åå§âã è¿æ¯å ä¸ºå¨åæ ¸å®ç°ä¸­epollæ¯æ ¹æ®æ¯ä¸ªæä»¶æè¿°ç¬¦ä¸é¢çcallbackå½æ°å®ç°çï¼åªè¦å°±ç»ªå°±ä¼ç´æ¥è°ç¨åè°callbackå½æ°ï¼å®ç°ç²¾åéç¥ï¼è¾¾å°o(1)çæ¶é´å¤æåº¦ã\n\n       select ï¼æ©æçæ¬ï¼         poll ï¼1.4ï¼              epoll ï¼1.5ä¹åï¼\næä½æ¹å¼   éå                    éå                      åè°\nåºå±å®ç°   æ°ç»                    é¾è¡¨                      åå¸è¡¨\nioæç   éåæ°ç»ä¸­ææchannelï¼æ§è½è¾å·®   éåé¾è¡¨ä¸­ææççchannelï¼æ§è½è¾å·®   ç±æä½ç³»ç»å°åçäºä»¶çchannelå­å°æå¡ç«¯çå°±ç»ªäºä»¶åè¡¨ä¸­ï¼selectorç´æ¥ä»å°±ç»ªäºä»¶åè¡¨ä¸­è·åæå´è¶£çäºä»¶ï¼ä¸éè¦éåææchannelï¼æ¶é´å¤æåº¦ä¸ºo(1)\næå¤§è¿æ¥   æä¸é                   æ ä¸é                     æ ä¸é\n\n\n# 6. æ»ç»\n\nå¯¹äºjava nioçä»ç»å°è¿éå°±ç»æäºï¼è³äºjava.nioåä¸çå¶ä»ç±»å°±éè¦ä½ èªå·±å»æ©å±äºãæ»ç»ä¸ä¸æ¬ç¯çåå®¹ï¼\n\n 1. java nio çæææ¯new ioï¼æææ¯æä¾çæ°ioåï¼å¯ä»¥å®ç°åæ­¥é»å¡ioãåæ­¥éé»å¡ioãioå¤è·¯å¤ç¨ã\n    \n    æä½ç³»ç»nioçæææ¯non bloking ioï¼åªæ¯åæ­¥éé»å¡ioã\n\n 2. java çioå¤è·¯å¤ç¨æ¯ä½¿ç¨ selectorå®ç°çï¼ä¸ä¸ªchannelé¦åè¦æ³¨åå°selectoræå¯ä»¥è¢«åç°ã\n\n 3. selectoréæ©æ¶æ¯æç§âæå´è¶£çäºä»¶âéæ©çï¼æä»¥æä»¬å°æå¡ç«¯ç»å®å°selectorä¸æ¶å¤§å¤æ°é½ä¼æå®è¿æ¥äºä»¶ã',charsets:{cjk:!0},lastUpdated:"2023/10/20, 13:14:55",lastUpdatedTimestamp:1697778895e3},{title:"InnoDB - è¡æ ¼å¼",frontmatter:{title:"InnoDB - è¡æ ¼å¼",date:"2023-06-08T21:47:16.000Z",permalink:"/pages/493ffc/"},regularPath:"/02.%E6%96%87%E7%AB%A0/02.MySQL/01.InnoDB%20-%20%E8%A1%8C%E6%A0%BC%E5%BC%8F.html",relativePath:"02.æç« /02.MySQL/01.InnoDB - è¡æ ¼å¼.md",key:"v-f0607dd8",path:"/pages/493ffc/",headers:[{level:2,title:"1. ä»ä¹æ¯è¡æ ¼å¼",slug:"_1-ä»ä¹æ¯è¡æ ¼å¼",normalizedTitle:"1. ä»ä¹æ¯è¡æ ¼å¼",charIndex:19},{level:2,title:"2. åç§è¡æ ¼å¼",slug:"_2-åç§è¡æ ¼å¼",normalizedTitle:"2. åç§è¡æ ¼å¼",charIndex:325},{level:2,title:"3. Compactè¡æ ¼å¼",slug:"_3-compactè¡æ ¼å¼",normalizedTitle:"3. compactè¡æ ¼å¼",charIndex:537}],headersStr:"1. ä»ä¹æ¯è¡æ ¼å¼ 2. åç§è¡æ ¼å¼ 3. Compactè¡æ ¼å¼",content:"# InnoDB - è¡æ ¼å¼\n\n\n# 1. ä»ä¹æ¯è¡æ ¼å¼\n\næä»¬å¹³æ¶æ¯ä»¥è¡è®°å½ä¸ºåä½åè¡¨ä¸­æå¥æ°æ®çï¼è¿äºæ°æ®å¨ç£çä¸çå­æ¾æ¹å¼è¢«ç§°ä¸ºè¡æ ¼å¼æèè®°å½æ ¼å¼ã\n\nInnoDBå¼æä¸­æ¯æåç§è¡æ ¼å¼ï¼CompactãRedundantãDynamicãCompressed\n\nå¯ä»¥å¨åå»ºè¡¨çæ¶åæå®è¡æ ¼å¼ï¼æèç´æ¥ä½¿ç¨alterå½ä»¤æ´æ¹è¡¨çè¡æ ¼å¼ã\n\n 1. åå»ºè¡¨çæ¶åæå®è¡æ ¼å¼\n    \n    CREATE TABLE è¡¨å (    \n    \n    ) row_format = è¡æ ¼å¼åç§°;\n    \n\n 2. æ´æ¹è¡¨çæ¶åæå®è¡æ ¼å¼\n    \n    ALTER TABLE è¡¨å ROW_FORMAT = è¡æ ¼å¼åç§°;\n    \n\n\n# 2. åç§è¡æ ¼å¼\n\nå¦ä¸æè¿°ï¼CompactãRedundantãDynamicãCompressed\n\nè¡æ ¼å¼ç»æä»¬çæ°æ®æ·»å äºå¾å¤é¢å¤çå­æ®µï¼è¿äºå­æ®µè®°å½äºæ¬æ¡æ°æ®çä¸ä¸ä¿¡æ¯ï¼è¿äºä¿¡æ¯å±äºæ¯MySQLæå¡å¨ä¸ºäºæè¿°è¿æ¡è®°å½ï¼è¡æ°æ®ï¼èä¸å¾ä¸é¢å¤æ·»å çä¸äºä¿¡æ¯ã\n\nè¿å ç§è¡æ ¼å¼å¤§åå°å¼ï¼é½æ¯å¨ä½ çè¡¨çåºç¡ä¸ç»ä½ å¢å å ä¸ªéå½¢çå­æ®µï¼ç®çæ¯ä¸ºäºå å¿«MySQLçè¿è¡æçã\n\næ¬ç¯æç« åªæè¿°ä¸ä¸Compactè¡æ ¼å¼ã\n\n\n# 3. Compactè¡æ ¼å¼\n\nCompactè¡æ ¼å¼ç»è¡¨å¢å äºä¸ä¸ªé¢å¤å­æ®µï¼åé¿å­æ®µé¿åº¦åè¡¨ãNULLå¼åè¡¨ãè®°å½å¤´ä¿¡æ¯ã\n\n * åé¿å­æ®µé¿åº¦åè¡¨ï¼ä½ çæäºå­æ®µçå¼çé¿åº¦æ¯ä¸ç¡®å®çï¼ä¾å¦varchar()ãbolgãtextè¿äºç±»åï¼æ°æ®çé¿åº¦ä¸åºå®ï¼ä½æ¯MySQLè§£æçæ¶ååä¸æ³çä½ æå ä¸ªå­èï¼æä»¥å°±ä½¿ç¨è¿ä¸ªåè¡¨è®°å½ææä¼ååçå­æ®µçé¿åº¦ã\n * NULLå¼åè¡¨ï¼æçå­æ®µçå¼æ¯å¯ä»¥ä¸ºç©ºçï¼è¿äºæ°æ®æ¯ä¸éè¦è§£æå¤ççï¼æä»¥MySQLä¼å°è¿äºå­æ®µè®°å½ä¸æ¥ãï¼ä¸»é®ånot null å³é®å­ä¿®é¥°çå­æ®µä¸è½ä¸ºç©ºï¼æä»¥ä¸ä¼è¢«è®°å½ï¼\n * è®°å½å¤´ä¿¡æ¯ï¼æå¾å¤å­æ®µç»æï¼ä¸åå­æ®µæä¸åçä½ç¨ï¼ä¸»è¦æï¼æ è®°è¯¥è®°å½æ¯å¦è¢«å é¤ãæ è®°è¯¥è®°å½æ¯å¦æ¯B+æ å¶å­èç¹ãè¯¥è®°å½å¨è®°å½å ä¸­çä½ç½®ä¿¡æ¯...\n\n\n\nè¿ä¸ä¸ªå­æ®µæ¯MySQLæä¾ç»èªå·±ä½¿ç¨çãç°å¨è¯¦ç»ççå®ä»¬ã\n\n 1. åé¿å­æ®µçé¿åº¦åè¡¨\n    \n    å¦åå­æç¤ºï¼ä½ çè¡¨ä¸­æå¤å°å­æ®µçå¼çé¿åº¦æ¯å¯åçï¼å®å°±è®°å½è¿äºå¯åçæ°æ®çé¿åº¦ã\n    \n    æä»¬ç¥éMySQLä¸­æ¯æä¸äºä¸å®é¿çæ°æ®ç±»åï¼varcharãblogãtextãlongtext.....æä»¬å¯ä»¥å°è¿äºæ°æ®ç±»åçåç§°ä¸ºåé¿å­æ®µï¼åé¿å­æ®µä¸­å­å¨å¤é¿å­èçæ°æ®æ¯ä¸åºå®çï¼æä»¥MySQLå°è¿äºæ°æ®å­å¨æ¶é¡ºä¾¿å­ä¸å®ä»¬çé¿åº¦ï¼è¿æ ·å°±å¯ä»¥æ´å¿«çè§£æå¤çäºã\n    \n    å¨compactè¡æ ¼å¼ä¸­ï¼æææåé¿å­æ®µççå®æ°æ®å ç¨çå­èé¿åº¦é½å­æ¾å¨è®°å½çå¼å¤´ä½ç½®ï¼ä»èå½¢æä¸ä¸ªé¿åº¦åè¡¨ï¼ç§°ä¸ºåé¿å­æ®µçé¿åº¦åè¡¨ï¼åä¸ªåé¿å­æ®µæ°æ®å ç¨çå­èæ°æç§åçé¡ºåºéåºå­æ¾ãå¼ºè°ä¸ä¸ï¼éåºå­æ¾ã\n    \n    åå¦ç°å¨æä¸ä¸ªå­æ®µï¼idãnameãpasswordï¼å¶ä¸­idæ¯intç±»åï¼æä»¥å®ä¸æ¯åé¿å­æ®µï¼nameåpasswordé½æ¯varcharç±»åï¼å®ä»¬æ¯åé¿å­æ®µï¼æä»¥é¿åº¦åè¡¨ä¸­ä¼è®°å½ä»ä¿©çé¿åº¦ã\n    \n    name: xiaoming \n    password: 123\n    \n    \n    å¦ä¸ï¼nameçé¿åº¦æ¯8ä¸ªå­èï¼åå­è¿å¶æ¯0x08ï¼passwordæ¯3ä¸ªå­èï¼åå­è¿å¶æ¯0x03ã\n    \n    å­å¨å¨åè¡¨ä¸­å°±æ¯ï¼0308ã\n    \n    æ¾å¨æ´ä¸ªè¡ä¸­å°±æ¯ï¼\n    \n    ä½æ¯è¿æä¸ä¸ªé®é¢ï¼å¦ææä¸ªå­æ®µå­å¨çæ°æ®ç¹å«å¤ï¼ä½ åªç¨ä¸ä¸ªå­èå¯ä»¥å­åï¼æèè¯´ï¼ä½ æä¹ç¥é03ä»£è¡¨é¿åº¦è¿æ¯0308ä»£è¡¨é¿åº¦å¢ï¼\n    \n    æ¾å¿ ï¼InnoDB æå®çä¸å¥è§åãè¿éå°±ä¸å±å¼è®²è¿°äºã\n    \n    å¦å¤éè¦æ³¨æçæ¯ï¼åé¿å­æ®µé¿åº¦åè¡¨ä¸­åªå­å¨éNULLçååå®¹å ç¨çé¿åº¦ï¼é£è¯å®åï¼ä¸ºNULLçå¼ä½ è®°å½å®å¹²å¥ï¼\n    \n    åæ¶ï¼è¿ä¸ªåè¡¨çä¸­çå­æ®µä¸ä»ä»ä¼è¢«åé¿å­æ®µå½±åï¼è¿ä¼è¢«MySQLæä½¿ç¨å­ç¬¦éå½±åï¼\n    \n    å¯¹äº CHAR() ç±»åçåæ¥è¯´ï¼å½åéç¨çæ¯å®é¿å­ç¬¦éæ¶ï¼è¯¥åå ç¨çå­èæ°ä¸ä¼è¢«å å°åé¿å­æ®µé¿åº¦åè¡¨ï¼èå¦æéç¨åé¿å­ç¬¦éæ¶ï¼è¯¥åå ç¨çå­èæ°ä¹ä¼è¢«å å°åé¿å­æ®µé¿åº¦åè¡¨ã\n\n 2. NULLå¼åè¡¨\n    \n    æäºè¡¨ä¸­çæäºåå¯è½å­å¨NULLå¼ï¼MySQLä¼å°è¿äºå¼ä¸ºNULLçåç»ä¸ç®¡çèµ·æ¥ï¼å­å¨å°NULlå¼åè¡¨ä¸­ã\n    \n    é¦åï¼ä¸»é®åè¢«not null ä¿®é¥°çå­æ®µä¸ä¼è¢«å­å¨ãå¶æ¬¡ï¼å¦ææ­¤è¡çæ°æ®æ²¡æNULLå¼ï¼è¿ä¸ªNULLå¼åè¡¨ä¹å°±æ²¡ææä¹äºã\n    \n    å¦åï¼æ¯ä¸ä¸ªåè®¸å­å¨NULLå¼çå­æ®µå¯¹åºä¸ä¸ªäºè¿å¶ä½ï¼äºè¿å¶ä½æç§å­æ®µçé¡ºåºéåºæåºï¼å¼ºè°ï¼éåºã\n    \n    äºè¿å¶ä½çæä¹ï¼\n    \n    * äºè¿å¶ä½çå¼ä¸º1ï¼è¯¥å­æ®µçå¼ä¸ºNULLã\n    * äºè¿å¶ä½çå¼ä¸º0ï¼è¯¥å­æ®µçå¼ä¸ä¸ºNULLã\n    \n    å¦ä¸ï¼\n    \n    ä½æ¯MySQLè§å®NULLå¼åè¡¨å¿é¡»ä½¿ç¨æ´æ°ä¸ªå­èçä½è¡¨ç¤ºï¼å³ï¼8ã16ã32...\n    \n    å¹¶ä¸ï¼å¯¹äºè¿ä¸è¡æ°æ®æ¥è¯´ï¼å¼ä¸ºNULLçå­æ®µæ¯ä¸è¢«å­å¨çã\n    \n    æä»¥ä¸é¢é£å¼ å¾å®åä¸ä¸å¶å®æ¯è¿æ ·ï¼\n    \n    \n\n 3. è®°å½å¤´ä¿¡æ¯\n    \n    è¿ä¸ªå­æ®µåºå®æ5ä¸ªå­èï¼å³40ä¸ªäºè¿å¶ä½ï¼ä¸åçä½ä»£è¡¨ä¸åçææï¼å¦ä¸ï¼\n    \n    \n\nåç§°             å¤§å°ï¼BITï¼   ä½ç¨\né¢çä½            2         å¾ä½¿ç¨\ndelete_mask    1         è¯¥è®°å½æ¯å¦è¢«å é¤\nmin_rec_mask   1         B+æ çæ¯å±éå¶å­èç¹ä¸­çæå°è®°å½é½ä¼æ·»å è¯¥æ è®°\nn_owned        4         è¡¨ç¤ºå½åè®°å½æ¥æçè®°å½æ°\nheap_no        13        è¡¨ç¤ºå½åè®°å½å¨é¡µä¸­çä½ç½®\nrecord_type    3         è¡¨ç¤ºå½åè®°å½çç±»å0ï¼æ®éè®°å½1ï¼è¡¨ç¤ºB+æ éå¶å­èç¹è®°å½2ï¼è¡¨ç¤ºæå°è®°å½3ï¼è¡¨ç¤ºæå¤§è®°å½\nnext_record    16        è¡¨ç¤ºä¸ä¸æ¡è®°å½çç¸å¯¹ä½ç½®\n\nçå°delete_maskå¤§å®¶å¯è½ä¼æäºçæï¼è¿ä¸ªæ å¿ä¸æ¯âè¯¥æ¡è®°å½æ¯å¦è¢«å é¤âåï¼æä»¬å é¤ä¸æ¡æ°æ®ä¹åMySQLåæ¥å¹¶æ²¡æçæ­£çå é¤å®ï¼å¯¹ï¼MySQLæ§è¡çä¹æ¯é»è¾å é¤ï¼è³äºå·ä½æ¯ææ ·åçï¼å°±å¨æ°æ®å·ä½çå­å¨æ¹å¼ï¼InnoDB - é¡µç»æ ä¸­ä¸å¶ä»å¤´ä¿¡æ¯ä¸èµ·è¯´å§~ã\n\n 4. éèå­æ®µ\n    \n    èè¿MySQLé¢è¯é¢çå¤§æ¦é½ç¥éï¼å¨åå»ºè¡¨çæ¶åMySQLæä¾äºå ä¸ªéèå­æ®µï¼å®ç°MVCCæºå¶çä¸ä¸ªéèå­æ®µï¼\n    \n    * row_idï¼è¡idï¼å¯ä¸æ è¯\n    * transaction_idï¼æä½æ­¤è¡æ°æ®çäºå¡çid\n    * roll_pointerï¼åæ»æé\n    \n    å¤§å®¶å¯è½é½èè¿ï¼è¿éå°±ä¸å±å¼è®²äºãäºæ¯æä»¬åå»ºçè¡¨ï¼å ä¸ææéèå­æ®µä¹åå¶å®æ¯è¿æ ·çï¼\n    \n    \n\nç»¼ä¸æè¿°å°±æ¯MySQLçCompactè¡æ ¼å¼ã\n\nâ",normalizedContent:"# innodb - è¡æ ¼å¼\n\n\n# 1. ä»ä¹æ¯è¡æ ¼å¼\n\næä»¬å¹³æ¶æ¯ä»¥è¡è®°å½ä¸ºåä½åè¡¨ä¸­æå¥æ°æ®çï¼è¿äºæ°æ®å¨ç£çä¸çå­æ¾æ¹å¼è¢«ç§°ä¸ºè¡æ ¼å¼æèè®°å½æ ¼å¼ã\n\ninnodbå¼æä¸­æ¯æåç§è¡æ ¼å¼ï¼compactãredundantãdynamicãcompressed\n\nå¯ä»¥å¨åå»ºè¡¨çæ¶åæå®è¡æ ¼å¼ï¼æèç´æ¥ä½¿ç¨alterå½ä»¤æ´æ¹è¡¨çè¡æ ¼å¼ã\n\n 1. åå»ºè¡¨çæ¶åæå®è¡æ ¼å¼\n    \n    create table è¡¨å (    \n    \n    ) row_format = è¡æ ¼å¼åç§°;\n    \n\n 2. æ´æ¹è¡¨çæ¶åæå®è¡æ ¼å¼\n    \n    alter table è¡¨å row_format = è¡æ ¼å¼åç§°;\n    \n\n\n# 2. åç§è¡æ ¼å¼\n\nå¦ä¸æè¿°ï¼compactãredundantãdynamicãcompressed\n\nè¡æ ¼å¼ç»æä»¬çæ°æ®æ·»å äºå¾å¤é¢å¤çå­æ®µï¼è¿äºå­æ®µè®°å½äºæ¬æ¡æ°æ®çä¸ä¸ä¿¡æ¯ï¼è¿äºä¿¡æ¯å±äºæ¯mysqlæå¡å¨ä¸ºäºæè¿°è¿æ¡è®°å½ï¼è¡æ°æ®ï¼èä¸å¾ä¸é¢å¤æ·»å çä¸äºä¿¡æ¯ã\n\nè¿å ç§è¡æ ¼å¼å¤§åå°å¼ï¼é½æ¯å¨ä½ çè¡¨çåºç¡ä¸ç»ä½ å¢å å ä¸ªéå½¢çå­æ®µï¼ç®çæ¯ä¸ºäºå å¿«mysqlçè¿è¡æçã\n\næ¬ç¯æç« åªæè¿°ä¸ä¸compactè¡æ ¼å¼ã\n\n\n# 3. compactè¡æ ¼å¼\n\ncompactè¡æ ¼å¼ç»è¡¨å¢å äºä¸ä¸ªé¢å¤å­æ®µï¼åé¿å­æ®µé¿åº¦åè¡¨ãnullå¼åè¡¨ãè®°å½å¤´ä¿¡æ¯ã\n\n * åé¿å­æ®µé¿åº¦åè¡¨ï¼ä½ çæäºå­æ®µçå¼çé¿åº¦æ¯ä¸ç¡®å®çï¼ä¾å¦varchar()ãbolgãtextè¿äºç±»åï¼æ°æ®çé¿åº¦ä¸åºå®ï¼ä½æ¯mysqlè§£æçæ¶ååä¸æ³çä½ æå ä¸ªå­èï¼æä»¥å°±ä½¿ç¨è¿ä¸ªåè¡¨è®°å½ææä¼ååçå­æ®µçé¿åº¦ã\n * nullå¼åè¡¨ï¼æçå­æ®µçå¼æ¯å¯ä»¥ä¸ºç©ºçï¼è¿äºæ°æ®æ¯ä¸éè¦è§£æå¤ççï¼æä»¥mysqlä¼å°è¿äºå­æ®µè®°å½ä¸æ¥ãï¼ä¸»é®ånot null å³é®å­ä¿®é¥°çå­æ®µä¸è½ä¸ºç©ºï¼æä»¥ä¸ä¼è¢«è®°å½ï¼\n * è®°å½å¤´ä¿¡æ¯ï¼æå¾å¤å­æ®µç»æï¼ä¸åå­æ®µæä¸åçä½ç¨ï¼ä¸»è¦æï¼æ è®°è¯¥è®°å½æ¯å¦è¢«å é¤ãæ è®°è¯¥è®°å½æ¯å¦æ¯b+æ å¶å­èç¹ãè¯¥è®°å½å¨è®°å½å ä¸­çä½ç½®ä¿¡æ¯...\n\n\n\nè¿ä¸ä¸ªå­æ®µæ¯mysqlæä¾ç»èªå·±ä½¿ç¨çãç°å¨è¯¦ç»ççå®ä»¬ã\n\n 1. åé¿å­æ®µçé¿åº¦åè¡¨\n    \n    å¦åå­æç¤ºï¼ä½ çè¡¨ä¸­æå¤å°å­æ®µçå¼çé¿åº¦æ¯å¯åçï¼å®å°±è®°å½è¿äºå¯åçæ°æ®çé¿åº¦ã\n    \n    æä»¬ç¥émysqlä¸­æ¯æä¸äºä¸å®é¿çæ°æ®ç±»åï¼varcharãblogãtextãlongtext.....æä»¬å¯ä»¥å°è¿äºæ°æ®ç±»åçåç§°ä¸ºåé¿å­æ®µï¼åé¿å­æ®µä¸­å­å¨å¤é¿å­èçæ°æ®æ¯ä¸åºå®çï¼æä»¥mysqlå°è¿äºæ°æ®å­å¨æ¶é¡ºä¾¿å­ä¸å®ä»¬çé¿åº¦ï¼è¿æ ·å°±å¯ä»¥æ´å¿«çè§£æå¤çäºã\n    \n    å¨compactè¡æ ¼å¼ä¸­ï¼æææåé¿å­æ®µççå®æ°æ®å ç¨çå­èé¿åº¦é½å­æ¾å¨è®°å½çå¼å¤´ä½ç½®ï¼ä»èå½¢æä¸ä¸ªé¿åº¦åè¡¨ï¼ç§°ä¸ºåé¿å­æ®µçé¿åº¦åè¡¨ï¼åä¸ªåé¿å­æ®µæ°æ®å ç¨çå­èæ°æç§åçé¡ºåºéåºå­æ¾ãå¼ºè°ä¸ä¸ï¼éåºå­æ¾ã\n    \n    åå¦ç°å¨æä¸ä¸ªå­æ®µï¼idãnameãpasswordï¼å¶ä¸­idæ¯intç±»åï¼æä»¥å®ä¸æ¯åé¿å­æ®µï¼nameåpasswordé½æ¯varcharç±»åï¼å®ä»¬æ¯åé¿å­æ®µï¼æä»¥é¿åº¦åè¡¨ä¸­ä¼è®°å½ä»ä¿©çé¿åº¦ã\n    \n    name: xiaoming \n    password: 123\n    \n    \n    å¦ä¸ï¼nameçé¿åº¦æ¯8ä¸ªå­èï¼åå­è¿å¶æ¯0x08ï¼passwordæ¯3ä¸ªå­èï¼åå­è¿å¶æ¯0x03ã\n    \n    å­å¨å¨åè¡¨ä¸­å°±æ¯ï¼0308ã\n    \n    æ¾å¨æ´ä¸ªè¡ä¸­å°±æ¯ï¼\n    \n    ä½æ¯è¿æä¸ä¸ªé®é¢ï¼å¦ææä¸ªå­æ®µå­å¨çæ°æ®ç¹å«å¤ï¼ä½ åªç¨ä¸ä¸ªå­èå¯ä»¥å­åï¼æèè¯´ï¼ä½ æä¹ç¥é03ä»£è¡¨é¿åº¦è¿æ¯0308ä»£è¡¨é¿åº¦å¢ï¼\n    \n    æ¾å¿ ï¼innodb æå®çä¸å¥è§åãè¿éå°±ä¸å±å¼è®²è¿°äºã\n    \n    å¦å¤éè¦æ³¨æçæ¯ï¼åé¿å­æ®µé¿åº¦åè¡¨ä¸­åªå­å¨énullçååå®¹å ç¨çé¿åº¦ï¼é£è¯å®åï¼ä¸ºnullçå¼ä½ è®°å½å®å¹²å¥ï¼\n    \n    åæ¶ï¼è¿ä¸ªåè¡¨çä¸­çå­æ®µä¸ä»ä»ä¼è¢«åé¿å­æ®µå½±åï¼è¿ä¼è¢«mysqlæä½¿ç¨å­ç¬¦éå½±åï¼\n    \n    å¯¹äº char() ç±»åçåæ¥è¯´ï¼å½åéç¨çæ¯å®é¿å­ç¬¦éæ¶ï¼è¯¥åå ç¨çå­èæ°ä¸ä¼è¢«å å°åé¿å­æ®µé¿åº¦åè¡¨ï¼èå¦æéç¨åé¿å­ç¬¦éæ¶ï¼è¯¥åå ç¨çå­èæ°ä¹ä¼è¢«å å°åé¿å­æ®µé¿åº¦åè¡¨ã\n\n 2. nullå¼åè¡¨\n    \n    æäºè¡¨ä¸­çæäºåå¯è½å­å¨nullå¼ï¼mysqlä¼å°è¿äºå¼ä¸ºnullçåç»ä¸ç®¡çèµ·æ¥ï¼å­å¨å°nullå¼åè¡¨ä¸­ã\n    \n    é¦åï¼ä¸»é®åè¢«not null ä¿®é¥°çå­æ®µä¸ä¼è¢«å­å¨ãå¶æ¬¡ï¼å¦ææ­¤è¡çæ°æ®æ²¡ænullå¼ï¼è¿ä¸ªnullå¼åè¡¨ä¹å°±æ²¡ææä¹äºã\n    \n    å¦åï¼æ¯ä¸ä¸ªåè®¸å­å¨nullå¼çå­æ®µå¯¹åºä¸ä¸ªäºè¿å¶ä½ï¼äºè¿å¶ä½æç§å­æ®µçé¡ºåºéåºæåºï¼å¼ºè°ï¼éåºã\n    \n    äºè¿å¶ä½çæä¹ï¼\n    \n    * äºè¿å¶ä½çå¼ä¸º1ï¼è¯¥å­æ®µçå¼ä¸ºnullã\n    * äºè¿å¶ä½çå¼ä¸º0ï¼è¯¥å­æ®µçå¼ä¸ä¸ºnullã\n    \n    å¦ä¸ï¼\n    \n    ä½æ¯mysqlè§å®nullå¼åè¡¨å¿é¡»ä½¿ç¨æ´æ°ä¸ªå­èçä½è¡¨ç¤ºï¼å³ï¼8ã16ã32...\n    \n    å¹¶ä¸ï¼å¯¹äºè¿ä¸è¡æ°æ®æ¥è¯´ï¼å¼ä¸ºnullçå­æ®µæ¯ä¸è¢«å­å¨çã\n    \n    æä»¥ä¸é¢é£å¼ å¾å®åä¸ä¸å¶å®æ¯è¿æ ·ï¼\n    \n    \n\n 3. è®°å½å¤´ä¿¡æ¯\n    \n    è¿ä¸ªå­æ®µåºå®æ5ä¸ªå­èï¼å³40ä¸ªäºè¿å¶ä½ï¼ä¸åçä½ä»£è¡¨ä¸åçææï¼å¦ä¸ï¼\n    \n    \n\nåç§°             å¤§å°ï¼bitï¼   ä½ç¨\né¢çä½            2         å¾ä½¿ç¨\ndelete_mask    1         è¯¥è®°å½æ¯å¦è¢«å é¤\nmin_rec_mask   1         b+æ çæ¯å±éå¶å­èç¹ä¸­çæå°è®°å½é½ä¼æ·»å è¯¥æ è®°\nn_owned        4         è¡¨ç¤ºå½åè®°å½æ¥æçè®°å½æ°\nheap_no        13        è¡¨ç¤ºå½åè®°å½å¨é¡µä¸­çä½ç½®\nrecord_type    3         è¡¨ç¤ºå½åè®°å½çç±»å0ï¼æ®éè®°å½1ï¼è¡¨ç¤ºb+æ éå¶å­èç¹è®°å½2ï¼è¡¨ç¤ºæå°è®°å½3ï¼è¡¨ç¤ºæå¤§è®°å½\nnext_record    16        è¡¨ç¤ºä¸ä¸æ¡è®°å½çç¸å¯¹ä½ç½®\n\nçå°delete_maskå¤§å®¶å¯è½ä¼æäºçæï¼è¿ä¸ªæ å¿ä¸æ¯âè¯¥æ¡è®°å½æ¯å¦è¢«å é¤âåï¼æä»¬å é¤ä¸æ¡æ°æ®ä¹åmysqlåæ¥å¹¶æ²¡æçæ­£çå é¤å®ï¼å¯¹ï¼mysqlæ§è¡çä¹æ¯é»è¾å é¤ï¼è³äºå·ä½æ¯ææ ·åçï¼å°±å¨æ°æ®å·ä½çå­å¨æ¹å¼ï¼innodb - é¡µç»æ ä¸­ä¸å¶ä»å¤´ä¿¡æ¯ä¸èµ·è¯´å§~ã\n\n 4. éèå­æ®µ\n    \n    èè¿mysqlé¢è¯é¢çå¤§æ¦é½ç¥éï¼å¨åå»ºè¡¨çæ¶åmysqlæä¾äºå ä¸ªéèå­æ®µï¼å®ç°mvccæºå¶çä¸ä¸ªéèå­æ®µï¼\n    \n    * row_idï¼è¡idï¼å¯ä¸æ è¯\n    * transaction_idï¼æä½æ­¤è¡æ°æ®çäºå¡çid\n    * roll_pointerï¼åæ»æé\n    \n    å¤§å®¶å¯è½é½èè¿ï¼è¿éå°±ä¸å±å¼è®²äºãäºæ¯æä»¬åå»ºçè¡¨ï¼å ä¸ææéèå­æ®µä¹åå¶å®æ¯è¿æ ·çï¼\n    \n    \n\nç»¼ä¸æè¿°å°±æ¯mysqlçcompactè¡æ ¼å¼ã\n\nâ",charsets:{cjk:!0},lastUpdated:"2023/06/08, 21:54:53",lastUpdatedTimestamp:1686232493e3},{title:"InnoDB - é¡µç»æ",frontmatter:{title:"InnoDB - é¡µç»æ",date:"2023-06-08T21:47:16.000Z",permalink:"/pages/b3086d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/02.MySQL/05.InnoDB%20-%20%E9%A1%B5%E7%BB%93%E6%9E%84.html",relativePath:"02.æç« /02.MySQL/05.InnoDB - é¡µç»æ.md",key:"v-062f8431",path:"/pages/b3086d/",headers:[{level:2,title:"1. InnoDBé¡µç®ä»",slug:"_1-innodbé¡µç®ä»",normalizedTitle:"1. innodbé¡µç®ä»",charIndex:19},{level:2,title:"2. InnoDBé¡µç»æ",slug:"_2-innodbé¡µç»æ",normalizedTitle:"2. innodbé¡µç»æ",charIndex:462},{level:3,title:"2.1 User Recordsï¼æ°æ®ï¼",slug:"_2-1-user-records-æ°æ®",normalizedTitle:"2.1 user recordsï¼æ°æ®ï¼",charIndex:1019},{level:3,title:"2.2 Page Directoryï¼é¡µç®å½ï¼",slug:"_2-2-page-directory-é¡µç®å½",normalizedTitle:"2.2 page directoryï¼é¡µç®å½ï¼",charIndex:2464},{level:3,title:"2.3 Page Headerï¼é¡µå¤´é¨ä¿¡æ¯ï¼",slug:"_2-3-page-header-é¡µå¤´é¨ä¿¡æ¯",normalizedTitle:"2.3 page headerï¼é¡µå¤´é¨ä¿¡æ¯ï¼",charIndex:4146},{level:3,title:"2.4 File Headerï¼æä»¶å¤´ï¼",slug:"_2-4-file-header-æä»¶å¤´",normalizedTitle:"2.4 file headerï¼æä»¶å¤´ï¼",charIndex:4457},{level:3,title:"2.5 File Trailerï¼æä»¶å°¾ï¼",slug:"_2-5-file-trailer-æä»¶å°¾",normalizedTitle:"2.5 file trailerï¼æä»¶å°¾ï¼",charIndex:4810},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:5222}],headersStr:"1. InnoDBé¡µç®ä» 2. InnoDBé¡µç»æ 2.1 User Recordsï¼æ°æ®ï¼ 2.2 Page Directoryï¼é¡µç®å½ï¼ 2.3 Page Headerï¼é¡µå¤´é¨ä¿¡æ¯ï¼ 2.4 File Headerï¼æä»¶å¤´ï¼ 2.5 File Trailerï¼æä»¶å°¾ï¼ 3. æ»ç»",content:"# InnoDB - é¡µç»æ\n\n\n# 1. InnoDBé¡µç®ä»\n\nInnoDBæ¯ä¸ä¸ªå°è¡¨ä¸­çæ°æ®å­å¨å°ç£çä¸çå­å¨å¼æï¼æä»¥å³ä½¿å³æºåéå¯æä»¬çæ°æ®è¿æ¯å­å¨çãèçæ­£çå¯¹æ°æ®çå¤çè¿ç¨æ¯åçå¨åå­ä¸­çã\n\nå³ï¼å°ç£çä¸­çæ°æ®è¯»åå°åå­ä¸­è¿è¡æä½ã\n\n * è¯»è¯·æ±ï¼å°ç£çä¸­çåå®¹è¯»åå°åå­ä¸­ã\n * åè¯·æ±ï¼å°åå­ä¸­çè¢«ä¿®æ¹åçæ°æ®ååç£çä¸­ã\n\næä»¬ç¥éï¼è¯»åç£ççéåº¦éå¸¸æ¢ï¼ä¸åå­æä½å·®äºå ä¸ªæ°éçº§ï¼æä»¥å½æä»¬æ³è¦ä»è¡¨ä¸­è·åæ°æ®æ¶ï¼InnoDBä¼ä¸æ¡ä¸æ¡çæè®°å½ä»ç£çä¸­é½åºæ¥åï¼ä¸æ¯ï¼InnoDBéåçæ¹å¼æ¯ï¼å°æ°æ®ååä¸ºè¥å¹²é¡µï¼ä»¥é¡µä¸ºç£çååå­ä¹é´äº¤äºçåºæ¬åä½ï¼InnoDBä¸­é¡µçå¤§å°ä¸è¬ä¸º16kã\n\nå¨è¿ç§æåµä¸ï¼MySQLä¸æ¬¡æå°ä¼ä»ç£çä¸­å è½½16kçæ°æ®å°åå­ä¸­ï¼è¯´æç½ç¹ï¼å³ä½¿ä½ åªselectäºä¸æ¡æ°æ®ï¼ä¸è¯¥æ¡æ°æ®åä¸é¡µçæææ°æ®é½ä¼è¢«å è½½ï¼ä»ç£çå è½½å°åå­ï¼ã\n\nç°å¨æä»¬å°±å¯ä»¥æ¢³çä¸ä¸MySQLçInnoDBå¼æä¸­é¡µçæ¦å¿µï¼InnoDBç®¡çå­å¨ç©ºé´çåºæ¬åä½ãç¨äºç£çä¸åå­äº¤äºçæå°åä½ã\n\n\n# 2. InnoDBé¡µç»æ\n\n16kçé¡µè¢«åä¸ºå¥½å¤ä¸ªé¨åï¼å¹¶ä¸æ¯16kå¨é¨å­å¨æ°æ®çãä»¥ä¸ä¸ºé¡µçåºæ¬ç»æã\n\n\n\nå±æ7ä¸ªé¨åï¼ä»ä»¬çå¤§æ¦åè½å¦è¡¨æ ¼æç¤ºï¼\n\nä½ å¯ä»¥åçè¡¨æ ¼äºè§£ä¸ä¸å®ä»¬é½æ¯å¹²å¥çï¼ä¸é¢ä¼è¯¦ç»çæè¿°å®ä»¬çä½ç¨ã\n\nåç§°                   ä¸­æå         ä½ç¨\nFile Header          æä»¶å¤´é¨        é¡µçä¸äºéç¨ä¿¡æ¯\nPage Header          é¡µé¢å¤´é¨        æ°æ®é¡µä¸ç¨çä¸äºä¿¡æ¯\nInfimum + Supermum   æå°è®°å½åæå¤§è®°å½   ä¸¤ä¸ªèæçè¡è®°å½\nUser Records         ç¨æ·è®°å½        å®éå­å¨çè¡æ°æ®åå®¹ï¼åå§ä¸ºç©ºï¼éçè®°å½çå¢å ï¼ä»Free Spaceä¸­æªç¨ç©ºé´\nFree Space           ç©ºé²ç©ºé´        é¡µä¸­æªä½¿ç¨çç©ºé´ï¼ä¸ºUser Recordsæä¾ç©ºé´\nPage Directory       é¡µé¢ç®å½        é¡µä¸­çæäºè®°å½çç¸å¯¹ä½ç½®\nFile Trailer         æä»¶å°¾é¨        æ ¡éªé¡µæ¯å¦å®æ´\n\næä»¬æ¥ä¸æ¥å¹¶ä¸æç®æç§é¡µä¸­åä¸ªé¨åçåºç°é¡ºåºæ¥ä¾æ¬¡ä»ç»å®ä»¬ï¼å ä¸ºåä¸ªé¨åä¸­ä¼åºç°å¾å¤å¤§å®¶ç®åä¸çè§£çæ¦å¿µ.\n\n\n# 2.1 User Recordsï¼æ°æ®ï¼\n\n\n\nå¨é¡µç7ä¸ªç»æé¨åä¸­ï¼æä»¬èªå·±çæ°æ®ï¼studentãuserï¼ä¼å­å¨å¨User Recordsä¸­ãä½æ¯å¨ä¸å¼å§çæé¡µçæ¶åä¸ä¼ä¸ºUser Redordsåéç©ºé´ï¼æ¯å½æä»¬æå¥ä¸æ¡æ°æ®ï¼é½ä¼ä»Free Spaceååºé¨åç©ºé´å°User Redordsæ¥å­å¨è¿æ¡æ°æ®ï¼ç´å°Free Spaceè¢«User Recordså¨é¨æ¿ä»£ï¼è¯´æè¿ä¸ªé¡µç¨åäºï¼å°±ä¼åå»ºæ°çé¡µã\n\n\n\nå¨ä¸ä¸ç¯InnoDB - è¡æ ¼å¼ä¸­ï¼æä»¬ä»ç»äºInnoDBè¡æ ¼å¼ï¼è¯´å°äºæ¯ä¸è¡å¶å®æ6ä¸ªéèå­æ®µï¼å¶ä¸­æä¸ä¸ªéèå­æ®µå«åï¼è®°å½å¤´ä¿¡æ¯ã\n\n\n\nè®°å½å¤´ä¿¡æ¯ä¸­åæå¾å¤å­æ®µï¼å¨è¿éä¼æ¶åå°çæ5ä¸ªï¼ï¼æ­¤å¾çç¥äºå¶ä»éèå­æ®µï¼\n\n\n\ndelete_maskï¼è¯¥è®°å½æ¯å¦è¢«å é¤ã\n\nmin_rec_maskï¼æ¯å¦ä¸ºB+æ çæ¯å±éå¶å­èç¹ä¸­çæå°è®°å½ã\n\nn_ownedï¼æå ä¸ªè®°å½å±äºè¿ä¸ªè®°å½ãæ¯ä¸ªç»çæåä¸æ¡è®°å½ï¼ä¹å°±æ¯ç»åæå¤§çé£æ¡è®°å½ï¼çå¤´ä¿¡æ¯ä¸­ç n_owned å±æ§è¡¨ç¤ºè¯¥è®°å½æ¥æå¤å°æ¡è®°å½ã\n\nå½ï¼ä¹å°±æ¯è¯¥ç»åå±æå æ¡è®°å½ã\n\nheap_noï¼å¨é¡µä¸­çä¸æ ï¼ç¬¬å æ¡æ°æ®ï¼ã\n\nnext_recordï¼è¡¨ç¤ºä¸ä¸æ¡è®°å½çç¸å¯¹ä½ç½®ã\n\næä»¬æ³è¿å¼ è¡¨ä¸­æå¥3æ¡æ°æ®ï¼\n\ninsert into users values(1, 'aaaa'), \n                        (2, 'bbbb'),                       \n\t\t\t\t\t\t(3, 'cccc');\n\n\näºæ¯è¿å æ¡æ°æ®å°±å¦ä¸å¾æç¤ºè¿æ¥ï¼\n\n\n\nç±äºè¿æ²¡ææ¥è§¦å°ï¼æä»¥æå ä¸ªå­æ®µå¨å¾ä¸­æ¯ä¸éè¦çï¼è¿éåªéè¦æ³¨æä¸¤ä¸ªå­æ®µï¼heap_noãnext_recordã\n\nå¾ææ¾ï¼next_recordæ¯æåä¸ä¸æ¡è®°å½çæéã\n\nheap_noæ¯æ­¤è¡æ°æ®å¨é¡µä¸­çä¸è¡¨ï¼ä½æ¯æä»¬ç¥éä¸æ ä¸è¬æ¯ä»0æè1å¼å§çï¼åªæä»2å¼å§çå¢ï¼æä¹ä¸è§ heap_no å¼ä¸º 0 å 1 çè®°å½å¢ï¼\n\nå¶å®MySQLçè®¾è®¡èå¨å®ç°è¿é¨åçæ¶åèäºè±æ ·ï¼é¡µç»æä¸­æè¿æ ·ä¸ä¸ªå­æ®µï¼Infimumãsupermumãå®ä»¬çä¸­æååå«æ¯æå°è®°å½åæå¤§è®°å½ã\n\nç°å¨ä½ åºè¯¥çå°åºå·0å1é½å½è°äºå§ï¼å°±æ¯æå°è®°å½åæå¤§è®°å½ã\n\n\n\né£ä¹åæé£å¼ å¾å®åä¸ä¸å°±æ¯ï¼\n\n\n\nå¦å¾æç¤ºï¼MySQLéèçæå°è®°å½æåæä»¬æ·»å çä¸»é®æå°çè®°å½ï¼å½¢æä¸ä¸ªé¾è¡¨ï¼æåæä»¬æ·»å çä¸»é®æå¤§çè®°å½æåMySQLèªå¸¦çæå¤§è®°å½ã\n\nå³ï¼infimum -> User Records -> supermumã\n\nä»ä¸­å é¤ä¸æ¡æ°æ®ï¼æ´ä¸ªé¾è¡¨çç»æå°±ä¼åçååï¼åå¦ä»ä¸­å é¤idä¸º1çæ°æ®ï¼\n\n\n\nä¸è®ºæä»¬æä¹å¯¹é¡µä¸­çè®°å½åå¢å æ¹æä½ï¼InnoDBå§ç»ä¼ç»´æ¤ä¸æ¡è®°å½çåé¾è¡¨ï¼é¾è¡¨ä¸­çåä¸ªèç¹æ¯æç§ä¸»é®å¼ç±å°å°å¤§çé¡ºåºè¿æ¥èµ·æ¥çã\n\nå½æ°æ®é¡µä¸­å­å¨å¤æ¡è¢«å é¤æçè®°å½æ¶ï¼è¿äºè®°å½çnext_recordå±æ§å°ä¼æè¿äºè¢«å é¤æçè®°å½ç»æä¸ä¸ªåå¾é¾è¡¨ï¼ä»¥å¤ä¹åéç¨è¿é¨åå­å¨ç©ºé´ã\n\nå³ï¼æªå æ°æ®åå é¤æ°æ®é½ä¼ç»æé¾è¡¨ã\n\n> ä½ ä¼ä¸ä¼è§å¾next_recordå¾å¥æªï¼å®ç«ç¶æåéèå­æ®µåçå®æ°æ®ä¹é´çé¨åï¼èä¸æ¯æåéèå­æ®µå¼å¤´é¨å\n> \n> å ä¸ºè¿ä¸ªä½ç½®ååå¥½ï¼åå·¦è¯»åå°±æ¯è®°å½å¤´ä¿¡æ¯ï¼åå³è¯»åå°±æ¯çå®æ°æ®ã\n> \n> æä»¬ç¥éï¼éèå­æ®µä¸­ä¿¡æ¯çè®°å½é½æ¯éåºçï¼åèInnoDB - è¡æ ¼å¼ï¼ï¼å®ä»å³åå·¦è¯»å°±å¯ä»¥è¯»åå°æ­£åºçä¿¡æ¯äºï¼\n\n\n# 2.2 Page Directoryï¼é¡µç®å½ï¼\n\n\n\nåæè¯´äºï¼æ°æ®ä¹é´ä¼å½¢æé¾è¡¨ï¼æ¹ä¾¿æ¥æ¾ï¼ä½æ¯é¾è¡¨å¾ææ¾æçå¾æ¢ãMySQLçç´¢å¼ä½¿ç¨çæ¯B+æ ï¼è¿éæä»¬è®²çæ¯æ°æ®é¡µï¼ä¸æ¯ç´¢å¼é¡µï¼æä»¥æ²¡æç¨å°B+æ ï¼ä½æ¯MySQLçè®¾è®¡èè¿æ¯éç¨äºä¸å®çæ¹å¼å å¿«æ°æ®çæ¥è¯¢ã\n\nä¹å°±æ¯æ¥ç®å½çæ¹å¼ã\n\næä¸ä¸ªæ¯è¾å½¢è±¡çæ¯å»ï¼\n\nè¿äºå¤§å­¦ï¼ç­é¿è®°ä¸ä½ä¹ä¸æ³è®°ä½ææåå­¦çåç§°ï¼äºæ¯ä»å°å¨ç­åå­¦æç§å­¦å·æåºãåç»ï¼æ¯ä¸ªç»å¤§æ¦4-8äººï¼ç»éå­¦å·æå¤§çé£ä¸ªäººå½ç»é¿ï¼ç­é¿å»ºç«ä¸ä¸ªç»é¿ç¾¤ï¼å°ç»é¿æè¿å»ï¼æå¥äºå°±ç´æ¥éç¥ç»é¿èä¸ä¼éç¥ç»åï¼æ³è¦æ¾æä¸ªäººçæ¶åå°±ç´æ¥å¨ç»é¿ç¾¤éè¯´ï¼xxxå¨åªä¸ä¸ªç»ï¼ç»é¿å«ä»åä¸ä¸éå¹´å¤§å­¦ä¹ ~\n\nMySQLéç¨äºä»¥ä¸æ¹å¼ï¼\n\n 1. å°æææªå é¤çæ°æ®ååä¸ºä¸åçç»\n 2. æ¯ä¸ªç»çæåä¸æ¡è®°å½çå¤´ä¿¡æ¯ä¸­ç n_owned å±æ§è¡¨ç¤ºè¯¥ç»åæå¤å°æ¡è®°å½\n 3. å°æ¯ä¸ªç»çæåä¸æ¡è®°å½çå°ååç§»éåç¬æååºæ¥æç§é¡ºåºå­å¨å° Page Directory ä¸­ï¼ä¹å°±æ¯é¡µç®å½ï¼ï¼æä»¬å°è¿äºå°ååç§»éç§°ä¸º æ§½ã\n\nè¿éä¸è¦è¢«æç³æ¶äºï¼ä¸ä¸ªé¡µä¸­æå¾å¤æ¡æ°æ®ï¼è¿äºæ°æ®ä¼æç§é¾è¡¨çæ ¼å¼å­å¨ï¼æä»¬å°è¿äºæ°æ®åä¸ºå¾å¤ç»ï¼æ¯ä¸ªç»çæåä¸æ¡è®°å½\n\nçå°åæ½ååºæ¥è®°å½å¨ Page Directory ä¸­ã\n\nè¿éçæ´ä¸ªç­å°±æ¯ä¸ä¸ªé¡µï¼åä¸ªç»å°±æ¯MySQLä¸­çç»ï¼ç»é¿å°±æ¯æ¯ä¸ªç»çæåä¸æ¡æ°æ®ï¼ç»é¿ç¾¤å°±æ¯ Page Directoryãè¿å¥ç»é¿ç¾¤åçç»é¿è¢«ç§°ä¸ºâæ§½âã\n\n\n\næ³¨æï¼\n\n * æ§½0ä¸­çæ°å­ä¸º91ï¼ä»£è¡¨æå°è®°å½çå°ååç§»éä¸º91å­èã\n * æ§½1ä¸­çæ°å­ä¸º122ï¼ä»£è¡¨æå¤§è®°å½çå°ååç§»éä¸º122å­èã\n * æ§½0æåæå°è®°å½ï¼ä»£è¡¨æå°è®°å½åç¬ä¸ç»ï¼ä¹å°±åªææå°è®°å½è¿ä¸æ¡æ°æ®ï¼æä»¥å®çn_ownedå¼ä¸º1ã\n * æ§½1æåæå¤§è®°å½ï¼ä»£è¡¨æå¤§è®°å½ä»¥åä¹åçæ°æ®ä¸ºä¸ç»ï¼æä»¥å®çn_ownedä¸º4\n\né£ä¹ä¸ºä»ä¹æå°è®°å½åç¬ä¸ç»å¢ï¼å ä¸ºè§å®ï¼MySQLå¯¹äºæ¯ä¸ªåç»ä¸­çè®°å½ä¸ªæ°æ¯æè§å®çï¼æå°è®°å½æå¨çåç»åªè½ç±1æ¡è®°å½ï¼æå¤§è®°å½æå¨çåç»å¯ä»¥æ1~8æ¡è®°å½ï¼å©ä¸çå¶ä»åç»å¯ä»¥æ4~8æ¡è®°å½ã\n\næä»¬çä¸ä¸æ°æ®å¤çæ¶åï¼\n\n\n\nå¦å¾æç¤ºï¼å½æ15æ¡æ°æ®æ¶ï¼æ»è®°å½æ°ä¸º17ï¼è¢«åä¸º5ä¸ªç»ï¼å±æ5ä¸ªæ§½ä½ï¼æ§½ä½å¯¹åºçæ°æ®æ¡æ°åå«ä¸ºï¼1ã4ã4ã4ã3ã\n\nä½æ¯ï¼æå¥çæ¶åæ¯æè®²ç©¶çï¼\n\n * åå§æåµä¸æ¯æ²¡æç¨æ·æ°æ®çï¼åªæä¸¤ä¸ªç»ï¼æå°è®°å½ç»ä¸æå¤§è®°å½ç»ã\n * ä¹åæ²¡æå¥ä¸æ¡è®°å½ï¼é½ä¼ä»é¡µç®å½ï¼æ§½ä½ï¼ä¸­æ¾å°ä¸»é®å¼æ¯æ¬è®°å½å¤§ï¼å¹¶ä¸å·®å¼æå°çæ§½ä½ï¼ç¶åæè¯¥æ§½ä½æåçè®°å½ç n_owned å¼å ä¸ï¼è¡¨ç¤ºæ¬ç»ååæ·»å äºä¸æ¡è®°å½ï¼ç´å°è¯¥ç»ä¸­çè®°å½æ°ç­äº8ä¸ªã\n * å½ç»ä¸­çè®°å½æ°ç­äº8ä¸ªæ¶ï¼åæ¬¡æå¥ä¼å°æ¬ç»åä¸ºä¸¤ä¸ªç»ï¼å å¥åä¸º4ç»å5ç»ï¼ç¬¬åç»æ4æ¡è®°å½ï¼ç¬¬äºç»æ5æ¡è®°å½ãå ä¸ºæåäºï¼æä»¥é¡µç®å½ä¸­ä¼å¢å ä¸ä¸ªæ§½ä½ã\n\nå¼æ¸äºåç»çæåµï¼ç°å¨æä»¬å¯ä»¥æ¥æ¥æ¾äºï¼åå¦æ³è¦æ¥æ¾å° id=8 çæ°æ®ãä»å¾ä¸­å¯ä»¥çå°å®å¨ç¬¬ä¸ç»ã\n\nå ä¸ºåä¸ªæ§½æåçè®°å½çä¸»é®é½æ¯ä»å°å°å¤§æåçï¼æä»¥æä»¬å¯ä»¥ä½¿ç¨äºåæ³ã\n\næ­¤æ¶å±æ5ç»ï¼ç¼å·ä¸º 0ã1ã2ã3ã4 ï¼è®° low = 0ï¼high = 4\n\n 1. ï¼low + highï¼/ 2 = 2ï¼ç¬¬äºä¸ªæ§½ä½å¯¹åºçè®°å½çidä¸º9ï¼å¤ªå¤§äºï¼highæ¹ä¸º2\n 2. ï¼low + highï¼/ 2 = 1ï¼ç¬¬ä¸ä¸ªæ§½ä½å¯¹åºçè®°å½çidä¸º5ï¼å¤ªå°äºï¼lowæ¹ä¸º1\n 3. å ä¸º high - low = 1ï¼å¯ä»¥è¯´æç®æ æ°æ®å°±å¨ ç¬¬äºç» ä¸­ï¼æä»¬åªéè¦è·ålowæ§½ä½å¯¹åºçæ°æ®(ç¬¬ä¸ç»çæåä¸ä¸ªæ°æ®)ï¼åä¸æ¾ä¸ä¸ªæ°æ®å°±å°è¾¾ç¬¬äºç»çæå°æ°æ®ï¼æ­¤æ¶highæåçæ§½ä½çè®°å½æ°æ¯ç¬¬äºç»çæå¤§è®°å½ï¼è·å¾äºæå¤§ä¸æå°ï¼id=8çæ°æ®è¿ä¸æ¯å¾æå¯å¾ï¼\n\næä»¥å¨ä¸ä¸ªæ°æ®é¡µä¸­æ¥æ¾æå®ä¸»é®å¼çè®°å½çè¿ç¨åä¸ºä¸¤æ­¥ï¼\n\n * éè¿äºåæ³ç¡®å®è¯¥è®°å½æå¨çæ§½ï¼å¹¶æ¾å°æ¹æ§½ä¸­ä¸»é®å¼æå°çé£æ¡è®°å½ã\n * éè¿è®°å½ç next_record å±æ§éåè¯¥æ§½ï¼æ¾å°ç®æ æ°æ®ã\n\n\n# 2.3 Page Headerï¼é¡µå¤´é¨ä¿¡æ¯ï¼\n\n\n\næ°æ®é¡µå¤´é¨ä¿¡æ¯ï¼è¡æ°æ®å­æ®µè®°å½æ¬è¡çåºæ¬ä¿¡æ¯ï¼é£ä¹é¡µæ°æ®ä¹ä¼æä¸é¨çå­æ®µè®°å½æ¬é¡µçä¿¡æ¯ï¼èPage Headerå°±æ¯ç¨äºè®°å½ä¸ä¸ªæ°æ®é¡µçç¶æä¿¡æ¯ï¼æ¯å¦æ¬é¡µå­å¨äºå¤å°ä¸ªæ§½ãå¤å°ä¸ªæ°æ®ç­ç­...\n\nå·ä½æä»ä¹å­æ®µï¼æ¥çè¡¨æ ¼ï¼(ç±äºå­æ®µå¤ªå¤äºï¼è¿æ¯ç²¾ç®è¿çå­æ®µ)\n\nåç§°                 ä½ç¨\nPage_N_Dir_Slots   è¯¥é¡µçé¡µç®å½ä¸­çæ§½çæ°é\nPage_N_Heap        æ¬é¡µä¸­çè®°å½çæ°éï¼å é¤&æªå é¤ï¼\nPage_Level         å½åé¡µå¨B+æ æå¤çå±çº§\nPage_Index_id      æ¬é¡µå±äºåªä¸ªç´¢å¼\n\n\n# 2.4 File Headerï¼æä»¶å¤´ï¼\n\n\n\nFile Headeræ¯æ¯ç§é¡µé½æçå±æ§ï¼å¶ä¸­éè¦çå­æ®µå¦ï¼æ¬é¡µç¼å·ãä¸ä¸é¡µç¼å·ãä¸ä¸é¡µç¼å·ãæ ¡éªåã\n\nä¸ä¸ä¸ªä¸ä¸ä¸ä¸ªé¡µçç¼å·ï¼å¯ä»¥å°æææ°æ®é¡µç»æä¸ä¸ªåé¾è¡¨ï¼éåå°±å¾æ¹ä¾¿äºã\n\nFile Headerä¸­æä¸ä¸ªå¾éè¦çå­æ®µï¼æ ¡éªåã\n\nä»ä¹æ¯æ ¡éªåï¼\n\nå¯¹äºä¸ä¸ªå¾é¿å¾é¿çå­ç¬¦ä¸²æ¥è¯´ï¼æä»¬ä¼ä½¿ç¨æç§ç®æ³æ¥è®¡ç®ä¸ä¸ªæ¯è¾ç­çå­ç¬¦ä¸²æ¥ä»£æ¿å®ï¼æ¯å¦æä»¬éå¸¸ç¨æä»¶çmd5ç¼ç æ¥åæ­¥æ¯è¾æä»¶æ¯å¦ç¸ç­ã\n\næä»¬æ³æ¯è¾ä¸¤ä¸ªå¾é¿çå­ç¬¦ä¸²çæ¶åï¼å¯ä»¥åæ¯è¾ä»ä»¬çæ ¡éªåï¼å¦æè¿æ ¡éªåé½ä¸ä¸æ ·ï¼é£è¿ä¸¤ä¸ªå­ç¬¦ä¸²å°±è¯å®ä¸ä¸æ ·ãè¿æ ·å°±çå»äºä¸ä¸ªå­ç¬¦ä¸ä¸ªå­ç¬¦æ¯è¾æ¶èçæ¶é´ã\n\nåæ¶ï¼File Headerçæ ¡éªåè¿ä¼åFile Trailerçæ ¡éªåéåå·¥ä½ï¼ä¸é¢ä¼ä»ç»ã\n\n\n# 2.5 File Trailerï¼æä»¶å°¾ï¼\n\n\n\nFile Trailerè·File Headerä¸æ ·ï¼æä¸ä¸ªæ ¡éªåï¼é£ä¹è¿ä¸ªæ ¡éªåå°åºæ¯ä»ä¹ä½ç¨å¢ï¼\n\næä»¬ç¥éInnoDBå­å¨å¼æä¼å°æ°æ®ä»ç£çä¸­è¯»å°åå­ä¸­ï¼ä»¥é¡µä¸ºåä½ãå¦ææ°æ®å¨åå­ä¸­ä¿®æ¹äºï¼é£ä¹MySQLå¿å¿è¦æä»ä»¬åååç£çä¸­ï¼ååçè¿ç¨ä¸­ä¸ä¸åºç°äºä»ä¹éæä¹åï¼è¿ä¸æ¯å°´å°¬äºåï¼ä¸ºäºæ£éªä¸ä¸ªé¡µæ¯å¦å®æ´ï¼ä¹å°±æ¯åæ­¥çæ¶åæ¯å¦åºç°åæ­¥äºä¸åçæåµï¼ï¼MySQLå°±å¨é¡µçå¤´é¨åå°¾é¨é½å äºæ ¡éªåè¿ä¸ªä¸è¥¿ã\n\næ¯å½ä¸ä¸ªé¡µå¨åå­ä¸­ä¿®æ¹äºï¼å¨åæ­¥ä¹åå°±è¦æå®çæ ¡éªåç®åºæ¥ãFile Headerå¨é¡µçæåé¢ï¼æä»¥æ ¡éªåä¼è¢«ä¼ååæ­¥ï¼å¦æå®å¨åå®ï¼é£ä¹å°¾é¨çæ ¡éªåä¹ä¼åè¿å»ï¼è¿æ²¡é®é¢ãä¸ä¸ä¸­æ­äºï¼é£ä¹File Headerçæ ¡éªåæ¯å·²ç»ä¿®æ¹è¿çé¡µï¼File Trailerçæ ¡éªåæ¯ååçé¡µï¼äºèä¸ç¸åï¼è¯´æåæ­¥è¿ç¨ä¸­åºç°bugã\n\nï¼å¶å®è¿æä¸ä¸ªå­æ®µï¼ç°å¨åä¸ç®¡ï¼\n\n\n# 3. æ»ç»\n\n 1. InnoDBä¸ºäºä¸åçç®çèè®¾è®¡äºä¸åçé¡µç±»åï¼æä»¬æå­æ¾æ°æ®çé¡µç§°ä¸ºæ°æ®é¡µã\n\n 2. æ°æ®é¡µå¯ä»¥è¢«åä¸º7ä¸ªé¨åï¼\n    \n    1. File Headerï¼è¡¨ç¤ºé¡µçä¸äºéç¨ä¿¡æ¯\n    2. Page Headerï¼è¡¨ç¤ºæ°æ®é¡µä¸æçä¿¡æ¯\n    3. Infimum + Supermumï¼ä¸¤ä¸ªèæçä¼ªè®°å½ï¼åå«è¡¨ç¤ºé¡µä¸­çæå°è®°å½åæå¤§è®°å½\n    4. User Recordsï¼å­æ¾æä»¬æå¥çæ°æ®\n    5. Free Spaceï¼é¡µä¸­å¯ä»¥è¢«æä»¬ä½¿ç¨çæ°æ®\n    6. Page Directoryï¼é¡µä¸­çæäºè®°å½çç¸å¯¹ä½ç½®ï¼å¶ä¸­å­æ¾å¾å¤æ§½ä½\n    7. File Trailerï¼é¡µå°¾ï¼ä¸File Headerä¸èµ·æä¾æ ¡éªåæ¥æ£æ¥åæ­¥ç¶æ\n\n 3. æ¯ä¸ªæ°æ®é¡µçFile Headeré½æä¸ä¸ä¸ªä¸ä¸ä¸ä¸ªé¡µçç¼å·ï¼æä»¥ææçæ°æ®é¡µä¼ç»æä¸ä¸ªåé¾è¡¨\n\n 4. User Recordsä¸­çæ¯ä¸æ¡è®°å½ænext_recordï¼å®å°ææè®°å½ä¸²èä¸ºä¸ä¸ªé¾è¡¨ï¼å·²å é¤çåæªå é¤çï¼å±ä¸¤ä¸ªé¾è¡¨ï¼\n\n 5. ä¸ºä¿è¯åå­å°ç£ççåæ­¥çå®æ´æ§ï¼å¨æ°æ®é¡µçé¦é¨åæ°æ®é¡µçå°¾é¨é½ä¼å­å¨é¡µä¸­æ°æ®çæ ¡éªå\n\nâ",normalizedContent:"# innodb - é¡µç»æ\n\n\n# 1. innodbé¡µç®ä»\n\ninnodbæ¯ä¸ä¸ªå°è¡¨ä¸­çæ°æ®å­å¨å°ç£çä¸çå­å¨å¼æï¼æä»¥å³ä½¿å³æºåéå¯æä»¬çæ°æ®è¿æ¯å­å¨çãèçæ­£çå¯¹æ°æ®çå¤çè¿ç¨æ¯åçå¨åå­ä¸­çã\n\nå³ï¼å°ç£çä¸­çæ°æ®è¯»åå°åå­ä¸­è¿è¡æä½ã\n\n * è¯»è¯·æ±ï¼å°ç£çä¸­çåå®¹è¯»åå°åå­ä¸­ã\n * åè¯·æ±ï¼å°åå­ä¸­çè¢«ä¿®æ¹åçæ°æ®ååç£çä¸­ã\n\næä»¬ç¥éï¼è¯»åç£ççéåº¦éå¸¸æ¢ï¼ä¸åå­æä½å·®äºå ä¸ªæ°éçº§ï¼æä»¥å½æä»¬æ³è¦ä»è¡¨ä¸­è·åæ°æ®æ¶ï¼innodbä¼ä¸æ¡ä¸æ¡çæè®°å½ä»ç£çä¸­é½åºæ¥åï¼ä¸æ¯ï¼innodbéåçæ¹å¼æ¯ï¼å°æ°æ®ååä¸ºè¥å¹²é¡µï¼ä»¥é¡µä¸ºç£çååå­ä¹é´äº¤äºçåºæ¬åä½ï¼innodbä¸­é¡µçå¤§å°ä¸è¬ä¸º16kã\n\nå¨è¿ç§æåµä¸ï¼mysqlä¸æ¬¡æå°ä¼ä»ç£çä¸­å è½½16kçæ°æ®å°åå­ä¸­ï¼è¯´æç½ç¹ï¼å³ä½¿ä½ åªselectäºä¸æ¡æ°æ®ï¼ä¸è¯¥æ¡æ°æ®åä¸é¡µçæææ°æ®é½ä¼è¢«å è½½ï¼ä»ç£çå è½½å°åå­ï¼ã\n\nç°å¨æä»¬å°±å¯ä»¥æ¢³çä¸ä¸mysqlçinnodbå¼æä¸­é¡µçæ¦å¿µï¼innodbç®¡çå­å¨ç©ºé´çåºæ¬åä½ãç¨äºç£çä¸åå­äº¤äºçæå°åä½ã\n\n\n# 2. innodbé¡µç»æ\n\n16kçé¡µè¢«åä¸ºå¥½å¤ä¸ªé¨åï¼å¹¶ä¸æ¯16kå¨é¨å­å¨æ°æ®çãä»¥ä¸ä¸ºé¡µçåºæ¬ç»æã\n\n\n\nå±æ7ä¸ªé¨åï¼ä»ä»¬çå¤§æ¦åè½å¦è¡¨æ ¼æç¤ºï¼\n\nä½ å¯ä»¥åçè¡¨æ ¼äºè§£ä¸ä¸å®ä»¬é½æ¯å¹²å¥çï¼ä¸é¢ä¼è¯¦ç»çæè¿°å®ä»¬çä½ç¨ã\n\nåç§°                   ä¸­æå         ä½ç¨\nfile header          æä»¶å¤´é¨        é¡µçä¸äºéç¨ä¿¡æ¯\npage header          é¡µé¢å¤´é¨        æ°æ®é¡µä¸ç¨çä¸äºä¿¡æ¯\ninfimum + supermum   æå°è®°å½åæå¤§è®°å½   ä¸¤ä¸ªèæçè¡è®°å½\nuser records         ç¨æ·è®°å½        å®éå­å¨çè¡æ°æ®åå®¹ï¼åå§ä¸ºç©ºï¼éçè®°å½çå¢å ï¼ä»free spaceä¸­æªç¨ç©ºé´\nfree space           ç©ºé²ç©ºé´        é¡µä¸­æªä½¿ç¨çç©ºé´ï¼ä¸ºuser recordsæä¾ç©ºé´\npage directory       é¡µé¢ç®å½        é¡µä¸­çæäºè®°å½çç¸å¯¹ä½ç½®\nfile trailer         æä»¶å°¾é¨        æ ¡éªé¡µæ¯å¦å®æ´\n\næä»¬æ¥ä¸æ¥å¹¶ä¸æç®æç§é¡µä¸­åä¸ªé¨åçåºç°é¡ºåºæ¥ä¾æ¬¡ä»ç»å®ä»¬ï¼å ä¸ºåä¸ªé¨åä¸­ä¼åºç°å¾å¤å¤§å®¶ç®åä¸çè§£çæ¦å¿µ.\n\n\n# 2.1 user recordsï¼æ°æ®ï¼\n\n\n\nå¨é¡µç7ä¸ªç»æé¨åä¸­ï¼æä»¬èªå·±çæ°æ®ï¼studentãuserï¼ä¼å­å¨å¨user recordsä¸­ãä½æ¯å¨ä¸å¼å§çæé¡µçæ¶åä¸ä¼ä¸ºuser redordsåéç©ºé´ï¼æ¯å½æä»¬æå¥ä¸æ¡æ°æ®ï¼é½ä¼ä»free spaceååºé¨åç©ºé´å°user redordsæ¥å­å¨è¿æ¡æ°æ®ï¼ç´å°free spaceè¢«user recordså¨é¨æ¿ä»£ï¼è¯´æè¿ä¸ªé¡µç¨åäºï¼å°±ä¼åå»ºæ°çé¡µã\n\n\n\nå¨ä¸ä¸ç¯innodb - è¡æ ¼å¼ä¸­ï¼æä»¬ä»ç»äºinnodbè¡æ ¼å¼ï¼è¯´å°äºæ¯ä¸è¡å¶å®æ6ä¸ªéèå­æ®µï¼å¶ä¸­æä¸ä¸ªéèå­æ®µå«åï¼è®°å½å¤´ä¿¡æ¯ã\n\n\n\nè®°å½å¤´ä¿¡æ¯ä¸­åæå¾å¤å­æ®µï¼å¨è¿éä¼æ¶åå°çæ5ä¸ªï¼ï¼æ­¤å¾çç¥äºå¶ä»éèå­æ®µï¼\n\n\n\ndelete_maskï¼è¯¥è®°å½æ¯å¦è¢«å é¤ã\n\nmin_rec_maskï¼æ¯å¦ä¸ºb+æ çæ¯å±éå¶å­èç¹ä¸­çæå°è®°å½ã\n\nn_ownedï¼æå ä¸ªè®°å½å±äºè¿ä¸ªè®°å½ãæ¯ä¸ªç»çæåä¸æ¡è®°å½ï¼ä¹å°±æ¯ç»åæå¤§çé£æ¡è®°å½ï¼çå¤´ä¿¡æ¯ä¸­ç n_owned å±æ§è¡¨ç¤ºè¯¥è®°å½æ¥æå¤å°æ¡è®°å½ã\n\nå½ï¼ä¹å°±æ¯è¯¥ç»åå±æå æ¡è®°å½ã\n\nheap_noï¼å¨é¡µä¸­çä¸æ ï¼ç¬¬å æ¡æ°æ®ï¼ã\n\nnext_recordï¼è¡¨ç¤ºä¸ä¸æ¡è®°å½çç¸å¯¹ä½ç½®ã\n\næä»¬æ³è¿å¼ è¡¨ä¸­æå¥3æ¡æ°æ®ï¼\n\ninsert into users values(1, 'aaaa'), \n                        (2, 'bbbb'),                       \n\t\t\t\t\t\t(3, 'cccc');\n\n\näºæ¯è¿å æ¡æ°æ®å°±å¦ä¸å¾æç¤ºè¿æ¥ï¼\n\n\n\nç±äºè¿æ²¡ææ¥è§¦å°ï¼æä»¥æå ä¸ªå­æ®µå¨å¾ä¸­æ¯ä¸éè¦çï¼è¿éåªéè¦æ³¨æä¸¤ä¸ªå­æ®µï¼heap_noãnext_recordã\n\nå¾ææ¾ï¼next_recordæ¯æåä¸ä¸æ¡è®°å½çæéã\n\nheap_noæ¯æ­¤è¡æ°æ®å¨é¡µä¸­çä¸è¡¨ï¼ä½æ¯æä»¬ç¥éä¸æ ä¸è¬æ¯ä»0æè1å¼å§çï¼åªæä»2å¼å§çå¢ï¼æä¹ä¸è§ heap_no å¼ä¸º 0 å 1 çè®°å½å¢ï¼\n\nå¶å®mysqlçè®¾è®¡èå¨å®ç°è¿é¨åçæ¶åèäºè±æ ·ï¼é¡µç»æä¸­æè¿æ ·ä¸ä¸ªå­æ®µï¼infimumãsupermumãå®ä»¬çä¸­æååå«æ¯æå°è®°å½åæå¤§è®°å½ã\n\nç°å¨ä½ åºè¯¥çå°åºå·0å1é½å½è°äºå§ï¼å°±æ¯æå°è®°å½åæå¤§è®°å½ã\n\n\n\né£ä¹åæé£å¼ å¾å®åä¸ä¸å°±æ¯ï¼\n\n\n\nå¦å¾æç¤ºï¼mysqléèçæå°è®°å½æåæä»¬æ·»å çä¸»é®æå°çè®°å½ï¼å½¢æä¸ä¸ªé¾è¡¨ï¼æåæä»¬æ·»å çä¸»é®æå¤§çè®°å½æåmysqlèªå¸¦çæå¤§è®°å½ã\n\nå³ï¼infimum -> user records -> supermumã\n\nä»ä¸­å é¤ä¸æ¡æ°æ®ï¼æ´ä¸ªé¾è¡¨çç»æå°±ä¼åçååï¼åå¦ä»ä¸­å é¤idä¸º1çæ°æ®ï¼\n\n\n\nä¸è®ºæä»¬æä¹å¯¹é¡µä¸­çè®°å½åå¢å æ¹æä½ï¼innodbå§ç»ä¼ç»´æ¤ä¸æ¡è®°å½çåé¾è¡¨ï¼é¾è¡¨ä¸­çåä¸ªèç¹æ¯æç§ä¸»é®å¼ç±å°å°å¤§çé¡ºåºè¿æ¥èµ·æ¥çã\n\nå½æ°æ®é¡µä¸­å­å¨å¤æ¡è¢«å é¤æçè®°å½æ¶ï¼è¿äºè®°å½çnext_recordå±æ§å°ä¼æè¿äºè¢«å é¤æçè®°å½ç»æä¸ä¸ªåå¾é¾è¡¨ï¼ä»¥å¤ä¹åéç¨è¿é¨åå­å¨ç©ºé´ã\n\nå³ï¼æªå æ°æ®åå é¤æ°æ®é½ä¼ç»æé¾è¡¨ã\n\n> ä½ ä¼ä¸ä¼è§å¾next_recordå¾å¥æªï¼å®ç«ç¶æåéèå­æ®µåçå®æ°æ®ä¹é´çé¨åï¼èä¸æ¯æåéèå­æ®µå¼å¤´é¨å\n> \n> å ä¸ºè¿ä¸ªä½ç½®ååå¥½ï¼åå·¦è¯»åå°±æ¯è®°å½å¤´ä¿¡æ¯ï¼åå³è¯»åå°±æ¯çå®æ°æ®ã\n> \n> æä»¬ç¥éï¼éèå­æ®µä¸­ä¿¡æ¯çè®°å½é½æ¯éåºçï¼åèinnodb - è¡æ ¼å¼ï¼ï¼å®ä»å³åå·¦è¯»å°±å¯ä»¥è¯»åå°æ­£åºçä¿¡æ¯äºï¼\n\n\n# 2.2 page directoryï¼é¡µç®å½ï¼\n\n\n\nåæè¯´äºï¼æ°æ®ä¹é´ä¼å½¢æé¾è¡¨ï¼æ¹ä¾¿æ¥æ¾ï¼ä½æ¯é¾è¡¨å¾ææ¾æçå¾æ¢ãmysqlçç´¢å¼ä½¿ç¨çæ¯b+æ ï¼è¿éæä»¬è®²çæ¯æ°æ®é¡µï¼ä¸æ¯ç´¢å¼é¡µï¼æä»¥æ²¡æç¨å°b+æ ï¼ä½æ¯mysqlçè®¾è®¡èè¿æ¯éç¨äºä¸å®çæ¹å¼å å¿«æ°æ®çæ¥è¯¢ã\n\nä¹å°±æ¯æ¥ç®å½çæ¹å¼ã\n\næä¸ä¸ªæ¯è¾å½¢è±¡çæ¯å»ï¼\n\nè¿äºå¤§å­¦ï¼ç­é¿è®°ä¸ä½ä¹ä¸æ³è®°ä½ææåå­¦çåç§°ï¼äºæ¯ä»å°å¨ç­åå­¦æç§å­¦å·æåºãåç»ï¼æ¯ä¸ªç»å¤§æ¦4-8äººï¼ç»éå­¦å·æå¤§çé£ä¸ªäººå½ç»é¿ï¼ç­é¿å»ºç«ä¸ä¸ªç»é¿ç¾¤ï¼å°ç»é¿æè¿å»ï¼æå¥äºå°±ç´æ¥éç¥ç»é¿èä¸ä¼éç¥ç»åï¼æ³è¦æ¾æä¸ªäººçæ¶åå°±ç´æ¥å¨ç»é¿ç¾¤éè¯´ï¼xxxå¨åªä¸ä¸ªç»ï¼ç»é¿å«ä»åä¸ä¸éå¹´å¤§å­¦ä¹ ~\n\nmysqléç¨äºä»¥ä¸æ¹å¼ï¼\n\n 1. å°æææªå é¤çæ°æ®ååä¸ºä¸åçç»\n 2. æ¯ä¸ªç»çæåä¸æ¡è®°å½çå¤´ä¿¡æ¯ä¸­ç n_owned å±æ§è¡¨ç¤ºè¯¥ç»åæå¤å°æ¡è®°å½\n 3. å°æ¯ä¸ªç»çæåä¸æ¡è®°å½çå°ååç§»éåç¬æååºæ¥æç§é¡ºåºå­å¨å° page directory ä¸­ï¼ä¹å°±æ¯é¡µç®å½ï¼ï¼æä»¬å°è¿äºå°ååç§»éç§°ä¸º æ§½ã\n\nè¿éä¸è¦è¢«æç³æ¶äºï¼ä¸ä¸ªé¡µä¸­æå¾å¤æ¡æ°æ®ï¼è¿äºæ°æ®ä¼æç§é¾è¡¨çæ ¼å¼å­å¨ï¼æä»¬å°è¿äºæ°æ®åä¸ºå¾å¤ç»ï¼æ¯ä¸ªç»çæåä¸æ¡è®°å½\n\nçå°åæ½ååºæ¥è®°å½å¨ page directory ä¸­ã\n\nè¿éçæ´ä¸ªç­å°±æ¯ä¸ä¸ªé¡µï¼åä¸ªç»å°±æ¯mysqlä¸­çç»ï¼ç»é¿å°±æ¯æ¯ä¸ªç»çæåä¸æ¡æ°æ®ï¼ç»é¿ç¾¤å°±æ¯ page directoryãè¿å¥ç»é¿ç¾¤åçç»é¿è¢«ç§°ä¸ºâæ§½âã\n\n\n\næ³¨æï¼\n\n * æ§½0ä¸­çæ°å­ä¸º91ï¼ä»£è¡¨æå°è®°å½çå°ååç§»éä¸º91å­èã\n * æ§½1ä¸­çæ°å­ä¸º122ï¼ä»£è¡¨æå¤§è®°å½çå°ååç§»éä¸º122å­èã\n * æ§½0æåæå°è®°å½ï¼ä»£è¡¨æå°è®°å½åç¬ä¸ç»ï¼ä¹å°±åªææå°è®°å½è¿ä¸æ¡æ°æ®ï¼æä»¥å®çn_ownedå¼ä¸º1ã\n * æ§½1æåæå¤§è®°å½ï¼ä»£è¡¨æå¤§è®°å½ä»¥åä¹åçæ°æ®ä¸ºä¸ç»ï¼æä»¥å®çn_ownedä¸º4\n\né£ä¹ä¸ºä»ä¹æå°è®°å½åç¬ä¸ç»å¢ï¼å ä¸ºè§å®ï¼mysqlå¯¹äºæ¯ä¸ªåç»ä¸­çè®°å½ä¸ªæ°æ¯æè§å®çï¼æå°è®°å½æå¨çåç»åªè½ç±1æ¡è®°å½ï¼æå¤§è®°å½æå¨çåç»å¯ä»¥æ1~8æ¡è®°å½ï¼å©ä¸çå¶ä»åç»å¯ä»¥æ4~8æ¡è®°å½ã\n\næä»¬çä¸ä¸æ°æ®å¤çæ¶åï¼\n\n\n\nå¦å¾æç¤ºï¼å½æ15æ¡æ°æ®æ¶ï¼æ»è®°å½æ°ä¸º17ï¼è¢«åä¸º5ä¸ªç»ï¼å±æ5ä¸ªæ§½ä½ï¼æ§½ä½å¯¹åºçæ°æ®æ¡æ°åå«ä¸ºï¼1ã4ã4ã4ã3ã\n\nä½æ¯ï¼æå¥çæ¶åæ¯æè®²ç©¶çï¼\n\n * åå§æåµä¸æ¯æ²¡æç¨æ·æ°æ®çï¼åªæä¸¤ä¸ªç»ï¼æå°è®°å½ç»ä¸æå¤§è®°å½ç»ã\n * ä¹åæ²¡æå¥ä¸æ¡è®°å½ï¼é½ä¼ä»é¡µç®å½ï¼æ§½ä½ï¼ä¸­æ¾å°ä¸»é®å¼æ¯æ¬è®°å½å¤§ï¼å¹¶ä¸å·®å¼æå°çæ§½ä½ï¼ç¶åæè¯¥æ§½ä½æåçè®°å½ç n_owned å¼å ä¸ï¼è¡¨ç¤ºæ¬ç»ååæ·»å äºä¸æ¡è®°å½ï¼ç´å°è¯¥ç»ä¸­çè®°å½æ°ç­äº8ä¸ªã\n * å½ç»ä¸­çè®°å½æ°ç­äº8ä¸ªæ¶ï¼åæ¬¡æå¥ä¼å°æ¬ç»åä¸ºä¸¤ä¸ªç»ï¼å å¥åä¸º4ç»å5ç»ï¼ç¬¬åç»æ4æ¡è®°å½ï¼ç¬¬äºç»æ5æ¡è®°å½ãå ä¸ºæåäºï¼æä»¥é¡µç®å½ä¸­ä¼å¢å ä¸ä¸ªæ§½ä½ã\n\nå¼æ¸äºåç»çæåµï¼ç°å¨æä»¬å¯ä»¥æ¥æ¥æ¾äºï¼åå¦æ³è¦æ¥æ¾å° id=8 çæ°æ®ãä»å¾ä¸­å¯ä»¥çå°å®å¨ç¬¬ä¸ç»ã\n\nå ä¸ºåä¸ªæ§½æåçè®°å½çä¸»é®é½æ¯ä»å°å°å¤§æåçï¼æä»¥æä»¬å¯ä»¥ä½¿ç¨äºåæ³ã\n\næ­¤æ¶å±æ5ç»ï¼ç¼å·ä¸º 0ã1ã2ã3ã4 ï¼è®° low = 0ï¼high = 4\n\n 1. ï¼low + highï¼/ 2 = 2ï¼ç¬¬äºä¸ªæ§½ä½å¯¹åºçè®°å½çidä¸º9ï¼å¤ªå¤§äºï¼highæ¹ä¸º2\n 2. ï¼low + highï¼/ 2 = 1ï¼ç¬¬ä¸ä¸ªæ§½ä½å¯¹åºçè®°å½çidä¸º5ï¼å¤ªå°äºï¼lowæ¹ä¸º1\n 3. å ä¸º high - low = 1ï¼å¯ä»¥è¯´æç®æ æ°æ®å°±å¨ ç¬¬äºç» ä¸­ï¼æä»¬åªéè¦è·ålowæ§½ä½å¯¹åºçæ°æ®(ç¬¬ä¸ç»çæåä¸ä¸ªæ°æ®)ï¼åä¸æ¾ä¸ä¸ªæ°æ®å°±å°è¾¾ç¬¬äºç»çæå°æ°æ®ï¼æ­¤æ¶highæåçæ§½ä½çè®°å½æ°æ¯ç¬¬äºç»çæå¤§è®°å½ï¼è·å¾äºæå¤§ä¸æå°ï¼id=8çæ°æ®è¿ä¸æ¯å¾æå¯å¾ï¼\n\næä»¥å¨ä¸ä¸ªæ°æ®é¡µä¸­æ¥æ¾æå®ä¸»é®å¼çè®°å½çè¿ç¨åä¸ºä¸¤æ­¥ï¼\n\n * éè¿äºåæ³ç¡®å®è¯¥è®°å½æå¨çæ§½ï¼å¹¶æ¾å°æ¹æ§½ä¸­ä¸»é®å¼æå°çé£æ¡è®°å½ã\n * éè¿è®°å½ç next_record å±æ§éåè¯¥æ§½ï¼æ¾å°ç®æ æ°æ®ã\n\n\n# 2.3 page headerï¼é¡µå¤´é¨ä¿¡æ¯ï¼\n\n\n\næ°æ®é¡µå¤´é¨ä¿¡æ¯ï¼è¡æ°æ®å­æ®µè®°å½æ¬è¡çåºæ¬ä¿¡æ¯ï¼é£ä¹é¡µæ°æ®ä¹ä¼æä¸é¨çå­æ®µè®°å½æ¬é¡µçä¿¡æ¯ï¼èpage headerå°±æ¯ç¨äºè®°å½ä¸ä¸ªæ°æ®é¡µçç¶æä¿¡æ¯ï¼æ¯å¦æ¬é¡µå­å¨äºå¤å°ä¸ªæ§½ãå¤å°ä¸ªæ°æ®ç­ç­...\n\nå·ä½æä»ä¹å­æ®µï¼æ¥çè¡¨æ ¼ï¼(ç±äºå­æ®µå¤ªå¤äºï¼è¿æ¯ç²¾ç®è¿çå­æ®µ)\n\nåç§°                 ä½ç¨\npage_n_dir_slots   è¯¥é¡µçé¡µç®å½ä¸­çæ§½çæ°é\npage_n_heap        æ¬é¡µä¸­çè®°å½çæ°éï¼å é¤&æªå é¤ï¼\npage_level         å½åé¡µå¨b+æ æå¤çå±çº§\npage_index_id      æ¬é¡µå±äºåªä¸ªç´¢å¼\n\n\n# 2.4 file headerï¼æä»¶å¤´ï¼\n\n\n\nfile headeræ¯æ¯ç§é¡µé½æçå±æ§ï¼å¶ä¸­éè¦çå­æ®µå¦ï¼æ¬é¡µç¼å·ãä¸ä¸é¡µç¼å·ãä¸ä¸é¡µç¼å·ãæ ¡éªåã\n\nä¸ä¸ä¸ªä¸ä¸ä¸ä¸ªé¡µçç¼å·ï¼å¯ä»¥å°æææ°æ®é¡µç»æä¸ä¸ªåé¾è¡¨ï¼éåå°±å¾æ¹ä¾¿äºã\n\nfile headerä¸­æä¸ä¸ªå¾éè¦çå­æ®µï¼æ ¡éªåã\n\nä»ä¹æ¯æ ¡éªåï¼\n\nå¯¹äºä¸ä¸ªå¾é¿å¾é¿çå­ç¬¦ä¸²æ¥è¯´ï¼æä»¬ä¼ä½¿ç¨æç§ç®æ³æ¥è®¡ç®ä¸ä¸ªæ¯è¾ç­çå­ç¬¦ä¸²æ¥ä»£æ¿å®ï¼æ¯å¦æä»¬éå¸¸ç¨æä»¶çmd5ç¼ç æ¥åæ­¥æ¯è¾æä»¶æ¯å¦ç¸ç­ã\n\næä»¬æ³æ¯è¾ä¸¤ä¸ªå¾é¿çå­ç¬¦ä¸²çæ¶åï¼å¯ä»¥åæ¯è¾ä»ä»¬çæ ¡éªåï¼å¦æè¿æ ¡éªåé½ä¸ä¸æ ·ï¼é£è¿ä¸¤ä¸ªå­ç¬¦ä¸²å°±è¯å®ä¸ä¸æ ·ãè¿æ ·å°±çå»äºä¸ä¸ªå­ç¬¦ä¸ä¸ªå­ç¬¦æ¯è¾æ¶èçæ¶é´ã\n\nåæ¶ï¼file headerçæ ¡éªåè¿ä¼åfile trailerçæ ¡éªåéåå·¥ä½ï¼ä¸é¢ä¼ä»ç»ã\n\n\n# 2.5 file trailerï¼æä»¶å°¾ï¼\n\n\n\nfile trailerè·file headerä¸æ ·ï¼æä¸ä¸ªæ ¡éªåï¼é£ä¹è¿ä¸ªæ ¡éªåå°åºæ¯ä»ä¹ä½ç¨å¢ï¼\n\næä»¬ç¥éinnodbå­å¨å¼æä¼å°æ°æ®ä»ç£çä¸­è¯»å°åå­ä¸­ï¼ä»¥é¡µä¸ºåä½ãå¦ææ°æ®å¨åå­ä¸­ä¿®æ¹äºï¼é£ä¹mysqlå¿å¿è¦æä»ä»¬åååç£çä¸­ï¼ååçè¿ç¨ä¸­ä¸ä¸åºç°äºä»ä¹éæä¹åï¼è¿ä¸æ¯å°´å°¬äºåï¼ä¸ºäºæ£éªä¸ä¸ªé¡µæ¯å¦å®æ´ï¼ä¹å°±æ¯åæ­¥çæ¶åæ¯å¦åºç°åæ­¥äºä¸åçæåµï¼ï¼mysqlå°±å¨é¡µçå¤´é¨åå°¾é¨é½å äºæ ¡éªåè¿ä¸ªä¸è¥¿ã\n\næ¯å½ä¸ä¸ªé¡µå¨åå­ä¸­ä¿®æ¹äºï¼å¨åæ­¥ä¹åå°±è¦æå®çæ ¡éªåç®åºæ¥ãfile headerå¨é¡µçæåé¢ï¼æä»¥æ ¡éªåä¼è¢«ä¼ååæ­¥ï¼å¦æå®å¨åå®ï¼é£ä¹å°¾é¨çæ ¡éªåä¹ä¼åè¿å»ï¼è¿æ²¡é®é¢ãä¸ä¸ä¸­æ­äºï¼é£ä¹file headerçæ ¡éªåæ¯å·²ç»ä¿®æ¹è¿çé¡µï¼file trailerçæ ¡éªåæ¯ååçé¡µï¼äºèä¸ç¸åï¼è¯´æåæ­¥è¿ç¨ä¸­åºç°bugã\n\nï¼å¶å®è¿æä¸ä¸ªå­æ®µï¼ç°å¨åä¸ç®¡ï¼\n\n\n# 3. æ»ç»\n\n 1. innodbä¸ºäºä¸åçç®çèè®¾è®¡äºä¸åçé¡µç±»åï¼æä»¬æå­æ¾æ°æ®çé¡µç§°ä¸ºæ°æ®é¡µã\n\n 2. æ°æ®é¡µå¯ä»¥è¢«åä¸º7ä¸ªé¨åï¼\n    \n    1. file headerï¼è¡¨ç¤ºé¡µçä¸äºéç¨ä¿¡æ¯\n    2. page headerï¼è¡¨ç¤ºæ°æ®é¡µä¸æçä¿¡æ¯\n    3. infimum + supermumï¼ä¸¤ä¸ªèæçä¼ªè®°å½ï¼åå«è¡¨ç¤ºé¡µä¸­çæå°è®°å½åæå¤§è®°å½\n    4. user recordsï¼å­æ¾æä»¬æå¥çæ°æ®\n    5. free spaceï¼é¡µä¸­å¯ä»¥è¢«æä»¬ä½¿ç¨çæ°æ®\n    6. page directoryï¼é¡µä¸­çæäºè®°å½çç¸å¯¹ä½ç½®ï¼å¶ä¸­å­æ¾å¾å¤æ§½ä½\n    7. file trailerï¼é¡µå°¾ï¼ä¸file headerä¸èµ·æä¾æ ¡éªåæ¥æ£æ¥åæ­¥ç¶æ\n\n 3. æ¯ä¸ªæ°æ®é¡µçfile headeré½æä¸ä¸ä¸ªä¸ä¸ä¸ä¸ªé¡µçç¼å·ï¼æä»¥ææçæ°æ®é¡µä¼ç»æä¸ä¸ªåé¾è¡¨\n\n 4. user recordsä¸­çæ¯ä¸æ¡è®°å½ænext_recordï¼å®å°ææè®°å½ä¸²èä¸ºä¸ä¸ªé¾è¡¨ï¼å·²å é¤çåæªå é¤çï¼å±ä¸¤ä¸ªé¾è¡¨ï¼\n\n 5. ä¸ºä¿è¯åå­å°ç£ççåæ­¥çå®æ´æ§ï¼å¨æ°æ®é¡µçé¦é¨åæ°æ®é¡µçå°¾é¨é½ä¼å­å¨é¡µä¸­æ°æ®çæ ¡éªå\n\nâ",charsets:{cjk:!0},lastUpdated:"2023/06/08, 21:54:53",lastUpdatedTimestamp:1686232493e3},{title:"åæºå®æ¶ä»»å¡çå®ç°",frontmatter:{title:"åæºå®æ¶ä»»å¡çå®ç°",date:"2024-06-11T23:06:35.000Z",permalink:"/pages/d8c9ba/"},regularPath:"/02.%E6%96%87%E7%AB%A0/01.Java%E5%9F%BA%E7%A1%80/300.%E5%8D%95%E6%9C%BA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0.html",relativePath:"02.æç« /01.Javaåºç¡/300.åæºå®æ¶ä»»å¡çå®ç°.md",key:"v-afa30cfc",path:"/pages/d8c9ba/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. Timer",slug:"_2-timer",normalizedTitle:"2. timer",charIndex:350},{level:3,title:"2.1 TimerQueue",slug:"_2-1-timerqueue",normalizedTitle:"2.1 timerqueue",charIndex:511},{level:3,title:"2.2 TimerThread",slug:"_2-2-timerthread",normalizedTitle:"2.2 timerthread",charIndex:2441},{level:3,title:"2.3 æ»ç»",slug:"_2-3-æ»ç»",normalizedTitle:"2.3 æ»ç»",charIndex:6375},{level:2,title:"3. ScheduledThreadPoolExecutor",slug:"_3-scheduledthreadpoolexecutor",normalizedTitle:"3. scheduledthreadpoolexecutor",charIndex:6428},{level:2,title:"4. HashedWheelTimer",slug:"_4-hashedwheeltimer",normalizedTitle:"4. hashedwheeltimer",charIndex:6533}],headersStr:"1. ç®è¿° 2. Timer 2.1 TimerQueue 2.2 TimerThread 2.3 æ»ç» 3. ScheduledThreadPoolExecutor 4. HashedWheelTimer",content:"# 1. ç®è¿°\n\næ¬ç¯æç« ä»ç»çæ¯åæºå®æ¶ä»»å¡çå®ç°ï¼ä¸åæ¬å XXL-JOBãPower-JOB è¿æ ·çåå¸å¼å®æ¶ä»»å¡ã\n\nåæºçå®æ¶ä»»å¡ç¨çæ¯è¾å¤çå®ç°æ JDK æä¾ç TimerãScheduledThreadPoolExecutorãNetty å Dubboç HashedWheelTimerã\n\nå®ç°å®æ¶ä»»å¡ï¼é½è¦ä½¿ç¨ç¹å®çå®¹å¨ï¼å ä¸ºè¿äºä»»å¡éè¦å¨æå®çæ¶é´æ§è¡ï¼ä½ æä¹ç¥éä»ä¹æ¶åæåªäºä»»å¡è¦æ§è¡å¢ï¼æä»¥å°±è¦ä½¿ç¨çº¿ç¨ä¸ç´è½®è¯¢è¿ä¸ªå®¹å¨ã\n\næ ¹æ®ä¸é¢è¯´çï¼å®ç°å®æ¶ä»»å¡æä¸¤ä¸ªå³é® ï¼\n\n 1. å­å¨ä»»å¡çå®¹å¨\n 2. è½®è¯¢å®¹å¨çæ¹å¼\n\næ¥ä¸æ¥å°±ççTimerãScheduledThreadPoolExecutorã HashedWheelTimer å®ä»¬å¯¹äºå®æ¶ä»»å¡çå®ç°ã\n\n\n# 2. Timer\n\nTimer ä½¿ç¨å ä½ä¸ºå­å¨ä»»å¡çå®¹å¨ï¼èä¸æ¯å°æ ¹å ï¼ä»»å¡æ ¹æ®æ¶é´æ³çå¤§å°å¨å ä¸­æåºã\n\nä½ æ³åï¼ä»»å¡æ¯æå®æ¶é´æ§è¡çï¼é£ä¹æå°ç¦»ç°å¨æè¿çä»»å¡ï¼ä¹å°±æ¯æ¶é´æ³æå° çä»»å¡æ¾å¨å°æ ¹å çæä¸é¢ï¼çº¿ç¨æ¯ä¸æ¬¡åï¼é½å¯ä»¥å°ææ©éè¦æ§è¡çä»»å¡ååºæ¥ãçº¿ç¨çè½®è¯¢æ¹å¼ä¹å°±æäºï¼åä»»å¡ãæ§è¡ä»»å¡ãåè°ï¼æ¯ç¥ð\n\n\n# 2.1 TimerQueue\n\nè¯´å°å ï¼ä½ å¨ç¬¬ä¸æ¬¡å­¦ä¹ å çä½¿ç¨ä½¿ç¨ä»ä¹æ¹å¼å®ç°çå å¢ï¼æçå¤§å¤æ°é½æ¯ç¨æ°ç»æ¥å®ç°ãTimerä¹æ¯å¦æ­¤ï¼Timer ä½¿ç¨æ°ç»æ¥å®ç°å ï¼å¹¶å°å¶å°è£ä¸º TimerQueueã\n\nå¶å®æå®å¨å¯ä»¥å° TimerQueue çå¨é¨ä»£ç å±ç¤ºç»ä½ ï¼å ä¸ºå®å¨æ¯å¤ªç­äº\n\nclass TaskQueue {\n    \n\t// ä½ å¯è½ä¸ç¥é TimerTaskæ¯å¥ï¼ä¸éè¦ï¼è¿åªæ¯ä¸ä¸ªå­æ¾ä»»å¡çæ°ç»\n    private TimerTask[] queue = new TimerTask[128];\n\t// æ°æ®ä¸ªæ°\n    private int size = 0;\n\n    void add(TimerTask task) {\n        // å¦æå®¹éè¶äºå°±æ©å®¹ã\n        if (size + 1 == queue.length)\n            queue = Arrays.copyOf(queue, 2*queue.length);\n\t\t// æ·»å ä»»å¡ï¼ç¶åæ ¹æ®è¿ä¸ªä»»å¡çæ§è¡æ¶é´å°å¶åä¸è°æ´\n        queue[++size] = task;\n        fixUp(size);\n    }\n\n\t// è·åæè¿è¦æ§è¡çä»»å¡\n    TimerTask getMin() {\n        return queue[1];\n    }\n\n    /**\n     * å é¤æè¿çä»»å¡\n     */\n    void removeMin() {\n        queue[1] = queue[size];\n        queue[size--] = null;  \n        fixDown(1);\n    }\n\n    private void fixUp(int k) {\n        while (k > 1) {\n            int j = k >> 1;\n            if (queue[j].nextExecutionTime <= queue[k].nextExecutionTime)\n                break;\n            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;\n            k = j;\n        }\n    }\n\n    private void fixDown(int k) {\n        int j;\n        while ((j = k << 1) <= size && j > 0) {\n            if (j < size && queue[j].nextExecutionTime > queue[j+1].nextExecutionTime)\n                j++; \n            \n            if (queue[k].nextExecutionTime <= queue[j].nextExecutionTime)\n                break;\n            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;\n            k = j;\n        }\n    }\n\n    void heapify() {\n        for (int i = size/2; i >= 1; i--)\n            fixDown(i);\n    }\n}\n\n\n\nå®å¨æ¯ç®åå°çç¸ï¼è¿ä¸å°±æ¯æä»¬å®ç°çå åï¼æ¯«æ éè¯»é¾åº¦ãå æ éå°±æ¯ä¸¤ä¸ªæä½ ï¼ä¸è°ãä¸è°ãè¿éé¢ fixUpå fixDown å°±ä»£è¡¨äºè¿ä¸¤ä¸ªæä½ã\n\nå¶å®æå åäºé¨åæ¹æ³ï¼ææ¥å±ç¤ºå¶ä¸­ä¸ä¸ª ï¼\n\n    void rescheduleMin(long newTime) {\n        queue[1].nextExecutionTime = newTime;\n        fixDown(1);\n    }\n\n\nschedule æ¯å®æ¶ï¼reschedule æ¯éæ°å®æ¶ï¼min æ¯æå°ï¼è¿ä¸ªæ¹æ³çææå°±æ¯å°æè¿çä»»å¡éæ°å®æ¶ï¼ç¨äºä½å¤ï¼ä½æ¶ä½¿ç¨å¢ï¼\n\nå½ç¬¬ä¸ä¸ªä»»å¡æ§è¡å®æåï¼è¿ä¸ªä»»å¡æ¯å®æ¶çï¼å®ä¸å¤©æ§è¡ä¸æ¬¡ï¼ä¸ä¸æ¬¡æ§è¡å°±æ¯ä¸å¤©åäºï¼é£ä¹æä»¬å°±è¦éæ°è®¡ç®å®çä¸ä¸æ¬¡æ§è¡æ¶é´ï¼ç¶åå°å¶ç§»å°å°æ ¹å çä¸é¢æå¤ã\n\n\n# 2.2 TimerThread\n\næ´ä¸ªä»£ç ä¹ç¹å«ç¹å«å°ï¼åªæ80è¡ï¼ä½æ¯æåä¸åå¤ç´æ¥æ¾ä»£ç äºãåæ¥çä¸ä¸è¿ä¸ªçº¿ç¨çå·¥ä½æ¹å¼ï¼\n\n 1. ä»å°æ ¹å å é¡¶ååºä»»å¡ï¼ä½æ¯ä¸è½å é¤\n 2. è®¡ç®ä»»å¡çæ§è¡æ¶é´ä¸å½åæ¶é´çå·®è·ï¼è®©æ­¤çº¿ç¨ç¡ç å°ä»»å¡çæ§è¡æ¶é´\n 3. æ§è¡ä»»å¡\n 4. éæ°è®¡ç®è¯¥ä»»å¡çæ§è¡æ¶é´å¹¶è°æ´å°æ ¹å ã\n 5. ç»§ç»­éå¤ç¬¬ä¸æ­¥\n\nç±äºæ¯çº¿ç¨ï¼æä»¥è¦å®ç° run() æ¹æ³ï¼ä¸»è¦é»è¾å¨ run() æ¹æ³ä¸­ ï¼\n\n    public void run() {\n        try {\n            mainLoop();\n        } finally {\n            // æ§è¡ç»ææä¸¤ç§æåµ:\n            // æ­£å¸¸è¿è¡ç»æ: å°æ ¹å ä¸­æ æ°æ®\n            // å¼å¸¸è¿è¡ç»æ: æå¶ä»çº¿ç¨å°æ­¤ä»»å¡ç»æ­¢ï¼æä»¬è¦æ¸é¤å°æ ¹å ä¸­çä»»å¡ã\n            synchronized(queue) {\n                newTasksMayBeScheduled = false;\n                queue.clear();   \n            }\n        }\n    }\n\n\nä»ä¸é¢å¯ä»¥çå°ï¼run() è°ç¨äº mainLoop() ï¼çå° Loop ä½ å°±åºè¯¥æ³å° å¾ªç¯ãè½®è¯¢ è¿äºå³é®è¯ã\n\nprivate void mainLoop() {\n        while (true) {\n            try {\n                TimerTask task;\n                boolean taskFired;\n                synchronized(queue) {\n                    // å½å°æ ¹å ä¸­æ ä»»å¡æ¶ï¼å½åçº¿ç¨waité»å¡ã\n                    // æ­¤çº¿ç¨ä»ä¹æ¶åè¢«å¤éå¢ï¼å» TimerQueue ä¸­å¯»æ¾ queue.notifyAllæ²¡ææ¾å°\n                    // ç²çå¤éé»è¾å¨ Timer ä¸­ã\n                    while (queue.isEmpty() && newTasksMayBeScheduled)\n                        queue.wait();\n                    if (queue.isEmpty())\n                        break; \n\n                    // å½åæ¶é´\n                    long currentTime; \n                    // ä»»å¡çæ§è¡æ¶é´\n                    long executionTime;\n                    // å¾å°æè¿è¦æ§è¡çä»»å¡\n                    task = queue.getMin();\n                    // éä½è¯¥ä»»å¡\n                    synchronized(task.lock) {\n                        // å¦æä»»å¡å·²ç»åæ¶ï¼ä¸ç¨æ§è¡äºï¼ç´æ¥å äº\n                        if (task.state == TimerTask.CANCELLED) {\n                            queue.removeMin();\n                            continue;  \n                        }\n                        // è·åå½åæ¶é´åä»»å¡çæ§è¡æ¶é´\n                        currentTime = System.currentTimeMillis();\n                        executionTime = task.nextExecutionTime;\n                        // å¦æä»»å¡çæ§è¡æ¶é´å°äºå½åæ¶é´ï¼é£ä¹ä»»å¡å°±å¯ä»¥æ§è¡äº\n                        if (taskFired = (executionTime<=currentTime)) {\n                            // ççä»»å¡æ¯å¨ææ§ä»»å¡è¿æ¯ä¸æ¬¡æ§ä»»å¡\n                            // å¦ææ¯ä¸æ¬¡æ§ä»»å¡å°±æ ééæ°è®¡ç®è¯¥ä»»å¡çæ§è¡æ¶é´\n                            if (task.period == 0) { \n                                queue.removeMin();\n                                task.state = TimerTask.EXECUTED;\n                            } else { \n                                // å¦ææ¯å¨ææ§ä»»å¡ï¼æ¥çæ¯å»¶æ¶ä»»å¡è¿æ¯å®æ¶ä»»å¡, åæ¶è®¡ç®ä¸æ¬¡æ§è¡æ¶é´\n                                queue.rescheduleMin(\n                                  task.period<0 ? currentTime   - task.period\n                                                : executionTime + task.period);\n                            }\n                        }\n                    }\n                    // å¦æä»»å¡çæ§è¡æ¶é´å¤§äºå½åæ¶é´ï¼æ­¤çº¿ç¨ç¡å°ä»»å¡è¯¥æ§è¡çæ¶åã\n                    if (!taskFired) // Task hasn't yet fired; wait\n                        queue.wait(executionTime - currentTime);\n                }\n                // æ§è¡ä»»å¡\n                if (taskFired)  // Task fired; run it, holding no locks\n                    task.run();\n            } catch(InterruptedException e) {\n            }\n        }\n    }\n\n\n 1. ä¸ºä»ä¹è¦å é synchronized(queue) ï¼\n    \n    å ä¸ºæ­¤çº¿ç¨åä»»å¡ï¼å¶ä»çº¿ç¨å¯è½å queue ä¸­æ¾ä»»å¡ï¼æä»¥è¦å®ç°å¹¶åå®å¨ã\n    \n    åæ¶å¯ä»¥çå°å®å  synchronized çèå´ç¹å«å°ï¼ä¸åæ¬ä»»å¡çæ§è¡ï¼åªåæ¬ä»»å¡ç¶æçä¿®æ¹ãä»»å¡æ§è¡æ¶é´çä¿®æ¹ã\n\n 2. å»¶æ¶ä»»å¡åå®æ¶ä»»å¡çåºå«æ¯ä»ä¹ï¼\n    \n    å»¶æ¶ä»»å¡ç®ä¸äºä»»å¡çæ§è¡æ¶é´ï¼å®æ¶ä»»å¡ä¸ç®ã\n    \n    ä¸¾ä¾ï¼ä¸ä¸ªä»»å¡ 10s æ§è¡ä¸æ¬¡ï¼æ¯æ¬¡æ§è¡ 5s\n    \n    å¦æè¯¥ä»»å¡ä¸ºå®æ¶ä»»å¡ ï¼ä»»å¡çæ§è¡æ¶é´ä¸º 10ã20ã30ã40...\n    \n    å¦æè¯¥ä»»å¡æ¯å»¶æ¶ä»»å¡ ï¼ä»»å¡çæ§è¡æ¶é´ä¸º 10ã25ã40ã55\n\nTimerThread æ¯å¦ä½åºåå®æ¶ä»»å¡åå»¶æ¶ä»»å¡çå¢ï¼æ¥çä¸¤ä¸ªæ¹æ³ ï¼\n\n    // å»¶æ¶ä»»å¡\n\tpublic void schedule(TimerTask task, Date firstTime, long period) {\n        sched(task, firstTime.getTime(), -period);\n    }\n\n\n    // å®æ¶ä»»å¡\n\tpublic void scheduleAtFixedRate(TimerTask task, Date firstTime, long period) {\n        sched(task, firstTime.getTime(), period);\n    }\n\n\nåºå«æ¯ä»ä¹ï¼å¨è°ç¨ super(...) æ¶ period çæ­£è´ï¼ç°å¨ååå»ç TimerThread éæ°è®¡ç®ä»»å¡çæ§è¡æ¶é´é£ä¸æ®µå§ ï¼\n\n// currentTime : å½åæ¶é´ï¼æ¢è¨ä¹ï¼ä»»å¡æ§è¡çç»ææ¶é´\n// executionTime : ä»»å¡å¼å§æ§è¡çæ¶é´\n\tqueue.rescheduleMin(\n    \ttask.period < 0 ? \n        currentTime   - task.period : \n        executionTime + task.period\n    );\n\n\n\n# 2.3 æ»ç»\n\næ²¡äºï¼Timerå°±æ¯å¦æ­¤ç®åãä½¿ç¨å°æ ¹å å­æ¾å®æ¶ä»»å¡ï¼ä½¿ç¨çº¿ç¨æ«æå°æ ¹å çå é¡¶ã\n\n\n# 3. ScheduledThreadPoolExecutor\n\nScheduledThreadPoolExecutor ä¹ä½¿ç¨å ä½ä¸ºå­å¨ä»»å¡çå®¹å¨ï¼å¯ä¸ä¸ Timer ä¸åçæ¯ï¼æ«æå®¹å¨ççº¿ç¨åå¤äºã\n\n\n# 4. HashedWheelTimer\n\nNetty å Dubbo ä»¥åå¾å¤æ¡æ¶é½æå®çå¯¹åºå®ç°ï¼æ ¸å¿ææ³é½ä¸æ ·ãå®ä»¬é½å°ä»»å¡æ¾å¨æ°ç»ä¸­ï¼ä½¿ç¨çº¿ç¨æ«ææ°ç»ã\n\nï¼åªæ Netty å Dubbo æ¯å ä¸ºæåªçè¿å®ä¿©çæºç ï¼å¶å® Kafka çæ¶é´è½®æ´åï¼å¯ä»¥ä½ä¸ºä½ çæ©å±å­¦ä¹ åå®¹ï¼\n\nä¸å ä¸åçæ¯ï¼æ­¤æ°ç»æ¨¡æçæ¯ä¸ä¸ªè½®å­ï¼å®çæ¯ä¸ä¸ªå»åº¦ä»£è¡¨çä¸ä¸ªæ¶é´æ®µï¼æ¯å¦å¤§å°ä¸º 60 çæ°ç»ï¼æ°ç»ä¸­çæ¯ä¸ä¸ªåç´ å¯ä»¥ä»£è¡¨1sï¼é£ä¹è¿ä¸ªæ°ç»å°±å¯ä»¥æ¨¡æä¸ä¸ªéè¡¨ï¼çº¿ç¨æ¨¡æç§éï¼å¨å¾ªç¯éåçæ¶ååªéè¦æ¯ 1s æ§è¡é£ä¸ªæ¶é´æ®µçææä»»å¡ï¼å°±å¯ä»¥å®ç°âå®æ¶åè½âã\n\né®ä¸ä¸ªé®é¢ï¼åªä¸ªçº¿ç¨å°ä»»å¡æ¾å¨æ¶é´è½®ä¸­ï¼ä»»å¡çº¿ç¨ä¼åæ¶é´è½®ä¸­çä»»å¡å»æ§è¡ï¼main çº¿ç¨å¦æå¯ä»¥ç´æ¥æ¥è§¦å°æ¶é´è½®çè¯ï¼æä»¬å°±éè¦ä¿è¯æ¶é´è½®çå¹¶åå®å¨äºãä½æ¯æä¸æ³è®©å¹¶åé®é¢åçå¨æ¶é´è½®ä¸ï¼å¦ä½å®ç°ï¼\n\n 1. main çº¿ç¨å°ä»»å¡æ¾å°ä¸ä¸ªæ®éçæ°ç»ä¸­\n 2. ä»»å¡çº¿ç¨å°ä»»å¡ä»æ®éçæ°ç»ä¸­ååºï¼è®¡ç®ä»»å¡çæ§è¡æ¶é´ï¼ç¶åå°å¶æ¾å°å¯¹åºçå»åº¦ä¸ã\n\nä¸è®© main çº¿ç¨æ¥è§¦å°æ¶é´è½®æ°ç»ï¼å°±å¯ä»¥å°å¹¶åé®é¢æ§å¶å¨æ®éæ°ç»ä¸­ï¼æ¶é´è½®åªè´è´£å°ä»»å¡æç§æ¶é´ç»´åº¦å­å¨å³å¯ãä¸ºä»ä¹è¦å°å¹¶åé®é¢æ§å¶å¨æ®éæ°ç»èä¸æ¯æ¶é´è½®æ°ç»ï¼å ä¸ºæ¾å¨æ®éæ°ç»æ¶ï¼æä»¬åªéè¦æ¾/åï¼èæ¾å¨æ¶é´è½®æ°ç»ä¸­ï¼æä»¬ååè¿è¦å¤æ­ä¸æ¬¡æ¶é´åæ¾è¿å»ï¼æ¶åå°å¾å¤ç¶æçä¿®æ¹ï¼äºæ¯å¹¶åæåµå°±æ´å¤ã\n\nè¿æä¸ä¸ªé®é¢ ï¼å¦æä»»å¡çæ§è¡æ¶é´ç¦»ç°å¨å¤ªè¿äºï¼æ¯å¦æä¸ä¸ªä»»å¡å¨æå¤©æ§è¡ï¼æä»¬éè¦åå»ºä¸ä¸ª 24 * 60 * 60 ä¸ªåç´ çæ°ç»åï¼è¯å®ä¸è½ï¼æä»¬å¯ä»¥ä½¿ç¨åæ°æ¥ä»£è¡¨ä»»å¡è·ç¦»ç°å¨çæ¶é´ï¼æå¤©æ§è¡çä»»å¡å¯ä»¥æ¾å¨ç¬¬1ä¸ªå»åº¦ä¸ï¼è¯¥ä»»å¡çåæ°ä¸º 24 * 60ï¼æ¯ä¸æ¬¡å¾ªç¯å°å®é½å°è¿ä¸ªåæ°å1ï¼å½åæ°ä¸º 0 æ¶å³å¯æ§è¡ã\n\né®é¢æ»ç»å®äºï¼æ¥çä¸ä¸ HashedWheelTimer çå·¥ä½æµç¨ï¼\n\n 1. main çº¿ç¨è´è´£å°ä»»å¡æ¾å°æ®éæ°ç»ä¸­\n 2. ä»»å¡çº¿ç¨æ¯æ¬¡å¾ªç¯é½ä»æ®éæ°ç»ä¸­åä»»å¡ï¼å°å¶æ¾å°å¯¹åºçå»åº¦ä¸­ï¼ç¶åæ§è¡æ­¤æ¶æåçå»åº¦ä¸­çææä»»å¡ã",normalizedContent:"# 1. ç®è¿°\n\næ¬ç¯æç« ä»ç»çæ¯åæºå®æ¶ä»»å¡çå®ç°ï¼ä¸åæ¬å xxl-jobãpower-job è¿æ ·çåå¸å¼å®æ¶ä»»å¡ã\n\nåæºçå®æ¶ä»»å¡ç¨çæ¯è¾å¤çå®ç°æ jdk æä¾ç timerãscheduledthreadpoolexecutorãnetty å dubboç hashedwheeltimerã\n\nå®ç°å®æ¶ä»»å¡ï¼é½è¦ä½¿ç¨ç¹å®çå®¹å¨ï¼å ä¸ºè¿äºä»»å¡éè¦å¨æå®çæ¶é´æ§è¡ï¼ä½ æä¹ç¥éä»ä¹æ¶åæåªäºä»»å¡è¦æ§è¡å¢ï¼æä»¥å°±è¦ä½¿ç¨çº¿ç¨ä¸ç´è½®è¯¢è¿ä¸ªå®¹å¨ã\n\næ ¹æ®ä¸é¢è¯´çï¼å®ç°å®æ¶ä»»å¡æä¸¤ä¸ªå³é® ï¼\n\n 1. å­å¨ä»»å¡çå®¹å¨\n 2. è½®è¯¢å®¹å¨çæ¹å¼\n\næ¥ä¸æ¥å°±ççtimerãscheduledthreadpoolexecutorã hashedwheeltimer å®ä»¬å¯¹äºå®æ¶ä»»å¡çå®ç°ã\n\n\n# 2. timer\n\ntimer ä½¿ç¨å ä½ä¸ºå­å¨ä»»å¡çå®¹å¨ï¼èä¸æ¯å°æ ¹å ï¼ä»»å¡æ ¹æ®æ¶é´æ³çå¤§å°å¨å ä¸­æåºã\n\nä½ æ³åï¼ä»»å¡æ¯æå®æ¶é´æ§è¡çï¼é£ä¹æå°ç¦»ç°å¨æè¿çä»»å¡ï¼ä¹å°±æ¯æ¶é´æ³æå° çä»»å¡æ¾å¨å°æ ¹å çæä¸é¢ï¼çº¿ç¨æ¯ä¸æ¬¡åï¼é½å¯ä»¥å°ææ©éè¦æ§è¡çä»»å¡ååºæ¥ãçº¿ç¨çè½®è¯¢æ¹å¼ä¹å°±æäºï¼åä»»å¡ãæ§è¡ä»»å¡ãåè°ï¼æ¯ç¥ð\n\n\n# 2.1 timerqueue\n\nè¯´å°å ï¼ä½ å¨ç¬¬ä¸æ¬¡å­¦ä¹ å çä½¿ç¨ä½¿ç¨ä»ä¹æ¹å¼å®ç°çå å¢ï¼æçå¤§å¤æ°é½æ¯ç¨æ°ç»æ¥å®ç°ãtimerä¹æ¯å¦æ­¤ï¼timer ä½¿ç¨æ°ç»æ¥å®ç°å ï¼å¹¶å°å¶å°è£ä¸º timerqueueã\n\nå¶å®æå®å¨å¯ä»¥å° timerqueue çå¨é¨ä»£ç å±ç¤ºç»ä½ ï¼å ä¸ºå®å¨æ¯å¤ªç­äº\n\nclass taskqueue {\n    \n\t// ä½ å¯è½ä¸ç¥é timertaskæ¯å¥ï¼ä¸éè¦ï¼è¿åªæ¯ä¸ä¸ªå­æ¾ä»»å¡çæ°ç»\n    private timertask[] queue = new timertask[128];\n\t// æ°æ®ä¸ªæ°\n    private int size = 0;\n\n    void add(timertask task) {\n        // å¦æå®¹éè¶äºå°±æ©å®¹ã\n        if (size + 1 == queue.length)\n            queue = arrays.copyof(queue, 2*queue.length);\n\t\t// æ·»å ä»»å¡ï¼ç¶åæ ¹æ®è¿ä¸ªä»»å¡çæ§è¡æ¶é´å°å¶åä¸è°æ´\n        queue[++size] = task;\n        fixup(size);\n    }\n\n\t// è·åæè¿è¦æ§è¡çä»»å¡\n    timertask getmin() {\n        return queue[1];\n    }\n\n    /**\n     * å é¤æè¿çä»»å¡\n     */\n    void removemin() {\n        queue[1] = queue[size];\n        queue[size--] = null;  \n        fixdown(1);\n    }\n\n    private void fixup(int k) {\n        while (k > 1) {\n            int j = k >> 1;\n            if (queue[j].nextexecutiontime <= queue[k].nextexecutiontime)\n                break;\n            timertask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;\n            k = j;\n        }\n    }\n\n    private void fixdown(int k) {\n        int j;\n        while ((j = k << 1) <= size && j > 0) {\n            if (j < size && queue[j].nextexecutiontime > queue[j+1].nextexecutiontime)\n                j++; \n            \n            if (queue[k].nextexecutiontime <= queue[j].nextexecutiontime)\n                break;\n            timertask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;\n            k = j;\n        }\n    }\n\n    void heapify() {\n        for (int i = size/2; i >= 1; i--)\n            fixdown(i);\n    }\n}\n\n\n\nå®å¨æ¯ç®åå°çç¸ï¼è¿ä¸å°±æ¯æä»¬å®ç°çå åï¼æ¯«æ éè¯»é¾åº¦ãå æ éå°±æ¯ä¸¤ä¸ªæä½ ï¼ä¸è°ãä¸è°ãè¿éé¢ fixupå fixdown å°±ä»£è¡¨äºè¿ä¸¤ä¸ªæä½ã\n\nå¶å®æå åäºé¨åæ¹æ³ï¼ææ¥å±ç¤ºå¶ä¸­ä¸ä¸ª ï¼\n\n    void reschedulemin(long newtime) {\n        queue[1].nextexecutiontime = newtime;\n        fixdown(1);\n    }\n\n\nschedule æ¯å®æ¶ï¼reschedule æ¯éæ°å®æ¶ï¼min æ¯æå°ï¼è¿ä¸ªæ¹æ³çææå°±æ¯å°æè¿çä»»å¡éæ°å®æ¶ï¼ç¨äºä½å¤ï¼ä½æ¶ä½¿ç¨å¢ï¼\n\nå½ç¬¬ä¸ä¸ªä»»å¡æ§è¡å®æåï¼è¿ä¸ªä»»å¡æ¯å®æ¶çï¼å®ä¸å¤©æ§è¡ä¸æ¬¡ï¼ä¸ä¸æ¬¡æ§è¡å°±æ¯ä¸å¤©åäºï¼é£ä¹æä»¬å°±è¦éæ°è®¡ç®å®çä¸ä¸æ¬¡æ§è¡æ¶é´ï¼ç¶åå°å¶ç§»å°å°æ ¹å çä¸é¢æå¤ã\n\n\n# 2.2 timerthread\n\næ´ä¸ªä»£ç ä¹ç¹å«ç¹å«å°ï¼åªæ80è¡ï¼ä½æ¯æåä¸åå¤ç´æ¥æ¾ä»£ç äºãåæ¥çä¸ä¸è¿ä¸ªçº¿ç¨çå·¥ä½æ¹å¼ï¼\n\n 1. ä»å°æ ¹å å é¡¶ååºä»»å¡ï¼ä½æ¯ä¸è½å é¤\n 2. è®¡ç®ä»»å¡çæ§è¡æ¶é´ä¸å½åæ¶é´çå·®è·ï¼è®©æ­¤çº¿ç¨ç¡ç å°ä»»å¡çæ§è¡æ¶é´\n 3. æ§è¡ä»»å¡\n 4. éæ°è®¡ç®è¯¥ä»»å¡çæ§è¡æ¶é´å¹¶è°æ´å°æ ¹å ã\n 5. ç»§ç»­éå¤ç¬¬ä¸æ­¥\n\nç±äºæ¯çº¿ç¨ï¼æä»¥è¦å®ç° run() æ¹æ³ï¼ä¸»è¦é»è¾å¨ run() æ¹æ³ä¸­ ï¼\n\n    public void run() {\n        try {\n            mainloop();\n        } finally {\n            // æ§è¡ç»ææä¸¤ç§æåµ:\n            // æ­£å¸¸è¿è¡ç»æ: å°æ ¹å ä¸­æ æ°æ®\n            // å¼å¸¸è¿è¡ç»æ: æå¶ä»çº¿ç¨å°æ­¤ä»»å¡ç»æ­¢ï¼æä»¬è¦æ¸é¤å°æ ¹å ä¸­çä»»å¡ã\n            synchronized(queue) {\n                newtasksmaybescheduled = false;\n                queue.clear();   \n            }\n        }\n    }\n\n\nä»ä¸é¢å¯ä»¥çå°ï¼run() è°ç¨äº mainloop() ï¼çå° loop ä½ å°±åºè¯¥æ³å° å¾ªç¯ãè½®è¯¢ è¿äºå³é®è¯ã\n\nprivate void mainloop() {\n        while (true) {\n            try {\n                timertask task;\n                boolean taskfired;\n                synchronized(queue) {\n                    // å½å°æ ¹å ä¸­æ ä»»å¡æ¶ï¼å½åçº¿ç¨waité»å¡ã\n                    // æ­¤çº¿ç¨ä»ä¹æ¶åè¢«å¤éå¢ï¼å» timerqueue ä¸­å¯»æ¾ queue.notifyallæ²¡ææ¾å°\n                    // ç²çå¤éé»è¾å¨ timer ä¸­ã\n                    while (queue.isempty() && newtasksmaybescheduled)\n                        queue.wait();\n                    if (queue.isempty())\n                        break; \n\n                    // å½åæ¶é´\n                    long currenttime; \n                    // ä»»å¡çæ§è¡æ¶é´\n                    long executiontime;\n                    // å¾å°æè¿è¦æ§è¡çä»»å¡\n                    task = queue.getmin();\n                    // éä½è¯¥ä»»å¡\n                    synchronized(task.lock) {\n                        // å¦æä»»å¡å·²ç»åæ¶ï¼ä¸ç¨æ§è¡äºï¼ç´æ¥å äº\n                        if (task.state == timertask.cancelled) {\n                            queue.removemin();\n                            continue;  \n                        }\n                        // è·åå½åæ¶é´åä»»å¡çæ§è¡æ¶é´\n                        currenttime = system.currenttimemillis();\n                        executiontime = task.nextexecutiontime;\n                        // å¦æä»»å¡çæ§è¡æ¶é´å°äºå½åæ¶é´ï¼é£ä¹ä»»å¡å°±å¯ä»¥æ§è¡äº\n                        if (taskfired = (executiontime<=currenttime)) {\n                            // ççä»»å¡æ¯å¨ææ§ä»»å¡è¿æ¯ä¸æ¬¡æ§ä»»å¡\n                            // å¦ææ¯ä¸æ¬¡æ§ä»»å¡å°±æ ééæ°è®¡ç®è¯¥ä»»å¡çæ§è¡æ¶é´\n                            if (task.period == 0) { \n                                queue.removemin();\n                                task.state = timertask.executed;\n                            } else { \n                                // å¦ææ¯å¨ææ§ä»»å¡ï¼æ¥çæ¯å»¶æ¶ä»»å¡è¿æ¯å®æ¶ä»»å¡, åæ¶è®¡ç®ä¸æ¬¡æ§è¡æ¶é´\n                                queue.reschedulemin(\n                                  task.period<0 ? currenttime   - task.period\n                                                : executiontime + task.period);\n                            }\n                        }\n                    }\n                    // å¦æä»»å¡çæ§è¡æ¶é´å¤§äºå½åæ¶é´ï¼æ­¤çº¿ç¨ç¡å°ä»»å¡è¯¥æ§è¡çæ¶åã\n                    if (!taskfired) // task hasn't yet fired; wait\n                        queue.wait(executiontime - currenttime);\n                }\n                // æ§è¡ä»»å¡\n                if (taskfired)  // task fired; run it, holding no locks\n                    task.run();\n            } catch(interruptedexception e) {\n            }\n        }\n    }\n\n\n 1. ä¸ºä»ä¹è¦å é synchronized(queue) ï¼\n    \n    å ä¸ºæ­¤çº¿ç¨åä»»å¡ï¼å¶ä»çº¿ç¨å¯è½å queue ä¸­æ¾ä»»å¡ï¼æä»¥è¦å®ç°å¹¶åå®å¨ã\n    \n    åæ¶å¯ä»¥çå°å®å  synchronized çèå´ç¹å«å°ï¼ä¸åæ¬ä»»å¡çæ§è¡ï¼åªåæ¬ä»»å¡ç¶æçä¿®æ¹ãä»»å¡æ§è¡æ¶é´çä¿®æ¹ã\n\n 2. å»¶æ¶ä»»å¡åå®æ¶ä»»å¡çåºå«æ¯ä»ä¹ï¼\n    \n    å»¶æ¶ä»»å¡ç®ä¸äºä»»å¡çæ§è¡æ¶é´ï¼å®æ¶ä»»å¡ä¸ç®ã\n    \n    ä¸¾ä¾ï¼ä¸ä¸ªä»»å¡ 10s æ§è¡ä¸æ¬¡ï¼æ¯æ¬¡æ§è¡ 5s\n    \n    å¦æè¯¥ä»»å¡ä¸ºå®æ¶ä»»å¡ ï¼ä»»å¡çæ§è¡æ¶é´ä¸º 10ã20ã30ã40...\n    \n    å¦æè¯¥ä»»å¡æ¯å»¶æ¶ä»»å¡ ï¼ä»»å¡çæ§è¡æ¶é´ä¸º 10ã25ã40ã55\n\ntimerthread æ¯å¦ä½åºåå®æ¶ä»»å¡åå»¶æ¶ä»»å¡çå¢ï¼æ¥çä¸¤ä¸ªæ¹æ³ ï¼\n\n    // å»¶æ¶ä»»å¡\n\tpublic void schedule(timertask task, date firsttime, long period) {\n        sched(task, firsttime.gettime(), -period);\n    }\n\n\n    // å®æ¶ä»»å¡\n\tpublic void scheduleatfixedrate(timertask task, date firsttime, long period) {\n        sched(task, firsttime.gettime(), period);\n    }\n\n\nåºå«æ¯ä»ä¹ï¼å¨è°ç¨ super(...) æ¶ period çæ­£è´ï¼ç°å¨ååå»ç timerthread éæ°è®¡ç®ä»»å¡çæ§è¡æ¶é´é£ä¸æ®µå§ ï¼\n\n// currenttime : å½åæ¶é´ï¼æ¢è¨ä¹ï¼ä»»å¡æ§è¡çç»ææ¶é´\n// executiontime : ä»»å¡å¼å§æ§è¡çæ¶é´\n\tqueue.reschedulemin(\n    \ttask.period < 0 ? \n        currenttime   - task.period : \n        executiontime + task.period\n    );\n\n\n\n# 2.3 æ»ç»\n\næ²¡äºï¼timerå°±æ¯å¦æ­¤ç®åãä½¿ç¨å°æ ¹å å­æ¾å®æ¶ä»»å¡ï¼ä½¿ç¨çº¿ç¨æ«æå°æ ¹å çå é¡¶ã\n\n\n# 3. scheduledthreadpoolexecutor\n\nscheduledthreadpoolexecutor ä¹ä½¿ç¨å ä½ä¸ºå­å¨ä»»å¡çå®¹å¨ï¼å¯ä¸ä¸ timer ä¸åçæ¯ï¼æ«æå®¹å¨ççº¿ç¨åå¤äºã\n\n\n# 4. hashedwheeltimer\n\nnetty å dubbo ä»¥åå¾å¤æ¡æ¶é½æå®çå¯¹åºå®ç°ï¼æ ¸å¿ææ³é½ä¸æ ·ãå®ä»¬é½å°ä»»å¡æ¾å¨æ°ç»ä¸­ï¼ä½¿ç¨çº¿ç¨æ«ææ°ç»ã\n\nï¼åªæ netty å dubbo æ¯å ä¸ºæåªçè¿å®ä¿©çæºç ï¼å¶å® kafka çæ¶é´è½®æ´åï¼å¯ä»¥ä½ä¸ºä½ çæ©å±å­¦ä¹ åå®¹ï¼\n\nä¸å ä¸åçæ¯ï¼æ­¤æ°ç»æ¨¡æçæ¯ä¸ä¸ªè½®å­ï¼å®çæ¯ä¸ä¸ªå»åº¦ä»£è¡¨çä¸ä¸ªæ¶é´æ®µï¼æ¯å¦å¤§å°ä¸º 60 çæ°ç»ï¼æ°ç»ä¸­çæ¯ä¸ä¸ªåç´ å¯ä»¥ä»£è¡¨1sï¼é£ä¹è¿ä¸ªæ°ç»å°±å¯ä»¥æ¨¡æä¸ä¸ªéè¡¨ï¼çº¿ç¨æ¨¡æç§éï¼å¨å¾ªç¯éåçæ¶ååªéè¦æ¯ 1s æ§è¡é£ä¸ªæ¶é´æ®µçææä»»å¡ï¼å°±å¯ä»¥å®ç°âå®æ¶åè½âã\n\né®ä¸ä¸ªé®é¢ï¼åªä¸ªçº¿ç¨å°ä»»å¡æ¾å¨æ¶é´è½®ä¸­ï¼ä»»å¡çº¿ç¨ä¼åæ¶é´è½®ä¸­çä»»å¡å»æ§è¡ï¼main çº¿ç¨å¦æå¯ä»¥ç´æ¥æ¥è§¦å°æ¶é´è½®çè¯ï¼æä»¬å°±éè¦ä¿è¯æ¶é´è½®çå¹¶åå®å¨äºãä½æ¯æä¸æ³è®©å¹¶åé®é¢åçå¨æ¶é´è½®ä¸ï¼å¦ä½å®ç°ï¼\n\n 1. main çº¿ç¨å°ä»»å¡æ¾å°ä¸ä¸ªæ®éçæ°ç»ä¸­\n 2. ä»»å¡çº¿ç¨å°ä»»å¡ä»æ®éçæ°ç»ä¸­ååºï¼è®¡ç®ä»»å¡çæ§è¡æ¶é´ï¼ç¶åå°å¶æ¾å°å¯¹åºçå»åº¦ä¸ã\n\nä¸è®© main çº¿ç¨æ¥è§¦å°æ¶é´è½®æ°ç»ï¼å°±å¯ä»¥å°å¹¶åé®é¢æ§å¶å¨æ®éæ°ç»ä¸­ï¼æ¶é´è½®åªè´è´£å°ä»»å¡æç§æ¶é´ç»´åº¦å­å¨å³å¯ãä¸ºä»ä¹è¦å°å¹¶åé®é¢æ§å¶å¨æ®éæ°ç»èä¸æ¯æ¶é´è½®æ°ç»ï¼å ä¸ºæ¾å¨æ®éæ°ç»æ¶ï¼æä»¬åªéè¦æ¾/åï¼èæ¾å¨æ¶é´è½®æ°ç»ä¸­ï¼æä»¬ååè¿è¦å¤æ­ä¸æ¬¡æ¶é´åæ¾è¿å»ï¼æ¶åå°å¾å¤ç¶æçä¿®æ¹ï¼äºæ¯å¹¶åæåµå°±æ´å¤ã\n\nè¿æä¸ä¸ªé®é¢ ï¼å¦æä»»å¡çæ§è¡æ¶é´ç¦»ç°å¨å¤ªè¿äºï¼æ¯å¦æä¸ä¸ªä»»å¡å¨æå¤©æ§è¡ï¼æä»¬éè¦åå»ºä¸ä¸ª 24 * 60 * 60 ä¸ªåç´ çæ°ç»åï¼è¯å®ä¸è½ï¼æä»¬å¯ä»¥ä½¿ç¨åæ°æ¥ä»£è¡¨ä»»å¡è·ç¦»ç°å¨çæ¶é´ï¼æå¤©æ§è¡çä»»å¡å¯ä»¥æ¾å¨ç¬¬1ä¸ªå»åº¦ä¸ï¼è¯¥ä»»å¡çåæ°ä¸º 24 * 60ï¼æ¯ä¸æ¬¡å¾ªç¯å°å®é½å°è¿ä¸ªåæ°å1ï¼å½åæ°ä¸º 0 æ¶å³å¯æ§è¡ã\n\né®é¢æ»ç»å®äºï¼æ¥çä¸ä¸ hashedwheeltimer çå·¥ä½æµç¨ï¼\n\n 1. main çº¿ç¨è´è´£å°ä»»å¡æ¾å°æ®éæ°ç»ä¸­\n 2. ä»»å¡çº¿ç¨æ¯æ¬¡å¾ªç¯é½ä»æ®éæ°ç»ä¸­åä»»å¡ï¼å°å¶æ¾å°å¯¹åºçå»åº¦ä¸­ï¼ç¶åæ§è¡æ­¤æ¶æåçå»åº¦ä¸­çææä»»å¡ã",charsets:{cjk:!0},lastUpdated:"2024/06/11, 23:06:50",lastUpdatedTimestamp:171811841e4},{title:"Reatoræ¨¡å¼",frontmatter:{title:"Reatoræ¨¡å¼",date:"2024-01-22T00:32:48.000Z",permalink:"/pages/0c2518/"},regularPath:"/02.%E6%96%87%E7%AB%A0/01.Java%E5%9F%BA%E7%A1%80/150.Reactor%E6%A8%A1%E5%BC%8F.html",relativePath:"02.æç« /01.Javaåºç¡/150.Reactoræ¨¡å¼.md",key:"v-e1c868da",path:"/pages/0c2518/",headers:[{level:2,title:"Reator",slug:"reator",normalizedTitle:"reator",charIndex:11},{level:3,title:"1. åReactoråçº¿ç¨æ¨¡å",slug:"_1-åreactoråçº¿ç¨æ¨¡å",normalizedTitle:"1. åreactoråçº¿ç¨æ¨¡å",charIndex:159},{level:3,title:"2. åReactorå¤çº¿ç¨æ¨¡å",slug:"_2-åreactorå¤çº¿ç¨æ¨¡å",normalizedTitle:"2. åreactorå¤çº¿ç¨æ¨¡å",charIndex:178},{level:3,title:"3. ä¸»ä»Reactorå¤çº¿ç¨æ¨¡å",slug:"_3-ä¸»ä»reactorå¤çº¿ç¨æ¨¡å",normalizedTitle:"3. ä¸»ä»reactorå¤çº¿ç¨æ¨¡å",charIndex:197},{level:2,title:"æ»ç»",slug:"æ»ç»",normalizedTitle:"æ»ç»",charIndex:13992}],headersStr:"Reator 1. åReactoråçº¿ç¨æ¨¡å 2. åReactorå¤çº¿ç¨æ¨¡å 3. ä¸»ä»Reactorå¤çº¿ç¨æ¨¡å æ»ç»",content:"æ¬ææèª ï¼ä¸æææ Reator\n\nå¨ç½ç»IOè®¾è®¡ä¸­ï¼æä¸¤ç§é«æ§è½æ¨¡åï¼Reactoræ¨¡ååProactoræ¨¡åãReactoråºäºåæ­¥IOæ¨¡å¼ï¼Proactoråºäºå¼æ­¥IOæ¨¡å¼ã\n\nNettyç½ç»æ¡æ¶ï¼Redisç­ä¸­é´ä»¶ä¸­é½æä½¿ç¨å°Reactoræ¨¡åãæ¬æå°å¯¹Reactoræ¨¡åçå¦ä¸ä¸ç§åç±»è¿è¡å­¦ä¹ åå®ç°ã\n\n 1. åReactoråçº¿ç¨æ¨¡åï¼\n 2. åReactorå¤çº¿ç¨æ¨¡åï¼\n 3. ä¸»ä»Reactorå¤çº¿ç¨æ¨¡åã\n\nå¦æä¸å·å¤ç½ç»IOçç¸å³ç¥è¯ï¼å»ºè®®åéè¯»Javaç½ç»IOæ¨¡ååæä¸å®ç°ã\n\n\n# Reator\n\n\n# 1. åReactoråçº¿ç¨æ¨¡å\n\nåReactoråçº¿ç¨æ¨¡åä¸­ï¼åªæä¸ä¸ªReactorå¨çå¬äºä»¶åååäºä»¶ï¼å¹¶ä¸çå¬äºä»¶ï¼ååäºä»¶åå¤çäºä»¶é½å¨ä¸ä¸ªçº¿ç¨ä¸­å®æãç¤ºæå¾å¦ä¸æç¤ºã\n\n\n\nä¸è¿°ç¤ºæå¾ä¸­ï¼ä¸æ¬¡å®æ´çå¤çæµç¨å¯ä»¥æ¦æ¬å¦ä¸ã\n\n 1. Reactorçå¬å°ACCEPTäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶æå®¢æ·ç«¯å»ºç«è¿æ¥ï¼\n 2. Reactorå°ACCEPTäºä»¶ååç»Acceptorå¤çï¼\n 3. Acceptorä¼å¨æå¡ç«¯åå»ºä¸å®¢æ·ç«¯éä¿¡çclient-socketç®¡éï¼ç¶åæ³¨åå°IOå¤è·¯å¤ç¨å¨selectorä¸ï¼å¹¶çå¬READäºä»¶ï¼\n 4. Reactorçå¬å°READäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶å®¢æ·ç«¯æ°æ®å¯è¯»ï¼\n 5. Reactorå°READäºä»¶ååç»Handlerå¤çï¼Handlerå¤çREADäºä»¶å°±ä¼åºäºclient-socketç®¡éå®æå®¢æ·ç«¯æ°æ®çè¯»åã\n\nä¸é¢å°åºäºJavaè¯­è¨ï¼å®ç°ä¸ä¸ªç®åçåReactoråçº¿ç¨æ¨¡åçæå¡ç«¯ï¼æ´ä½ä»£ç å®ç°å®å¨ç¬¦åä¸è¿°ç¤ºæå¾ï¼å¤§å®¶å¯ä»¥è¿è¡åç§éè¯»ã\n\né¦åå®ç°Reactorï¼å¦ä¸æç¤ºã\n\npublic class Reactor implements Runnable {\n\n    private final Selector selector;\n\n    public Reactor(int port) throws IOException {\n        // å¼å¯å¤è·¯å¤ç¨\n        selector = Selector.open();\n        // æå¡ç«¯åå»ºlisten-socketç®¡é\n        ServerSocketChannel listenSocketChannel = ServerSocketChannel.open();\n        // ç»å®ç«¯å£\n        listenSocketChannel.socket().bind(new InetSocketAddress(port));\n        // è®¾ç½®ä¸ºéé»å¡æ¨¡å¼\n        listenSocketChannel.configureBlocking(false);\n        // ACCEPTäºä»¶çéå å¨æ¯Acceptor\n        listenSocketChannel.register(selector, SelectionKey.OP_ACCEPT,\n                new Acceptor(selector, listenSocketChannel));\n    }\n\n    @Override\n    public void run() {\n        while (!Thread.interrupted()) {\n            try {\n                // è·ååççäºä»¶\n                selector.select();\n                Set<SelectionKey> selectionKeys = selector.selectedKeys();\n                Iterator<SelectionKey> iterable = selectionKeys.iterator();\n                while (iterable.hasNext()) {\n                    // å¯¹äºä»¶è¿è¡åå\n                    dispatch(iterable.next());\n                    iterable.remove();\n                }\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n            LockSupport.parkNanos(1000 * 1000 * 1000);\n        }\n    }\n\n    private void dispatch(SelectionKey selectionKey) {\n        // è·åäºä»¶çéå å¨\n        // ACCEPTäºä»¶çéå å¨æ¯Acceptorï¼æç±Acceptoræ¥å¤çACCEPTäºä»¶\n        // READäºä»¶çéå å¨æ¯Handlerï¼æç±Handleræ¥å¤çREADäºä»¶\n        Runnable attachment = (Runnable) selectionKey.attachment();\n        if (attachment != null) {\n            attachment.run();\n        }\n    }\n\n}\n\n\nå·²ç¥Reactorä¼çå¬å®¢æ·ç«¯è¿æ¥çACCEPTäºä»¶ï¼è¿å·²ç¥ACCEPTäºä»¶ç±Acceptorå¤çï¼æä»¥å¨åå¤è·¯å¤ç¨å¨æ³¨åæå¡ç«¯ç¨äºçå¬å®¢æ·ç«¯è¿æ¥çlisten-socketç®¡éæ¶ï¼æ·»å äºä¸ä¸ªAcceptorä½ä¸ºéå å¨ï¼é£ä¹å½åçACCEPTäºä»¶æ¶ï¼å°±è½å¤è·åå°ä½ä¸ºACCEPTäºä»¶éå å¨çAcceptoræ¥å¤çACCEPTäºä»¶ã\n\nä¸é¢çä¸ä¸Acceptorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class Acceptor implements Runnable {\n\n    private final Selector selector;\n    private final ServerSocketChannel listenSocketChannel;\n\n    public Acceptor(Selector selector, ServerSocketChannel listenSocketChannel) {\n        this.selector = selector;\n        this.listenSocketChannel = listenSocketChannel;\n    }\n\n    @Override\n    public void run() {\n        try {\n            // ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºclient-socketç®¡é\n            SocketChannel clientSocketChannel = listenSocketChannel.accept();\n            // è®¾ç½®ä¸ºéé»å¡\n            clientSocketChannel.configureBlocking(false);\n            // READäºä»¶çéå å¨æ¯Handler\n            clientSocketChannel.register(selector, SelectionKey.OP_READ,\n                    new Handler(clientSocketChannel));\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n\n}\n\n\nå¨Acceptorä¸­å°±æ¯å¨æå¡ç«¯åå»ºä¸å®¢æ·ç«¯éä¿¡çclient-socketç®¡éï¼ç¶åæ³¨åå°å¤è·¯å¤ç¨å¨ä¸å¹¶æå®çå¬READäºä»¶ï¼åæ¶åå ä¸ºREADäºä»¶ç±Handlerå¤çï¼æä»¥è¿æ·»å äºä¸ä¸ªHandlerä½ä¸ºéå å¨ï¼å½READäºä»¶åçæ¶å¯ä»¥è·åå°ä½ä¸ºREADäºä»¶éå å¨çHandleræ¥å¤çREADäºä»¶ã\n\nä¸é¢çä¸ä¸Handlerçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class Handler implements Runnable {\n\n    private final SocketChannel clientSocketChannel;\n\n    public Handler(SocketChannel clientSocketChannel) {\n        this.clientSocketChannel = clientSocketChannel;\n    }\n\n    @Override\n    public void run() {\n        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n        try {\n            // è¯»åæ°æ®\n            int read = clientSocketChannel.read(byteBuffer);\n            if (read <= 0) {\n                clientSocketChannel.close();\n            } else {\n                System.out.println(new String(byteBuffer.array()));\n            }\n        } catch (IOException e1) {\n            try {\n                clientSocketChannel.close();\n            } catch (IOException e2) {\n                e2.printStackTrace();\n            }\n            e1.printStackTrace();\n        }\n    }\n\n}\n\n\nå¨Handlerä¸­å°±æ¯ç®åçè¯»åæ°æ®å¹¶æå°ï¼å½è¯»åæ°æ®ä¸ºç©ºæèåçå¼å¸¸æ¶ï¼éè¦åæ¶å°ç®¡éå³é­ã\n\næåç¼åä¸ä¸ªä¸»ç¨åºå°Reactorè¿è¡èµ·æ¥ï¼å¦ä¸æç¤ºã\n\npublic class MainServer {\n\n    public static void main(String[] args) throws IOException {\n        Thread reactorThread = new Thread(new Reactor(8080));\n        reactorThread.start();\n    }\n\n}\n\n\nç°å¨æ¥æèä¸ä¸ï¼åReactoråçº¿ç¨æ¨¡åæä»ä¹ä¼ç¹åç¼ºç¹ãä¼ç¹å¶å®å°±æ¯æ¨¡åç®åï¼å®ç°æ¹ä¾¿ãç¼ºç¹æä¸¤ç¹ï¼å¦ä¸æç¤ºã\n\n 1. ä¸ä¸ªReactoråæ¶è´è´£çå¬ACCEPTäºä»¶åREADäºä»¶ï¼\n 2. åªæä¸ä¸ªçº¿ç¨å¨å·¥ä½ï¼å¤çæçä½ï¼æ æ³å©ç¨å¤æ ¸CPUçä¼å¿ã\n\nä½æ¯å°½ç®¡åReactoråçº¿ç¨æ¨¡åæä¸è¿°çç¼ºç¹ï¼ä½æ¯èåçç¼å­ä¸­é´ä»¶Redisçæå¡ç«¯ï¼å°±æ¯ä½¿ç¨çåReactoråçº¿ç¨æ¨¡åï¼ç¤ºæå¾å¦ä¸ã\n\n\n\né£ä¸ºä»ä¹ä»¥æ§è½èç§°çRedisä¼éååReactoråçº¿ç¨æ¨¡åå¢ï¼å¶å®å°±æ¯å ä¸ºRedisçæä½é½å¨åå­ä¸­ï¼è¯»åé½éå¸¸å¿«éï¼æä»¥åReactoråçº¿ç¨æ¨¡åä¹è½è¿è¡å¾å¾æµçï¼åæ¶è¿é¿åäºå¤çº¿ç¨ä¸çåç§å¹¶åé®é¢ã\n\n\n# 2. åReactorå¤çº¿ç¨æ¨¡å\n\nå¨çè§£äºåReactoråçº¿ç¨æ¨¡ååï¼é£ä¹è¯å®å°±è½æ³å°ï¼åå¦å¨Handlerä¸­å¤çREADäºä»¶çè¿ä¸ªäºæè½å¤ä½¿ç¨ä¸ä¸ªçº¿ç¨æ± æ¥å®æï¼ä»èå°±å¯ä»¥å®ç°READäºä»¶çå¤çä¸ä¼é»å¡ä¸»çº¿ç¨ãèè¿æ ·çä¸ä¸ªæ¨¡åï¼å¶å®å°±æ¯åReactorå¤çº¿ç¨æ¨¡åï¼ç¤ºæå¾å¦ä¸æç¤ºã\n\nååReactoråçº¿ç¨æ¨¡åå¯ä¸çä¸åï¼å°±æ¯å¨Handlerä¸­å¤äºä¸ä¸ªçº¿ç¨æ± ã\n\nåReactorå¤çº¿ç¨æ¨¡åçä»£ç å®ç°ï¼é¤äºHandlerä»¥å¤ï¼å¶ä½ååReactoråçº¿ç¨æ¨¡åä¸æ¸ä¸æ ·ï¼æä»¥ä¸é¢å°±çä¸ä¸åReactorå¤çº¿ç¨æ¨¡åä¸­çHandlerå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class Handler implements Runnable {\n\n    private static final ThreadPoolExecutor threadPool = new ThreadPoolExecutor(16, 32,\n            60, TimeUnit.SECONDS, new LinkedBlockingQueue<>(200));\n\n    private final SocketChannel clientSocketChannel;\n\n    public Handler(SocketChannel clientSocketChannel) {\n        this.clientSocketChannel = clientSocketChannel;\n    }\n\n    @Override\n    public void run() {\n        threadPool.execute(() -> {\n            ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n            try {\n                // è¯»åæ°æ®\n                int read = clientSocketChannel.read(byteBuffer);\n                if (read <= 0) {\n                    clientSocketChannel.close();\n                } else {\n                    System.out.println(new String(byteBuffer.array()));\n                }\n                // ç¡ç 10Sï¼æ¼ç¤ºä»»å¡æ§è¡èæ¶é¿ä¹ä¸ä¼é»å¡å¤çå¶å®å®¢æ·ç«¯è¯·æ±\n                LockSupport.parkNanos(1000 * 1000 * 1000 * 10L);\n            } catch (IOException e1) {\n                try {\n                    clientSocketChannel.close();\n                } catch (IOException e2) {\n                    e2.printStackTrace();\n                }\n                e1.printStackTrace();\n            }\n        });\n    }\n\n}\n\n\nå¶å®å°±æ¯æ¯ä¸ä¸ªREADäºä»¶çå¤çä¼ä½ä¸ºä¸ä¸ªä»»å¡è¢«æå°çº¿ç¨æ± ä¸­å»å¤çã\n\nåReactorå¤çº¿ç¨æ¨¡åè½ç¶è§£å³äºåªæä¸ä¸ªçº¿ç¨çé®é¢ï¼ä½æ¯å¯ä»¥åç°ï¼ä»æ§æ¯åªæä¸ä¸ªReactorå¨åæ¶çå¬ACCEPTäºä»¶åREADäºä»¶ã\n\né£ä¹ç°å¨æèä¸ä¸ï¼ä¸ºä»ä¹ä¸ä¸ªReactoråæ¶çå¬ACCEPTäºä»¶åREADäºä»¶æ¯ä¸å¥½çãå¶å®å°±æ¯å ä¸ºéå¸¸å®¢æ·ç«¯è¿æ¥çå»ºç«æ¯ä¸é¢ç¹çï¼ä½æ¯è¿æ¥å»ºç«åæ°æ®çæ¶åæ¯é¢ç¹çï¼æä»¥å¦æè½å¤å°çå¬READäºä»¶è¿ä¸ªå¨ä½æååºæ¥ï¼è®©å¤ä¸ªå­Reactoræ¥çå¬READäºä»¶ï¼èåæ¥çä¸»Reactoråªçå¬ACCEPTäºä»¶ï¼é£ä¹æ´ä½çæçï¼ä¼è¿ä¸æ­¥æåï¼èè¿ï¼å°±æ¯ä¸»ä»Reactorå¤çº¿ç¨æ¨¡åã\n\n\n# 3. ä¸»ä»Reactorå¤çº¿ç¨æ¨¡å\n\nä¸»ä»Reactoræ¨¡åä¸­ï¼æä¸ä¸ªä¸»Reactorï¼ä¸é¨çå¬ACCEPTäºä»¶ï¼ç¶åæå¤ä¸ªä»Reactorï¼ä¸é¨çå¬READäºä»¶ï¼ç¤ºæå¾å¦ä¸æç¤ºã\n\n\n\nä¸è¿°ç¤ºæå¾ä¸­ï¼ä¸æ¬¡å®æ´çå¤çæµç¨å¯ä»¥æ¦æ¬å¦ä¸ã\n\n 1. ä¸»Reactorçå¬å°ACCEPTäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶æå®¢æ·ç«¯å»ºç«è¿æ¥ï¼\n 2. ä¸»Reactorå°ACCEPTäºä»¶ååç»Acceptorå¤çï¼\n 3. Acceptorä¼å¨æå¡ç«¯åå»ºä¸å®¢æ·ç«¯éä¿¡çclient-socketç®¡éï¼ç¶åæ³¨åå°ä»ReactorçIOå¤è·¯å¤ç¨å¨selectorä¸ï¼å¹¶çå¬READäºä»¶ï¼\n 4. ä»Reactorçå¬å°READäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶å®¢æ·ç«¯æ°æ®å¯è¯»ï¼\n 5. ä»Reactorå°ACCEPTäºä»¶ååç»Handlerå¤çï¼Handlerå¤çREADäºä»¶å°±ä¼åºäºclient-socketç®¡éå®æå®¢æ·ç«¯æ°æ®çè¯»åã\n\nä¸é¢å°åºäºJavaè¯­è¨ï¼å®ç°ä¸ä¸ªç®åçä¸»ä»Reactorå¤çº¿ç¨æ¨¡åçæå¡ç«¯ï¼æ´ä½ä»£ç å®ç°å®å¨ç¬¦åä¸è¿°ç¤ºæå¾ï¼å¤§å®¶å¯ä»¥è¿è¡åç§éè¯»ã\n\né¦åæ¯ä¸»Reactorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class MainReactor implements Runnable {\n\n    private final Selector selector;\n\n    public MainReactor(int port) throws IOException {\n        // å¼å¤è·¯å¤ç¨å¨\n        selector = Selector.open();\n        // æå¡ç«¯åå»ºlisten-socketç®¡é\n        ServerSocketChannel listenSocketChannel = ServerSocketChannel.open();\n        // è®¾ç½®ä¸ºéé»å¡\n        listenSocketChannel.configureBlocking(false);\n        // ç»å®çå¬ç«¯å£\n        listenSocketChannel.socket().bind(new InetSocketAddress(port));\n        // å°listen-socketç®¡éç»å®å°ä¸»Reactorçå¤è·¯å¤ç¨å¨ä¸\n        // å¹¶ä¸ä¸»Reactorä¸åªä¼æ³¨ålisten-socketç®¡éï¼ç¨äºçå¬ACCEPTäºä»¶\n        listenSocketChannel.register(selector, SelectionKey.OP_ACCEPT,\n                new Acceptor(listenSocketChannel));\n    }\n\n    @Override\n    public void run() {\n        while (!Thread.interrupted()) {\n            try {\n                selector.select();\n                Set<SelectionKey> selectionKeys = selector.selectedKeys();\n                Iterator<SelectionKey> iterable = selectionKeys.iterator();\n                while (iterable.hasNext()) {\n                    // å¯¹äºä»¶è¿è¡åå\n                    dispatch(iterable.next());\n                    iterable.remove();\n                }\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n            LockSupport.parkNanos(1000 * 1000 * 1000);\n        }\n    }\n\n    private void dispatch(SelectionKey selectionKey) {\n        // è·åäºä»¶éå å¨ï¼åªä¼æ¯Acceptor\n        Runnable attachment = (Runnable) selectionKey.attachment();\n        if (attachment != null) {\n            attachment.run();\n        }\n    }\n\n}\n\n\nä¸»Reactorçå®ç°ä¸­ï¼è¿æ¯ååå»ºæå¡ç«¯çå¬å®¢æ·ç«¯è¿æ¥çlisten-socketç®¡éï¼ç¶åæ³¨åå°ä¸»ReactorçIOå¤è·¯å¤ç¨å¨ä¸ï¼å¹¶çå¬ACCEPTäºä»¶ï¼åæ¶æä»¬ç°å¨ç¥éï¼ä¸»ReactorçIOå¤è·¯å¤ç¨å¨ä¸åªä¼æ³¨ålisten-socketç®¡éä¸åªä¼çå¬ACCEPTäºä»¶ãåæ ·ï¼ä¹æ·»å äºä¸ä¸ªAcceptorä½ä¸ºéå å¨ï¼é£ä¹å½åçACCEPTäºä»¶æ¶ï¼å°±è½å¤è·åå°ä½ä¸ºACCEPTäºä»¶éå å¨çAcceptoræ¥å¤çACCEPTäºä»¶ã\n\nä¸é¢æ¯Acceptorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class Acceptor implements Runnable {\n\n    // æå®ä»Reactorä¸å±æ16ä¸ª\n    private static final int TOTAL_SUBREACTOR_NUM = 16;\n\n    // æå¡ç«¯çlisten-socketç®¡é\n    private final ServerSocketChannel listenSocketChannel;\n\n    // ç¨äºè¿è¡ä»Reactor\n    private final ThreadPoolExecutor threadPool = new ThreadPoolExecutor(\n            TOTAL_SUBREACTOR_NUM, TOTAL_SUBREACTOR_NUM * 2,\n            60, TimeUnit.SECONDS, new LinkedBlockingQueue<>(200));\n\n    // ä»Reactoréå\n    private final List<SubReactor> subReactors = new ArrayList<>(TOTAL_SUBREACTOR_NUM);\n\n    public Acceptor(ServerSocketChannel listenSocketChannel) throws IOException {\n        this.listenSocketChannel = listenSocketChannel;\n        // å°ä»Reactoråå§ååºæ¥å¹¶è¿è¡\n        for (int i = 0; i < TOTAL_SUBREACTOR_NUM; i++) {\n            SubReactor subReactor = new SubReactor(Selector.open());\n            subReactors.add(subReactor);\n            threadPool.execute(subReactor);\n        }\n    }\n\n    @Override\n    public void run() {\n        try {\n            // ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºclient-socketç®¡é\n            SocketChannel clientSocketChannel = listenSocketChannel.accept();\n            // è®¾ç½®ä¸ºéé»å¡\n            clientSocketChannel.configureBlocking(false);\n            // ä»»æéæ©ä¸ä¸ªä»Reactorï¼è®©å¶çå¬è¿æ¥çå®¢æ·ç«¯çREADäºä»¶\n            Optional<SubReactor> anySubReactor = subReactors.stream().findAny();\n            if (anySubReactor.isPresent()) {\n                SubReactor subReactor = anySubReactor.get();\n                // ä»Reactorçå¤è·¯å¤ç¨å¨ä¼é»å¡å¨select()æ¹æ³ä¸\n                // è¿ééè¦åå¤éå¤è·¯å¤ç¨å¨ï¼ç«å³ä»select()æ¹æ³è¿å\n                subReactor.getSelector().wakeup();\n                // è®©ä»Reactorè´è´£å¤çå®¢æ·ç«¯çREADäºä»¶\n                clientSocketChannel.register(subReactor.getSelector(), SelectionKey.OP_READ,\n                        new Handler(clientSocketChannel));\n            }\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n\n}\n\n\né¦åå¨Acceptorçæé å½æ°ä¸­ï¼ä¼å°ææä»Reactoråå§ååºæ¥ï¼å¹¶ä¸æ¯ä¸ä¸ªä»Reactoré½ä¼ææä¸ä¸ªIOå¤è·¯å¤ç¨å¨ãå½ä¸ä¸ªä»Reactoråå»ºåºæ¥åå°±ä¼ç«å³è¿è¡ï¼æ­¤æ¶ä»ReactorçIOå¤è·¯å¤ç¨å¨å°±ä¼å¼å§çå¬ï¼å³é»å¡å¨select() æ¹æ³ä¸ã\n\nç¶åå¨Acceptorçä¸»ä½é»è¾ä¸­ï¼ä¼ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºclient-socketç®¡éï¼ç¶åä»ææä»Reactorä¸­åºäºæç§ç­ç¥ï¼éæºï¼éæ©ä¸ä¸ªä»Reactorï¼å¹¶å°client-socketç®¡éæ³¨åå¨éæ©çä»ReactorçIOå¤è·¯å¤ç¨å¨ä¸ï¼æä¸ç¹éè¦æ³¨æï¼æ­¤æ¶ä»ReactorçIOå¤è·¯å¤ç¨å¨å¯è½ä¼é»å¡å¨select() æ¹æ³ä¸ï¼æä»¥æ³¨ååéè¦åéè¿wakeup() æ¹æ³è¿è¡å¤éã\n\næ¥ä¸æ¥ç»§ç»­çä»Reactorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class SubReactor implements Runnable {\n\n    private final Selector selector;\n\n    public SubReactor(Selector selector) {\n        this.selector = selector;\n    }\n\n    @Override\n    public void run() {\n        while (!Thread.interrupted()) {\n            try {\n                selector.select();\n                Set<SelectionKey> selectionKeys = selector.selectedKeys();\n                Iterator<SelectionKey> iterator = selectionKeys.iterator();\n                while (iterator.hasNext()) {\n                    // å¯¹äºä»¶è¿è¡åå\n                    dispatch(iterator.next());\n                    iterator.remove();\n                }\n            } catch (IOException e) {\n                e.printStackTrace();\n            }\n            LockSupport.parkNanos(1000 * 1000 * 1000);\n        }\n    }\n\n    private void dispatch(SelectionKey selectionKey) {\n        // è·åäºä»¶éå å¨ï¼åªä¼æ¯Handler\n        Runnable runnable = (Runnable) selectionKey.attachment();\n        if (runnable != null) {\n            runnable.run();\n        }\n    }\n\n    public Selector getSelector() {\n        return selector;\n    }\n\n}\n\n\nä»Reactorçå®ç°ä¸­ï¼ä¼çå¬æå¡ç«¯ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºçclient-socketç®¡éä¸çREADäºä»¶ï¼ä¸æ¦æREADäºä»¶åçï¼å°±ä¼ä½¿ç¨ä½ä¸ºéå å¨çHandleræ¥å¤çREADäºä»¶ãåæ ·ï¼ä»ReactorçIOå¤è·¯å¤ç¨å¨ä¸åªä¼æ³¨åclient-socketç®¡éä¸åªä¼çå¬READäºä»¶ã\n\nç¶åæ¯Handlerï¼å ä¸ºæ¯å¤çº¿ç¨æ¨¡åï¼æä»¥å¶å®ç°åç¬¬ä¸èä¸­çHandlerå®å¨ä¸æ ·ï¼ä¸é¢åè´´ä¸ä¸ä»£ç ã\n\npublic class Handler implements Runnable {\n\n    private static final ThreadPoolExecutor threadPool = new ThreadPoolExecutor(16, 32,\n            60, TimeUnit.SECONDS, new LinkedBlockingQueue<>(200));\n\n    private final SocketChannel clientSocketChannel;\n\n    public Handler(SocketChannel clientSocketChannel) {\n        this.clientSocketChannel = clientSocketChannel;\n    }\n\n    @Override\n    public void run() {\n        threadPool.execute(() -> {\n            ByteBuffer byteBuffer = ByteBuffer.allocate(1024);\n            try {\n                // è¯»åæ°æ®\n                int read = clientSocketChannel.read(byteBuffer);\n                if (read <= 0) {\n                    clientSocketChannel.close();\n                } else {\n                    System.out.println(new String(byteBuffer.array()));\n                }\n                // ç¡ç 10Sï¼æ¼ç¤ºä»»å¡æ§è¡èæ¶é¿ä¹ä¸ä¼é»å¡å¤çå¶å®å®¢æ·ç«¯è¯·æ±\n                LockSupport.parkNanos(1000 * 1000 * 1000 * 10L);\n            } catch (IOException e1) {\n                try {\n                    clientSocketChannel.close();\n                } catch (IOException e2) {\n                    e2.printStackTrace();\n                }\n                e1.printStackTrace();\n            }\n        });\n    }\n\n}\n\n\næåç¼åä¸ä¸ªä¸»ç¨åºå°ä¸»Reactorè¿è¡èµ·æ¥ï¼å¦ä¸æç¤ºã\n\npublic class MainServer {\n\n    public static void main(String[] args) throws IOException {\n        Thread mainReactorThread = new Thread(new MainReactor(8080));\n        mainReactorThread.start();\n    }\n\n}\n\n\n\n# æ»ç»\n\nReactoræ¨¡åä¸»è¦å°±æ¯çå¬äºä»¶ï¼ååäºä»¶åå¤çäºä»¶ãå¶ä¸­Reactorè§è²ä¼è´è´£çå¬äºä»¶ åååäºä»¶ï¼Handlerè§è²åAcceptorè§è²ä¼è´è´£å¤çäºä»¶ã\n\nReactoræ¨¡åè½ç¶åä¸ºï¼åReactoråçº¿ç¨æ¨¡åï¼åReactorå¤çº¿ç¨æ¨¡ååä¸»ä»Reactorå¤çº¿ç¨æ¨¡åï¼ä½æ¯å¶æ¬è´¨å°±æ¯NIOçå®ç°ï¼æ¯ä¸è¿å¥äºReactorè®¾è®¡æ¨¡å¼çå¤å£³ã\n\nå¨ç½ç»éä¿¡æ¡æ¶Nettyä¸­ï¼ä¸ç§Reactoræ¨¡åé½æä½¿ç¨å°ï¼æä»¥æ³è¦å­¦ä¹ Nettyçç²¾é«ï¼çè§£Reactoræ¨¡åæ¯å¿ä¸å¯å°çã\n\nä½èï¼åå¤ä¹æ²« é¾æ¥ï¼https://juejin.cn/post/7210375522512666679 æ¥æºï¼ç¨åæé",normalizedContent:"æ¬ææèª ï¼ä¸æææ reator\n\nå¨ç½ç»ioè®¾è®¡ä¸­ï¼æä¸¤ç§é«æ§è½æ¨¡åï¼reactoræ¨¡ååproactoræ¨¡åãreactoråºäºåæ­¥ioæ¨¡å¼ï¼proactoråºäºå¼æ­¥ioæ¨¡å¼ã\n\nnettyç½ç»æ¡æ¶ï¼redisç­ä¸­é´ä»¶ä¸­é½æä½¿ç¨å°reactoræ¨¡åãæ¬æå°å¯¹reactoræ¨¡åçå¦ä¸ä¸ç§åç±»è¿è¡å­¦ä¹ åå®ç°ã\n\n 1. åreactoråçº¿ç¨æ¨¡åï¼\n 2. åreactorå¤çº¿ç¨æ¨¡åï¼\n 3. ä¸»ä»reactorå¤çº¿ç¨æ¨¡åã\n\nå¦æä¸å·å¤ç½ç»ioçç¸å³ç¥è¯ï¼å»ºè®®åéè¯»javaç½ç»ioæ¨¡ååæä¸å®ç°ã\n\n\n# reator\n\n\n# 1. åreactoråçº¿ç¨æ¨¡å\n\nåreactoråçº¿ç¨æ¨¡åä¸­ï¼åªæä¸ä¸ªreactorå¨çå¬äºä»¶åååäºä»¶ï¼å¹¶ä¸çå¬äºä»¶ï¼ååäºä»¶åå¤çäºä»¶é½å¨ä¸ä¸ªçº¿ç¨ä¸­å®æãç¤ºæå¾å¦ä¸æç¤ºã\n\n\n\nä¸è¿°ç¤ºæå¾ä¸­ï¼ä¸æ¬¡å®æ´çå¤çæµç¨å¯ä»¥æ¦æ¬å¦ä¸ã\n\n 1. reactorçå¬å°acceptäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶æå®¢æ·ç«¯å»ºç«è¿æ¥ï¼\n 2. reactorå°acceptäºä»¶ååç»acceptorå¤çï¼\n 3. acceptorä¼å¨æå¡ç«¯åå»ºä¸å®¢æ·ç«¯éä¿¡çclient-socketç®¡éï¼ç¶åæ³¨åå°ioå¤è·¯å¤ç¨å¨selectorä¸ï¼å¹¶çå¬readäºä»¶ï¼\n 4. reactorçå¬å°readäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶å®¢æ·ç«¯æ°æ®å¯è¯»ï¼\n 5. reactorå°readäºä»¶ååç»handlerå¤çï¼handlerå¤çreadäºä»¶å°±ä¼åºäºclient-socketç®¡éå®æå®¢æ·ç«¯æ°æ®çè¯»åã\n\nä¸é¢å°åºäºjavaè¯­è¨ï¼å®ç°ä¸ä¸ªç®åçåreactoråçº¿ç¨æ¨¡åçæå¡ç«¯ï¼æ´ä½ä»£ç å®ç°å®å¨ç¬¦åä¸è¿°ç¤ºæå¾ï¼å¤§å®¶å¯ä»¥è¿è¡åç§éè¯»ã\n\né¦åå®ç°reactorï¼å¦ä¸æç¤ºã\n\npublic class reactor implements runnable {\n\n    private final selector selector;\n\n    public reactor(int port) throws ioexception {\n        // å¼å¯å¤è·¯å¤ç¨\n        selector = selector.open();\n        // æå¡ç«¯åå»ºlisten-socketç®¡é\n        serversocketchannel listensocketchannel = serversocketchannel.open();\n        // ç»å®ç«¯å£\n        listensocketchannel.socket().bind(new inetsocketaddress(port));\n        // è®¾ç½®ä¸ºéé»å¡æ¨¡å¼\n        listensocketchannel.configureblocking(false);\n        // acceptäºä»¶çéå å¨æ¯acceptor\n        listensocketchannel.register(selector, selectionkey.op_accept,\n                new acceptor(selector, listensocketchannel));\n    }\n\n    @override\n    public void run() {\n        while (!thread.interrupted()) {\n            try {\n                // è·ååççäºä»¶\n                selector.select();\n                set<selectionkey> selectionkeys = selector.selectedkeys();\n                iterator<selectionkey> iterable = selectionkeys.iterator();\n                while (iterable.hasnext()) {\n                    // å¯¹äºä»¶è¿è¡åå\n                    dispatch(iterable.next());\n                    iterable.remove();\n                }\n            } catch (ioexception e) {\n                e.printstacktrace();\n            }\n            locksupport.parknanos(1000 * 1000 * 1000);\n        }\n    }\n\n    private void dispatch(selectionkey selectionkey) {\n        // è·åäºä»¶çéå å¨\n        // acceptäºä»¶çéå å¨æ¯acceptorï¼æç±acceptoræ¥å¤çacceptäºä»¶\n        // readäºä»¶çéå å¨æ¯handlerï¼æç±handleræ¥å¤çreadäºä»¶\n        runnable attachment = (runnable) selectionkey.attachment();\n        if (attachment != null) {\n            attachment.run();\n        }\n    }\n\n}\n\n\nå·²ç¥reactorä¼çå¬å®¢æ·ç«¯è¿æ¥çacceptäºä»¶ï¼è¿å·²ç¥acceptäºä»¶ç±acceptorå¤çï¼æä»¥å¨åå¤è·¯å¤ç¨å¨æ³¨åæå¡ç«¯ç¨äºçå¬å®¢æ·ç«¯è¿æ¥çlisten-socketç®¡éæ¶ï¼æ·»å äºä¸ä¸ªacceptorä½ä¸ºéå å¨ï¼é£ä¹å½åçacceptäºä»¶æ¶ï¼å°±è½å¤è·åå°ä½ä¸ºacceptäºä»¶éå å¨çacceptoræ¥å¤çacceptäºä»¶ã\n\nä¸é¢çä¸ä¸acceptorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class acceptor implements runnable {\n\n    private final selector selector;\n    private final serversocketchannel listensocketchannel;\n\n    public acceptor(selector selector, serversocketchannel listensocketchannel) {\n        this.selector = selector;\n        this.listensocketchannel = listensocketchannel;\n    }\n\n    @override\n    public void run() {\n        try {\n            // ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºclient-socketç®¡é\n            socketchannel clientsocketchannel = listensocketchannel.accept();\n            // è®¾ç½®ä¸ºéé»å¡\n            clientsocketchannel.configureblocking(false);\n            // readäºä»¶çéå å¨æ¯handler\n            clientsocketchannel.register(selector, selectionkey.op_read,\n                    new handler(clientsocketchannel));\n        } catch (ioexception e) {\n            e.printstacktrace();\n        }\n    }\n\n}\n\n\nå¨acceptorä¸­å°±æ¯å¨æå¡ç«¯åå»ºä¸å®¢æ·ç«¯éä¿¡çclient-socketç®¡éï¼ç¶åæ³¨åå°å¤è·¯å¤ç¨å¨ä¸å¹¶æå®çå¬readäºä»¶ï¼åæ¶åå ä¸ºreadäºä»¶ç±handlerå¤çï¼æä»¥è¿æ·»å äºä¸ä¸ªhandlerä½ä¸ºéå å¨ï¼å½readäºä»¶åçæ¶å¯ä»¥è·åå°ä½ä¸ºreadäºä»¶éå å¨çhandleræ¥å¤çreadäºä»¶ã\n\nä¸é¢çä¸ä¸handlerçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class handler implements runnable {\n\n    private final socketchannel clientsocketchannel;\n\n    public handler(socketchannel clientsocketchannel) {\n        this.clientsocketchannel = clientsocketchannel;\n    }\n\n    @override\n    public void run() {\n        bytebuffer bytebuffer = bytebuffer.allocate(1024);\n        try {\n            // è¯»åæ°æ®\n            int read = clientsocketchannel.read(bytebuffer);\n            if (read <= 0) {\n                clientsocketchannel.close();\n            } else {\n                system.out.println(new string(bytebuffer.array()));\n            }\n        } catch (ioexception e1) {\n            try {\n                clientsocketchannel.close();\n            } catch (ioexception e2) {\n                e2.printstacktrace();\n            }\n            e1.printstacktrace();\n        }\n    }\n\n}\n\n\nå¨handlerä¸­å°±æ¯ç®åçè¯»åæ°æ®å¹¶æå°ï¼å½è¯»åæ°æ®ä¸ºç©ºæèåçå¼å¸¸æ¶ï¼éè¦åæ¶å°ç®¡éå³é­ã\n\næåç¼åä¸ä¸ªä¸»ç¨åºå°reactorè¿è¡èµ·æ¥ï¼å¦ä¸æç¤ºã\n\npublic class mainserver {\n\n    public static void main(string[] args) throws ioexception {\n        thread reactorthread = new thread(new reactor(8080));\n        reactorthread.start();\n    }\n\n}\n\n\nç°å¨æ¥æèä¸ä¸ï¼åreactoråçº¿ç¨æ¨¡åæä»ä¹ä¼ç¹åç¼ºç¹ãä¼ç¹å¶å®å°±æ¯æ¨¡åç®åï¼å®ç°æ¹ä¾¿ãç¼ºç¹æä¸¤ç¹ï¼å¦ä¸æç¤ºã\n\n 1. ä¸ä¸ªreactoråæ¶è´è´£çå¬acceptäºä»¶åreadäºä»¶ï¼\n 2. åªæä¸ä¸ªçº¿ç¨å¨å·¥ä½ï¼å¤çæçä½ï¼æ æ³å©ç¨å¤æ ¸cpuçä¼å¿ã\n\nä½æ¯å°½ç®¡åreactoråçº¿ç¨æ¨¡åæä¸è¿°çç¼ºç¹ï¼ä½æ¯èåçç¼å­ä¸­é´ä»¶redisçæå¡ç«¯ï¼å°±æ¯ä½¿ç¨çåreactoråçº¿ç¨æ¨¡åï¼ç¤ºæå¾å¦ä¸ã\n\n\n\né£ä¸ºä»ä¹ä»¥æ§è½èç§°çredisä¼éååreactoråçº¿ç¨æ¨¡åå¢ï¼å¶å®å°±æ¯å ä¸ºredisçæä½é½å¨åå­ä¸­ï¼è¯»åé½éå¸¸å¿«éï¼æä»¥åreactoråçº¿ç¨æ¨¡åä¹è½è¿è¡å¾å¾æµçï¼åæ¶è¿é¿åäºå¤çº¿ç¨ä¸çåç§å¹¶åé®é¢ã\n\n\n# 2. åreactorå¤çº¿ç¨æ¨¡å\n\nå¨çè§£äºåreactoråçº¿ç¨æ¨¡ååï¼é£ä¹è¯å®å°±è½æ³å°ï¼åå¦å¨handlerä¸­å¤çreadäºä»¶çè¿ä¸ªäºæè½å¤ä½¿ç¨ä¸ä¸ªçº¿ç¨æ± æ¥å®æï¼ä»èå°±å¯ä»¥å®ç°readäºä»¶çå¤çä¸ä¼é»å¡ä¸»çº¿ç¨ãèè¿æ ·çä¸ä¸ªæ¨¡åï¼å¶å®å°±æ¯åreactorå¤çº¿ç¨æ¨¡åï¼ç¤ºæå¾å¦ä¸æç¤ºã\n\nååreactoråçº¿ç¨æ¨¡åå¯ä¸çä¸åï¼å°±æ¯å¨handlerä¸­å¤äºä¸ä¸ªçº¿ç¨æ± ã\n\nåreactorå¤çº¿ç¨æ¨¡åçä»£ç å®ç°ï¼é¤äºhandlerä»¥å¤ï¼å¶ä½ååreactoråçº¿ç¨æ¨¡åä¸æ¸ä¸æ ·ï¼æä»¥ä¸é¢å°±çä¸ä¸åreactorå¤çº¿ç¨æ¨¡åä¸­çhandlerå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class handler implements runnable {\n\n    private static final threadpoolexecutor threadpool = new threadpoolexecutor(16, 32,\n            60, timeunit.seconds, new linkedblockingqueue<>(200));\n\n    private final socketchannel clientsocketchannel;\n\n    public handler(socketchannel clientsocketchannel) {\n        this.clientsocketchannel = clientsocketchannel;\n    }\n\n    @override\n    public void run() {\n        threadpool.execute(() -> {\n            bytebuffer bytebuffer = bytebuffer.allocate(1024);\n            try {\n                // è¯»åæ°æ®\n                int read = clientsocketchannel.read(bytebuffer);\n                if (read <= 0) {\n                    clientsocketchannel.close();\n                } else {\n                    system.out.println(new string(bytebuffer.array()));\n                }\n                // ç¡ç 10sï¼æ¼ç¤ºä»»å¡æ§è¡èæ¶é¿ä¹ä¸ä¼é»å¡å¤çå¶å®å®¢æ·ç«¯è¯·æ±\n                locksupport.parknanos(1000 * 1000 * 1000 * 10l);\n            } catch (ioexception e1) {\n                try {\n                    clientsocketchannel.close();\n                } catch (ioexception e2) {\n                    e2.printstacktrace();\n                }\n                e1.printstacktrace();\n            }\n        });\n    }\n\n}\n\n\nå¶å®å°±æ¯æ¯ä¸ä¸ªreadäºä»¶çå¤çä¼ä½ä¸ºä¸ä¸ªä»»å¡è¢«æå°çº¿ç¨æ± ä¸­å»å¤çã\n\nåreactorå¤çº¿ç¨æ¨¡åè½ç¶è§£å³äºåªæä¸ä¸ªçº¿ç¨çé®é¢ï¼ä½æ¯å¯ä»¥åç°ï¼ä»æ§æ¯åªæä¸ä¸ªreactorå¨åæ¶çå¬acceptäºä»¶åreadäºä»¶ã\n\né£ä¹ç°å¨æèä¸ä¸ï¼ä¸ºä»ä¹ä¸ä¸ªreactoråæ¶çå¬acceptäºä»¶åreadäºä»¶æ¯ä¸å¥½çãå¶å®å°±æ¯å ä¸ºéå¸¸å®¢æ·ç«¯è¿æ¥çå»ºç«æ¯ä¸é¢ç¹çï¼ä½æ¯è¿æ¥å»ºç«åæ°æ®çæ¶åæ¯é¢ç¹çï¼æä»¥å¦æè½å¤å°çå¬readäºä»¶è¿ä¸ªå¨ä½æååºæ¥ï¼è®©å¤ä¸ªå­reactoræ¥çå¬readäºä»¶ï¼èåæ¥çä¸»reactoråªçå¬acceptäºä»¶ï¼é£ä¹æ´ä½çæçï¼ä¼è¿ä¸æ­¥æåï¼èè¿ï¼å°±æ¯ä¸»ä»reactorå¤çº¿ç¨æ¨¡åã\n\n\n# 3. ä¸»ä»reactorå¤çº¿ç¨æ¨¡å\n\nä¸»ä»reactoræ¨¡åä¸­ï¼æä¸ä¸ªä¸»reactorï¼ä¸é¨çå¬acceptäºä»¶ï¼ç¶åæå¤ä¸ªä»reactorï¼ä¸é¨çå¬readäºä»¶ï¼ç¤ºæå¾å¦ä¸æç¤ºã\n\n\n\nä¸è¿°ç¤ºæå¾ä¸­ï¼ä¸æ¬¡å®æ´çå¤çæµç¨å¯ä»¥æ¦æ¬å¦ä¸ã\n\n 1. ä¸»reactorçå¬å°acceptäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶æå®¢æ·ç«¯å»ºç«è¿æ¥ï¼\n 2. ä¸»reactorå°acceptäºä»¶ååç»acceptorå¤çï¼\n 3. acceptorä¼å¨æå¡ç«¯åå»ºä¸å®¢æ·ç«¯éä¿¡çclient-socketç®¡éï¼ç¶åæ³¨åå°ä»reactorçioå¤è·¯å¤ç¨å¨selectorä¸ï¼å¹¶çå¬readäºä»¶ï¼\n 4. ä»reactorçå¬å°readäºä»¶åçï¼è¡¨ç¤ºæ­¤æ¶å®¢æ·ç«¯æ°æ®å¯è¯»ï¼\n 5. ä»reactorå°acceptäºä»¶ååç»handlerå¤çï¼handlerå¤çreadäºä»¶å°±ä¼åºäºclient-socketç®¡éå®æå®¢æ·ç«¯æ°æ®çè¯»åã\n\nä¸é¢å°åºäºjavaè¯­è¨ï¼å®ç°ä¸ä¸ªç®åçä¸»ä»reactorå¤çº¿ç¨æ¨¡åçæå¡ç«¯ï¼æ´ä½ä»£ç å®ç°å®å¨ç¬¦åä¸è¿°ç¤ºæå¾ï¼å¤§å®¶å¯ä»¥è¿è¡åç§éè¯»ã\n\né¦åæ¯ä¸»reactorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class mainreactor implements runnable {\n\n    private final selector selector;\n\n    public mainreactor(int port) throws ioexception {\n        // å¼å¤è·¯å¤ç¨å¨\n        selector = selector.open();\n        // æå¡ç«¯åå»ºlisten-socketç®¡é\n        serversocketchannel listensocketchannel = serversocketchannel.open();\n        // è®¾ç½®ä¸ºéé»å¡\n        listensocketchannel.configureblocking(false);\n        // ç»å®çå¬ç«¯å£\n        listensocketchannel.socket().bind(new inetsocketaddress(port));\n        // å°listen-socketç®¡éç»å®å°ä¸»reactorçå¤è·¯å¤ç¨å¨ä¸\n        // å¹¶ä¸ä¸»reactorä¸åªä¼æ³¨ålisten-socketç®¡éï¼ç¨äºçå¬acceptäºä»¶\n        listensocketchannel.register(selector, selectionkey.op_accept,\n                new acceptor(listensocketchannel));\n    }\n\n    @override\n    public void run() {\n        while (!thread.interrupted()) {\n            try {\n                selector.select();\n                set<selectionkey> selectionkeys = selector.selectedkeys();\n                iterator<selectionkey> iterable = selectionkeys.iterator();\n                while (iterable.hasnext()) {\n                    // å¯¹äºä»¶è¿è¡åå\n                    dispatch(iterable.next());\n                    iterable.remove();\n                }\n            } catch (ioexception e) {\n                e.printstacktrace();\n            }\n            locksupport.parknanos(1000 * 1000 * 1000);\n        }\n    }\n\n    private void dispatch(selectionkey selectionkey) {\n        // è·åäºä»¶éå å¨ï¼åªä¼æ¯acceptor\n        runnable attachment = (runnable) selectionkey.attachment();\n        if (attachment != null) {\n            attachment.run();\n        }\n    }\n\n}\n\n\nä¸»reactorçå®ç°ä¸­ï¼è¿æ¯ååå»ºæå¡ç«¯çå¬å®¢æ·ç«¯è¿æ¥çlisten-socketç®¡éï¼ç¶åæ³¨åå°ä¸»reactorçioå¤è·¯å¤ç¨å¨ä¸ï¼å¹¶çå¬acceptäºä»¶ï¼åæ¶æä»¬ç°å¨ç¥éï¼ä¸»reactorçioå¤è·¯å¤ç¨å¨ä¸åªä¼æ³¨ålisten-socketç®¡éä¸åªä¼çå¬acceptäºä»¶ãåæ ·ï¼ä¹æ·»å äºä¸ä¸ªacceptorä½ä¸ºéå å¨ï¼é£ä¹å½åçacceptäºä»¶æ¶ï¼å°±è½å¤è·åå°ä½ä¸ºacceptäºä»¶éå å¨çacceptoræ¥å¤çacceptäºä»¶ã\n\nä¸é¢æ¯acceptorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class acceptor implements runnable {\n\n    // æå®ä»reactorä¸å±æ16ä¸ª\n    private static final int total_subreactor_num = 16;\n\n    // æå¡ç«¯çlisten-socketç®¡é\n    private final serversocketchannel listensocketchannel;\n\n    // ç¨äºè¿è¡ä»reactor\n    private final threadpoolexecutor threadpool = new threadpoolexecutor(\n            total_subreactor_num, total_subreactor_num * 2,\n            60, timeunit.seconds, new linkedblockingqueue<>(200));\n\n    // ä»reactoréå\n    private final list<subreactor> subreactors = new arraylist<>(total_subreactor_num);\n\n    public acceptor(serversocketchannel listensocketchannel) throws ioexception {\n        this.listensocketchannel = listensocketchannel;\n        // å°ä»reactoråå§ååºæ¥å¹¶è¿è¡\n        for (int i = 0; i < total_subreactor_num; i++) {\n            subreactor subreactor = new subreactor(selector.open());\n            subreactors.add(subreactor);\n            threadpool.execute(subreactor);\n        }\n    }\n\n    @override\n    public void run() {\n        try {\n            // ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºclient-socketç®¡é\n            socketchannel clientsocketchannel = listensocketchannel.accept();\n            // è®¾ç½®ä¸ºéé»å¡\n            clientsocketchannel.configureblocking(false);\n            // ä»»æéæ©ä¸ä¸ªä»reactorï¼è®©å¶çå¬è¿æ¥çå®¢æ·ç«¯çreadäºä»¶\n            optional<subreactor> anysubreactor = subreactors.stream().findany();\n            if (anysubreactor.ispresent()) {\n                subreactor subreactor = anysubreactor.get();\n                // ä»reactorçå¤è·¯å¤ç¨å¨ä¼é»å¡å¨select()æ¹æ³ä¸\n                // è¿ééè¦åå¤éå¤è·¯å¤ç¨å¨ï¼ç«å³ä»select()æ¹æ³è¿å\n                subreactor.getselector().wakeup();\n                // è®©ä»reactorè´è´£å¤çå®¢æ·ç«¯çreadäºä»¶\n                clientsocketchannel.register(subreactor.getselector(), selectionkey.op_read,\n                        new handler(clientsocketchannel));\n            }\n        } catch (ioexception e) {\n            e.printstacktrace();\n        }\n    }\n\n}\n\n\né¦åå¨acceptorçæé å½æ°ä¸­ï¼ä¼å°ææä»reactoråå§ååºæ¥ï¼å¹¶ä¸æ¯ä¸ä¸ªä»reactoré½ä¼ææä¸ä¸ªioå¤è·¯å¤ç¨å¨ãå½ä¸ä¸ªä»reactoråå»ºåºæ¥åå°±ä¼ç«å³è¿è¡ï¼æ­¤æ¶ä»reactorçioå¤è·¯å¤ç¨å¨å°±ä¼å¼å§çå¬ï¼å³é»å¡å¨select() æ¹æ³ä¸ã\n\nç¶åå¨acceptorçä¸»ä½é»è¾ä¸­ï¼ä¼ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºclient-socketç®¡éï¼ç¶åä»ææä»reactorä¸­åºäºæç§ç­ç¥ï¼éæºï¼éæ©ä¸ä¸ªä»reactorï¼å¹¶å°client-socketç®¡éæ³¨åå¨éæ©çä»reactorçioå¤è·¯å¤ç¨å¨ä¸ï¼æä¸ç¹éè¦æ³¨æï¼æ­¤æ¶ä»reactorçioå¤è·¯å¤ç¨å¨å¯è½ä¼é»å¡å¨select() æ¹æ³ä¸ï¼æä»¥æ³¨ååéè¦åéè¿wakeup() æ¹æ³è¿è¡å¤éã\n\næ¥ä¸æ¥ç»§ç»­çä»reactorçå®ç°ï¼å¦ä¸æç¤ºã\n\npublic class subreactor implements runnable {\n\n    private final selector selector;\n\n    public subreactor(selector selector) {\n        this.selector = selector;\n    }\n\n    @override\n    public void run() {\n        while (!thread.interrupted()) {\n            try {\n                selector.select();\n                set<selectionkey> selectionkeys = selector.selectedkeys();\n                iterator<selectionkey> iterator = selectionkeys.iterator();\n                while (iterator.hasnext()) {\n                    // å¯¹äºä»¶è¿è¡åå\n                    dispatch(iterator.next());\n                    iterator.remove();\n                }\n            } catch (ioexception e) {\n                e.printstacktrace();\n            }\n            locksupport.parknanos(1000 * 1000 * 1000);\n        }\n    }\n\n    private void dispatch(selectionkey selectionkey) {\n        // è·åäºä»¶éå å¨ï¼åªä¼æ¯handler\n        runnable runnable = (runnable) selectionkey.attachment();\n        if (runnable != null) {\n            runnable.run();\n        }\n    }\n\n    public selector getselector() {\n        return selector;\n    }\n\n}\n\n\nä»reactorçå®ç°ä¸­ï¼ä¼çå¬æå¡ç«¯ä¸ºè¿æ¥çå®¢æ·ç«¯åå»ºçclient-socketç®¡éä¸çreadäºä»¶ï¼ä¸æ¦æreadäºä»¶åçï¼å°±ä¼ä½¿ç¨ä½ä¸ºéå å¨çhandleræ¥å¤çreadäºä»¶ãåæ ·ï¼ä»reactorçioå¤è·¯å¤ç¨å¨ä¸åªä¼æ³¨åclient-socketç®¡éä¸åªä¼çå¬readäºä»¶ã\n\nç¶åæ¯handlerï¼å ä¸ºæ¯å¤çº¿ç¨æ¨¡åï¼æä»¥å¶å®ç°åç¬¬ä¸èä¸­çhandlerå®å¨ä¸æ ·ï¼ä¸é¢åè´´ä¸ä¸ä»£ç ã\n\npublic class handler implements runnable {\n\n    private static final threadpoolexecutor threadpool = new threadpoolexecutor(16, 32,\n            60, timeunit.seconds, new linkedblockingqueue<>(200));\n\n    private final socketchannel clientsocketchannel;\n\n    public handler(socketchannel clientsocketchannel) {\n        this.clientsocketchannel = clientsocketchannel;\n    }\n\n    @override\n    public void run() {\n        threadpool.execute(() -> {\n            bytebuffer bytebuffer = bytebuffer.allocate(1024);\n            try {\n                // è¯»åæ°æ®\n                int read = clientsocketchannel.read(bytebuffer);\n                if (read <= 0) {\n                    clientsocketchannel.close();\n                } else {\n                    system.out.println(new string(bytebuffer.array()));\n                }\n                // ç¡ç 10sï¼æ¼ç¤ºä»»å¡æ§è¡èæ¶é¿ä¹ä¸ä¼é»å¡å¤çå¶å®å®¢æ·ç«¯è¯·æ±\n                locksupport.parknanos(1000 * 1000 * 1000 * 10l);\n            } catch (ioexception e1) {\n                try {\n                    clientsocketchannel.close();\n                } catch (ioexception e2) {\n                    e2.printstacktrace();\n                }\n                e1.printstacktrace();\n            }\n        });\n    }\n\n}\n\n\næåç¼åä¸ä¸ªä¸»ç¨åºå°ä¸»reactorè¿è¡èµ·æ¥ï¼å¦ä¸æç¤ºã\n\npublic class mainserver {\n\n    public static void main(string[] args) throws ioexception {\n        thread mainreactorthread = new thread(new mainreactor(8080));\n        mainreactorthread.start();\n    }\n\n}\n\n\n\n# æ»ç»\n\nreactoræ¨¡åä¸»è¦å°±æ¯çå¬äºä»¶ï¼ååäºä»¶åå¤çäºä»¶ãå¶ä¸­reactorè§è²ä¼è´è´£çå¬äºä»¶ åååäºä»¶ï¼handlerè§è²åacceptorè§è²ä¼è´è´£å¤çäºä»¶ã\n\nreactoræ¨¡åè½ç¶åä¸ºï¼åreactoråçº¿ç¨æ¨¡åï¼åreactorå¤çº¿ç¨æ¨¡ååä¸»ä»reactorå¤çº¿ç¨æ¨¡åï¼ä½æ¯å¶æ¬è´¨å°±æ¯nioçå®ç°ï¼æ¯ä¸è¿å¥äºreactorè®¾è®¡æ¨¡å¼çå¤å£³ã\n\nå¨ç½ç»éä¿¡æ¡æ¶nettyä¸­ï¼ä¸ç§reactoræ¨¡åé½æä½¿ç¨å°ï¼æä»¥æ³è¦å­¦ä¹ nettyçç²¾é«ï¼çè§£reactoræ¨¡åæ¯å¿ä¸å¯å°çã\n\nä½èï¼åå¤ä¹æ²« é¾æ¥ï¼https://juejin.cn/post/7210375522512666679 æ¥æºï¼ç¨åæé",charsets:{cjk:!0},lastUpdated:"2024/01/22, 14:42:01",lastUpdatedTimestamp:1705905721e3},{title:"InnoDB - redo log å undo log",frontmatter:{title:"InnoDB - redo log å undo log",date:"2023-06-08T21:47:16.000Z",permalink:"/pages/495592/"},regularPath:"/02.%E6%96%87%E7%AB%A0/02.MySQL/15.InnoDB%20-%20redo%20log%20%E5%92%8C%20undo%20log.html",relativePath:"02.æç« /02.MySQL/15.InnoDB - redo log å undo log.md",key:"v-2e7dd8a7",path:"/pages/495592/",headers:[{level:2,title:"1. redo log",slug:"_1-redo-log",normalizedTitle:"1. redo log",charIndex:35},{level:2,title:"2. undo log",slug:"_2-undo-log",normalizedTitle:"2. undo log",charIndex:895},{level:3,title:"2.1 äºå¡id",slug:"_2-1-äºå¡id",normalizedTitle:"2.1 äºå¡id",charIndex:911},{level:3,title:"2.2 undoæ¥å¿",slug:"_2-2-undoæ¥å¿",normalizedTitle:"2.2 undoæ¥å¿",charIndex:1146},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:1538}],headersStr:"1. redo log 2. undo log 2.1 äºå¡id 2.2 undoæ¥å¿ 3. æ»ç»",content:"# InnoDB - redo log å undo log\n\n\n# 1. redo log\n\næä»¬ç¥é InnoDB å­å¨å¼ææ¯ä»¥é¡µä¸ºåä½æ¥ç®¡çå­å¨ç©ºé´çï¼æä»¬è¿è¡çå¢å æ¹æ¥æä½å¶å®æ¬è´¨ä¸æ¯å¨åå­ä¸­å¯¹é¡µçè®¿é®ãä¹å°±æ¯å¨ç¼å²ä¸­å¯¹é¡µçä¿®æ¹ã\n\nä½æ¯æä»¬åç¥éï¼InnoDBå¼ææ¯æçäºå¡æ¯æ æä¹æ§ è¿ä¸ªç¹æ§çï¼æä¹æ§æ¯ä»ä¹å¢ï¼\n\næä¹æ§ï¼äºå¡æäº¤åå¯¹äºMySQLçå½±åä¸å®ä¼å°è¾¾æ°æ®åºå¹¶ä¸å¯¹æ°æ®è¿è¡ä¿®æ¹ã\n\næ³ä¸ä¸è¿ä¸ªåºæ¯ï¼æä»¬æ§è¡äºä¸ä¸ª delete æä½ï¼å¨åå­ä¸­çç¼å²æ± éå°å¯¹åºé¡µæ°æ®ä¿®æ¹äºï¼ä½æ¯å¨æä¹åå°ç£çä¸­ä¹ **å**ï¼MySQLå®æºäºï¼ç£çä¸­çæ°æ®æ²¡ä¿®æ¹ï¼ä½æ¯å®æºä¹ååå­ä¸­çæ°æ®æ²¡äºãããè¿ä¸å°±è¿åäºæä¹æ§åï¼\n\né£ä¹å¦ä½ä¿è¯æä¹æ§å¢ï¼ä¸ä¸ªå¾ç®åçåæ³ï¼å¨äºå¡æäº¤ä¹åæè¯¥äºå¡æä¿®æ¹çææé¡µé½å·æ°å°ç£çãä½æ¯è¿ç§åæ³æé®é¢ï¼\n\n * å·æ°ä¸ä¸ªå®æ´çæ°æ®é¡µå¤ªæµªè´¹äºï¼æä»¬å¯è½ä»ä»ä¿®æ¹äºé¡µçæä¸ä¸ªå­èï¼ç°å¨å°±è¦ææ´ä¸ªé¡µé½å·è¿ç£çï¼ï¼ï¼\n\næä»¥ç°å¨éè¦ä¸ä¸ªæºå¶ï¼ä¿è¯ä¸è½é¢ç¹å·åå­å°ç£çï¼ä¹è¦è§£å³çªç¶å®æºçå±å®³ã\n\næä»¬åªæ¯æ³è®©å·²ç»æäº¤äºçäºå¡å¯¹äºæ°æ®åºä¸­æ°æ®æåçä¿®æ¹æ°¸ä¹çæï¼å³ä½¿åæ¥ç³»ç»å´©æºï¼åéå¯åä¹è½æè¿ç§ä¿®æ¹åå¤åºæ¥ãæä»¥æä»¬æ²¡æå¿è¦æ¯æ¬¡é½æäºå¡ä¿®ææè¿çé¡µé½å·æ°å°ç£çä¸­ï¼åªéè¦æä¿®æ¹äºåªäºä¸è¥¿è®°å½ä¸ä¸å°±å¥½ï¼æ¯æ¹è¯´æä¸ªäºå¡æç³»ç»è¡¨ç©ºé´ä¸­çç¬¬100é¡µä¸­åç§»éä¸º1000å¤çé£ä¸ªå­èçå¼ä»1æ¹ä¸º2ï¼é£ä¹æä»¬åªéè¦è®°å½ä¸ä¸ï¼\n\nå°0å·è¡¨ç©ºé´ç100å·é¡µé¢çåç§»éä¸º1000åºçå¼æ´æ°ä¸º2.\n\nè¿æ ·ï¼å³ä½¿å¨ äºå¡æäº¤ä¹å&amp;&amp;åå­å·å°ç£çä¹å ç³»ç»å´©æºäºï¼æä»¬ä¹å¯ä»¥ä½¿ç¨redo logæ¢å¤æ´æ¹çæ°æ®ã\n\néè¿ä¸è¿°çæè¿°æä»¬ç¥é**redo logçä½ç¨ ï¼è®°å½äºäºå¡å¯¹è®°å½çä¿®æ¹ã**\n\nredo logçæ ¼å¼å¦ä¸ï¼\n\nå­æ®µ            æè¿°\ntype          è¿ä¸ªredo logæ¥å¿çç±»å\nspace id      è¡¨ç©ºé´id\npage number   é¡µå·\ndata          è¯¥æ¡redo logå·ä½çåå®¹\n\n\n# 2. undo log\n\n\n# 2.1 äºå¡id\n\nå¨å­¦ä¹ undo log ä¹åï¼æå¿è¦äºè§£äºè§£ä¸ä¸äºå¡id ï¼transaction_idã\n\nå¨è¡è®°å½ä¸­ï¼MySQLèªå¨ä¸ºæä»¬æ·»å äºå ä¸ªå­æ®µï¼åé¿å­æ®µçé¿åº¦åè¡¨ãNULLå¼åè¡¨ãè®°å½å¤´ä¿¡æ¯ãrow_idãtransaction_idãroll_pointerã\n\n\n\næºå¥½çè§£çï¼åªä¸ªäºå¡å¯¹æ­¤æ¡è®°å½åäºä¿®æ¹ï¼è¿ä¸ªtransaction_idå°±æ¯åªä¸ªäºå¡çidã\n\nå¹¶ä¸æ¯ææäºå¡é½æäºå¡idï¼è¿è¡å¢å æ¹æä½çäºå¡æidï¼åªè¯»çäºå¡æ²¡æidã\n\n\n# 2.2 undoæ¥å¿\n\nundo logåç§°ä¸ºåæ»æ¥å¿ï¼å°±æ¯äºå¡åºç°é®é¢çæ¶åæ§è¡åæ»æä½ã\n\näºå¡éè¦ä¿è¯åå­æ§ï¼ä¸ä¸ªäºå¡çè¯­å¥è¦ä¹å¨é¨æ§è¡æåï¼è¦ä¹å¨é¨æ§è¡å¤±è´¥ãæ§è¡æåçæåµå°±ä¸è¯´äºï¼ä¸ä¸æ§è¡å¤±è´¥å¢ï¼äºå¡ä¸­çè¯­å¥å·²ç»å¯¹åå­ä¸­çæ°æ®ä¿®æ¹äºï¼æä¹æ§è¡åæ»æä½å¢ï¼\n\næä»¬å¯ä»¥åè redo logï¼æè¿è¡çæä½è®°å½ä¸æ¥ï¼éè¦åæ»çæ¶åå°±å¯ä»¥æç§è®°å½çæä½åæ¹åæ§è¡ï¼ä½æ¯åæ¹åæ§è¡åå¤ªéº»ç¦äºï¼æä»¬ç´¢æ§è®°å½åæ¹åæ§è¡çæä½ã\n\n * ç¨æ·å¢å  id = 1çè®°å½ï¼æä»¬è®°å½ å é¤id = 1çè¯­å¥ï¼åæ»çæ¶åç´æ¥æ§è¡è¿æ¡è¯­å¥ã\n * ç¨æ·å é¤ id = 1çè®°å½ï¼æä»¬è®°å½id=1çè¯­å¥çå¨é¨å­æ®µå¼ï¼åæ»çæ¶åç´æ¥æ§è¡è¿æ¡è¯­å¥ã\n * ç¨æ·ä¿®æ¹ id = 1çè®°å½ï¼æä»¬è®°å½id=1çè®°å½åæ¥çæ°æ®ï¼åæ»çæ¶åç´æ¥æ§è¡è¿æ¡è¯­å¥ã\n\nè¿æ ·å°±å¯ä»¥åå°äºå¡åºç°é®é¢åæ§è¡åæ»æä½ã\n\n\n# 3. æ»ç»\n\nredo logæ¥å¿ä¿è¯æä¹æ§\n\nundo logæ¥å¿ä¿è¯åå­æ§\n\nå¯è½æå°ä¼ä¼´ä¼è¯´ï¼MySQLä¸æ¯æä¸ç§æ¥å¿åï¼redo logãundo logãbin log\n\nä½æ¯æ é¢åçæ¯InnoDBå¦ï¼æ¬æä¸»è¦è¿æ¯éå¯¹InnoDBå¼æçæ¥å¿ãbinlogæ¯MySQLç Server å±çï¼ææå¼æé½æç~\n\nç®èè¨ä¹ï¼redo logåundo logæ¯InnoDBå¼æçï¼bin logæ¯MySQL Serverçã\n\nè¿æ¯å¨è¿éç®è¿°ä¸ä¸bin logå§ï¼\n\n> MySQL å¨å®æä¸æ¡æ´æ°æä½åï¼Server å±ä¼çæä¸æ¡ binlogï¼ç­ä¹åäºå¡æäº¤çæ¶åï¼ä¼å°è¯¥äºç©æ§è¡è¿ç¨ä¸­äº§ççææ binlog ç»ä¸å å¥ binlog æä»¶ã\n> \n> bin log å¨æä»¬æéå¸¸ç¨äºæ°æ®çåæ­¥ï¼ä¾å¦MySQLçä¸»ä»ãMySQLä¸Redisæ°æ®åæ­¥ãMySQLä¸ESæ°æ®åæ­¥~\n\nâ",normalizedContent:"# innodb - redo log å undo log\n\n\n# 1. redo log\n\næä»¬ç¥é innodb å­å¨å¼ææ¯ä»¥é¡µä¸ºåä½æ¥ç®¡çå­å¨ç©ºé´çï¼æä»¬è¿è¡çå¢å æ¹æ¥æä½å¶å®æ¬è´¨ä¸æ¯å¨åå­ä¸­å¯¹é¡µçè®¿é®ãä¹å°±æ¯å¨ç¼å²ä¸­å¯¹é¡µçä¿®æ¹ã\n\nä½æ¯æä»¬åç¥éï¼innodbå¼ææ¯æçäºå¡æ¯æ æä¹æ§ è¿ä¸ªç¹æ§çï¼æä¹æ§æ¯ä»ä¹å¢ï¼\n\næä¹æ§ï¼äºå¡æäº¤åå¯¹äºmysqlçå½±åä¸å®ä¼å°è¾¾æ°æ®åºå¹¶ä¸å¯¹æ°æ®è¿è¡ä¿®æ¹ã\n\næ³ä¸ä¸è¿ä¸ªåºæ¯ï¼æä»¬æ§è¡äºä¸ä¸ª delete æä½ï¼å¨åå­ä¸­çç¼å²æ± éå°å¯¹åºé¡µæ°æ®ä¿®æ¹äºï¼ä½æ¯å¨æä¹åå°ç£çä¸­ä¹ **å**ï¼mysqlå®æºäºï¼ç£çä¸­çæ°æ®æ²¡ä¿®æ¹ï¼ä½æ¯å®æºä¹ååå­ä¸­çæ°æ®æ²¡äºãããè¿ä¸å°±è¿åäºæä¹æ§åï¼\n\né£ä¹å¦ä½ä¿è¯æä¹æ§å¢ï¼ä¸ä¸ªå¾ç®åçåæ³ï¼å¨äºå¡æäº¤ä¹åæè¯¥äºå¡æä¿®æ¹çææé¡µé½å·æ°å°ç£çãä½æ¯è¿ç§åæ³æé®é¢ï¼\n\n * å·æ°ä¸ä¸ªå®æ´çæ°æ®é¡µå¤ªæµªè´¹äºï¼æä»¬å¯è½ä»ä»ä¿®æ¹äºé¡µçæä¸ä¸ªå­èï¼ç°å¨å°±è¦ææ´ä¸ªé¡µé½å·è¿ç£çï¼ï¼ï¼\n\næä»¥ç°å¨éè¦ä¸ä¸ªæºå¶ï¼ä¿è¯ä¸è½é¢ç¹å·åå­å°ç£çï¼ä¹è¦è§£å³çªç¶å®æºçå±å®³ã\n\næä»¬åªæ¯æ³è®©å·²ç»æäº¤äºçäºå¡å¯¹äºæ°æ®åºä¸­æ°æ®æåçä¿®æ¹æ°¸ä¹çæï¼å³ä½¿åæ¥ç³»ç»å´©æºï¼åéå¯åä¹è½æè¿ç§ä¿®æ¹åå¤åºæ¥ãæä»¥æä»¬æ²¡æå¿è¦æ¯æ¬¡é½æäºå¡ä¿®ææè¿çé¡µé½å·æ°å°ç£çä¸­ï¼åªéè¦æä¿®æ¹äºåªäºä¸è¥¿è®°å½ä¸ä¸å°±å¥½ï¼æ¯æ¹è¯´æä¸ªäºå¡æç³»ç»è¡¨ç©ºé´ä¸­çç¬¬100é¡µä¸­åç§»éä¸º1000å¤çé£ä¸ªå­èçå¼ä»1æ¹ä¸º2ï¼é£ä¹æä»¬åªéè¦è®°å½ä¸ä¸ï¼\n\nå°0å·è¡¨ç©ºé´ç100å·é¡µé¢çåç§»éä¸º1000åºçå¼æ´æ°ä¸º2.\n\nè¿æ ·ï¼å³ä½¿å¨ äºå¡æäº¤ä¹å&amp;&amp;åå­å·å°ç£çä¹å ç³»ç»å´©æºäºï¼æä»¬ä¹å¯ä»¥ä½¿ç¨redo logæ¢å¤æ´æ¹çæ°æ®ã\n\néè¿ä¸è¿°çæè¿°æä»¬ç¥é**redo logçä½ç¨ ï¼è®°å½äºäºå¡å¯¹è®°å½çä¿®æ¹ã**\n\nredo logçæ ¼å¼å¦ä¸ï¼\n\nå­æ®µ            æè¿°\ntype          è¿ä¸ªredo logæ¥å¿çç±»å\nspace id      è¡¨ç©ºé´id\npage number   é¡µå·\ndata          è¯¥æ¡redo logå·ä½çåå®¹\n\n\n# 2. undo log\n\n\n# 2.1 äºå¡id\n\nå¨å­¦ä¹ undo log ä¹åï¼æå¿è¦äºè§£äºè§£ä¸ä¸äºå¡id ï¼transaction_idã\n\nå¨è¡è®°å½ä¸­ï¼mysqlèªå¨ä¸ºæä»¬æ·»å äºå ä¸ªå­æ®µï¼åé¿å­æ®µçé¿åº¦åè¡¨ãnullå¼åè¡¨ãè®°å½å¤´ä¿¡æ¯ãrow_idãtransaction_idãroll_pointerã\n\n\n\næºå¥½çè§£çï¼åªä¸ªäºå¡å¯¹æ­¤æ¡è®°å½åäºä¿®æ¹ï¼è¿ä¸ªtransaction_idå°±æ¯åªä¸ªäºå¡çidã\n\nå¹¶ä¸æ¯ææäºå¡é½æäºå¡idï¼è¿è¡å¢å æ¹æä½çäºå¡æidï¼åªè¯»çäºå¡æ²¡æidã\n\n\n# 2.2 undoæ¥å¿\n\nundo logåç§°ä¸ºåæ»æ¥å¿ï¼å°±æ¯äºå¡åºç°é®é¢çæ¶åæ§è¡åæ»æä½ã\n\näºå¡éè¦ä¿è¯åå­æ§ï¼ä¸ä¸ªäºå¡çè¯­å¥è¦ä¹å¨é¨æ§è¡æåï¼è¦ä¹å¨é¨æ§è¡å¤±è´¥ãæ§è¡æåçæåµå°±ä¸è¯´äºï¼ä¸ä¸æ§è¡å¤±è´¥å¢ï¼äºå¡ä¸­çè¯­å¥å·²ç»å¯¹åå­ä¸­çæ°æ®ä¿®æ¹äºï¼æä¹æ§è¡åæ»æä½å¢ï¼\n\næä»¬å¯ä»¥åè redo logï¼æè¿è¡çæä½è®°å½ä¸æ¥ï¼éè¦åæ»çæ¶åå°±å¯ä»¥æç§è®°å½çæä½åæ¹åæ§è¡ï¼ä½æ¯åæ¹åæ§è¡åå¤ªéº»ç¦äºï¼æä»¬ç´¢æ§è®°å½åæ¹åæ§è¡çæä½ã\n\n * ç¨æ·å¢å  id = 1çè®°å½ï¼æä»¬è®°å½ å é¤id = 1çè¯­å¥ï¼åæ»çæ¶åç´æ¥æ§è¡è¿æ¡è¯­å¥ã\n * ç¨æ·å é¤ id = 1çè®°å½ï¼æä»¬è®°å½id=1çè¯­å¥çå¨é¨å­æ®µå¼ï¼åæ»çæ¶åç´æ¥æ§è¡è¿æ¡è¯­å¥ã\n * ç¨æ·ä¿®æ¹ id = 1çè®°å½ï¼æä»¬è®°å½id=1çè®°å½åæ¥çæ°æ®ï¼åæ»çæ¶åç´æ¥æ§è¡è¿æ¡è¯­å¥ã\n\nè¿æ ·å°±å¯ä»¥åå°äºå¡åºç°é®é¢åæ§è¡åæ»æä½ã\n\n\n# 3. æ»ç»\n\nredo logæ¥å¿ä¿è¯æä¹æ§\n\nundo logæ¥å¿ä¿è¯åå­æ§\n\nå¯è½æå°ä¼ä¼´ä¼è¯´ï¼mysqlä¸æ¯æä¸ç§æ¥å¿åï¼redo logãundo logãbin log\n\nä½æ¯æ é¢åçæ¯innodbå¦ï¼æ¬æä¸»è¦è¿æ¯éå¯¹innodbå¼æçæ¥å¿ãbinlogæ¯mysqlç server å±çï¼ææå¼æé½æç~\n\nç®èè¨ä¹ï¼redo logåundo logæ¯innodbå¼æçï¼bin logæ¯mysql serverçã\n\nè¿æ¯å¨è¿éç®è¿°ä¸ä¸bin logå§ï¼\n\n> mysql å¨å®æä¸æ¡æ´æ°æä½åï¼server å±ä¼çæä¸æ¡ binlogï¼ç­ä¹åäºå¡æäº¤çæ¶åï¼ä¼å°è¯¥äºç©æ§è¡è¿ç¨ä¸­äº§ççææ binlog ç»ä¸å å¥ binlog æä»¶ã\n> \n> bin log å¨æä»¬æéå¸¸ç¨äºæ°æ®çåæ­¥ï¼ä¾å¦mysqlçä¸»ä»ãmysqlä¸redisæ°æ®åæ­¥ãmysqlä¸esæ°æ®åæ­¥~\n\nâ",charsets:{cjk:!0},lastUpdated:"2023/06/08, 21:54:53",lastUpdatedTimestamp:1686232493e3},{title:"InnoDB - Buffer Pool",frontmatter:{title:"InnoDB - Buffer Pool",date:"2023-06-17T20:35:21.000Z",permalink:"/pages/31e077/"},regularPath:"/02.%E6%96%87%E7%AB%A0/02.MySQL/17.InnoDB%20-%20Buffer%20Pool.html",relativePath:"02.æç« /02.MySQL/17.InnoDB - Buffer Pool.md",key:"v-38cc1f4f",path:"/pages/31e077/",headers:[{level:2,title:"1. ä»ä¹æ¯Buffer Pool",slug:"_1-ä»ä¹æ¯buffer-pool",normalizedTitle:"1. ä»ä¹æ¯buffer pool",charIndex:2},{level:2,title:"2. Buffer Poolçç»æ",slug:"_2-buffer-poolçç»æ",normalizedTitle:"2. buffer poolçç»æ",charIndex:242},{level:2,title:"3. freeé¾è¡¨",slug:"_3-freeé¾è¡¨",normalizedTitle:"3. freeé¾è¡¨",charIndex:678},{level:2,title:"4. flushé¾è¡¨",slug:"_4-flushé¾è¡¨",normalizedTitle:"4. flushé¾è¡¨",charIndex:1117},{level:2,title:"5. LRUé¾è¡¨",slug:"_5-lrué¾è¡¨",normalizedTitle:"5. lrué¾è¡¨",charIndex:1507},{level:2,title:"6. æ»ç»",slug:"_6-æ»ç»",normalizedTitle:"6. æ»ç»",charIndex:3567}],headersStr:"1. ä»ä¹æ¯Buffer Pool 2. Buffer Poolçç»æ 3. freeé¾è¡¨ 4. flushé¾è¡¨ 5. LRUé¾è¡¨ 6. æ»ç»",content:"# 1. ä»ä¹æ¯Buffer Pool\n\néè¿åå ç¯æç« çå­¦ä¹ æä»¬å¤§è´äºè§£å°ï¼å¯¹äºInnoDBå¼ææ¥è¯´ï¼ææçæ°æ®é½æ¯å­å¨ç£çä¸­ï¼ç¨çæ¶åä»¥é¡µä¸ºåä½å è½½å°åå­ä¸­çã è¿æ ·å°±åå°äºselectä¸æ¡æ°æ®è¿è¦æ¥åè¿è¡ç£çIOçæ§è½æèãä½æ¯å è½½å°åå­ä¸­åå¹¶ä¸æ¯ç¨å®å°±ä¸¢äºï¼èæ¯æ¾å¨ç¼å­ä¸­ï¼ä¸æ¬¡ç¨ç´æ¥æ¿å°±å¥½äºã\n\nä¸ºäºç¼å­è¿äºé¡µæ°æ®ï¼MySQLæå¡å¨å¯å¨çæ¶åå°±ç³è¯·äºä¸çè¿ç»­çåå­ï¼å«åBuffer Poolãå®çå¤§å°éå¸¸æ¯128Mï¼è¿ä¸ªå¼å¯ä»¥è®¾ç½®ï¼å¦æå°äº5Mä¼èªå¨è®¾ç½®ä¸º5Mã\n\n\n# 2. Buffer Poolçç»æ\n\nBuffer Pooléè¦ç¼å­ä»ç£çå è½½åºæ¥çé¡µï¼ç£çä¸­çé¡µæ¯16kï¼BufferPooléé¢é¡µçåç£çä¸­çé¡µä¸æ ·å¤§ãä¸ºäºè¡¨ç¤ºåºåï¼æ¥ä¸æ¥å°ç§°Buffer Poolä¸­çé¡µä¸ºç¼å­é¡µã\n\nä¸è¬æ¥è¯´ï¼ä¸ºäºæ´å¥½çç®¡çæ°æ®ï¼é½ä¼ç»æ°æ®æ·»å ä¸äºâåæ°æ®âãâå¤´ä¿¡æ¯âä¹ç±»çæè¿°æ°æ®çæ°æ®ï¼ ä¾å¦å¯¹è±¡Objectçå¯¹è±¡å¤´ãMySQLçéèå­æ®µãæ¶æ¯éåä¸­æ¶æ¯çåæ°æ®.... å¨è¿éä¹ä¸æå¤ï¼InnoDBå¼æä¹å¯¹Buffer Poolç¼å­çé¡µå¢å äºæè¿°ä¿¡æ¯ï¼æ§å¶åãæ¯ä¸ä¸ªç¼å­é¡µé½æå®å¯¹åºçæ§å¶åï¼ æ¯ä¸ä¸ªæ§å¶åä¸­çä¿¡æ¯åæ¬ è¯¥é¡µçé¡µå·ãè¯¥é¡µæå±çè¡¨å·ãè¯¥é¡µå¨Buffer Poolä¸­çä½ç½®ãé¾è¡¨èç¹ä¿¡æ¯.... æææ§å¶åçåå­å¤§å°æ¯ç¸åçï¼å¤§æ¦æ¯é¡µç8%ï¼ï¼æ§å¶ååç¼å­é¡µæ¯ä¸ä¸å¯¹åºçï¼ä»ä»¬é½å­æ¾å¨Buffer Poolä¸­ï¼ å¶ä¸­æ§å¶åè¢«æ¾å¨ç¼å­é¡µåé¢ï¼æä»¥å¨Buffer Poolä¸­ï¼æ§å¶ååç¼å­é¡µå¯¹åºçç©ºé´çèµ·æ¥å°±è·è¿æ ·å¼çï¼\n\n\n\n\n# 3. freeé¾è¡¨\n\næåå¯å¨MySQLæ¶ï¼éè¦å®æBuffer Poolçåå§åè¿ç¨ï¼å°±æ¯åæä½ç³»ç»ç³è¯·Buffer Poolçç©ºé´ï¼ç¶åå°å®ååä¸ºè¥å¹²å¯¹æ§å¶ååç¼å­é¡µï¼ ä½æ¯æ­¤æ¶å¹¶æ²¡æé¡µè¢«ç¼å­å°Bufferä¸­ï¼å ä¸ºè¿æ²¡æselectè¯­å¥ï¼ï¼åé¢éçç¨åºçè¿è¡æä¼ä¸æ­çæé¡µè¢«æ¾å¥Bufferä¸­ã ä½æ¯é®é¢æ¥äºï¼é¡µåºè¯¥æ¾å¨Buffer Poolçåªä¸ä¸ªä½ç½®å¢ï¼æèè¯´ï¼æä¹ç¥éåªäºç¼å­é¡µæ¯æ²¡æç¨è¿çï¼ é¾éè¦æ¨ä¸ªéåç¼å­é¡µæ¥çå®æ¯å¦ä¸ºç©ºåï¼\n\nè¿ä¸ªæ¯å¾å¥½è§£å³çï¼æä»¬æææç©ºé²çç¼å­é¡µå¯¹åºçæ§å¶åç»æä¸ä¸ªé¾è¡¨ï¼æä»¬ç§°ä¹ä¸ºfreeé¾è¡¨ã\n\nå½ä»ç£çå è½½åºä¸ä¸ªé¡µå¹¶ä¸ç¡®å®éè¦ç¼å­å®æ¶ï¼å¨freeé¾è¡¨ä¸­æ¿ä¸ä¸ªæ§å¶åï¼å°è¯¥é¡µçåºæ¬ä¿¡æ¯è®°å½å¨æ§å¶åä¸­å¹¶ææ§å¶åä»freeé¾è¡¨ä¸­å é¤ã\n\né£ä¹åæçå¾æ¹ä¸ä¸å°±æäºè¿ä¸ªæ ·å­ï¼\n\n\n\nå½æä»¬ä½¿ç¨selectè¯­å¥æ¶å°±ä¼ä»ç£çä¸­è¯»åé¡µåºæ¥ï¼å½è¯»ååºä¸é¡µæ¶ï¼ä¼å°freeé¾è¡¨çç¬¬ä¸ä¸ªæ§å¶åå¡«ä¸è¿ä¸ªé¡µçä¿¡æ¯ï¼ç¶åå°å®ä»freeé¾è¡¨å é¤ï¼\n\n\n\n\n# 4. flushé¾è¡¨\n\nç¼å­è½å¥½ï¼ä½é®é¢ä¹æºå¤ï¼ä¾å¦ï¼èæ°æ®ãä»ä¹æ¯èæ°æ®ï¼å°±æ¯ä½ ææ°æ®ä»ç£çä¸­è¯»å°åå­æä½ï¼åå­ä¸­çæ°æ®è¢«ä¿®æ¹äºä½æ¯å¹¶æ²¡æåå¥ç£çï¼é æäºåä¸ä¸ªæ°æ®å¨åå­ä¸­åç£çä¸­ä¸ä¸æ ·ãè¿å°±æ¯èæ°æ®ã\n\nä¸é¢è¯´è¿ï¼MySQLå¨Bufferä¸­ç»´æ¤äºå¾å¤ä¸ªæ§å¶å-ç¼å­é¡µï¼æä½ä¸æ®µæ¶é´åè¯å®ä¼åºç°èæ°æ®ï¼ä¹è¯å®è¦å¾ç£çä¸­åæ­¥æ°æ®ï¼é£ä¹æä»¬æä¹ç¥éåªäºé¡µæ¯èæ°æ®å¢ï¼ä¸ä¸ªä¸ä¸ªéåï¼MySQLçè®¾è®¡èè¯å®ä¸ä¼è¿ä¹å»ã\n\nä»ä»¬å¢å äºä¸ä¸ªé¾è¡¨ï¼flushé¾è¡¨ï¼ç¨æ¥è®°å½èæ°æ®é¡µãææè¢«åè¿çé¡µå¯¹åºçæ§å¶åé½ä¼è¢«å å¥è¿ä¸ªé¾è¡¨ä¸­ï¼ç­æ°æ®åæ­¥çæ¶åç´æ¥éåflushé¾è¡¨ï¼éè¿æ§å¶åæ¾å°ç¼å­é¡µï¼å°ç¼å­é¡µå·å°ç£çä¸­ã\n\né£ä¹åæçå¾ç»§ç»­å®åï¼\n\nï¼ç¼å­å1åç¼å­å6é½æ²¡æè¢«ä½¿ç¨ï¼ç¼å­å13åç¼å­å45é½äº§çäºèæ°æ®ï¼\n\n\n\nfreeé¾è¡¨åflushé½æä¸ä¸ªå¤´èç¹ä¸å­å¨ä»»ä½æ§å¶åã\n\n\n\n\n# 5. LRUé¾è¡¨\n\nä½ çå°LRUè¿ä¸ªè¯å¯è½ä¼æµé¼ï¼ä½æ¯ä½ å¤§æ¦çå­¦è¿LRUï¼Redisçæ·æ±°ç­ç¥ä¹ä¸ï¼LRUç­ç¥ã\n\nLRU ï¼Least Recently Usedï¼æè¿æå°ä½¿ç¨ãLRUæ¯å¸åçåå­ç®¡çç®æ³ï¼å®çææ³ç¨éä¿çè¯æ¥è¯´å°±æ¯æè¿è¢«é¢ç¹è®¿é®çæ°æ®ä¼å·å¤æ´é«ççå­ï¼æ·æ±°é£äºä¸å¸¸è¢«è®¿é®çæ°æ®ã\n\næ¯å½ä½¿ç¨å°ä¸ä¸ªæ°æ®æ¶ï¼å°å®æ¾å¨æåé¢ï¼å é¤æåé¢çæ°æ®ãè®¾æ³ä¸ä¸ªéåï¼è§å®å®åªè½ä»éå¤´è¿å¥éå°¾å é¤ï¼å·®ä¸å¤å°±æ¯LRUçææ³äºã\n\nä¸ºä»ä¹MySQLè¦ä½¿ç¨LRUç®æ³å¢ï¼Buffer Poolå¤§å°æ¯ç«æ¯æéçï¼æä»¬è¦æé£äºæ§çæ°æ®ä»Buffer Poolä¸­ç§»é¤ã\n\n> é£ä¹é®é¢æ¥äºï¼ä¸ºä»ä¹ä¸å®è¦ç§»é¤æ§çå¢ï¼ä¸æ¯åºè¯¥ç§»é¤æå°ä½¿ç¨è¿çåï¼\n> \n> å¶å®å¯ä»¥çä¸ä¸æ¶é´å±é¨æ§åç©ºé´å±é¨æ§ã\n\nåæ¥çä¸ä¸ç®åçLRUé¾è¡¨çå®ç°å§ï¼\n\n * å¦æè¯¥é¡µä¸å¨Buffer Poolä¸­ï¼å½æè¯¥é¡µä»ç£çä¸­å è½½å°Buffer Poolçç¼å­é¡µä¸­æ¶ï¼å°±æè¯¥ç¼å­é¡µå¯¹åºçæ§å¶åæ¾å°LRUé¾è¡¨å¤´é¨ã\n * å¦æè¯¥é¡µå·²ç»å¨Buffer Poolä¸­ï¼å°±æè¯¥é¡µå¯¹åºçç¼å­åç§»å¨å°LRUé¾è¡¨å¤´é¨ã\n\nä¹å°±æ¯è¯´ï¼åªè¦ç¨å°æä¸ªç¼å­é¡µï¼å°±æè¿ä¸ªç¼å­é¡µå¯¹åºçæ§å¶åç§»å¨å°LRUé¾è¡¨å¤´é¨ï¼é£ä¹å°¾é¨å°±æ¯æè¿æå°ä½¿ç¨å°çç¼å­é¡µäºã\n\nä½æ¯MySQLå¹¶æ²¡æç´æ¥ä½¿ç¨ä¸è¿°LRUé¾è¡¨ã\n\nå ä¸ºæä¸¤ä¸ªæåµå¯¹äºè¿ç§ç®åçLRUé¾è¡¨æ¥è¯´ç¹å«å°´å°¬ï¼\n\n 1. InnoDBçé¢è¯»ã\n    \n    é¢è¯» ï¼InnoDBè®¤ä¸ºæ§è¡å½åçè¯·æ±å¯è½ä¹åä¼è¯»åæäºé¡µï¼å°±æåæè¿äºé¡µå è½½å°Buffer Poolä¸­ãæ ¹æ®è§¦åçæ¹å¼ä¸åï¼é¢è¯»åå¯ä»¥åä¸ºä¸¤ç±»ï¼\n    \n    * çº¿æ§é¢è¯»ï¼\n      \n      å¦æé¡ºåºè®¿é®äºæä¸ªåº(extent)çé¡µé¢æ°éè¶è¿äºç¹å®å¼ï¼å°±ä¼è§¦åä¸æ¬¡å¼æ­¥è¯»åä¸ä¸ä¸ªåºä¸­å¨é¨çé¡µå°Buffer Poolä¸­ãå¼æ­¥å°±æå³çä»ç£çå è½½è¿äºè¢«é¢è¯»çé¡µé¢å¹¶ä¸ä¼å½±åå½åå·¥ä½çº¿ç¨çæ­£å¸¸æ§è¡ã\n    \n    * éæºé¢è¯»ï¼\n      \n      å¦æBuffer Poolä¸­å·²ç»ç¼å­äºæä¸ªåºç13ä¸ªè¿ç»­çé¡µé¢ï¼ä¸è®ºè¿äºé¡µæ¯é¡ºåºè¯»åè¿æ¯éæºè¯»åï¼é½ä¼è§¦åä¸æ¬¡éæºé¢è¯»ï¼å¼æ­¥è¯»åæ¬åºä¸­ææå¶ä»çé¡µå è½½å°ç¼å­ã\n    \n    é¢è¯»æ¬æ¥æ¯å¥½äºï¼å¦æé¢è¯»çé¡µè¢«è®¿é®å°ï¼å°±å¯ä»¥å¤§å¤§æåæçãå¯æ¯å¦æç¨ä¸å°å¢ï¼è¿äºé¢è¯»çé¡µä¼è¢«æ¾å°Buffer PoolçLRUé¾è¡¨çå¤´é¨ï¼å°åæ¥çé¡µæ¤æå¾å¤ï¼ä¸ä¸é¢è¯»çé¡µä¸ç»å¸¸ç¨å°ï¼å°±ä¼åºç°å£å¸é©±éè¯å¸çç°è±¡ï¼å¤§å¤§åå°å½ä¸­çã\n\n 2. æ«æå¨è¡¨\n    \n    ææ¶åæä»¬çSQLè¯­å¥éè¦å¯¹å¨è¡¨è¿è¡æ«æï¼è¿æå³çè¦å°è¿ä¸ªè¡¨å¯¹åºçææé¡µé½å è½½å°Buffer Poolä¸­ï¼åæ ·ä¹è¦æ¾å¥LRUé¾è¡¨çå¤´é¨ï¼åæ ·ä¼åºç°å£å¸é©±éè¯å¸çç°è±¡ã\n\næ»ç»ä¸ä¸è¿ä¸¤ç§ç¹æ®æåµå§ï¼ææ¶åä¼ä¸æ¬¡æ«æå°å¾å¤ä½¿ç¨ä¸å°é¡µï¼ä¼åºç°å£å¸é©±é¤è¯å¸çç°è±¡ã\n\nå ä¸ºæè¿ä¸¤ç§ç¹æ®æåµçå­å¨ï¼MySQLå°LRUé¾è¡¨åä¸ºä¸¤ä¸ªé¨åï¼\n\n * youngåºå ï¼å­å¨ä½¿ç¨é¢çå¾é«çç¼å­é¡µ\n * oldåºå ï¼å­å¨ä½¿ç¨é¢çä¸é«çç¼å­é¡µ\n\nï¼ææ²¡æå¾åJVMçæ°çä»£åèå¹´ä»£ï¼ï¼\n\nå¦å¾æç¤ºï¼ç¼å­é¡µ2ã45ã1å¤å¨youngåºåï¼ä¸ºç»å¸¸ä½¿ç¨å°çç¼å­é¡µã\n\nç¼å­é¡µ13ã6å¤å¨oldåºåï¼ä¸ºä½¿ç¨é¢çä¸é«çç¼å­é¡µã\n\n\n\néè¦æ³¨æçæ¯ï¼MySQLæç§æ¯ä¾ç»youngåºååoldåºååéå¤§å°ï¼ä¸è¬æ¥è¯´æ¯ 63 ï¼37ï¼éçç¨åºçè¿è¡ï¼ä¸ä¸ªæ§å¶åå¯è½ä»youngåºåè·³å°oldåºåï¼ä¹å¯è½ä»oldåºåè·³å°youngåºåã\n\næäºè¿ä¸ªååä¸ºyoungåoldåºåçLRUé¾è¡¨åï¼MySQLå°±å¯ä»¥è§£å³æä»¬åæçé®é¢äºï¼\n\n 1. éå¯¹é¢è¯»ï¼\n    \n    é¢è¯»çä¸»è¦å±å®³ï¼é¢è¯»åºæ¥çç¼å­é¡µå¯è½åç»­å°±ä¸è®¿é®ã\n    \n    ä¼åï¼å½ç£çä¸çæä¸ªé¡µé¢å¨é¦æ¬¡å è½½å°Buffer Poolä¸­æ¶ï¼ä¼åå°ç¼å­é¡µå¯¹åºçæ§å¶åå å¥å°oldåºåçå¤´é¨ï¼è¿æ ·éå¯¹é¢è¯»å°Buffer Poolå´ä¸è¿è¡åç»­è®¿é®çç¼å­é¡µå°±ä¼éæ¸ä»oldåºåéåºï¼èä¸ä¼å½±åyoungåºåä¸­æ¯è¾ç»å¸¸ä½¿ç¨éå°çç¼å­é¡µ\n\n 2. éå¯¹å¨è¡¨æ«æï¼\n    \n    å¨è¡¨æ«æçå±å®³ï¼å¨è¿è¡å¨è¡¨æ«ææ¶ï¼è½ç¶é¦æ¬¡è¢«å è½½å°Buffer Poolçé¡µè¢«æ¾å¨äºoldåºåçå¤´é¨ï¼ä½æ¯åç»­ä¼è¢«é©¬ä¸è®¿é®å°ï¼æ¯æ¬¡è¿è¡è®¿é®çæ¶ååä¼å°å¶æ¾å°youngåºåçå¤´é¨ï¼è¿æ ·ä»ä¼å½±ååæ¬å°±ç»å¸¸è®¿é®å°çç¼å­é¡µã\n    \n    ä¼åï¼å¨è¡¨æ«æçæ§è¡é¢çéå¸¸ä½ï¼ï¼æ¯ç«è°ä¹ä¸ä¼æ²¡äºå°±å¨é£åselect * from userï¼ï¼æä»¥MySQLè§å®ï¼å¨å¯¹æä¸ªå¤å¨oldåºåçç¼å­é¡µç¬¬ä¸è®¿é®æ¶å°±å¨å®å¯¹åºçæ§å¶åä¸­è®°å½ä¸æ¥è¿ä¸ªè®¿é®æ¶é´ï¼å¦æåç»­çè®¿é®æ¶é´ä¸ç¬¬ä¸æ¬¡çè®¿é®æ¶é´éçæ¶é´å¾ç­ï¼å¤§æ¦çå°±æ¯å¨è¡¨æ«æï¼å°±ä¸æå®ç§»å¨å°youngåºåçå¤´é¨ãå¦åå°±æå®ç§»å¨å°youngåºåã\n\nå½ç¶ï¼MySQLçLRUæ¯ä¸è¿°æè¿°çè¿è¦å¤æå¾å¤ï¼ä¸è¿å¨å¤æäºæä¹ä¸ä¼äº~~~~\n\n\n# 6. æ»ç»\n\n 1. åå­ä¸ç£çä¹é´è¿è¡äº¤äºï¼æå¿è¦è®¾ç½®ä¸ä¸ªç¼å­ã\n\n 2. Buffer Poolæ¬è´¨ä¸æ¯åå­ä¸­çä¸åè¿ç»­ç©ºé´\n\n 3. Buffer Poolçç»æ ï¼æ§å¶åãç¼å­é¡µã\n\n 4. InnoDBå¼æä½¿ç¨äºå¾å¤é¾è¡¨æ¥ç®¡çBuffer Poolï¼\n    \n    * freeé¾è¡¨ ï¼è®°å½æææªä½¿ç¨çç¼å­é¡µ\n    * flushé¾è¡¨ ï¼è®°å½ææèç¼å­é¡µ\n    * LRUé¾è¡¨ ï¼ç¨äºæ·æ±°ç¼å­é¡µï¼åä¸ºoldåyoungä¸¤ä¸ªåºåã",normalizedContent:"# 1. ä»ä¹æ¯buffer pool\n\néè¿åå ç¯æç« çå­¦ä¹ æä»¬å¤§è´äºè§£å°ï¼å¯¹äºinnodbå¼ææ¥è¯´ï¼ææçæ°æ®é½æ¯å­å¨ç£çä¸­ï¼ç¨çæ¶åä»¥é¡µä¸ºåä½å è½½å°åå­ä¸­çã è¿æ ·å°±åå°äºselectä¸æ¡æ°æ®è¿è¦æ¥åè¿è¡ç£çioçæ§è½æèãä½æ¯å è½½å°åå­ä¸­åå¹¶ä¸æ¯ç¨å®å°±ä¸¢äºï¼èæ¯æ¾å¨ç¼å­ä¸­ï¼ä¸æ¬¡ç¨ç´æ¥æ¿å°±å¥½äºã\n\nä¸ºäºç¼å­è¿äºé¡µæ°æ®ï¼mysqlæå¡å¨å¯å¨çæ¶åå°±ç³è¯·äºä¸çè¿ç»­çåå­ï¼å«åbuffer poolãå®çå¤§å°éå¸¸æ¯128mï¼è¿ä¸ªå¼å¯ä»¥è®¾ç½®ï¼å¦æå°äº5mä¼èªå¨è®¾ç½®ä¸º5mã\n\n\n# 2. buffer poolçç»æ\n\nbuffer pooléè¦ç¼å­ä»ç£çå è½½åºæ¥çé¡µï¼ç£çä¸­çé¡µæ¯16kï¼bufferpooléé¢é¡µçåç£çä¸­çé¡µä¸æ ·å¤§ãä¸ºäºè¡¨ç¤ºåºåï¼æ¥ä¸æ¥å°ç§°buffer poolä¸­çé¡µä¸ºç¼å­é¡µã\n\nä¸è¬æ¥è¯´ï¼ä¸ºäºæ´å¥½çç®¡çæ°æ®ï¼é½ä¼ç»æ°æ®æ·»å ä¸äºâåæ°æ®âãâå¤´ä¿¡æ¯âä¹ç±»çæè¿°æ°æ®çæ°æ®ï¼ ä¾å¦å¯¹è±¡objectçå¯¹è±¡å¤´ãmysqlçéèå­æ®µãæ¶æ¯éåä¸­æ¶æ¯çåæ°æ®.... å¨è¿éä¹ä¸æå¤ï¼innodbå¼æä¹å¯¹buffer poolç¼å­çé¡µå¢å äºæè¿°ä¿¡æ¯ï¼æ§å¶åãæ¯ä¸ä¸ªç¼å­é¡µé½æå®å¯¹åºçæ§å¶åï¼ æ¯ä¸ä¸ªæ§å¶åä¸­çä¿¡æ¯åæ¬ è¯¥é¡µçé¡µå·ãè¯¥é¡µæå±çè¡¨å·ãè¯¥é¡µå¨buffer poolä¸­çä½ç½®ãé¾è¡¨èç¹ä¿¡æ¯.... æææ§å¶åçåå­å¤§å°æ¯ç¸åçï¼å¤§æ¦æ¯é¡µç8%ï¼ï¼æ§å¶ååç¼å­é¡µæ¯ä¸ä¸å¯¹åºçï¼ä»ä»¬é½å­æ¾å¨buffer poolä¸­ï¼ å¶ä¸­æ§å¶åè¢«æ¾å¨ç¼å­é¡µåé¢ï¼æä»¥å¨buffer poolä¸­ï¼æ§å¶ååç¼å­é¡µå¯¹åºçç©ºé´çèµ·æ¥å°±è·è¿æ ·å¼çï¼\n\n\n\n\n# 3. freeé¾è¡¨\n\næåå¯å¨mysqlæ¶ï¼éè¦å®æbuffer poolçåå§åè¿ç¨ï¼å°±æ¯åæä½ç³»ç»ç³è¯·buffer poolçç©ºé´ï¼ç¶åå°å®ååä¸ºè¥å¹²å¯¹æ§å¶ååç¼å­é¡µï¼ ä½æ¯æ­¤æ¶å¹¶æ²¡æé¡µè¢«ç¼å­å°bufferä¸­ï¼å ä¸ºè¿æ²¡æselectè¯­å¥ï¼ï¼åé¢éçç¨åºçè¿è¡æä¼ä¸æ­çæé¡µè¢«æ¾å¥bufferä¸­ã ä½æ¯é®é¢æ¥äºï¼é¡µåºè¯¥æ¾å¨buffer poolçåªä¸ä¸ªä½ç½®å¢ï¼æèè¯´ï¼æä¹ç¥éåªäºç¼å­é¡µæ¯æ²¡æç¨è¿çï¼ é¾éè¦æ¨ä¸ªéåç¼å­é¡µæ¥çå®æ¯å¦ä¸ºç©ºåï¼\n\nè¿ä¸ªæ¯å¾å¥½è§£å³çï¼æä»¬æææç©ºé²çç¼å­é¡µå¯¹åºçæ§å¶åç»æä¸ä¸ªé¾è¡¨ï¼æä»¬ç§°ä¹ä¸ºfreeé¾è¡¨ã\n\nå½ä»ç£çå è½½åºä¸ä¸ªé¡µå¹¶ä¸ç¡®å®éè¦ç¼å­å®æ¶ï¼å¨freeé¾è¡¨ä¸­æ¿ä¸ä¸ªæ§å¶åï¼å°è¯¥é¡µçåºæ¬ä¿¡æ¯è®°å½å¨æ§å¶åä¸­å¹¶ææ§å¶åä»freeé¾è¡¨ä¸­å é¤ã\n\né£ä¹åæçå¾æ¹ä¸ä¸å°±æäºè¿ä¸ªæ ·å­ï¼\n\n\n\nå½æä»¬ä½¿ç¨selectè¯­å¥æ¶å°±ä¼ä»ç£çä¸­è¯»åé¡µåºæ¥ï¼å½è¯»ååºä¸é¡µæ¶ï¼ä¼å°freeé¾è¡¨çç¬¬ä¸ä¸ªæ§å¶åå¡«ä¸è¿ä¸ªé¡µçä¿¡æ¯ï¼ç¶åå°å®ä»freeé¾è¡¨å é¤ï¼\n\n\n\n\n# 4. flushé¾è¡¨\n\nç¼å­è½å¥½ï¼ä½é®é¢ä¹æºå¤ï¼ä¾å¦ï¼èæ°æ®ãä»ä¹æ¯èæ°æ®ï¼å°±æ¯ä½ ææ°æ®ä»ç£çä¸­è¯»å°åå­æä½ï¼åå­ä¸­çæ°æ®è¢«ä¿®æ¹äºä½æ¯å¹¶æ²¡æåå¥ç£çï¼é æäºåä¸ä¸ªæ°æ®å¨åå­ä¸­åç£çä¸­ä¸ä¸æ ·ãè¿å°±æ¯èæ°æ®ã\n\nä¸é¢è¯´è¿ï¼mysqlå¨bufferä¸­ç»´æ¤äºå¾å¤ä¸ªæ§å¶å-ç¼å­é¡µï¼æä½ä¸æ®µæ¶é´åè¯å®ä¼åºç°èæ°æ®ï¼ä¹è¯å®è¦å¾ç£çä¸­åæ­¥æ°æ®ï¼é£ä¹æä»¬æä¹ç¥éåªäºé¡µæ¯èæ°æ®å¢ï¼ä¸ä¸ªä¸ä¸ªéåï¼mysqlçè®¾è®¡èè¯å®ä¸ä¼è¿ä¹å»ã\n\nä»ä»¬å¢å äºä¸ä¸ªé¾è¡¨ï¼flushé¾è¡¨ï¼ç¨æ¥è®°å½èæ°æ®é¡µãææè¢«åè¿çé¡µå¯¹åºçæ§å¶åé½ä¼è¢«å å¥è¿ä¸ªé¾è¡¨ä¸­ï¼ç­æ°æ®åæ­¥çæ¶åç´æ¥éåflushé¾è¡¨ï¼éè¿æ§å¶åæ¾å°ç¼å­é¡µï¼å°ç¼å­é¡µå·å°ç£çä¸­ã\n\né£ä¹åæçå¾ç»§ç»­å®åï¼\n\nï¼ç¼å­å1åç¼å­å6é½æ²¡æè¢«ä½¿ç¨ï¼ç¼å­å13åç¼å­å45é½äº§çäºèæ°æ®ï¼\n\n\n\nfreeé¾è¡¨åflushé½æä¸ä¸ªå¤´èç¹ä¸å­å¨ä»»ä½æ§å¶åã\n\n\n\n\n# 5. lrué¾è¡¨\n\nä½ çå°lruè¿ä¸ªè¯å¯è½ä¼æµé¼ï¼ä½æ¯ä½ å¤§æ¦çå­¦è¿lruï¼redisçæ·æ±°ç­ç¥ä¹ä¸ï¼lruç­ç¥ã\n\nlru ï¼least recently usedï¼æè¿æå°ä½¿ç¨ãlruæ¯å¸åçåå­ç®¡çç®æ³ï¼å®çææ³ç¨éä¿çè¯æ¥è¯´å°±æ¯æè¿è¢«é¢ç¹è®¿é®çæ°æ®ä¼å·å¤æ´é«ççå­ï¼æ·æ±°é£äºä¸å¸¸è¢«è®¿é®çæ°æ®ã\n\næ¯å½ä½¿ç¨å°ä¸ä¸ªæ°æ®æ¶ï¼å°å®æ¾å¨æåé¢ï¼å é¤æåé¢çæ°æ®ãè®¾æ³ä¸ä¸ªéåï¼è§å®å®åªè½ä»éå¤´è¿å¥éå°¾å é¤ï¼å·®ä¸å¤å°±æ¯lruçææ³äºã\n\nä¸ºä»ä¹mysqlè¦ä½¿ç¨lruç®æ³å¢ï¼buffer poolå¤§å°æ¯ç«æ¯æéçï¼æä»¬è¦æé£äºæ§çæ°æ®ä»buffer poolä¸­ç§»é¤ã\n\n> é£ä¹é®é¢æ¥äºï¼ä¸ºä»ä¹ä¸å®è¦ç§»é¤æ§çå¢ï¼ä¸æ¯åºè¯¥ç§»é¤æå°ä½¿ç¨è¿çåï¼\n> \n> å¶å®å¯ä»¥çä¸ä¸æ¶é´å±é¨æ§åç©ºé´å±é¨æ§ã\n\nåæ¥çä¸ä¸ç®åçlrué¾è¡¨çå®ç°å§ï¼\n\n * å¦æè¯¥é¡µä¸å¨buffer poolä¸­ï¼å½æè¯¥é¡µä»ç£çä¸­å è½½å°buffer poolçç¼å­é¡µä¸­æ¶ï¼å°±æè¯¥ç¼å­é¡µå¯¹åºçæ§å¶åæ¾å°lrué¾è¡¨å¤´é¨ã\n * å¦æè¯¥é¡µå·²ç»å¨buffer poolä¸­ï¼å°±æè¯¥é¡µå¯¹åºçç¼å­åç§»å¨å°lrué¾è¡¨å¤´é¨ã\n\nä¹å°±æ¯è¯´ï¼åªè¦ç¨å°æä¸ªç¼å­é¡µï¼å°±æè¿ä¸ªç¼å­é¡µå¯¹åºçæ§å¶åç§»å¨å°lrué¾è¡¨å¤´é¨ï¼é£ä¹å°¾é¨å°±æ¯æè¿æå°ä½¿ç¨å°çç¼å­é¡µäºã\n\nä½æ¯mysqlå¹¶æ²¡æç´æ¥ä½¿ç¨ä¸è¿°lrué¾è¡¨ã\n\nå ä¸ºæä¸¤ä¸ªæåµå¯¹äºè¿ç§ç®åçlrué¾è¡¨æ¥è¯´ç¹å«å°´å°¬ï¼\n\n 1. innodbçé¢è¯»ã\n    \n    é¢è¯» ï¼innodbè®¤ä¸ºæ§è¡å½åçè¯·æ±å¯è½ä¹åä¼è¯»åæäºé¡µï¼å°±æåæè¿äºé¡µå è½½å°buffer poolä¸­ãæ ¹æ®è§¦åçæ¹å¼ä¸åï¼é¢è¯»åå¯ä»¥åä¸ºä¸¤ç±»ï¼\n    \n    * çº¿æ§é¢è¯»ï¼\n      \n      å¦æé¡ºåºè®¿é®äºæä¸ªåº(extent)çé¡µé¢æ°éè¶è¿äºç¹å®å¼ï¼å°±ä¼è§¦åä¸æ¬¡å¼æ­¥è¯»åä¸ä¸ä¸ªåºä¸­å¨é¨çé¡µå°buffer poolä¸­ãå¼æ­¥å°±æå³çä»ç£çå è½½è¿äºè¢«é¢è¯»çé¡µé¢å¹¶ä¸ä¼å½±åå½åå·¥ä½çº¿ç¨çæ­£å¸¸æ§è¡ã\n    \n    * éæºé¢è¯»ï¼\n      \n      å¦æbuffer poolä¸­å·²ç»ç¼å­äºæä¸ªåºç13ä¸ªè¿ç»­çé¡µé¢ï¼ä¸è®ºè¿äºé¡µæ¯é¡ºåºè¯»åè¿æ¯éæºè¯»åï¼é½ä¼è§¦åä¸æ¬¡éæºé¢è¯»ï¼å¼æ­¥è¯»åæ¬åºä¸­ææå¶ä»çé¡µå è½½å°ç¼å­ã\n    \n    é¢è¯»æ¬æ¥æ¯å¥½äºï¼å¦æé¢è¯»çé¡µè¢«è®¿é®å°ï¼å°±å¯ä»¥å¤§å¤§æåæçãå¯æ¯å¦æç¨ä¸å°å¢ï¼è¿äºé¢è¯»çé¡µä¼è¢«æ¾å°buffer poolçlrué¾è¡¨çå¤´é¨ï¼å°åæ¥çé¡µæ¤æå¾å¤ï¼ä¸ä¸é¢è¯»çé¡µä¸ç»å¸¸ç¨å°ï¼å°±ä¼åºç°å£å¸é©±éè¯å¸çç°è±¡ï¼å¤§å¤§åå°å½ä¸­çã\n\n 2. æ«æå¨è¡¨\n    \n    ææ¶åæä»¬çsqlè¯­å¥éè¦å¯¹å¨è¡¨è¿è¡æ«æï¼è¿æå³çè¦å°è¿ä¸ªè¡¨å¯¹åºçææé¡µé½å è½½å°buffer poolä¸­ï¼åæ ·ä¹è¦æ¾å¥lrué¾è¡¨çå¤´é¨ï¼åæ ·ä¼åºç°å£å¸é©±éè¯å¸çç°è±¡ã\n\næ»ç»ä¸ä¸è¿ä¸¤ç§ç¹æ®æåµå§ï¼ææ¶åä¼ä¸æ¬¡æ«æå°å¾å¤ä½¿ç¨ä¸å°é¡µï¼ä¼åºç°å£å¸é©±é¤è¯å¸çç°è±¡ã\n\nå ä¸ºæè¿ä¸¤ç§ç¹æ®æåµçå­å¨ï¼mysqlå°lrué¾è¡¨åä¸ºä¸¤ä¸ªé¨åï¼\n\n * youngåºå ï¼å­å¨ä½¿ç¨é¢çå¾é«çç¼å­é¡µ\n * oldåºå ï¼å­å¨ä½¿ç¨é¢çä¸é«çç¼å­é¡µ\n\nï¼ææ²¡æå¾åjvmçæ°çä»£åèå¹´ä»£ï¼ï¼\n\nå¦å¾æç¤ºï¼ç¼å­é¡µ2ã45ã1å¤å¨youngåºåï¼ä¸ºç»å¸¸ä½¿ç¨å°çç¼å­é¡µã\n\nç¼å­é¡µ13ã6å¤å¨oldåºåï¼ä¸ºä½¿ç¨é¢çä¸é«çç¼å­é¡µã\n\n\n\néè¦æ³¨æçæ¯ï¼mysqlæç§æ¯ä¾ç»youngåºååoldåºååéå¤§å°ï¼ä¸è¬æ¥è¯´æ¯ 63 ï¼37ï¼éçç¨åºçè¿è¡ï¼ä¸ä¸ªæ§å¶åå¯è½ä»youngåºåè·³å°oldåºåï¼ä¹å¯è½ä»oldåºåè·³å°youngåºåã\n\næäºè¿ä¸ªååä¸ºyoungåoldåºåçlrué¾è¡¨åï¼mysqlå°±å¯ä»¥è§£å³æä»¬åæçé®é¢äºï¼\n\n 1. éå¯¹é¢è¯»ï¼\n    \n    é¢è¯»çä¸»è¦å±å®³ï¼é¢è¯»åºæ¥çç¼å­é¡µå¯è½åç»­å°±ä¸è®¿é®ã\n    \n    ä¼åï¼å½ç£çä¸çæä¸ªé¡µé¢å¨é¦æ¬¡å è½½å°buffer poolä¸­æ¶ï¼ä¼åå°ç¼å­é¡µå¯¹åºçæ§å¶åå å¥å°oldåºåçå¤´é¨ï¼è¿æ ·éå¯¹é¢è¯»å°buffer poolå´ä¸è¿è¡åç»­è®¿é®çç¼å­é¡µå°±ä¼éæ¸ä»oldåºåéåºï¼èä¸ä¼å½±åyoungåºåä¸­æ¯è¾ç»å¸¸ä½¿ç¨éå°çç¼å­é¡µ\n\n 2. éå¯¹å¨è¡¨æ«æï¼\n    \n    å¨è¡¨æ«æçå±å®³ï¼å¨è¿è¡å¨è¡¨æ«ææ¶ï¼è½ç¶é¦æ¬¡è¢«å è½½å°buffer poolçé¡µè¢«æ¾å¨äºoldåºåçå¤´é¨ï¼ä½æ¯åç»­ä¼è¢«é©¬ä¸è®¿é®å°ï¼æ¯æ¬¡è¿è¡è®¿é®çæ¶ååä¼å°å¶æ¾å°youngåºåçå¤´é¨ï¼è¿æ ·ä»ä¼å½±ååæ¬å°±ç»å¸¸è®¿é®å°çç¼å­é¡µã\n    \n    ä¼åï¼å¨è¡¨æ«æçæ§è¡é¢çéå¸¸ä½ï¼ï¼æ¯ç«è°ä¹ä¸ä¼æ²¡äºå°±å¨é£åselect * from userï¼ï¼æä»¥mysqlè§å®ï¼å¨å¯¹æä¸ªå¤å¨oldåºåçç¼å­é¡µç¬¬ä¸è®¿é®æ¶å°±å¨å®å¯¹åºçæ§å¶åä¸­è®°å½ä¸æ¥è¿ä¸ªè®¿é®æ¶é´ï¼å¦æåç»­çè®¿é®æ¶é´ä¸ç¬¬ä¸æ¬¡çè®¿é®æ¶é´éçæ¶é´å¾ç­ï¼å¤§æ¦çå°±æ¯å¨è¡¨æ«æï¼å°±ä¸æå®ç§»å¨å°youngåºåçå¤´é¨ãå¦åå°±æå®ç§»å¨å°youngåºåã\n\nå½ç¶ï¼mysqlçlruæ¯ä¸è¿°æè¿°çè¿è¦å¤æå¾å¤ï¼ä¸è¿å¨å¤æäºæä¹ä¸ä¼äº~~~~\n\n\n# 6. æ»ç»\n\n 1. åå­ä¸ç£çä¹é´è¿è¡äº¤äºï¼æå¿è¦è®¾ç½®ä¸ä¸ªç¼å­ã\n\n 2. buffer poolæ¬è´¨ä¸æ¯åå­ä¸­çä¸åè¿ç»­ç©ºé´\n\n 3. buffer poolçç»æ ï¼æ§å¶åãç¼å­é¡µã\n\n 4. innodbå¼æä½¿ç¨äºå¾å¤é¾è¡¨æ¥ç®¡çbuffer poolï¼\n    \n    * freeé¾è¡¨ ï¼è®°å½æææªä½¿ç¨çç¼å­é¡µ\n    * flushé¾è¡¨ ï¼è®°å½ææèç¼å­é¡µ\n    * lrué¾è¡¨ ï¼ç¨äºæ·æ±°ç¼å­é¡µï¼åä¸ºoldåyoungä¸¤ä¸ªåºåã",charsets:{cjk:!0},lastUpdated:"2023/08/02, 23:56:18",lastUpdatedTimestamp:1690991778e3},{title:"Redis æä¹åæºå¶",frontmatter:{title:"Redis æä¹åæºå¶",date:"2023-06-11T12:25:09.000Z",permalink:"/pages/4e0b96/"},regularPath:"/02.%E6%96%87%E7%AB%A0/10.Redis/20.Redis%20%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6.html",relativePath:"02.æç« /10.Redis/20.Redis æä¹åæºå¶.md",key:"v-c8c76474",path:"/pages/4e0b96/",headers:[{level:2,title:"1. æ¦è¿°",slug:"_1-æ¦è¿°",normalizedTitle:"1. æ¦è¿°",charIndex:18},{level:2,title:"2. RDB",slug:"_2-rdb",normalizedTitle:"2. rdb",charIndex:554},{level:3,title:"2.1 æå¨å¿«ç§",slug:"_2-1-æå¨å¿«ç§",normalizedTitle:"2.1 æå¨å¿«ç§",charIndex:750},{level:3,title:"2.2 èªå¨å¿«ç§",slug:"_2-2-èªå¨å¿«ç§",normalizedTitle:"2.2 èªå¨å¿«ç§",charIndex:1011},{level:2,title:"3. AOF",slug:"_3-aof",normalizedTitle:"3. aof",charIndex:1510},{level:3,title:"3.1 AOF æºå¶",slug:"_3-1-aof-æºå¶",normalizedTitle:"3.1 aof æºå¶",charIndex:1636},{level:3,title:"3.2 AOF æä»¶çéå",slug:"_3-2-aof-æä»¶çéå",normalizedTitle:"3.2 aof æä»¶çéå",charIndex:2347},{level:2,title:"4. æ··ååæä¹å",slug:"_4-æ··ååæä¹å",normalizedTitle:"4. æ··ååæä¹å",charIndex:3418},{level:2,title:"5. æ»ç»",slug:"_5-æ»ç»",normalizedTitle:"5. æ»ç»",charIndex:3900}],headersStr:"1. æ¦è¿° 2. RDB 2.1 æå¨å¿«ç§ 2.2 èªå¨å¿«ç§ 3. AOF 3.1 AOF æºå¶ 3.2 AOF æä»¶çéå 4. æ··ååæä¹å 5. æ»ç»",content:"# Redis æä¹åæºå¶\n\n\n# 1. æ¦è¿°\n\nRedis ä¸ºäºä¿è¯æ§è½ï¼ä¼å°æææ°æ®æ¾å¨åå­ä¸­ï¼é£ä¹ä¸ä¸ Redis å®æºï¼æ°æ®å²ä¸æ¯å¨é¨ä¸¢å¤±äºï¼\n\nä¸è¦æï¼Redis èªç¶æ³å°äºè¿ä¸ç¹ï¼å®æä¾äºä¸ç§æä¹åæºå¶å°åå­ä¸­çæ°æ®æä¹åå°ç£çä¸­ã\n\n 1. RDB\n    \n    å¿«ç§æ¹å¼æä¹åï¼snapshotï¼ï¼å¿«ç§å¨ Linux å°±å·²ç»å­¦è¿ï¼ä¿å­æææ°æ®çç¶æï¼ä¸æ¬¡å¼æºç´æ¥æç§è¿ä¸ªç¶ææ¢å¤ã\n    \n    å ä¸ºä¿å­çå¿«ç§æ¯ä»¥.rdb ç»å°¾çæä»¶ï¼æç§°æ­¤æ¹å¼ä¸º RDB æä¹åæ¹å¼ã\n\n 2. AOF\n    \n    ï¼append only fileï¼åªè¿½å æ¥å¿æä»¶ï¼è®°å½ Redis ææåå½ä»¤ï¼ä¸æ¬¡å¼æºå°è¿äºå½ä»¤å¨é¨æ§è¡ï¼å³å¯æ¢å¤æ°æ®ã\n\n 3. æ··ååæä¹å\n    \n    RDB è½ç¶å¿«ï¼ä½æ¯æ°æ®ä¸¢å¤±é®é¢è¾ä¸ºä¸¥éï¼AOF è½ç¶è½ä¿è¯æ°æ®å®å¨ï¼ä½æ¯æ§è¡ææå½ä»¤éè¦å¾é¿æ¶é´ã\n    \n    æä»¥ Redis4.x ä»¥åï¼å°ä¸¤ç§æ¹å¼ç»åï¼RDB æä»¶çåå®¹æ¾å¨ AOF æä»¶ä¸­ï¼ä»¥.aof æä»¶çå½¢å¼å­å¨ãå¨æ¢å¤æ°æ®æ¶ï¼åå è½½ rdb çåå®¹ï¼åæ§è¡ aof çåå®¹ãç¼ºç¹æ¯ä¸¤ç§æ ¼å¼æ··åå¨ä¸èµ·é¾ä»¥éè¯»ã\n\n==éè¦æ³¨æçæ¯ï¼ä¸è®ºæ¯åªç§æ¹å¼ï¼é½æ æ³ä¿è¯æ°æ®çç»å¯¹å®å¨ã==\n\n\n# 2. RDB\n\nsnapshot æ³å¿å¤§å®¶å·²ç»ä¸éçäºï¼Linux å·²ç»æ¥è§¦è¿è¿ä¸ªæºå¶ï¼==ä¿å­ç°å¨çç¶æï¼éæ¶åå¤æ¢å¤ã==\n\nææçå¿«ç§ä»¥**.rdb** çå½¢å¼ä¿å­å¨ç£çä¸­ã\n\nåå¦å¨ Redis å®æºä¹åææçå¿«ç§ä¸ºï¼\n\n\n\né£ä¹ä¸æ¬¡å¼æºå°±å¯ä»¥å³å°è¿ä¸¤ä¸ªæ°æ®æ¢å¤ã\n\nRedis æä¾äºä¸¤ç§ææå¿«ç§çæ¹å¼ ï¼èªå¨ãæå¨ãå¶ä¸­æå¨ææå¿«ç§æä¸¤ä¸ªå½ä»¤ï¼saveãbgsave\n\n\n\n\n# 2.1 æå¨å¿«ç§\n\n 1. save\n    \n    ç±ä¸»è¿ç¨å®æå¿«ç§çææï¼æä¹åè¿ç¨ä¸­å¶ä»å½ä»¤é»å¡ã\n    \n    \n\n 2. bgsave\n    \n    background saveï¼ä¸»çº¿ç¨ fork åºä¸ä¸ªå­è¿ç¨ï¼ç±è¿ä¸ªå­è¿ç¨å®ææä¹åã\n    \n    \n\n> fork ï¼\n> \n> å½ä¸ä¸ªè¿ç¨åå»ºå­è¿ç¨æ¶ï¼åºå±çæä½ç³»ç»ä¼åå»ºè¯¥è¿ç¨çå¯æ¬ï¼å¨ç±» unix ç³»ç»ä¸­åå»ºå­è¿ç¨çæä½ä¼è¿è¡ä¼åï¼å¨åå¼å§çæ¶åï¼ç¶å­è¿ç¨å±äº«ç¸ååå­ï¼ç´å°ç¶è¿ç¨/å­è¿ç¨å¯¹åå­è¿è¡åæä½åç»æå±äº«ï¼åç¨åçã\n\n\n# 2.2 èªå¨å¿«ç§\n\nå¨ redis.conf éç½®æä»¶ä¸­å­å¨ï¼åæ°å¦ä¸:ï¼çæ¬ä¸åï¼é»è®¤åæ°ä¸åï¼\n\n#   * After 3600 seconds (an hour) if at least 1 key changed\n#   * After 300 seconds (5 minutes) if at least 100 keys changed\n#   * After 60 seconds if at least 10000 keys changed\n\n# save 3600 1\n# save 300 100\n# save 60 10000\n\n\nè§£é ï¼\n\n1h åæä¸ä¸ªé®è¢«æ¹åä¼è§¦åå¿«ç§ææã\n\n5mins åæ 100 ä¸ªé®è¢«æ¹åä¼è§¦åå¿«ç§ææã\n\n1min åæ 10000 ä¸ªé®è¢«æ¹åä¼è§¦åå¿«ç§ææã\n\nè¿äºå¿«ç§çæææ¹å¼é½æ¯ bgsaveã\n\nä¼ç¹ ï¼\n\n * rdb æä»¶çå è½½éåº¦ç¹å«å¿«ï¼è¿è¶ aofã\n\n * ä½¿ç¨åç¬å­è¿ç¨æ¥è¿è¡æä¹åï¼ä¸»è¿ç¨ä¸ä¼è¿è¡ä»»ä½ IO æä½ã\n\nç¼ºç¹ ï¼\n\n * å®¹æé ææ°æ®ä¸¢å¤±ã\n\n * æ¯æ¬¡æå¿«ç§é½è¦åå»ºå­è¿ç¨ï¼æµªè´¹èµæº.ã\n\n\n# 3. AOF\n\nè¿ç§æºå¶å¯ä»¥å°ææå®¢æ·ç«¯æ§è¡çåå½ä»¤è®°å½å°æ¥å¿æä»¶ä¸­ï¼AOF æä¹åä¼å°è¢«æ§è¡çåå½ä»¤åå° AOF æä»¶æ«å°¾ï¼ä»¥æ­¤æ¥è®°å½æ°æ®åçååçå¨è¿ç¨ï¼å æ­¤åªè¦ Redis ä»å¤´å°å°¾æ§è¡ä¸é AOF æä»¶ä¸­çå½ä»¤ï¼å°±å¯ä»¥æ¢å¤ä¹åçæ°æ®ã\n\n\n# 3.1 AOF æºå¶\n\nRDB æ¯é´éä¸æ®µæ¶é´è¿è¡æä¹åï¼å¦ææä¹åä¹é´çæ¶é´ååçæéï¼ä¼åºç°æ°æ®ä¸¢å¤±ãè AOF æä¹åæ¹å¼è½å¾å¥½çè§£å³ RDB æä¹åæ¹å¼é æçæ°æ®ä¸¢å¤±ï¼AOF æä¹åå°ç¡¬çä¸­çå¹¶ä¸æ¯åå­ä¸­çæ°æ®å¿«ç§ï¼èæ¯å°ææåå½ä»¤è®°å½å°æ¥å¿ä¸­ã\n\nAOF è½åå°æå¤ä¸¢å¤± 1s åçæ°æ®ï¼çè³ä¸ä¸¢å¤±æ°æ®ã\n\nRedis æä¾äºä¸ç§ AOF ç­ç¥ ï¼\n\n * appendfsync always\n   \n   æ¯æ§è¡ä¸æ¬¡åå½ä»¤ï¼é½å¯¹ aof æä»¶ç»­åã\n\n * appendfsync everysec\n   \n   æ¯ä¸ç§è¿è¡ä¸æ¬¡ aof æä»¶ç»­åï¼è¿ä¸ç§çåå½ä»¤é½ä¼è®°å½ã\n\n * appendfsync no\n   \n   å¹¶ä¸æ¯ä¸å¼å¯ï¼èæ¯å° aof ç»­åçæ¶æºäº¤ç»æä½ç³»ç»ç®¡çï¼æä½ç³»ç»å¼å¿äºå°±ç»­åï¼ä¸å¼å¿å°±ä¸ç»­åã\n\nè¿ä¸ç§ç­ç¥å¶å®ä¹å°±æ¯æ§å¶aofç¼å­åå¥æ¥å¿çæ¶æºç½¢äºï¼ä»ä¹ï¼aofç¼å­æ¯ä»ä¹å¢ï¼å¾ä¸ç\n\nAOFæä»¶è®°å½çå·ä½è¿ç¨ ï¼åå°å½ä»¤åå¥åå­ï¼åå°å½ä»¤åå¥æ¥å¿ã\n\n 1. å½ä»¤è¿½å  ï¼å°æ°æ§è¡çå½ä»¤è¿½å å° aofç¼å­ ä¸­\n 2. æä»¶åå¥ ï¼å° aofç¼å­ ä¸­çæ°æ®åå°aofæä»¶ä¸­ è¿ä¸æ­¥éè¦è¿è¡ç³»ç»è°ç¨ï¼çè¿æä½ç³»ç»çé½ç¥éï¼ç³»ç»è°ç¨éè¦è§¦åå½æ°ï¼æ¯å¦readãwriteï¼redisç¨çæ¯ fsync(), è¿ä¸ªå½ä»¤æä¹è§¦åï¼ å°±æ¯ä¸é¢éç½®çAOFç­ç¥ï¼alwaysãeverysecãnoã\n\næä»¥è¯´ï¼AOFçä¸ç§ç­ç¥å¶å®å°±æ¯æ§å¶æ§è¡ fsyncå½ä»¤ çæ¶æºã\n\nä¼ç¹ ï¼\n\n * ä¿è¯æ°æ®ä¸¢å¤±é£é©éå°æä½\n\nç¼ºç¹ ï¼\n\n * aof æä»¶çä½ç§¯ä¼å¾å¤§ï¼åæ¶å è½½éåº¦å¾æ¢\n\n\n# 3.2 AOF æä»¶çéå\n\néç Redis å¨çº¿ä¸è¿è¡çæ¶é´è¶æ¥è¶ä¹ï¼å®¢æ·ç«¯æ§è¡çå½ä»¤è¶æ¥è¶å¤ï¼AOF çæä»¶ä¹ä¼è¶æ¥è¶å¤§ã\n\nå½æä»¬æ§è¡ 100 æ¬¡ set name å¼ ä¸ ï¼å¶ä¸­ 99 æ¬¡é½æ¯å¤ä½çï¼å ä¸ºæ³è¦æ¢å¤åªè¦æ§è¡ä¸æ¬¡ set name å¼ ä¸ å°±è¡äºãä¸ºäºåç¼© AOF æä»¶çä½ç§¯ï¼Redis æä¾äº AOFæä»¶éåæºå¶ ã\n\næä¸¤ç§æ¹å¼è§¦å AOF çéåæºå¶ï¼\n\n * æå¨ï¼æ§è¡ bgrewrite ï¼background rewriteï¼ä¸ä¼é»å¡ Redis\n\n * èªå¨ï¼å¨éç½®æä»¶ä¸­è¿è¡éç½®\n   \n   auto-aof-rewrite-percentage 100\n   auto-aof-rewrite-min-size 64mb\n   \n   \n   å½ AOF æä»¶ä½ç§¯å¤§äº 64MBï¼æèæ¯ä¸ä¸æ¬¡éåä¹åä½ç§¯å¤§äº 100%ï¼ä¼èªå¨è§¦åã\n   \n   å¦æéåè¿äºé¢ç¹ï¼å¯ä»¥èèå° auto-aof-rewrite-percentage è®¾ç½®ä¸ºæ´å¤§ã\n\nâ\n\n> AOF éåæºå¶å¹¶æ²¡ææ ¹æ®ç°æçAOFæä»¶éåï¼èæ¯æ¯å¨éåæ¶ï¼è¯»åå½åæ°æ®åºä¸­çææé®å¼å¯¹ï¼ç¶åå°æ¯ä¸ä¸ªé®å¼å¯¹ç¨ä¸æ¡å½ä»¤è®°å½å°ãæ°ç AOF æä»¶ãï¼ç­å°å¨é¨è®°å½å®åï¼å°±å°æ°ç AOF æä»¶æ¿æ¢æç°æç AOF æä»¶ã\n\nä¸ºä»ä¹ä¸ä½¿ç¨åæç AOF æä»¶å¢?\n\nå¦æå¨åæçAOFæä»¶åºç¡ä¸éæ°ï¼ä½å¡AOFæä»¶éåè¿ç¨ä¸­å®æºæèå¤±è´¥ï¼åæçAOFæä»¶å°±è¢«æ±¡æäºï¼å¯è½æ æ³ç¨äºæ°æ®æ¢å¤ãæä»¥ä¿çåæçAOFæä»¶æ¯ä¿åºç­ç¥ã\n\néåçå·ä½è¿ç¨\n\néåä½¿ç¨å°äºåæ¶å¤å¶\n\nåæ¶å¤å¶ ï¼ç¶è¿ç¨ fork åºä¸ä¸ªå­è¿ç¨ï¼ä¸¤ä¸ªè¿ç¨å±ç¨åä¸ååå­åºåï¼äºèçèæåå­è½ç¶ä¸ç¸åï¼ä½æ¯èæåå­å¯¹åºçç©çåå­æ¯ä¸æ ·çï¼ï¼ä¸»è¿ç¨æ¯å¯ä»¥æ­£å¸¸å¤çè¯»è¯·æ±çï¼ä½æ¯å¦æåºç°åè¯·æ±ï¼ä¸æä½çæ°æ®æ¯å·²ç»å­å¨çï¼â­æä½ç³»ç»å°±ä¼å°è¿ä¸ªæ°æ®å¨ç¶è¿ç¨çç©çåå­å¤å¶ä¸ä»½äº¤ç»å­è¿ç¨ãæ³¨æï¼è¿éå¤å¶çç©çåå­æ¯ ä¿®æ¹äºåªä¸ªæ°æ®å°±åªå¤å¶è¿ä¸ªæ°æ®çç©çåå­ï¼èä¸æ¯å°ç¶è¿ç¨çææç©çåå­é½å¤å¶ä¸ä»½ã\n\nRedis è®¾ç½®äºä¸ä¸ª AOF éåç¼å²åºã å¨éå AOF æé´ï¼å½ Redis æ§è¡å®ä¸ä¸ªåå½ä»¤ä¹åï¼å®ä¼åæ¶å°è¿ä¸ªåå½ä»¤åå¥å° ãAOF ç¼å²åºãå ãAOF éåç¼å²åºãã\n\nå½å­è¿ç¨å®æAOFçéååï¼ä¼éç¥ç¶è¿ç¨ï¼ç¶è¿ç¨æä½AOF éåç¼å²åºï¼å°è¿½å çæ°æ®åå¥AOFæä»¶ï¼è¿ä¸ªæ­¥éª¤æ¯ç¶è¿ç¨è¿è¡çï¼\n\néè¦æ³¨æçæ¯ ï¼RDBå¿«ç§åAOFéåçè¿ç¨é½ç¨å°äºåæ¶å¤å¶ã\n\n\n# 4. æ··ååæä¹å\n\nå ä¸º RDB è½ç¶å è½½å¿«ä½æ¯å­å¨æ°æ®ä¸¢å¤±ï¼AOF æ°æ®å®å¨ä½æ¯å è½½ç¼æ¢ï¼Redis ä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼å¸¦æ¥äºä¸ä¸ªæ°çæä¹åéé¡¹ââæ··åæä¹åãå° RDB æä»¶çåå®¹åå¢éç AOF æ¥å¿æä»¶å­å¨ä¸èµ·ãè¿éç AOF æ¥å¿ä¸åæ¯å¨é çæ¥å¿ï¼èæ¯èªæä¹åå¼å§å°æä¹åç»æçè¿æ®µæ¶é´åççå¢é AOF æ¥å¿ï¼éå¸¸è¿é¨å AOF æ¥å¿å¾å°ãRedis éå¯çæ¶åï¼å¯ä»¥åå è½½ RDB çåå®¹ï¼ç¶ååéæ¾å¢é AOF æ¥å¿ï¼å°±å¯ä»¥å®å¨æ¿ä»£ä¹åç AOF å¨éæä»¶éæ¾ï¼æ¢å¤æçå æ­¤å¤§å¹å¾å°æåï¼æ··ååæä¹åæç»çæçæä»¶åç¼æ¯ .aof ï¼å¯ä»¥éè¿ redis.conf æä»¶ä¸­ aof-use-rdb-preamble yes éç½®å¼å¯ï¼ã\n\n * ä¼ç¹ï¼\n   \n   ç»åäº RDB å AOF çä¼ç¹ï¼ä½¿å¾æ°æ®æ¢å¤çæçå¤§å¹æå\n\n * ç¼ºç¹ï¼\n   \n   å¼å®¹æ§ä¸å¥½ï¼Redis-4.x æ°å¢ï¼è½ç¶æç»çæä»¶ä¹æ¯ .aof æ ¼å¼çæä»¶ï¼ä½å¨ 4.0 ä¹åçæ¬é½ä¸è¯å«è¯¥ aof æä»¶ï¼åæ¶ç±äºåé¨åæ¯ RDB æ ¼å¼ï¼éè¯»æ§è¾å·®ã\n\n\n# 5. æ»ç»\n\n",normalizedContent:"# redis æä¹åæºå¶\n\n\n# 1. æ¦è¿°\n\nredis ä¸ºäºä¿è¯æ§è½ï¼ä¼å°æææ°æ®æ¾å¨åå­ä¸­ï¼é£ä¹ä¸ä¸ redis å®æºï¼æ°æ®å²ä¸æ¯å¨é¨ä¸¢å¤±äºï¼\n\nä¸è¦æï¼redis èªç¶æ³å°äºè¿ä¸ç¹ï¼å®æä¾äºä¸ç§æä¹åæºå¶å°åå­ä¸­çæ°æ®æä¹åå°ç£çä¸­ã\n\n 1. rdb\n    \n    å¿«ç§æ¹å¼æä¹åï¼snapshotï¼ï¼å¿«ç§å¨ linux å°±å·²ç»å­¦è¿ï¼ä¿å­æææ°æ®çç¶æï¼ä¸æ¬¡å¼æºç´æ¥æç§è¿ä¸ªç¶ææ¢å¤ã\n    \n    å ä¸ºä¿å­çå¿«ç§æ¯ä»¥.rdb ç»å°¾çæä»¶ï¼æç§°æ­¤æ¹å¼ä¸º rdb æä¹åæ¹å¼ã\n\n 2. aof\n    \n    ï¼append only fileï¼åªè¿½å æ¥å¿æä»¶ï¼è®°å½ redis ææåå½ä»¤ï¼ä¸æ¬¡å¼æºå°è¿äºå½ä»¤å¨é¨æ§è¡ï¼å³å¯æ¢å¤æ°æ®ã\n\n 3. æ··ååæä¹å\n    \n    rdb è½ç¶å¿«ï¼ä½æ¯æ°æ®ä¸¢å¤±é®é¢è¾ä¸ºä¸¥éï¼aof è½ç¶è½ä¿è¯æ°æ®å®å¨ï¼ä½æ¯æ§è¡ææå½ä»¤éè¦å¾é¿æ¶é´ã\n    \n    æä»¥ redis4.x ä»¥åï¼å°ä¸¤ç§æ¹å¼ç»åï¼rdb æä»¶çåå®¹æ¾å¨ aof æä»¶ä¸­ï¼ä»¥.aof æä»¶çå½¢å¼å­å¨ãå¨æ¢å¤æ°æ®æ¶ï¼åå è½½ rdb çåå®¹ï¼åæ§è¡ aof çåå®¹ãç¼ºç¹æ¯ä¸¤ç§æ ¼å¼æ··åå¨ä¸èµ·é¾ä»¥éè¯»ã\n\n==éè¦æ³¨æçæ¯ï¼ä¸è®ºæ¯åªç§æ¹å¼ï¼é½æ æ³ä¿è¯æ°æ®çç»å¯¹å®å¨ã==\n\n\n# 2. rdb\n\nsnapshot æ³å¿å¤§å®¶å·²ç»ä¸éçäºï¼linux å·²ç»æ¥è§¦è¿è¿ä¸ªæºå¶ï¼==ä¿å­ç°å¨çç¶æï¼éæ¶åå¤æ¢å¤ã==\n\nææçå¿«ç§ä»¥**.rdb** çå½¢å¼ä¿å­å¨ç£çä¸­ã\n\nåå¦å¨ redis å®æºä¹åææçå¿«ç§ä¸ºï¼\n\n\n\né£ä¹ä¸æ¬¡å¼æºå°±å¯ä»¥å³å°è¿ä¸¤ä¸ªæ°æ®æ¢å¤ã\n\nredis æä¾äºä¸¤ç§ææå¿«ç§çæ¹å¼ ï¼èªå¨ãæå¨ãå¶ä¸­æå¨ææå¿«ç§æä¸¤ä¸ªå½ä»¤ï¼saveãbgsave\n\n\n\n\n# 2.1 æå¨å¿«ç§\n\n 1. save\n    \n    ç±ä¸»è¿ç¨å®æå¿«ç§çææï¼æä¹åè¿ç¨ä¸­å¶ä»å½ä»¤é»å¡ã\n    \n    \n\n 2. bgsave\n    \n    background saveï¼ä¸»çº¿ç¨ fork åºä¸ä¸ªå­è¿ç¨ï¼ç±è¿ä¸ªå­è¿ç¨å®ææä¹åã\n    \n    \n\n> fork ï¼\n> \n> å½ä¸ä¸ªè¿ç¨åå»ºå­è¿ç¨æ¶ï¼åºå±çæä½ç³»ç»ä¼åå»ºè¯¥è¿ç¨çå¯æ¬ï¼å¨ç±» unix ç³»ç»ä¸­åå»ºå­è¿ç¨çæä½ä¼è¿è¡ä¼åï¼å¨åå¼å§çæ¶åï¼ç¶å­è¿ç¨å±äº«ç¸ååå­ï¼ç´å°ç¶è¿ç¨/å­è¿ç¨å¯¹åå­è¿è¡åæä½åç»æå±äº«ï¼åç¨åçã\n\n\n# 2.2 èªå¨å¿«ç§\n\nå¨ redis.conf éç½®æä»¶ä¸­å­å¨ï¼åæ°å¦ä¸:ï¼çæ¬ä¸åï¼é»è®¤åæ°ä¸åï¼\n\n#   * after 3600 seconds (an hour) if at least 1 key changed\n#   * after 300 seconds (5 minutes) if at least 100 keys changed\n#   * after 60 seconds if at least 10000 keys changed\n\n# save 3600 1\n# save 300 100\n# save 60 10000\n\n\nè§£é ï¼\n\n1h åæä¸ä¸ªé®è¢«æ¹åä¼è§¦åå¿«ç§ææã\n\n5mins åæ 100 ä¸ªé®è¢«æ¹åä¼è§¦åå¿«ç§ææã\n\n1min åæ 10000 ä¸ªé®è¢«æ¹åä¼è§¦åå¿«ç§ææã\n\nè¿äºå¿«ç§çæææ¹å¼é½æ¯ bgsaveã\n\nä¼ç¹ ï¼\n\n * rdb æä»¶çå è½½éåº¦ç¹å«å¿«ï¼è¿è¶ aofã\n\n * ä½¿ç¨åç¬å­è¿ç¨æ¥è¿è¡æä¹åï¼ä¸»è¿ç¨ä¸ä¼è¿è¡ä»»ä½ io æä½ã\n\nç¼ºç¹ ï¼\n\n * å®¹æé ææ°æ®ä¸¢å¤±ã\n\n * æ¯æ¬¡æå¿«ç§é½è¦åå»ºå­è¿ç¨ï¼æµªè´¹èµæº.ã\n\n\n# 3. aof\n\nè¿ç§æºå¶å¯ä»¥å°ææå®¢æ·ç«¯æ§è¡çåå½ä»¤è®°å½å°æ¥å¿æä»¶ä¸­ï¼aof æä¹åä¼å°è¢«æ§è¡çåå½ä»¤åå° aof æä»¶æ«å°¾ï¼ä»¥æ­¤æ¥è®°å½æ°æ®åçååçå¨è¿ç¨ï¼å æ­¤åªè¦ redis ä»å¤´å°å°¾æ§è¡ä¸é aof æä»¶ä¸­çå½ä»¤ï¼å°±å¯ä»¥æ¢å¤ä¹åçæ°æ®ã\n\n\n# 3.1 aof æºå¶\n\nrdb æ¯é´éä¸æ®µæ¶é´è¿è¡æä¹åï¼å¦ææä¹åä¹é´çæ¶é´ååçæéï¼ä¼åºç°æ°æ®ä¸¢å¤±ãè aof æä¹åæ¹å¼è½å¾å¥½çè§£å³ rdb æä¹åæ¹å¼é æçæ°æ®ä¸¢å¤±ï¼aof æä¹åå°ç¡¬çä¸­çå¹¶ä¸æ¯åå­ä¸­çæ°æ®å¿«ç§ï¼èæ¯å°ææåå½ä»¤è®°å½å°æ¥å¿ä¸­ã\n\naof è½åå°æå¤ä¸¢å¤± 1s åçæ°æ®ï¼çè³ä¸ä¸¢å¤±æ°æ®ã\n\nredis æä¾äºä¸ç§ aof ç­ç¥ ï¼\n\n * appendfsync always\n   \n   æ¯æ§è¡ä¸æ¬¡åå½ä»¤ï¼é½å¯¹ aof æä»¶ç»­åã\n\n * appendfsync everysec\n   \n   æ¯ä¸ç§è¿è¡ä¸æ¬¡ aof æä»¶ç»­åï¼è¿ä¸ç§çåå½ä»¤é½ä¼è®°å½ã\n\n * appendfsync no\n   \n   å¹¶ä¸æ¯ä¸å¼å¯ï¼èæ¯å° aof ç»­åçæ¶æºäº¤ç»æä½ç³»ç»ç®¡çï¼æä½ç³»ç»å¼å¿äºå°±ç»­åï¼ä¸å¼å¿å°±ä¸ç»­åã\n\nè¿ä¸ç§ç­ç¥å¶å®ä¹å°±æ¯æ§å¶aofç¼å­åå¥æ¥å¿çæ¶æºç½¢äºï¼ä»ä¹ï¼aofç¼å­æ¯ä»ä¹å¢ï¼å¾ä¸ç\n\naofæä»¶è®°å½çå·ä½è¿ç¨ ï¼åå°å½ä»¤åå¥åå­ï¼åå°å½ä»¤åå¥æ¥å¿ã\n\n 1. å½ä»¤è¿½å  ï¼å°æ°æ§è¡çå½ä»¤è¿½å å° aofç¼å­ ä¸­\n 2. æä»¶åå¥ ï¼å° aofç¼å­ ä¸­çæ°æ®åå°aofæä»¶ä¸­ è¿ä¸æ­¥éè¦è¿è¡ç³»ç»è°ç¨ï¼çè¿æä½ç³»ç»çé½ç¥éï¼ç³»ç»è°ç¨éè¦è§¦åå½æ°ï¼æ¯å¦readãwriteï¼redisç¨çæ¯ fsync(), è¿ä¸ªå½ä»¤æä¹è§¦åï¼ å°±æ¯ä¸é¢éç½®çaofç­ç¥ï¼alwaysãeverysecãnoã\n\næä»¥è¯´ï¼aofçä¸ç§ç­ç¥å¶å®å°±æ¯æ§å¶æ§è¡ fsyncå½ä»¤ çæ¶æºã\n\nä¼ç¹ ï¼\n\n * ä¿è¯æ°æ®ä¸¢å¤±é£é©éå°æä½\n\nç¼ºç¹ ï¼\n\n * aof æä»¶çä½ç§¯ä¼å¾å¤§ï¼åæ¶å è½½éåº¦å¾æ¢\n\n\n# 3.2 aof æä»¶çéå\n\néç redis å¨çº¿ä¸è¿è¡çæ¶é´è¶æ¥è¶ä¹ï¼å®¢æ·ç«¯æ§è¡çå½ä»¤è¶æ¥è¶å¤ï¼aof çæä»¶ä¹ä¼è¶æ¥è¶å¤§ã\n\nå½æä»¬æ§è¡ 100 æ¬¡ set name å¼ ä¸ ï¼å¶ä¸­ 99 æ¬¡é½æ¯å¤ä½çï¼å ä¸ºæ³è¦æ¢å¤åªè¦æ§è¡ä¸æ¬¡ set name å¼ ä¸ å°±è¡äºãä¸ºäºåç¼© aof æä»¶çä½ç§¯ï¼redis æä¾äº aofæä»¶éåæºå¶ ã\n\næä¸¤ç§æ¹å¼è§¦å aof çéåæºå¶ï¼\n\n * æå¨ï¼æ§è¡ bgrewrite ï¼background rewriteï¼ä¸ä¼é»å¡ redis\n\n * èªå¨ï¼å¨éç½®æä»¶ä¸­è¿è¡éç½®\n   \n   auto-aof-rewrite-percentage 100\n   auto-aof-rewrite-min-size 64mb\n   \n   \n   å½ aof æä»¶ä½ç§¯å¤§äº 64mbï¼æèæ¯ä¸ä¸æ¬¡éåä¹åä½ç§¯å¤§äº 100%ï¼ä¼èªå¨è§¦åã\n   \n   å¦æéåè¿äºé¢ç¹ï¼å¯ä»¥èèå° auto-aof-rewrite-percentage è®¾ç½®ä¸ºæ´å¤§ã\n\nâ\n\n> aof éåæºå¶å¹¶æ²¡ææ ¹æ®ç°æçaofæä»¶éåï¼èæ¯æ¯å¨éåæ¶ï¼è¯»åå½åæ°æ®åºä¸­çææé®å¼å¯¹ï¼ç¶åå°æ¯ä¸ä¸ªé®å¼å¯¹ç¨ä¸æ¡å½ä»¤è®°å½å°ãæ°ç aof æä»¶ãï¼ç­å°å¨é¨è®°å½å®åï¼å°±å°æ°ç aof æä»¶æ¿æ¢æç°æç aof æä»¶ã\n\nä¸ºä»ä¹ä¸ä½¿ç¨åæç aof æä»¶å¢?\n\nå¦æå¨åæçaofæä»¶åºç¡ä¸éæ°ï¼ä½å¡aofæä»¶éåè¿ç¨ä¸­å®æºæèå¤±è´¥ï¼åæçaofæä»¶å°±è¢«æ±¡æäºï¼å¯è½æ æ³ç¨äºæ°æ®æ¢å¤ãæä»¥ä¿çåæçaofæä»¶æ¯ä¿åºç­ç¥ã\n\néåçå·ä½è¿ç¨\n\néåä½¿ç¨å°äºåæ¶å¤å¶\n\nåæ¶å¤å¶ ï¼ç¶è¿ç¨ fork åºä¸ä¸ªå­è¿ç¨ï¼ä¸¤ä¸ªè¿ç¨å±ç¨åä¸ååå­åºåï¼äºèçèæåå­è½ç¶ä¸ç¸åï¼ä½æ¯èæåå­å¯¹åºçç©çåå­æ¯ä¸æ ·çï¼ï¼ä¸»è¿ç¨æ¯å¯ä»¥æ­£å¸¸å¤çè¯»è¯·æ±çï¼ä½æ¯å¦æåºç°åè¯·æ±ï¼ä¸æä½çæ°æ®æ¯å·²ç»å­å¨çï¼â­æä½ç³»ç»å°±ä¼å°è¿ä¸ªæ°æ®å¨ç¶è¿ç¨çç©çåå­å¤å¶ä¸ä»½äº¤ç»å­è¿ç¨ãæ³¨æï¼è¿éå¤å¶çç©çåå­æ¯ ä¿®æ¹äºåªä¸ªæ°æ®å°±åªå¤å¶è¿ä¸ªæ°æ®çç©çåå­ï¼èä¸æ¯å°ç¶è¿ç¨çææç©çåå­é½å¤å¶ä¸ä»½ã\n\nredis è®¾ç½®äºä¸ä¸ª aof éåç¼å²åºã å¨éå aof æé´ï¼å½ redis æ§è¡å®ä¸ä¸ªåå½ä»¤ä¹åï¼å®ä¼åæ¶å°è¿ä¸ªåå½ä»¤åå¥å° ãaof ç¼å²åºãå ãaof éåç¼å²åºãã\n\nå½å­è¿ç¨å®æaofçéååï¼ä¼éç¥ç¶è¿ç¨ï¼ç¶è¿ç¨æä½aof éåç¼å²åºï¼å°è¿½å çæ°æ®åå¥aofæä»¶ï¼è¿ä¸ªæ­¥éª¤æ¯ç¶è¿ç¨è¿è¡çï¼\n\néè¦æ³¨æçæ¯ ï¼rdbå¿«ç§åaoféåçè¿ç¨é½ç¨å°äºåæ¶å¤å¶ã\n\n\n# 4. æ··ååæä¹å\n\nå ä¸º rdb è½ç¶å è½½å¿«ä½æ¯å­å¨æ°æ®ä¸¢å¤±ï¼aof æ°æ®å®å¨ä½æ¯å è½½ç¼æ¢ï¼redis ä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼å¸¦æ¥äºä¸ä¸ªæ°çæä¹åéé¡¹ââæ··åæä¹åãå° rdb æä»¶çåå®¹åå¢éç aof æ¥å¿æä»¶å­å¨ä¸èµ·ãè¿éç aof æ¥å¿ä¸åæ¯å¨é çæ¥å¿ï¼èæ¯èªæä¹åå¼å§å°æä¹åç»æçè¿æ®µæ¶é´åççå¢é aof æ¥å¿ï¼éå¸¸è¿é¨å aof æ¥å¿å¾å°ãredis éå¯çæ¶åï¼å¯ä»¥åå è½½ rdb çåå®¹ï¼ç¶ååéæ¾å¢é aof æ¥å¿ï¼å°±å¯ä»¥å®å¨æ¿ä»£ä¹åç aof å¨éæä»¶éæ¾ï¼æ¢å¤æçå æ­¤å¤§å¹å¾å°æåï¼æ··ååæä¹åæç»çæçæä»¶åç¼æ¯ .aof ï¼å¯ä»¥éè¿ redis.conf æä»¶ä¸­ aof-use-rdb-preamble yes éç½®å¼å¯ï¼ã\n\n * ä¼ç¹ï¼\n   \n   ç»åäº rdb å aof çä¼ç¹ï¼ä½¿å¾æ°æ®æ¢å¤çæçå¤§å¹æå\n\n * ç¼ºç¹ï¼\n   \n   å¼å®¹æ§ä¸å¥½ï¼redis-4.x æ°å¢ï¼è½ç¶æç»çæä»¶ä¹æ¯ .aof æ ¼å¼çæä»¶ï¼ä½å¨ 4.0 ä¹åçæ¬é½ä¸è¯å«è¯¥ aof æä»¶ï¼åæ¶ç±äºåé¨åæ¯ rdb æ ¼å¼ï¼éè¯»æ§è¾å·®ã\n\n\n# 5. æ»ç»\n\n",charsets:{cjk:!0},lastUpdated:"2023/10/31, 23:05:02",lastUpdatedTimestamp:1698764702e3},{title:"InnoDB - é",frontmatter:{title:"InnoDB - é",date:"2023-06-08T21:47:16.000Z",permalink:"/pages/2e3013/"},regularPath:"/02.%E6%96%87%E7%AB%A0/02.MySQL/20.InnoDB%20-%20%E9%94%81.html",relativePath:"02.æç« /02.MySQL/20.InnoDB - é.md",key:"v-1dab0d7c",path:"/pages/2e3013/",headers:[{level:2,title:"1. éçæ¦å¿µ",slug:"_1-éçæ¦å¿µ",normalizedTitle:"1. éçæ¦å¿µ",charIndex:12},{level:2,title:"2. éçåç±»",slug:"_2-éçåç±»",normalizedTitle:"2. éçåç±»",charIndex:73},{level:3,title:"2.1 å±äº«é",slug:"_2-1-å±äº«é",normalizedTitle:"2.1 å±äº«é",charIndex:149},{level:3,title:"2.2 æä»é",slug:"_2-2-æä»é",normalizedTitle:"2.2 æä»é",charIndex:355},{level:3,title:"2.3 å¨å±é",slug:"_2-3-å¨å±é",normalizedTitle:"2.3 å¨å±é",charIndex:587},{level:3,title:"2.4 è¡¨çº§é",slug:"_2-4-è¡¨çº§é",normalizedTitle:"2.4 è¡¨çº§é",charIndex:710},{level:3,title:"2.5 è¡çº§é",slug:"_2-5-è¡çº§é",normalizedTitle:"2.5 è¡çº§é",charIndex:1108},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:1415}],headersStr:"1. éçæ¦å¿µ 2. éçåç±» 2.1 å±äº«é 2.2 æä»é 2.3 å¨å±é 2.4 è¡¨çº§é 2.5 è¡çº§é 3. æ»ç»",content:"# 12. é\n\n\n# 1. éçæ¦å¿µ\n\néæºå¶æ¯==æ°æ®åºä¸ºäºä¿è¯æ°æ®çä¸è´æ§ï¼å¨ä½¿ç¨å±äº«èµæºæ¶å¹¶åè®¿é®åå¾æåºæè®¾è®¡çä¸ç§è§åã==\n\n\n# 2. éçåç±»\n\nå¨MySQLä¸­å¯ä»¥æç§åè½ä¸èå´åç±» ï¼\n\næç§åè½åç±» ï¼å±äº«éãæä»éã\n\næç§èå´åç±» ï¼å¨å±éãè¡¨çº§éãè¡çº§éã\n\n\n\n\n# 2.1 å±äº«é\n\nå±äº«éåç§°è¯»é (shared lock)ï¼å³å±äº«è¯»ã\n\nè¯»åæä½åå»ºçéãå¶ä»ç¨æ·å¯ä»¥å¹¶åè¯»åæ°æ®ï¼ä½ä»»ä½äºå¡é½ä¸è½å¯¹æ°æ®è¿è¡ä¿®æ¹ï¼è·åæ°æ®ä¸çæä»éï¼ï¼ç´å°å·²éæ¾ææå±äº«éãå½å¦æäºå¡å¯¹è¯»éè¿è¡ä¿®æ¹æä½ï¼å¾å¯è½ä¼é ææ­»éã\n\n> å¦æäºå¡Aç»æ°æ®å äºå±äº«è¯»é ï¼\n> \n> äºå¡Aè½è¯»ï¼ä¸è½åã\n> \n> äºå¡Bè½è¯»ï¼ä¸è½åã\n> \n> å³ ï¼å±äº«æ°æ®çè¯»æéï¼å³é­æ°æ®çåæéã\n\n\n# 2.2 æä»é\n\næä»éåç§°åéï¼exclusive lockï¼ï¼å³ç¬å åã\nè¥æä¸ªäºç©å¯¹æä¸è¡å ä¸äºæä»éï¼åªè½è¿ä¸ªäºå¡å¯¹å¶è¿è¡è¯»åï¼å¨æ­¤äºå¡ç»æä¹åï¼å¶ä»äºå¡ä¸è½å¯¹å¶è¿è¡å ä»»ä½éï¼å¶ä»è¿ç¨å¯ä»¥è¯»å,ä¸è½è¿è¡åæä½ï¼éç­å¾å¶éæ¾ã æå®éæ¯æ²è§éçä¸ç§å®ç°ï¼å¨ä¸é¢æ²è§éä¹ä»ç»è¿ã\n\n> å¦æäºå¡Aç»æ°æ®å äºæä»é ï¼\n> \n> äºå¡Aå¯ä»¥è¯»ï¼å¯ä»¥åã\n> \n> äºå¡Bä¸è½è¯»ï¼ä¸è½åã\n> \n> å³ ï¼ç¬å æ°æ®è¯»åæä½çæéãææ¥å¶ä»äºå¡çè¯»åæä½ã\n\n\n# 2.3 å¨å±é\n\nå¨å±éå°±æ¯å¯¹æ´ä¸ªæ°æ®åºå®ä¾å éï¼å éåæ´ä¸ªå®ä¾å¤äºåªè¯»ç¶æï¼åç»­çå¢å æ¹ãä¿®æ¹è¡¨è¿äºæä½çäºå¡æäº¤é½ä¼è¢«é»å¡ã\n\n-- å¨å±éï¼æ´ä¸ªæ°æ®åºçææè¡¨é½å ä¸éã\nflush tables with read locks;\n\n\n\n# 2.4 è¡¨çº§é\n\nè¡¨çº§éå°±æ¯éä½æå¼ è¡¨ãåä¸º è¡¨éãåæ°æ®éãæåéã\n\n 1. è¡¨é\n    \n    è¡¨éåä¸ºè¯»éååéï¼éµå¾ªä¸è¿° å±äº«è¯»ï¼ç¬å åã\n\n 2. åæ°æ®é\n    \n    ç»´æ¤è¡¨ç»æçæ°æ®ä¸è´æ§ãå¨è®¿é®ä¸å¼ è¡¨æ¶ä¼èªå¨å åæ°æ®éï¼å¦ææä¸å¼ è¡¨å­å¨æªæäº¤çäºå¡ï¼é£ä¹å°±ä¸è½ä¿®æ¹è¡¨çç»æã\n\n 3. æåé\n    \n    å¦ææå¼ è¡¨çæä¸è¡å äºè¡éï¼è¿ä¸ªè¡¨æ¯ä¸è½å è¡¨éçï¼ä½æ¯å¦ä½å¤æ­å¢ï¼éåæ´å¼ è¡¨æ¥çæ¯å¦æè¡éï¼å¤ªéº»ç¦ã\n    \n    æåéå­å¨äºè¡¨ä¸­ï¼å¨å è¡¨éä¹åæ¥çè¿å¼ è¡¨æ¯å¦ææåéï¼å¦æææåéï¼ä»£è¡¨è¿å¼ è¡¨æäºå­æ®µå äºè¡éï¼å°±ä¸è½å è¡¨éäºã\n    \n    > æåå±äº«é ä¸ è¡¨å±äº«é å¼å®¹ï¼ä¸è¡¨æä»éäºæ¥ã\n    > \n    > æåæä»é ä¸ è¡¨å±äº«ãè¡¨æä»é½äºæ¥ã\n    > \n    > å³ ï¼å±äº«éä¸å±äº«éå¼å®¹ï¼æä»éä¸ä»»ä½éé½äºæ¥ã\n\n\n# 2.5 è¡çº§é\n\néä½å¯¹åºçè¡ãåºç¨å¨Innodbå¼æä¸­ï¼MyISAMä¸æ¯æãï¼InnoDBä¸MyISAMçä¸å¤§åºå«ä¹ä¸ï¼ã\n\nInnoDBçæ°æ®æ¯åºäºç´¢å¼ç»ç»çï¼è¡éæ¯éè¿å¯¹ç´¢å¼ä¸çç´¢å¼é¡¹å éæ¥å®ç°çï¼èä¸æ¯å¯¹è®°å½å éãè¡ééçæ¯ç´¢å¼é¡¹ã\n\nä¸»è¦åä¸º ï¼è¡éãé´ééãä¸´é®é\n\n 1. è¡é\n    \n    éå®åè¡è®°å½ï¼é²æ­¢å¶ä»äºå¡å¯¹æ­¤è¿è¡updateãdeleteæä½ã\n\n 2. é´éé\n    \n    éå®ç´¢å¼è®°å½é´éï¼ä¸åå«è¯¥è®°å½ï¼ï¼ç¡®ä¿ç´¢å¼è®°å½é´éä¸åï¼é²æ­¢å¶ä»äºå¡å¨é´éä¸­æå¥æ°æ®ã\n\n 3. ä¸´é®é\n    \n    ä¸´é®éæ¯è¡éåé´ééçç»åï¼åæ¶éä½ç´¢å¼è®°å½ä»¥åè®°å½åé¢çé´éã\n\n\n# 3. æ»ç»\n\nå¨æ¬ç¯ä¸­å°±å¯¹MySQL çéæºå¶æäºå¤§æ¦è®¤ç¥ï¼ä»éçæ¦å¿µãåç±»ï¼å°å±äº«éãæä»éãå¨å±éãè¡¨çº§éãè¡çº§éçä»ç»ï¼ç¸ä¿¡æ¬ç« çä¸æ¥ï¼è¶³å¤è®©ä½ å¯¹MySQL éæºå¶æä¸ä¸ªç³»ç»åçè®¤ç¥ï¼é£ä¹æä»¬ä¸ç¯åè§ã",normalizedContent:"# 12. é\n\n\n# 1. éçæ¦å¿µ\n\néæºå¶æ¯==æ°æ®åºä¸ºäºä¿è¯æ°æ®çä¸è´æ§ï¼å¨ä½¿ç¨å±äº«èµæºæ¶å¹¶åè®¿é®åå¾æåºæè®¾è®¡çä¸ç§è§åã==\n\n\n# 2. éçåç±»\n\nå¨mysqlä¸­å¯ä»¥æç§åè½ä¸èå´åç±» ï¼\n\næç§åè½åç±» ï¼å±äº«éãæä»éã\n\næç§èå´åç±» ï¼å¨å±éãè¡¨çº§éãè¡çº§éã\n\n\n\n\n# 2.1 å±äº«é\n\nå±äº«éåç§°è¯»é (shared lock)ï¼å³å±äº«è¯»ã\n\nè¯»åæä½åå»ºçéãå¶ä»ç¨æ·å¯ä»¥å¹¶åè¯»åæ°æ®ï¼ä½ä»»ä½äºå¡é½ä¸è½å¯¹æ°æ®è¿è¡ä¿®æ¹ï¼è·åæ°æ®ä¸çæä»éï¼ï¼ç´å°å·²éæ¾ææå±äº«éãå½å¦æäºå¡å¯¹è¯»éè¿è¡ä¿®æ¹æä½ï¼å¾å¯è½ä¼é ææ­»éã\n\n> å¦æäºå¡aç»æ°æ®å äºå±äº«è¯»é ï¼\n> \n> äºå¡aè½è¯»ï¼ä¸è½åã\n> \n> äºå¡bè½è¯»ï¼ä¸è½åã\n> \n> å³ ï¼å±äº«æ°æ®çè¯»æéï¼å³é­æ°æ®çåæéã\n\n\n# 2.2 æä»é\n\næä»éåç§°åéï¼exclusive lockï¼ï¼å³ç¬å åã\nè¥æä¸ªäºç©å¯¹æä¸è¡å ä¸äºæä»éï¼åªè½è¿ä¸ªäºå¡å¯¹å¶è¿è¡è¯»åï¼å¨æ­¤äºå¡ç»æä¹åï¼å¶ä»äºå¡ä¸è½å¯¹å¶è¿è¡å ä»»ä½éï¼å¶ä»è¿ç¨å¯ä»¥è¯»å,ä¸è½è¿è¡åæä½ï¼éç­å¾å¶éæ¾ã æå®éæ¯æ²è§éçä¸ç§å®ç°ï¼å¨ä¸é¢æ²è§éä¹ä»ç»è¿ã\n\n> å¦æäºå¡aç»æ°æ®å äºæä»é ï¼\n> \n> äºå¡aå¯ä»¥è¯»ï¼å¯ä»¥åã\n> \n> äºå¡bä¸è½è¯»ï¼ä¸è½åã\n> \n> å³ ï¼ç¬å æ°æ®è¯»åæä½çæéãææ¥å¶ä»äºå¡çè¯»åæä½ã\n\n\n# 2.3 å¨å±é\n\nå¨å±éå°±æ¯å¯¹æ´ä¸ªæ°æ®åºå®ä¾å éï¼å éåæ´ä¸ªå®ä¾å¤äºåªè¯»ç¶æï¼åç»­çå¢å æ¹ãä¿®æ¹è¡¨è¿äºæä½çäºå¡æäº¤é½ä¼è¢«é»å¡ã\n\n-- å¨å±éï¼æ´ä¸ªæ°æ®åºçææè¡¨é½å ä¸éã\nflush tables with read locks;\n\n\n\n# 2.4 è¡¨çº§é\n\nè¡¨çº§éå°±æ¯éä½æå¼ è¡¨ãåä¸º è¡¨éãåæ°æ®éãæåéã\n\n 1. è¡¨é\n    \n    è¡¨éåä¸ºè¯»éååéï¼éµå¾ªä¸è¿° å±äº«è¯»ï¼ç¬å åã\n\n 2. åæ°æ®é\n    \n    ç»´æ¤è¡¨ç»æçæ°æ®ä¸è´æ§ãå¨è®¿é®ä¸å¼ è¡¨æ¶ä¼èªå¨å åæ°æ®éï¼å¦ææä¸å¼ è¡¨å­å¨æªæäº¤çäºå¡ï¼é£ä¹å°±ä¸è½ä¿®æ¹è¡¨çç»æã\n\n 3. æåé\n    \n    å¦ææå¼ è¡¨çæä¸è¡å äºè¡éï¼è¿ä¸ªè¡¨æ¯ä¸è½å è¡¨éçï¼ä½æ¯å¦ä½å¤æ­å¢ï¼éåæ´å¼ è¡¨æ¥çæ¯å¦æè¡éï¼å¤ªéº»ç¦ã\n    \n    æåéå­å¨äºè¡¨ä¸­ï¼å¨å è¡¨éä¹åæ¥çè¿å¼ è¡¨æ¯å¦ææåéï¼å¦æææåéï¼ä»£è¡¨è¿å¼ è¡¨æäºå­æ®µå äºè¡éï¼å°±ä¸è½å è¡¨éäºã\n    \n    > æåå±äº«é ä¸ è¡¨å±äº«é å¼å®¹ï¼ä¸è¡¨æä»éäºæ¥ã\n    > \n    > æåæä»é ä¸ è¡¨å±äº«ãè¡¨æä»é½äºæ¥ã\n    > \n    > å³ ï¼å±äº«éä¸å±äº«éå¼å®¹ï¼æä»éä¸ä»»ä½éé½äºæ¥ã\n\n\n# 2.5 è¡çº§é\n\néä½å¯¹åºçè¡ãåºç¨å¨innodbå¼æä¸­ï¼myisamä¸æ¯æãï¼innodbä¸myisamçä¸å¤§åºå«ä¹ä¸ï¼ã\n\ninnodbçæ°æ®æ¯åºäºç´¢å¼ç»ç»çï¼è¡éæ¯éè¿å¯¹ç´¢å¼ä¸çç´¢å¼é¡¹å éæ¥å®ç°çï¼èä¸æ¯å¯¹è®°å½å éãè¡ééçæ¯ç´¢å¼é¡¹ã\n\nä¸»è¦åä¸º ï¼è¡éãé´ééãä¸´é®é\n\n 1. è¡é\n    \n    éå®åè¡è®°å½ï¼é²æ­¢å¶ä»äºå¡å¯¹æ­¤è¿è¡updateãdeleteæä½ã\n\n 2. é´éé\n    \n    éå®ç´¢å¼è®°å½é´éï¼ä¸åå«è¯¥è®°å½ï¼ï¼ç¡®ä¿ç´¢å¼è®°å½é´éä¸åï¼é²æ­¢å¶ä»äºå¡å¨é´éä¸­æå¥æ°æ®ã\n\n 3. ä¸´é®é\n    \n    ä¸´é®éæ¯è¡éåé´ééçç»åï¼åæ¶éä½ç´¢å¼è®°å½ä»¥åè®°å½åé¢çé´éã\n\n\n# 3. æ»ç»\n\nå¨æ¬ç¯ä¸­å°±å¯¹mysql çéæºå¶æäºå¤§æ¦è®¤ç¥ï¼ä»éçæ¦å¿µãåç±»ï¼å°å±äº«éãæä»éãå¨å±éãè¡¨çº§éãè¡çº§éçä»ç»ï¼ç¸ä¿¡æ¬ç« çä¸æ¥ï¼è¶³å¤è®©ä½ å¯¹mysql éæºå¶æä¸ä¸ªç³»ç»åçè®¤ç¥ï¼é£ä¹æä»¬ä¸ç¯åè§ã",charsets:{cjk:!0},lastUpdated:"2023/06/08, 21:54:53",lastUpdatedTimestamp:1686232493e3},{title:"InnoDB - B+æ ç´¢å¼",frontmatter:{title:"InnoDB - B+æ ç´¢å¼",date:"2023-06-08T21:47:16.000Z",permalink:"/pages/26e2d2/"},regularPath:"/02.%E6%96%87%E7%AB%A0/02.MySQL/10.InnoDB%20-%20B+%E6%A0%91%E7%B4%A2%E5%BC%95.html",relativePath:"02.æç« /02.MySQL/10.InnoDB - B+æ ç´¢å¼.md",key:"v-4a5e1071",path:"/pages/26e2d2/",headers:[{level:2,title:"1. æ²¡æç´¢å¼çæ¥æ¾",slug:"_1-æ²¡æç´¢å¼çæ¥æ¾",normalizedTitle:"1. æ²¡æç´¢å¼çæ¥æ¾",charIndex:58},{level:3,title:"1.1 å¨ä¸é¡µä¸­æ¥æ¾",slug:"_1-1-å¨ä¸é¡µä¸­æ¥æ¾",normalizedTitle:"1.1 å¨ä¸é¡µä¸­æ¥æ¾",charIndex:73},{level:3,title:"1.2 å¨å¾å¤é¡µä¸­æ¥æ¾",slug:"_1-2-å¨å¾å¤é¡µä¸­æ¥æ¾",normalizedTitle:"1.2 å¨å¾å¤é¡µä¸­æ¥æ¾",charIndex:345},{level:2,title:"2. ç´¢å¼",slug:"_2-ç´¢å¼",normalizedTitle:"2. ç´¢å¼",charIndex:545},{level:3,title:"2.1 ä¸ä¸ªç®åçç´¢å¼æ¹æ¡",slug:"_2-1-ä¸ä¸ªç®åçç´¢å¼æ¹æ¡",normalizedTitle:"2.1 ä¸ä¸ªç®åçç´¢å¼æ¹æ¡",charIndex:936},{level:3,title:"2.2 InnoDBçç´¢å¼æ¹æ¡",slug:"_2-2-innodbçç´¢å¼æ¹æ¡",normalizedTitle:"2.2 innodbçç´¢å¼æ¹æ¡",charIndex:2035},{level:3,title:"2.3 èç°ç´¢å¼",slug:"_2-3-èç°ç´¢å¼",normalizedTitle:"2.3 èç°ç´¢å¼",charIndex:3305},{level:3,title:"2.4 äºçº§ç´¢å¼",slug:"_2-4-äºçº§ç´¢å¼",normalizedTitle:"2.4 äºçº§ç´¢å¼",charIndex:3447},{level:2,title:"3. åè¡¨",slug:"_3-åè¡¨",normalizedTitle:"3. åè¡¨",charIndex:3752},{level:3,title:"3.1 åè¡¨çä»£ä»·",slug:"_3-1-åè¡¨çä»£ä»·",normalizedTitle:"3.1 åè¡¨çä»£ä»·",charIndex:3762},{level:3,title:"3.2 è¦çç´¢å¼",slug:"_3-2-è¦çç´¢å¼",normalizedTitle:"3.2 è¦çç´¢å¼",charIndex:4649},{level:2,title:"4. B+æ ç´¢å¼çä½¿ç¨",slug:"_4-b-æ ç´¢å¼çä½¿ç¨",normalizedTitle:"4. b+æ ç´¢å¼çä½¿ç¨",charIndex:4824},{level:3,title:"4.1 ç´¢å¼çä»£ä»·",slug:"_4-1-ç´¢å¼çä»£ä»·",normalizedTitle:"4.1 ç´¢å¼çä»£ä»·",charIndex:4969},{level:3,title:"4.2 ç´¢å¼å¤±æçåºæ¯",slug:"_4-2-ç´¢å¼å¤±æçåºæ¯",normalizedTitle:"4.2 ç´¢å¼å¤±æçåºæ¯",charIndex:5256},{level:4,title:"4.2.1 æå·¦åç¼å¹é",slug:"_4-2-1-æå·¦åç¼å¹é",normalizedTitle:"4.2.1 æå·¦åç¼å¹é",charIndex:5896},{level:4,title:"4.2.2 æ¨¡ç³æ¥è¯¢",slug:"_4-2-2-æ¨¡ç³æ¥è¯¢",normalizedTitle:"4.2.2 æ¨¡ç³æ¥è¯¢",charIndex:6901},{level:4,title:"4.2.4 è¿ç®ä¸å½æ°",slug:"_4-2-4-è¿ç®ä¸å½æ°",normalizedTitle:"4.2.4 è¿ç®ä¸å½æ°",charIndex:7423},{level:4,title:"4.2.5 or",slug:"_4-2-5-or",normalizedTitle:"4.2.5 or",charIndex:7552},{level:2,title:"5. å¦ä½æéç´¢å¼",slug:"_5-å¦ä½æéç´¢å¼",normalizedTitle:"5. å¦ä½æéç´¢å¼",charIndex:7644},{level:3,title:"5.1 å¸¸ç¨äºæç´¢ãæåºãåç»çå",slug:"_5-1-å¸¸ç¨äºæç´¢ãæåºãåç»çå",normalizedTitle:"5.1 å¸¸ç¨äºæç´¢ãæåºãåç»çå",charIndex:7658},{level:3,title:"5.2 èèåçåºæ°",slug:"_5-2-èèåçåºæ°",normalizedTitle:"5.2 èèåçåºæ°",charIndex:7861},{level:3,title:"5.3 ä¸»é®æå¥é¡ºåº",slug:"_5-3-ä¸»é®æå¥é¡ºåº",normalizedTitle:"5.3 ä¸»é®æå¥é¡ºåº",charIndex:8025}],headersStr:"1. æ²¡æç´¢å¼çæ¥æ¾ 1.1 å¨ä¸é¡µä¸­æ¥æ¾ 1.2 å¨å¾å¤é¡µä¸­æ¥æ¾ 2. ç´¢å¼ 2.1 ä¸ä¸ªç®åçç´¢å¼æ¹æ¡ 2.2 InnoDBçç´¢å¼æ¹æ¡ 2.3 èç°ç´¢å¼ 2.4 äºçº§ç´¢å¼ 3. åè¡¨ 3.1 åè¡¨çä»£ä»· 3.2 è¦çç´¢å¼ 4. B+æ ç´¢å¼çä½¿ç¨ 4.1 ç´¢å¼çä»£ä»· 4.2 ç´¢å¼å¤±æçåºæ¯ 4.2.1 æå·¦åç¼å¹é 4.2.2 æ¨¡ç³æ¥è¯¢ 4.2.4 è¿ç®ä¸å½æ° 4.2.5 or 5. å¦ä½æéç´¢å¼ 5.1 å¸¸ç¨äºæç´¢ãæåºãåç»çå 5.2 èèåçåºæ° 5.3 ä¸»é®æå¥é¡ºåº",content:"# InnoDB - B+æ ç´¢å¼\n\nå¨éè¯»åä½ éè¦äºè§£çåç½®ç¥è¯ï¼ InnoDBè¡æ ¼å¼ InnoDBé¡µç»æ\n\n\n# 1. æ²¡æç´¢å¼çæ¥æ¾\n\n\n# 1.1 å¨ä¸é¡µä¸­æ¥æ¾\n\næ¬ç¯çä¸»é¢æ¯ç´¢å¼ï¼å¨æ­£å¼ä»ç»ç´¢å¼ä¹åï¼æä»¬éè¦äºè§£ä¸ä¸æ²¡æç´¢å¼çæ¥æ¾ï¼ä¸é¢åªéå¯¹ç²¾ç¡®æ¥æ¾ï¼å¹¶ä¸ç°å¨ä¸é¡µä¸­è®¨è®ºï¼\n\nå¦æä¸æ¡SQLæ¯è¿æ ·çï¼\n\nselect * from user where åå = 'xxx';\n\n\nå¯¹äºç²¾ç¡®æ¥æ¾ï¼ååä¸ºä¸¤ç§æåµï¼ä¸»é®æ¥æ¾åéä¸»é®æ¥æ¾ã\n\n * ä¸»é®æ¥æ¾ï¼å¨é¡µç®å½çæ§½ä½ä¸­è¿è¡äºåæ³æ¥æ¾ï¼æ¾å°å·®å¼æå°çæ§½åå»User Recordåºåå¯»æ¾å¯¹åºçç»ï¼å¨ç»ä¸­å°±å¯ä»¥æ¥æ¾å°ç¸åºæ°æ®ã\n * éä¸»é®æ¥æ¾ï¼ç±äºæ§½ä½ä¸­å¹¶ä¸ä¼è®°å½éä¸»é®çä¿¡æ¯ï¼åªè½ä»æå°è®°å½æ¨ä¸ªéåå¯»æ¾ç¬¦åæ¡ä»¶çè¡æ°æ®ã\n\n\n# 1.2 å¨å¾å¤é¡µä¸­æ¥æ¾\n\nä¸è¿°æåµåªæ¯éå¯¹åªæä¸é¡µæ°æ®çæåµï¼å¤§é¨åæåµä¸æä»¬çæ°æ®æ¯å¾å¤çï¼å¾å¾æå¾å¤é¡µæ¥å­å¨æ°æ®ï¼é£ä¹æ¥è¯¢çæ­¥éª¤å°±åæè¿æ ·ï¼\n\n * éåææé¡µ\n * å¨æ¯ä¸é¡µä¸­ä½¿ç¨äºåæ³æ¥æ¾æ°æ®ã\n\nå¨æ²¡æç´¢å¼çæåµä¸ï¼ä¸è®ºæ¯æ ¹æ®ä¸»é®æèå¶ä»å­æ®µè¿è¡æ¥æ¾ï¼æä»¬æ æ³å¿«éå®ä½å°æ°æ®æå¨çé¡µï¼æä»¥åªè½æ²¿çé¡µç»æçååé¾è¡¨æ¨ä¸ªéåï¼éåææé¡µçæçæ¯éå¸¸ä½çï¼è¿æ¶åç´¢å¼çä¼å¿å°±ä½ç°åºæ¥äºã\n\n\n# 2. ç´¢å¼\n\nä¸ºäºæäºçé¡ºå©åå±ï¼æä»¬ååå»ºä¸ä¸ªè¡¨ï¼\n\ncreate table indx_demo (   \n\tc1 int ,   \n\tc2 int ,   \n\tc3 char(1),   \n\tprimary key(c1) \n) row_format = compact;\n\n\nè¿ä¸ªæ°å»ºç index_demo è¡¨ä¸­æ2ä¸ª int ç±»åçåï¼1ä¸ªcharç±»åçåï¼c1ä¸ºä¸»é®ï¼èä¸è§å®äºè¿ä¸ªè¡¨ä½¿ç¨Compactè¡æ ¼å¼æ¥å­å¨æ°æ®ã\n\nä¸ºäºæ¹ä¾¿çè§£ï¼æä»¬ç®åè¡æ ¼å¼ï¼åªä¿çæ¬ç¯æç« ç¨å°çï¼\n\n * record_type ï¼æ­¤æ¡è®°å½çç±»å\n   \n   * 0ï¼æ®éè®°å½\n   * 1ï¼B+æ éå¶å­èç¹è®°å½\n   * 2ï¼æå°è®°å½\n   * 3ï¼æå¤§è®°å½\n\n * next_recordï¼æ­¤æ¡è®°å½çä¸ä¸æ¡è®°å½\n\näºæ¯æä»¬å index_demo è¡¨ä¸­æå¥å æ¡æ°æ®åï¼\n\n\n\n\n# 2.1 ä¸ä¸ªç®åçç´¢å¼æ¹æ¡\n\nåè¯´åï¼MySQLç¨çä¸æ¯è¿ä¸ªå°æ é¢ä¸­çç´¢å¼æ¹æ¡ï¼åªæ¯æä»¬å¨å°è¯ä½¿ç¨èªå·±çæ³æ³æ¥è®¾è®¡ä¸ä¸ªç´¢å¼æ¹æ¡ã\n\næä»¬å¨æ ¹æ®æä¸ªæç´¢æ¡ä»¶æ¥è¯¢æ¶ä¸ºä»ä¹è¦éåææçæ°æ®é¡µå¢ï¼å ä¸ºåä¸ªé¡µçæ°æ®æ²¡æè§å¾ï¼æèè¯´æä»¬å¹¶ä¸ç¥éæä»¬çæç´¢æ¡ä»¶å¹éåªäºé¡µä¸­çè®°å½ï¼æä»¥ä¸å¾ä¸éåææçæ°æ®é¡µã\n\nå¦ææä»¬æ³è¦å¿«éå®ä½å°éè¦æ¥æ¾çè®°å½å¨åªä¸ªæ°æ®é¡µè¯¥æä¹åï¼è¿è®°å¾æä»¬ä¸ºäºæ ¹æ®ä¸»é®å¼å¿«éå®ä½ä¸æ¡è®°å½å¨é¡µä¸­çä½ç½®èè®¾ç«çç®å½åï¼æä»¬ä¹å¯ä»¥åé´è¿ä¸ªææ³ï¼ç®å½\n\nè¿ä¸ªç®å½å¿é¡»åå°ä»¥ä¸åè½ï¼\n\n 1. ä¸ä¸ä¸ªæ°æ®é¡µä¸­çç¬¬ä¸æ¡æ°æ®çä¸»é®å¼å¿é¡»å¤§äºä¸ä¸ä¸ªæ°æ®é¡µä¸­æåä¸æ¡æ°æ®çä¸»é®å¼ï¼è¿æ ·æè½ç¨äºåæ³ã\n 2. ç»é¡µå»ºç«ç®å½ï¼è¿æ ·æè½è·å¾å¿«éå°è¾¾é¡µ\n\nï¼åè®¾ä¸é¡µåªè½å­å¨3æ¡ç¨æ·è®°å½ï¼\n\næä»¬åå¶ä¸­æå¥ä¸æ¡æ°æ®ï¼\n\n\n\nè¿ä¸é¡µå±æä¸æ¡æ°æ®ï¼idåå«ä¸º1ã2ã5.\n\nå½æä»¬ç»§ç»­åè¡¨ä¸­æå¥ä¸æ¡id = 4çæ°æ®ï¼è¿ä¸ªé¡µå·²ç»æ»¡äºï¼æä»¥MySQLä¼åå»ºæ°çé¡µæ¥å­å¨æ°æ®ã\n\n\n\nä¸ºä»ä¹æ°åéçé¡µçç¼å·æ¯24èä¸æ¯11å¢ï¼å¶å®MySQLå¹¶æ²¡æè§å®é¡µç å¿é¡»æç§é¡ºåºï¼åªè¦ä¸¤ä¸ªé¡µä¹é´ææéç¸è¿ç»æä¸ä¸ªååé¾è¡¨å°±è¡äºã\n\né¡µ10ä¸­æå¤§ç¨æ·è®°å½çidä¸º5ï¼é¡µ24ä¸­æå°è®°å½çidä¸º4ï¼è¿å°±ä¸ç¬¦åä¸ä¸ä¸ªæ°æ®é¡µä¸­ç¨æ·è®°å½çä¸»é®å¼å¤§äºè¯¥é¡µä¸­ç¨æ·è®°å½çä¸»é®å¼çè¦æ±ã\n\næä»¬æ³è¦é¡µ24çæå°ä¸»é®å¼å¤§äºé¡µ10çæå¤§ä¸»é®å¼ï¼è¿æ¶å°±éè¦å°5ç§»å¨å°24ï¼å°4ç§»å¨å°10ã\n\nè¿ä¸ªè¿ç¨è¡¨æäºå¨å¯¹é¡µçè®°å½è¿è¡å¢å æ¹çæ¶åï¼MySQLä¼éè¿ä¸äºæä½ï¼ä¾å¦è®°å½ç§»å¨ãé¡µçå¢å /å é¤æ¥ç»´æï¼ä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼æ°¸è¿æ¯ä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼å¤§ãè¿ä¸ªè¿ç¨å¯ä»¥ç§°ä¸ºï¼é¡µåè£ã\n\né¡µåè£æ¯éå¸¸æ¶èèµæºçï¼æä»¥MySQLå»ºè®®æä»¬ç»ä¸ä¸ªè¡¨åå»ºä¸ä¸ªæ æä¹ä¸èªå¢çä¸»é®ãé¿åèæ¯åçé¡µåè£ã\n\nç¬¬ä¸æ¡æä»¬å·²ç»æ»¡è¶³äºï¼ä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼å¿é¡»å¤§äºä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼ï¼è¿æ ·æè½ç¨äºåæ³ã\n\nä¸é¢æ¥çç¬¬äºä¸ªï¼ç»é¡µå»ºç«ç®å½\n\nç«å¨é¡µçåé¨ï¼æä»¬å°æ°æ®è¿è¡åç»ï¼ç»åä¸ªç»å»ºç«äºç®å½ï¼å å¿«å¯¹äºæ°æ®çæ¥è¯¢ã\n\nç°å¨æä»¬å°ç«å¨é¡µçå¤é¨ï¼ï¼ä¹å°±æ¯è¡¨çè§åº¦ï¼ç»é¡µå»ºç«ç®å½ï¼å å¿«æ¾å°ç®æ é¡µçéåº¦ã\n\nååè¿å¼ è¡¨ä¸­å¤æå¥å æ¡æ°æ®ï¼\n\n\n\nç°å¨å±æ4ä¸ªé¡µï¼æ¯ä¸ªé¡µæ3æ¡ç¨æ·è®°å½ã\n\nå ä¸ºè¿äº16KBçé¡µå¨ç©çå­å¨ä¸å¾å¯è½å¹¶ä¸æ¨çï¼æä»¥å¦ææ³ä»è¿ä¹å¤é¡µä¸­æ ¹æ®ä¸»é®å¼å¿«éå®ä½æäºè®°å½æå¨çé¡µï¼æä»¬å¯ä»¥æ ¹æ® ä¸»é®å¼-é¡µç  çæä¸ä¸ªç®å½ï¼è¿æ ·å°±å¯ä»¥æ ¹æ®ä¸»é®å¼å®ä½é¡µç äºãæ¯ä¸ä¸ªé¡µå¯¹åºä¸ä¸ªç®å½é¡¹ï¼æ¯ä¸ªç®å½é¡¹åå«ï¼é¡µç ãé¡µç å¯¹åºçé¡µä¸­æ°æ®çæå°ä¸»é®å¼ã\n\näºæ¯ï¼ä¸ä¸ªç´¢å¼éå½¢å°±åºç°äºï¼\n\n\n\n\n# 2.2 InnoDBçç´¢å¼æ¹æ¡\n\nä¸é¢å°èçæ é¢æ¯âä¸ä¸ªç®åçç´¢å¼æ¹æ¡âï¼æ¯å ä¸ºå®åªæ¯ä¸ä¸ªéå½¢ï¼è¿å·æå¾å¤ä¸å®å¤çå°æ¹ãå®å·æä»¥ä¸å ä¸ªç¼ºç¹ï¼\n\n 1. InnoDBæ¯ä½¿ç¨é¡µä½ä¸ºç®¡çå­å¨ç©ºé´çåºæ¬åä½ï¼ä¹å°±æ¯æå¤è½ä¿è¯16KBçè¿ç»­å­å¨ç©ºé´ï¼èéçè¡¨ä¸­è®°å½çå¢å¤ï¼éè¦éå¸¸å¤§çè¿ç»­çå­å¨ç©ºé´ï¼è¿æ¾ç¶æ¯ä¸ç°å®çã\n 2. æä»¬ç»å¸¸ä¼å¯¹æ°æ®è¿è¡å¢å æ¹ï¼åè®¾æä»¬æ24é¡µä¸­çæ°æ®å¨é½å é¤äºï¼é£ä¹24é¡µä¹å°±æ²¡æäºå­å¨çå¿è¦ï¼é£ä¹å¯¹åºçç®å½é¡¹ä¹å°±æ²¡æäºå­å¨çå¿è¦ï¼è¿çµæ¯å°é¡µãç®å½é¡¹çç§»å¨ï¼çµä¸åèå¨å¨èº«\n\næä»¥å¦ä½çµæ´»çç®¡çç®å½é¡¹æ¯ä¸ªé®é¢ï¼MySQLè®¾è®¡èå½ç¶æ³åºäºè§£å³è¿ä¸ªé®é¢çæ¹æ¡ï¼ç®å½é¡¹åæ ·ä½¿ç¨é¡µè¿è¡å­å¨ã\n\nä»ä»¬å¤ç¨äºå­å¨ç¨æ·æ°æ®çé¡µæ¥å­å¨ç®å½é¡¹ï¼ä¹å°±æ¯ç´¢å¼ï¼ãæä»¬å¯ä»¥åºå«çç§°å¼å¶ä¸ºï¼ç¨æ·è®°å½ãç´¢å¼è®°å½ï¼ç®å½é¡¹è®°å½ï¼ã\n\né£ä¹å¦ä½åºåä¸æ¡è®°å½æ¯ç¨æ·è®°å½è¿æ¯ç´¢å¼è®°å½å¢ï¼record_typeå±æ§ãrecord_typeåä¸ªåå¼ä»£è¡¨çææï¼\n\n * 0 ï¼ç¨æ·è®°å½\n * 1 ï¼ç®å½é¡¹è®°å½ï¼ç´¢å¼è®°å½ï¼\n * 2 ï¼æå°è®°å½\n * 3 ï¼æå¤§è®°å½\n\næä»¬å°ä¸è¿°å¾å®åä¸ä¸å°±æ¯ï¼\n\n\n\nè¿å¼ å¾ä½ ææ²¡ææè§åä»ä¹æ°æ®ç»æï¼B+æ ï¼\n\nä»å¾ä¸­æä»¬å¯ä»¥çåºï¼\n\n * å¶å­èç¹å­å¨ä¸»é®ä»¥åæ°æ®ï¼æ°æ®çrecord_typeä¸º0\n * éå¶å­èç¹åªå­å¨ä¸»é®+é¡µç®å½ï¼æ°æ®çrecord_typeä¸º1\n * æ¯ä¸å±çèç¹ï¼æ¯ä¸ä¸ªèç¹å³ä¸é¡µï¼ä½¿ç¨ååé¾è¡¨è¿æ¥ã\n\näºæ¯å½æä»¬æ¥è¯¢ä¸æ¡è®°å½æ¶å¯ä»¥åä¸ºä¸¤æ­¥ï¼\n\n 1. ç¡®å® ç®å½é¡¹è®°å½ é¡µï¼æ ¹æ®ä¸»é®ï¼ä½¿ç¨äºåæ³ç¡®å®è¿ä¸ªè®°å½å¤§æ¦å¤å¨åªä¸ªé¡µ\n 2. ç¡®å® è®°å½å¨åªä¸ªç»ï¼æ ¹æ®é¡µç®å½ï¼ä½¿ç¨äºåæ³çæ§½ä½ç¡®å®è¿ä¸ªè®°å½å¨åªä¸ªç»ï¼è¿èä»ç»ä¸­æ¾å°è¯¥æ°æ®ã\n\nä»å¤´å°å°¾é½æ¯äºåæ³ã\n\néè¦æ³¨æçæ¯ï¼æä»¬ä¸è¬ç¨ä¸ä¸ªé¡¶ç¹æ¥å­å¨ç®å½é¡¹è®°å½çé¡µãäºæ¯ä¸é¢é£å¼ å¾çæç»çä¸ºï¼\n\n\n\næ´åB+æ äº~\n\nåå¦ä¸ä¸ªé¡µå¯ä»¥æ1000ä¸ªå­é¡µï¼ä¹å°±æ¯ä¸é¡µä¸­æ1000æ¡è®°å½ï¼ï¼ä¸å±æ¯ä¸ä¸ªé¡µï¼ç¬¬äºå±å°±å¯ä»¥æ1000é¡µï¼ç¬¬ä¸å±å°±å¯ä»¥æ1000 * 1000 é¡µï¼æ¯ä¸é¡µæ1000æ¡æ°æ®ï¼é£ä¹ç¬¬ä¸å±å¯ä»¥æ 1000 * 1000 * 1000 æ¡æ°æ®ï¼æä»¥æä»¬çæ°æ®ç»å¤§å¤æ°åªæä¸¤~ä¸å±B+æ ã\n\næ³èµ·ä¹åèçé¢è¯é¢ï¼\n\nç¸æ¯äºäºåæ ï¼B+æ çå±çº§æ´ä½...(é¿å·´é¿å·´é¿å·´)\n\nç°å¨ç¥éå°åºä¸ºä»ä¹äºå§ã\n\nä½æ¯ç°å¨è¿æä¸ä¸ªé®é¢ï¼\n\nå¦ææä»¬ä¸º age åå»ºäºä¸ä¸ªäºçº§ç´¢å¼ï¼é£ä¹å¨B+æ çéå¶å­èç¹ä¸­çè®°å½å°±æ¯ï¼ageå¯¹åºé¡µç ãä½æ¯ageæ¯å¾å®¹æéå¤çï¼13è¿ä¸ªageæå¯è½å¯¹åºå¾å¤ä¸ªé¡µç ï¼è¿èåºç°äºè¿ç§æåµï¼age=13å¯¹åºäº 54ã32ã15è¿ä¸é¡µï¼åæå¥ä¸æ¡age=13çæ°æ®ï¼è¿æ¡æ°æ®è¯¥å¾åªä¸ªé¡µä¸­æå¥å¢ï¼\n\nä¸ºäºè®©æ°æå¥è®°å½è½æ¾å°èªå·±å¨é£ä¸ªé¡µéï¼æä»¬éè¦å¨è®°å½ä¸­åæ·»å ä¸ä¸ªå¯ä¸å­æ®µï¼ä»ä¹å­æ®µéååè¿ä¸ªå¯ä¸ç´¢å¼å¢ï¼ä¸»é®åã\n\næä»¥å¯¹äºäºçº§ç´¢å¼çåèç¹çç®å½é¡¹è®°å½çåå®¹å®éä¸æ¯ç±ä¸ä¸ªé¨åææç\n\n * å­æ®µå¼\n * å­æ®µå¯¹åºçä¸»é®å¼\n * é¡µç \n\n\n# 2.3 èç°ç´¢å¼\n\nInnoDBçB+æ ç´¢å¼ä¹å¯ä»¥å¤§è´åä¸ºè¿ä¸¤ç±»ï¼èç°ç´¢å¼åäºçº§ç´¢å¼ã\n\nï¼åªæä¸»é®ä¼å»ºç«ä¸é¢èç°ç´¢å¼B+æ ï¼ä¸ç®¡æ¯å¯ä¸ç´¢å¼è¿æ¯èåç´¢å¼å·´æå·´æè¿äºå¶ä»çç´¢å¼é½æ¯äºçº§ç´¢å¼ï¼\n\nä¸è¿°å¾çæè¿°çæ¯èç°ç´¢å¼ï¼å¶å­èç¹ä¸­å­å¨çæ¯ ä¸»é®->æ°æ® ãï¼å­¦è¿çå¤§æ¦é½ç¥éï¼\n\n\n# 2.4 äºçº§ç´¢å¼\n\näºçº§ç´¢å¼çå¶å­èç¹ä¸­å­å¨çæ¯ å­æ®µå¼ -> ä¸»é®ã\n\nå¦ææ¥è¯¢äºçº§ç´¢å¼ï¼æ¿å°ä¸»é®åè¿éè¦å»èç°ç´¢å¼çB+æ ä¸­éè¿ä¸»é®æ¿å°å¨é¨æ°æ®ãè¿ä¹è¢«ç§°ä¸ºåè¡¨æ¥è¯¢ã\n\nèåç´¢å¼ï¼\n\nèåç´¢å¼å°±æ¯å¾å¤ä¸ªå­æ®µä¸èµ·å±ç¨åä¸é¢B+æ ã\n\nåå¦ä¸º idãnameãageå»ºç«èåç´¢å¼ idx_id_name_ageï¼é£ä¹å®ä»¬ä¸ä¸ªå­æ®µå°±ä¼ä½¿ç¨åä¸é¢B+æ ã\n\néè¿åæçå­¦ä¹ ï¼æä»¬ç¥éB+æ æ¯æç§ä¸å®é¡ºåºå­å¨æ°æ®çï¼ä¹å°±æ¯æåºçï¼èç°ç´¢å¼æç§ä¸»é®æåºï¼é£ä¹èåç´¢å¼å¢ï¼\n\nå¯¹äº idx_id_name_age è¿ä¸ªèåç´¢å¼æ¥è¯´ï¼é¡ºåºï¼æç§idæåºï¼idç¸ååæç§nameæåºï¼nameç¸ååæç§ageæåºã\n\n\n# 3. åè¡¨\n\n\n# 3.1 åè¡¨çä»£ä»·\n\nä¹åå¯¹äºåè¡¨è¿ä¸ªè¯é½æ¯ä¸å¸¦èè¿ï¼ä¸é¢è¯¦ç»è¯´ä¸ä¸ã\n\nåå¦å¯¹äº nameãbirthdayãphone_numå»ºç«äºä¸ä¸ªèåç´¢å¼ï¼idx_name_birthday_phone_numberã\n\nå¯¹äºä»¥ä¸SQLè¯­å¥ï¼\n\nselect * from person_info where name > 'xiaoming' and name < 'zengyi';\n\n\nå¨ä½¿ç¨èåç´¢å¼ idx_name_birthday_phone_numberæ¶å¯ä»¥åä¸ºè¿ä¸¤æ­¥ï¼\n\n * ä»ç´¢å¼ idx_name_birthday_phone_number ä¸­çB+æ ååºå¼å¨ xiaoming ~ zengyi çæ°æ®ã\n * ç±äºç´¢å¼åªæ name birthday phone_number è¿ä¸ä¸ªå­æ®µï¼èæ¥è¯¢åè¡¨ä¸­æ³è¦çæ¯ *ï¼æä»¥ä¼æ¿çä¸»é®idå»èç°ç´¢å¼ä¸­æ¿å¨é¨è®°å½ã\n\nç±äºç´¢å¼ idx_name_birthday å¯¹åºçB+æ çè®°å½ä¼é¦åæç§nameåçå¼è¿è¡æåºï¼æä»¥å¼å¨ xiaoming ~ zengyi ä¹é´çè®°å½å¨ç£çä¸­çå­å¨æ¶æ¯ç¸è¿çï¼æå¯è½å°±éä¸­åå¸å¨åä¸é¡µä¸­ï¼æä»¬å¯ä»¥ç´æ¥æ²¿çé¾è¡¨å°æ°æ®è¯»ååºæ¥ï¼è¿ä¸ªè¿ç¨ç§°ä¸ºé¡ºåºIOãä½æ¯æ ¹æ®nameæ¿å°çidå¹¶ä¸ç¸è¿ï¼è½ç¶èç°ç´¢å¼ä¸­çidæ¯é¡ºåºçï¼ä½æ¯æä»¬æ ¹æ® name æ¿å°çidä¸ç¸è¿ï¼æä»¥åªè½å»ä¸åçé¡µå»æ¿æ°æ®ï¼è¿ç§è¯»åæ¹å¼è¢«ç§°ä¸ºéæºIOãä¸è¬æåµä¸ï¼é¡ºåºIOæ¯éæºIOå¿«å¾å¤ï¼æä»¥è¿ä¸ªSQLè¯­å¥çä¸¤æ­¥å¶å®æ¯è¿æ ·çï¼\n\n * ä¼ç¨å°ä¸¤ä¸ªç´¢å¼ï¼èå(äºçº§)ç´¢å¼åèç°ç´¢å¼\n * è®¿é®äºçº§ç´¢å¼æ¶ä½¿ç¨é¡ºåºIOï¼è®¿é®èç°ç´¢å¼æ¶ä½¿ç¨éæºIOã\n\néè¦åè¡¨çè®°å½è¶å¤ï¼ä½¿ç¨äºçº§ç´¢å¼çæ§è½å°±è¶ä½ãçè³æäºæ¥è¯¢å®æ¿ç¨å¨è¡¨æ«æä¹ä¸ç¨äºçº§ç´¢å¼ã\n\nä¾å¦åæé£ä¸ªSQLæ¥åºçè®°å½å å°è¡¨ä¸­æ»è®°å½çï¼ï¼ï¼æ¶ï¼ççä¸å¦ç´æ¥å¨è¡¨æ«æã\n\né£ä¹ä»ä¹æ¶åä½¿ç¨ç´¢å¼ï¼ä»ä¹æ¶åå¨è¡¨æ«æå¢ï¼è¿æ¯æ¥è¯¢ä¼åå¨éè¦åçäºã\n\næ¥è¯¢ä¼åå¨ä¼æ ¹æ®ä¸æ¡ï¼³ï¼±ï¼¬èµ°äºåªäºç´¢å¼å ç¨äºå¤å°æ§è½æ¥è®¡ç®åæ°ï¼æåä½¿ç¨åæ°æä½çé£ä¸ªSQLæèç´æ¥å¨è¡¨æ«æã\n\n\n# 3.2 è¦çç´¢å¼\n\nä¸ºäºåå°åè¡¨å¸¦æ¥çæ§è½æèï¼MySQLæ´å»ºè®®ï¼æ¥è¯¢åè¡¨å°½éåªåå«ç´¢å¼åã\n\nselectãname, birthday, phone_number  \nfrom person_info \nwhere name > 'xiaoming' and name < 'zengyi';\n\n\nåªè¦ä¸è®©å®åè¡¨ï¼å°±ä¸ä¼æåè¡¨çåå¤å¦~\n\n\n# 4. B+æ ç´¢å¼çä½¿ç¨\n\nåé¢ä¸¤èè¯¦ç»æè¿°äºB+æ çç»æï¼æ¸©æï¼\n\n * æ¯ä¸ä¸ªç´¢å¼é½å¯¹åºä¸ä¸ªB+æ ï¼B+æ çèç¹æ¯é¡µãéå¶å­èç¹å­å¨çæ¯ç®å½ï¼å¶å­èç¹å­å¨çæ¯æ°æ®ï¼èç°ç´¢å¼åäºçº§ç´¢å¼ä¸åï¼\n * B+æ çå¶å­èç¹ï¼é¡µï¼æç§ååé¾è¡¨è¿æ¥ï¼é¡µçåé¨ï¼å³æ°æ®ï¼æç§åé¾è¡¨é¡ºåºè¿æ¥ã\n\n\n\n\n# 4.1 ç´¢å¼çä»£ä»·\n\nå¨ä»ç»æ´å¥½çä½¿ç¨ç´¢å¼åè¯å®è¦ç¥é ä¸ºä»ä¹è¦æ´å¥½çä½¿ç¨ç´¢å¼ï¼å ä¸ºç´¢å¼ä¹æç¼ºç¹å~\n\n * ç©ºé´ä¸çä»£ä»· ï¼è¿ä¸ªæ¯æ¾èæè§çï¼æ¯å»ºç«ä¸ä¸ªç´¢å¼ï¼ç©ºé´ä¸­å°±å¤ä¸é¢B+æ ï¼B+æ çæ¯ä¸ä¸ªèç¹é½æ¯ä¸é¡µï¼ä¸é¡µ16Kï¼å½ç¶å¾å ç©ºé´å½ã\n * æ¶é´ä¸çä»£ä»· ï¼ç´¢å¼ä¼åäºæ¥è¯¢æä½ï¼æ¯ç«ä½¿ç¨äºäºåæ¥æ¾ãä½æ¯å¨å¢å æ¹æä½æ¶ï¼ä¸ä»éè¦ä¿®æ¹æ°æ®é¡µï¼è¿éè¦ä¿®æ¹ç´¢å¼é¡µãï¼ä¸ä»è¦ä¿®æ¹å¶å­èç¹ï¼åè¦ä¿®æ¹éå¶å­èç¹ï¼ãæ¶ä¸æ¶è¿ä¼ä¼´éçé¡µåè£ãé¡µåæ¶ãè®°å½ç§»å¨çæä½ï¼è¿äºé½æ¯å¯¹æ¶é´çæ¶èã\n\næä»¥ï¼ä¸å¼ è¡¨ä¸ç´¢å¼å»ºç«çè¶å¤ï¼å°±ä¼å ç¨è¶å¤çå­å¨ç©ºé´ï¼å¨å¯¹æ°æ®å¢å æ¹æ¶çæ§è½å°±ä¼æ´å·®ã\n\n\n# 4.2 ç´¢å¼å¤±æçåºæ¯\n\nè¿ä¸ªç¥è¯ç¹æ³å¿å¤§å®¶é¢è¯é¢é½èçäºï¼é£ä¹ä½ ç¥é\n\n * ä¸ºä»ä¹ä¸ç¬¦åæå·¦åç¼å¹éååï¼ç´¢å¼å°±ä¼å¤±æåï¼\n * ä¸ºä»ä¹ä½¿ç¨ '%xxx'ï¼ç´¢å¼å°±ä¼å¤±æå\n\nä¸é¢æ¥çä¸ä¸ä¸ºä»ä¹ã\n\næä»¬å»ºç«ä¸å¼ è¡¨ï¼ä»¥ä¾¿åç»­ç¨å°ï¼\n\nCREATE TABLE person_info(     \n    id INT NOT NULL auto_increment,     \n    name VARCHAR(100) NOT NULL,     \n    birthday DATE NOT NULL,     \n    phone_number CHAR(11) NOT NULL,     \n    country varchar(100) NOT NULL,     \n    PRIMARY KEY (id),     \n    KEY idx_name_birthday_phone_number (name, birthday, phone_number) \n);\n\n\nè¿å¼ è¡¨ä¸­å±æ5ä¸ªå­æ®µï¼å¶ä¸­idå­æ®µèªå¨çæä¸é¢èç°ç´¢å¼çB+æ ï¼nameãbirthdayãnumberè¿ä¸ä¸ªå­æ®µå±ç¨ä¸é¢B+æ ã\n\nç­ç­ï¼å¨ç»§ç»­åä¸çä¹åï¼ä½ éè¦åé¡¾ä¸ä¸ï¼\n\nå¯¹äºèåç´¢å¼ idx_name_birthday_phone_numberï¼æåºçè§åä¸ºï¼åæç§ name æåºï¼name ç¸ååæç§ birthday æåºï¼birthdayç¸ååæç§number æåºã\n\n# 4.2.1 æå·¦åç¼å¹é\n\næå·¦åç¼å¹éç¸æ¯å¤§å®¶é½ç¥éï¼å¯¹äºä¸ä¸ªèåç´¢å¼ï¼å¦ææä¸ä¸ªå­æ®µæ²¡æèµ°ç´¢å¼ï¼é£ä¹å®åé¢çææå­æ®µé½ä¸ä¼èµ°ç´¢å¼ã\n\nåºç°è¿ç§æåµçåå å°±æ¯èåç´¢å¼çæåºè§åï¼åæè¯´è¿ï¼æåºè§åæ¯æç§å·¦è¾¹çåæåºï¼å·¦è¾¹çåç¸ååæç§å³è¾¹çåæåºã\n\nç°å¨æ¥çä¸ä¸è¿å ç§æåµï¼\n\n 1. select * from person_info where name = 'xiaoming' and birthday = '2000-01-01';\n    \n    è¿ä¸ªä¼èµ°ç´¢å¼åï¼ä¼ï¼MySQLä¼å¨èåç´¢å¼çB+æ ä¸­æ¾å° xiaoming æå¨çé¡µï¼åæ¾å®æå¨çç»ï¼æåç¡®å®ç¬¬ä¸ä¸ªnameä¸ºxiaomingçå°æ¹ï¼åæ ¹æ®å·²ç»æå¥½åºç birthday è¿è¡é¡ºåºæ¥æ¾ï¼ç´è³æ¾å°ç®æ ãï¼æ¿å°è¯¥ç®æ çä¸»é®åå»èç°ç´¢å¼ä¸­åè¡¨æ¥è¯¢ï¼\n\n 2. select * from person_info where birthday = '2000-01-01';\n    \n    è¿ä¸ªä¼èµ°ç´¢å¼åï¼ä¸ä¼ï¼å ä¸ºbirthdayæå¨çç´¢å¼é¦åæç§nameè¿è¡æåºï¼åæç§birthdayæåºãé½ä¸æbirthdayæåºäºï¼æä¹èµ°ç´¢å¼ï¼\n\n 3. select * from person_info where name < 'xiaoming' and name > 'xiaohong' and birthday = '2002-01-01';\n    \n    è¿ä¸ªä¼èµ°å ä¸ªç´¢å¼ï¼ä¸ä¸ªnameçç´¢å¼ï¼ä¸ºä»ä¹å¢ï¼æä»¬æ ¹æ®nameèµ°äºç´¢å¼ä¹åè·å¾äºä¸ä¸ªèå´å¼ï¼é£ä¹è¿ä¸ªèå´ä¹å¯è½å¦ä¸æç¤ºï¼\n    \n    xiaohong 1998-03-12\n    \n    xiaohong 2002-01-01\n    \n    xiaohong 2005-08-09\n    \n    xiaoming 2001-10-02\n    \n    xiaoming 2002-09-13\n    \n    å¯ä»¥çå°ï¼è½ç¶æç§nameæå¥½åºäºï¼ä½æ¯birthdayå¹¶æ²¡æé¡ºåºå¯è¨ï¼ä¹å°±æ æ³èµ°ç´¢å¼ï¼åªè½åæ¿å°ä¸»é®idï¼å»èç°ç´¢å¼ä¸­æ¿å°å¯¹åºæ°æ®ååå¤æ­ä¸ä¸è¿äºæ°æ®çbirthdayæ¯å¦ä¸º 2002-01-01ã\n    \n    ä¸ä»ä»æ¯ç­å¼å¹éãèå´å¹éä¼ä½¿ç¨æå·¦åç¼å¹éï¼åç»æä½ä¹ä¼ä½¿ç¨æå·¦åç¼å¹éååï¼æä»¥åç»æ¶ä¹è¦æ³¨æå¦ã\n\n# 4.2.2 æ¨¡ç³æ¥è¯¢\n\nå¨è¿è¡æ¨¡ç³æ¥è¯¢æ¶ï¼'xx%'å'x%x' é½ä¸ä¼å¤±æï¼è'%xxx'å°±ä¼å¯¼è´ç´¢å¼å¤±æã\n\nä¸ºå¥ï¼åä¸¤ä¸ªæèµ·ç ç¬¬ä¸ä¸ªä¸ºxï¼MySQLå¯ä»¥å¨ç´¢å¼ä¸­æ¾å°ç¬¬ä¸ä¸ªå­ç¬¦ä¸ºxçæ°æ®ï¼è¿æ ·å³ä½¿ä¸è½æç»ç¡®å®æåªäºæ°æ®ä¹è½ç­éæä¸å°çæ°æ®äºã\n\nä½æ¯ç»æä¸ª '%xx' æ¯ä»ä¹ææï¼ç¬¬ä¸ä¸ª '%' ä½ æ³è®©ææä¹å¹éæä¹æåºï¼è¯å®èµ°ä¸äºç´¢å¼å~\n\n4.2.3 æåº\n\næåºä¼åºç°ä»ä¹é®é¢å¢ï¼\n\nMySQLè§å®ï¼å¯¹äºä½¿ç¨èåç´¢å¼çåºæ¯ï¼è¦æ±åä¸ªæåºåçæåºé¡ºåºæ¯ä¸è´çï¼ä¹å°±æ¯è¦åä¸ªåè¦ä¹å¨é¨éåºï¼è¦ä¹å¨é¨ååºã\n\nä¸ºä»ä¹å¢ï¼\n\nåå¦æä¸ä¸SQLè¯­å¥ï¼\n\nselect * from person_info  order by name asc, birthday desc limit 10;\n\n\nè¿å¥sqlçä½ç¨ï¼\n\n * åä»ç´¢å¼çæå·¦è¾¹ç¡®å® name åæå°çå¼ï¼ç¶åä»nameåçæå³è¾¹é£æ¡è®°å½ä»å³åå·¦æ¾10æ¡(å ä¸ºè¦æ±æ¯birthdayéåº)\n * å¦ææ­¤nameåä¸è¶³10æ¡ï¼é£ä¹å°±è¦å»ä¸ä¸ä¸ªnameåä¸­éå¤ä¸è¿°æä½ã\n\nè¿æ ·éå¸¸éº»ç¦ï¼èä¸ä¸è½é«æå©ç¨ç´¢å¼ï¼æä»¥MySQLå°±è§å® ä½¿ç¨èåç´¢å¼çåä¸ªæåºé¡ºåºé½å¿é¡»æ¯ä¸è´çã\n\n# 4.2.4 è¿ç®ä¸å½æ°\n\nè¦æ³ä½¿ç¨ç´¢å¼è¿è¡æåºæä½ï¼å¿é¡»ä¿è¯ç´¢å¼åæ¯ä»¥åç¬åçå½¢å¼åºç°ï¼èä¸æ¯ä¿®é¥°è¿çå½¢å¼ã\n\nå ä¸ºwhere æ¡ä»¶å­æ®µç±»åä¸å®éè¡¨ä¸­å­æ®µç±»åä¸å¹éæ¶ï¼MySQLä¼è¿è¡éå¼çç±»åè½¬æ¢ï¼èç±»åè½¬æ¢ä¼ç¨å°åç½®å½æ°ï¼å¯¼è´å¨æ¥è¯¢æ¶æ²¡æèµ°ç´¢å¼ã\n\n# 4.2.5 or\n\næä»¬ææ¶åä¼ç¨å°orï¼select * from user where age = 18 or age = 20;\n\norå·¦å³çå­æ®µå¿é¡»é½å ç´¢å¼æä¼çæã\n\n\n# 5. å¦ä½æéç´¢å¼\n\n\n# 5.1 å¸¸ç¨äºæç´¢ãæåºãåç»çå\n\nä¸ºå¸¸ç¨äºæç´¢ãæåºãåç»çååå»ºç´¢å¼ï¼ä¹å°±æ¯è¯´ï¼åªä¸ºåºç°å¨ where å­å¥ä¸­çååå»ºç´¢å¼ï¼åºç°å¨æ¥è¯¢åè¡¨ä¸­çå°±æ²¡å¿è¦äºï¼å ä¸ºåè¡¨åèªç¶è½æ¥åºæ¥ï¼ã\n\nä¸é¢è¿ä¸å¥ï¼æä»¬ä¸ºnameåå»ºç´¢å¼ï¼èä¸ä¸ºbirthdayåcountryåå»ºç´¢å¼ã\n\nselect birthday, country from person_info where name='xxx';\n\n\n# 5.2 èèåçåºæ°\n\nä»ä¹æ¯åºæ°ï¼ä¸å¼ è¡¨æ10000æ¡æ°æ®ï¼å®çæ¯ä¸åçåºæ°ä¸æ ·åï¼\n\nä¸æ¯ï¼å¦ææ¯idå­æ®µï¼10000æ¡æ°æ®å¯è½idé½ä¸ä¸æ ·ãå¦ææ¯ageå¢ï¼å¦ææ¯åæ°å¢ï¼\n\næä»¥åºæ°æ¯æä¸ç¸åçä¸ªæ°ï¼æä»¬åºè¯¥å°½éæéåºæ°å¤§çåå»ºç«ç´¢å¼ã\n\nï¼åé£äºæ§å«ãç¶æå°±ä¸è¦åå»ºç´¢å¼ï¼ä½æ¯å¦æç»å¸¸ç¨äºåç»çè¯ä¹å¯ä»¥èèï¼ã\n\n\n# 5.3 ä¸»é®æå¥é¡ºåº\n\nä¸»é®æå¥é¡ºåºå°½ééå¢ï¼å¹¶ä¸å°½éä¸è¦è®©ä¸»é®åæ´ãæä»¥ä¸»é®å°½éè®¾ç½®ä¸ºæ æä¹ä¸èªå¢çãé²æ­¢é¡µåè£ãè®°å½éæåº....é æçæ§è½æèã\n\nâ",normalizedContent:"# innodb - b+æ ç´¢å¼\n\nå¨éè¯»åä½ éè¦äºè§£çåç½®ç¥è¯ï¼ innodbè¡æ ¼å¼ innodbé¡µç»æ\n\n\n# 1. æ²¡æç´¢å¼çæ¥æ¾\n\n\n# 1.1 å¨ä¸é¡µä¸­æ¥æ¾\n\næ¬ç¯çä¸»é¢æ¯ç´¢å¼ï¼å¨æ­£å¼ä»ç»ç´¢å¼ä¹åï¼æä»¬éè¦äºè§£ä¸ä¸æ²¡æç´¢å¼çæ¥æ¾ï¼ä¸é¢åªéå¯¹ç²¾ç¡®æ¥æ¾ï¼å¹¶ä¸ç°å¨ä¸é¡µä¸­è®¨è®ºï¼\n\nå¦æä¸æ¡sqlæ¯è¿æ ·çï¼\n\nselect * from user where åå = 'xxx';\n\n\nå¯¹äºç²¾ç¡®æ¥æ¾ï¼ååä¸ºä¸¤ç§æåµï¼ä¸»é®æ¥æ¾åéä¸»é®æ¥æ¾ã\n\n * ä¸»é®æ¥æ¾ï¼å¨é¡µç®å½çæ§½ä½ä¸­è¿è¡äºåæ³æ¥æ¾ï¼æ¾å°å·®å¼æå°çæ§½åå»user recordåºåå¯»æ¾å¯¹åºçç»ï¼å¨ç»ä¸­å°±å¯ä»¥æ¥æ¾å°ç¸åºæ°æ®ã\n * éä¸»é®æ¥æ¾ï¼ç±äºæ§½ä½ä¸­å¹¶ä¸ä¼è®°å½éä¸»é®çä¿¡æ¯ï¼åªè½ä»æå°è®°å½æ¨ä¸ªéåå¯»æ¾ç¬¦åæ¡ä»¶çè¡æ°æ®ã\n\n\n# 1.2 å¨å¾å¤é¡µä¸­æ¥æ¾\n\nä¸è¿°æåµåªæ¯éå¯¹åªæä¸é¡µæ°æ®çæåµï¼å¤§é¨åæåµä¸æä»¬çæ°æ®æ¯å¾å¤çï¼å¾å¾æå¾å¤é¡µæ¥å­å¨æ°æ®ï¼é£ä¹æ¥è¯¢çæ­¥éª¤å°±åæè¿æ ·ï¼\n\n * éåææé¡µ\n * å¨æ¯ä¸é¡µä¸­ä½¿ç¨äºåæ³æ¥æ¾æ°æ®ã\n\nå¨æ²¡æç´¢å¼çæåµä¸ï¼ä¸è®ºæ¯æ ¹æ®ä¸»é®æèå¶ä»å­æ®µè¿è¡æ¥æ¾ï¼æä»¬æ æ³å¿«éå®ä½å°æ°æ®æå¨çé¡µï¼æä»¥åªè½æ²¿çé¡µç»æçååé¾è¡¨æ¨ä¸ªéåï¼éåææé¡µçæçæ¯éå¸¸ä½çï¼è¿æ¶åç´¢å¼çä¼å¿å°±ä½ç°åºæ¥äºã\n\n\n# 2. ç´¢å¼\n\nä¸ºäºæäºçé¡ºå©åå±ï¼æä»¬ååå»ºä¸ä¸ªè¡¨ï¼\n\ncreate table indx_demo (   \n\tc1 int ,   \n\tc2 int ,   \n\tc3 char(1),   \n\tprimary key(c1) \n) row_format = compact;\n\n\nè¿ä¸ªæ°å»ºç index_demo è¡¨ä¸­æ2ä¸ª int ç±»åçåï¼1ä¸ªcharç±»åçåï¼c1ä¸ºä¸»é®ï¼èä¸è§å®äºè¿ä¸ªè¡¨ä½¿ç¨compactè¡æ ¼å¼æ¥å­å¨æ°æ®ã\n\nä¸ºäºæ¹ä¾¿çè§£ï¼æä»¬ç®åè¡æ ¼å¼ï¼åªä¿çæ¬ç¯æç« ç¨å°çï¼\n\n * record_type ï¼æ­¤æ¡è®°å½çç±»å\n   \n   * 0ï¼æ®éè®°å½\n   * 1ï¼b+æ éå¶å­èç¹è®°å½\n   * 2ï¼æå°è®°å½\n   * 3ï¼æå¤§è®°å½\n\n * next_recordï¼æ­¤æ¡è®°å½çä¸ä¸æ¡è®°å½\n\näºæ¯æä»¬å index_demo è¡¨ä¸­æå¥å æ¡æ°æ®åï¼\n\n\n\n\n# 2.1 ä¸ä¸ªç®åçç´¢å¼æ¹æ¡\n\nåè¯´åï¼mysqlç¨çä¸æ¯è¿ä¸ªå°æ é¢ä¸­çç´¢å¼æ¹æ¡ï¼åªæ¯æä»¬å¨å°è¯ä½¿ç¨èªå·±çæ³æ³æ¥è®¾è®¡ä¸ä¸ªç´¢å¼æ¹æ¡ã\n\næä»¬å¨æ ¹æ®æä¸ªæç´¢æ¡ä»¶æ¥è¯¢æ¶ä¸ºä»ä¹è¦éåææçæ°æ®é¡µå¢ï¼å ä¸ºåä¸ªé¡µçæ°æ®æ²¡æè§å¾ï¼æèè¯´æä»¬å¹¶ä¸ç¥éæä»¬çæç´¢æ¡ä»¶å¹éåªäºé¡µä¸­çè®°å½ï¼æä»¥ä¸å¾ä¸éåææçæ°æ®é¡µã\n\nå¦ææä»¬æ³è¦å¿«éå®ä½å°éè¦æ¥æ¾çè®°å½å¨åªä¸ªæ°æ®é¡µè¯¥æä¹åï¼è¿è®°å¾æä»¬ä¸ºäºæ ¹æ®ä¸»é®å¼å¿«éå®ä½ä¸æ¡è®°å½å¨é¡µä¸­çä½ç½®èè®¾ç«çç®å½åï¼æä»¬ä¹å¯ä»¥åé´è¿ä¸ªææ³ï¼ç®å½\n\nè¿ä¸ªç®å½å¿é¡»åå°ä»¥ä¸åè½ï¼\n\n 1. ä¸ä¸ä¸ªæ°æ®é¡µä¸­çç¬¬ä¸æ¡æ°æ®çä¸»é®å¼å¿é¡»å¤§äºä¸ä¸ä¸ªæ°æ®é¡µä¸­æåä¸æ¡æ°æ®çä¸»é®å¼ï¼è¿æ ·æè½ç¨äºåæ³ã\n 2. ç»é¡µå»ºç«ç®å½ï¼è¿æ ·æè½è·å¾å¿«éå°è¾¾é¡µ\n\nï¼åè®¾ä¸é¡µåªè½å­å¨3æ¡ç¨æ·è®°å½ï¼\n\næä»¬åå¶ä¸­æå¥ä¸æ¡æ°æ®ï¼\n\n\n\nè¿ä¸é¡µå±æä¸æ¡æ°æ®ï¼idåå«ä¸º1ã2ã5.\n\nå½æä»¬ç»§ç»­åè¡¨ä¸­æå¥ä¸æ¡id = 4çæ°æ®ï¼è¿ä¸ªé¡µå·²ç»æ»¡äºï¼æä»¥mysqlä¼åå»ºæ°çé¡µæ¥å­å¨æ°æ®ã\n\n\n\nä¸ºä»ä¹æ°åéçé¡µçç¼å·æ¯24èä¸æ¯11å¢ï¼å¶å®mysqlå¹¶æ²¡æè§å®é¡µç å¿é¡»æç§é¡ºåºï¼åªè¦ä¸¤ä¸ªé¡µä¹é´ææéç¸è¿ç»æä¸ä¸ªååé¾è¡¨å°±è¡äºã\n\né¡µ10ä¸­æå¤§ç¨æ·è®°å½çidä¸º5ï¼é¡µ24ä¸­æå°è®°å½çidä¸º4ï¼è¿å°±ä¸ç¬¦åä¸ä¸ä¸ªæ°æ®é¡µä¸­ç¨æ·è®°å½çä¸»é®å¼å¤§äºè¯¥é¡µä¸­ç¨æ·è®°å½çä¸»é®å¼çè¦æ±ã\n\næä»¬æ³è¦é¡µ24çæå°ä¸»é®å¼å¤§äºé¡µ10çæå¤§ä¸»é®å¼ï¼è¿æ¶å°±éè¦å°5ç§»å¨å°24ï¼å°4ç§»å¨å°10ã\n\nè¿ä¸ªè¿ç¨è¡¨æäºå¨å¯¹é¡µçè®°å½è¿è¡å¢å æ¹çæ¶åï¼mysqlä¼éè¿ä¸äºæä½ï¼ä¾å¦è®°å½ç§»å¨ãé¡µçå¢å /å é¤æ¥ç»´æï¼ä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼æ°¸è¿æ¯ä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼å¤§ãè¿ä¸ªè¿ç¨å¯ä»¥ç§°ä¸ºï¼é¡µåè£ã\n\né¡µåè£æ¯éå¸¸æ¶èèµæºçï¼æä»¥mysqlå»ºè®®æä»¬ç»ä¸ä¸ªè¡¨åå»ºä¸ä¸ªæ æä¹ä¸èªå¢çä¸»é®ãé¿åèæ¯åçé¡µåè£ã\n\nç¬¬ä¸æ¡æä»¬å·²ç»æ»¡è¶³äºï¼ä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼å¿é¡»å¤§äºä¸ä¸ä¸ªæ°æ®é¡µä¸­çä¸»é®å¼ï¼è¿æ ·æè½ç¨äºåæ³ã\n\nä¸é¢æ¥çç¬¬äºä¸ªï¼ç»é¡µå»ºç«ç®å½\n\nç«å¨é¡µçåé¨ï¼æä»¬å°æ°æ®è¿è¡åç»ï¼ç»åä¸ªç»å»ºç«äºç®å½ï¼å å¿«å¯¹äºæ°æ®çæ¥è¯¢ã\n\nç°å¨æä»¬å°ç«å¨é¡µçå¤é¨ï¼ï¼ä¹å°±æ¯è¡¨çè§åº¦ï¼ç»é¡µå»ºç«ç®å½ï¼å å¿«æ¾å°ç®æ é¡µçéåº¦ã\n\nååè¿å¼ è¡¨ä¸­å¤æå¥å æ¡æ°æ®ï¼\n\n\n\nç°å¨å±æ4ä¸ªé¡µï¼æ¯ä¸ªé¡µæ3æ¡ç¨æ·è®°å½ã\n\nå ä¸ºè¿äº16kbçé¡µå¨ç©çå­å¨ä¸å¾å¯è½å¹¶ä¸æ¨çï¼æä»¥å¦ææ³ä»è¿ä¹å¤é¡µä¸­æ ¹æ®ä¸»é®å¼å¿«éå®ä½æäºè®°å½æå¨çé¡µï¼æä»¬å¯ä»¥æ ¹æ® ä¸»é®å¼-é¡µç  çæä¸ä¸ªç®å½ï¼è¿æ ·å°±å¯ä»¥æ ¹æ®ä¸»é®å¼å®ä½é¡µç äºãæ¯ä¸ä¸ªé¡µå¯¹åºä¸ä¸ªç®å½é¡¹ï¼æ¯ä¸ªç®å½é¡¹åå«ï¼é¡µç ãé¡µç å¯¹åºçé¡µä¸­æ°æ®çæå°ä¸»é®å¼ã\n\näºæ¯ï¼ä¸ä¸ªç´¢å¼éå½¢å°±åºç°äºï¼\n\n\n\n\n# 2.2 innodbçç´¢å¼æ¹æ¡\n\nä¸é¢å°èçæ é¢æ¯âä¸ä¸ªç®åçç´¢å¼æ¹æ¡âï¼æ¯å ä¸ºå®åªæ¯ä¸ä¸ªéå½¢ï¼è¿å·æå¾å¤ä¸å®å¤çå°æ¹ãå®å·æä»¥ä¸å ä¸ªç¼ºç¹ï¼\n\n 1. innodbæ¯ä½¿ç¨é¡µä½ä¸ºç®¡çå­å¨ç©ºé´çåºæ¬åä½ï¼ä¹å°±æ¯æå¤è½ä¿è¯16kbçè¿ç»­å­å¨ç©ºé´ï¼èéçè¡¨ä¸­è®°å½çå¢å¤ï¼éè¦éå¸¸å¤§çè¿ç»­çå­å¨ç©ºé´ï¼è¿æ¾ç¶æ¯ä¸ç°å®çã\n 2. æä»¬ç»å¸¸ä¼å¯¹æ°æ®è¿è¡å¢å æ¹ï¼åè®¾æä»¬æ24é¡µä¸­çæ°æ®å¨é½å é¤äºï¼é£ä¹24é¡µä¹å°±æ²¡æäºå­å¨çå¿è¦ï¼é£ä¹å¯¹åºçç®å½é¡¹ä¹å°±æ²¡æäºå­å¨çå¿è¦ï¼è¿çµæ¯å°é¡µãç®å½é¡¹çç§»å¨ï¼çµä¸åèå¨å¨èº«\n\næä»¥å¦ä½çµæ´»çç®¡çç®å½é¡¹æ¯ä¸ªé®é¢ï¼mysqlè®¾è®¡èå½ç¶æ³åºäºè§£å³è¿ä¸ªé®é¢çæ¹æ¡ï¼ç®å½é¡¹åæ ·ä½¿ç¨é¡µè¿è¡å­å¨ã\n\nä»ä»¬å¤ç¨äºå­å¨ç¨æ·æ°æ®çé¡µæ¥å­å¨ç®å½é¡¹ï¼ä¹å°±æ¯ç´¢å¼ï¼ãæä»¬å¯ä»¥åºå«çç§°å¼å¶ä¸ºï¼ç¨æ·è®°å½ãç´¢å¼è®°å½ï¼ç®å½é¡¹è®°å½ï¼ã\n\né£ä¹å¦ä½åºåä¸æ¡è®°å½æ¯ç¨æ·è®°å½è¿æ¯ç´¢å¼è®°å½å¢ï¼record_typeå±æ§ãrecord_typeåä¸ªåå¼ä»£è¡¨çææï¼\n\n * 0 ï¼ç¨æ·è®°å½\n * 1 ï¼ç®å½é¡¹è®°å½ï¼ç´¢å¼è®°å½ï¼\n * 2 ï¼æå°è®°å½\n * 3 ï¼æå¤§è®°å½\n\næä»¬å°ä¸è¿°å¾å®åä¸ä¸å°±æ¯ï¼\n\n\n\nè¿å¼ å¾ä½ ææ²¡ææè§åä»ä¹æ°æ®ç»æï¼b+æ ï¼\n\nä»å¾ä¸­æä»¬å¯ä»¥çåºï¼\n\n * å¶å­èç¹å­å¨ä¸»é®ä»¥åæ°æ®ï¼æ°æ®çrecord_typeä¸º0\n * éå¶å­èç¹åªå­å¨ä¸»é®+é¡µç®å½ï¼æ°æ®çrecord_typeä¸º1\n * æ¯ä¸å±çèç¹ï¼æ¯ä¸ä¸ªèç¹å³ä¸é¡µï¼ä½¿ç¨ååé¾è¡¨è¿æ¥ã\n\näºæ¯å½æä»¬æ¥è¯¢ä¸æ¡è®°å½æ¶å¯ä»¥åä¸ºä¸¤æ­¥ï¼\n\n 1. ç¡®å® ç®å½é¡¹è®°å½ é¡µï¼æ ¹æ®ä¸»é®ï¼ä½¿ç¨äºåæ³ç¡®å®è¿ä¸ªè®°å½å¤§æ¦å¤å¨åªä¸ªé¡µ\n 2. ç¡®å® è®°å½å¨åªä¸ªç»ï¼æ ¹æ®é¡µç®å½ï¼ä½¿ç¨äºåæ³çæ§½ä½ç¡®å®è¿ä¸ªè®°å½å¨åªä¸ªç»ï¼è¿èä»ç»ä¸­æ¾å°è¯¥æ°æ®ã\n\nä»å¤´å°å°¾é½æ¯äºåæ³ã\n\néè¦æ³¨æçæ¯ï¼æä»¬ä¸è¬ç¨ä¸ä¸ªé¡¶ç¹æ¥å­å¨ç®å½é¡¹è®°å½çé¡µãäºæ¯ä¸é¢é£å¼ å¾çæç»çä¸ºï¼\n\n\n\næ´åb+æ äº~\n\nåå¦ä¸ä¸ªé¡µå¯ä»¥æ1000ä¸ªå­é¡µï¼ä¹å°±æ¯ä¸é¡µä¸­æ1000æ¡è®°å½ï¼ï¼ä¸å±æ¯ä¸ä¸ªé¡µï¼ç¬¬äºå±å°±å¯ä»¥æ1000é¡µï¼ç¬¬ä¸å±å°±å¯ä»¥æ1000 * 1000 é¡µï¼æ¯ä¸é¡µæ1000æ¡æ°æ®ï¼é£ä¹ç¬¬ä¸å±å¯ä»¥æ 1000 * 1000 * 1000 æ¡æ°æ®ï¼æä»¥æä»¬çæ°æ®ç»å¤§å¤æ°åªæä¸¤~ä¸å±b+æ ã\n\næ³èµ·ä¹åèçé¢è¯é¢ï¼\n\nç¸æ¯äºäºåæ ï¼b+æ çå±çº§æ´ä½...(é¿å·´é¿å·´é¿å·´)\n\nç°å¨ç¥éå°åºä¸ºä»ä¹äºå§ã\n\nä½æ¯ç°å¨è¿æä¸ä¸ªé®é¢ï¼\n\nå¦ææä»¬ä¸º age åå»ºäºä¸ä¸ªäºçº§ç´¢å¼ï¼é£ä¹å¨b+æ çéå¶å­èç¹ä¸­çè®°å½å°±æ¯ï¼ageå¯¹åºé¡µç ãä½æ¯ageæ¯å¾å®¹æéå¤çï¼13è¿ä¸ªageæå¯è½å¯¹åºå¾å¤ä¸ªé¡µç ï¼è¿èåºç°äºè¿ç§æåµï¼age=13å¯¹åºäº 54ã32ã15è¿ä¸é¡µï¼åæå¥ä¸æ¡age=13çæ°æ®ï¼è¿æ¡æ°æ®è¯¥å¾åªä¸ªé¡µä¸­æå¥å¢ï¼\n\nä¸ºäºè®©æ°æå¥è®°å½è½æ¾å°èªå·±å¨é£ä¸ªé¡µéï¼æä»¬éè¦å¨è®°å½ä¸­åæ·»å ä¸ä¸ªå¯ä¸å­æ®µï¼ä»ä¹å­æ®µéååè¿ä¸ªå¯ä¸ç´¢å¼å¢ï¼ä¸»é®åã\n\næä»¥å¯¹äºäºçº§ç´¢å¼çåèç¹çç®å½é¡¹è®°å½çåå®¹å®éä¸æ¯ç±ä¸ä¸ªé¨åææç\n\n * å­æ®µå¼\n * å­æ®µå¯¹åºçä¸»é®å¼\n * é¡µç \n\n\n# 2.3 èç°ç´¢å¼\n\ninnodbçb+æ ç´¢å¼ä¹å¯ä»¥å¤§è´åä¸ºè¿ä¸¤ç±»ï¼èç°ç´¢å¼åäºçº§ç´¢å¼ã\n\nï¼åªæä¸»é®ä¼å»ºç«ä¸é¢èç°ç´¢å¼b+æ ï¼ä¸ç®¡æ¯å¯ä¸ç´¢å¼è¿æ¯èåç´¢å¼å·´æå·´æè¿äºå¶ä»çç´¢å¼é½æ¯äºçº§ç´¢å¼ï¼\n\nä¸è¿°å¾çæè¿°çæ¯èç°ç´¢å¼ï¼å¶å­èç¹ä¸­å­å¨çæ¯ ä¸»é®->æ°æ® ãï¼å­¦è¿çå¤§æ¦é½ç¥éï¼\n\n\n# 2.4 äºçº§ç´¢å¼\n\näºçº§ç´¢å¼çå¶å­èç¹ä¸­å­å¨çæ¯ å­æ®µå¼ -> ä¸»é®ã\n\nå¦ææ¥è¯¢äºçº§ç´¢å¼ï¼æ¿å°ä¸»é®åè¿éè¦å»èç°ç´¢å¼çb+æ ä¸­éè¿ä¸»é®æ¿å°å¨é¨æ°æ®ãè¿ä¹è¢«ç§°ä¸ºåè¡¨æ¥è¯¢ã\n\nèåç´¢å¼ï¼\n\nèåç´¢å¼å°±æ¯å¾å¤ä¸ªå­æ®µä¸èµ·å±ç¨åä¸é¢b+æ ã\n\nåå¦ä¸º idãnameãageå»ºç«èåç´¢å¼ idx_id_name_ageï¼é£ä¹å®ä»¬ä¸ä¸ªå­æ®µå°±ä¼ä½¿ç¨åä¸é¢b+æ ã\n\néè¿åæçå­¦ä¹ ï¼æä»¬ç¥éb+æ æ¯æç§ä¸å®é¡ºåºå­å¨æ°æ®çï¼ä¹å°±æ¯æåºçï¼èç°ç´¢å¼æç§ä¸»é®æåºï¼é£ä¹èåç´¢å¼å¢ï¼\n\nå¯¹äº idx_id_name_age è¿ä¸ªèåç´¢å¼æ¥è¯´ï¼é¡ºåºï¼æç§idæåºï¼idç¸ååæç§nameæåºï¼nameç¸ååæç§ageæåºã\n\n\n# 3. åè¡¨\n\n\n# 3.1 åè¡¨çä»£ä»·\n\nä¹åå¯¹äºåè¡¨è¿ä¸ªè¯é½æ¯ä¸å¸¦èè¿ï¼ä¸é¢è¯¦ç»è¯´ä¸ä¸ã\n\nåå¦å¯¹äº nameãbirthdayãphone_numå»ºç«äºä¸ä¸ªèåç´¢å¼ï¼idx_name_birthday_phone_numberã\n\nå¯¹äºä»¥ä¸sqlè¯­å¥ï¼\n\nselect * from person_info where name > 'xiaoming' and name < 'zengyi';\n\n\nå¨ä½¿ç¨èåç´¢å¼ idx_name_birthday_phone_numberæ¶å¯ä»¥åä¸ºè¿ä¸¤æ­¥ï¼\n\n * ä»ç´¢å¼ idx_name_birthday_phone_number ä¸­çb+æ ååºå¼å¨ xiaoming ~ zengyi çæ°æ®ã\n * ç±äºç´¢å¼åªæ name birthday phone_number è¿ä¸ä¸ªå­æ®µï¼èæ¥è¯¢åè¡¨ä¸­æ³è¦çæ¯ *ï¼æä»¥ä¼æ¿çä¸»é®idå»èç°ç´¢å¼ä¸­æ¿å¨é¨è®°å½ã\n\nç±äºç´¢å¼ idx_name_birthday å¯¹åºçb+æ çè®°å½ä¼é¦åæç§nameåçå¼è¿è¡æåºï¼æä»¥å¼å¨ xiaoming ~ zengyi ä¹é´çè®°å½å¨ç£çä¸­çå­å¨æ¶æ¯ç¸è¿çï¼æå¯è½å°±éä¸­åå¸å¨åä¸é¡µä¸­ï¼æä»¬å¯ä»¥ç´æ¥æ²¿çé¾è¡¨å°æ°æ®è¯»ååºæ¥ï¼è¿ä¸ªè¿ç¨ç§°ä¸ºé¡ºåºioãä½æ¯æ ¹æ®nameæ¿å°çidå¹¶ä¸ç¸è¿ï¼è½ç¶èç°ç´¢å¼ä¸­çidæ¯é¡ºåºçï¼ä½æ¯æä»¬æ ¹æ® name æ¿å°çidä¸ç¸è¿ï¼æä»¥åªè½å»ä¸åçé¡µå»æ¿æ°æ®ï¼è¿ç§è¯»åæ¹å¼è¢«ç§°ä¸ºéæºioãä¸è¬æåµä¸ï¼é¡ºåºioæ¯éæºioå¿«å¾å¤ï¼æä»¥è¿ä¸ªsqlè¯­å¥çä¸¤æ­¥å¶å®æ¯è¿æ ·çï¼\n\n * ä¼ç¨å°ä¸¤ä¸ªç´¢å¼ï¼èå(äºçº§)ç´¢å¼åèç°ç´¢å¼\n * è®¿é®äºçº§ç´¢å¼æ¶ä½¿ç¨é¡ºåºioï¼è®¿é®èç°ç´¢å¼æ¶ä½¿ç¨éæºioã\n\néè¦åè¡¨çè®°å½è¶å¤ï¼ä½¿ç¨äºçº§ç´¢å¼çæ§è½å°±è¶ä½ãçè³æäºæ¥è¯¢å®æ¿ç¨å¨è¡¨æ«æä¹ä¸ç¨äºçº§ç´¢å¼ã\n\nä¾å¦åæé£ä¸ªsqlæ¥åºçè®°å½å å°è¡¨ä¸­æ»è®°å½çï¼ï¼ï¼æ¶ï¼ççä¸å¦ç´æ¥å¨è¡¨æ«æã\n\né£ä¹ä»ä¹æ¶åä½¿ç¨ç´¢å¼ï¼ä»ä¹æ¶åå¨è¡¨æ«æå¢ï¼è¿æ¯æ¥è¯¢ä¼åå¨éè¦åçäºã\n\næ¥è¯¢ä¼åå¨ä¼æ ¹æ®ä¸æ¡ï½ï½ï½èµ°äºåªäºç´¢å¼å ç¨äºå¤å°æ§è½æ¥è®¡ç®åæ°ï¼æåä½¿ç¨åæ°æä½çé£ä¸ªsqlæèç´æ¥å¨è¡¨æ«æã\n\n\n# 3.2 è¦çç´¢å¼\n\nä¸ºäºåå°åè¡¨å¸¦æ¥çæ§è½æèï¼mysqlæ´å»ºè®®ï¼æ¥è¯¢åè¡¨å°½éåªåå«ç´¢å¼åã\n\nselectãname, birthday, phone_number  \nfrom person_info \nwhere name > 'xiaoming' and name < 'zengyi';\n\n\nåªè¦ä¸è®©å®åè¡¨ï¼å°±ä¸ä¼æåè¡¨çåå¤å¦~\n\n\n# 4. b+æ ç´¢å¼çä½¿ç¨\n\nåé¢ä¸¤èè¯¦ç»æè¿°äºb+æ çç»æï¼æ¸©æï¼\n\n * æ¯ä¸ä¸ªç´¢å¼é½å¯¹åºä¸ä¸ªb+æ ï¼b+æ çèç¹æ¯é¡µãéå¶å­èç¹å­å¨çæ¯ç®å½ï¼å¶å­èç¹å­å¨çæ¯æ°æ®ï¼èç°ç´¢å¼åäºçº§ç´¢å¼ä¸åï¼\n * b+æ çå¶å­èç¹ï¼é¡µï¼æç§ååé¾è¡¨è¿æ¥ï¼é¡µçåé¨ï¼å³æ°æ®ï¼æç§åé¾è¡¨é¡ºåºè¿æ¥ã\n\n\n\n\n# 4.1 ç´¢å¼çä»£ä»·\n\nå¨ä»ç»æ´å¥½çä½¿ç¨ç´¢å¼åè¯å®è¦ç¥é ä¸ºä»ä¹è¦æ´å¥½çä½¿ç¨ç´¢å¼ï¼å ä¸ºç´¢å¼ä¹æç¼ºç¹å~\n\n * ç©ºé´ä¸çä»£ä»· ï¼è¿ä¸ªæ¯æ¾èæè§çï¼æ¯å»ºç«ä¸ä¸ªç´¢å¼ï¼ç©ºé´ä¸­å°±å¤ä¸é¢b+æ ï¼b+æ çæ¯ä¸ä¸ªèç¹é½æ¯ä¸é¡µï¼ä¸é¡µ16kï¼å½ç¶å¾å ç©ºé´å½ã\n * æ¶é´ä¸çä»£ä»· ï¼ç´¢å¼ä¼åäºæ¥è¯¢æä½ï¼æ¯ç«ä½¿ç¨äºäºåæ¥æ¾ãä½æ¯å¨å¢å æ¹æä½æ¶ï¼ä¸ä»éè¦ä¿®æ¹æ°æ®é¡µï¼è¿éè¦ä¿®æ¹ç´¢å¼é¡µãï¼ä¸ä»è¦ä¿®æ¹å¶å­èç¹ï¼åè¦ä¿®æ¹éå¶å­èç¹ï¼ãæ¶ä¸æ¶è¿ä¼ä¼´éçé¡µåè£ãé¡µåæ¶ãè®°å½ç§»å¨çæä½ï¼è¿äºé½æ¯å¯¹æ¶é´çæ¶èã\n\næä»¥ï¼ä¸å¼ è¡¨ä¸ç´¢å¼å»ºç«çè¶å¤ï¼å°±ä¼å ç¨è¶å¤çå­å¨ç©ºé´ï¼å¨å¯¹æ°æ®å¢å æ¹æ¶çæ§è½å°±ä¼æ´å·®ã\n\n\n# 4.2 ç´¢å¼å¤±æçåºæ¯\n\nè¿ä¸ªç¥è¯ç¹æ³å¿å¤§å®¶é¢è¯é¢é½èçäºï¼é£ä¹ä½ ç¥é\n\n * ä¸ºä»ä¹ä¸ç¬¦åæå·¦åç¼å¹éååï¼ç´¢å¼å°±ä¼å¤±æåï¼\n * ä¸ºä»ä¹ä½¿ç¨ '%xxx'ï¼ç´¢å¼å°±ä¼å¤±æå\n\nä¸é¢æ¥çä¸ä¸ä¸ºä»ä¹ã\n\næä»¬å»ºç«ä¸å¼ è¡¨ï¼ä»¥ä¾¿åç»­ç¨å°ï¼\n\ncreate table person_info(     \n    id int not null auto_increment,     \n    name varchar(100) not null,     \n    birthday date not null,     \n    phone_number char(11) not null,     \n    country varchar(100) not null,     \n    primary key (id),     \n    key idx_name_birthday_phone_number (name, birthday, phone_number) \n);\n\n\nè¿å¼ è¡¨ä¸­å±æ5ä¸ªå­æ®µï¼å¶ä¸­idå­æ®µèªå¨çæä¸é¢èç°ç´¢å¼çb+æ ï¼nameãbirthdayãnumberè¿ä¸ä¸ªå­æ®µå±ç¨ä¸é¢b+æ ã\n\nç­ç­ï¼å¨ç»§ç»­åä¸çä¹åï¼ä½ éè¦åé¡¾ä¸ä¸ï¼\n\nå¯¹äºèåç´¢å¼ idx_name_birthday_phone_numberï¼æåºçè§åä¸ºï¼åæç§ name æåºï¼name ç¸ååæç§ birthday æåºï¼birthdayç¸ååæç§number æåºã\n\n# 4.2.1 æå·¦åç¼å¹é\n\næå·¦åç¼å¹éç¸æ¯å¤§å®¶é½ç¥éï¼å¯¹äºä¸ä¸ªèåç´¢å¼ï¼å¦ææä¸ä¸ªå­æ®µæ²¡æèµ°ç´¢å¼ï¼é£ä¹å®åé¢çææå­æ®µé½ä¸ä¼èµ°ç´¢å¼ã\n\nåºç°è¿ç§æåµçåå å°±æ¯èåç´¢å¼çæåºè§åï¼åæè¯´è¿ï¼æåºè§åæ¯æç§å·¦è¾¹çåæåºï¼å·¦è¾¹çåç¸ååæç§å³è¾¹çåæåºã\n\nç°å¨æ¥çä¸ä¸è¿å ç§æåµï¼\n\n 1. select * from person_info where name = 'xiaoming' and birthday = '2000-01-01';\n    \n    è¿ä¸ªä¼èµ°ç´¢å¼åï¼ä¼ï¼mysqlä¼å¨èåç´¢å¼çb+æ ä¸­æ¾å° xiaoming æå¨çé¡µï¼åæ¾å®æå¨çç»ï¼æåç¡®å®ç¬¬ä¸ä¸ªnameä¸ºxiaomingçå°æ¹ï¼åæ ¹æ®å·²ç»æå¥½åºç birthday è¿è¡é¡ºåºæ¥æ¾ï¼ç´è³æ¾å°ç®æ ãï¼æ¿å°è¯¥ç®æ çä¸»é®åå»èç°ç´¢å¼ä¸­åè¡¨æ¥è¯¢ï¼\n\n 2. select * from person_info where birthday = '2000-01-01';\n    \n    è¿ä¸ªä¼èµ°ç´¢å¼åï¼ä¸ä¼ï¼å ä¸ºbirthdayæå¨çç´¢å¼é¦åæç§nameè¿è¡æåºï¼åæç§birthdayæåºãé½ä¸æbirthdayæåºäºï¼æä¹èµ°ç´¢å¼ï¼\n\n 3. select * from person_info where name < 'xiaoming' and name > 'xiaohong' and birthday = '2002-01-01';\n    \n    è¿ä¸ªä¼èµ°å ä¸ªç´¢å¼ï¼ä¸ä¸ªnameçç´¢å¼ï¼ä¸ºä»ä¹å¢ï¼æä»¬æ ¹æ®nameèµ°äºç´¢å¼ä¹åè·å¾äºä¸ä¸ªèå´å¼ï¼é£ä¹è¿ä¸ªèå´ä¹å¯è½å¦ä¸æç¤ºï¼\n    \n    xiaohong 1998-03-12\n    \n    xiaohong 2002-01-01\n    \n    xiaohong 2005-08-09\n    \n    xiaoming 2001-10-02\n    \n    xiaoming 2002-09-13\n    \n    å¯ä»¥çå°ï¼è½ç¶æç§nameæå¥½åºäºï¼ä½æ¯birthdayå¹¶æ²¡æé¡ºåºå¯è¨ï¼ä¹å°±æ æ³èµ°ç´¢å¼ï¼åªè½åæ¿å°ä¸»é®idï¼å»èç°ç´¢å¼ä¸­æ¿å°å¯¹åºæ°æ®ååå¤æ­ä¸ä¸è¿äºæ°æ®çbirthdayæ¯å¦ä¸º 2002-01-01ã\n    \n    ä¸ä»ä»æ¯ç­å¼å¹éãèå´å¹éä¼ä½¿ç¨æå·¦åç¼å¹éï¼åç»æä½ä¹ä¼ä½¿ç¨æå·¦åç¼å¹éååï¼æä»¥åç»æ¶ä¹è¦æ³¨æå¦ã\n\n# 4.2.2 æ¨¡ç³æ¥è¯¢\n\nå¨è¿è¡æ¨¡ç³æ¥è¯¢æ¶ï¼'xx%'å'x%x' é½ä¸ä¼å¤±æï¼è'%xxx'å°±ä¼å¯¼è´ç´¢å¼å¤±æã\n\nä¸ºå¥ï¼åä¸¤ä¸ªæèµ·ç ç¬¬ä¸ä¸ªä¸ºxï¼mysqlå¯ä»¥å¨ç´¢å¼ä¸­æ¾å°ç¬¬ä¸ä¸ªå­ç¬¦ä¸ºxçæ°æ®ï¼è¿æ ·å³ä½¿ä¸è½æç»ç¡®å®æåªäºæ°æ®ä¹è½ç­éæä¸å°çæ°æ®äºã\n\nä½æ¯ç»æä¸ª '%xx' æ¯ä»ä¹ææï¼ç¬¬ä¸ä¸ª '%' ä½ æ³è®©ææä¹å¹éæä¹æåºï¼è¯å®èµ°ä¸äºç´¢å¼å~\n\n4.2.3 æåº\n\næåºä¼åºç°ä»ä¹é®é¢å¢ï¼\n\nmysqlè§å®ï¼å¯¹äºä½¿ç¨èåç´¢å¼çåºæ¯ï¼è¦æ±åä¸ªæåºåçæåºé¡ºåºæ¯ä¸è´çï¼ä¹å°±æ¯è¦åä¸ªåè¦ä¹å¨é¨éåºï¼è¦ä¹å¨é¨ååºã\n\nä¸ºä»ä¹å¢ï¼\n\nåå¦æä¸ä¸sqlè¯­å¥ï¼\n\nselect * from person_info  order by name asc, birthday desc limit 10;\n\n\nè¿å¥sqlçä½ç¨ï¼\n\n * åä»ç´¢å¼çæå·¦è¾¹ç¡®å® name åæå°çå¼ï¼ç¶åä»nameåçæå³è¾¹é£æ¡è®°å½ä»å³åå·¦æ¾10æ¡(å ä¸ºè¦æ±æ¯birthdayéåº)\n * å¦ææ­¤nameåä¸è¶³10æ¡ï¼é£ä¹å°±è¦å»ä¸ä¸ä¸ªnameåä¸­éå¤ä¸è¿°æä½ã\n\nè¿æ ·éå¸¸éº»ç¦ï¼èä¸ä¸è½é«æå©ç¨ç´¢å¼ï¼æä»¥mysqlå°±è§å® ä½¿ç¨èåç´¢å¼çåä¸ªæåºé¡ºåºé½å¿é¡»æ¯ä¸è´çã\n\n# 4.2.4 è¿ç®ä¸å½æ°\n\nè¦æ³ä½¿ç¨ç´¢å¼è¿è¡æåºæä½ï¼å¿é¡»ä¿è¯ç´¢å¼åæ¯ä»¥åç¬åçå½¢å¼åºç°ï¼èä¸æ¯ä¿®é¥°è¿çå½¢å¼ã\n\nå ä¸ºwhere æ¡ä»¶å­æ®µç±»åä¸å®éè¡¨ä¸­å­æ®µç±»åä¸å¹éæ¶ï¼mysqlä¼è¿è¡éå¼çç±»åè½¬æ¢ï¼èç±»åè½¬æ¢ä¼ç¨å°åç½®å½æ°ï¼å¯¼è´å¨æ¥è¯¢æ¶æ²¡æèµ°ç´¢å¼ã\n\n# 4.2.5 or\n\næä»¬ææ¶åä¼ç¨å°orï¼select * from user where age = 18 or age = 20;\n\norå·¦å³çå­æ®µå¿é¡»é½å ç´¢å¼æä¼çæã\n\n\n# 5. å¦ä½æéç´¢å¼\n\n\n# 5.1 å¸¸ç¨äºæç´¢ãæåºãåç»çå\n\nä¸ºå¸¸ç¨äºæç´¢ãæåºãåç»çååå»ºç´¢å¼ï¼ä¹å°±æ¯è¯´ï¼åªä¸ºåºç°å¨ where å­å¥ä¸­çååå»ºç´¢å¼ï¼åºç°å¨æ¥è¯¢åè¡¨ä¸­çå°±æ²¡å¿è¦äºï¼å ä¸ºåè¡¨åèªç¶è½æ¥åºæ¥ï¼ã\n\nä¸é¢è¿ä¸å¥ï¼æä»¬ä¸ºnameåå»ºç´¢å¼ï¼èä¸ä¸ºbirthdayåcountryåå»ºç´¢å¼ã\n\nselect birthday, country from person_info where name='xxx';\n\n\n# 5.2 èèåçåºæ°\n\nä»ä¹æ¯åºæ°ï¼ä¸å¼ è¡¨æ10000æ¡æ°æ®ï¼å®çæ¯ä¸åçåºæ°ä¸æ ·åï¼\n\nä¸æ¯ï¼å¦ææ¯idå­æ®µï¼10000æ¡æ°æ®å¯è½idé½ä¸ä¸æ ·ãå¦ææ¯ageå¢ï¼å¦ææ¯åæ°å¢ï¼\n\næä»¥åºæ°æ¯æä¸ç¸åçä¸ªæ°ï¼æä»¬åºè¯¥å°½éæéåºæ°å¤§çåå»ºç«ç´¢å¼ã\n\nï¼åé£äºæ§å«ãç¶æå°±ä¸è¦åå»ºç´¢å¼ï¼ä½æ¯å¦æç»å¸¸ç¨äºåç»çè¯ä¹å¯ä»¥èèï¼ã\n\n\n# 5.3 ä¸»é®æå¥é¡ºåº\n\nä¸»é®æå¥é¡ºåºå°½ééå¢ï¼å¹¶ä¸å°½éä¸è¦è®©ä¸»é®åæ´ãæä»¥ä¸»é®å°½éè®¾ç½®ä¸ºæ æä¹ä¸èªå¢çãé²æ­¢é¡µåè£ãè®°å½éæåº....é æçæ§è½æèã\n\nâ",charsets:{cjk:!0},lastUpdated:"2023/06/14, 19:46:55",lastUpdatedTimestamp:1686743215e3},{title:"Redisä¸»ä»éç¾¤åç",frontmatter:{title:"Redisä¸»ä»éç¾¤åç",date:"2023-07-01T14:55:03.000Z",permalink:"/pages/db45e7/"},regularPath:"/02.%E6%96%87%E7%AB%A0/10.Redis/40.Redis%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86.html",relativePath:"02.æç« /10.Redis/40.Redisä¸»ä»éç¾¤åç.md",key:"v-6890b777",path:"/pages/db45e7/",headers:[{level:2,title:"1. Redisä¸»ä»æ¦å¿µ",slug:"_1-redisä¸»ä»æ¦å¿µ",normalizedTitle:"1. redisä¸»ä»æ¦å¿µ",charIndex:2},{level:2,title:"2. å¨éåæ­¥",slug:"_2-å¨éåæ­¥",normalizedTitle:"2. å¨éåæ­¥",charIndex:706},{level:2,title:"3. å¢éåæ­¥",slug:"_3-å¢éåæ­¥",normalizedTitle:"3. å¢éåæ­¥",charIndex:1543},{level:2,title:"4. æ ç£çå¤å¶",slug:"_4-æ ç£çå¤å¶",normalizedTitle:"4. æ ç£çå¤å¶",charIndex:2148},{level:2,title:"5. ä¸»ä»åæ­¥æ³¨æäºé¡¹",slug:"_5-ä¸»ä»åæ­¥æ³¨æäºé¡¹",normalizedTitle:"5. ä¸»ä»åæ­¥æ³¨æäºé¡¹",charIndex:2276}],headersStr:"1. Redisä¸»ä»æ¦å¿µ 2. å¨éåæ­¥ 3. å¢éåæ­¥ 4. æ ç£çå¤å¶ 5. ä¸»ä»åæ­¥æ³¨æäºé¡¹",content:"# 1. Redisä¸»ä»æ¦å¿µ\n\nåæºçRedisè½å¤æ¿è½½çQPSå¤§æ¦æ¯å ä¸å·¦å³ãå¯¹äºç¼å­æ¥è¯´ï¼ä¸è¬é½æ¯ç¨æ¥æ¯æè¯»é«å¹¶åçï¼å æ­¤æ¶æåæä¸»ä»(master-slave)ç»æï¼ä¸ä¸»å¤ä»ï¼ä¸»èç¹è´è´£åï¼ä»èç¹è´è´£è¯»ï¼ä¸»èç¹åä¹åå°æ°æ®åæ­¥å°ä»èç¹ãææçè¯»è¯·æ±å¨é¨èµ°ä»èç¹ï¼è¿æ ·ä¹å¯ä»¥å¾è½»æ¾å®ç°æ°´å¹³æ©å±ï¼æ¯æè¯»é«å¹¶åã\n\nå¹¶ä¸å¨é¢è¯ä¸­ç»å¸¸ä¼åºç° âä½ æ¯å¦äºè§£Redisé«å¯ç¨â è¿ç±»é¢è¯é¢ï¼Redisé«å¯ç¨åç­åæ¬ä¸¤ä¸ªæ¹é¢ï¼ä¸ä¸ªå°±æ¯æ°æ®ä¸è½ä¸¢å¤±ï¼æèè¯´å°½éåå°ä¸¢å¤±ï¼å¦ä¸ä¸ªå°±æ¯ä¿è¯Redisæå¡ä¸ä¸­æ­ã\n\n * å¯¹äºå°½éåå°ä¸¢å¤±ï¼å¯ä»¥éè¿AOFåRDBæ°æ®æä¹åä¿è¯ã\n * å¯¹äºä¿è¯æå¡ä¸ä¸­æ­ï¼Rediså°±ä¸è½åç¹é¨ç½²ï¼è¿æ¶åå°±éè¦ä½¿ç¨Redisä¸»ä»ã\n\n> æä¹è¿è¡æ°æ®åæ­¥ï¼\n> \n> æ³è¦åæ°æ®åæ­¥ï¼é¦åè¦æå¨é¨æ°æ®ï¼é£ä¹åªä¸ªå°æ¹è®°è½½äºRedisçå¨é¨æ°æ®å¢ï¼ä½ æ¯å¦è¿è®°å¾RedisçRDBæä¹åæ¹å¼ï¼å®ä¼å°æææ°æ®è®°å½å¨rdbæä»¶ä¸­ï¼æä»¬å¯ä»¥å©ç¨è¿ä¸ªæ¥å¿æ¥è¿è¡æ°æ®çåæ­¥ï¼å½ä¸»èç¹æ³è¦è¿è¡æ°æ®åæ­¥æ¶ï¼ç´æ¥å°RDBæä»¶ç©ç»ä»ä»èç¹å°±è¡äº~\n> \n> ï¼å½ç¶âå¨é¨ç©è¿å»âåªæ¯ä¸ä¸ªææ³ï¼Redisæä¸ä¼ä½¿ç¨è¿ç§æè ¢çæ¹å¼ï¼\n\nRedisæ¯ç«æ¯ä¸ªæ°æ®åºï¼æ³è¦å®ç°åä¸»è¯»ä»çæ¨¡å¼å°±éè¦è¿è¡æ°æ®åæ­¥ï¼å°åå°ä¸»èç¹çæ°æ®åæ­¥å°ä»èç¹ãæ°æ®åæ­¥çè¿ç¨æ¯æä»¬ä¸»è¦æ³è§£å³çé®é¢ï¼Rediså°æ°æ®çåæ­¥æ¹å¼åä¸ºä¸¤ç§ï¼å¨éåæ­¥ãå¢éåæ­¥ã\n\n * å¨éåæ­¥ ï¼å¤§é¨åç¨äºä»èç¹ç¬¬ä¸æ¬¡è¿æ¥å°ä¸»èç¹æ¶éè¦æ¿å°ä¸»èç¹çå¨é¨æ°æ®ã\n * å¢éåæ­¥ ï¼å¨éåæ­¥åè¿ä¼æåç»­çæ°æ®åå¥ä¸»èç¹ï¼è¿äºåç»­å¢å çæ°æ®çåæ­¥å°±å«åå¢éåæ­¥ã\n\n\n# 2. å¨éåæ­¥\n\nå¨éåæ­¥åæè§£éè¿äºï¼å°±æ¯Redisä¸»èç¹æå¨é¨çæ°æ®é½ä¸¢ç»ä»èç¹ï¼ä¹å°±æ¯RDBæä»¶çå¨é¨åå®¹ã\n\nä»ä¹æ¶åä¼åçå¨éåæ­¥å¢ï¼è¯å®æ¯ä»èç¹ç¬¬ä¸æ¬¡è¿æ¥å°å°ä¸»èç¹çæ¶åå¦ï¼ä½æ¯åªæè¿ä¸ä¸ªåºæ¯åï¼ä¸ï¼æä¸¤ç§æåµä¼è§¦åå¨éåæ­¥ï¼\n\n 1. ä»èç¹ç¬¬ä¸æ¬¡è¿æ¥ä¸»èç¹ã\n 2. ä»èç¹å®æºæ¶é´å¤ªä¹ï¼æ æ³è¿è¡å¢éåæ­¥ã\n\nåæ¥å­¦ä¹ ä¸ä¸å¨éåæ­¥å§ï¼å¨éåæ­¥åä¸ºä¸ä¸ªé¶æ®µï¼\n\n 1. ä¸»ä»ä¹é´å»ºç«è¿æ¥ã\n 2. ä¸»èç¹ææ°æ®åæ­¥å°ä»èç¹ã\n 3. ä¸»èç¹ææ°åçå½ä»¤åéå°ä»èç¹ã\n\nç¬¬ä¸ä¸ªé¶æ®µï¼ä¸»ä»ä¹é´å»ºç«è¿æ¥\n\næ ¹æ®ç»éªï¼ä¸»ä»ä¹é´å»ºç«è¿æ¥çè¿ç¨è¯å®ä¸ä»ä»æ¯å»ºç«è¿æ¥è¿ä¹ç®åï¼å®ä¿©è¯å®è¦äº¤æ¢ä¸äºä¿¡æ¯ã\n\n * ä»èç¹åépsyncå½ä»¤ï¼åè¯ä¸»èç¹èªå·±æ³è¦æä¸ºå®çä»èç¹ï¼è¿ä¸ªå½ä»¤ä¸­åå«èªå·±çrunIDï¼ä¸»èç¹åç°è¿ä¸ªrunIDä¸èªå·±çrunIDä¸ä¸è´ï¼å®å°±æè¯å°è¿ä¸ªå®¶ä¼æ¯ç¬¬ä¸æ¬¡åæ­¥ï¼éè¦è¿è¡å¨éåæ­¥ã\n * äºæ¯ä¸»èç¹ååºfullresyncå½ä»¤åè¯ä»èç¹è®©å®è¿è¡å¨éåæ­¥ï¼è¿ä¸ªå½ä»¤ä¸­åå«ä¸»èç¹çrunIDä¸ç®åRDBçå¤å¶è¿åº¦offsetï¼åérunIDæ¯ä¸ºäºè®©ä»èç¹ä¹ä½¿ç¨è¿ä¸ªrunIDï¼ä¸ä¸æ¬¡æ¥çæ¶åå°±ç¥éå®æ¯ä¸æ¯ç¬¬ä¸æ¬¡è¿æ¥äºï¼åéoffsetæ¯ä¸ºäºåè¯ä»èç¹ä½ ç¬¬ä¸æ¬¡å°±å¤å¶RDBæä»¶çè¿ä¸ªå°æ¹æ°æ®ã\n\n\n\nç¬¬äºä¸ªé¶æ®µï¼ä¸»èç¹ææ°æ®åæ­¥å°ä»èç¹\n\n * é¦åä¸»èç¹ä¼ä½¿ç¨bgsaveå½ä»¤çæRDBæä»¶ï¼å°RDBæä»¶åéç»ä»èç¹\n * ä»èç¹æ¶å°RDBæä»¶åä¼åæ¸ç©ºå½åçå¨é¨æ°æ®ï¼æ¯ç«ä½ è¦è·ä¸»èç¹çæ°æ®ä¸è´ï¼é£ä¹ä½ åæ¥çæ°æ®ä½ å°±è¦å é¤ï¼ä¹åå°±æç§offsetå è½½RDBæä»¶\n * ä¸»èç¹æRDBæä»¶åéç»ä»èç¹è¿è¡åæ­¥çè¿ç¨æ¯å¼æ­¥çï¼ä¸»èç¹è¿æå¯è½æ¥æ¶å°æ°çæ°æ®åå¥ï¼äºæ¯å®æè¿äºæ°æ®è®°å½å¨æ¥å¿æä»¶repl_baklogä¸­\n\n\n\nç¬¬ä¸ä¸ªé¶æ®µï¼ä¸»èç¹ææ°åçå½ä»¤åéå°ä»èç¹ã\n\n * ä¸»èç¹å°repl_baklogåéç»ä»èç¹ï¼ä»èç¹ç»§ç»­å°åå®¹åå¥ã\n\n\n\n\n# 3. å¢éåæ­¥\n\nå¨éåæ­¥å®è¿è¡äºä¸æ®µæ¶é´åï¼ä¸»ä»äº§çäºä¸ä¸è´æ»ä¸è½åè¿è¡ä¸æ¬¡å¨éåæ­¥å§ï¼è¿æ¶å°±éè¦ä½¿ç¨å¢éåæ­¥ã\n\nä»Redis2.8å¼å§æ¯æå¢éåæ­¥ï¼èä¸æ¯æ­ç¹ç»­ä¼ çå¢éå¤å¶ï¼ä¹å°±æ¯è¯´å¦æåºç°ç½ç»å»¶è¿æèä»èç¹å®æºå¯¼è´å¤å¶ä¸­æ­çæåµï¼å¨ç³»ç»æ¢å¤åä»ç¶å¯ä»¥ä»ä¸æ¬¡åæ­¥çå°æ¹å¼å§åæ­¥ã\n\nå®çåçæ¯ä¸»ä»é½ç»´æ¤ä¸ä¸ªoffsetï¼å¤å¶åç§»éï¼ï¼master_offsetãslave_offsetï¼ä¸»èç¹æ¯ä¸æ¬¡é½å°ä» slave_offset å° master_offsetçæ°æ®ä¼ è¾ç»ä»èç¹ï¼ä»ä¹ï¼æ²¡æ¶å°ï¼é£å°±éæ°ä»slave_offsetä¼ ã\n\noffsetè®°å½çä¸»ä»èç¹å¨repl_baklogæ¥å¿ä¸­çåç§»éï¼repl_baklogå®éä¸å°±æ¯ä¸»ä¸ä»ä¹é´æ°æ®å·®å¼çç¼å²åºï¼å®æ¯ä¸ä¸ªå¤§å°åºå®çæä»¶ï¼åå¦å®æ¯1024kï¼ç°å¨offsetå°äºç¬¬1024kçä½ç½®ï¼ä¸ä¸æ¬¡å®ä¼è¦çåé¢çæ°æ®ã\n\nè¿æ ·æ¯æå±é©çï¼å¦å¾ï¼\n\næ­£å¸¸æåµä¸ï¼slaveä¸masterä¹é´çå·®è·å¹¶ä¸å¤ï¼æ¯å¯ä»¥ä½¿ç¨å¢éåæ­¥ä¿è¯æ°æ®ä¸è´æ§ã\n\n\n\nä½æ¯ä¸ä¸slaveå®æºï¼masterä¸­çæ°æ®æ¯slaveæ°æ®æ´æ´å¤äºä¸ä¸ªâç¯âï¼é£ä¹å°±æ æ³è¿è¡å¢éåæ­¥äºã\n\n\n\nè¿æ¶å°±éè¦éæ°è¿è¡å¨éå¤å¶ï¼ä¹å°±æ¯ç¬¬äºç§è¿è¡å¨éåæ­¥çæåµï¼ï¼èå¨éå¤å¶éå¸¸æèæ§è½ï¼æä»¥æä»¬è¦ æé«repl_baklogçå¤§å°å¹¶ä¸å½ä»èç¹å®æºæ¶å°½å¿«æ¢å¤ï¼åå°å¨éåæ­¥çåºç°ã\n\n\n# 4. æ ç£çå¤å¶\n\nå¨éåæ­¥åå¢éåæ­¥é½æ¯åºäºRDBæä»¶çï¼éè¦è¿è¡ç£çIOï¼ä½æ¯æä»¬å¯ä»¥å¼å¯æ ç£çåæ­¥ï¼è¿å°±ä¸ä¼çæRDBæä»¶ï¼èæ¯æRDBæä»¶ä¸­çåå®¹ä¸ä¿å­å¨ç£çä¸­ï¼ç´æ¥å¨åå­ä¸­åéç»ä»èç¹ã\n\nrepl-diskless-sync yes\n\n\n\n# 5. ä¸»ä»åæ­¥æ³¨æäºé¡¹\n\nä¸»ä»æ¨¡å¼è§£å³äºæ°æ®å¤ä»½åæ§è½çé®é¢ï¼ä½æ¯è¿æ¯å­å¨ä¸äºé®é¢ï¼\n\n 1. ç¬¬ä¸æ¬¡å»ºç«è¿æ¥æ¶ä¸å®æ¯å¨éåæ­¥ï¼åæ­¥çèæ¶æ¯è¾ä¹ï¼æ­¤æ¶åºè¯¥é¿å¼Redisæä¾æå¡çé«å³°æã\n 2. å¦ææå¤ä¸ªä»èç¹éè¦å»ºç«è¿æ¥ï¼å¯ä»¥èèå°å ä¸ªä»èç¹éå¼æ¶é´æ®µï¼é¿åä¸»èç¹åå­å ç¨è¿å¤ãæ­¤å¤å¦æä»èç¹å¤ªå¤ï¼ä¹å¯ä»¥è°æ´ä¸»ä»å¤å¶çç»æï¼ä½¿å¶åä¸ºæ ç¶ç»æã\n 3. å¨ä¸ä¸»ä¸ä»æèä¸ä¸»å¤ä»çæåµä¸ï¼å¦æä¸»æå¡å¨æäºï¼å¯¹å¤æä¾çæå¡å°±ä¸å¯ç¨äºï¼åç¹é®é¢æ²¡æè§£å³ãæä»¥ä¼åºç°åé¢çå¨åµéç¾¤æ¨¡å¼ã",normalizedContent:"# 1. redisä¸»ä»æ¦å¿µ\n\nåæºçredisè½å¤æ¿è½½çqpså¤§æ¦æ¯å ä¸å·¦å³ãå¯¹äºç¼å­æ¥è¯´ï¼ä¸è¬é½æ¯ç¨æ¥æ¯æè¯»é«å¹¶åçï¼å æ­¤æ¶æåæä¸»ä»(master-slave)ç»æï¼ä¸ä¸»å¤ä»ï¼ä¸»èç¹è´è´£åï¼ä»èç¹è´è´£è¯»ï¼ä¸»èç¹åä¹åå°æ°æ®åæ­¥å°ä»èç¹ãææçè¯»è¯·æ±å¨é¨èµ°ä»èç¹ï¼è¿æ ·ä¹å¯ä»¥å¾è½»æ¾å®ç°æ°´å¹³æ©å±ï¼æ¯æè¯»é«å¹¶åã\n\nå¹¶ä¸å¨é¢è¯ä¸­ç»å¸¸ä¼åºç° âä½ æ¯å¦äºè§£redisé«å¯ç¨â è¿ç±»é¢è¯é¢ï¼redisé«å¯ç¨åç­åæ¬ä¸¤ä¸ªæ¹é¢ï¼ä¸ä¸ªå°±æ¯æ°æ®ä¸è½ä¸¢å¤±ï¼æèè¯´å°½éåå°ä¸¢å¤±ï¼å¦ä¸ä¸ªå°±æ¯ä¿è¯redisæå¡ä¸ä¸­æ­ã\n\n * å¯¹äºå°½éåå°ä¸¢å¤±ï¼å¯ä»¥éè¿aofårdbæ°æ®æä¹åä¿è¯ã\n * å¯¹äºä¿è¯æå¡ä¸ä¸­æ­ï¼rediså°±ä¸è½åç¹é¨ç½²ï¼è¿æ¶åå°±éè¦ä½¿ç¨redisä¸»ä»ã\n\n> æä¹è¿è¡æ°æ®åæ­¥ï¼\n> \n> æ³è¦åæ°æ®åæ­¥ï¼é¦åè¦æå¨é¨æ°æ®ï¼é£ä¹åªä¸ªå°æ¹è®°è½½äºredisçå¨é¨æ°æ®å¢ï¼ä½ æ¯å¦è¿è®°å¾redisçrdbæä¹åæ¹å¼ï¼å®ä¼å°æææ°æ®è®°å½å¨rdbæä»¶ä¸­ï¼æä»¬å¯ä»¥å©ç¨è¿ä¸ªæ¥å¿æ¥è¿è¡æ°æ®çåæ­¥ï¼å½ä¸»èç¹æ³è¦è¿è¡æ°æ®åæ­¥æ¶ï¼ç´æ¥å°rdbæä»¶ç©ç»ä»ä»èç¹å°±è¡äº~\n> \n> ï¼å½ç¶âå¨é¨ç©è¿å»âåªæ¯ä¸ä¸ªææ³ï¼redisæä¸ä¼ä½¿ç¨è¿ç§æè ¢çæ¹å¼ï¼\n\nredisæ¯ç«æ¯ä¸ªæ°æ®åºï¼æ³è¦å®ç°åä¸»è¯»ä»çæ¨¡å¼å°±éè¦è¿è¡æ°æ®åæ­¥ï¼å°åå°ä¸»èç¹çæ°æ®åæ­¥å°ä»èç¹ãæ°æ®åæ­¥çè¿ç¨æ¯æä»¬ä¸»è¦æ³è§£å³çé®é¢ï¼rediså°æ°æ®çåæ­¥æ¹å¼åä¸ºä¸¤ç§ï¼å¨éåæ­¥ãå¢éåæ­¥ã\n\n * å¨éåæ­¥ ï¼å¤§é¨åç¨äºä»èç¹ç¬¬ä¸æ¬¡è¿æ¥å°ä¸»èç¹æ¶éè¦æ¿å°ä¸»èç¹çå¨é¨æ°æ®ã\n * å¢éåæ­¥ ï¼å¨éåæ­¥åè¿ä¼æåç»­çæ°æ®åå¥ä¸»èç¹ï¼è¿äºåç»­å¢å çæ°æ®çåæ­¥å°±å«åå¢éåæ­¥ã\n\n\n# 2. å¨éåæ­¥\n\nå¨éåæ­¥åæè§£éè¿äºï¼å°±æ¯redisä¸»èç¹æå¨é¨çæ°æ®é½ä¸¢ç»ä»èç¹ï¼ä¹å°±æ¯rdbæä»¶çå¨é¨åå®¹ã\n\nä»ä¹æ¶åä¼åçå¨éåæ­¥å¢ï¼è¯å®æ¯ä»èç¹ç¬¬ä¸æ¬¡è¿æ¥å°å°ä¸»èç¹çæ¶åå¦ï¼ä½æ¯åªæè¿ä¸ä¸ªåºæ¯åï¼ä¸ï¼æä¸¤ç§æåµä¼è§¦åå¨éåæ­¥ï¼\n\n 1. ä»èç¹ç¬¬ä¸æ¬¡è¿æ¥ä¸»èç¹ã\n 2. ä»èç¹å®æºæ¶é´å¤ªä¹ï¼æ æ³è¿è¡å¢éåæ­¥ã\n\nåæ¥å­¦ä¹ ä¸ä¸å¨éåæ­¥å§ï¼å¨éåæ­¥åä¸ºä¸ä¸ªé¶æ®µï¼\n\n 1. ä¸»ä»ä¹é´å»ºç«è¿æ¥ã\n 2. ä¸»èç¹ææ°æ®åæ­¥å°ä»èç¹ã\n 3. ä¸»èç¹ææ°åçå½ä»¤åéå°ä»èç¹ã\n\nç¬¬ä¸ä¸ªé¶æ®µï¼ä¸»ä»ä¹é´å»ºç«è¿æ¥\n\næ ¹æ®ç»éªï¼ä¸»ä»ä¹é´å»ºç«è¿æ¥çè¿ç¨è¯å®ä¸ä»ä»æ¯å»ºç«è¿æ¥è¿ä¹ç®åï¼å®ä¿©è¯å®è¦äº¤æ¢ä¸äºä¿¡æ¯ã\n\n * ä»èç¹åépsyncå½ä»¤ï¼åè¯ä¸»èç¹èªå·±æ³è¦æä¸ºå®çä»èç¹ï¼è¿ä¸ªå½ä»¤ä¸­åå«èªå·±çrunidï¼ä¸»èç¹åç°è¿ä¸ªrunidä¸èªå·±çrunidä¸ä¸è´ï¼å®å°±æè¯å°è¿ä¸ªå®¶ä¼æ¯ç¬¬ä¸æ¬¡åæ­¥ï¼éè¦è¿è¡å¨éåæ­¥ã\n * äºæ¯ä¸»èç¹ååºfullresyncå½ä»¤åè¯ä»èç¹è®©å®è¿è¡å¨éåæ­¥ï¼è¿ä¸ªå½ä»¤ä¸­åå«ä¸»èç¹çrunidä¸ç®årdbçå¤å¶è¿åº¦offsetï¼åérunidæ¯ä¸ºäºè®©ä»èç¹ä¹ä½¿ç¨è¿ä¸ªrunidï¼ä¸ä¸æ¬¡æ¥çæ¶åå°±ç¥éå®æ¯ä¸æ¯ç¬¬ä¸æ¬¡è¿æ¥äºï¼åéoffsetæ¯ä¸ºäºåè¯ä»èç¹ä½ ç¬¬ä¸æ¬¡å°±å¤å¶rdbæä»¶çè¿ä¸ªå°æ¹æ°æ®ã\n\n\n\nç¬¬äºä¸ªé¶æ®µï¼ä¸»èç¹ææ°æ®åæ­¥å°ä»èç¹\n\n * é¦åä¸»èç¹ä¼ä½¿ç¨bgsaveå½ä»¤çærdbæä»¶ï¼å°rdbæä»¶åéç»ä»èç¹\n * ä»èç¹æ¶å°rdbæä»¶åä¼åæ¸ç©ºå½åçå¨é¨æ°æ®ï¼æ¯ç«ä½ è¦è·ä¸»èç¹çæ°æ®ä¸è´ï¼é£ä¹ä½ åæ¥çæ°æ®ä½ å°±è¦å é¤ï¼ä¹åå°±æç§offsetå è½½rdbæä»¶\n * ä¸»èç¹ærdbæä»¶åéç»ä»èç¹è¿è¡åæ­¥çè¿ç¨æ¯å¼æ­¥çï¼ä¸»èç¹è¿æå¯è½æ¥æ¶å°æ°çæ°æ®åå¥ï¼äºæ¯å®æè¿äºæ°æ®è®°å½å¨æ¥å¿æä»¶repl_baklogä¸­\n\n\n\nç¬¬ä¸ä¸ªé¶æ®µï¼ä¸»èç¹ææ°åçå½ä»¤åéå°ä»èç¹ã\n\n * ä¸»èç¹å°repl_baklogåéç»ä»èç¹ï¼ä»èç¹ç»§ç»­å°åå®¹åå¥ã\n\n\n\n\n# 3. å¢éåæ­¥\n\nå¨éåæ­¥å®è¿è¡äºä¸æ®µæ¶é´åï¼ä¸»ä»äº§çäºä¸ä¸è´æ»ä¸è½åè¿è¡ä¸æ¬¡å¨éåæ­¥å§ï¼è¿æ¶å°±éè¦ä½¿ç¨å¢éåæ­¥ã\n\nä»redis2.8å¼å§æ¯æå¢éåæ­¥ï¼èä¸æ¯æ­ç¹ç»­ä¼ çå¢éå¤å¶ï¼ä¹å°±æ¯è¯´å¦æåºç°ç½ç»å»¶è¿æèä»èç¹å®æºå¯¼è´å¤å¶ä¸­æ­çæåµï¼å¨ç³»ç»æ¢å¤åä»ç¶å¯ä»¥ä»ä¸æ¬¡åæ­¥çå°æ¹å¼å§åæ­¥ã\n\nå®çåçæ¯ä¸»ä»é½ç»´æ¤ä¸ä¸ªoffsetï¼å¤å¶åç§»éï¼ï¼master_offsetãslave_offsetï¼ä¸»èç¹æ¯ä¸æ¬¡é½å°ä» slave_offset å° master_offsetçæ°æ®ä¼ è¾ç»ä»èç¹ï¼ä»ä¹ï¼æ²¡æ¶å°ï¼é£å°±éæ°ä»slave_offsetä¼ ã\n\noffsetè®°å½çä¸»ä»èç¹å¨repl_baklogæ¥å¿ä¸­çåç§»éï¼repl_baklogå®éä¸å°±æ¯ä¸»ä¸ä»ä¹é´æ°æ®å·®å¼çç¼å²åºï¼å®æ¯ä¸ä¸ªå¤§å°åºå®çæä»¶ï¼åå¦å®æ¯1024kï¼ç°å¨offsetå°äºç¬¬1024kçä½ç½®ï¼ä¸ä¸æ¬¡å®ä¼è¦çåé¢çæ°æ®ã\n\nè¿æ ·æ¯æå±é©çï¼å¦å¾ï¼\n\næ­£å¸¸æåµä¸ï¼slaveä¸masterä¹é´çå·®è·å¹¶ä¸å¤ï¼æ¯å¯ä»¥ä½¿ç¨å¢éåæ­¥ä¿è¯æ°æ®ä¸è´æ§ã\n\n\n\nä½æ¯ä¸ä¸slaveå®æºï¼masterä¸­çæ°æ®æ¯slaveæ°æ®æ´æ´å¤äºä¸ä¸ªâç¯âï¼é£ä¹å°±æ æ³è¿è¡å¢éåæ­¥äºã\n\n\n\nè¿æ¶å°±éè¦éæ°è¿è¡å¨éå¤å¶ï¼ä¹å°±æ¯ç¬¬äºç§è¿è¡å¨éåæ­¥çæåµï¼ï¼èå¨éå¤å¶éå¸¸æèæ§è½ï¼æä»¥æä»¬è¦ æé«repl_baklogçå¤§å°å¹¶ä¸å½ä»èç¹å®æºæ¶å°½å¿«æ¢å¤ï¼åå°å¨éåæ­¥çåºç°ã\n\n\n# 4. æ ç£çå¤å¶\n\nå¨éåæ­¥åå¢éåæ­¥é½æ¯åºäºrdbæä»¶çï¼éè¦è¿è¡ç£çioï¼ä½æ¯æä»¬å¯ä»¥å¼å¯æ ç£çåæ­¥ï¼è¿å°±ä¸ä¼çærdbæä»¶ï¼èæ¯ærdbæä»¶ä¸­çåå®¹ä¸ä¿å­å¨ç£çä¸­ï¼ç´æ¥å¨åå­ä¸­åéç»ä»èç¹ã\n\nrepl-diskless-sync yes\n\n\n\n# 5. ä¸»ä»åæ­¥æ³¨æäºé¡¹\n\nä¸»ä»æ¨¡å¼è§£å³äºæ°æ®å¤ä»½åæ§è½çé®é¢ï¼ä½æ¯è¿æ¯å­å¨ä¸äºé®é¢ï¼\n\n 1. ç¬¬ä¸æ¬¡å»ºç«è¿æ¥æ¶ä¸å®æ¯å¨éåæ­¥ï¼åæ­¥çèæ¶æ¯è¾ä¹ï¼æ­¤æ¶åºè¯¥é¿å¼redisæä¾æå¡çé«å³°æã\n 2. å¦ææå¤ä¸ªä»èç¹éè¦å»ºç«è¿æ¥ï¼å¯ä»¥èèå°å ä¸ªä»èç¹éå¼æ¶é´æ®µï¼é¿åä¸»èç¹åå­å ç¨è¿å¤ãæ­¤å¤å¦æä»èç¹å¤ªå¤ï¼ä¹å¯ä»¥è°æ´ä¸»ä»å¤å¶çç»æï¼ä½¿å¶åä¸ºæ ç¶ç»æã\n 3. å¨ä¸ä¸»ä¸ä»æèä¸ä¸»å¤ä»çæåµä¸ï¼å¦æä¸»æå¡å¨æäºï¼å¯¹å¤æä¾çæå¡å°±ä¸å¯ç¨äºï¼åç¹é®é¢æ²¡æè§£å³ãæä»¥ä¼åºç°åé¢çå¨åµéç¾¤æ¨¡å¼ã",charsets:{cjk:!0},lastUpdated:"2023/07/01, 15:08:05",lastUpdatedTimestamp:1688195285e3},{title:"Redisæ°æ®ç»æä¸æ°æ®ç±»å",frontmatter:{title:"Redisæ°æ®ç»æä¸æ°æ®ç±»å",date:"2023-06-11T12:25:09.000Z",permalink:"/pages/77c4c7/"},regularPath:"/02.%E6%96%87%E7%AB%A0/10.Redis/10.Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.html",relativePath:"02.æç« /10.Redis/10.Redisæ°æ®ç»æä¸æ°æ®ç±»å.md",key:"v-6db7c258",path:"/pages/77c4c7/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:16},{level:2,title:"2. æ°æ®ç±»å",slug:"_2-æ°æ®ç±»å",normalizedTitle:"2. æ°æ®ç±»å",charIndex:463},{level:3,title:"2.1 SDSå¨æå­ç¬¦ä¸²",slug:"_2-1-sdså¨æå­ç¬¦ä¸²",normalizedTitle:"2.1 sdså¨æå­ç¬¦ä¸²",charIndex:571},{level:3,title:"2.2 Intset",slug:"_2-2-intset",normalizedTitle:"2.2 intset",charIndex:1539},{level:3,title:"2.3 Dict",slug:"_2-3-dict",normalizedTitle:"2.3 dict",charIndex:2153},{level:3,title:"2.4 ZipList",slug:"_2-4-ziplist",normalizedTitle:"2.4 ziplist",charIndex:3550},{level:3,title:"2.5 QuickList",slug:"_2-5-quicklist",normalizedTitle:"2.5 quicklist",charIndex:4332},{level:3,title:"2.6 SkipList",slug:"_2-6-skiplist",normalizedTitle:"2.6 skiplist",charIndex:5462},{level:2,title:"3. RedisObject",slug:"_3-redisobject",normalizedTitle:"3. redisobject",charIndex:6632},{level:2,title:"4. æ°æ®ç»æ",slug:"_4-æ°æ®ç»æ",normalizedTitle:"4. æ°æ®ç»æ",charIndex:7729},{level:3,title:"4.1 string",slug:"_4-1-string",normalizedTitle:"4.1 string",charIndex:7741},{level:3,title:"4.2 list",slug:"_4-2-list",normalizedTitle:"4.2 list",charIndex:8406},{level:3,title:"4.3 set",slug:"_4-3-set",normalizedTitle:"4.3 set",charIndex:8538},{level:3,title:"4.4 zset",slug:"_4-4-zset",normalizedTitle:"4.4 zset",charIndex:8653},{level:3,title:"4.5 hash",slug:"_4-5-hash",normalizedTitle:"4.5 hash",charIndex:9122},{level:3,title:"4.6 æ»ç»",slug:"_4-6-æ»ç»",normalizedTitle:"4.6 æ»ç»",charIndex:9381},{level:2,title:"5. åºç¨åºæ¯",slug:"_5-åºç¨åºæ¯",normalizedTitle:"5. åºç¨åºæ¯",charIndex:9392},{level:3,title:"5.1 string",slug:"_5-1-string",normalizedTitle:"5.1 string",charIndex:9404},{level:3,title:"5.2 list",slug:"_5-2-list",normalizedTitle:"5.2 list",charIndex:9689},{level:3,title:"5.3 set",slug:"_5-3-set",normalizedTitle:"5.3 set",charIndex:9757},{level:3,title:"5.4 zset",slug:"_5-4-zset",normalizedTitle:"5.4 zset",charIndex:9857},{level:3,title:"5.5 hash",slug:"_5-5-hash",normalizedTitle:"5.5 hash",charIndex:9903}],headersStr:"1. ç®è¿° 2. æ°æ®ç±»å 2.1 SDSå¨æå­ç¬¦ä¸² 2.2 Intset 2.3 Dict 2.4 ZipList 2.5 QuickList 2.6 SkipList 3. RedisObject 4. æ°æ®ç»æ 4.1 string 4.2 list 4.3 set 4.4 zset 4.5 hash 4.6 æ»ç» 5. åºç¨åºæ¯ 5.1 string 5.2 list 5.3 set 5.4 zset 5.5 hash",content:'# Redisæ°æ®ç»æ\n\n\n# 1. ç®è¿°\n\næ³å¿å¤§å®¶å·²ç»äºè§£äºRedisçå å¤§æ°æ®ç»æï¼é£ä¹æ°æ®ç±»åæ¯ä»ä¹ï¼\n\nðå¶å®æ¯æèªå·±ç¼çï¼ä¸ºäºè®©èªå·±çè§£è¿äºä¸è¥¿é åºæ¥ç~~\n\n> æ°æ®ç»æ ï¼åstringãsetãlistãzsetï¼æä»¬å¯ä»¥ç´æ¥ä½¿ç¨çè¿äºRediså·ä½çç±»åã\n> \n> æ°æ®ç±»å ï¼ä¸è¿°æ°æ®ç»æåºå±çå®ç°ã\n\nè¯¥å¦ä½çè§£è¿ä¸¤ä¸ªè¯å¢ï¼\n\nå­¦ä¹ åç§è¯­è¨é½æ¯åå­¦åç§æ°æ®ç±»åï¼ä¾å¦intãfloatãchar...\n\nåå­¦åç§æ°æ®ç»æï¼ä¾å¦æ ãéåãæ ...\n\næ°æ®ç»æç±æ°æ®ç±»åç»æï¼å°±åæ ãéåè¿äºç»æçåºå±å¯ä»¥ç±æ°ç»å®ç°ã\n\næ¬ç¯å°ä¼è®²è¿°ä»¥ä¸åå®¹ ï¼\n\n * æ°æ®ç±»å ï¼SDSãIntsetãDitãZipListãQuickListãSkipList\n * ç¨äºç¡®è®¤æ°æ®ç»æä½¿ç¨åªç§æ°æ®ç»æçRedisObject\n * æ°æ®ç±»å ï¼stringãlistãsetãzsetãHashä»¥åå®ä»¬çåºç¨åºæ¯ã\n\nåè¯´ä¸å¥ï¼æ¬æçæ°æ®ç±»åãæ°æ®ç»æé½æ¯æ¬äººææ°ï¼ä¾¿äºèªå·±çè§£ï¼å®éä¸å®ä»¬é½æ¯æ°æ®ç±»å\n\n\n# 2. æ°æ®ç±»å\n\nçäºä¸äºé¢è¯é¢ï¼åºç°Redisæ°æ®ç±»åè¿ä¸åç¥è¯çï¼å¯¹äºSDSåSkipListè¾å¤ï¼Dictä¹æï¼IntsetãZipListãQuickListå°±æ¯è¾å°äºã\n\nä¸»è¦è¿æ¯å®ä»¬çåºç¨åºæ¯ã\n\n\n# 2.1 SDSå¨æå­ç¬¦ä¸²\n\nRedisæå»ºäºä¸ç§ç»æä½æ¥å®æå­å¨å­ç¬¦ä¸²çåè½ï¼ç®åå¨æå­ç¬¦ä¸²ï¼Simple Dynamic Stringï¼ï¼ç®ç§°SDSã\n\nstruct __attribute__ ((__packed__)) sdshdr8{\n    char buf[];\n\n    uint8_t alloc;\n \n    uint8_t len;\n\n    unsigned char flags;\n};\n\n\n * char buf[] ï¼å­èæ°ç»ï¼ç¨äºå­å¨string/int/floatã\n * uint8_t alloc ï¼è®°å½bufæ°ç»ç³è¯·çæ»å­èæ°,ç±»åä¸º8ä½æ ç¬¦å·æ´åãä¸åæ¬ç»ææ å¿\'\\0\'ã\n * uint8_t len ï¼è®°å½bufæ°ç»ä¸­å·²ç»ä½¿ç¨çå­èçæ°é,ç±»åä¸º:8ä½æ ç¬¦å·æ´åãä¸åæ¬ç»ææ å¿ã\n * unsigned char flags ï¼è®°å½SDSçæå¤§ç©ºé´ï¼å³å³å®allocçæå¤§å¼ãå ä¸ºå­å¨ç©ºé´ä¸åï¼SDSç±»åä¹ä¸åï¼æå¾å¤ä¸åç±»åçSDSï¼ä¾å¦16ä½ã32ä½...\n\nä¹æä»¥è¢«ç§°ä¸ºå¨æå­ç¬¦ä¸²ï¼å ä¸ºè¿ä¸ªå­ç¬¦ä¸²æå¨ææ©å®¹æºå¶ï¼\n\n * æ©å®¹åçç©ºé´å°äº1M ï¼æ©å®¹åçç©ºé´å¤§å°ä¹ä»¥ 2ï¼1\n * æ©å®¹åçç©ºé´å¤§äº1M ï¼ç©ºé´ç´æ¥ +1M+1\n\n# æ©å®¹æ¹æ¡:\nni -> nihao\n# åç©ºé´: \n    len=2\n    alloc=2\n# æ©å®¹å:\n    len=5\n    alloc=10\n# ä¸ºä»ä¹æ²¡æå ä¸ï¼ä¸åºè¯¥æ¯5*2 + 1 = 11å?\n    å ä¸ºå­ç¬¦ä¸²åé¢æ \'\\0\', èè¿lenåallocä¸¤ä¸ªå­æ®µé½ä¸è®¡ç®ç»ææ å¿ã\n    ç©ºé´ç¡®å®æäºï¼ä½æ¯allocæ²¡æè®¡ç®è¿å»ã\n\n\nä½æ¯allocçç±»åæ¯8ä½æ ç¬¦å·æ´åï¼åªè½å­å¨2^8ä¸ªæ°å­ï¼å¤ªæéï¼æä»¥Redisæä¾äºä¸åç±»åçSDSï¼å®ä»¬çå¶ä»ç¹æ§é½ç¸åï¼åªæallocãlençç±»åä¸åï¼æ5ä½ã8ä½ã16ä½ã32ä½ã\n\nå¦ä½åºåï¼ä½¿ç¨ flag è¿ä¸ªå­æ®µãflagæä¸åçå¼ï¼åå«ä»£è¡¨å­èå¤§å°ï¼5ã8ã16ã32.\n\næ»ç» ï¼flagè§å®allocçæå¤§å¼ï¼éè¦æ©å®¹æ¶éè¦æ¹åallocçè³flagãallocè§å®å­ç¬¦ä¸²å¯ä»¥å­å¨å¤å°åç´ ï¼ä¸æ¦è¶è¿ï¼éè¦æ©å®¹ãlenæ¯å½ååç´ ä¸ªæ°ãbuf[]å­å¨å½ååç´ ã\n\n\n# 2.2 Intset\n\nIntsetæ¯Redisä¸­setéåçä¸ç§å®ç°æ¹å¼ï¼åºäºæ´æ°æ°ç»æ¥å®ç°ï¼å·æé¿åº¦å¯åãå¯ä¸ãæåºç­ç¹ç¹ã\n\ntypedef struct intset {\n    uint32_t encoding;\n    \n    uint32_t length;\n    \n    int8_t contents[];\n} intset;\n\n\n * uint32_t encoding ï¼æ°æ®ç¼ç æ¹å¼ï¼æ¯æå­æ¾16ä½ã32ä½ã64ä½çæ°æ®ã\n * uint32_t length ï¼åç´ ä¸ªæ°ã\n * int8_t contents[] ï¼æ´æ°æ°ç»ï¼ä¿å­éåæ°æ®ãæ°æ®èå´ç±encodingç¡®è®¤ã\n\n> é£ä¹Intsetå¦ä½ç»´ææåºãå¯ä¸çç¹ç¹ï¼\n\nå¨æå¥æ¶ ï¼\n\n 1. æ£æ¥æå¥æ°æ®æ¯å¦å¤ªå¤§æå¤ªå°ï¼æ¯å¦éè¦æ¹åencodingç¼ç ã\n    \n    å¦æéç½®ç¼ç ï¼åå¦éç½®ç¼ç ååæ¥ç16ä½åæ32ä½ï¼éè¦éæ°æ·è´æ°ç»çåææ°æ®å°åçº§åçåå­èä¸éè¦ååºæ·è´é²æ­¢æ°æ®ä¸¢å¤±ã\n\n 2. æ¥çæ°ç»ä¸­æ¯å¦å·²ç»å­å¨è¯¥æ°æ®ï¼è¥å·²å­å¨å°±ä¸æå¥ï¼è¥ä¸å­å¨ï¼äºåæ³è·å¾è¯¥æ°æ®çæå¥ä½ç½®ã\n    \n    äºåæ³ä¿è¯æ°æ®æåºï¼æ°æ®æåºå¯ä»¥ä½¿ç¨äºåæ³ã\n\n 3. æ°ç»åå°æ©å®¹ï¼å°å¾æå¥åç´ æå¥\n\néè¿ç¬¬äºç¹å°±å¯ä»¥ä¿è¯Intsetçå¯ä¸æ§åæåºæ§ã\n\nä¸è¿°å·ä½æ­¥éª¤å¯ä»¥æå¼Redisæºç éè¯»ãå°Rediå®è£åæå¼å³å¯ã\n\n\n# 2.3 Dict\n\nRedisæ¯å¸åçé®å¼åï¼key-valueï¼æ°æ®åºï¼å®å°±æ¯é Dictæ¥ä¿æé®ä¸å¼çæ å°å³ç³»çã\n\nJavaä¸­çMapæ¯åºäºHashçå­å¸ç»æï¼Redisä¸­çå­å¸Dictä¹æ¯ã\n\nDictç±ä¸é¨åç»æ ï¼åå¸èç¹ï¼DictEntryï¼ãåå¸è¡¨ï¼DictHashTableï¼ãå­å¸ï¼Dictï¼ã\n\nä»å°å¾å¤§è¯´ï¼åè¯´åå¸èç¹ä¸åå¸è¡¨ï¼ä¸ä¸ªåå¸è¡¨å¯ä»¥åå«å¤ä¸ªåå¸èç¹ï¼åå¸èç¹æ¯é®-å¼åçã\n\nåå¸èç¹ï¼\n\ntypedef struct dictEntry {\n    void *key;\n    \n    union {\n        void *val;\n        uint64_t u64;\n        int64_t s64;\n        double d;\n    } value;\n    \n    struct dictEntry *next;\n} dictEntry;\n\n\n * keyï¼åå¸èç¹çé®ã\n * value ï¼åå¸èç¹çå¼ï¼ä¸ºèåä½ç±»åã\n * *next ï¼ä¸ºäºæ¹ä¾¿å¯»åï¼æ¯ä¸ªåå¸èç¹é½ææåä¸ä¸ä¸ªåå¸èç¹çæéã\n\nåå¸è¡¨ ï¼\n\ntypedef struct dictht {\n    dictEntry **table;\n    unsigned long size;\n    unsigned long sizemask;\n    unsigned long used;\n} dictht;   \n\n\n * table ï¼æåé®å¼å¯¹æ°ç»çæéãæ°ç»æ¯æéï¼tableæ¯æåæ°ç»çæéï¼æä»¥tableæ¯äºçº§æéã\n * size ï¼åå¸è¡¨å¤§å°ãæ»ç­äº 2^n ï¼nä¸ºæ´æ°ï¼ã\n * sizemark ï¼åå¸è¡¨å¤§å°çæ©ç ï¼æ»ç­äºsize - 1 ã\n * used ï¼åå¸èç¹ä¸ªæ°ã\n\nä¸ºä»ä¹æäºsizeè¡¨ç¤ºåå¸èç¹ä¸ªæ°ï¼è¿è¦ä½¿ç¨usedå¤æ­¤ä¸ä¸¾å¢ï¼\n\nHashè¿ç®ä¼äº§çHashå²çªï¼ä¼å¨æ°ç»çåºç¡ä¸å¤ä¸äºé¾è¡¨ï¼sizeè¡¨ç¤ºæ°ç»åç´ ä¸ªæ°ï¼usedè¡¨ç¤ºæ°ç»+é¾è¡¨çåç´ ä¸ªæ°ã\n\nå½æä»¬åDictæ·»å é®å¼å¯¹æ¶ï¼Redisé¦åæ ¹æ®keyè®¡ç®åºhashå¼ï¼ç¶åéè¿hash & sizemarkè®¡ç®è¯¥æ°æ®åºè¯¥æ¾å°æ°ç»ä¸­åªä¸ªä½ç½®ã\n\n\n\né¤äºåå¸èç¹ä¸åå¸è¡¨ä¹å¤ï¼Dictæåä¸ä¸ªç»æï¼å­å¸ DictHashTable.\n\ntypedef struct dict {\n\tdictType *type;\n    void *privdata;\n    dictht ht[2];\n    long rehashidx;\n    int16_t pauserehash;\n} ;\n\n\n * *typeï¼æ¬å­å¸çç±»åï¼ä¸åç±»åä½¿ç¨ä¸åHashå½æ°ã\n * *privdata ï¼ç§ææ°æ®ï¼å¨åç¹æ®hashè¿ç®æ¶ä½¿ç¨ã\n * ht[2] ï¼ä¸ä¸ªå­å¸æ¥æä¸¤ä¸ªåå¸è¡¨ï¼ä¸ä¸ªæ¾åå¸èç¹ï¼ä¸ä¸ªä¸ºrehashæ¶ä½¿ç¨ã\n * rehashidx ï¼rehashçè¿åº¦ï¼-1ä»£è¡¨æªå¼å§ã\n * pauserehash ï¼rehashæ¯å¦æåï¼1åæåï¼0åç»§ç»­ã\n\næ»ç» ï¼Dictåºå±æ¯åºäºæ°ç»ãé¾è¡¨çHashè¡¨ï¼æ°ç»ä¸­ä¿å­çæ¯ä¸ä¸ªä¸ªentryé®å¼å¯¹ï¼é®å¼å¯¹çç±»åå¤§å¤æ¯æéï¼æåSDSå¯¹è±¡ãæ°ç»ä¸­çentryé®å¼å¯¹ç±nextæéè¿æ¥ï¼ä¾¿äºå¯»åã\n\n\n# 2.4 ZipList\n\nåç¼©é¾è¡¨ï¼ä¸ºäºèçåå­èè®¾è®¡çé¾è¡¨ï¼ç±ä¸ç³»åç¹æ®ç¼ç çè¿ç»­ç©ºé´ç»æï¼å¯ä»¥å¨ä»»æä¸ç«¯è¿è¡åå¥/å¼¹åºæä½ï¼å¹¶ä¸è¯¥æä½çæ¶é´å¤æåº¦ä¸º O(1)ã\n\nä½æ¯æä¹è¿ç»­ï¼è´¥ä¹è¿ç»­ï¼ZipListçè¯çæ¯ä¸ºäºè§£å³Dictæéè¿å¤ä¸åå­ä¸è¿ç»­çé®é¢ï¼ä¸è¿äº§çäºæ°é®é¢ ï¼ä¸æ¦æ°æ®éå¤ªå¤§ï¼ä¸åªå»æ¾è¿ä¹å¤è¿ç»­çç©ºé´ï¼æä»¥å¾å¤Redisçæ°æ®ç±»ååªå¨æ°æ®éå°çæ¶åç¨ZipListã\n\ntypedef struct ziplist {\n    uint32_t albytes;\n    uint32_t zltail;\n    uint16_t zllen;\n    entry *entry;\n    uint8_t zlend;\n} ziplist;\n\n\n * zlbytes ï¼æ»å­èæ°\n * zltail ï¼å°¾èç¹ä¸èµ·å§å°åä¹é´çå­èæ°\n * zllen ï¼entryèç¹çä¸ªæ°\n * zlend ï¼ç»ææ å¿ï¼0xff\n * entry ï¼ZipListä¸­ææèç¹ï¼ä¸ªæ°ãå­èå¤§å°ä¸å®ã\n\n\n\nentryå­èå¤§å°ä¸ç¡®å®ï¼é£éåçæ¶åè¯¥å¦ä½éåå¢ï¼æ°ç»ä¸­çåç´ å­èå¤§å°åºå®ï¼å¯ä»¥ç¥éæ¯æ¬¡è¯»åå ä¸ªå­èçç©ºé´ï¼é¾è¡¨ç´æ¥ä½¿ç¨æéæåä¸ä¸ä¸ªåç´ ï¼é£ä¹entryè¯¥å¦ä½éåï¼\n\nåªè¦å¨entryè¿ä¸ªç»æåé¨è®°å½ä¸ä¸ä½¿ç¨çç©ºé´å°±è¡äºã\n\nä½æ¯Entryè®°å½çæ¯ä¸ä¸ä¸ªentryå ç¨çå­èæ°ãï¼Redis7æ¹ä¸ºæ­¤entryå­èæ°ï¼\n\næ¯ä¸ä¸ªentryæä¸ä¸ªå­æ®µ ï¼\n\n * previous_entry_length ï¼åä¸èç¹çé¿åº¦ï¼1-5ä¸ªå­èã\n * encoding ï¼æ¬èç¹å±æ§ï¼è®°å½contentçæ°æ®ç±»åï¼æ´æ°/å­ç¬¦ä¸²ï¼ä»¥åé¿åº¦ã\n * contents ï¼ä¿å­èç¹æ°æ®ï¼å¯ä»¥æ¯å­ç¬¦ä¸²ææ´æ°ã\n\nåªè¦ç¥éåä¸ä¸ªèç¹/æ¬èç¹çå­èæ°ï¼å°±å¯ä»¥éåã\n\n\n# 2.5 QuickList\n\nä¸ºäºè§£å³ZipListçé®é¢ï¼QuickListè¯çäºã\n\nZipListçé®é¢æ¯ç©ºé´è¿ç»­ï¼ä½æ¯æ¾ä¸å°å¤ªå¤§çè¿ç»­ç©ºé´ã\n\nä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼QuickListéç¨ä¸¤ç§æ¹æ³ ï¼\n\n * éå¶entryçä¸ªæ°åå¤§å°ã\n * ä½¿ç¨å¤ä¸ªZipListã\n\nä¸ä¸ª5Mçæ°æ®ï¼ä½¿ç¨ä¸ä¸ªZipListå¯è½æ¾ä¸å°è¿ç»­ç5Mç©ºé´ï¼ä½å¦æå¯ä»¥æ¾å°5ä¸ªè¿ç»­ç1Mç©ºé´ï¼å°±å¯ä»¥å°è¿ä¸ªæ°æ®åä¸º5ä»½ï¼ä½¿ç¨5ä¸ªZipListå­å¨ã\n\nRedis3.2ä¹åå¼å¥çQuickListæ¯ä¸ä¸ªåç«¯é¾è¡¨ï¼åªä¸è¿æ¯ä¸ä¸ªèç¹é½æ¯ä¸ä¸ªZipListã\n\né¤äºæ§å¶ZipListçå¤§å°ï¼QuickListè¿å¯¹èç¹çZipListè¿è¡åç¼©\n\nQuickListNodeï¼èç¹ï¼æºç ï¼\n\ntypedef struct quicklistNode {\n    // æååä¸ä¸ªç»ç¹çæé\n    struct quicklistNode *pre;\n    // æååä¸ä¸ªèç¹çæé\n    struct quicklistNode *next;\n    // å½åèç¹çziplistæé\n    unsigned char *zl;\n    // å½åèç¹çziplistçå­èæ°\n    unsigned int sz;\n    // å½åèç¹æå±çziplistçentryä¸ªæ°\n    unsigned int count;\n    // ç¼ç æ¹å¼ 1.ZipList  2.lzfåç¼©æ¨¡å¼\n    unsigned int encoding;\n    // æ¯å¦è¢«è§£åç¼© 1è¯´æè¢«è§£åäºï¼ä»¥åè¦éæ°åç¼©\n    unsigned int recompress;\n}\n\n\nQuickListæºç ï¼\n\ntypedef struct quicklist {\n    // å¤´èç¹æé\n    quicklistNode *head;\n    // å°¾èç¹æé\n    quicklistNode *tail;\n    // ææziplistä¸­çentryä¸ªæ°\n    unsigned long count;\n    // ziplistä¸ªæ°\n    unsigned long len;\n    // ziplistçentryæ°éä¸é\n    int fill; // é»è®¤ä¸º2\n}\n\n\n\nï¼æºç å äºä¸ç¹æ²¡ç¨çï¼\n\nå½å­å¨ä¸å®æ°æ®æ¶ï¼QuickListçæ¨¡æ · ï¼\n\n\n\næ»ç» QuickListç¹ç¹ï¼\n\n 1. èç¹ä¸ºziplistçåç«¯é¾è¡¨ã\n 2. æ§å¶ziplistä¸­entryçä¸ªæ°ä»¥åæ¯ä¸ªentryçå¤§å°ã\n 3. ä¸­é´èç¹å¯ä»¥åç¼©ï¼è¿ä¸æ­¥èçåå­ã\n\n\n# 2.6 SkipList\n\nSkipListï¼é¢è¯ä¸­ç»å¸¸é®çè·³è¡¨ï¼è¢«ç§°ä¸ºè·³è¡¨æ¯å ä¸ºå®éåçæ¶åå¯ä»¥âè·³âçéåã\n\nå¯¹äºä¸ä¸ªæåºæ°ç»ï¼å¯ä»¥ä½¿ç¨äºåæ³å¿«éæ¥æ¾ï¼ä½æ¯é¾è¡¨æä¹å¿«éå¢ï¼\n\næ­£å¸¸çé¾è¡¨åªææåååèç¹çæéï¼ä½æ¯è·³è¡¨ä¸ä¸æ ·ï¼å®æéæºä¸ªéæºæéãå¯¹äº1-10è¿å ä¸ªæ°ç»æçè·³è¡¨ï¼å¯è½1è¿ä¸ªåç´ ä¸­ææå5ã6ã9ã10çæéï¼2ææå3ã4ã8ã10çï¼10å¯è½ææå1ã4ã7çæéãè¿æ ·å°±å¯ä»¥éè¿ä¸æ­çè·³è·ãæ¯è¾ï¼å¿«éå¾å°æ³è¦çå¼ãæ­¤ç»ææ­£å ä¸ºè¿ä¸ªç¹ç¹è¢«ç§°ä¸ºè·³è¡¨ã\n\nå½ç¶äºï¼è·³è¡¨çæéæ¯éæºçæçï¼éæºæ§å¤ªå¤§ï¼å¯è½ä¸æ¬¡å°±æ¾å°å¼ï¼å¯è½éè¦ä¸ä¸ªä¸ä¸ªéåã\n\nSkipListï¼è·³è¡¨ï¼é¦åæ¯é¾è¡¨ï¼ä½ä¸ä¼ ç»é¾è¡¨æå ç¹å·®å¼ ï¼\n\n * åç´ ååºæåï¼ä¸è¿ä¸æ¯æç§åç´ è¿è¡æåºï¼èæ¯æ ¹æ®åç´ çæçscoreæåºã\n * èç¹å¯è½åå«å¤ä¸ªæéï¼æéè·¨åº¦éæºã\n\næ­£å ä¸ºè¿ä¸¤ä¸ªç¹ç¹ï¼è·³è¡¨å¯ä»¥è¾¹è·³è·è¾¹æ¯è¾ï¼å¤§å¤§æé«æ¥è¯¢æçã\n\nè·³è¡¨èç¹\n\ntypedef struct zskiplistNode {\n    sds ele;\n    double score;\n    zskiplistNode *backward;\n    struct zskiplistLevel {\n        zskiplistNode *forward;\n        unsigned long span;\n    } level[];\n}zskiplistNode;\n\n\n * ele ï¼èç¹å­å¨çå¼ã\n * score ï¼èç¹çåæ°ï¼ç¨äºæåºã\n * backward ï¼åä¸ä¸ªèç¹çæéã\n * level ï¼å¤çº§ç´¢å¼æ°ç»ï¼ææåç»§èç¹\n * forward ï¼ä¸ä¸ªèç¹å¯è½æå¤ä¸ªlevelï¼forwardæåè¿ä¸ªlevelä»£è¡¨çèç¹ã\n * span ï¼ç´¢å¼è·¨åº¦ï¼ç¬¬ä¸ä¸ªèç¹æåç¬¬åä¸ªèç¹ï¼è·¨åº¦ä¸º9\n\nè·³è¡¨\n\ntypedef struct zskiplist {\n    struct zskiplistNode *header, *tail;\n    unsigned long length;\n    int level;\n}\n\n\n * header tail ï¼å¤´èç¹ãå°¾èç¹ã\n * length ï¼èç¹æ°éã\n * level ï¼æå¤§ç´¢å¼å±çº§ï¼é»è®¤ä¸º1ï¼æå¤§ä¸º32ï¼å³ä¸ä¸ªèç¹çåç»§æéå¯ä»¥æ1-32ä¸ªã\n\n\n\nSkipListç¹ç¹ï¼\n\n 1. ååé¾è¡¨ï¼æ¯ä¸ªèç¹åå«scoreåeleå¼\n 2. èç¹æç§scoreæåºï¼scoreå¼ä¸æ ·åæç§eleæåº\n 3. æ¯ä¸ªèç¹é½å¯ä»¥åå«å¤å±æéï¼å±æ°æ¯1-32çéæºå¼\n 4. ä¸åæéå°ä¸ä¸ä¸ªèç¹çè·¨åº¦ä¸åï¼å±çº§è¶é«ï¼è·¨åº¦è¶å¤§ã\n 5. å¢å æ¹æ¥æçä¸çº¢é»æ åºæ¬ä¸è´ï¼å®ç°å´æ´ç®åã\n\n\n# 3. RedisObject\n\nå­¦ä¹ äºä»¥ä¸å ç§æ°æ®ç±»åï¼æä»ä¹ç¨å¢ï¼å¯¹ï¼ç»æRedisä¸­å¯ä»¥ä½¿ç¨çæ°æ®ç»æï¼é£ä¹åä¸ªæ°æ®ç»æç¨ä»ä¹æ ·çåºå±å®ç°å¢ï¼å¨åªéå¯ä»¥çå°å¢ï¼å¨åªéè®°å½ä¸æ¥å¢ï¼\n\nRedisObject\n\nRedisä¸­çä»»ä½æ°æ®ç±»åé½ä¼è¢«å°è£ä¸ºä¸ä¸ªRedisObjectï¼ä¹å«åRediså¯¹è±¡ã\n\ntypedef struct redisObject {\n    unsigned type:4;\n    unsigned encoding:4;\n    unsigned lru:24; \n    int refcount;\n    void *ptr;\n}\n\n\n * type ï¼æ­¤å¯¹è±¡çç±»åï¼åå«ä¸ºstringãlistãsetãzsetãhash\n\n * encoding ï¼æ­¤å¯¹è±¡çåºå±å®ç°ï¼ä¸è¿°SDSãIntsetãDictãSkipList...æ11ä¸ªå¼ã\n\n * lru ï¼è®°å½å½åRediså¯¹è±¡æè¿ä¸æ¬¡è®¿é®æ¶é´ï¼ä»¥ä¾¿å°é¿æ¶é´æªä½¿ç¨çå¯¹è±¡åæ¶ã\n\n * refcount ï¼å¯¹è±¡å¼ç¨è®¡æ°å¨ï¼è®¡æ°å¨ä¸º0åè¯´æå¯¹è±¡æ äººä½¿ç¨ï¼å¯ä»¥è¢«åæ¶ã\n\n * *ptr ï¼æåå·ä½å­æ¾æ°æ®çç©ºé´ã\n\ntypeåencodingå­æ®µæ¯æ¬ç¯æç« å³æ³¨çå°æ¹ã\n\nåæ¥ççencodingå­æ®µç11ä¸ªå¼ ï¼\n\nç¼å·   ç¼ç æ¹å¼                      è¯´æ\n0    OBJ_ENCODING_INT          longç±»åçæ´æ°å­ç¬¦ä¸²\n1    OBJ_ENCODING_RAW          rawç¼ç çå¨æå­ç¬¦ä¸²\n2    OBJ_ENCODING_EMBSTR       embstrç¼ç çå¨æå­ç¬¦ä¸²\n3    OBJ_ENCODING_INTSET       æ´æ°éå\n4    OBJ_ENCODING_ZIPLIST      åç¼©åè¡¨\n5    OBJ_ENCODING_QUICKLIST    å¿«éåè¡¨\n6    OBJ_ENCODING_SKIPLIST     è·³è¡¨\n7    OBJ_ENCODING_LINKEDLIST   åç«¯é¾è¡¨\n8    OBJ_ENCODING_HT           å­å¸\n9    OBJ_ENCODING_ZIPMAP       å·²åºå¼\n10   OBJ_ENCODING_STREAM       Streamæµ\n\nå¯ä»¥çå°ï¼stringæä¸ç§ç¼ç æ¹å¼ï¼listæ3ä¸­ç¼ç æ¹å¼ï¼setæä¸ç§ç¼ç æ¹å¼ã\n\n----------------------------------------\n\n\n# 4. æ°æ®ç»æ\n\n\n# 4.1 string\n\nstringæ¯Redisæå¸¸è§çæ°æ®å­å¨ç±»åã\n\n * å¦æå­å¨çå­ç¬¦ä¸²é¿åº¦å°äº44å­èï¼åä¼ä½¿ç¨EMBSTRç¼ç ãæ­¤æ¶object headä¸SDSæ¯ä¸çè¿ç»­ç©ºé´ï¼ç³è¯·åå­æ¶åªéè¦è°ç¨ä¸æ¬¡åå­åå­åéå½æ°ï¼æçæ´é«ã\n\n * SDSé¿åº¦å¤§äº44ï¼ç¼ç æ¹å¼æ¯RAWãobject headä¸SDSä¸åè¿ç»­\n\n\n\n * å¦æSDSçåå®¹æ¯æ°å­ï¼å¹¶ä¸è¿ä¸ªæ°å­å¨Long_MAXèå´åå°±ä½¿ç¨INTç¼ç æ¹å¼ãINTç¼ç æ¹å¼ç´æ¥å°æ°æ®å­å¨RedisObjectçptræéä½ç½®ï¼åå¥½8å­èï¼ï¼ä¸éè¦SDSäºã\n\n\n\nå¯ä»¥çåºææ¾åºå« ï¼EMBSTRçç©ºé´æ¯è¿ç»­çï¼å ä¸ºå­ç¬¦ä¸²ä½ç§¯å°ï¼å®¹æç³è¯·è¿ç»­ç©ºé´ã\n\nä»¥ä¸åRediså­å¨åä¸ªå¼ï¼åå«ä¸º æ°å­ãç­å­ç¬¦ä¸²ã44ä½å­ç¬¦ä¸²ã45ä½å­ç¬¦ä¸²ï¼æ¥ççç¼ç æ¹å¼ç»æå¦ä¸ï¼\n\nyun:0>set a 12\n"OK"\nyun:0>object encoding a\n"int"\nyun:0>set b xiaoming\n"OK"\nyun:0>object encoding b\n"embstr"\nyun:0>set c 01234567890123456789012345678901234567890123\n"OK"\nyun:0>object encoding c\n"embstr"\nyun:0>set d 012345678901234567890123456789012345678901234\n"OK"\nyun:0>object encoding d\n"raw"\n\n\n\n# 4.2 list\n\nlistæ¥æä¸ç§ç¼ç æ¹å¼ ï¼linkedlistãziplistãquicklistãèªä»QuickListåºç°åå°±å¾å°ç¨LinkedListäºã\n\næä»¥å¨Redis3.2çæ¬åï¼Redisç»ä¸éç¨QuickListå®ç°Listã\n\n\n\n\n# 4.3 set\n\n * å½å­å¨çæ°æ®å¨é¨ä¸ºæ´æ°ï¼ä¸åç´ æ°éä¸è¶è¿set-max-intset-emtriesæ¶ï¼setä½¿ç¨intsetç¼ç \n\n * å¶ä»æåµä½¿ç¨Dictç¼ç ï¼ä½¿ç¨å®çkeyï¼valueç»ä¸ä¸ºnullã\n\n\n\n\n# 4.4 zset\n\nzsetä¹å°±æ¯sortedsetï¼æ¯ä¸ä¸ªåç´ é½æä¸ä¸ªç¨äºæåºçscoreå¼ãzsetçç¹ç¹ ï¼\n\n * scoreå¼ç¨äºæåº\n * é®å¯ä¸\n * å¯ä»¥æ ¹æ®é®æ¥è¯¢åæ°\n\nçèµ·æ¥å¯ä»¥ç¨SkipListï¼ä½æ¯è·³è¡¨çé®ä¸å¯ä¸ï¼èä¸å®çscoreè½ç¶å¯ä»¥æåºï¼ä½æ æ³æ¥è¯¢ã\n\nçèµ·æ¥å¯ä»¥ç¨Dictï¼ä½Dictæ æ³æåºã\n\né£ä¹æä»¬å°å®ä»¬ç»åèµ·æ¥ä¸å°±è¡äºï¼ä¸ä¸ªzsetåå«ä¸ä¸ªSkipListåä¸ä¸ªDictï¼æ·»å åç´ æ¶ååDictæ·»å ï¼ä¿è¯åç´ å¯ä¸ï¼å¦æåç´ å¯ä¸ååSkipListæ·»å ï¼ä¿è¯å¯æåºã\n\ntypedef struct zset {\n    dict *dict;\n    zskiplist *zsl;\n}\n\n\nè½ç¶zsetä½¿ç¨äºä¸¤ç§ç»æï¼ä½å®çç¼ç åæskiplistã\n\nä½æ¯å½åç´ æ°éå°äº128æåç´ å¤§å°å°äº64å­èæ¶ï¼zsetä¼ä½¿ç¨ZipListèçç©ºé´ã\n\n * åç´ æ°éå°äº128æåç´ å¤§å°å°äº64å­èæ¶ï¼ä½¿ç¨ZipListèçç©ºé´ã\n * å¶ä»æåµä½¿ç¨ Dict + SkipListã\n\n\n\n\n# 4.5 hash\n\nHashç»æä¸Redisä¸­çZsetå¾å\n\n * é®å¼å­å¨\n * å¯ä»¥æ ¹æ®é®è·åå¼\n * é®å¯ä¸\n\näºèå·®å«ä¾å¦zsetçå¼å¿é¡»æ¯æ°å­ï¼ç¨äºæåºãèHashç»æä¸ç¨æåºã\n\nHashåºå±éç¨çç¼ç ä¸Zsetåºæ¬ä¸è´ï¼åªéè¦ææåºæå³çSkipListå»æå³å¯ ï¼\n\n * Hashé»è®¤ä½¿ç¨ZipListç¼ç ï¼ä»¥èçåå­ãZipListçç¸é»ä¸¤ä¸ªentryåå«å­å¨é®ãå¼ã\n * å½åç´ æ°éè¶è¿512æä»»æä¸ä¸ªentryèç¹å¤§å°è¶è¿64å­èæ¶Hashç»æä¼è½¬ä¸ºHTç¼ç ï¼ä¹å°±æ¯Dictã\n\n\n\n\n# 4.6 æ»ç»\n\n\n# 5. åºç¨åºæ¯\n\n\n# 5.1 string\n\n 1. ç¨äºåç¼å­\n 2. setnx æä½çæåå¸å¼é\n 3. è¿æ¶å¯ä»¥ç¨äºè®¡æ°å¨ãå½æ°æ®æ¯æ°å­æ¶ï¼stringä¸ä¼åå»ºæ°çSDSå¯¹è±¡ï¼èæ¯å°æ°å­å­å¨å¨RedisObjectçpträ¸ï¼éå¸¸èçç©ºé´ã\n\nç¨äºè®¡æ°å¨ä¸å¹¶åéé«çæåµä¸ï¼åå¦ç¨äºæç« æµè§éï¼ä½ çæå¡æåä¸º10å°æºå¨ï¼è¿10å°æºå¨å¯è½åæ¶æ¢å¤ºæµè§éä¸º100çè¿ä¸ªæ°å­ï¼é£ä¹åªæä¸å°æºå¨å¯ä»¥æåï¼å©ä¸9å°é½ä¼å¤±è´¥ï¼æçå¤ªä½ãæ­¤æ¶æä»¬å¯ä»¥ä½¿ç¨INCRBYï¼ä¸å°æºå¨è¿æ¥ï¼æä»¬ç»å®100ä¸ªæµè§éï¼å®èªå·±ç¨å»å§ï¼Redisä¸­çæ°æ®ç´æ¥INCRBY 100å³å¯ãè¿æ ·å°±å¯ä»¥æé«æçã\n\n\n# 5.2 list\n\nlistæ¯æåç«¯æå¥ãè®¿é®\n\nç¨ä½ä¿¡æ¯æµãä¾å¦ä½ å³æ³¨å¾å¤å¬ä¼å·ï¼è¿äºå¬ä¼å·åçæç« é½å¯ä»¥å¡è¿ä½ çlistä¸­\n\n\n# 5.3 set\n\nå¾å¤äººç¨setçåå ä¼°è®¡å°±æ¯å¼å¯ä¸å§ï¼è¿ä¸ªå°±å¯ä»¥ç¨ä½ç¹èµåè¡¨ãå¥½ååè¡¨ãå³æ³¨åè¡¨ãæ¶èç­ç­..\n\nåæ¶å®å¯ä»¥æ±äº¤éãå¹¶éï¼è¿æ ·å°±æ¯æâå±åå¥½åâãâä½ å¯è½è®¤è¯çäººâç­ç­æä½\n\n\n# 5.4 zset\n\nzsetå¯ä»¥æ ¹æ®scoreæåºï¼åæ¶ä¿è¯å¼å¯ä¸ãå¸¸ç¨äºæè¡æ¦ã\n\n\n# 5.5 hash\n\nå¯ç¨äºè´­ç©è½¦ï¼hashçæä½å¾å¥åâè´­ç©è½¦âè¿ä¸åè½éæ± ï¼å¢å å é¤ååãå¢å åå°æä¸ªååçæ°éãéä¸­å¨é¨ãè·åå¨é¨ååçæ°é....',normalizedContent:'# redisæ°æ®ç»æ\n\n\n# 1. ç®è¿°\n\næ³å¿å¤§å®¶å·²ç»äºè§£äºredisçå å¤§æ°æ®ç»æï¼é£ä¹æ°æ®ç±»åæ¯ä»ä¹ï¼\n\nðå¶å®æ¯æèªå·±ç¼çï¼ä¸ºäºè®©èªå·±çè§£è¿äºä¸è¥¿é åºæ¥ç~~\n\n> æ°æ®ç»æ ï¼åstringãsetãlistãzsetï¼æä»¬å¯ä»¥ç´æ¥ä½¿ç¨çè¿äºrediså·ä½çç±»åã\n> \n> æ°æ®ç±»å ï¼ä¸è¿°æ°æ®ç»æåºå±çå®ç°ã\n\nè¯¥å¦ä½çè§£è¿ä¸¤ä¸ªè¯å¢ï¼\n\nå­¦ä¹ åç§è¯­è¨é½æ¯åå­¦åç§æ°æ®ç±»åï¼ä¾å¦intãfloatãchar...\n\nåå­¦åç§æ°æ®ç»æï¼ä¾å¦æ ãéåãæ ...\n\næ°æ®ç»æç±æ°æ®ç±»åç»æï¼å°±åæ ãéåè¿äºç»æçåºå±å¯ä»¥ç±æ°ç»å®ç°ã\n\næ¬ç¯å°ä¼è®²è¿°ä»¥ä¸åå®¹ ï¼\n\n * æ°æ®ç±»å ï¼sdsãintsetãditãziplistãquicklistãskiplist\n * ç¨äºç¡®è®¤æ°æ®ç»æä½¿ç¨åªç§æ°æ®ç»æçredisobject\n * æ°æ®ç±»å ï¼stringãlistãsetãzsetãhashä»¥åå®ä»¬çåºç¨åºæ¯ã\n\nåè¯´ä¸å¥ï¼æ¬æçæ°æ®ç±»åãæ°æ®ç»æé½æ¯æ¬äººææ°ï¼ä¾¿äºèªå·±çè§£ï¼å®éä¸å®ä»¬é½æ¯æ°æ®ç±»å\n\n\n# 2. æ°æ®ç±»å\n\nçäºä¸äºé¢è¯é¢ï¼åºç°redisæ°æ®ç±»åè¿ä¸åç¥è¯çï¼å¯¹äºsdsåskiplistè¾å¤ï¼dictä¹æï¼intsetãziplistãquicklistå°±æ¯è¾å°äºã\n\nä¸»è¦è¿æ¯å®ä»¬çåºç¨åºæ¯ã\n\n\n# 2.1 sdså¨æå­ç¬¦ä¸²\n\nredisæå»ºäºä¸ç§ç»æä½æ¥å®æå­å¨å­ç¬¦ä¸²çåè½ï¼ç®åå¨æå­ç¬¦ä¸²ï¼simple dynamic stringï¼ï¼ç®ç§°sdsã\n\nstruct __attribute__ ((__packed__)) sdshdr8{\n    char buf[];\n\n    uint8_t alloc;\n \n    uint8_t len;\n\n    unsigned char flags;\n};\n\n\n * char buf[] ï¼å­èæ°ç»ï¼ç¨äºå­å¨string/int/floatã\n * uint8_t alloc ï¼è®°å½bufæ°ç»ç³è¯·çæ»å­èæ°,ç±»åä¸º8ä½æ ç¬¦å·æ´åãä¸åæ¬ç»ææ å¿\'\\0\'ã\n * uint8_t len ï¼è®°å½bufæ°ç»ä¸­å·²ç»ä½¿ç¨çå­èçæ°é,ç±»åä¸º:8ä½æ ç¬¦å·æ´åãä¸åæ¬ç»ææ å¿ã\n * unsigned char flags ï¼è®°å½sdsçæå¤§ç©ºé´ï¼å³å³å®allocçæå¤§å¼ãå ä¸ºå­å¨ç©ºé´ä¸åï¼sdsç±»åä¹ä¸åï¼æå¾å¤ä¸åç±»åçsdsï¼ä¾å¦16ä½ã32ä½...\n\nä¹æä»¥è¢«ç§°ä¸ºå¨æå­ç¬¦ä¸²ï¼å ä¸ºè¿ä¸ªå­ç¬¦ä¸²æå¨ææ©å®¹æºå¶ï¼\n\n * æ©å®¹åçç©ºé´å°äº1m ï¼æ©å®¹åçç©ºé´å¤§å°ä¹ä»¥ 2ï¼1\n * æ©å®¹åçç©ºé´å¤§äº1m ï¼ç©ºé´ç´æ¥ +1m+1\n\n# æ©å®¹æ¹æ¡:\nni -> nihao\n# åç©ºé´: \n    len=2\n    alloc=2\n# æ©å®¹å:\n    len=5\n    alloc=10\n# ä¸ºä»ä¹æ²¡æå ä¸ï¼ä¸åºè¯¥æ¯5*2 + 1 = 11å?\n    å ä¸ºå­ç¬¦ä¸²åé¢æ \'\\0\', èè¿lenåallocä¸¤ä¸ªå­æ®µé½ä¸è®¡ç®ç»ææ å¿ã\n    ç©ºé´ç¡®å®æäºï¼ä½æ¯allocæ²¡æè®¡ç®è¿å»ã\n\n\nä½æ¯allocçç±»åæ¯8ä½æ ç¬¦å·æ´åï¼åªè½å­å¨2^8ä¸ªæ°å­ï¼å¤ªæéï¼æä»¥redisæä¾äºä¸åç±»åçsdsï¼å®ä»¬çå¶ä»ç¹æ§é½ç¸åï¼åªæallocãlençç±»åä¸åï¼æ5ä½ã8ä½ã16ä½ã32ä½ã\n\nå¦ä½åºåï¼ä½¿ç¨ flag è¿ä¸ªå­æ®µãflagæä¸åçå¼ï¼åå«ä»£è¡¨å­èå¤§å°ï¼5ã8ã16ã32.\n\næ»ç» ï¼flagè§å®allocçæå¤§å¼ï¼éè¦æ©å®¹æ¶éè¦æ¹åallocçè³flagãallocè§å®å­ç¬¦ä¸²å¯ä»¥å­å¨å¤å°åç´ ï¼ä¸æ¦è¶è¿ï¼éè¦æ©å®¹ãlenæ¯å½ååç´ ä¸ªæ°ãbuf[]å­å¨å½ååç´ ã\n\n\n# 2.2 intset\n\nintsetæ¯redisä¸­setéåçä¸ç§å®ç°æ¹å¼ï¼åºäºæ´æ°æ°ç»æ¥å®ç°ï¼å·æé¿åº¦å¯åãå¯ä¸ãæåºç­ç¹ç¹ã\n\ntypedef struct intset {\n    uint32_t encoding;\n    \n    uint32_t length;\n    \n    int8_t contents[];\n} intset;\n\n\n * uint32_t encoding ï¼æ°æ®ç¼ç æ¹å¼ï¼æ¯æå­æ¾16ä½ã32ä½ã64ä½çæ°æ®ã\n * uint32_t length ï¼åç´ ä¸ªæ°ã\n * int8_t contents[] ï¼æ´æ°æ°ç»ï¼ä¿å­éåæ°æ®ãæ°æ®èå´ç±encodingç¡®è®¤ã\n\n> é£ä¹intsetå¦ä½ç»´ææåºãå¯ä¸çç¹ç¹ï¼\n\nå¨æå¥æ¶ ï¼\n\n 1. æ£æ¥æå¥æ°æ®æ¯å¦å¤ªå¤§æå¤ªå°ï¼æ¯å¦éè¦æ¹åencodingç¼ç ã\n    \n    å¦æéç½®ç¼ç ï¼åå¦éç½®ç¼ç ååæ¥ç16ä½åæ32ä½ï¼éè¦éæ°æ·è´æ°ç»çåææ°æ®å°åçº§åçåå­èä¸éè¦ååºæ·è´é²æ­¢æ°æ®ä¸¢å¤±ã\n\n 2. æ¥çæ°ç»ä¸­æ¯å¦å·²ç»å­å¨è¯¥æ°æ®ï¼è¥å·²å­å¨å°±ä¸æå¥ï¼è¥ä¸å­å¨ï¼äºåæ³è·å¾è¯¥æ°æ®çæå¥ä½ç½®ã\n    \n    äºåæ³ä¿è¯æ°æ®æåºï¼æ°æ®æåºå¯ä»¥ä½¿ç¨äºåæ³ã\n\n 3. æ°ç»åå°æ©å®¹ï¼å°å¾æå¥åç´ æå¥\n\néè¿ç¬¬äºç¹å°±å¯ä»¥ä¿è¯intsetçå¯ä¸æ§åæåºæ§ã\n\nä¸è¿°å·ä½æ­¥éª¤å¯ä»¥æå¼redisæºç éè¯»ãå°rediå®è£åæå¼å³å¯ã\n\n\n# 2.3 dict\n\nredisæ¯å¸åçé®å¼åï¼key-valueï¼æ°æ®åºï¼å®å°±æ¯é dictæ¥ä¿æé®ä¸å¼çæ å°å³ç³»çã\n\njavaä¸­çmapæ¯åºäºhashçå­å¸ç»æï¼redisä¸­çå­å¸dictä¹æ¯ã\n\ndictç±ä¸é¨åç»æ ï¼åå¸èç¹ï¼dictentryï¼ãåå¸è¡¨ï¼dicthashtableï¼ãå­å¸ï¼dictï¼ã\n\nä»å°å¾å¤§è¯´ï¼åè¯´åå¸èç¹ä¸åå¸è¡¨ï¼ä¸ä¸ªåå¸è¡¨å¯ä»¥åå«å¤ä¸ªåå¸èç¹ï¼åå¸èç¹æ¯é®-å¼åçã\n\nåå¸èç¹ï¼\n\ntypedef struct dictentry {\n    void *key;\n    \n    union {\n        void *val;\n        uint64_t u64;\n        int64_t s64;\n        double d;\n    } value;\n    \n    struct dictentry *next;\n} dictentry;\n\n\n * keyï¼åå¸èç¹çé®ã\n * value ï¼åå¸èç¹çå¼ï¼ä¸ºèåä½ç±»åã\n * *next ï¼ä¸ºäºæ¹ä¾¿å¯»åï¼æ¯ä¸ªåå¸èç¹é½ææåä¸ä¸ä¸ªåå¸èç¹çæéã\n\nåå¸è¡¨ ï¼\n\ntypedef struct dictht {\n    dictentry **table;\n    unsigned long size;\n    unsigned long sizemask;\n    unsigned long used;\n} dictht;   \n\n\n * table ï¼æåé®å¼å¯¹æ°ç»çæéãæ°ç»æ¯æéï¼tableæ¯æåæ°ç»çæéï¼æä»¥tableæ¯äºçº§æéã\n * size ï¼åå¸è¡¨å¤§å°ãæ»ç­äº 2^n ï¼nä¸ºæ´æ°ï¼ã\n * sizemark ï¼åå¸è¡¨å¤§å°çæ©ç ï¼æ»ç­äºsize - 1 ã\n * used ï¼åå¸èç¹ä¸ªæ°ã\n\nä¸ºä»ä¹æäºsizeè¡¨ç¤ºåå¸èç¹ä¸ªæ°ï¼è¿è¦ä½¿ç¨usedå¤æ­¤ä¸ä¸¾å¢ï¼\n\nhashè¿ç®ä¼äº§çhashå²çªï¼ä¼å¨æ°ç»çåºç¡ä¸å¤ä¸äºé¾è¡¨ï¼sizeè¡¨ç¤ºæ°ç»åç´ ä¸ªæ°ï¼usedè¡¨ç¤ºæ°ç»+é¾è¡¨çåç´ ä¸ªæ°ã\n\nå½æä»¬ådictæ·»å é®å¼å¯¹æ¶ï¼redisé¦åæ ¹æ®keyè®¡ç®åºhashå¼ï¼ç¶åéè¿hash & sizemarkè®¡ç®è¯¥æ°æ®åºè¯¥æ¾å°æ°ç»ä¸­åªä¸ªä½ç½®ã\n\n\n\né¤äºåå¸èç¹ä¸åå¸è¡¨ä¹å¤ï¼dictæåä¸ä¸ªç»æï¼å­å¸ dicthashtable.\n\ntypedef struct dict {\n\tdicttype *type;\n    void *privdata;\n    dictht ht[2];\n    long rehashidx;\n    int16_t pauserehash;\n} ;\n\n\n * *typeï¼æ¬å­å¸çç±»åï¼ä¸åç±»åä½¿ç¨ä¸åhashå½æ°ã\n * *privdata ï¼ç§ææ°æ®ï¼å¨åç¹æ®hashè¿ç®æ¶ä½¿ç¨ã\n * ht[2] ï¼ä¸ä¸ªå­å¸æ¥æä¸¤ä¸ªåå¸è¡¨ï¼ä¸ä¸ªæ¾åå¸èç¹ï¼ä¸ä¸ªä¸ºrehashæ¶ä½¿ç¨ã\n * rehashidx ï¼rehashçè¿åº¦ï¼-1ä»£è¡¨æªå¼å§ã\n * pauserehash ï¼rehashæ¯å¦æåï¼1åæåï¼0åç»§ç»­ã\n\næ»ç» ï¼dictåºå±æ¯åºäºæ°ç»ãé¾è¡¨çhashè¡¨ï¼æ°ç»ä¸­ä¿å­çæ¯ä¸ä¸ªä¸ªentryé®å¼å¯¹ï¼é®å¼å¯¹çç±»åå¤§å¤æ¯æéï¼æåsdså¯¹è±¡ãæ°ç»ä¸­çentryé®å¼å¯¹ç±nextæéè¿æ¥ï¼ä¾¿äºå¯»åã\n\n\n# 2.4 ziplist\n\nåç¼©é¾è¡¨ï¼ä¸ºäºèçåå­èè®¾è®¡çé¾è¡¨ï¼ç±ä¸ç³»åç¹æ®ç¼ç çè¿ç»­ç©ºé´ç»æï¼å¯ä»¥å¨ä»»æä¸ç«¯è¿è¡åå¥/å¼¹åºæä½ï¼å¹¶ä¸è¯¥æä½çæ¶é´å¤æåº¦ä¸º o(1)ã\n\nä½æ¯æä¹è¿ç»­ï¼è´¥ä¹è¿ç»­ï¼ziplistçè¯çæ¯ä¸ºäºè§£å³dictæéè¿å¤ä¸åå­ä¸è¿ç»­çé®é¢ï¼ä¸è¿äº§çäºæ°é®é¢ ï¼ä¸æ¦æ°æ®éå¤ªå¤§ï¼ä¸åªå»æ¾è¿ä¹å¤è¿ç»­çç©ºé´ï¼æä»¥å¾å¤redisçæ°æ®ç±»ååªå¨æ°æ®éå°çæ¶åç¨ziplistã\n\ntypedef struct ziplist {\n    uint32_t albytes;\n    uint32_t zltail;\n    uint16_t zllen;\n    entry *entry;\n    uint8_t zlend;\n} ziplist;\n\n\n * zlbytes ï¼æ»å­èæ°\n * zltail ï¼å°¾èç¹ä¸èµ·å§å°åä¹é´çå­èæ°\n * zllen ï¼entryèç¹çä¸ªæ°\n * zlend ï¼ç»ææ å¿ï¼0xff\n * entry ï¼ziplistä¸­ææèç¹ï¼ä¸ªæ°ãå­èå¤§å°ä¸å®ã\n\n\n\nentryå­èå¤§å°ä¸ç¡®å®ï¼é£éåçæ¶åè¯¥å¦ä½éåå¢ï¼æ°ç»ä¸­çåç´ å­èå¤§å°åºå®ï¼å¯ä»¥ç¥éæ¯æ¬¡è¯»åå ä¸ªå­èçç©ºé´ï¼é¾è¡¨ç´æ¥ä½¿ç¨æéæåä¸ä¸ä¸ªåç´ ï¼é£ä¹entryè¯¥å¦ä½éåï¼\n\nåªè¦å¨entryè¿ä¸ªç»æåé¨è®°å½ä¸ä¸ä½¿ç¨çç©ºé´å°±è¡äºã\n\nä½æ¯entryè®°å½çæ¯ä¸ä¸ä¸ªentryå ç¨çå­èæ°ãï¼redis7æ¹ä¸ºæ­¤entryå­èæ°ï¼\n\næ¯ä¸ä¸ªentryæä¸ä¸ªå­æ®µ ï¼\n\n * previous_entry_length ï¼åä¸èç¹çé¿åº¦ï¼1-5ä¸ªå­èã\n * encoding ï¼æ¬èç¹å±æ§ï¼è®°å½contentçæ°æ®ç±»åï¼æ´æ°/å­ç¬¦ä¸²ï¼ä»¥åé¿åº¦ã\n * contents ï¼ä¿å­èç¹æ°æ®ï¼å¯ä»¥æ¯å­ç¬¦ä¸²ææ´æ°ã\n\nåªè¦ç¥éåä¸ä¸ªèç¹/æ¬èç¹çå­èæ°ï¼å°±å¯ä»¥éåã\n\n\n# 2.5 quicklist\n\nä¸ºäºè§£å³ziplistçé®é¢ï¼quicklistè¯çäºã\n\nziplistçé®é¢æ¯ç©ºé´è¿ç»­ï¼ä½æ¯æ¾ä¸å°å¤ªå¤§çè¿ç»­ç©ºé´ã\n\nä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼quicklistéç¨ä¸¤ç§æ¹æ³ ï¼\n\n * éå¶entryçä¸ªæ°åå¤§å°ã\n * ä½¿ç¨å¤ä¸ªziplistã\n\nä¸ä¸ª5mçæ°æ®ï¼ä½¿ç¨ä¸ä¸ªziplistå¯è½æ¾ä¸å°è¿ç»­ç5mç©ºé´ï¼ä½å¦æå¯ä»¥æ¾å°5ä¸ªè¿ç»­ç1mç©ºé´ï¼å°±å¯ä»¥å°è¿ä¸ªæ°æ®åä¸º5ä»½ï¼ä½¿ç¨5ä¸ªziplistå­å¨ã\n\nredis3.2ä¹åå¼å¥çquicklistæ¯ä¸ä¸ªåç«¯é¾è¡¨ï¼åªä¸è¿æ¯ä¸ä¸ªèç¹é½æ¯ä¸ä¸ªziplistã\n\né¤äºæ§å¶ziplistçå¤§å°ï¼quicklistè¿å¯¹èç¹çziplistè¿è¡åç¼©\n\nquicklistnodeï¼èç¹ï¼æºç ï¼\n\ntypedef struct quicklistnode {\n    // æååä¸ä¸ªç»ç¹çæé\n    struct quicklistnode *pre;\n    // æååä¸ä¸ªèç¹çæé\n    struct quicklistnode *next;\n    // å½åèç¹çziplistæé\n    unsigned char *zl;\n    // å½åèç¹çziplistçå­èæ°\n    unsigned int sz;\n    // å½åèç¹æå±çziplistçentryä¸ªæ°\n    unsigned int count;\n    // ç¼ç æ¹å¼ 1.ziplist  2.lzfåç¼©æ¨¡å¼\n    unsigned int encoding;\n    // æ¯å¦è¢«è§£åç¼© 1è¯´æè¢«è§£åäºï¼ä»¥åè¦éæ°åç¼©\n    unsigned int recompress;\n}\n\n\nquicklistæºç ï¼\n\ntypedef struct quicklist {\n    // å¤´èç¹æé\n    quicklistnode *head;\n    // å°¾èç¹æé\n    quicklistnode *tail;\n    // ææziplistä¸­çentryä¸ªæ°\n    unsigned long count;\n    // ziplistä¸ªæ°\n    unsigned long len;\n    // ziplistçentryæ°éä¸é\n    int fill; // é»è®¤ä¸º2\n}\n\n\n\nï¼æºç å äºä¸ç¹æ²¡ç¨çï¼\n\nå½å­å¨ä¸å®æ°æ®æ¶ï¼quicklistçæ¨¡æ · ï¼\n\n\n\næ»ç» quicklistç¹ç¹ï¼\n\n 1. èç¹ä¸ºziplistçåç«¯é¾è¡¨ã\n 2. æ§å¶ziplistä¸­entryçä¸ªæ°ä»¥åæ¯ä¸ªentryçå¤§å°ã\n 3. ä¸­é´èç¹å¯ä»¥åç¼©ï¼è¿ä¸æ­¥èçåå­ã\n\n\n# 2.6 skiplist\n\nskiplistï¼é¢è¯ä¸­ç»å¸¸é®çè·³è¡¨ï¼è¢«ç§°ä¸ºè·³è¡¨æ¯å ä¸ºå®éåçæ¶åå¯ä»¥âè·³âçéåã\n\nå¯¹äºä¸ä¸ªæåºæ°ç»ï¼å¯ä»¥ä½¿ç¨äºåæ³å¿«éæ¥æ¾ï¼ä½æ¯é¾è¡¨æä¹å¿«éå¢ï¼\n\næ­£å¸¸çé¾è¡¨åªææåååèç¹çæéï¼ä½æ¯è·³è¡¨ä¸ä¸æ ·ï¼å®æéæºä¸ªéæºæéãå¯¹äº1-10è¿å ä¸ªæ°ç»æçè·³è¡¨ï¼å¯è½1è¿ä¸ªåç´ ä¸­ææå5ã6ã9ã10çæéï¼2ææå3ã4ã8ã10çï¼10å¯è½ææå1ã4ã7çæéãè¿æ ·å°±å¯ä»¥éè¿ä¸æ­çè·³è·ãæ¯è¾ï¼å¿«éå¾å°æ³è¦çå¼ãæ­¤ç»ææ­£å ä¸ºè¿ä¸ªç¹ç¹è¢«ç§°ä¸ºè·³è¡¨ã\n\nå½ç¶äºï¼è·³è¡¨çæéæ¯éæºçæçï¼éæºæ§å¤ªå¤§ï¼å¯è½ä¸æ¬¡å°±æ¾å°å¼ï¼å¯è½éè¦ä¸ä¸ªä¸ä¸ªéåã\n\nskiplistï¼è·³è¡¨ï¼é¦åæ¯é¾è¡¨ï¼ä½ä¸ä¼ ç»é¾è¡¨æå ç¹å·®å¼ ï¼\n\n * åç´ ååºæåï¼ä¸è¿ä¸æ¯æç§åç´ è¿è¡æåºï¼èæ¯æ ¹æ®åç´ çæçscoreæåºã\n * èç¹å¯è½åå«å¤ä¸ªæéï¼æéè·¨åº¦éæºã\n\næ­£å ä¸ºè¿ä¸¤ä¸ªç¹ç¹ï¼è·³è¡¨å¯ä»¥è¾¹è·³è·è¾¹æ¯è¾ï¼å¤§å¤§æé«æ¥è¯¢æçã\n\nè·³è¡¨èç¹\n\ntypedef struct zskiplistnode {\n    sds ele;\n    double score;\n    zskiplistnode *backward;\n    struct zskiplistlevel {\n        zskiplistnode *forward;\n        unsigned long span;\n    } level[];\n}zskiplistnode;\n\n\n * ele ï¼èç¹å­å¨çå¼ã\n * score ï¼èç¹çåæ°ï¼ç¨äºæåºã\n * backward ï¼åä¸ä¸ªèç¹çæéã\n * level ï¼å¤çº§ç´¢å¼æ°ç»ï¼ææåç»§èç¹\n * forward ï¼ä¸ä¸ªèç¹å¯è½æå¤ä¸ªlevelï¼forwardæåè¿ä¸ªlevelä»£è¡¨çèç¹ã\n * span ï¼ç´¢å¼è·¨åº¦ï¼ç¬¬ä¸ä¸ªèç¹æåç¬¬åä¸ªèç¹ï¼è·¨åº¦ä¸º9\n\nè·³è¡¨\n\ntypedef struct zskiplist {\n    struct zskiplistnode *header, *tail;\n    unsigned long length;\n    int level;\n}\n\n\n * header tail ï¼å¤´èç¹ãå°¾èç¹ã\n * length ï¼èç¹æ°éã\n * level ï¼æå¤§ç´¢å¼å±çº§ï¼é»è®¤ä¸º1ï¼æå¤§ä¸º32ï¼å³ä¸ä¸ªèç¹çåç»§æéå¯ä»¥æ1-32ä¸ªã\n\n\n\nskiplistç¹ç¹ï¼\n\n 1. ååé¾è¡¨ï¼æ¯ä¸ªèç¹åå«scoreåeleå¼\n 2. èç¹æç§scoreæåºï¼scoreå¼ä¸æ ·åæç§eleæåº\n 3. æ¯ä¸ªèç¹é½å¯ä»¥åå«å¤å±æéï¼å±æ°æ¯1-32çéæºå¼\n 4. ä¸åæéå°ä¸ä¸ä¸ªèç¹çè·¨åº¦ä¸åï¼å±çº§è¶é«ï¼è·¨åº¦è¶å¤§ã\n 5. å¢å æ¹æ¥æçä¸çº¢é»æ åºæ¬ä¸è´ï¼å®ç°å´æ´ç®åã\n\n\n# 3. redisobject\n\nå­¦ä¹ äºä»¥ä¸å ç§æ°æ®ç±»åï¼æä»ä¹ç¨å¢ï¼å¯¹ï¼ç»æredisä¸­å¯ä»¥ä½¿ç¨çæ°æ®ç»æï¼é£ä¹åä¸ªæ°æ®ç»æç¨ä»ä¹æ ·çåºå±å®ç°å¢ï¼å¨åªéå¯ä»¥çå°å¢ï¼å¨åªéè®°å½ä¸æ¥å¢ï¼\n\nredisobject\n\nredisä¸­çä»»ä½æ°æ®ç±»åé½ä¼è¢«å°è£ä¸ºä¸ä¸ªredisobjectï¼ä¹å«årediså¯¹è±¡ã\n\ntypedef struct redisobject {\n    unsigned type:4;\n    unsigned encoding:4;\n    unsigned lru:24; \n    int refcount;\n    void *ptr;\n}\n\n\n * type ï¼æ­¤å¯¹è±¡çç±»åï¼åå«ä¸ºstringãlistãsetãzsetãhash\n\n * encoding ï¼æ­¤å¯¹è±¡çåºå±å®ç°ï¼ä¸è¿°sdsãintsetãdictãskiplist...æ11ä¸ªå¼ã\n\n * lru ï¼è®°å½å½årediså¯¹è±¡æè¿ä¸æ¬¡è®¿é®æ¶é´ï¼ä»¥ä¾¿å°é¿æ¶é´æªä½¿ç¨çå¯¹è±¡åæ¶ã\n\n * refcount ï¼å¯¹è±¡å¼ç¨è®¡æ°å¨ï¼è®¡æ°å¨ä¸º0åè¯´æå¯¹è±¡æ äººä½¿ç¨ï¼å¯ä»¥è¢«åæ¶ã\n\n * *ptr ï¼æåå·ä½å­æ¾æ°æ®çç©ºé´ã\n\ntypeåencodingå­æ®µæ¯æ¬ç¯æç« å³æ³¨çå°æ¹ã\n\nåæ¥ççencodingå­æ®µç11ä¸ªå¼ ï¼\n\nç¼å·   ç¼ç æ¹å¼                      è¯´æ\n0    obj_encoding_int          longç±»åçæ´æ°å­ç¬¦ä¸²\n1    obj_encoding_raw          rawç¼ç çå¨æå­ç¬¦ä¸²\n2    obj_encoding_embstr       embstrç¼ç çå¨æå­ç¬¦ä¸²\n3    obj_encoding_intset       æ´æ°éå\n4    obj_encoding_ziplist      åç¼©åè¡¨\n5    obj_encoding_quicklist    å¿«éåè¡¨\n6    obj_encoding_skiplist     è·³è¡¨\n7    obj_encoding_linkedlist   åç«¯é¾è¡¨\n8    obj_encoding_ht           å­å¸\n9    obj_encoding_zipmap       å·²åºå¼\n10   obj_encoding_stream       streamæµ\n\nå¯ä»¥çå°ï¼stringæä¸ç§ç¼ç æ¹å¼ï¼listæ3ä¸­ç¼ç æ¹å¼ï¼setæä¸ç§ç¼ç æ¹å¼ã\n\n----------------------------------------\n\n\n# 4. æ°æ®ç»æ\n\n\n# 4.1 string\n\nstringæ¯redisæå¸¸è§çæ°æ®å­å¨ç±»åã\n\n * å¦æå­å¨çå­ç¬¦ä¸²é¿åº¦å°äº44å­èï¼åä¼ä½¿ç¨embstrç¼ç ãæ­¤æ¶object headä¸sdsæ¯ä¸çè¿ç»­ç©ºé´ï¼ç³è¯·åå­æ¶åªéè¦è°ç¨ä¸æ¬¡åå­åå­åéå½æ°ï¼æçæ´é«ã\n\n * sdsé¿åº¦å¤§äº44ï¼ç¼ç æ¹å¼æ¯rawãobject headä¸sdsä¸åè¿ç»­\n\n\n\n * å¦æsdsçåå®¹æ¯æ°å­ï¼å¹¶ä¸è¿ä¸ªæ°å­å¨long_maxèå´åå°±ä½¿ç¨intç¼ç æ¹å¼ãintç¼ç æ¹å¼ç´æ¥å°æ°æ®å­å¨redisobjectçptræéä½ç½®ï¼åå¥½8å­èï¼ï¼ä¸éè¦sdsäºã\n\n\n\nå¯ä»¥çåºææ¾åºå« ï¼embstrçç©ºé´æ¯è¿ç»­çï¼å ä¸ºå­ç¬¦ä¸²ä½ç§¯å°ï¼å®¹æç³è¯·è¿ç»­ç©ºé´ã\n\nä»¥ä¸årediså­å¨åä¸ªå¼ï¼åå«ä¸º æ°å­ãç­å­ç¬¦ä¸²ã44ä½å­ç¬¦ä¸²ã45ä½å­ç¬¦ä¸²ï¼æ¥ççç¼ç æ¹å¼ç»æå¦ä¸ï¼\n\nyun:0>set a 12\n"ok"\nyun:0>object encoding a\n"int"\nyun:0>set b xiaoming\n"ok"\nyun:0>object encoding b\n"embstr"\nyun:0>set c 01234567890123456789012345678901234567890123\n"ok"\nyun:0>object encoding c\n"embstr"\nyun:0>set d 012345678901234567890123456789012345678901234\n"ok"\nyun:0>object encoding d\n"raw"\n\n\n\n# 4.2 list\n\nlistæ¥æä¸ç§ç¼ç æ¹å¼ ï¼linkedlistãziplistãquicklistãèªä»quickliståºç°åå°±å¾å°ç¨linkedlistäºã\n\næä»¥å¨redis3.2çæ¬åï¼redisç»ä¸éç¨quicklistå®ç°listã\n\n\n\n\n# 4.3 set\n\n * å½å­å¨çæ°æ®å¨é¨ä¸ºæ´æ°ï¼ä¸åç´ æ°éä¸è¶è¿set-max-intset-emtriesæ¶ï¼setä½¿ç¨intsetç¼ç \n\n * å¶ä»æåµä½¿ç¨dictç¼ç ï¼ä½¿ç¨å®çkeyï¼valueç»ä¸ä¸ºnullã\n\n\n\n\n# 4.4 zset\n\nzsetä¹å°±æ¯sortedsetï¼æ¯ä¸ä¸ªåç´ é½æä¸ä¸ªç¨äºæåºçscoreå¼ãzsetçç¹ç¹ ï¼\n\n * scoreå¼ç¨äºæåº\n * é®å¯ä¸\n * å¯ä»¥æ ¹æ®é®æ¥è¯¢åæ°\n\nçèµ·æ¥å¯ä»¥ç¨skiplistï¼ä½æ¯è·³è¡¨çé®ä¸å¯ä¸ï¼èä¸å®çscoreè½ç¶å¯ä»¥æåºï¼ä½æ æ³æ¥è¯¢ã\n\nçèµ·æ¥å¯ä»¥ç¨dictï¼ä½dictæ æ³æåºã\n\né£ä¹æä»¬å°å®ä»¬ç»åèµ·æ¥ä¸å°±è¡äºï¼ä¸ä¸ªzsetåå«ä¸ä¸ªskipliståä¸ä¸ªdictï¼æ·»å åç´ æ¶åådictæ·»å ï¼ä¿è¯åç´ å¯ä¸ï¼å¦æåç´ å¯ä¸ååskiplistæ·»å ï¼ä¿è¯å¯æåºã\n\ntypedef struct zset {\n    dict *dict;\n    zskiplist *zsl;\n}\n\n\nè½ç¶zsetä½¿ç¨äºä¸¤ç§ç»æï¼ä½å®çç¼ç åæskiplistã\n\nä½æ¯å½åç´ æ°éå°äº128æåç´ å¤§å°å°äº64å­èæ¶ï¼zsetä¼ä½¿ç¨ziplistèçç©ºé´ã\n\n * åç´ æ°éå°äº128æåç´ å¤§å°å°äº64å­èæ¶ï¼ä½¿ç¨ziplistèçç©ºé´ã\n * å¶ä»æåµä½¿ç¨ dict + skiplistã\n\n\n\n\n# 4.5 hash\n\nhashç»æä¸redisä¸­çzsetå¾å\n\n * é®å¼å­å¨\n * å¯ä»¥æ ¹æ®é®è·åå¼\n * é®å¯ä¸\n\näºèå·®å«ä¾å¦zsetçå¼å¿é¡»æ¯æ°å­ï¼ç¨äºæåºãèhashç»æä¸ç¨æåºã\n\nhashåºå±éç¨çç¼ç ä¸zsetåºæ¬ä¸è´ï¼åªéè¦ææåºæå³çskiplistå»æå³å¯ ï¼\n\n * hashé»è®¤ä½¿ç¨ziplistç¼ç ï¼ä»¥èçåå­ãziplistçç¸é»ä¸¤ä¸ªentryåå«å­å¨é®ãå¼ã\n * å½åç´ æ°éè¶è¿512æä»»æä¸ä¸ªentryèç¹å¤§å°è¶è¿64å­èæ¶hashç»æä¼è½¬ä¸ºhtç¼ç ï¼ä¹å°±æ¯dictã\n\n\n\n\n# 4.6 æ»ç»\n\n\n# 5. åºç¨åºæ¯\n\n\n# 5.1 string\n\n 1. ç¨äºåç¼å­\n 2. setnx æä½çæåå¸å¼é\n 3. è¿æ¶å¯ä»¥ç¨äºè®¡æ°å¨ãå½æ°æ®æ¯æ°å­æ¶ï¼stringä¸ä¼åå»ºæ°çsdså¯¹è±¡ï¼èæ¯å°æ°å­å­å¨å¨redisobjectçpträ¸ï¼éå¸¸èçç©ºé´ã\n\nç¨äºè®¡æ°å¨ä¸å¹¶åéé«çæåµä¸ï¼åå¦ç¨äºæç« æµè§éï¼ä½ çæå¡æåä¸º10å°æºå¨ï¼è¿10å°æºå¨å¯è½åæ¶æ¢å¤ºæµè§éä¸º100çè¿ä¸ªæ°å­ï¼é£ä¹åªæä¸å°æºå¨å¯ä»¥æåï¼å©ä¸9å°é½ä¼å¤±è´¥ï¼æçå¤ªä½ãæ­¤æ¶æä»¬å¯ä»¥ä½¿ç¨incrbyï¼ä¸å°æºå¨è¿æ¥ï¼æä»¬ç»å®100ä¸ªæµè§éï¼å®èªå·±ç¨å»å§ï¼redisä¸­çæ°æ®ç´æ¥incrby 100å³å¯ãè¿æ ·å°±å¯ä»¥æé«æçã\n\n\n# 5.2 list\n\nlistæ¯æåç«¯æå¥ãè®¿é®\n\nç¨ä½ä¿¡æ¯æµãä¾å¦ä½ å³æ³¨å¾å¤å¬ä¼å·ï¼è¿äºå¬ä¼å·åçæç« é½å¯ä»¥å¡è¿ä½ çlistä¸­\n\n\n# 5.3 set\n\nå¾å¤äººç¨setçåå ä¼°è®¡å°±æ¯å¼å¯ä¸å§ï¼è¿ä¸ªå°±å¯ä»¥ç¨ä½ç¹èµåè¡¨ãå¥½ååè¡¨ãå³æ³¨åè¡¨ãæ¶èç­ç­..\n\nåæ¶å®å¯ä»¥æ±äº¤éãå¹¶éï¼è¿æ ·å°±æ¯æâå±åå¥½åâãâä½ å¯è½è®¤è¯çäººâç­ç­æä½\n\n\n# 5.4 zset\n\nzsetå¯ä»¥æ ¹æ®scoreæåºï¼åæ¶ä¿è¯å¼å¯ä¸ãå¸¸ç¨äºæè¡æ¦ã\n\n\n# 5.5 hash\n\nå¯ç¨äºè´­ç©è½¦ï¼hashçæä½å¾å¥åâè´­ç©è½¦âè¿ä¸åè½éæ± ï¼å¢å å é¤ååãå¢å åå°æä¸ªååçæ°éãéä¸­å¨é¨ãè·åå¨é¨ååçæ°é....',charsets:{cjk:!0},lastUpdated:"2023/06/11, 12:28:11",lastUpdatedTimestamp:1686457691e3},{title:"Redisåå­åæ¶",frontmatter:{title:"Redisåå­åæ¶",date:"2023-06-11T12:25:09.000Z",permalink:"/pages/73749d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/10.Redis/30.Redis%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6.html",relativePath:"02.æç« /10.Redis/30.Redisåå­åæ¶.md",key:"v-f8cd9c4a",path:"/pages/73749d/",headers:[{level:2,title:"1. è¿æåæ¶",slug:"_1-è¿æåæ¶",normalizedTitle:"1. è¿æåæ¶",charIndex:16},{level:2,title:"2. åå­æ·æ±°",slug:"_2-åå­æ·æ±°",normalizedTitle:"2. åå­æ·æ±°",charIndex:853}],headersStr:"1. è¿æåæ¶ 2. åå­æ·æ±°",content:"# Redisåå­åæ¶\n\n\n# 1. è¿æåæ¶\n\nRedisæ¯æè®¾ç½®æ°æ®æææ¶é´ï¼æææè¿äºæ°æ®å°±å é¤æï¼é£ä¹Redisè¯å®è¦å¢å å­æ®µè®°å½æ°æ®çæææï¼å¦ä½å¢å å­æ®µå¢ï¼æ°æ®å°æç«é©¬å é¤åï¼\n\næ¥ä¸æ¥ççRediséç¨çè¿æåæ¶ç­ç¥ï¼\n\nRedisæ¬èº«æ¯ä¸ä¸ªé®å¼åçæ°æ®åºï¼å æ­¤ææçæ°æ®é½ä¿å­å¨Dictä¸­ï¼ä¸è¿å¨å¶databaseç»æä½ä¸­æä¸¤ä¸ªDictï¼ä¸ä¸ªå­å¨æææ°æ®ï¼ä¸ä¸ªå­å¨ættlçæ°æ®ã\n\ntypedef struct redisdb {\n    dict *dict;\n    dict *expires;\n    ...\n    ...\n}\n\n\n * dict ï¼ä»¥key-valueå½¢å¼å­å¨æææ°æ®\n * expires ï¼ä»¥key-ttlå½¢å¼å­å¨å¸¦æè¿ææ¶é´çæ°æ®ã\n\næ³ç¥éä¸ä¸ªkeyæ¯å¦è¿æï¼æ¿çkeyå»ç¬¬äºä¸ªDictæ¥å°±è¡äºã\n\né£ä¹æ°æ®å°æç«å³å é¤åï¼\n\nä¸åçkeyå¸¦æä¸åçè¿ææ¶é´ï¼å¦æç»æ¯ä¸ä¸ªkeyé½è®¾ç½®å®æ¶ä»»å¡ï¼å¤ªæµªè´¹èµæºã\n\nRediséç¨ä¸¤ç§å é¤æºå¶ï¼\n\n 1. æ°æ§å é¤ ï¼æ¯æ¬¡è®¿é®æ¶å¤æ­æ¯å¦è¿æï¼è¿æåå é¤ã\n 2. å¨æå é¤ ï¼éè¿å®æ¶ä»»å¡å¨ææ§çæ½é¨åè¿ækeyå é¤ã\n\næ°æ§å é¤çä¼ç¹åç¼ºç¹é½å¾ææ¾ï¼å®ä¸å¿å¼å¯é¢å¤çä»»å¡ï¼åªéè¦å¨è®¿é®æ¶å¤æ­ãä½æ¯è¿ææ°æ®ä¸ç´ä¸è®¿é®å¢ï¼å°±ä¼éçå¨åå­ã\n\nå¨æå é¤åæä¸¤ç§æ¹å¼ï¼\n\n 1. SLOW ï¼Redisè®¾ç½®ä¸ä¸ªå®æ¶ä»»å¡serverCron()ï¼æç§1ç§10æ¬¡çé¢çæ§è¡è¿æKeyæ¸çã\n 2. FAST ï¼Redisçæ¯ä¸ªäºä»¶å¾ªç¯åä¼è°ç¨beforeSleep()ï¼æ§è¡è¿æKeyæ¸çã\n\nè¿ä¸¤ç§ç­ç¥æè§å°±åè¿·ä½ ççFullGCåMinorGCã\n\n> Q ï¼Rediså¦ä½ç¥éåªäºkeyè¿æäºï¼\n> \n> A ï¼ä½¿ç¨ä¸¤ä¸ªDictï¼ä¸ä¸ªå­æ¾key-valueï¼ä¸ä¸ªå­æ¾key-ttl\n\n> Q ï¼æ°æ®è¿æç«é©¬å é¤åï¼\n> \n> A ï¼ææ°æ§å é¤åå¨æå é¤ä¸¤ç§ç­ç¥ï¼å¨æå é¤æä¸¤ç§æ¹å¼ï¼FASTãSLOWã\n\n\n# 2. åå­æ·æ±°\n\nåå­æ·æ±° ï¼å½Redisåå­ä½¿ç¨è¾¾å°è®¾ç½®çéå¼æ¶ï¼Redisä¸»å¨æéé¨åkeyå é¤æ¥éæ¾æ´å¤çåå­ã\n\nRedisæå«ç§ä¸åçæ·æ±°ç­ç¥ ï¼\n\nç­ç¥                ä½ç¨\nnoeviction        é»è®¤ç­ç¥ï¼ä¸æ·æ±°ä»»ä½æ°æ®ï¼ä¸åè®¸åå¥æ°æ°æ®\nvolatile-ttl      å¯¹è®¾ç½®äºttlçæ°æ®æ¯è¾ï¼æ·æ±°å¿«è¿æçæ°æ®\nallkeys-random    å¨ä½æ°æ®éå³æ·æ±°\nvolatile-random   è®¾ç½®äºttlçæ°æ®ï¼éå³æ·æ±°\nallkeys-lru       å¨ä½æ°æ®ï¼åºäºlruç®æ³è¿è¡æ·æ±°\nvolatile-lru      è®¾ç½®äºttlçæ°æ®ï¼åºäºlruç®æ³è¿è¡æ·æ±°\nallkeys-lfu       å¨ä½æ°æ®ï¼åºäºlfuç®æ³è¿è¡æ·æ±°\nvolatile-lfu      è®¾ç½®äºttlçæ°æ®ï¼åºäºlfuç®æ³è¿è¡æ·æ±°\n\n * ==LRU==\n   \n   Least Recently Used æå°æè¿ä½¿ç¨\n   \n   ç¨å½åæ¶é´åå»æåä¸æ¬¡è®¿é®æ¶é´ï¼è¿ä¸ªå¼è¶å¤§ï¼æ·æ±°ä¼åçº§è¶é«ã\n\n * ==LFU==\n   \n   Least Frequently Used æå°é¢çä½¿ç¨\n   \n   ç»è®¡æ¯ä¸ä¸ªkeyçè®¿é®é¢çï¼é¢çè¶å°æ·æ±°ä¼åçº§è¶é«ã",normalizedContent:"# redisåå­åæ¶\n\n\n# 1. è¿æåæ¶\n\nredisæ¯æè®¾ç½®æ°æ®æææ¶é´ï¼æææè¿äºæ°æ®å°±å é¤æï¼é£ä¹redisè¯å®è¦å¢å å­æ®µè®°å½æ°æ®çæææï¼å¦ä½å¢å å­æ®µå¢ï¼æ°æ®å°æç«é©¬å é¤åï¼\n\næ¥ä¸æ¥ççrediséç¨çè¿æåæ¶ç­ç¥ï¼\n\nredisæ¬èº«æ¯ä¸ä¸ªé®å¼åçæ°æ®åºï¼å æ­¤ææçæ°æ®é½ä¿å­å¨dictä¸­ï¼ä¸è¿å¨å¶databaseç»æä½ä¸­æä¸¤ä¸ªdictï¼ä¸ä¸ªå­å¨æææ°æ®ï¼ä¸ä¸ªå­å¨ættlçæ°æ®ã\n\ntypedef struct redisdb {\n    dict *dict;\n    dict *expires;\n    ...\n    ...\n}\n\n\n * dict ï¼ä»¥key-valueå½¢å¼å­å¨æææ°æ®\n * expires ï¼ä»¥key-ttlå½¢å¼å­å¨å¸¦æè¿ææ¶é´çæ°æ®ã\n\næ³ç¥éä¸ä¸ªkeyæ¯å¦è¿æï¼æ¿çkeyå»ç¬¬äºä¸ªdictæ¥å°±è¡äºã\n\né£ä¹æ°æ®å°æç«å³å é¤åï¼\n\nä¸åçkeyå¸¦æä¸åçè¿ææ¶é´ï¼å¦æç»æ¯ä¸ä¸ªkeyé½è®¾ç½®å®æ¶ä»»å¡ï¼å¤ªæµªè´¹èµæºã\n\nrediséç¨ä¸¤ç§å é¤æºå¶ï¼\n\n 1. æ°æ§å é¤ ï¼æ¯æ¬¡è®¿é®æ¶å¤æ­æ¯å¦è¿æï¼è¿æåå é¤ã\n 2. å¨æå é¤ ï¼éè¿å®æ¶ä»»å¡å¨ææ§çæ½é¨åè¿ækeyå é¤ã\n\næ°æ§å é¤çä¼ç¹åç¼ºç¹é½å¾ææ¾ï¼å®ä¸å¿å¼å¯é¢å¤çä»»å¡ï¼åªéè¦å¨è®¿é®æ¶å¤æ­ãä½æ¯è¿ææ°æ®ä¸ç´ä¸è®¿é®å¢ï¼å°±ä¼éçå¨åå­ã\n\nå¨æå é¤åæä¸¤ç§æ¹å¼ï¼\n\n 1. slow ï¼redisè®¾ç½®ä¸ä¸ªå®æ¶ä»»å¡servercron()ï¼æç§1ç§10æ¬¡çé¢çæ§è¡è¿ækeyæ¸çã\n 2. fast ï¼redisçæ¯ä¸ªäºä»¶å¾ªç¯åä¼è°ç¨beforesleep()ï¼æ§è¡è¿ækeyæ¸çã\n\nè¿ä¸¤ç§ç­ç¥æè§å°±åè¿·ä½ ççfullgcåminorgcã\n\n> q ï¼rediså¦ä½ç¥éåªäºkeyè¿æäºï¼\n> \n> a ï¼ä½¿ç¨ä¸¤ä¸ªdictï¼ä¸ä¸ªå­æ¾key-valueï¼ä¸ä¸ªå­æ¾key-ttl\n\n> q ï¼æ°æ®è¿æç«é©¬å é¤åï¼\n> \n> a ï¼ææ°æ§å é¤åå¨æå é¤ä¸¤ç§ç­ç¥ï¼å¨æå é¤æä¸¤ç§æ¹å¼ï¼fastãslowã\n\n\n# 2. åå­æ·æ±°\n\nåå­æ·æ±° ï¼å½redisåå­ä½¿ç¨è¾¾å°è®¾ç½®çéå¼æ¶ï¼redisä¸»å¨æéé¨åkeyå é¤æ¥éæ¾æ´å¤çåå­ã\n\nredisæå«ç§ä¸åçæ·æ±°ç­ç¥ ï¼\n\nç­ç¥                ä½ç¨\nnoeviction        é»è®¤ç­ç¥ï¼ä¸æ·æ±°ä»»ä½æ°æ®ï¼ä¸åè®¸åå¥æ°æ°æ®\nvolatile-ttl      å¯¹è®¾ç½®äºttlçæ°æ®æ¯è¾ï¼æ·æ±°å¿«è¿æçæ°æ®\nallkeys-random    å¨ä½æ°æ®éå³æ·æ±°\nvolatile-random   è®¾ç½®äºttlçæ°æ®ï¼éå³æ·æ±°\nallkeys-lru       å¨ä½æ°æ®ï¼åºäºlruç®æ³è¿è¡æ·æ±°\nvolatile-lru      è®¾ç½®äºttlçæ°æ®ï¼åºäºlruç®æ³è¿è¡æ·æ±°\nallkeys-lfu       å¨ä½æ°æ®ï¼åºäºlfuç®æ³è¿è¡æ·æ±°\nvolatile-lfu      è®¾ç½®äºttlçæ°æ®ï¼åºäºlfuç®æ³è¿è¡æ·æ±°\n\n * ==lru==\n   \n   least recently used æå°æè¿ä½¿ç¨\n   \n   ç¨å½åæ¶é´åå»æåä¸æ¬¡è®¿é®æ¶é´ï¼è¿ä¸ªå¼è¶å¤§ï¼æ·æ±°ä¼åçº§è¶é«ã\n\n * ==lfu==\n   \n   least frequently used æå°é¢çä½¿ç¨\n   \n   ç»è®¡æ¯ä¸ä¸ªkeyçè®¿é®é¢çï¼é¢çè¶å°æ·æ±°ä¼åçº§è¶é«ã",charsets:{cjk:!0},lastUpdated:"2023/06/11, 12:28:11",lastUpdatedTimestamp:1686457691e3},{title:"Rediså¨åµéç¾¤",frontmatter:{title:"Rediså¨åµéç¾¤",date:"2023-07-03T21:08:01.000Z",permalink:"/pages/3743cc/"},regularPath:"/02.%E6%96%87%E7%AB%A0/10.Redis/50.Redis%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4.html",relativePath:"02.æç« /10.Redis/50.Rediså¨åµéç¾¤.md",key:"v-1ca94746",path:"/pages/3743cc/",headers:[{level:2,title:"1. ä»ä¹æ¯å¨åµ",slug:"_1-ä»ä¹æ¯å¨åµ",normalizedTitle:"1. ä»ä¹æ¯å¨åµ",charIndex:213},{level:2,title:"2. çæ§",slug:"_2-çæ§",normalizedTitle:"2. çæ§",charIndex:553},{level:2,title:"3. èªå¨æéè¿ç§»",slug:"_3-èªå¨æéè¿ç§»",normalizedTitle:"3. èªå¨æéè¿ç§»",charIndex:395},{level:2,title:"4. sentineléä¸¾é¢å¯¼è",slug:"_4-sentineléä¸¾é¢å¯¼è",normalizedTitle:"4. sentineléä¸¾é¢å¯¼è",charIndex:1531}],headersStr:"1. ä»ä¹æ¯å¨åµ 2. çæ§ 3. èªå¨æéè¿ç§» 4. sentineléä¸¾é¢å¯¼è",content:"# Rediså¨åµéç¾¤\n\nå¨ä¸ä¸ç¯Redisä¸»ä»éç¾¤åçä¸­ï¼æä»¬å­¦ä¹ äºä¸»ä»æ¶æï¼æç½äºä½¿ç¨ä¸»ä»éç¾¤ä¿è¯ç³»ç»é«å¯ç¨çåçï¼ä½æ¯å¨ç»å°¾ä¹å¼ºè°äºä¸ä¸ªé®é¢ï¼\n\nä¸»ä»éç¾¤çç¼ºç¹\n\nå¨ä¸ä¸»ä¸ä»æèä¸ä¸»å¤ä»çæåµä¸ï¼å¦æä¸»æå¡å¨æäºï¼å¯¹å¤æä¾çæå¡å°±ä¸å¯ç¨äºï¼åç¹é®é¢æ²¡æè§£å³ã\n\næä¹è§£å³å¢ï¼æä»¬å¯ä»¥åé´ZooKeeperçåæ³ï¼å¦æä¸»èç¹å®æºï¼å¨è¯¸å¤ä»èç¹ä¸­éä¸ä¸ªå½ä¸»èç¹å°±è¡äºãé£ä¹è°æ¥éå¢ï¼è¿å°±æ¯æ¬ç¯å°è¦å­¦ä¹ çåå®¹ï¼å¨åµã\n\n\n# 1. ä»ä¹æ¯å¨åµ\n\nå¨åµæ¨¡å¼æ¯Redisçé«å¯ç¨æ¹å¼ï¼å¨åµèç¹ä¹æ¯ä¸ä¸ªRedisèç¹ï¼ä¸è¿å®ä¸æä¾æ°æ®è¯»åæå¡ï¼ä¸»è¦ç¨æ¥çæ§Redisçææèç¹ã\n\nRediså¨åµçä½ç¨ï¼\n\n 1. çè§ ï¼å¨åµä¼ä¸æ­æ£æ¥ä¸»èç¹ä¸ä»èç¹æ¯å¦æ­£å¸¸è¿è¡ã\n 2. æé ï¼Sentineåå½Rediså®¢æ·ç«¯çæå¡åç°æ¥æºï¼å½éç¾¤åçæéè½¬ç§»æ¶ï¼ä¼å°ææ°æ¶æ¯æ¨éç»Rediså®¢æ·ç«¯ã\n 3. èªå¨æéè¿ç§» ï¼å¦æmasteråºç°æéï¼Sentinelä¼å°ä¸ä¸ªslaveæåä¸ºmasterãå½æéå®ä¾æ¢å¤åä¹ä»¥æ°çmasterä¸ºä¸»ã\n\nå½é¨ç½²Redisä¸»ä»éç¾¤åï¼å¯ä»¥åé¨ç½²å¨åµéç¾¤ç¨äºçè§ä¸»ä»éç¾¤ï¼\n\n\n\nä»å¾ä¸­å¯ä»¥çåºæ¥ï¼å¨åµä¹å¯ä»¥æ¯ä¸ä¸ªéç¾¤ï¼ä½ æ¯æ¥çæ§å«äººçï¼ç»æä½ èªå·±æäºï¼è¿ä¸ç¬è¯åã\n\n\n# 2. çæ§\n\nSentinelåºäºå¿è·³æºå¶æ£æµæå¡ç¶æï¼æ¯é1såéç¾¤ä¸­çæ¯ä¸ä¸ªèç¹åépingå½ä»¤ï¼å¦æèç¹åå¤è¯æå®æ²¡é®é¢ï¼å¦æ master èç¹åå¤ PING å½ä»¤çæ¶é´è¶è¿ down-after-milliseconds è®¾å®çéå¼ï¼é»è®¤30sï¼ï¼åè¿ä¸ªèç¹ä¼è¢« sentinel æ è®°ä¸ºä¸»è§ä¸çº¿ï¼å ä¸ºè¿ä¸ªpingå½ä»¤å¯è½å ä¸ºç½ç»å»¶è¿æ²¡æåæ¶æ¶å°åå¤ï¼æä»¥è¿æ¯æ­¤å¨åµä¸»è§è®¤ä¸ºèç¹ä¸çº¿äºã\n\nå½sentinel å¨åµèç¹å°èç¹æ è®°ä¸ºä¸»è§ä¸çº¿åï¼ä¼åå¶ä½ææç sentinel åésentinel is-master-down-by-addræ¶æ¯ï¼è¯¢é®å¶ä»sentinelæ¯å¦åæè¯¥èç¹ä¸çº¿ï¼å¦æè¶è¿è§å®æ°é(é»è®¤ä¸å)çsetinelåæï¼ä¹å°±æ¯è¶è¿ä¸è¬æ°éçsetinelé½è®¤ä¸ºè¿ä¸ªèç¹ä¸»è§ä¸çº¿ï¼é£ä¹å®å°±ä¼è¢«æ è®°ä¸ºå®¢è§ä¸çº¿ã\n\n * ä¸»è§ä¸çº¿ ï¼å¦ææsetinelåç°æèç¹æªå¨è§å®æ¶é´åååºï¼åè®¤ä¸ºè¯¥èç¹ä¸»è§ä¸çº¿ã\n * å®¢è§ä¸çº¿ ï¼è¥è¶è¿æå®æ°éçsentinelé½è®¤ä¸ºè¯¥èç¹ä¸»è§ä¸çº¿ï¼åè¯¥èç¹å®¢è§ä¸çº¿ï¼ä¼è§¦åéç¥æå¡å°è¯¥èç¹çæåµéç¥ç»å®¢æ·ç«¯ãï¼æå®æ°éæå¥½è®¾ç½®ä¸ºå¨åµæ°éçä¸åå¤ï¼\n\n\n# 3. èªå¨æéè¿ç§»\n\nä¹å°±æ¯éæ°éä¸¾ä¸»èç¹ã\n\nä¸æ¦åç° master æéï¼sentinel éè¦å¨slaveä¸­éæ©ä¸ä¸ªä½ä¸ºæ°çmasterãéä¸¾çä¾æ®ï¼\n\n 1. éæ©ä¼åçº§æé«çèç¹ï¼éè¿sentineléç½®æä»¶ä¸­çreplica-priorityéç½®é¡¹ï¼è¿ä¸ªåæ°è¶å°ï¼è¡¨ç¤ºä¼åçº§è¶é«\n 2. å¦æç¬¬ä¸æ­¥ä¸­çä¼åçº§ç¸åï¼éæ©offsetæå¤§çï¼offsetè¡¨ç¤ºä¸»èç¹åä»èç¹åæ­¥æ°æ®çåç§»éï¼è¶å¤§è¡¨ç¤ºåæ­¥çæ°æ®è¶å¤\n 3. å¦æç¬¬äºæ­¥offsetä¹ç¸åï¼éæ©run idè¾å°ç\n\nå½éä¸­äºå¶ä¸­ä¸ä¸ªslaveä¸ºæ°çmaster (åå¦ä¸ºslave1)åï¼æéçè½¬ç§»è¿ç¨å¦ä¸ï¼\n\n * sentineléç¾¤ç»slave1åéslaveof no oneå½ä»¤ï¼è®©è¯¥èç¹ç§°ä¸ºmasterã\n * sentineléç¾¤ç»å¶ä»èç¹åéå¹¿æ­æ¶æ¯ï¼è®©å¶ä»slaveèç¹ç§°ä¸ºæ°masterçä»èç¹ï¼å¼å§ä»æ°çmasterä¸­åæ­¥æ°æ®ã\n * sentinelå°æéèç¹æ è®°ä¸ºslaveï¼å½æéèç¹æ¢å¤åä¼èªå¨æä¸ºæ°çmasterçslaveèç¹ã\n\n\n# 4. sentineléä¸¾é¢å¯¼è\n\nå¶å®ä¸é¢çæè¿°å¹¶ä¸åç¡®ï¼æéè½¬ç§»æ¯æä¸ä¸ªsentinelèç¹åçï¼èä¸æ¯æ´ä¸ªsentineléç¾¤åçï¼é£ä¹è°æ¥åè¿ä»¶äºå¢ï¼ä¸ä¸ªsentineléç¾¤æ¯æä¸ä¸ªå¤´sentinelçï¼ç±å®æ¥å®æä¸»èç¹çéä¸¾ã\n\nå½ä¸»èç¹è¢«å®¢è§ä¸çº¿åï¼åä¸ªå¨åµèç¹ä¼éä¸¾åºä¸ä¸ªé¢å¯¼èå¨åµèç¹ï¼å¹¶ç±è¯¥é¢å¯¼èèç¹å¯¹å¶è¿è¡æéè½¬ç§»æä½ã\n\nçè§è¯¥ä¸»èç¹çææå¨åµé½æå¯è½ç§°ä¸ºé¢å¯¼èï¼éä¸¾ä½¿ç¨Raftç®æ³ï¼å¨æ²¡ææ°æ®å¯ä»¥è¿è¡æ¯è¾çæåµä¸ï¼Raftçéä¸¾æ´åæ¯åå°åå¾ï¼å¨ä¸è½®éä¸¾ä¸­ï¼å¨åµAåBåéæä¸ºé¢å¯¼èçç³è¯·ï¼å¦æBæ²¡æåæè¿å¶ä»å¨åµï¼åä¼åæAæä¸ºé¢å¯¼èãéä¸¾çå·ä½è¿ç¨å¯ä»¥æ¥éRaftç®æ³ã\n\nâ",normalizedContent:"# rediså¨åµéç¾¤\n\nå¨ä¸ä¸ç¯redisä¸»ä»éç¾¤åçä¸­ï¼æä»¬å­¦ä¹ äºä¸»ä»æ¶æï¼æç½äºä½¿ç¨ä¸»ä»éç¾¤ä¿è¯ç³»ç»é«å¯ç¨çåçï¼ä½æ¯å¨ç»å°¾ä¹å¼ºè°äºä¸ä¸ªé®é¢ï¼\n\nä¸»ä»éç¾¤çç¼ºç¹\n\nå¨ä¸ä¸»ä¸ä»æèä¸ä¸»å¤ä»çæåµä¸ï¼å¦æä¸»æå¡å¨æäºï¼å¯¹å¤æä¾çæå¡å°±ä¸å¯ç¨äºï¼åç¹é®é¢æ²¡æè§£å³ã\n\næä¹è§£å³å¢ï¼æä»¬å¯ä»¥åé´zookeeperçåæ³ï¼å¦æä¸»èç¹å®æºï¼å¨è¯¸å¤ä»èç¹ä¸­éä¸ä¸ªå½ä¸»èç¹å°±è¡äºãé£ä¹è°æ¥éå¢ï¼è¿å°±æ¯æ¬ç¯å°è¦å­¦ä¹ çåå®¹ï¼å¨åµã\n\n\n# 1. ä»ä¹æ¯å¨åµ\n\nå¨åµæ¨¡å¼æ¯redisçé«å¯ç¨æ¹å¼ï¼å¨åµèç¹ä¹æ¯ä¸ä¸ªredisèç¹ï¼ä¸è¿å®ä¸æä¾æ°æ®è¯»åæå¡ï¼ä¸»è¦ç¨æ¥çæ§redisçææèç¹ã\n\nrediså¨åµçä½ç¨ï¼\n\n 1. çè§ ï¼å¨åµä¼ä¸æ­æ£æ¥ä¸»èç¹ä¸ä»èç¹æ¯å¦æ­£å¸¸è¿è¡ã\n 2. æé ï¼sentineåå½rediså®¢æ·ç«¯çæå¡åç°æ¥æºï¼å½éç¾¤åçæéè½¬ç§»æ¶ï¼ä¼å°ææ°æ¶æ¯æ¨éç»rediså®¢æ·ç«¯ã\n 3. èªå¨æéè¿ç§» ï¼å¦æmasteråºç°æéï¼sentinelä¼å°ä¸ä¸ªslaveæåä¸ºmasterãå½æéå®ä¾æ¢å¤åä¹ä»¥æ°çmasterä¸ºä¸»ã\n\nå½é¨ç½²redisä¸»ä»éç¾¤åï¼å¯ä»¥åé¨ç½²å¨åµéç¾¤ç¨äºçè§ä¸»ä»éç¾¤ï¼\n\n\n\nä»å¾ä¸­å¯ä»¥çåºæ¥ï¼å¨åµä¹å¯ä»¥æ¯ä¸ä¸ªéç¾¤ï¼ä½ æ¯æ¥çæ§å«äººçï¼ç»æä½ èªå·±æäºï¼è¿ä¸ç¬è¯åã\n\n\n# 2. çæ§\n\nsentinelåºäºå¿è·³æºå¶æ£æµæå¡ç¶æï¼æ¯é1såéç¾¤ä¸­çæ¯ä¸ä¸ªèç¹åépingå½ä»¤ï¼å¦æèç¹åå¤è¯æå®æ²¡é®é¢ï¼å¦æ master èç¹åå¤ ping å½ä»¤çæ¶é´è¶è¿ down-after-milliseconds è®¾å®çéå¼ï¼é»è®¤30sï¼ï¼åè¿ä¸ªèç¹ä¼è¢« sentinel æ è®°ä¸ºä¸»è§ä¸çº¿ï¼å ä¸ºè¿ä¸ªpingå½ä»¤å¯è½å ä¸ºç½ç»å»¶è¿æ²¡æåæ¶æ¶å°åå¤ï¼æä»¥è¿æ¯æ­¤å¨åµä¸»è§è®¤ä¸ºèç¹ä¸çº¿äºã\n\nå½sentinel å¨åµèç¹å°èç¹æ è®°ä¸ºä¸»è§ä¸çº¿åï¼ä¼åå¶ä½ææç sentinel åésentinel is-master-down-by-addræ¶æ¯ï¼è¯¢é®å¶ä»sentinelæ¯å¦åæè¯¥èç¹ä¸çº¿ï¼å¦æè¶è¿è§å®æ°é(é»è®¤ä¸å)çsetinelåæï¼ä¹å°±æ¯è¶è¿ä¸è¬æ°éçsetinelé½è®¤ä¸ºè¿ä¸ªèç¹ä¸»è§ä¸çº¿ï¼é£ä¹å®å°±ä¼è¢«æ è®°ä¸ºå®¢è§ä¸çº¿ã\n\n * ä¸»è§ä¸çº¿ ï¼å¦ææsetinelåç°æèç¹æªå¨è§å®æ¶é´åååºï¼åè®¤ä¸ºè¯¥èç¹ä¸»è§ä¸çº¿ã\n * å®¢è§ä¸çº¿ ï¼è¥è¶è¿æå®æ°éçsentinelé½è®¤ä¸ºè¯¥èç¹ä¸»è§ä¸çº¿ï¼åè¯¥èç¹å®¢è§ä¸çº¿ï¼ä¼è§¦åéç¥æå¡å°è¯¥èç¹çæåµéç¥ç»å®¢æ·ç«¯ãï¼æå®æ°éæå¥½è®¾ç½®ä¸ºå¨åµæ°éçä¸åå¤ï¼\n\n\n# 3. èªå¨æéè¿ç§»\n\nä¹å°±æ¯éæ°éä¸¾ä¸»èç¹ã\n\nä¸æ¦åç° master æéï¼sentinel éè¦å¨slaveä¸­éæ©ä¸ä¸ªä½ä¸ºæ°çmasterãéä¸¾çä¾æ®ï¼\n\n 1. éæ©ä¼åçº§æé«çèç¹ï¼éè¿sentineléç½®æä»¶ä¸­çreplica-priorityéç½®é¡¹ï¼è¿ä¸ªåæ°è¶å°ï¼è¡¨ç¤ºä¼åçº§è¶é«\n 2. å¦æç¬¬ä¸æ­¥ä¸­çä¼åçº§ç¸åï¼éæ©offsetæå¤§çï¼offsetè¡¨ç¤ºä¸»èç¹åä»èç¹åæ­¥æ°æ®çåç§»éï¼è¶å¤§è¡¨ç¤ºåæ­¥çæ°æ®è¶å¤\n 3. å¦æç¬¬äºæ­¥offsetä¹ç¸åï¼éæ©run idè¾å°ç\n\nå½éä¸­äºå¶ä¸­ä¸ä¸ªslaveä¸ºæ°çmaster (åå¦ä¸ºslave1)åï¼æéçè½¬ç§»è¿ç¨å¦ä¸ï¼\n\n * sentineléç¾¤ç»slave1åéslaveof no oneå½ä»¤ï¼è®©è¯¥èç¹ç§°ä¸ºmasterã\n * sentineléç¾¤ç»å¶ä»èç¹åéå¹¿æ­æ¶æ¯ï¼è®©å¶ä»slaveèç¹ç§°ä¸ºæ°masterçä»èç¹ï¼å¼å§ä»æ°çmasterä¸­åæ­¥æ°æ®ã\n * sentinelå°æéèç¹æ è®°ä¸ºslaveï¼å½æéèç¹æ¢å¤åä¼èªå¨æä¸ºæ°çmasterçslaveèç¹ã\n\n\n# 4. sentineléä¸¾é¢å¯¼è\n\nå¶å®ä¸é¢çæè¿°å¹¶ä¸åç¡®ï¼æéè½¬ç§»æ¯æä¸ä¸ªsentinelèç¹åçï¼èä¸æ¯æ´ä¸ªsentineléç¾¤åçï¼é£ä¹è°æ¥åè¿ä»¶äºå¢ï¼ä¸ä¸ªsentineléç¾¤æ¯æä¸ä¸ªå¤´sentinelçï¼ç±å®æ¥å®æä¸»èç¹çéä¸¾ã\n\nå½ä¸»èç¹è¢«å®¢è§ä¸çº¿åï¼åä¸ªå¨åµèç¹ä¼éä¸¾åºä¸ä¸ªé¢å¯¼èå¨åµèç¹ï¼å¹¶ç±è¯¥é¢å¯¼èèç¹å¯¹å¶è¿è¡æéè½¬ç§»æä½ã\n\nçè§è¯¥ä¸»èç¹çææå¨åµé½æå¯è½ç§°ä¸ºé¢å¯¼èï¼éä¸¾ä½¿ç¨raftç®æ³ï¼å¨æ²¡ææ°æ®å¯ä»¥è¿è¡æ¯è¾çæåµä¸ï¼raftçéä¸¾æ´åæ¯åå°åå¾ï¼å¨ä¸è½®éä¸¾ä¸­ï¼å¨åµaåbåéæä¸ºé¢å¯¼èçç³è¯·ï¼å¦æbæ²¡æåæè¿å¶ä»å¨åµï¼åä¼åæaæä¸ºé¢å¯¼èãéä¸¾çå·ä½è¿ç¨å¯ä»¥æ¥éraftç®æ³ã\n\nâ",charsets:{cjk:!0},lastUpdated:"2023/07/03, 21:12:04",lastUpdatedTimestamp:1688389924e3},{title:"å¸¸ç¨å·¥å·ç±»",frontmatter:{title:"å¸¸ç¨å·¥å·ç±»",date:"2023-06-13T15:06:07.000Z",permalink:"/pages/70ea3d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/100.%E5%85%B6%E4%BB%96/100.%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB.html",relativePath:"02.æç« /100.å¶ä»/100.å¸¸ç¨å·¥å·ç±».md",key:"v-87b51ada",path:"/pages/70ea3d/",headers:[{level:2,title:"å¯ç å å¯å·¥å·ç±»",slug:"å¯ç å å¯å·¥å·ç±»",normalizedTitle:"å¯ç å å¯å·¥å·ç±»",charIndex:2},{level:2,title:"éªè¯å·¥å·ç±»",slug:"éªè¯å·¥å·ç±»",normalizedTitle:"éªè¯å·¥å·ç±»",charIndex:1772},{level:2,title:"Tokençæ",slug:"tokençæ",normalizedTitle:"tokençæ",charIndex:3883},{level:2,title:"è·¨åè¯·æ±éç½®",slug:"è·¨åè¯·æ±éç½®",normalizedTitle:"è·¨åè¯·æ±éç½®",charIndex:5956}],headersStr:"å¯ç å å¯å·¥å·ç±» éªè¯å·¥å·ç±» Tokençæ è·¨åè¯·æ±éç½®",content:'# å¯ç å å¯å·¥å·ç±»\n\nç±»åä¸ºPasswordEncoder,æ²¡å­¦SpringSecurityæ¶èªå·±åçå¯¹å¯ç è¿è¡ç®åçå å¯å·¥å·ã\nå å¯çè§åå¦ä¸:\n\n 1. ç¨æ·æ³¨åæ¶å¯ç ä¸º 123ï¼èªå¨çæççä¸º bgddsa\n 2. åå°123bgddsaä½¿ç¨MD5ç¼ç ä¸ä¸ï¼ä¸º536D2A9E796B12B877702C02F6763231\n 3. æçæ¾å¨ç¼ç åçå¯ç çåé¢ï¼ä½¿ç¨@ç¬¦å·éå¼, å­å¥æ°æ®åºçå¯ç å¦ä¸:\n    bgddsa@536D2A9E796B12B877702C02F6763231\n 4. ç¨æ·ç»å½æ¶è¾å¥ç¨æ·åã456ï¼æ ¹æ®ç¨æ·åä»æ°æ®åºä¸­æ¥è¯¢åºçå¯ç ä¸º:bgddsa@536D2A9E796B12B877702C02F6763231\n 5. å°å¤´é¨@åé¢çsaltååºï¼ä¸ºbgddsaï¼å°456bgddsaä½¿ç¨MD5ç¼ç ä¸ä¸ï¼åå ä¸salt@, å¤æ­ååä¸¤æ¬¡å å¯çç»ææ¯å¦ç¸åå³å¯ã éè¦ä½¿ç¨å°hutoolå·¥å·ç±»çæéæºæ°ï¼å½ç¶å¦æèªå·±åä¹å¯ä»¥ã å¦æä½¿ç¨hutoolå·¥å·ç±»ï¼éè¦å å¥ä¾èµ:\n\n\x3c!--hutool--\x3e\n<dependency>\n    <groupId>cn.hutool</groupId>\n    <artifactId>hutool-all</artifactId>\n    <version>5.7.17</version>\n</dependency>\n\n\nimport cn.hutool.core.util.RandomUtil;\nimport org.springframework.util.DigestUtils;\n\nimport java.nio.charset.StandardCharsets;\n\n/**\n * @description: å¯ç å å¯ãéªè¯çå·¥å·ç±»\n * @author : å°ä½\n */\npublic class PasswordEncoder {\n\n    public static String encode(String password) {\n        // çæç\n        String salt = RandomUtil.randomString(20);\n        // å å¯\n        return encode(password,salt);\n    }\n    private static String encode(String password, String salt) {\n        // å å¯\n        return salt + "@" + DigestUtils.md5DigestAsHex((password + salt).getBytes(StandardCharsets.UTF_8));\n    }\n\n    /**\n     *\n     * @param encodedPassword: ä»æ°æ®åºä¸­æ¥è¯¢çå¯ç \n     * @param rawPassword: ç¨æ·è¾å¥çå¯ç \n     * @return\n     */\n    public static Boolean matches(String encodedPassword, String rawPassword) {\n        if (encodedPassword == null || rawPassword == null) {\n            return false;\n        }\n        if(!encodedPassword.contains("@")){\n            throw new RuntimeException("å¯ç æ ¼å¼ä¸æ­£ç¡®ï¼");\n        }\n        String[] arr = encodedPassword.split("@");\n        // è·åç\n        String salt = arr[0];\n        // æ¯è¾\n        return encodedPassword.equals(encode(rawPassword, salt));\n    }\n}\n\n\n\n# éªè¯å·¥å·ç±»\n\næä¾äºå¯¹æäºåç«¯æäº¤æ°æ®çéªè¯ï¼ä¾å¦ææºå·ãé®ç®±ãèº«ä»½è¯å·..\n\nimport cn.hutool.core.util.StrUtil;\n\n/**\n * @description : éªè¯ææºå·ãèº«ä»½è¯å·ãå¯ç ãéªè¯ç ãé®ç®±çå·¥å·ç±»\n * @author : å°ä½\n */\npublic class VerifyUtils {\n    /**\n     * ææºå·æ­£å\n     */\n    public static final String PHONE_REGEX = "^1([38][0-9]|4[579]|5[0-3,5-9]|6[6]|7[0135678]|9[89])\\\\d{8}$";\n\n    /**\n     * é®ç®±æ­£å\n     */\n    public static final String EMAIL_REGEX = "^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\\\\.[a-zA-Z0-9_-]+)+$";\n\n    /**\n     * å¯ç æ­£åã4~32ä½çå­æ¯ãæ°å­ãä¸åçº¿\n     */\n    public static final String PASSWORD_REGEX = "^\\\\w{4,32}$";\n\n    /**\n     * éªè¯ç æ­£å, 6ä½æ°å­æå­æ¯\n     */\n    public static final String VERIFY_CODE_REGEX = "^[a-zA-Z\\\\d]{6}$";\n\n    /**\n     * èº«ä»½è¯å·æ­£å\n     */\n    public static final String ID_CARD_NUMBER_REGEX_18 = "^[1-9]\\\\d{5}(18|19|([23]\\\\d))\\\\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\\\\d{3}[0-9Xx]$";\n    public static final String ID_CARD_NUMBER_REGEX_15 = "^[1-9]\\\\d{5}\\\\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\\\\d{2}$";\n\n    /**\n     * ææºå·æ¯å¦åæ³\n     * @param phone è¦æ ¡éªçææºå·\n     * @return true:ç¬¦åï¼falseï¼ä¸ç¬¦å\n     */\n    public static boolean isPhoneLegal(String phone){\n        return match(phone, PHONE_REGEX);\n    }\n    /**\n     * æ¯å¦æ¯æ æé®ç®±æ ¼å¼\n     * @param email è¦æ ¡éªçé®ç®±\n     * @return true:ç¬¦åï¼falseï¼ä¸ç¬¦å\n     */\n    public static boolean isEmailLegal(String email){\n        return match(email, EMAIL_REGEX);\n    }\n\n    /**\n     * æ¯å¦æ¯æ æéªè¯ç æ ¼å¼\n     * @param code è¦æ ¡éªçéªè¯ç \n     * @return true:ç¬¦åï¼falseï¼ä¸ç¬¦å\n     */\n    public static boolean isCodeLegal(String code){\n        return match(code, VERIFY_CODE_REGEX);\n    }\n\n    // æ ¡éªæ¯å¦ä¸ç¬¦åæ­£åæ ¼å¼\n    private static boolean match(String str, String regex){\n        if (StrUtil.isBlank(str)) {\n            return false;\n        }\n        return str.matches(regex);\n    }\n\n    /**\n     * éªè¯èº«ä»½è¯å·æ¯å¦åæ³\n     * @param idCard èº«ä»½è¯å·\n     * @return true: åæ³ï¼    false:ä¸åæ³\n     */\n    public static boolean isIdCardLegal(String idCard) {\n        if (idCard.length() == 18) {\n            return match(idCard, ID_CARD_NUMBER_REGEX_18);\n        } else {\n            return match(idCard, ID_CARD_NUMBER_REGEX_15);\n        }\n    }\n}\n\n\n\n# Tokençæ\n\nä½¿ç¨JWTçæå·¥å·ç±»ãæä¾äºä¸¤ç§æ¹å¼: æ ¹æ®Mapçæãæ ¹æ®å¯¹è±¡çæã éè¦ä½¿ç¨å°hutoolä¾èµãjwtä¾èµã éè¦èªå®ä¹ç­¾åï¼ä¸é¢ä¸ºéä¾¿åçç­¾åã\n\n\x3c!--hutool--\x3e\n<dependency>\n    <groupId>com.auth0</groupId>\n    <artifactId>java-jwt</artifactId>\n    <version>4.0.0</version>\n</dependency>\n\n\n<dependency>\n    <groupId>cn.hutool</groupId>\n    <artifactId>hutool-all</artifactId>\n    <version>5.7.17</version>\n</dependency>\n\n\nä»£ç :\n\n\nimport com.auth0.jwt.JWT;\nimport com.auth0.jwt.algorithms.Algorithm;\nimport com.auth0.jwt.interfaces.Claim;\nimport com.auth0.jwt.interfaces.DecodedJWT;\nimport org.apache.commons.beanutils.PropertyUtilsBean;\n\nimport java.beans.PropertyDescriptor;\nimport java.util.Calendar;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class JWTUtils {\n    // ç­¾å(å¯ä»¥éææ´æ¢)\n    private static final String SIGN = "234as5@4123";\n\n    // ç®æ³\n    private static final Map<String, Object> map = new HashMap<>();\n\n    // æ ¹æ®mapçætoken\n    public static String generateToken(Map<String,Object> payload) {\n        Calendar instance = Calendar.getInstance();\n        instance.add(Calendar.HOUR, 30);\n\n        String token = JWT.create().withHeader(map) // å¤´\n                .withPayload(payload) // è´è½½\n                .withExpiresAt(instance.getTime()) // è®¾ç½®è¿ææ¶é´ã\n                .sign(Algorithm.HMAC256(SIGN));// ç­¾åï¼ä½¿ç¨ç®æ³çæã\n\n        return token;\n    }\n    // æ ¹æ®å¯¹è±¡çætoken\n    public static <T> String generateToken(T bean) {\n        Map<String, Object> stringObjectMap = BeanUtil.beanToMap(bean);\n        return generateToken(stringObjectMap);\n    }\n\n\n    /**\n     * éªè¯token,å¦ætokenæéï¼ç´æ¥æåºå¼å¸¸äºã\n     * @param token token\n     */\n    public static void  verify(String token) {\n        JWT.require(Algorithm.HMAC256(SIGN)).build().verify(token);\n    }\n\n    /**\n     * è·åtokenä¿¡æ¯\n     * @param token token\n     * @return ä¿¡æ¯\n     */\n    public static Map<String, Claim> getClaims(String token) {\n        Map<String, ?> map = new HashMap<>();\n        DecodedJWT decodedJWT = JWT.require(Algorithm.HMAC256(SIGN)).build().verify(token);\n        Map<String, Claim> claims = decodedJWT.getClaims();\n        return claims;\n    }\n} \n\n\n\n# è·¨åè¯·æ±éç½®\n\n @Configuration\npublic class GlobalCorsConfig {\n\n  @Bean\n public CorsFilter getCorsFilter(){\n\n   CorsConfiguration configuration= new CorsConfiguration();\n\n   //æ·»å åªäºhttpæ¹æ³å¯ä»¥è·¨åï¼æ¯å¦ï¼GET,Postï¼ï¼å¤ä¸ªæ¹æ³ä¸­é´ä»¥éå·åéï¼ï¼*å·è¡¨ç¤ºææ\n   configuration.addAllowedMethod("*");\n   //æ·»å åè®¸åªä¸ªè¯·æ±è¿è¡è·¨åï¼*è¡¨ç¤ºææ,å¯ä»¥å·ä½æå®http://localhost:8601è¡¨ç¤ºåªåè®¸http://localhost:8601/è·¨å\n   configuration.addAllowedOrigin("*");\n   //ææå¤´ä¿¡æ¯å¨é¨æ¾è¡\n   configuration.addAllowedHeader("*");\n   //åè®¸è·¨ååécookie\n   configuration.setAllowCredentials(true);\n\n   UrlBasedCorsConfigurationSource urlBasedCorsConfigurationSource = new UrlBasedCorsConfigurationSource();\n   urlBasedCorsConfigurationSource.registerCorsConfiguration("/**",configuration);\n   return new CorsFilter(urlBasedCorsConfigurationSource);\n  }\n} \n',normalizedContent:'# å¯ç å å¯å·¥å·ç±»\n\nç±»åä¸ºpasswordencoder,æ²¡å­¦springsecurityæ¶èªå·±åçå¯¹å¯ç è¿è¡ç®åçå å¯å·¥å·ã\nå å¯çè§åå¦ä¸:\n\n 1. ç¨æ·æ³¨åæ¶å¯ç ä¸º 123ï¼èªå¨çæççä¸º bgddsa\n 2. åå°123bgddsaä½¿ç¨md5ç¼ç ä¸ä¸ï¼ä¸º536d2a9e796b12b877702c02f6763231\n 3. æçæ¾å¨ç¼ç åçå¯ç çåé¢ï¼ä½¿ç¨@ç¬¦å·éå¼, å­å¥æ°æ®åºçå¯ç å¦ä¸:\n    bgddsa@536d2a9e796b12b877702c02f6763231\n 4. ç¨æ·ç»å½æ¶è¾å¥ç¨æ·åã456ï¼æ ¹æ®ç¨æ·åä»æ°æ®åºä¸­æ¥è¯¢åºçå¯ç ä¸º:bgddsa@536d2a9e796b12b877702c02f6763231\n 5. å°å¤´é¨@åé¢çsaltååºï¼ä¸ºbgddsaï¼å°456bgddsaä½¿ç¨md5ç¼ç ä¸ä¸ï¼åå ä¸salt@, å¤æ­ååä¸¤æ¬¡å å¯çç»ææ¯å¦ç¸åå³å¯ã éè¦ä½¿ç¨å°hutoolå·¥å·ç±»çæéæºæ°ï¼å½ç¶å¦æèªå·±åä¹å¯ä»¥ã å¦æä½¿ç¨hutoolå·¥å·ç±»ï¼éè¦å å¥ä¾èµ:\n\n\x3c!--hutool--\x3e\n<dependency>\n    <groupid>cn.hutool</groupid>\n    <artifactid>hutool-all</artifactid>\n    <version>5.7.17</version>\n</dependency>\n\n\nimport cn.hutool.core.util.randomutil;\nimport org.springframework.util.digestutils;\n\nimport java.nio.charset.standardcharsets;\n\n/**\n * @description: å¯ç å å¯ãéªè¯çå·¥å·ç±»\n * @author : å°ä½\n */\npublic class passwordencoder {\n\n    public static string encode(string password) {\n        // çæç\n        string salt = randomutil.randomstring(20);\n        // å å¯\n        return encode(password,salt);\n    }\n    private static string encode(string password, string salt) {\n        // å å¯\n        return salt + "@" + digestutils.md5digestashex((password + salt).getbytes(standardcharsets.utf_8));\n    }\n\n    /**\n     *\n     * @param encodedpassword: ä»æ°æ®åºä¸­æ¥è¯¢çå¯ç \n     * @param rawpassword: ç¨æ·è¾å¥çå¯ç \n     * @return\n     */\n    public static boolean matches(string encodedpassword, string rawpassword) {\n        if (encodedpassword == null || rawpassword == null) {\n            return false;\n        }\n        if(!encodedpassword.contains("@")){\n            throw new runtimeexception("å¯ç æ ¼å¼ä¸æ­£ç¡®ï¼");\n        }\n        string[] arr = encodedpassword.split("@");\n        // è·åç\n        string salt = arr[0];\n        // æ¯è¾\n        return encodedpassword.equals(encode(rawpassword, salt));\n    }\n}\n\n\n\n# éªè¯å·¥å·ç±»\n\næä¾äºå¯¹æäºåç«¯æäº¤æ°æ®çéªè¯ï¼ä¾å¦ææºå·ãé®ç®±ãèº«ä»½è¯å·..\n\nimport cn.hutool.core.util.strutil;\n\n/**\n * @description : éªè¯ææºå·ãèº«ä»½è¯å·ãå¯ç ãéªè¯ç ãé®ç®±çå·¥å·ç±»\n * @author : å°ä½\n */\npublic class verifyutils {\n    /**\n     * ææºå·æ­£å\n     */\n    public static final string phone_regex = "^1([38][0-9]|4[579]|5[0-3,5-9]|6[6]|7[0135678]|9[89])\\\\d{8}$";\n\n    /**\n     * é®ç®±æ­£å\n     */\n    public static final string email_regex = "^[a-za-z0-9_-]+@[a-za-z0-9_-]+(\\\\.[a-za-z0-9_-]+)+$";\n\n    /**\n     * å¯ç æ­£åã4~32ä½çå­æ¯ãæ°å­ãä¸åçº¿\n     */\n    public static final string password_regex = "^\\\\w{4,32}$";\n\n    /**\n     * éªè¯ç æ­£å, 6ä½æ°å­æå­æ¯\n     */\n    public static final string verify_code_regex = "^[a-za-z\\\\d]{6}$";\n\n    /**\n     * èº«ä»½è¯å·æ­£å\n     */\n    public static final string id_card_number_regex_18 = "^[1-9]\\\\d{5}(18|19|([23]\\\\d))\\\\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\\\\d{3}[0-9xx]$";\n    public static final string id_card_number_regex_15 = "^[1-9]\\\\d{5}\\\\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\\\\d{2}$";\n\n    /**\n     * ææºå·æ¯å¦åæ³\n     * @param phone è¦æ ¡éªçææºå·\n     * @return true:ç¬¦åï¼falseï¼ä¸ç¬¦å\n     */\n    public static boolean isphonelegal(string phone){\n        return match(phone, phone_regex);\n    }\n    /**\n     * æ¯å¦æ¯æ æé®ç®±æ ¼å¼\n     * @param email è¦æ ¡éªçé®ç®±\n     * @return true:ç¬¦åï¼falseï¼ä¸ç¬¦å\n     */\n    public static boolean isemaillegal(string email){\n        return match(email, email_regex);\n    }\n\n    /**\n     * æ¯å¦æ¯æ æéªè¯ç æ ¼å¼\n     * @param code è¦æ ¡éªçéªè¯ç \n     * @return true:ç¬¦åï¼falseï¼ä¸ç¬¦å\n     */\n    public static boolean iscodelegal(string code){\n        return match(code, verify_code_regex);\n    }\n\n    // æ ¡éªæ¯å¦ä¸ç¬¦åæ­£åæ ¼å¼\n    private static boolean match(string str, string regex){\n        if (strutil.isblank(str)) {\n            return false;\n        }\n        return str.matches(regex);\n    }\n\n    /**\n     * éªè¯èº«ä»½è¯å·æ¯å¦åæ³\n     * @param idcard èº«ä»½è¯å·\n     * @return true: åæ³ï¼    false:ä¸åæ³\n     */\n    public static boolean isidcardlegal(string idcard) {\n        if (idcard.length() == 18) {\n            return match(idcard, id_card_number_regex_18);\n        } else {\n            return match(idcard, id_card_number_regex_15);\n        }\n    }\n}\n\n\n\n# tokençæ\n\nä½¿ç¨jwtçæå·¥å·ç±»ãæä¾äºä¸¤ç§æ¹å¼: æ ¹æ®mapçæãæ ¹æ®å¯¹è±¡çæã éè¦ä½¿ç¨å°hutoolä¾èµãjwtä¾èµã éè¦èªå®ä¹ç­¾åï¼ä¸é¢ä¸ºéä¾¿åçç­¾åã\n\n\x3c!--hutool--\x3e\n<dependency>\n    <groupid>com.auth0</groupid>\n    <artifactid>java-jwt</artifactid>\n    <version>4.0.0</version>\n</dependency>\n\n\n<dependency>\n    <groupid>cn.hutool</groupid>\n    <artifactid>hutool-all</artifactid>\n    <version>5.7.17</version>\n</dependency>\n\n\nä»£ç :\n\n\nimport com.auth0.jwt.jwt;\nimport com.auth0.jwt.algorithms.algorithm;\nimport com.auth0.jwt.interfaces.claim;\nimport com.auth0.jwt.interfaces.decodedjwt;\nimport org.apache.commons.beanutils.propertyutilsbean;\n\nimport java.beans.propertydescriptor;\nimport java.util.calendar;\nimport java.util.hashmap;\nimport java.util.map;\n\npublic class jwtutils {\n    // ç­¾å(å¯ä»¥éææ´æ¢)\n    private static final string sign = "234as5@4123";\n\n    // ç®æ³\n    private static final map<string, object> map = new hashmap<>();\n\n    // æ ¹æ®mapçætoken\n    public static string generatetoken(map<string,object> payload) {\n        calendar instance = calendar.getinstance();\n        instance.add(calendar.hour, 30);\n\n        string token = jwt.create().withheader(map) // å¤´\n                .withpayload(payload) // è´è½½\n                .withexpiresat(instance.gettime()) // è®¾ç½®è¿ææ¶é´ã\n                .sign(algorithm.hmac256(sign));// ç­¾åï¼ä½¿ç¨ç®æ³çæã\n\n        return token;\n    }\n    // æ ¹æ®å¯¹è±¡çætoken\n    public static <t> string generatetoken(t bean) {\n        map<string, object> stringobjectmap = beanutil.beantomap(bean);\n        return generatetoken(stringobjectmap);\n    }\n\n\n    /**\n     * éªè¯token,å¦ætokenæéï¼ç´æ¥æåºå¼å¸¸äºã\n     * @param token token\n     */\n    public static void  verify(string token) {\n        jwt.require(algorithm.hmac256(sign)).build().verify(token);\n    }\n\n    /**\n     * è·åtokenä¿¡æ¯\n     * @param token token\n     * @return ä¿¡æ¯\n     */\n    public static map<string, claim> getclaims(string token) {\n        map<string, ?> map = new hashmap<>();\n        decodedjwt decodedjwt = jwt.require(algorithm.hmac256(sign)).build().verify(token);\n        map<string, claim> claims = decodedjwt.getclaims();\n        return claims;\n    }\n} \n\n\n\n# è·¨åè¯·æ±éç½®\n\n @configuration\npublic class globalcorsconfig {\n\n  @bean\n public corsfilter getcorsfilter(){\n\n   corsconfiguration configuration= new corsconfiguration();\n\n   //æ·»å åªäºhttpæ¹æ³å¯ä»¥è·¨åï¼æ¯å¦ï¼get,postï¼ï¼å¤ä¸ªæ¹æ³ä¸­é´ä»¥éå·åéï¼ï¼*å·è¡¨ç¤ºææ\n   configuration.addallowedmethod("*");\n   //æ·»å åè®¸åªä¸ªè¯·æ±è¿è¡è·¨åï¼*è¡¨ç¤ºææ,å¯ä»¥å·ä½æå®http://localhost:8601è¡¨ç¤ºåªåè®¸http://localhost:8601/è·¨å\n   configuration.addallowedorigin("*");\n   //ææå¤´ä¿¡æ¯å¨é¨æ¾è¡\n   configuration.addallowedheader("*");\n   //åè®¸è·¨ååécookie\n   configuration.setallowcredentials(true);\n\n   urlbasedcorsconfigurationsource urlbasedcorsconfigurationsource = new urlbasedcorsconfigurationsource();\n   urlbasedcorsconfigurationsource.registercorsconfiguration("/**",configuration);\n   return new corsfilter(urlbasedcorsconfigurationsource);\n  }\n} \n',charsets:{cjk:!0},lastUpdated:"2023/06/14, 09:41:46",lastUpdatedTimestamp:1686706906e3},{title:"Javaå­¦ä¹ è·¯çº¿",frontmatter:{title:"Javaå­¦ä¹ è·¯çº¿",date:"2023-06-14T09:28:34.000Z",permalink:"/pages/7ca562/"},regularPath:"/02.%E6%96%87%E7%AB%A0/100.%E5%85%B6%E4%BB%96/1000.Java%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF.html",relativePath:"02.æç« /100.å¶ä»/1000.Javaå­¦ä¹ è·¯çº¿.md",key:"v-0d72e0be",path:"/pages/7ca562/",headers:[{level:2,title:"1. è·¯çº¿",slug:"_1-è·¯çº¿",normalizedTitle:"1. è·¯çº¿",charIndex:2},{level:2,title:"2. æ¨èå·¥å·",slug:"_2-æ¨èå·¥å·",normalizedTitle:"2. æ¨èå·¥å·",charIndex:1156},{level:2,title:"3. é¨åææ¯æ çæ¨èè§é¢",slug:"_3-é¨åææ¯æ çæ¨èè§é¢",normalizedTitle:"3. é¨åææ¯æ çæ¨èè§é¢",charIndex:1813},{level:2,title:"4. ä¸äºå»ºè®®",slug:"_4-ä¸äºå»ºè®®",normalizedTitle:"4. ä¸äºå»ºè®®",charIndex:2862}],headersStr:"1. è·¯çº¿ 2. æ¨èå·¥å· 3. é¨åææ¯æ çæ¨èè§é¢ 4. ä¸äºå»ºè®®",content:"# 1. è·¯çº¿\n\n 1.  Javaåºç¡ -> éå -> IO -> streamæµ -> å¤çº¿ç¨ -> ç½ç»ç¼ç¨\n\n 2.  MySQL\n\n 3.  JDBC\n\n 4.  åç«¯ä¸åå®¢ï¼å»ºè®®å­¦ä¹ æ¶é´1å¨ä»¥åï¼å­¦htmlãjavascriptï¼ä¼æ¾ç¤ºæ°æ®å°±è¡ãéç¹å­¦ajaxï¼\n\n 5.  Servlet ï¼å«å¨jspä¸è±å¤ªå¤æ¶é´ï¼\n\n 6.  è·Bç«åä¸ªServleté¡¹ç®ï¼åç«¯åä¸åºæ¥æ­£å¸¸ï¼ç´æ¥é¢èµæ\n\n 7.  Maven ï¼åé¢å¾å¤bugé½ä¼è·Mavenæå³~ä½æ¯åªè¦ççå­¦ä¼äºå°±ä¸ä¼åºbugï¼\n\n 8.  SpringãMybatisãSpringMVC\n     \n     SpringåMybatisçé¡ºåºçä½ èªå·±å§ãåæ­£æåå­¦MVCã\n     \n     SSMé¶æ®µåºå¾å¤bugå¾æ­£å¸¸ï¼åºçbugè¶å¤è¶å¥½ï¼å°è¯å¤debugãä¸ç¨åSSMé¡¹ç®ï¼Bç«æ²¡å¥å¥½çSSMé¡¹ç®ï¼èªå·±ç¨SSMåå ä¸ªå¢å æ¹æ¥å°±è¡äºã\n     \n     æºç æå­¦ï¼ä¼æå»èªå·±ã\n\n 9.  SpringBoot\n\n 10. å¯ä»¥åSpringBooté¡¹ç®ï¼ä¹å¯ä»¥å­¦äºMybatis-plusä¹ååé¡¹ç®ï¼Bç«æå¾å¤SpringBooté¡¹ç®ã\n\n 11. å¯ä»¥å­¦ä¸ä¸Vueï¼ä½æ¯ä¸å»ºè®®è±å¤ªå¤æ¶é´\n\n 12. Linuxï¼ä¸éè¦å­¦å¾å¤ï¼ä¼å®è£å¸è½½ï¼ä¼å³é²ç«å¢å°±è¡äºãå½ä»¤éç¨éæ¥ï¼\n\n 13. Redis\n\n 14. ç»ä¸é¢ä½ åçé¡¹ç®å ä¸Redisï¼ä¹å¯ä»¥æ¾ä¸ªSpringBoot+Redisçé¡¹ç®ååï¼è¿è¾¹æ¨èé»é©¬ç¹è¯\n\n 15. MQï¼ä¸ä¸ªMQéä¸ä¸ªå­¦ï¼RabbitMQãRocketMQãKafkaãææ¨è RocketMQ\n\n 16. åé¡¹ç®ï¼é»é©¬ç¹è¯ æè çå®¢è®ºåï¼ççä¸è¦å°çç§æå¨é¢è¯éçå«éé\n\n 17. Docker ï¼å¿«éå®è£ä¸­é´ä»¶ï¼å¯ä»¥åä¸é¢æ¢é¡ºåºï¼Dockerççå¾æ¹ä¾¿å®¶äººä»¬ï¼å­¦ä¼äºDockerï¼ä¸é¢çSpringCloudçå¥½å¤§çåæ°ã\n\n 18. SpringCloudãSpringCloud Alibaba...\n\n 19. æ¥ä¸æ¥å°±æ¯JUCãJVMè¿äºé¢è¯å¸¸ç¨çï¼åæ¶ï¼è®¡ç®æºåºç¡ä¹è¦æå¥½~ä¾å¦è®¡ç½ãæä½ç³»ç»ï¼é¢è¯çæ¶åç»å¸¸ä¼è¢«é®å°ã\n\nSSMãSpringBootè¦å¤è±æ¶é´ãåæ¶ç®æ³é¢åSQLä¹è¦å¤å·ã\n\nåæ¶ä¹å¯ä»¥å­¦ä¸äºå¶ä»çå·¥å·æèææ¯ï¼ä¾å¦Gitï¼æä»£ç æ¾å°GiteeæèGithubä¸ï¼ç»¿æ²¹æ²¹ä¸çå¥½ççå~\n\næå\n\næåï¼ä¸é¢çææ¯æ å­¦å®äºä¹åå¯ä»¥å»çä¹¦ï¼å ä¸ºä½ ææ¯æ çä¼¼âå­¦å®äºâï¼ä½æ¯ææ¡çæä¹æ ·å¢ï¼\nåæ¶ï¼å¯ä»¥å¹å»èªå·±æ ¹æ®ææ¡£/åå®¢å»åé¡¹ç®çè½åï¼ç»ä½ ä¸ä¸ªæ¨¡åçå¤§è´æè¿°åå®æ´ä»£ç ï¼ä½ å¯ä»¥å°æ¨¡åå®æ´çååºæ¥åï¼\nå¬å¸æ»ä¸è½ä¸ºäºå ä¸ªå®ä¹ çå»å½å¶é¡¹ç®çå­¦ä¹ è§é¢å§~\n\n\n# 2. æ¨èå·¥å·\n\n * IDEA ï¼ä¸ç¨å¤è¯´å§~\n\n * Postman ï¼ç¨æ¥åè¯·æ±ç\n\n * DataGrip ï¼è¿æ¥æ°æ®åºçè¿ç¨å·¥å·ï¼è·IDEAæ¯åä¸ä¸ªå¬å¸çï¼ä»£ç æç¤ºå¾åå¥½\n\n * Navicat ï¼è¿æ¥æ°æ®åºçè¿ç¨å·¥å·ï¼æºå¥½ç¨\n\n * Typora ï¼è®°ç¬è®°çå·¥å·ï¼æ ¼å¼æ¯Markdownæ ¼å¼ï¼åå¤§åå®¢ç½ç«é½æ¯æã\n   \n   ä¸è¿å¾çä¿å­å¨æ¬å°ï¼ç´æ¥å¤å¶ç²è´´å°CSDNåå¾çä¼âæ¶å¤±âï¼å¯ä»¥å°è¯æ­å»ºå¾åºï¼\n   \n   ï¼å³é®è¯æ ï¼Typora + picgo + é¿éäº æ Typora + gitee/githubï¼\n   \n   æ¨èTypora + picgo + é¿éäºï¼ä¸å¹´10åé±éåº¦ååå¿«\n\n * ææºç¬è®° ï¼å¦æä¸æ³ååå®¢ï¼åªæ¯æ³è®°å½ä¸ä¸èªå·±å¹³æ¶çç¬è®°ï¼å¼ºçæ¨èææºç¬è®°ãï¼ä»è´¹å¯ä»¥æ­å¾åºï¼\n\n * é­æ³ ï¼ddddï¼å¦ææ²¡æåéï¼åªæ¯æ¥å¸¸ç¨ä¸ä¸Githubï¼å¯ä»¥ä¸è½½Steam++ãå¦ææ³ççå¤é¢çä¸çï¼å¯ä»¥éè½åï¼é¾æ¥å°±ä¸æ¾äºï¼ä½ å»åç§ç¼ç¨äº¤æµç¾¤ä¸é®å°±æã\n\n * FinalShell ï¼èªå·±ççµèè¿æ¥Linuxçå·¥å·ï¼ä¹å¯ä»¥è¿æ¥äºæå¡å¨ï¼åè½æ¯XShell + Xftpï¼\n\n * XShell ï¼è¿æ¥Linuxçå·¥å·\n\n * Xftp ï¼è¿æ¥Linuxåå¿«éä¸ä¼ æä»¶çå·¥å·\n\n * ChatGPT ï¼è¿ä¸ªä¸ç¨æå¤è¯´äºå§ï¼ä½æ¯å¦æä½ ä¸æ³è±é±ä¹°å¤å½çææºå·å¹¶ä¸ä½¿ç¨åºæ¯ä¸å¤çè¯ï¼å¯ä»¥ç¨ç¨çççï¼å¶å®å¤§å¤æ°äººå¯¹ AI çç¨å¤ä¹å°±æ°´ä¸ªå¹³æ¶ä½ä¸ï¼ç¨ç¨å½åçé£äºè¶³å¤äºã\n\n\n# 3. é¨åææ¯æ çæ¨èè§é¢\n\nä¸å¾ä¸è¯´ï¼é»é©¬å¨Javaè§é¢è¿åå¾çé¼ã\n\n 1. æ°æ®ç»æä¸ç®æ³\n    \n    ãç®æ³å¤§ç¥ï¼çè3ä¸ªææé ãLeetcodeç®æ³500é¢ãç®æ³ä¸æ°æ®ç»æä»åºç¡å°é«çº§å¨å®¶æ¡¶æç¨ï¼BTAJç­ä¸çº¿å¤§åé¢è¯å¿é®è¯¦è§£ï¼ã\n    \n    å·¦ç¨äºçç®æ³è¯¾ï¼è¿ä¸ªè§é¢æ¯éå²çï¼ä½æ¯ä»çåéå¾å¥½ã\n    \n    çå®ä¹åå¯ä»¥çBç«å®æ´ç80hï¼æå·¦ç¨äºå°±æäºã\n    \n    åçå®å¯ä»¥ä½¿ç¨éè½åæ¾çç~\n    \n    å³äºç®æ³é¢ä¹å¯ä»¥ççè¿ä½å¥ï¼ä»çè§é¢æ¯å¯¹åæ£ä¸äºé¢çè®²è§£ï¼æ¯é10minsï¼æ¸æ°ææï¼\n    \n    \n    \n    ç®æ³é¢å»ºè®®ä¸å¤©ä¸é¢ãè¿æSQLï¼è¿ä¸¤ä¸ªççå¾éè¦ã\n\n 2. MySQL\n    \n    https://www.bilibili.com/video/BV1Kr4y1i7ru/?spm_id_from=333.337.search-card.all.click\n\n 3. SSM\n    \n    ãé»é©¬ç¨åºåSSMæ¡æ¶æç¨_Spring+SpringMVC+Mavené«çº§+SpringBoot+MyBatisPlusä¼ä¸å®ç¨å¼åææ¯ã\n    \n    æ¨èUPä¸»ï¼\n    \n    \n    \n    ä»çSSMè§é¢æ¯ä¸ªå¤§æ¦30hï¼ä¸å»ºè®®ä¸å¼å§å¥é¨çè¿ä¸ªï¼å¯ä»¥åçé»é©¬çSSMï¼ååçä»çè§é¢ã\n\n 4. SpringBoot\n    \n    ãé»é©¬ç¨åºåSpringBoot2å¨å¥è§é¢æç¨ï¼springbooté¶åºç¡å°é¡¹ç®å®æï¼spring boot2å®æ´çï¼ã\n\n 5. Redis\n    \n    ãé»é©¬ç¨åºåRediså¥é¨å°å®ææç¨ï¼æ·±åº¦éæredisåºå±åç+redisåå¸å¼é+ä¼ä¸è§£å³æ¹æ¡+é»é©¬ç¹è¯å®æé¡¹ç®ã\n\n 6. SpringCloud\n    \n    ãSpringCloud+RabbitMQ+Docker+Redis+æç´¢+åå¸å¼ï¼ç³»ç»è¯¦è§£springcloudå¾®æå¡ææ¯æ è¯¾ç¨|é»é©¬ç¨åºåJavaå¾®æå¡ã\n\n 7. æ¨èUPä¸»ï¼\n    \n    \n    \n    ä»çè§é¢æ¯ä¸äºå°ææ¯ç¹ï¼ä¾å¦JWTãDockerå¿«éä½¿ç¨ãVueå¿«éä½¿ç¨ãäºæå¡å¨æ­å»ºï¼åç«¯å­¦Vueçå¯ä»¥çä»çVueçåå éï¼æçå½å¨æçå®å°±å¯ä»¥äºã\n\n 8. è®¡ç®æºç½ç»\n    \n    æ¹ç§å¤§æä¹¦å çè®¡ç®æºç½ç»å¨ç½æå¼ºæ äºè®®\n    \n    ãè®¡ç®æºç½ç»å¾®è¯¾å ï¼æå­å¹æ èæ¯é³ä¹çï¼ã\n\n\n# 4. ä¸äºå»ºè®®\n\nä¸è¦å·çå®¢ï¼å ä¸ºä¸é¢æå½¢å½¢è²è²çäººï¼ä½ å¯è½ä¼å ä¸ºä»ä»¬çæå/å¤±è´¥æå°ç¦èï¼å¦æè½åç¦èä¸ºå¨åé£å¶å®æºå¥½ï¼ä½æ¯æä»¬å¤§å¤æ°é½æ¯æ®éäººï¼æ»ä¼è¢«ç¦èæå®ï¼æä»¥ä¸å°å¿è¦çæ¶ååä¸ä¸è¦å·çå®¢ï¼\nå¦æä½ è¿æ¯æå°ç¦èï¼ç¹å»èç³»æï¼å¥³å¨ç¹ðï¼ç·å¨æ»ðï¼\n\nä¸è¦ææä¸å®ï¼éä¸ªæ¹å all in å°±å®äºäº ï¼ä¸ç®¡æ¯å°±ä¸è¿æ¯èç ï¼ä¸ç®¡æ¯å¼åæµè¯è¿ç»´ç®æ³ï¼ä½ è¦æå¾all inçæºæ§ã\n\nææä¸æ¨èçå°±æ¯ä¸´æ¶è½¬æ¢æ¹åï¼æ¯å¦ä½ çå°ä»å¹´Javaä¸å¥½ä»å¹´C++ä¸å¥½ï¼èµ¶ç´§è½¬æ¹åãè¿ç§ææè ¢äºãæä¹ä¸æ¨èè³èå½è½¦ï¼å­¦åä¸å¥½å°±ä¸è¦ all in é£ç§å­¦åè¦æ±é«çæ¹åã\n\nå»æ çä¹¦/æç« /åå®¢ çä¹ æ¯ï¼å¹¶ä¸åè¯»åæï¼åªæç§çä¹¦æä¸éé½ä¼ææ¶è·ãååå®¢/ç¬è®°ä¸æ¯ä¸ºäºåªä¸ªå¹³å°çé£ç¹ç²ä¸çï¼è¿ä¸ªå¨ä½ åå¤é¢è¯çæ¶åä¼æå¾å¤§å¸®å©ã\n\nå¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢",normalizedContent:"# 1. è·¯çº¿\n\n 1.  javaåºç¡ -> éå -> io -> streamæµ -> å¤çº¿ç¨ -> ç½ç»ç¼ç¨\n\n 2.  mysql\n\n 3.  jdbc\n\n 4.  åç«¯ä¸åå®¢ï¼å»ºè®®å­¦ä¹ æ¶é´1å¨ä»¥åï¼å­¦htmlãjavascriptï¼ä¼æ¾ç¤ºæ°æ®å°±è¡ãéç¹å­¦ajaxï¼\n\n 5.  servlet ï¼å«å¨jspä¸è±å¤ªå¤æ¶é´ï¼\n\n 6.  è·bç«åä¸ªservleté¡¹ç®ï¼åç«¯åä¸åºæ¥æ­£å¸¸ï¼ç´æ¥é¢èµæ\n\n 7.  maven ï¼åé¢å¾å¤bugé½ä¼è·mavenæå³~ä½æ¯åªè¦ççå­¦ä¼äºå°±ä¸ä¼åºbugï¼\n\n 8.  springãmybatisãspringmvc\n     \n     springåmybatisçé¡ºåºçä½ èªå·±å§ãåæ­£æåå­¦mvcã\n     \n     ssmé¶æ®µåºå¾å¤bugå¾æ­£å¸¸ï¼åºçbugè¶å¤è¶å¥½ï¼å°è¯å¤debugãä¸ç¨åssmé¡¹ç®ï¼bç«æ²¡å¥å¥½çssmé¡¹ç®ï¼èªå·±ç¨ssmåå ä¸ªå¢å æ¹æ¥å°±è¡äºã\n     \n     æºç æå­¦ï¼ä¼æå»èªå·±ã\n\n 9.  springboot\n\n 10. å¯ä»¥åspringbooté¡¹ç®ï¼ä¹å¯ä»¥å­¦äºmybatis-plusä¹ååé¡¹ç®ï¼bç«æå¾å¤springbooté¡¹ç®ã\n\n 11. å¯ä»¥å­¦ä¸ä¸vueï¼ä½æ¯ä¸å»ºè®®è±å¤ªå¤æ¶é´\n\n 12. linuxï¼ä¸éè¦å­¦å¾å¤ï¼ä¼å®è£å¸è½½ï¼ä¼å³é²ç«å¢å°±è¡äºãå½ä»¤éç¨éæ¥ï¼\n\n 13. redis\n\n 14. ç»ä¸é¢ä½ åçé¡¹ç®å ä¸redisï¼ä¹å¯ä»¥æ¾ä¸ªspringboot+redisçé¡¹ç®ååï¼è¿è¾¹æ¨èé»é©¬ç¹è¯\n\n 15. mqï¼ä¸ä¸ªmqéä¸ä¸ªå­¦ï¼rabbitmqãrocketmqãkafkaãææ¨è rocketmq\n\n 16. åé¡¹ç®ï¼é»é©¬ç¹è¯ æè çå®¢è®ºåï¼ççä¸è¦å°çç§æå¨é¢è¯éçå«éé\n\n 17. docker ï¼å¿«éå®è£ä¸­é´ä»¶ï¼å¯ä»¥åä¸é¢æ¢é¡ºåºï¼dockerççå¾æ¹ä¾¿å®¶äººä»¬ï¼å­¦ä¼äºdockerï¼ä¸é¢çspringcloudçå¥½å¤§çåæ°ã\n\n 18. springcloudãspringcloud alibaba...\n\n 19. æ¥ä¸æ¥å°±æ¯jucãjvmè¿äºé¢è¯å¸¸ç¨çï¼åæ¶ï¼è®¡ç®æºåºç¡ä¹è¦æå¥½~ä¾å¦è®¡ç½ãæä½ç³»ç»ï¼é¢è¯çæ¶åç»å¸¸ä¼è¢«é®å°ã\n\nssmãspringbootè¦å¤è±æ¶é´ãåæ¶ç®æ³é¢åsqlä¹è¦å¤å·ã\n\nåæ¶ä¹å¯ä»¥å­¦ä¸äºå¶ä»çå·¥å·æèææ¯ï¼ä¾å¦gitï¼æä»£ç æ¾å°giteeæègithubä¸ï¼ç»¿æ²¹æ²¹ä¸çå¥½ççå~\n\næå\n\næåï¼ä¸é¢çææ¯æ å­¦å®äºä¹åå¯ä»¥å»çä¹¦ï¼å ä¸ºä½ ææ¯æ çä¼¼âå­¦å®äºâï¼ä½æ¯ææ¡çæä¹æ ·å¢ï¼\nåæ¶ï¼å¯ä»¥å¹å»èªå·±æ ¹æ®ææ¡£/åå®¢å»åé¡¹ç®çè½åï¼ç»ä½ ä¸ä¸ªæ¨¡åçå¤§è´æè¿°åå®æ´ä»£ç ï¼ä½ å¯ä»¥å°æ¨¡åå®æ´çååºæ¥åï¼\nå¬å¸æ»ä¸è½ä¸ºäºå ä¸ªå®ä¹ çå»å½å¶é¡¹ç®çå­¦ä¹ è§é¢å§~\n\n\n# 2. æ¨èå·¥å·\n\n * idea ï¼ä¸ç¨å¤è¯´å§~\n\n * postman ï¼ç¨æ¥åè¯·æ±ç\n\n * datagrip ï¼è¿æ¥æ°æ®åºçè¿ç¨å·¥å·ï¼è·ideaæ¯åä¸ä¸ªå¬å¸çï¼ä»£ç æç¤ºå¾åå¥½\n\n * navicat ï¼è¿æ¥æ°æ®åºçè¿ç¨å·¥å·ï¼æºå¥½ç¨\n\n * typora ï¼è®°ç¬è®°çå·¥å·ï¼æ ¼å¼æ¯markdownæ ¼å¼ï¼åå¤§åå®¢ç½ç«é½æ¯æã\n   \n   ä¸è¿å¾çä¿å­å¨æ¬å°ï¼ç´æ¥å¤å¶ç²è´´å°csdnåå¾çä¼âæ¶å¤±âï¼å¯ä»¥å°è¯æ­å»ºå¾åºï¼\n   \n   ï¼å³é®è¯æ ï¼typora + picgo + é¿éäº æ typora + gitee/githubï¼\n   \n   æ¨ètypora + picgo + é¿éäºï¼ä¸å¹´10åé±éåº¦ååå¿«\n\n * ææºç¬è®° ï¼å¦æä¸æ³ååå®¢ï¼åªæ¯æ³è®°å½ä¸ä¸èªå·±å¹³æ¶çç¬è®°ï¼å¼ºçæ¨èææºç¬è®°ãï¼ä»è´¹å¯ä»¥æ­å¾åºï¼\n\n * é­æ³ ï¼ddddï¼å¦ææ²¡æåéï¼åªæ¯æ¥å¸¸ç¨ä¸ä¸githubï¼å¯ä»¥ä¸è½½steam++ãå¦ææ³ççå¤é¢çä¸çï¼å¯ä»¥éè½åï¼é¾æ¥å°±ä¸æ¾äºï¼ä½ å»åç§ç¼ç¨äº¤æµç¾¤ä¸é®å°±æã\n\n * finalshell ï¼èªå·±ççµèè¿æ¥linuxçå·¥å·ï¼ä¹å¯ä»¥è¿æ¥äºæå¡å¨ï¼åè½æ¯xshell + xftpï¼\n\n * xshell ï¼è¿æ¥linuxçå·¥å·\n\n * xftp ï¼è¿æ¥linuxåå¿«éä¸ä¼ æä»¶çå·¥å·\n\n * chatgpt ï¼è¿ä¸ªä¸ç¨æå¤è¯´äºå§ï¼ä½æ¯å¦æä½ ä¸æ³è±é±ä¹°å¤å½çææºå·å¹¶ä¸ä½¿ç¨åºæ¯ä¸å¤çè¯ï¼å¯ä»¥ç¨ç¨çççï¼å¶å®å¤§å¤æ°äººå¯¹ ai çç¨å¤ä¹å°±æ°´ä¸ªå¹³æ¶ä½ä¸ï¼ç¨ç¨å½åçé£äºè¶³å¤äºã\n\n\n# 3. é¨åææ¯æ çæ¨èè§é¢\n\nä¸å¾ä¸è¯´ï¼é»é©¬å¨javaè§é¢è¿åå¾çé¼ã\n\n 1. æ°æ®ç»æä¸ç®æ³\n    \n    ãç®æ³å¤§ç¥ï¼çè3ä¸ªææé ãleetcodeç®æ³500é¢ãç®æ³ä¸æ°æ®ç»æä»åºç¡å°é«çº§å¨å®¶æ¡¶æç¨ï¼btajç­ä¸çº¿å¤§åé¢è¯å¿é®è¯¦è§£ï¼ã\n    \n    å·¦ç¨äºçç®æ³è¯¾ï¼è¿ä¸ªè§é¢æ¯éå²çï¼ä½æ¯ä»çåéå¾å¥½ã\n    \n    çå®ä¹åå¯ä»¥çbç«å®æ´ç80hï¼æå·¦ç¨äºå°±æäºã\n    \n    åçå®å¯ä»¥ä½¿ç¨éè½åæ¾çç~\n    \n    å³äºç®æ³é¢ä¹å¯ä»¥ççè¿ä½å¥ï¼ä»çè§é¢æ¯å¯¹åæ£ä¸äºé¢çè®²è§£ï¼æ¯é10minsï¼æ¸æ°ææï¼\n    \n    \n    \n    ç®æ³é¢å»ºè®®ä¸å¤©ä¸é¢ãè¿æsqlï¼è¿ä¸¤ä¸ªççå¾éè¦ã\n\n 2. mysql\n    \n    https://www.bilibili.com/video/bv1kr4y1i7ru/?spm_id_from=333.337.search-card.all.click\n\n 3. ssm\n    \n    ãé»é©¬ç¨åºåssmæ¡æ¶æç¨_spring+springmvc+mavené«çº§+springboot+mybatisplusä¼ä¸å®ç¨å¼åææ¯ã\n    \n    æ¨èupä¸»ï¼\n    \n    \n    \n    ä»çssmè§é¢æ¯ä¸ªå¤§æ¦30hï¼ä¸å»ºè®®ä¸å¼å§å¥é¨çè¿ä¸ªï¼å¯ä»¥åçé»é©¬çssmï¼ååçä»çè§é¢ã\n\n 4. springboot\n    \n    ãé»é©¬ç¨åºåspringboot2å¨å¥è§é¢æç¨ï¼springbooté¶åºç¡å°é¡¹ç®å®æï¼spring boot2å®æ´çï¼ã\n\n 5. redis\n    \n    ãé»é©¬ç¨åºårediså¥é¨å°å®ææç¨ï¼æ·±åº¦éæredisåºå±åç+redisåå¸å¼é+ä¼ä¸è§£å³æ¹æ¡+é»é©¬ç¹è¯å®æé¡¹ç®ã\n\n 6. springcloud\n    \n    ãspringcloud+rabbitmq+docker+redis+æç´¢+åå¸å¼ï¼ç³»ç»è¯¦è§£springcloudå¾®æå¡ææ¯æ è¯¾ç¨|é»é©¬ç¨åºåjavaå¾®æå¡ã\n\n 7. æ¨èupä¸»ï¼\n    \n    \n    \n    ä»çè§é¢æ¯ä¸äºå°ææ¯ç¹ï¼ä¾å¦jwtãdockerå¿«éä½¿ç¨ãvueå¿«éä½¿ç¨ãäºæå¡å¨æ­å»ºï¼åç«¯å­¦vueçå¯ä»¥çä»çvueçåå éï¼æçå½å¨æçå®å°±å¯ä»¥äºã\n\n 8. è®¡ç®æºç½ç»\n    \n    æ¹ç§å¤§æä¹¦å çè®¡ç®æºç½ç»å¨ç½æå¼ºæ äºè®®\n    \n    ãè®¡ç®æºç½ç»å¾®è¯¾å ï¼æå­å¹æ èæ¯é³ä¹çï¼ã\n\n\n# 4. ä¸äºå»ºè®®\n\nä¸è¦å·çå®¢ï¼å ä¸ºä¸é¢æå½¢å½¢è²è²çäººï¼ä½ å¯è½ä¼å ä¸ºä»ä»¬çæå/å¤±è´¥æå°ç¦èï¼å¦æè½åç¦èä¸ºå¨åé£å¶å®æºå¥½ï¼ä½æ¯æä»¬å¤§å¤æ°é½æ¯æ®éäººï¼æ»ä¼è¢«ç¦èæå®ï¼æä»¥ä¸å°å¿è¦çæ¶ååä¸ä¸è¦å·çå®¢ï¼\nå¦æä½ è¿æ¯æå°ç¦èï¼ç¹å»èç³»æï¼å¥³å¨ç¹ðï¼ç·å¨æ»ðï¼\n\nä¸è¦ææä¸å®ï¼éä¸ªæ¹å all in å°±å®äºäº ï¼ä¸ç®¡æ¯å°±ä¸è¿æ¯èç ï¼ä¸ç®¡æ¯å¼åæµè¯è¿ç»´ç®æ³ï¼ä½ è¦æå¾all inçæºæ§ã\n\nææä¸æ¨èçå°±æ¯ä¸´æ¶è½¬æ¢æ¹åï¼æ¯å¦ä½ çå°ä»å¹´javaä¸å¥½ä»å¹´c++ä¸å¥½ï¼èµ¶ç´§è½¬æ¹åãè¿ç§ææè ¢äºãæä¹ä¸æ¨èè³èå½è½¦ï¼å­¦åä¸å¥½å°±ä¸è¦ all in é£ç§å­¦åè¦æ±é«çæ¹åã\n\nå»æ çä¹¦/æç« /åå®¢ çä¹ æ¯ï¼å¹¶ä¸åè¯»åæï¼åªæç§çä¹¦æä¸éé½ä¼ææ¶è·ãååå®¢/ç¬è®°ä¸æ¯ä¸ºäºåªä¸ªå¹³å°çé£ç¹ç²ä¸çï¼è¿ä¸ªå¨ä½ åå¤é¢è¯çæ¶åä¼æå¾å¤§å¸®å©ã\n\nå¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢å¤å·é¢",charsets:{cjk:!0},lastUpdated:"2024/02/15, 16:56:10",lastUpdatedTimestamp:170798737e4},{title:"å¦ä½å°IPå°åå­å¥MySQL",frontmatter:{title:"å¦ä½å°IPå°åå­å¥MySQL",date:"2023-06-11T19:28:31.000Z",permalink:"/pages/ad5a8e/"},regularPath:"/02.%E6%96%87%E7%AB%A0/100.%E5%85%B6%E4%BB%96/5.%E5%A6%82%E4%BD%95%E5%B0%86IP%E5%9C%B0%E5%9D%80%E5%AD%98%E5%85%A5MySQL.html",relativePath:"02.æç« /100.å¶ä»/5.å¦ä½å°IPå°åå­å¥MySQL.md",key:"v-689aeb6e",path:"/pages/ad5a8e/",headersStr:null,content:"ä¹åè¢«é®è¿è¿æ ·ä¸ä¸ªé¢è¯é¢ï¼è¿è¾¹æ³è¦è®°å½ç¨æ·çIPå°åï¼è¯¥æä¹å­å¨å¢ï¼\nhiahiahiaðæçè¿è¿ç¯æç« ~\nç°å¨éæ°æ»ç»ä¸ä¸\nåå¦IPå°åä¸ºï¼192.168.101.24\n\nå¯è§IPå°åå±åä¸º4åï¼æ¯ä¸åç¨ç¹ç¸è¿æ¥ï¼å¯ä»¥ä½¿ç¨MySQLä¸­çintç±»åï¼ä¸å±32ä½ï¼æ¯8ä½å­å¨ä¸å°åIPå°åã\n\nä¾å¦ 192 çäºè¿å¶ä¸º 00000000 00000000 00000000 11000000ï¼å°å¶å·¦ç§»24ä½åå¾å°ï¼\n11000000 00000000 00000000 00000000\nåé¢çé£ä¹å¤0å¯ä»¥ç´æ¥æå¼æã\n\næ¥ä¸æ¥æ¯168ï¼å®çäºè¿å¶ä¸º: 00000000 00000000 00000000 10101000\nç±äº192ç¨äºæé«ç8ä½(ç¬¬ä¸ä¸ªå­è)ï¼168å°±ç¨åé¢ç8ä½(ç¬¬äºä¸ªå­è)ï¼å°168ç§»ä½16ä½åï¼\n00000000 10101000 0000000 000000000\n\næ¥ä¸æ¥æ¯101ï¼å®çäºè¿å¶ä¸ºï¼00000000 00000000 00000000 1100101\nåä¸¤ä¸ªå­èé½è¢«ç¨äºï¼ç°å¨å°±ç¨ç¬¬ä¸ä¸ªå­èï¼\n00000000 00000000 10101000 00000000\n\næåæ¯24ï¼å®åªå©æåä¸ä¸ªå­èå¯ç¨ï¼ä¸éè¦ç§»ä½ã00000000 00000000 00000000 00011000 ç§»0ä½åï¼\n00000000 00000000 00000000 00011000\n\nå°è¿åé¨åç»æä¸èµ·ï¼11000000 10101000 11001010 00011000ï¼äºæ¯å¾å°ä¸ä¸ªæ ç¬¦å·æ´æ°ï¼å­å¥æ°æ®åºã ååºæ¥çæ¶ååæ¹åçéå°±è¡äº~\n\næ³¨æ\n\né£ä¸å¤§ä¸²å¯ä¸æ¯ç´æ¥å½å­ç¬¦ä¸²å­å¥MySQLï¼èæ¯å°å¶å¯¹åºçåè¿å¶æ°ä»¥intç±»åå­å¥MySQLã",normalizedContent:"ä¹åè¢«é®è¿è¿æ ·ä¸ä¸ªé¢è¯é¢ï¼è¿è¾¹æ³è¦è®°å½ç¨æ·çipå°åï¼è¯¥æä¹å­å¨å¢ï¼\nhiahiahiaðæçè¿è¿ç¯æç« ~\nç°å¨éæ°æ»ç»ä¸ä¸\nåå¦ipå°åä¸ºï¼192.168.101.24\n\nå¯è§ipå°åå±åä¸º4åï¼æ¯ä¸åç¨ç¹ç¸è¿æ¥ï¼å¯ä»¥ä½¿ç¨mysqlä¸­çintç±»åï¼ä¸å±32ä½ï¼æ¯8ä½å­å¨ä¸å°åipå°åã\n\nä¾å¦ 192 çäºè¿å¶ä¸º 00000000 00000000 00000000 11000000ï¼å°å¶å·¦ç§»24ä½åå¾å°ï¼\n11000000 00000000 00000000 00000000\nåé¢çé£ä¹å¤0å¯ä»¥ç´æ¥æå¼æã\n\næ¥ä¸æ¥æ¯168ï¼å®çäºè¿å¶ä¸º: 00000000 00000000 00000000 10101000\nç±äº192ç¨äºæé«ç8ä½(ç¬¬ä¸ä¸ªå­è)ï¼168å°±ç¨åé¢ç8ä½(ç¬¬äºä¸ªå­è)ï¼å°168ç§»ä½16ä½åï¼\n00000000 10101000 0000000 000000000\n\næ¥ä¸æ¥æ¯101ï¼å®çäºè¿å¶ä¸ºï¼00000000 00000000 00000000 1100101\nåä¸¤ä¸ªå­èé½è¢«ç¨äºï¼ç°å¨å°±ç¨ç¬¬ä¸ä¸ªå­èï¼\n00000000 00000000 10101000 00000000\n\næåæ¯24ï¼å®åªå©æåä¸ä¸ªå­èå¯ç¨ï¼ä¸éè¦ç§»ä½ã00000000 00000000 00000000 00011000 ç§»0ä½åï¼\n00000000 00000000 00000000 00011000\n\nå°è¿åé¨åç»æä¸èµ·ï¼11000000 10101000 11001010 00011000ï¼äºæ¯å¾å°ä¸ä¸ªæ ç¬¦å·æ´æ°ï¼å­å¥æ°æ®åºã ååºæ¥çæ¶ååæ¹åçéå°±è¡äº~\n\næ³¨æ\n\né£ä¸å¤§ä¸²å¯ä¸æ¯ç´æ¥å½å­ç¬¦ä¸²å­å¥mysqlï¼èæ¯å°å¶å¯¹åºçåè¿å¶æ°ä»¥intç±»åå­å¥mysqlã",charsets:{cjk:!0},lastUpdated:"2023/06/11, 21:22:31",lastUpdatedTimestamp:1686489751e3},{title:"Gitè¸©å",frontmatter:{title:"Gitè¸©å",date:"2023-07-04T18:32:54.000Z",permalink:"/pages/f63fe9/"},regularPath:"/02.%E6%96%87%E7%AB%A0/1000.%E5%AE%9E%E4%B9%A0%E5%B0%8F%E7%BB%93/1.Git%E8%B8%A9%E5%9D%91.html",relativePath:"02.æç« /1000.å®ä¹ å°ç»/1.Gitè¸©å.md",key:"v-30dbcc76",path:"/pages/f63fe9/",headers:[{level:2,title:"1. åæ¢åæ¯",slug:"_1-åæ¢åæ¯",normalizedTitle:"1. åæ¢åæ¯",charIndex:87},{level:2,title:"2. å¿è®°åæ¢åæ¯",slug:"_2-å¿è®°åæ¢åæ¯",normalizedTitle:"2. å¿è®°åæ¢åæ¯",charIndex:580},{level:2,title:"3. poll",slug:"_3-poll",normalizedTitle:"3. poll",charIndex:1062},{level:2,title:"4. é¨ç½²å°æµè¯ç¯å¢",slug:"_4-é¨ç½²å°æµè¯ç¯å¢",normalizedTitle:"4. é¨ç½²å°æµè¯ç¯å¢",charIndex:1568}],headersStr:"1. åæ¢åæ¯ 2. å¿è®°åæ¢åæ¯ 3. poll 4. é¨ç½²å°æµè¯ç¯å¢",content:'ç¬è®°\n\nå°½ç®¡å¨å®ä¹ åæå¨Bç«çäºå¾å¤å³äºå®ä¹ è¸©åçè§é¢ï¼ä¹é®äºä¸äºå­¦é¿ä»ä»¬è¸©çåï¼ä½æ¯è¯¥è¸©çåè¿æ¯ä¸ä¸ªé½ä¸ä¼å°ç~\næ¬ç¯ç¬è®°è®°å½ä¸ä¸èªå·±å¨å¬å¸ä½¿ç¨Gitæ¶åºçbug\n\n\n# 1. åæ¢åæ¯\n\nä¸è¬çæµç¨åºè¯¥æ¯: èå¤§è·ä½ è¯´è¦åä¸åªä¸ªé¡¹ç®ï¼æé¡¹ç®æºç é¾æ¥åä½ ï¼GitLab/Github/Giteeï¼ï¼æ¿å°æä¸åæä¸æ¥é»è®¤æ¯ä¸»åæ¯ï¼ ä¹å°±æ¯masterï¼ä½æ¯ä¸è¬æ¥è¯´æ¯ä¸åè®¸å¼åäººåå¾ master åæ¯ä¸­ push ä»£ç çï¼è¿æ¶åä½ å°±è¦åæ¢å°å½åçæ¬çåæ¯ã\nåæ¢æ¹æ³ï¼ æå¼IDEAä¸­Gitçç®¡çæ¡ï¼æçæ¯2023æ°UIï¼æ§UIåºè¯¥å¨æä¸é¢çä¸­é´ï¼\nç¶åç¹å»Fatch\nç¹å»ä¹åå°±ä¼çå°å³ä¸è§é¤äºmasterä¹å¤åè¹¦åºæ¥é¡¹ç®ä¸­çå¶ä»çåæ¯\nè¿æ¶ä½ åä¼çå°åä¸º Local Branches å Remote Branches\nLocal Branchesï¼ æ¬å°çåæ¯ï¼ä¹å°±æ¯ä½ å¨è¿ç¨ä»åºä¸­æåçåæ¯ã\nRemote Branchesï¼è¿ç¨çåæ¯ï¼ä¹å°±æ¯ç°å¨ä»åºä¸­çææåæ¯ã\næä»¬å°±å¨Remote Branchesä¸­éæ©å°è¦åæ¢çåæ¯\n\n\nç¹å»æä¸ªè¿ç¨åæ¯ä¹åæä¸ä¸ªcheckoutï¼ç¹å»checkoutå°±å¯ä»¥æè¿ä¸ªåæ¯æå°æ¬å°ï¼åºè¯¥ä¼é»è®¤åæ¢æ¬å°çåæ¯ï¼å¦ææ²¡æåæ¢å°±æå¨checkoutä¸ä¸ã\n\nåæ¢å°å½åçæ¬çåæ¯ä¹åå°±å¯ä»¥æå¿«çåä»£ç äº~\n\n\n# 2. å¿è®°åæ¢åæ¯\n\næå°±å¿è®°åæ¢åæ¯äºï¼ç¶åå¨masterä¸­åçä»£ç ï¼åå®ä¹å commit -> push ä¸æ¡é¾ï¼åè¶£ master ä¸è®© pushï¼ï¼ï¼\näºæ¯æèµ¶ç´§åæ¢åå¼åçæ¬ï¼æä¸ç§°å®ä¸º dev1.0.0 å§ã\nåæ¢å° dev1.0.0 ä¹ååç°æçä»£ç æ²¡äºï¼ï¼ å¥½çåï¼ç°å¨çé®é¢å°±æ¯ï¼æå¨ master åçä»£ç  commit ä¹åï¼åæ¢å dev1.0 åç°æ¶å¤±äºã\né£è¯å®ä¸è½éæ°ååï¼ç°å¨è¦åçå°±æ¯æ master ä¸­å·²ç»commitçä»£ç æå°devåæ¯çæ¬å°ï¼ç¶åéæ°ä¸ä¼ ã\nè§£å³ï¼è¦ç¡®ä¿ä»£ç å¨msaterä¸­å·²ç»commitäºï¼å¹¶ä¸ç°å¨dev1.0åæ¯æ¯ææ°çï¼å«å¿è®°pollä¸ä¸å¦ï¼ã\nç°å¨æ¯dev1.0åæ¯ï¼æå¼Git Log\n\nå¨è¿éä½ å¯ä»¥çå°ææäººç commit/push è®°å½ï¼æ¾å° master å¹¶ä¸æ¾å°ä½ èªå·±ï¼å¹¶ä¸æ¾å°é£ä¸æ¡éè¦æ¢å¤çè®°å½ã\n\nåå¦æåæcommitçæ¯ "éåçæå¤§å¼" è¿ä¸æ¡è®°å½ï¼æç°å¨æ³æå®æåå°devæ¬å°ï¼é£ä¹æå³é®ä¹åç¹å»Cherry-Pickç¶åç¨ç­çå»å°±å¯ä»¥çå°åæåçä»£ç äº~ã\n\n\n\n# 3. poll\n\nèªå·±åé¡¹ç®çæ¶åå¾å¾å°±ä¸ä¸ªåæ¯ç¨å°åºï¼èä¸ä¸ä¼æå«äººå¾è¿ä¸ªé¡¹ç®éé¢åä»£ç ãä½æ¯å¨å¬å¸æ¶æ¶å»å»é½ä¼æäººå¾Githubä¸æ¾ä»£ç ã\nè®¾æ³è¿ä¸ªåºæ¯ï¼ä½ åæå±ä¿©äººåä¸å¤©å¥èï¼åä¸å¤©åä»£ç ï¼ä½ è´è´£è®¢åorderæ¨¡åï¼æè´è´£éé¤sendFoodæ¨¡åã\næä»¬åä¸å¤©æåä»£ç ï¼é£ä¹è¿ä¸ªæ¶åå±ä¿©å¾å°çä»£ç å°±æ¯ä¸æ ·çï¼ä½æ¯å å¤©ä¹åï¼ä½ å¨orderæ¨¡åæ·»å äºAç±»ä¸Bç±»ï¼æå¨sendFoodæ¨¡åä¸­æ·»å äºGç±»ä¸Oç±»ã\nç°å¨å±ä¿©äººçä»£ç ä¸ä¸æ ·ï¼ä½ ççµèéæ²¡ææåçGåOï¼æççµèéæ²¡æä½ åçAåBã\nä½ ååå®pushä¸å»äºï¼ç°å¨çGithubä»£ç å¨æä»¬å¥èæ¶åå§ä»£ç çåæä¸å¢å äºä½ çAåBãä½æ¯æåå®ä¹åä¹pushäºä¸ä¸ï¼ä¼åçä»ä¹äºæï¼\næ push ä¸å»çä»£ç æ²¡æä½ çä»£ç ï¼é£ä¹ä½ ä¹åpushä¸å»çä»£ç å°±ä¼è¢«è¦çï¼ã\nç®èè¨ä¹ï¼ä½ ç½å¹²äºã\næ³è¦é¿åè¿ç§æåµï¼ä¹æ¯å®ä¹ çéå¸¸éå¸¸å®¹æåºç°çé®é¢ï¼ï¼pushä»£ç ä¹ååpollä»£ç ã\nä¹å°±æ¯å¾ä¸æ¾ä»£ç ä¹ååæä»£ç æå°ä½ ççµèä¸ãæµç¨æ¯ï¼poll -> commit -> push\nå¨IDEAä¸­å°±æ´ç®åäºï¼ä¸é¢è¿ä¸ä¸ªæé®ä»å·¦å°å³æ¨ä¸ªæä¸éå°±å¯ä»¥é¿åä¸è¿°é®é¢ï¼\n\n\n\n# 4. é¨ç½²å°æµè¯ç¯å¢\n\nä¸å¤§æ©éæ¥ï¼æµè¯è·æè¯´æåçæ¥å£å¨æ²¡æè¿ð¢ð¥²ï¼ææåå¾å¿æèæï¼ææ³è¿æä¹å¯è½å¢ï¼äºæ¯ææå¼çº¿ä¸å°åï¼æµè¯äºä¸ä¸è¿çæ¯å¨é½æ²¡æè¿....ä½æ¯æå¨æ¬å°æ¯å¨é¨é½å¯ä»¥è·éçåï¼äºæ¯æå¼å§æå¼æµè¯ç¯å¢çæ¥å¿å»æ¥ï¼å¬å¸ç¨çESï¼ï¼åç°è¿è·æåçä»£ç é»è¾æ¥åºé¡ºåºä¸å¤ªä¸æ ·ä½æ¯ä¼¼æ¾ç¸è¯åï¼ï¼\nè¿æ¯æåå¤©åçä»£ç ï¼è¿æ¶åºæ¬å·²ç»å®ä½å°é®é¢äºï¼æçä»£ç æ²¡ææ¾å°æµè¯ç¯å¢ä¸ï¼\nä¸ºäºéªè¯æ¯ä¸æ¯è¿ä¸ªé®é¢ï¼ææä¹ååçå¯¼åºæä»¶çæ¥å£æµè¯äºä¸ä¸ï¼åç°Excelæä»¶ç¡®å®è·æåè°å¥½çæ ¼å¼ä¸ä¸æ ·ã\nç°å¨çé®é¢æ¯ï¼æçä»£ç æ¾å°å¼åç¯å¢äºï¼ä½æ¯æ²¡ææ¾å°æµè¯ç¯å¢ã\näºæ¯ææå¼IDEAçè¿ç¨åæ¯ï¼ç¡®å®æä¸ä¸ª âxxx_testâï¼äºæ¯ææå®æå°æ¬å°ï¼ä½æ¯æåç°æcommitçæ¶åæ¬å°å¹¶æ²¡æä»£ç éè¦æäº¤å°teståæ¯é\nä¸å¯¹å²åï¼æçä»£ç åºè¯¥æ²¡æå¨teståæ¯commitè¿åãåæ¥å¸¦æçå¤§å¥è¯´ï¼ä½ è¦æå¼ååæ¯ä¸­å·²ç»commitçä»£ç mergeå°æµè¯åæ¯ã\n\näºæ¯æ­¥éª¤å¦ä¸ï¼\n\n 1. åæ¢å°teståæ¯\n 2. å°å¼ååæ¯çä»£ç mergeå°teståæ¯\n 3. å°åå¹¶åçä»£ç pushå°ä»åºä¸­ã',normalizedContent:'ç¬è®°\n\nå°½ç®¡å¨å®ä¹ åæå¨bç«çäºå¾å¤å³äºå®ä¹ è¸©åçè§é¢ï¼ä¹é®äºä¸äºå­¦é¿ä»ä»¬è¸©çåï¼ä½æ¯è¯¥è¸©çåè¿æ¯ä¸ä¸ªé½ä¸ä¼å°ç~\næ¬ç¯ç¬è®°è®°å½ä¸ä¸èªå·±å¨å¬å¸ä½¿ç¨gitæ¶åºçbug\n\n\n# 1. åæ¢åæ¯\n\nä¸è¬çæµç¨åºè¯¥æ¯: èå¤§è·ä½ è¯´è¦åä¸åªä¸ªé¡¹ç®ï¼æé¡¹ç®æºç é¾æ¥åä½ ï¼gitlab/github/giteeï¼ï¼æ¿å°æä¸åæä¸æ¥é»è®¤æ¯ä¸»åæ¯ï¼ ä¹å°±æ¯masterï¼ä½æ¯ä¸è¬æ¥è¯´æ¯ä¸åè®¸å¼åäººåå¾ master åæ¯ä¸­ push ä»£ç çï¼è¿æ¶åä½ å°±è¦åæ¢å°å½åçæ¬çåæ¯ã\nåæ¢æ¹æ³ï¼ æå¼ideaä¸­gitçç®¡çæ¡ï¼æçæ¯2023æ°uiï¼æ§uiåºè¯¥å¨æä¸é¢çä¸­é´ï¼\nç¶åç¹å»fatch\nç¹å»ä¹åå°±ä¼çå°å³ä¸è§é¤äºmasterä¹å¤åè¹¦åºæ¥é¡¹ç®ä¸­çå¶ä»çåæ¯\nè¿æ¶ä½ åä¼çå°åä¸º local branches å remote branches\nlocal branchesï¼ æ¬å°çåæ¯ï¼ä¹å°±æ¯ä½ å¨è¿ç¨ä»åºä¸­æåçåæ¯ã\nremote branchesï¼è¿ç¨çåæ¯ï¼ä¹å°±æ¯ç°å¨ä»åºä¸­çææåæ¯ã\næä»¬å°±å¨remote branchesä¸­éæ©å°è¦åæ¢çåæ¯\n\n\nç¹å»æä¸ªè¿ç¨åæ¯ä¹åæä¸ä¸ªcheckoutï¼ç¹å»checkoutå°±å¯ä»¥æè¿ä¸ªåæ¯æå°æ¬å°ï¼åºè¯¥ä¼é»è®¤åæ¢æ¬å°çåæ¯ï¼å¦ææ²¡æåæ¢å°±æå¨checkoutä¸ä¸ã\n\nåæ¢å°å½åçæ¬çåæ¯ä¹åå°±å¯ä»¥æå¿«çåä»£ç äº~\n\n\n# 2. å¿è®°åæ¢åæ¯\n\næå°±å¿è®°åæ¢åæ¯äºï¼ç¶åå¨masterä¸­åçä»£ç ï¼åå®ä¹å commit -> push ä¸æ¡é¾ï¼åè¶£ master ä¸è®© pushï¼ï¼ï¼\näºæ¯æèµ¶ç´§åæ¢åå¼åçæ¬ï¼æä¸ç§°å®ä¸º dev1.0.0 å§ã\nåæ¢å° dev1.0.0 ä¹ååç°æçä»£ç æ²¡äºï¼ï¼ å¥½çåï¼ç°å¨çé®é¢å°±æ¯ï¼æå¨ master åçä»£ç  commit ä¹åï¼åæ¢å dev1.0 åç°æ¶å¤±äºã\né£è¯å®ä¸è½éæ°ååï¼ç°å¨è¦åçå°±æ¯æ master ä¸­å·²ç»commitçä»£ç æå°devåæ¯çæ¬å°ï¼ç¶åéæ°ä¸ä¼ ã\nè§£å³ï¼è¦ç¡®ä¿ä»£ç å¨msaterä¸­å·²ç»commitäºï¼å¹¶ä¸ç°å¨dev1.0åæ¯æ¯ææ°çï¼å«å¿è®°pollä¸ä¸å¦ï¼ã\nç°å¨æ¯dev1.0åæ¯ï¼æå¼git log\n\nå¨è¿éä½ å¯ä»¥çå°ææäººç commit/push è®°å½ï¼æ¾å° master å¹¶ä¸æ¾å°ä½ èªå·±ï¼å¹¶ä¸æ¾å°é£ä¸æ¡éè¦æ¢å¤çè®°å½ã\n\nåå¦æåæcommitçæ¯ "éåçæå¤§å¼" è¿ä¸æ¡è®°å½ï¼æç°å¨æ³æå®æåå°devæ¬å°ï¼é£ä¹æå³é®ä¹åç¹å»cherry-pickç¶åç¨ç­çå»å°±å¯ä»¥çå°åæåçä»£ç äº~ã\n\n\n\n# 3. poll\n\nèªå·±åé¡¹ç®çæ¶åå¾å¾å°±ä¸ä¸ªåæ¯ç¨å°åºï¼èä¸ä¸ä¼æå«äººå¾è¿ä¸ªé¡¹ç®éé¢åä»£ç ãä½æ¯å¨å¬å¸æ¶æ¶å»å»é½ä¼æäººå¾githubä¸æ¾ä»£ç ã\nè®¾æ³è¿ä¸ªåºæ¯ï¼ä½ åæå±ä¿©äººåä¸å¤©å¥èï¼åä¸å¤©åä»£ç ï¼ä½ è´è´£è®¢åorderæ¨¡åï¼æè´è´£éé¤sendfoodæ¨¡åã\næä»¬åä¸å¤©æåä»£ç ï¼é£ä¹è¿ä¸ªæ¶åå±ä¿©å¾å°çä»£ç å°±æ¯ä¸æ ·çï¼ä½æ¯å å¤©ä¹åï¼ä½ å¨orderæ¨¡åæ·»å äºaç±»ä¸bç±»ï¼æå¨sendfoodæ¨¡åä¸­æ·»å äºgç±»ä¸oç±»ã\nç°å¨å±ä¿©äººçä»£ç ä¸ä¸æ ·ï¼ä½ ççµèéæ²¡ææåçgåoï¼æççµèéæ²¡æä½ åçaåbã\nä½ ååå®pushä¸å»äºï¼ç°å¨çgithubä»£ç å¨æä»¬å¥èæ¶åå§ä»£ç çåæä¸å¢å äºä½ çaåbãä½æ¯æåå®ä¹åä¹pushäºä¸ä¸ï¼ä¼åçä»ä¹äºæï¼\næ push ä¸å»çä»£ç æ²¡æä½ çä»£ç ï¼é£ä¹ä½ ä¹åpushä¸å»çä»£ç å°±ä¼è¢«è¦çï¼ã\nç®èè¨ä¹ï¼ä½ ç½å¹²äºã\næ³è¦é¿åè¿ç§æåµï¼ä¹æ¯å®ä¹ çéå¸¸éå¸¸å®¹æåºç°çé®é¢ï¼ï¼pushä»£ç ä¹ååpollä»£ç ã\nä¹å°±æ¯å¾ä¸æ¾ä»£ç ä¹ååæä»£ç æå°ä½ ççµèä¸ãæµç¨æ¯ï¼poll -> commit -> push\nå¨ideaä¸­å°±æ´ç®åäºï¼ä¸é¢è¿ä¸ä¸ªæé®ä»å·¦å°å³æ¨ä¸ªæä¸éå°±å¯ä»¥é¿åä¸è¿°é®é¢ï¼\n\n\n\n# 4. é¨ç½²å°æµè¯ç¯å¢\n\nä¸å¤§æ©éæ¥ï¼æµè¯è·æè¯´æåçæ¥å£å¨æ²¡æè¿ð¢ð¥²ï¼ææåå¾å¿æèæï¼ææ³è¿æä¹å¯è½å¢ï¼äºæ¯ææå¼çº¿ä¸å°åï¼æµè¯äºä¸ä¸è¿çæ¯å¨é½æ²¡æè¿....ä½æ¯æå¨æ¬å°æ¯å¨é¨é½å¯ä»¥è·éçåï¼äºæ¯æå¼å§æå¼æµè¯ç¯å¢çæ¥å¿å»æ¥ï¼å¬å¸ç¨çesï¼ï¼åç°è¿è·æåçä»£ç é»è¾æ¥åºé¡ºåºä¸å¤ªä¸æ ·ä½æ¯ä¼¼æ¾ç¸è¯åï¼ï¼\nè¿æ¯æåå¤©åçä»£ç ï¼è¿æ¶åºæ¬å·²ç»å®ä½å°é®é¢äºï¼æçä»£ç æ²¡ææ¾å°æµè¯ç¯å¢ä¸ï¼\nä¸ºäºéªè¯æ¯ä¸æ¯è¿ä¸ªé®é¢ï¼ææä¹ååçå¯¼åºæä»¶çæ¥å£æµè¯äºä¸ä¸ï¼åç°excelæä»¶ç¡®å®è·æåè°å¥½çæ ¼å¼ä¸ä¸æ ·ã\nç°å¨çé®é¢æ¯ï¼æçä»£ç æ¾å°å¼åç¯å¢äºï¼ä½æ¯æ²¡ææ¾å°æµè¯ç¯å¢ã\näºæ¯ææå¼ideaçè¿ç¨åæ¯ï¼ç¡®å®æä¸ä¸ª âxxx_testâï¼äºæ¯ææå®æå°æ¬å°ï¼ä½æ¯æåç°æcommitçæ¶åæ¬å°å¹¶æ²¡æä»£ç éè¦æäº¤å°teståæ¯é\nä¸å¯¹å²åï¼æçä»£ç åºè¯¥æ²¡æå¨teståæ¯commitè¿åãåæ¥å¸¦æçå¤§å¥è¯´ï¼ä½ è¦æå¼ååæ¯ä¸­å·²ç»commitçä»£ç mergeå°æµè¯åæ¯ã\n\näºæ¯æ­¥éª¤å¦ä¸ï¼\n\n 1. åæ¢å°teståæ¯\n 2. å°å¼ååæ¯çä»£ç mergeå°teståæ¯\n 3. å°åå¹¶åçä»£ç pushå°ä»åºä¸­ã',charsets:{cjk:!0},lastUpdated:"2023/07/13, 12:36:57",lastUpdatedTimestamp:1689223017e3},{title:"xxl job Access token is wrong",frontmatter:{title:"xxl job Access token is wrong",date:"2023-11-09T13:14:25.000Z",permalink:"/pages/65cd6f/"},regularPath:"/02.%E6%96%87%E7%AB%A0/200.%E8%B8%A9%E5%9D%91/10.xxl%20job%20Access%20token%20is%20wrong.html",relativePath:"02.æç« /200.è¸©å/10.xxl job Access token is wrong.md",key:"v-aebcce32",path:"/pages/65cd6f/",headersStr:null,content:"æåéå°äºXXL-JOBçä¸ä¸ªé®é¢ï¼\n\nxxl-job registry fail, registryParam:RegistryParam{registryGroup= EXECUTOR , registryKey= xxl-job-executor-sample , registryValue= http://10.16.245.130:9999/ }, registryResult:ReturnT [code=500, msg=The accessToken is wrong.]\n\n\nææå°±æ¯æ§è¡å¨æ³¨åå¤±è´¥äºï¼æ¥éä¿¡æ¯æ¯ tokenéäºã\n\nè§£å³ï¼\n\n 1. æ£æ¥çæ¬ã\n    \n    æä»¬é½ç¥éä½¿ç¨ xxl-job çæ¶åéè¦å¨éç½®æä»¶ä¸­éç½®ä¸ä¸\n    \n    xxl.job.accessToken=default_token\n    \n    \n    ä½æ¯ 2.4.0 è· 2.2.0 ç¨çæ¯ä¸ä¸æ ·çã\n    \n    2.2.0çæ¬ç xxl-job è§£ææ¶è¯»çæ¯ï¼\n    \n    @Value(${xxl.job.admin.accessToken})\n    \n    \n    æä»¥ä½ ççèªå·±ççæ¬ï¼å¦ææ¯2.2.0 å°±è¦å¤å ä¸ä¸ª admin\n\n 2. æ£æ¥éç½®\n    \n    èªå·±éç½®çéç½®ç±»æå¯è½åºéï¼å°±æ¯é£ä¸ªå« XxlJobConfig çç±»ï¼ççå°åºææ²¡ææå® accessToken\n    \n    åæ ·å«å¿äºå¶ä»éç½®ï¼å°½éå¨æºç éé¢æã\n    \n    \n\nåå ï¼ç¬¬ä¸ä¸ªå°±ä¸è¯´äºï¼è¿éç½®é½åºéäºè¯å®è¿ä¸ä¸ãè¯´ä¸ä¸ç¬¬äºä¸ªçåå ã\n\næä»¬å¼å¥ç xxl-job-core ä¾èµä¸­æä¸ä¸ªç±»ï¼AdminBizClient ï¼è¿ä¸ªæ¯æ§è¡å¨ç»è°åº¦ä¸­å¿åæ¶æ¯ï¼ä¹å°±æ¯åHTTPè¯·æ±çç±»ï¼æ¯HTTPè¯·æ±å°±æå¯è½å¸¦tokenï¼é£ä¹tokenä»åªéæ¥ï¼å¯¹ï¼ä» XxlJobSpringExecutor ä¸­ç±ä½ æ¥éç½®ï¼ä½æ¯ï¼ä½ æ²¡æéç½®ï¼é£ä¹åè¿å»çè¯·æ±å°±æ²¡ætokenï¼æä»¥å°±æ²¡æ³æ³¨åå½~",normalizedContent:"æåéå°äºxxl-jobçä¸ä¸ªé®é¢ï¼\n\nxxl-job registry fail, registryparam:registryparam{registrygroup= executor , registrykey= xxl-job-executor-sample , registryvalue= http://10.16.245.130:9999/ }, registryresult:returnt [code=500, msg=the accesstoken is wrong.]\n\n\nææå°±æ¯æ§è¡å¨æ³¨åå¤±è´¥äºï¼æ¥éä¿¡æ¯æ¯ tokenéäºã\n\nè§£å³ï¼\n\n 1. æ£æ¥çæ¬ã\n    \n    æä»¬é½ç¥éä½¿ç¨ xxl-job çæ¶åéè¦å¨éç½®æä»¶ä¸­éç½®ä¸ä¸\n    \n    xxl.job.accesstoken=default_token\n    \n    \n    ä½æ¯ 2.4.0 è· 2.2.0 ç¨çæ¯ä¸ä¸æ ·çã\n    \n    2.2.0çæ¬ç xxl-job è§£ææ¶è¯»çæ¯ï¼\n    \n    @value(${xxl.job.admin.accesstoken})\n    \n    \n    æä»¥ä½ ççèªå·±ççæ¬ï¼å¦ææ¯2.2.0 å°±è¦å¤å ä¸ä¸ª admin\n\n 2. æ£æ¥éç½®\n    \n    èªå·±éç½®çéç½®ç±»æå¯è½åºéï¼å°±æ¯é£ä¸ªå« xxljobconfig çç±»ï¼ççå°åºææ²¡ææå® accesstoken\n    \n    åæ ·å«å¿äºå¶ä»éç½®ï¼å°½éå¨æºç éé¢æã\n    \n    \n\nåå ï¼ç¬¬ä¸ä¸ªå°±ä¸è¯´äºï¼è¿éç½®é½åºéäºè¯å®è¿ä¸ä¸ãè¯´ä¸ä¸ç¬¬äºä¸ªçåå ã\n\næä»¬å¼å¥ç xxl-job-core ä¾èµä¸­æä¸ä¸ªç±»ï¼adminbizclient ï¼è¿ä¸ªæ¯æ§è¡å¨ç»è°åº¦ä¸­å¿åæ¶æ¯ï¼ä¹å°±æ¯åhttpè¯·æ±çç±»ï¼æ¯httpè¯·æ±å°±æå¯è½å¸¦tokenï¼é£ä¹tokenä»åªéæ¥ï¼å¯¹ï¼ä» xxljobspringexecutor ä¸­ç±ä½ æ¥éç½®ï¼ä½æ¯ï¼ä½ æ²¡æéç½®ï¼é£ä¹åè¿å»çè¯·æ±å°±æ²¡ætokenï¼æä»¥å°±æ²¡æ³æ³¨åå½~",charsets:{cjk:!0},lastUpdated:"2023/11/09, 13:28:41",lastUpdatedTimestamp:1699507721e3},{title:"å½éåæ¶éè¦è¿åç»åç«¯ä¸æ®µjsonï¼jsonå·¥å·ä¸åç»ææ¥é",frontmatter:{title:"å½éåæ¶éè¦è¿åç»åç«¯ä¸æ®µjsonï¼jsonå·¥å·ä¸åç»ææ¥é",date:"2023-11-09T13:16:56.000Z",permalink:"/pages/3cac9b/"},regularPath:"/02.%E6%96%87%E7%AB%A0/200.%E8%B8%A9%E5%9D%91/20.%E5%9B%BD%E9%99%85%E5%8C%96%E6%97%B6%E9%9C%80%E8%A6%81%E8%BF%94%E5%9B%9E%E7%BB%99%E5%89%8D%E7%AB%AF%E4%B8%80%E6%AE%B5json%EF%BC%8Cjson%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%90%8C%E7%BB%93%E6%9E%9C%E6%8A%A5%E9%94%99.html",relativePath:"02.æç« /200.è¸©å/20.å½éåæ¶éè¦è¿åç»åç«¯ä¸æ®µjsonï¼jsonå·¥å·ä¸åç»ææ¥é.md",key:"v-59982f2a",path:"/pages/3cac9b/",headersStr:null,content:'å¨ xxl-job ä¸­ç¨å°äºI18Utilï¼ä¹å°±æ¯å½éåï¼è¿ä¸ªä¸è¥¿éç½®åéè¦å¨ cookie ä¸­ è¿è¡å½éåãåç«¯éè¦çæ¶ååè°ç¨å¯¹åºçåç«¯è¿åçjsonä¸²ã\n\næºç ä¸­ä½¿ç¨ com.fasterxml.jackson.databind.ObjectMapper è¿è¡jsonçæ ¼å¼åï¼æç¨äº com.google.gson.Gson ã\n\nä½æ¯ææ¥éï¼\n\n10:34:17.510 logback [http-nio-8080-exec-3] ERROR freemarker.runtime - Error executing FreeMarker template\nfreemarker.core._MiscTemplateException: Failed to "?eval" string with this error:\n\n---begin-message---\nSyntax error in ?eval-ed string in line 1, column 6248:\nLexical error: encountered "u" (117), after "\\"{0}/{1} [\\u4efb\\u52a1ID\\\\".\n---end-message---\n\nThe failing expression:\n==> I18nUtil.getMultString()?eval  [in template "common/common.macro.ftl" at line 32, column 25]\n\n----\nFTL stack trace ("~" means nesting-related):\n\t- Failed at: #global I18n = I18nUtil.getMultString...  [in template "common/common.macro.ftl" in macro "commonStyle" at line 32, column 9]\n\t- Reached through: @netCommon.commonStyle  [in template "login.ftl" at line 5, column 9]\n----\n\n\nçæçjsonä¸²æ¯ä¸æ ·çï¼\n\n\n\nä½æ¯æè¿æ²¡æ¾å°åå ã\n\nåèæç« ï¼\n\n[[FreeMarker Error] Failed to "?eval" string]',normalizedContent:'å¨ xxl-job ä¸­ç¨å°äºi18utilï¼ä¹å°±æ¯å½éåï¼è¿ä¸ªä¸è¥¿éç½®åéè¦å¨ cookie ä¸­ è¿è¡å½éåãåç«¯éè¦çæ¶ååè°ç¨å¯¹åºçåç«¯è¿åçjsonä¸²ã\n\næºç ä¸­ä½¿ç¨ com.fasterxml.jackson.databind.objectmapper è¿è¡jsonçæ ¼å¼åï¼æç¨äº com.google.gson.gson ã\n\nä½æ¯ææ¥éï¼\n\n10:34:17.510 logback [http-nio-8080-exec-3] error freemarker.runtime - error executing freemarker template\nfreemarker.core._misctemplateexception: failed to "?eval" string with this error:\n\n---begin-message---\nsyntax error in ?eval-ed string in line 1, column 6248:\nlexical error: encountered "u" (117), after "\\"{0}/{1} [\\u4efb\\u52a1id\\\\".\n---end-message---\n\nthe failing expression:\n==> i18nutil.getmultstring()?eval  [in template "common/common.macro.ftl" at line 32, column 25]\n\n----\nftl stack trace ("~" means nesting-related):\n\t- failed at: #global i18n = i18nutil.getmultstring...  [in template "common/common.macro.ftl" in macro "commonstyle" at line 32, column 9]\n\t- reached through: @netcommon.commonstyle  [in template "login.ftl" at line 5, column 9]\n----\n\n\nçæçjsonä¸²æ¯ä¸æ ·çï¼\n\n\n\nä½æ¯æè¿æ²¡æ¾å°åå ã\n\nåèæç« ï¼\n\n[[freemarker error] failed to "?eval" string]',charsets:{cjk:!0},lastUpdated:"2023/11/09, 20:11:15",lastUpdatedTimestamp:1699531875e3},{title:"mpä½¿ç¨@TableFieldæ³¨è§£æªçæåèæ¥é",frontmatter:{title:"mpä½¿ç¨@TableFieldæ³¨è§£æªçæåèæ¥é",date:"2023-11-09T13:17:31.000Z",permalink:"/pages/0e629c/"},regularPath:"/02.%E6%96%87%E7%AB%A0/200.%E8%B8%A9%E5%9D%91/30.mp%E4%BD%BF%E7%94%A8@TableField%E6%B3%A8%E8%A7%A3%E6%9C%AA%E7%94%9F%E6%95%88%E5%8F%8D%E8%80%8C%E6%8A%A5%E9%94%99.html",relativePath:"02.æç« /200.è¸©å/30.mpä½¿ç¨@TableFieldæ³¨è§£æªçæåèæ¥é.md",key:"v-54af3d7f",path:"/pages/0e629c/",headersStr:null,content:"å¨ä½¿ç¨MybatisPlusç@TableFieldæ³¨è§£æå®å­æ®µæ¶ï¼æçä»£ç æ¯è¿æ ·åçï¼\n\n\n\næ¥éå¦ä¸ï¼\n\n\n\nè¡¨å¦ä¸ï¼\n\n\n\néè¯¯åå  ï¼å¨åæ¶ä½¿ç¨@TableFieldå@TableIdæ¶ï¼ä¸¤ä¸ªæ³¨è§£ä¸­é½éè¦æå®å­æ®µå",normalizedContent:"å¨ä½¿ç¨mybatisplusç@tablefieldæ³¨è§£æå®å­æ®µæ¶ï¼æçä»£ç æ¯è¿æ ·åçï¼\n\n\n\næ¥éå¦ä¸ï¼\n\n\n\nè¡¨å¦ä¸ï¼\n\n\n\néè¯¯åå  ï¼å¨åæ¶ä½¿ç¨@tablefieldå@tableidæ¶ï¼ä¸¤ä¸ªæ³¨è§£ä¸­é½éè¦æå®å­æ®µå",charsets:{cjk:!0},lastUpdated:"2023/11/09, 20:11:15",lastUpdatedTimestamp:1699531875e3},{title:"å¼åè§è",frontmatter:{title:"å¼åè§è",date:"2023-06-22T10:38:58.000Z",permalink:"/pages/99f624/"},regularPath:"/02.%E6%96%87%E7%AB%A0/1000.%E5%AE%9E%E4%B9%A0%E5%B0%8F%E7%BB%93/150.%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html",relativePath:"02.æç« /1000.å®ä¹ å°ç»/150.å¼åè§è.md",key:"v-5b394e2a",path:"/pages/99f624/",headersStr:null,content:"# å¼åè§è\n\nåä¸ç¯ç¬è®°è®°å½ä¸ä¸å¬å¸çå¼åè§èï¼ä»¥åä»¥åè¸©åð¥²\n\n 1.  é¿åä½¿ç¨é­æ³å¼ï¼èæ¯ä½¿ç¨æä¸¾ç±»æèéæå¸¸é\n 2.  éå¯¹ä¸åçå¼å¸¸è¦ä½¿ç¨ä¸åç catch è¯­å¥ï¼ç¦æ­¢ä»»ä½å¼å¸¸é½ä½¿ç¨Exceptionæè·\n 3.  ä½¿ç¨try{}catch{}æè·å¼å¸¸åï¼å¿é¡»è®°å½æ¥å¿ï¼ç¦æ­¢ä½¿ç¨System.out.println()ãprintStackTraceæå°æ¥å¿ã\n 4.  é¿åä½¿ç¨ä¸å±åä»¥ä¸çif/elseåµå¥ï¼å¯ä»¥ä½¿ç¨å«è¯­å¥ãç­ç¥æ¨¡å¼å®ç°\n 5.  è®¾è®¡äºå¤æçæ¹æ³/ä½¿ç¨äºå·§å¦è®¾è®¡çæ¹æ³ï¼å¦ä½¿ç¨äºè®¾è®¡æ¨¡å¼ï¼å¿é¡»è¦æ·»å æ³¨é\n 6.  åä¸ªæ¹æ³éå¶é¿åº¦ä¸º200è¡\n 7.  ç¦æ­¢å¨å¾ªç¯ä¸­è°ç¨æ°æ®åº\n 8.  æ½è±¡æ¹æ³ä½¿ç¨javadocæ³¨éï¼åæ¬åæ°ãè¿åå¼ãå¼å¸¸ãæ¹æ³ä»¥åæ¹æ³å®ç°çåè½\n 9.  æ ç¨çä»£ç ç´æ¥å æï¼èä¸æ¯æ³¨é\n 10. ä¸è¦å¨ä»£ç åé¢åæ³¨éï¼å¨ä»£ç ä¸é¢å\n 11. æä»¶èµæºãæ°æ®åºèµæºæèæµå¯¹è±¡ä½¿ç¨åå¿é¡»close\n 12. è®¿é®æ°æ®åºä½¿ç¨é»è®¤å­ç¬¦éï¼ä¸è¦èªå·±æå®å­ç¬¦é\n 13. ä¸è¬æåµä¸ SQLè¿è¡¨ä¸è¶è¿ä¸å¼ ï¼å®å¨ä¸è¡å¯ä»¥åå¼æ¥\n 14. ä¸è¦å¨é¡¹ç®ä¸­ä½¿ç¨SQLéå½ï¼å¶ä»æåµä¸å¯ä»¥ä½¿ç¨ï¼\n 15. ä½¿ç¨å¤çº¿ç¨æ¶å°½éä½¿ç¨ ThreadPoolExecutor æ¥åå»ºçº¿ç¨æ± ï¼è®¾ç½®åççåæ°ï¼é¿åèµæºæµªè´¹ã\n 16. é¿åå¸¸è§çç©ºæéï¼å°½éä½¿ç¨å·¥å·ç±»å¤ç©ºå¦Strings.isEmptyãCollections.emptyListãCollections.emptyMap\n 17. åè£ç±»ä½¿ç¨equalsæ¯è¾ï¼BigDecimalä½¿ç¨compareToæ¯è¾\n 18. redisçkeyè®¾è®¡ååï¼systemName:env:businessGroup:businessKey\n 19. ä¸è¬æåµä¸æ¹æ³çåæ°ä¸è¶è¿5ä¸ªï¼å¤äºæ¨èå°è£ä¸ºå¯¹è±¡ã\n 20. åç«¯æææ¥å£éç¨ç»ä¸çè¿åå®ä½ã\n\nç¬è®°\n\nææ¯å¨å¾ªç¯ä¸­ä½¿ç¨æ°æ®åºæä½è¢«èå¤§æéäº~~",normalizedContent:"# å¼åè§è\n\nåä¸ç¯ç¬è®°è®°å½ä¸ä¸å¬å¸çå¼åè§èï¼ä»¥åä»¥åè¸©åð¥²\n\n 1.  é¿åä½¿ç¨é­æ³å¼ï¼èæ¯ä½¿ç¨æä¸¾ç±»æèéæå¸¸é\n 2.  éå¯¹ä¸åçå¼å¸¸è¦ä½¿ç¨ä¸åç catch è¯­å¥ï¼ç¦æ­¢ä»»ä½å¼å¸¸é½ä½¿ç¨exceptionæè·\n 3.  ä½¿ç¨try{}catch{}æè·å¼å¸¸åï¼å¿é¡»è®°å½æ¥å¿ï¼ç¦æ­¢ä½¿ç¨system.out.println()ãprintstacktraceæå°æ¥å¿ã\n 4.  é¿åä½¿ç¨ä¸å±åä»¥ä¸çif/elseåµå¥ï¼å¯ä»¥ä½¿ç¨å«è¯­å¥ãç­ç¥æ¨¡å¼å®ç°\n 5.  è®¾è®¡äºå¤æçæ¹æ³/ä½¿ç¨äºå·§å¦è®¾è®¡çæ¹æ³ï¼å¦ä½¿ç¨äºè®¾è®¡æ¨¡å¼ï¼å¿é¡»è¦æ·»å æ³¨é\n 6.  åä¸ªæ¹æ³éå¶é¿åº¦ä¸º200è¡\n 7.  ç¦æ­¢å¨å¾ªç¯ä¸­è°ç¨æ°æ®åº\n 8.  æ½è±¡æ¹æ³ä½¿ç¨javadocæ³¨éï¼åæ¬åæ°ãè¿åå¼ãå¼å¸¸ãæ¹æ³ä»¥åæ¹æ³å®ç°çåè½\n 9.  æ ç¨çä»£ç ç´æ¥å æï¼èä¸æ¯æ³¨é\n 10. ä¸è¦å¨ä»£ç åé¢åæ³¨éï¼å¨ä»£ç ä¸é¢å\n 11. æä»¶èµæºãæ°æ®åºèµæºæèæµå¯¹è±¡ä½¿ç¨åå¿é¡»close\n 12. è®¿é®æ°æ®åºä½¿ç¨é»è®¤å­ç¬¦éï¼ä¸è¦èªå·±æå®å­ç¬¦é\n 13. ä¸è¬æåµä¸ sqlè¿è¡¨ä¸è¶è¿ä¸å¼ ï¼å®å¨ä¸è¡å¯ä»¥åå¼æ¥\n 14. ä¸è¦å¨é¡¹ç®ä¸­ä½¿ç¨sqléå½ï¼å¶ä»æåµä¸å¯ä»¥ä½¿ç¨ï¼\n 15. ä½¿ç¨å¤çº¿ç¨æ¶å°½éä½¿ç¨ threadpoolexecutor æ¥åå»ºçº¿ç¨æ± ï¼è®¾ç½®åççåæ°ï¼é¿åèµæºæµªè´¹ã\n 16. é¿åå¸¸è§çç©ºæéï¼å°½éä½¿ç¨å·¥å·ç±»å¤ç©ºå¦strings.isemptyãcollections.emptylistãcollections.emptymap\n 17. åè£ç±»ä½¿ç¨equalsæ¯è¾ï¼bigdecimalä½¿ç¨comparetoæ¯è¾\n 18. redisçkeyè®¾è®¡ååï¼systemname:env:businessgroup:businesskey\n 19. ä¸è¬æåµä¸æ¹æ³çåæ°ä¸è¶è¿5ä¸ªï¼å¤äºæ¨èå°è£ä¸ºå¯¹è±¡ã\n 20. åç«¯æææ¥å£éç¨ç»ä¸çè¿åå®ä½ã\n\nç¬è®°\n\nææ¯å¨å¾ªç¯ä¸­ä½¿ç¨æ°æ®åºæä½è¢«èå¤§æéäº~~",charsets:{cjk:!0},lastUpdated:"2023/06/22, 14:29:37",lastUpdatedTimestamp:1687415377e3},{title:"ä½¿ç¨@Validatedæ³¨è§£è¿è¡åæ°æ ¡éªæ¶æ¥éï¼UnexpectedTypeException",frontmatter:{title:"ä½¿ç¨@Validatedæ³¨è§£è¿è¡åæ°æ ¡éªæ¶æ¥éï¼UnexpectedTypeException",date:"2023-11-09T13:20:32.000Z",permalink:"/pages/e96a9e/"},regularPath:"/02.%E6%96%87%E7%AB%A0/200.%E8%B8%A9%E5%9D%91/40.%E4%BD%BF%E7%94%A8@Validated%E6%B3%A8%E8%A7%A3%E8%BF%9B%E8%A1%8C%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E6%97%B6%E6%8A%A5%E9%94%99%EF%BC%9AUnexpectedTypeException.html",relativePath:"02.æç« /200.è¸©å/40.ä½¿ç¨@Validatedæ³¨è§£è¿è¡åæ°æ ¡éªæ¶æ¥éï¼UnexpectedTypeException.md",key:"v-f080616e",path:"/pages/e96a9e/",headersStr:null,content:"èµ·å æ¯ä½¿ç¨ @Validated æ³¨è§£å¯¹ä¸ä¸ªå¯¹è±¡è¿è¡åæ°æ ¡éªï¼è®¾æ³çæ¯åºç°MethodArgumentNotValidExceptionè¿ä¸ªå¼å¸¸ï¼ä½æ¯åºç°äºUnexpectedTypeExeptionå¼å¸¸ã\n\nåå æ¯è¿ä¸ªå¯¹è±¡éæå­æ®µä¸º intãfloatç±»åï¼å¹¶ä¸æä½¿ç¨äº @NotEmptyå¯¹å¶æ ¡éªãä¸è½è¿æ ·ï¼å¯¹äºåºæ¬æ°æ®ç±»åï¼è¦ä½¿ç¨@NotNullã\n\næ³¨è§£          ç¨å¤\n@NotEmpty   å¯¹æ°ç»ãéåè¿è¡æ ¡éªï¼å¤æ­æ¯å¦ä¸ºç©º\n@NotNull    å¯¹åºæ¬æ°æ®ç±»å intãfloatãdoubleä»¥åä»ä»¬çåè£ç±»å¤æ­ä¸è½ä¸ºç©º\n@NotBlank   å¯¹å­ç¬¦ä¸²å¤æ­æ¯å¦ä¸ºç©º",normalizedContent:"èµ·å æ¯ä½¿ç¨ @validated æ³¨è§£å¯¹ä¸ä¸ªå¯¹è±¡è¿è¡åæ°æ ¡éªï¼è®¾æ³çæ¯åºç°methodargumentnotvalidexceptionè¿ä¸ªå¼å¸¸ï¼ä½æ¯åºç°äºunexpectedtypeexeptionå¼å¸¸ã\n\nåå æ¯è¿ä¸ªå¯¹è±¡éæå­æ®µä¸º intãfloatç±»åï¼å¹¶ä¸æä½¿ç¨äº @notemptyå¯¹å¶æ ¡éªãä¸è½è¿æ ·ï¼å¯¹äºåºæ¬æ°æ®ç±»åï¼è¦ä½¿ç¨@notnullã\n\næ³¨è§£          ç¨å¤\n@notempty   å¯¹æ°ç»ãéåè¿è¡æ ¡éªï¼å¤æ­æ¯å¦ä¸ºç©º\n@notnull    å¯¹åºæ¬æ°æ®ç±»å intãfloatãdoubleä»¥åä»ä»¬çåè£ç±»å¤æ­ä¸è½ä¸ºç©º\n@notblank   å¯¹å­ç¬¦ä¸²å¤æ­æ¯å¦ä¸ºç©º",charsets:{cjk:!0},lastUpdated:"2023/11/09, 20:11:15",lastUpdatedTimestamp:1699531875e3},{title:"connection.setReadTimeout",frontmatter:{title:"connection.setReadTimeout",date:"2023-11-09T13:25:08.000Z",permalink:"/pages/4e379b/"},regularPath:"/02.%E6%96%87%E7%AB%A0/200.%E8%B8%A9%E5%9D%91/50.connection.setReadTimeout.html",relativePath:"02.æç« /200.è¸©å/50.connection.setReadTimeout.md",key:"v-e594d938",path:"/pages/4e379b/",headersStr:null,content:"åé HTTP è¯·æ±æ¶æä¸ä¸ªå±æ§æ¯è¿æ ·çï¼\n\nconnection.setReadTimeout(long timestamp)\n\n\nä¹åæä»¥ä¸ºè¿ä¸ª readTimeout å±æ§æ¯è¯·æ±ååºå»ç´å°æ¶å°ååºçæ¶é´ï¼å¨å®è·µä¹ååç°ä¸æ¯è¿æ ·çã\n\næ­£ç¡®è§£éï¼\n\nconnectTimeout : è¿æ¥è¶æ¶æ¶é´ï¼tcpè¦å»ºç«è¿æ¥ï¼å¦æå»ºç«è¿æ¥çæ¶é´è¶è¿è¿ä¸ªå°±ä¼æå¼å¸¸\nreadTimeout : æ°æ®å¨ç®¡éä¸­çä¼ è¾æ¶é´ï¼æ¥æ¶æ¹å¨æ¶å°è¿ä¸ªæ¶æ¯ä¹åå°±ä¸åè®¡ç®äº\n",normalizedContent:"åé http è¯·æ±æ¶æä¸ä¸ªå±æ§æ¯è¿æ ·çï¼\n\nconnection.setreadtimeout(long timestamp)\n\n\nä¹åæä»¥ä¸ºè¿ä¸ª readtimeout å±æ§æ¯è¯·æ±ååºå»ç´å°æ¶å°ååºçæ¶é´ï¼å¨å®è·µä¹ååç°ä¸æ¯è¿æ ·çã\n\næ­£ç¡®è§£éï¼\n\nconnecttimeout : è¿æ¥è¶æ¶æ¶é´ï¼tcpè¦å»ºç«è¿æ¥ï¼å¦æå»ºç«è¿æ¥çæ¶é´è¶è¿è¿ä¸ªå°±ä¼æå¼å¸¸\nreadtimeout : æ°æ®å¨ç®¡éä¸­çä¼ è¾æ¶é´ï¼æ¥æ¶æ¹å¨æ¶å°è¿ä¸ªæ¶æ¯ä¹åå°±ä¸åè®¡ç®äº\n",charsets:{cjk:!0},lastUpdated:"2023/11/09, 20:11:15",lastUpdatedTimestamp:1699531875e3},{title:"ç¨æ·æååæ ¸æ",frontmatter:{title:"ç¨æ·æååæ ¸æ",date:"2023-08-02T01:05:40.000Z",permalink:"/pages/c6965c/"},regularPath:"/02.%E6%96%87%E7%AB%A0/60.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/10.%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81.html",relativePath:"02.æç« /60.æä½ç³»ç»/10.ç¨æ·æååæ ¸æ.md",key:"v-619d565d",path:"/pages/c6965c/",headers:[{level:2,title:"1. ä»ä¹æ¯ç¨æ·æååæ ¸æ",slug:"_1-ä»ä¹æ¯ç¨æ·æååæ ¸æ",normalizedTitle:"1. ä»ä¹æ¯ç¨æ·æååæ ¸æ",charIndex:2},{level:2,title:"2. ä¸ºä»ä¹è¦åºåç¨æ·æååæ ¸æ",slug:"_2-ä¸ºä»ä¹è¦åºåç¨æ·æååæ ¸æ",normalizedTitle:"2. ä¸ºä»ä¹è¦åºåç¨æ·æååæ ¸æ",charIndex:971},{level:2,title:"3. ä»ä¹æ¯ç³»ç»è°ç¨",slug:"_3-ä»ä¹æ¯ç³»ç»è°ç¨",normalizedTitle:"3. ä»ä¹æ¯ç³»ç»è°ç¨",charIndex:1282}],headersStr:"1. ä»ä¹æ¯ç¨æ·æååæ ¸æ 2. ä¸ºä»ä¹è¦åºåç¨æ·æååæ ¸æ 3. ä»ä¹æ¯ç³»ç»è°ç¨",content:"# 1. ä»ä¹æ¯ç¨æ·æååæ ¸æ\n\næ ¹æ®è¿ç¨è®¿é®èµæºçç¹ç¹ï¼å¯ä»¥æè¿ç¨å¨ç³»ç»çè¿è¡åä¸ºä¸¤ä¸ªçº§å« ï¼ç¨æ·æãåæ ¸æã\n\n 1. ç¨æ·æï¼User Modeï¼ ï¼ç¨æ·æçº§è¿ç¨å¯ä»¥ç´æ¥è¯»åç¨æ·ç¨åºçæ°æ®ï¼æ¥æè¾ä½çæéã\n    \n    å½åºç¨ç¨åºéè¦æ§è¡æäºç¹æ®æéçæä½ï¼ä¾å¦è¯»åç£çãç½ç»éä¿¡ç­ï¼å°±éè¦åæä½ç³»ç»åèµ·ç³»ç»è°ç¨è¯·æ±ï¼å¹¶è¿å¥åæ ¸æã\n\n 2. åæ ¸æï¼Kernel Modeï¼ï¼åæ ¸æè¿è¡çè¿ç¨å ä¹å¯ä»¥è®¿é®è®¡ç®æºçä»»ä½èµæºï¼åæ¬ç³»ç»çåå­ç©ºé´ãè®¾å¤ãé©±å¨ç¨åºç­ï¼ä¸åéå¶ï¼æ¥æéå¸¸é«çæéã\n    \n    å½æä½ç³»ç»æ¥æ¶å°è¿ç¨çç³»ç»è°ç¨è¯·æ±æ¶ï¼å°±ä¼ä»ç¨æ·æåæ¢å°åæ ¸æï¼æ§è¡ç¸åºçç³»ç»è°ç¨ï¼å¹¶å°ç»æè¿åç»è¿ç¨ï¼æååä»åæ ¸æåæ¢åç¨æ·æã\n\nä»ä¹æ¶åä¼åèµ·ç³»ç»è°ç¨ï¼åºç¨ç¨åºæ³è¦è®¿é®ç³»ç»èµæºæ¶ï¼ä¾å¦è¯»åæä»¶ãåéåå­....\n\nåæ¬¡å¼ºè°ï¼æä»¬å¹³æ¶è¿è¡çåºç¨ç¨åºæ¯å¨ç¨æ·ç©ºé´ä¸­çï¼åªæå½åºç°åå­åéãæä»¶æä½ç­æä½æ¶ æä¼åæ¢ä¸ºåæ ¸ç©ºé´ï¼å¹¶ä¸ç¨æ·ç©ºé´æ¯æ æ³è®¿é®è¿äºèµæºçï¼ç¨æ·è¿ç¨æ³è¦è®¿é®ç³»ç»èµæºå°±å¿é¡»è¦ è¿è¡ç³»ç»è°ç¨ä»ç¨æ·ç©ºé´åæ¢å°åæ ¸ç©ºé´ã\n\n\n\nåæ ¸æç¸æ¯äºç¨æ·ææ¥ææ´é«çæéï¼å æ­¤è½å¤æ§è¡æ´åºå±ãæ´ææçæä½ãä¸è¿ï¼ç±äºè¿å¥åæ ¸æéè¦ä»åºè¾é«çå¼éï¼ä¸ç³»åä¸ä¸æåæ¢åæéæ£æ¥ï¼ï¼åºè¯¥å°½éåå°ç¨æ·æä¸åæ ¸æåæ¢çæ¬¡æ°ä»¥æé«ç³»ç»çæ§è½åç¨³å®æ§ã\n\nç¨æ·æååæ ¸æä¹é´å¦ä½åæ¢ ï¼\n\næä¸ç§æ¹å¼å¯ä»¥å°ç¨æ·æåæ¢ä¸ºåæ ¸æ ï¼ç³»ç»è°ç¨ãä¸­æ­ãå¼å¸¸ã\n\n 1. ç³»ç»è°ç¨ ï¼ç¨æ·æä¸»å¨è¦æ±åæ¢ä¸ºåæ ¸æï¼ä¸»è¦æ¯ä¸ºäºä½¿ç¨åæ ¸ææè½åçäºãç³»ç»è°ç¨çæºå¶æ ¸å¿è¿æ¯ä½¿ç¨äºæä½ç³»ç»ä¸ºç¨æ·ç¹å«å¼æ¾çä¸ä¸ªä¸­æ­æ¥å®ç°ã\n\n 2. ä¸­æ­ ï¼å½å¤å´è®¾å¤å®æç¨æ·è¯·æ±çæä½åï¼ä¼åCPUååºç¸åºçä¸­æ­ä¿¡å·ï¼è¿æ¶CPUä¼æåæ§è¡ä¸ä¸æ¡æä»¤èå»æ§è¡ä¸ä¸­æ­ä¿¡å·å¯¹åºçå¤çç¨åºã\n    \n    å¦æååæ§è¡çæä»¤æ¯ç¨æ·æä¸çç¨åºå¹¶ä¸ä¸­æ­ä¿¡å·å¯¹åºçå¤çç¨åºæ¯åæ ¸æï¼é£ä¹è¿ä¸ªè½¬æ¢çè¿ç¨èªç¶ä¹å°±åçäºç¨æ·æå°åæ ¸æçåæ¢ãæ¯å¦ç¡¬çè¯»åæä½å®æï¼ç³»ç»ä¼åæ¢å°ç¡¬çè¯»åçä¸­æ­å¤çç¨åºä¸­æ§è¡åç»­é»è¾ã\n\n 3. å¼å¸¸ ï¼å½CPUå¨æ§è¡ç¨æ·æä¸çç¨åºæ¶ï¼åçäºå¼å¸¸ï¼è¿æ¶ä¼è§¦åç±å½åè¿è¡è¿ç¨åæ¢å°å¤çæ­¤å¼å¸¸çåæ ¸ç¸å³ç¨åºä¸­ï¼ä¹å°±è½¬å°äºåæ ¸æï¼æ¯å¦ç¼ºé¡µå¼å¸¸ã\n\n\n# 2. ä¸ºä»ä¹è¦åºåç¨æ·æååæ ¸æ\n\n 1. å¨CPUçæææä»¤ä¸­ï¼æä¸äºæ§è¡æ¯æ¯è¾å±é©çï¼æ¯å¦åå­åéãè®¾ç½®æ¶éãæä»¶IOå¤ç ç­ï¼å¦æææç¨åºé½è½ä½¿ç¨è¿äºæä»¤ï¼ä¼å¯¹ç³»ç»çæ­£å¸¸è¿è¡é æç¾é¾æ§çå½±åãå æ­¤ï¼æä»¬éè¦éå¶è¿äºå±é©æä»¤åªè½å¨åæ ¸æè¿è¡ãè¿äºåªè½ç±æä½ç³»ç»åæ ¸ææ§è¡çæä»¤ä¹è¢«å«åç¹ææä»¤ã\n 2. å¦æè®¡ç®æºä¸­åªæä¸ä¸ªåæ ¸æï¼é£ä¹ææç¨åºæè¿ç¨é½å¿é¡»å±äº«ç³»ç»èµæºï¼ä¾å¦åå­ãCPUãç¡¬çç­ï¼è¿å°å¯¼è´ç³»ç»èµæºçç«äºåå²çªï¼ä»èå½±åç³»ç»æ§è½åæçãå¹¶ä¸ï¼è¿æ ·ä¹ä¼è®©ç³»ç»çå®å¨æ§éä½ï¼æ¯ç«ææç¨åºæè¿ç¨é½æç¸åçç¹æçº§å«åè®¿é®æéã\n\nå æ­¤ï¼åæ¶å·æç¨æ·æååæ ¸æä¸»è¦æ¯ä¸ºäºè®¡ç®æºç³»ç»çå®å¨æ§ãç¨³å®æ§åæ§è½ã\n\n\n# 3. ä»ä¹æ¯ç³»ç»è°ç¨\n\nåæä¸ç´å¨è¯´âåªæç»è¿ç³»ç»è°ç¨ï¼è¿ç¨æä¼ä»ç¨æ·æåæ¢ä¸ºåæ ¸æâï¼é£ä¹ä»ä¹æ¯ç³»ç»è°ç¨å¢ï¼å¸¸ç¨çåæåªäºç³»ç»è°ç¨å¢ï¼\n\nç³»ç»è°ç¨å¤§è´å¯ä»¥åä¸ºä»¥ä¸å ç±»ï¼\n\n 1. è®¾å¤ç®¡ç ï¼å®æè®¾å¤ï¼è¾å¥è¾åºè®¾å¤åå¤é¨å­å¨è®¾å¤ï¼çè¯·æ±æéæ¾ãè®¾å¤å¯å¨ç­ã\n 2. æä»¶ç®¡ç ï¼æä»¶çè¯»åãåå»ºãå é¤\n 3. è¿ç¨ç®¡ç ï¼è¿ç¨çåå»ºãæ¤éãé»å¡ãå¤éãè¿ç¨ä¹é´çéä¿¡\n 4. åå­ç®¡ç ï¼åå­ååéãåæ¶ãè·ååå­å°åç­ã\n\nç³»ç»è°ç¨æ¯åºç¨ç¨åºä¸æä½ç³»ç»ä¹é´è¿è¡äº¤äºçä¸ç§æ¹å¼ï¼éè¿ç³»ç»è°ç¨ï¼åºç¨ç¨åºå¯ä»¥è®¿é®æä½ç³»ç»åºå±èµæºï¼å¦æä»¶ãè®¾å¤ãç½ç»ç­ã\n\nç³»ç»è°ç¨çè¿ç¨ ï¼\n\n 1. ç¨æ·æåèµ·ç³»ç»è°ç¨ï¼å ä¸ºç³»ç»è°ç¨ä¸­æ¶åä¸äºç¹ææä»¤ï¼åªè½ç±æä½ç³»ç»åæ ¸ææ§è¡çæä»¤ï¼ï¼ç¨æ·æç¨åºæéä¸è¶³ï¼å æ­¤ä¼ä¸­æ­æ§è¡ï¼ä¹å°±æ¯ Trapï¼Trapæ¯ä¸ç§ä¸­æ­ï¼\n 2. åçä¸­æ­åï¼å½åCPUæ§è¡çç¨åºä¼ä¸­æ­ï¼è·³è½¬å°ä¸­æ­å¤çç¨åºãåæ ¸ç¨åºå¼å§æ§è¡ï¼ä¹å°±æ¯å¼å§å¤çç³»ç»è°ç¨ã\n 3. åæ ¸å¤çå®æåï¼ä¸»å¨è§¦å Trapï¼è¿æ ·ä¼åæ¬¡åçä¸­æ­ï¼åæ¢åç¨æ·æã\n\nå¸¸ç¨çç³»ç»è°ç¨ï¼æä»¶æä½ï¼ä¾å¦readãwrite",normalizedContent:"# 1. ä»ä¹æ¯ç¨æ·æååæ ¸æ\n\næ ¹æ®è¿ç¨è®¿é®èµæºçç¹ç¹ï¼å¯ä»¥æè¿ç¨å¨ç³»ç»çè¿è¡åä¸ºä¸¤ä¸ªçº§å« ï¼ç¨æ·æãåæ ¸æã\n\n 1. ç¨æ·æï¼user modeï¼ ï¼ç¨æ·æçº§è¿ç¨å¯ä»¥ç´æ¥è¯»åç¨æ·ç¨åºçæ°æ®ï¼æ¥æè¾ä½çæéã\n    \n    å½åºç¨ç¨åºéè¦æ§è¡æäºç¹æ®æéçæä½ï¼ä¾å¦è¯»åç£çãç½ç»éä¿¡ç­ï¼å°±éè¦åæä½ç³»ç»åèµ·ç³»ç»è°ç¨è¯·æ±ï¼å¹¶è¿å¥åæ ¸æã\n\n 2. åæ ¸æï¼kernel modeï¼ï¼åæ ¸æè¿è¡çè¿ç¨å ä¹å¯ä»¥è®¿é®è®¡ç®æºçä»»ä½èµæºï¼åæ¬ç³»ç»çåå­ç©ºé´ãè®¾å¤ãé©±å¨ç¨åºç­ï¼ä¸åéå¶ï¼æ¥æéå¸¸é«çæéã\n    \n    å½æä½ç³»ç»æ¥æ¶å°è¿ç¨çç³»ç»è°ç¨è¯·æ±æ¶ï¼å°±ä¼ä»ç¨æ·æåæ¢å°åæ ¸æï¼æ§è¡ç¸åºçç³»ç»è°ç¨ï¼å¹¶å°ç»æè¿åç»è¿ç¨ï¼æååä»åæ ¸æåæ¢åç¨æ·æã\n\nä»ä¹æ¶åä¼åèµ·ç³»ç»è°ç¨ï¼åºç¨ç¨åºæ³è¦è®¿é®ç³»ç»èµæºæ¶ï¼ä¾å¦è¯»åæä»¶ãåéåå­....\n\nåæ¬¡å¼ºè°ï¼æä»¬å¹³æ¶è¿è¡çåºç¨ç¨åºæ¯å¨ç¨æ·ç©ºé´ä¸­çï¼åªæå½åºç°åå­åéãæä»¶æä½ç­æä½æ¶ æä¼åæ¢ä¸ºåæ ¸ç©ºé´ï¼å¹¶ä¸ç¨æ·ç©ºé´æ¯æ æ³è®¿é®è¿äºèµæºçï¼ç¨æ·è¿ç¨æ³è¦è®¿é®ç³»ç»èµæºå°±å¿é¡»è¦ è¿è¡ç³»ç»è°ç¨ä»ç¨æ·ç©ºé´åæ¢å°åæ ¸ç©ºé´ã\n\n\n\nåæ ¸æç¸æ¯äºç¨æ·ææ¥ææ´é«çæéï¼å æ­¤è½å¤æ§è¡æ´åºå±ãæ´ææçæä½ãä¸è¿ï¼ç±äºè¿å¥åæ ¸æéè¦ä»åºè¾é«çå¼éï¼ä¸ç³»åä¸ä¸æåæ¢åæéæ£æ¥ï¼ï¼åºè¯¥å°½éåå°ç¨æ·æä¸åæ ¸æåæ¢çæ¬¡æ°ä»¥æé«ç³»ç»çæ§è½åç¨³å®æ§ã\n\nç¨æ·æååæ ¸æä¹é´å¦ä½åæ¢ ï¼\n\næä¸ç§æ¹å¼å¯ä»¥å°ç¨æ·æåæ¢ä¸ºåæ ¸æ ï¼ç³»ç»è°ç¨ãä¸­æ­ãå¼å¸¸ã\n\n 1. ç³»ç»è°ç¨ ï¼ç¨æ·æä¸»å¨è¦æ±åæ¢ä¸ºåæ ¸æï¼ä¸»è¦æ¯ä¸ºäºä½¿ç¨åæ ¸ææè½åçäºãç³»ç»è°ç¨çæºå¶æ ¸å¿è¿æ¯ä½¿ç¨äºæä½ç³»ç»ä¸ºç¨æ·ç¹å«å¼æ¾çä¸ä¸ªä¸­æ­æ¥å®ç°ã\n\n 2. ä¸­æ­ ï¼å½å¤å´è®¾å¤å®æç¨æ·è¯·æ±çæä½åï¼ä¼åcpuååºç¸åºçä¸­æ­ä¿¡å·ï¼è¿æ¶cpuä¼æåæ§è¡ä¸ä¸æ¡æä»¤èå»æ§è¡ä¸ä¸­æ­ä¿¡å·å¯¹åºçå¤çç¨åºã\n    \n    å¦æååæ§è¡çæä»¤æ¯ç¨æ·æä¸çç¨åºå¹¶ä¸ä¸­æ­ä¿¡å·å¯¹åºçå¤çç¨åºæ¯åæ ¸æï¼é£ä¹è¿ä¸ªè½¬æ¢çè¿ç¨èªç¶ä¹å°±åçäºç¨æ·æå°åæ ¸æçåæ¢ãæ¯å¦ç¡¬çè¯»åæä½å®æï¼ç³»ç»ä¼åæ¢å°ç¡¬çè¯»åçä¸­æ­å¤çç¨åºä¸­æ§è¡åç»­é»è¾ã\n\n 3. å¼å¸¸ ï¼å½cpuå¨æ§è¡ç¨æ·æä¸çç¨åºæ¶ï¼åçäºå¼å¸¸ï¼è¿æ¶ä¼è§¦åç±å½åè¿è¡è¿ç¨åæ¢å°å¤çæ­¤å¼å¸¸çåæ ¸ç¸å³ç¨åºä¸­ï¼ä¹å°±è½¬å°äºåæ ¸æï¼æ¯å¦ç¼ºé¡µå¼å¸¸ã\n\n\n# 2. ä¸ºä»ä¹è¦åºåç¨æ·æååæ ¸æ\n\n 1. å¨cpuçæææä»¤ä¸­ï¼æä¸äºæ§è¡æ¯æ¯è¾å±é©çï¼æ¯å¦åå­åéãè®¾ç½®æ¶éãæä»¶ioå¤ç ç­ï¼å¦æææç¨åºé½è½ä½¿ç¨è¿äºæä»¤ï¼ä¼å¯¹ç³»ç»çæ­£å¸¸è¿è¡é æç¾é¾æ§çå½±åãå æ­¤ï¼æä»¬éè¦éå¶è¿äºå±é©æä»¤åªè½å¨åæ ¸æè¿è¡ãè¿äºåªè½ç±æä½ç³»ç»åæ ¸ææ§è¡çæä»¤ä¹è¢«å«åç¹ææä»¤ã\n 2. å¦æè®¡ç®æºä¸­åªæä¸ä¸ªåæ ¸æï¼é£ä¹ææç¨åºæè¿ç¨é½å¿é¡»å±äº«ç³»ç»èµæºï¼ä¾å¦åå­ãcpuãç¡¬çç­ï¼è¿å°å¯¼è´ç³»ç»èµæºçç«äºåå²çªï¼ä»èå½±åç³»ç»æ§è½åæçãå¹¶ä¸ï¼è¿æ ·ä¹ä¼è®©ç³»ç»çå®å¨æ§éä½ï¼æ¯ç«ææç¨åºæè¿ç¨é½æç¸åçç¹æçº§å«åè®¿é®æéã\n\nå æ­¤ï¼åæ¶å·æç¨æ·æååæ ¸æä¸»è¦æ¯ä¸ºäºè®¡ç®æºç³»ç»çå®å¨æ§ãç¨³å®æ§åæ§è½ã\n\n\n# 3. ä»ä¹æ¯ç³»ç»è°ç¨\n\nåæä¸ç´å¨è¯´âåªæç»è¿ç³»ç»è°ç¨ï¼è¿ç¨æä¼ä»ç¨æ·æåæ¢ä¸ºåæ ¸æâï¼é£ä¹ä»ä¹æ¯ç³»ç»è°ç¨å¢ï¼å¸¸ç¨çåæåªäºç³»ç»è°ç¨å¢ï¼\n\nç³»ç»è°ç¨å¤§è´å¯ä»¥åä¸ºä»¥ä¸å ç±»ï¼\n\n 1. è®¾å¤ç®¡ç ï¼å®æè®¾å¤ï¼è¾å¥è¾åºè®¾å¤åå¤é¨å­å¨è®¾å¤ï¼çè¯·æ±æéæ¾ãè®¾å¤å¯å¨ç­ã\n 2. æä»¶ç®¡ç ï¼æä»¶çè¯»åãåå»ºãå é¤\n 3. è¿ç¨ç®¡ç ï¼è¿ç¨çåå»ºãæ¤éãé»å¡ãå¤éãè¿ç¨ä¹é´çéä¿¡\n 4. åå­ç®¡ç ï¼åå­ååéãåæ¶ãè·ååå­å°åç­ã\n\nç³»ç»è°ç¨æ¯åºç¨ç¨åºä¸æä½ç³»ç»ä¹é´è¿è¡äº¤äºçä¸ç§æ¹å¼ï¼éè¿ç³»ç»è°ç¨ï¼åºç¨ç¨åºå¯ä»¥è®¿é®æä½ç³»ç»åºå±èµæºï¼å¦æä»¶ãè®¾å¤ãç½ç»ç­ã\n\nç³»ç»è°ç¨çè¿ç¨ ï¼\n\n 1. ç¨æ·æåèµ·ç³»ç»è°ç¨ï¼å ä¸ºç³»ç»è°ç¨ä¸­æ¶åä¸äºç¹ææä»¤ï¼åªè½ç±æä½ç³»ç»åæ ¸ææ§è¡çæä»¤ï¼ï¼ç¨æ·æç¨åºæéä¸è¶³ï¼å æ­¤ä¼ä¸­æ­æ§è¡ï¼ä¹å°±æ¯ trapï¼trapæ¯ä¸ç§ä¸­æ­ï¼\n 2. åçä¸­æ­åï¼å½åcpuæ§è¡çç¨åºä¼ä¸­æ­ï¼è·³è½¬å°ä¸­æ­å¤çç¨åºãåæ ¸ç¨åºå¼å§æ§è¡ï¼ä¹å°±æ¯å¼å§å¤çç³»ç»è°ç¨ã\n 3. åæ ¸å¤çå®æåï¼ä¸»å¨è§¦å trapï¼è¿æ ·ä¼åæ¬¡åçä¸­æ­ï¼åæ¢åç¨æ·æã\n\nå¸¸ç¨çç³»ç»è°ç¨ï¼æä»¶æä½ï¼ä¾å¦readãwrite",charsets:{cjk:!0},lastUpdated:"2023/08/02, 01:36:29",lastUpdatedTimestamp:1690911389e3},{title:"é¶æ·è´",frontmatter:{title:"é¶æ·è´",date:"2023-08-02T01:14:35.000Z",permalink:"/pages/dbd03e/"},regularPath:"/02.%E6%96%87%E7%AB%A0/60.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/110.%E9%9B%B6%E6%8B%B7%E8%B4%9D.html",relativePath:"02.æç« /60.æä½ç³»ç»/110.é¶æ·è´.md",key:"v-c1afabda",path:"/pages/dbd03e/",headers:[{level:2,title:"0. ç®è¿°",slug:"_0-ç®è¿°",normalizedTitle:"0. ç®è¿°",charIndex:2},{level:2,title:"1. DMA",slug:"_1-dma",normalizedTitle:"1. dma",charIndex:225},{level:2,title:"2. ä¼ è¾æä»¶æ¶åçäºä»ä¹",slug:"_2-ä¼ è¾æä»¶æ¶åçäºä»ä¹",normalizedTitle:"2. ä¼ è¾æä»¶æ¶åçäºä»ä¹",charIndex:512},{level:2,title:"3. é¶æ·è´çå®ç°æ¹å¼",slug:"_3-é¶æ·è´çå®ç°æ¹å¼",normalizedTitle:"3. é¶æ·è´çå®ç°æ¹å¼",charIndex:1430},{level:3,title:"3.1 mmap",slug:"_3-1-mmap",normalizedTitle:"3.1 mmap",charIndex:1499},{level:3,title:"3.2 sendfile",slug:"_3-2-sendfile",normalizedTitle:"3.2 sendfile",charIndex:1815}],headersStr:"0. ç®è¿° 1. DMA 2. ä¼ è¾æä»¶æ¶åçäºä»ä¹ 3. é¶æ·è´çå®ç°æ¹å¼ 3.1 mmap 3.2 sendfile",content:"# 0. ç®è¿°\n\né¶æ·è´è¿ä¸ªä¸è¥¿å®éä¸æä¸æ³æ¾å¨ Javaåºç¡ è¿é¨åè¯´ï¼å ä¸ºä¸¥æ ¼æ¥è¯´å®è®¾è®¡çæä½ç³»ç»ç¥è¯æ¯è¾å¤ï¼ä½æ¯ä¹ä¸æ³æèè¿ä¹å¤äº~\n\nå¦æä½ è¿æ²¡æç¸å³çæä½ç³»ç»ç¥è¯ï¼è¿ç¯æç« ä¸å»ºè®®çå¦~\n\næèå¯ä»¥åçä¸ä¸åç½®çæä½ç³»ç»ç¥è¯ï¼ ç¨æ·æååæ ¸æ ï¼åå«ç¨æ·æåæ ¸æãç³»ç»è°ç¨çç¥è¯ï¼\n\né¶æ·è´è¿ä¸ªææ¯è¿ä¸ªå¾å¤ä¸­é´ä»¶é½æç¨è¿ï¼ä¾å¦RocketMQãnettyã\n\nå¹¶ä¸ç±äºææ¯æ¯æ·è´ï¼æä»¥ä¸æææçç¨æ·æãåæ ¸æä¹é´çåæ¢é½åºäº æä»¶ã\n\n\n# 1. DMA\n\nå¨å¾ä¹ä¹åï¼ç¨æ·æä¸åæ ¸æåæ¢åç æ°æ®è¯»åæä½ æ¯å®å¨ç±CPUè´è´£çã\n\n\n\nè¿ä¸ªè¿ç¨ä¸­CPUæ¯é»å¡çï¼å¦æåªè¯»å ä¸ªå­ç¬¦ä¹å°±ç®äºï¼ä½æ¯å¦æè¦è¯»å ä¸ªGçæä»¶ï¼é£CPUå°±æçåäºã\n\næä»¥å°±åæäº DMA ææ¯\n\nDMA ï¼Direct Memory Accessï¼å¨è¿è¡ I/O è®¾å¤ååå­çæ°æ®ä¼ è¾çæ¶åï¼æ°æ®æ¬è¿çå·¥ä½å¨é¨äº¤ç» DMA æ§å¶å¨ï¼è CPU ä¸ååä¸ä»»ä½ä¸æ°æ®æ¬è¿ç¸å³çäºæï¼è¿æ · CPU å°±å¯ä»¥å»å¤çå«çäºå¡ãå¦å¾ã\n\nä½æ¯ CPU å¨è¿ä¸ªè¿ç¨ä¸­ä¹æ¯å¿ä¸å¯å°çï¼å ä¸ºè¦è¯»åªä¸ªæä»¶ãè¯»å¤å°è¿äºåºæ¬ä¿¡æ¯é½éè¦CPUå»åè¯DMAã\n\n\n\n\n# 2. ä¼ è¾æä»¶æ¶åçäºä»ä¹\n\nå¨è¿è¡æä»¶ä¼ è¾æ¶ä¸è¬ä¼æ¶åä¸¤ä¸ªç³»ç»è°ç¨ ï¼readãwrite\n\nread(file, tmp_buf, len);\nwrite(socket, tmp_buf, len);\n\n\nä¸ä¸ª read() å¯ä»¥åèµ·ç³»ç»è°ç¨ï¼ä½¿è¿ç¨ä»ç¨æ·æåæ¢ä¸ºåæ ¸æï¼æ°æ®åå¤å¥½ååä» åæ ¸æåæ¢å ç¨æ·æãå³ï¼ä¸æ¬¡ç³»ç»è°ç¨ä¼åçä¸¤æ¬¡ä¸ä¸æåæ¢ãï¼ä¸æ¬¡writeåçï¼\n\næä»¶ä¼ è¾è½ç¶åªæä¸¤è¡ä»£ç ï¼ä½å´åäºä¸å°äºæï¼\n\n\n\nä¸å± 2 æ¬¡ç³»ç»è°ç¨ï¼ä¹å°±æ¯ 4 æ¬¡ç¨æ·æä¸åæ ¸æ ä¸ä¸æçåæ¢ãä¸ä¸æåæ¢çææ¬å¾é«ï¼ä¸æ¬¡åæ¢éè¦å åçº³ç§å°å å¾®ç§ãå¶æ¬¡è¿åçäº 4 æ¬¡æ°æ®æ·è´ï¼2æ¬¡DMAæ·è´ + 2æ¬¡CPUæ·è´ï¼\n\nè¿åæ¬¡æ·è´ï¼\n\n 1. ç¬¬ä¸æ¬¡æ·è´ï¼æç£çä¸çæ°æ®æ·è´å°æä½ç³»ç»åæ ¸çç¼å²åºéï¼è¿ä¸ªæ·è´çè¿ç¨æ¯éè¿ DMA æ¬è¿çã\n 2. ç¬¬äºæ¬¡æ·è´ï¼æåæ ¸ç¼å²åºçæ°æ®æ·è´å°ç¨æ·çç¼å²åºéï¼äºæ¯æä»¬åºç¨ç¨åºå°±å¯ä»¥ä½¿ç¨è¿é¨åæ°æ®äºï¼è¿ä¸ªæ·è´å°è¿ç¨æ¯ç± CPU å®æçã\n 3. ç¬¬ä¸æ¬¡æ·è´ï¼æåææ·è´å°ç¨æ·çç¼å²åºéçæ°æ®ï¼åæ·è´å°åæ ¸ç socket çç¼å²åºéï¼è¿ä¸ªè¿ç¨ä¾ç¶è¿æ¯ç± CPU æ¬è¿çã\n 4. ç¬¬åæ¬¡æ·è´ï¼æåæ ¸ç socket ç¼å²åºéçæ°æ®ï¼æ·è´å°ç½å¡çç¼å²åºéï¼è¿ä¸ªè¿ç¨åæ¯ç± DMA æ¬è¿çã\n\nè¿ç§ç®ååä¼ ç»çæä»¶ä¼ è¾æ¹å¼ï¼å­å¨åä½çä¸æåæ¢åæ°æ®æ·è´ï¼å¨é«å¹¶åç³»ç»éæ¯éå¸¸ç³ç³çï¼å¤äºå¾å¤ä¸å¿è¦çå¼éï¼ä¼ä¸¥éå½±åç³»ç»æ§è½ã\n\næä»¥ï¼è¦æ³æé«æä»¶ä¼ è¾çæ§è½ï¼å°±éè¦åå°ãç¨æ·æä¸åæ ¸æçä¸ä¸æåæ¢ãåãæ°æ®æ·è´ãçæ¬¡æ°ã\n\n * åå°ç¨æ·æååæ ¸æçä¸ä¸æåæ¢å°±æ¯ åå°ç³»ç»è°ç¨çæ¬¡æ°\n\n * åå°æ°æ®æ·è´æ¬¡æ° ï¼ãä»åæ ¸çè¯»ç¼å²åºæ·è´å°ç¨æ·çç¼å²åºéï¼åä»ç¨æ·çç¼å²åºéæ·è´å° socket çç¼å²åºéãï¼è¿ä¸ªè¿ç¨æ¯æ²¡æå¿è¦çãå ä¸ºæä»¶ä¼ è¾çåºç¨åºæ¯ä¸­ï¼å¨ç¨æ·ç©ºé´æä»¬å¹¶ä¸ä¼å¯¹æ°æ®ãåå å·¥ãï¼æä»¥æ°æ®å®éä¸å¯ä»¥ä¸ç¨æ¬è¿å°ç¨æ·ç©ºé´ï¼å æ­¤ç¨æ·çç¼å²åºæ¯æ²¡æå¿è¦å­å¨çãæä»¬å¯ä»¥ç´æ¥å°æ°æ®ä»åæ ¸ç¼å²åºæ·è´å°socketç¼å²åº\n\nç°å¨å°±è¦æ­£å¼ä»ç»é¶æ·è´äºï¼é¶æ·è´ä¹æ­£æ¯å®ç°ä¸è¿°æé«æ§è½çå®ç°æ¹æ³ã\n\n\n# 3. é¶æ·è´çå®ç°æ¹å¼\n\né¶æ·è´çå®ç°éå¸¸æä¸¤ç§ ï¼\n\n>  1. mmap + write\n> \n>  2. sendfile\n\n\n# 3.1 mmap\n\né¦åä»ç»ä¸ä¸å¤§åé¼é¼ç mmap + writeã\n\nä¹åè¯´è¿ï¼åå°æ°æ®æ·è´æ¬¡æ°ä¸»è¦æ¯åå° âä»åæ ¸æç¼å²åºæ·è´å°ç¨æ·æç¼å²åºâè¿ä¸æ­¥ï¼æ³è¦æå®å æã\n\nç°å¨ä½¿ç¨ mmap æ¿ä»£ read è¿è¡è¯»æä½\n\nbuf = mmap(file, len);\nwrite(sockfd, buf, len);\n\n\nmmap() ç³»ç»è°ç¨å½æ°ä¼ç´æ¥æåæ ¸ç¼å²åºéçæ°æ®ãæ å°ã(ä¸æ¯æ·è´) å°ç¨æ·ç©ºé´ï¼è¿æ ·ï¼æä½ç³»ç»åæ ¸ä¸ç¨æ·ç©ºé´å°±ä¸éè¦åè¿è¡ä»»ä½çæ°æ®æ·è´æä½ãä¹å¯ä»¥è¯´ç¨æ·æååæ ¸æç°å¨å±äº«ç¼å²åºäºã\n\n\n\nè½ç¶å¯ä»¥åå°ä¸æ¬¡ æ°æ®æ·è´ï¼å¯è¿ä»æ§ä¸æ¯çæ³çé¶æ·è´ï¼æä»¬æç»çç®çæ¯ï¼åå°ç³»ç»è°ç¨å¸¦æ¥çä¸ä¸æåæ¢ã\n\n\n# 3.2 sendfile\n\nåæ¥ä»ç»ä¸ä¸sendfile\n\nssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);\n\n\nè¿ä¸ªsendfileå½æ°æ¯Linuxç¨äºä¸é¨åéæä»¶çå½æ°ï¼ç®çå°±æ¯æ¿ä»£ read + writeã\n\nå®å¯ä»¥æ¿ä»£åé¢ç read() å write() è¿ä¸¤ä¸ªç³»ç»è°ç¨ï¼è¿æ ·å°±å¯ä»¥åå°ä¸æ¬¡ç³»ç»è°ç¨ï¼ä¹å°±åå°äº 2 æ¬¡ä¸ä¸æåæ¢çå¼éã å¶æ¬¡ï¼è¯¥ç³»ç»è°ç¨å¯ä»¥ç´æ¥æåæ ¸ç¼å²åºéçæ°æ®æ·è´å° socket ç¼å²åºéï¼ä¸åæ·è´å°ç¨æ·æãè¿æ ·å°±åªå©ä¸ 2 æ¬¡ä¸ä¸æåæ¢ï¼å 3 æ¬¡æ°æ®æ·è´ã å¦ä¸å¾ï¼\n\n\n\nå½ç¶ï¼è¿è¿ä¸æ¯å®ç¾çé¶æ·è´ææ¯ï¼å¦æç½å¡æ¯æ scatter-gather ç¹æ§ï¼é£ä¹sendfileå¯ä»¥ä¸éè¦ç¬¬äºé¨çCPUæ·è´åç¬¬ä¸æ­¥çDMAæ·è´ï¼ç´æ¥å°æ°æ®ä»åæ ¸ç¼å²åºåéå°ç½å¡ã è¿è¢«ç§°ä¸º SG-DMAæ·è´ã\n\n\n\né£ä¹ä¼åå°ç°å¨ï¼åå°äº 2 æ¬¡ä¸ä¸æåæ¢åæ°æ®æ·è´æ¬¡æ°ï¼åªéè¦ 2 æ¬¡ä¸ä¸æåæ¢åæ°æ®æ·è´æ¬¡æ°ï¼å°±å¯ä»¥å®ææä»¶çä¼ è¾ï¼èä¸ 2 æ¬¡çæ°æ®æ·è´è¿ç¨ï¼é½ä¸éè¦éè¿ CPUï¼2 æ¬¡é½æ¯ç± DMA æ¥æ¬è¿ã\n\næä»¥ï¼æ»ä½æ¥çï¼é¶æ·è´ææ¯å¯ä»¥ææä»¶ä¼ è¾çæ§è½æé«è³å°ä¸åä»¥ä¸ã\n\nèå¨Javaä¸­ï¼MappedByteBufferå°±è°ç¨äºmmapï¼transferTo/transferFromå°±æ¯sendfileæ¹æ³ã\n\nå¦ææ¶åå°æä»¶ä¼ è¾ï¼transferToæ¯é¦éï¼ä½æ¯å¦ææ¶åå°å¯¹åå­æ°æ®çä¿®æ¹éç¨MappedByteBufferã",normalizedContent:"# 0. ç®è¿°\n\né¶æ·è´è¿ä¸ªä¸è¥¿å®éä¸æä¸æ³æ¾å¨ javaåºç¡ è¿é¨åè¯´ï¼å ä¸ºä¸¥æ ¼æ¥è¯´å®è®¾è®¡çæä½ç³»ç»ç¥è¯æ¯è¾å¤ï¼ä½æ¯ä¹ä¸æ³æèè¿ä¹å¤äº~\n\nå¦æä½ è¿æ²¡æç¸å³çæä½ç³»ç»ç¥è¯ï¼è¿ç¯æç« ä¸å»ºè®®çå¦~\n\næèå¯ä»¥åçä¸ä¸åç½®çæä½ç³»ç»ç¥è¯ï¼ ç¨æ·æååæ ¸æ ï¼åå«ç¨æ·æåæ ¸æãç³»ç»è°ç¨çç¥è¯ï¼\n\né¶æ·è´è¿ä¸ªææ¯è¿ä¸ªå¾å¤ä¸­é´ä»¶é½æç¨è¿ï¼ä¾å¦rocketmqãnettyã\n\nå¹¶ä¸ç±äºææ¯æ¯æ·è´ï¼æä»¥ä¸æææçç¨æ·æãåæ ¸æä¹é´çåæ¢é½åºäº æä»¶ã\n\n\n# 1. dma\n\nå¨å¾ä¹ä¹åï¼ç¨æ·æä¸åæ ¸æåæ¢åç æ°æ®è¯»åæä½ æ¯å®å¨ç±cpuè´è´£çã\n\n\n\nè¿ä¸ªè¿ç¨ä¸­cpuæ¯é»å¡çï¼å¦æåªè¯»å ä¸ªå­ç¬¦ä¹å°±ç®äºï¼ä½æ¯å¦æè¦è¯»å ä¸ªgçæä»¶ï¼é£cpuå°±æçåäºã\n\næä»¥å°±åæäº dma ææ¯\n\ndma ï¼direct memory accessï¼å¨è¿è¡ i/o è®¾å¤ååå­çæ°æ®ä¼ è¾çæ¶åï¼æ°æ®æ¬è¿çå·¥ä½å¨é¨äº¤ç» dma æ§å¶å¨ï¼è cpu ä¸ååä¸ä»»ä½ä¸æ°æ®æ¬è¿ç¸å³çäºæï¼è¿æ · cpu å°±å¯ä»¥å»å¤çå«çäºå¡ãå¦å¾ã\n\nä½æ¯ cpu å¨è¿ä¸ªè¿ç¨ä¸­ä¹æ¯å¿ä¸å¯å°çï¼å ä¸ºè¦è¯»åªä¸ªæä»¶ãè¯»å¤å°è¿äºåºæ¬ä¿¡æ¯é½éè¦cpuå»åè¯dmaã\n\n\n\n\n# 2. ä¼ è¾æä»¶æ¶åçäºä»ä¹\n\nå¨è¿è¡æä»¶ä¼ è¾æ¶ä¸è¬ä¼æ¶åä¸¤ä¸ªç³»ç»è°ç¨ ï¼readãwrite\n\nread(file, tmp_buf, len);\nwrite(socket, tmp_buf, len);\n\n\nä¸ä¸ª read() å¯ä»¥åèµ·ç³»ç»è°ç¨ï¼ä½¿è¿ç¨ä»ç¨æ·æåæ¢ä¸ºåæ ¸æï¼æ°æ®åå¤å¥½ååä» åæ ¸æåæ¢å ç¨æ·æãå³ï¼ä¸æ¬¡ç³»ç»è°ç¨ä¼åçä¸¤æ¬¡ä¸ä¸æåæ¢ãï¼ä¸æ¬¡writeåçï¼\n\næä»¶ä¼ è¾è½ç¶åªæä¸¤è¡ä»£ç ï¼ä½å´åäºä¸å°äºæï¼\n\n\n\nä¸å± 2 æ¬¡ç³»ç»è°ç¨ï¼ä¹å°±æ¯ 4 æ¬¡ç¨æ·æä¸åæ ¸æ ä¸ä¸æçåæ¢ãä¸ä¸æåæ¢çææ¬å¾é«ï¼ä¸æ¬¡åæ¢éè¦å åçº³ç§å°å å¾®ç§ãå¶æ¬¡è¿åçäº 4 æ¬¡æ°æ®æ·è´ï¼2æ¬¡dmaæ·è´ + 2æ¬¡cpuæ·è´ï¼\n\nè¿åæ¬¡æ·è´ï¼\n\n 1. ç¬¬ä¸æ¬¡æ·è´ï¼æç£çä¸çæ°æ®æ·è´å°æä½ç³»ç»åæ ¸çç¼å²åºéï¼è¿ä¸ªæ·è´çè¿ç¨æ¯éè¿ dma æ¬è¿çã\n 2. ç¬¬äºæ¬¡æ·è´ï¼æåæ ¸ç¼å²åºçæ°æ®æ·è´å°ç¨æ·çç¼å²åºéï¼äºæ¯æä»¬åºç¨ç¨åºå°±å¯ä»¥ä½¿ç¨è¿é¨åæ°æ®äºï¼è¿ä¸ªæ·è´å°è¿ç¨æ¯ç± cpu å®æçã\n 3. ç¬¬ä¸æ¬¡æ·è´ï¼æåææ·è´å°ç¨æ·çç¼å²åºéçæ°æ®ï¼åæ·è´å°åæ ¸ç socket çç¼å²åºéï¼è¿ä¸ªè¿ç¨ä¾ç¶è¿æ¯ç± cpu æ¬è¿çã\n 4. ç¬¬åæ¬¡æ·è´ï¼æåæ ¸ç socket ç¼å²åºéçæ°æ®ï¼æ·è´å°ç½å¡çç¼å²åºéï¼è¿ä¸ªè¿ç¨åæ¯ç± dma æ¬è¿çã\n\nè¿ç§ç®ååä¼ ç»çæä»¶ä¼ è¾æ¹å¼ï¼å­å¨åä½çä¸æåæ¢åæ°æ®æ·è´ï¼å¨é«å¹¶åç³»ç»éæ¯éå¸¸ç³ç³çï¼å¤äºå¾å¤ä¸å¿è¦çå¼éï¼ä¼ä¸¥éå½±åç³»ç»æ§è½ã\n\næä»¥ï¼è¦æ³æé«æä»¶ä¼ è¾çæ§è½ï¼å°±éè¦åå°ãç¨æ·æä¸åæ ¸æçä¸ä¸æåæ¢ãåãæ°æ®æ·è´ãçæ¬¡æ°ã\n\n * åå°ç¨æ·æååæ ¸æçä¸ä¸æåæ¢å°±æ¯ åå°ç³»ç»è°ç¨çæ¬¡æ°\n\n * åå°æ°æ®æ·è´æ¬¡æ° ï¼ãä»åæ ¸çè¯»ç¼å²åºæ·è´å°ç¨æ·çç¼å²åºéï¼åä»ç¨æ·çç¼å²åºéæ·è´å° socket çç¼å²åºéãï¼è¿ä¸ªè¿ç¨æ¯æ²¡æå¿è¦çãå ä¸ºæä»¶ä¼ è¾çåºç¨åºæ¯ä¸­ï¼å¨ç¨æ·ç©ºé´æä»¬å¹¶ä¸ä¼å¯¹æ°æ®ãåå å·¥ãï¼æä»¥æ°æ®å®éä¸å¯ä»¥ä¸ç¨æ¬è¿å°ç¨æ·ç©ºé´ï¼å æ­¤ç¨æ·çç¼å²åºæ¯æ²¡æå¿è¦å­å¨çãæä»¬å¯ä»¥ç´æ¥å°æ°æ®ä»åæ ¸ç¼å²åºæ·è´å°socketç¼å²åº\n\nç°å¨å°±è¦æ­£å¼ä»ç»é¶æ·è´äºï¼é¶æ·è´ä¹æ­£æ¯å®ç°ä¸è¿°æé«æ§è½çå®ç°æ¹æ³ã\n\n\n# 3. é¶æ·è´çå®ç°æ¹å¼\n\né¶æ·è´çå®ç°éå¸¸æä¸¤ç§ ï¼\n\n>  1. mmap + write\n> \n>  2. sendfile\n\n\n# 3.1 mmap\n\né¦åä»ç»ä¸ä¸å¤§åé¼é¼ç mmap + writeã\n\nä¹åè¯´è¿ï¼åå°æ°æ®æ·è´æ¬¡æ°ä¸»è¦æ¯åå° âä»åæ ¸æç¼å²åºæ·è´å°ç¨æ·æç¼å²åºâè¿ä¸æ­¥ï¼æ³è¦æå®å æã\n\nç°å¨ä½¿ç¨ mmap æ¿ä»£ read è¿è¡è¯»æä½\n\nbuf = mmap(file, len);\nwrite(sockfd, buf, len);\n\n\nmmap() ç³»ç»è°ç¨å½æ°ä¼ç´æ¥æåæ ¸ç¼å²åºéçæ°æ®ãæ å°ã(ä¸æ¯æ·è´) å°ç¨æ·ç©ºé´ï¼è¿æ ·ï¼æä½ç³»ç»åæ ¸ä¸ç¨æ·ç©ºé´å°±ä¸éè¦åè¿è¡ä»»ä½çæ°æ®æ·è´æä½ãä¹å¯ä»¥è¯´ç¨æ·æååæ ¸æç°å¨å±äº«ç¼å²åºäºã\n\n\n\nè½ç¶å¯ä»¥åå°ä¸æ¬¡ æ°æ®æ·è´ï¼å¯è¿ä»æ§ä¸æ¯çæ³çé¶æ·è´ï¼æä»¬æç»çç®çæ¯ï¼åå°ç³»ç»è°ç¨å¸¦æ¥çä¸ä¸æåæ¢ã\n\n\n# 3.2 sendfile\n\nåæ¥ä»ç»ä¸ä¸sendfile\n\nssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);\n\n\nè¿ä¸ªsendfileå½æ°æ¯linuxç¨äºä¸é¨åéæä»¶çå½æ°ï¼ç®çå°±æ¯æ¿ä»£ read + writeã\n\nå®å¯ä»¥æ¿ä»£åé¢ç read() å write() è¿ä¸¤ä¸ªç³»ç»è°ç¨ï¼è¿æ ·å°±å¯ä»¥åå°ä¸æ¬¡ç³»ç»è°ç¨ï¼ä¹å°±åå°äº 2 æ¬¡ä¸ä¸æåæ¢çå¼éã å¶æ¬¡ï¼è¯¥ç³»ç»è°ç¨å¯ä»¥ç´æ¥æåæ ¸ç¼å²åºéçæ°æ®æ·è´å° socket ç¼å²åºéï¼ä¸åæ·è´å°ç¨æ·æãè¿æ ·å°±åªå©ä¸ 2 æ¬¡ä¸ä¸æåæ¢ï¼å 3 æ¬¡æ°æ®æ·è´ã å¦ä¸å¾ï¼\n\n\n\nå½ç¶ï¼è¿è¿ä¸æ¯å®ç¾çé¶æ·è´ææ¯ï¼å¦æç½å¡æ¯æ scatter-gather ç¹æ§ï¼é£ä¹sendfileå¯ä»¥ä¸éè¦ç¬¬äºé¨çcpuæ·è´åç¬¬ä¸æ­¥çdmaæ·è´ï¼ç´æ¥å°æ°æ®ä»åæ ¸ç¼å²åºåéå°ç½å¡ã è¿è¢«ç§°ä¸º sg-dmaæ·è´ã\n\n\n\né£ä¹ä¼åå°ç°å¨ï¼åå°äº 2 æ¬¡ä¸ä¸æåæ¢åæ°æ®æ·è´æ¬¡æ°ï¼åªéè¦ 2 æ¬¡ä¸ä¸æåæ¢åæ°æ®æ·è´æ¬¡æ°ï¼å°±å¯ä»¥å®ææä»¶çä¼ è¾ï¼èä¸ 2 æ¬¡çæ°æ®æ·è´è¿ç¨ï¼é½ä¸éè¦éè¿ cpuï¼2 æ¬¡é½æ¯ç± dma æ¥æ¬è¿ã\n\næä»¥ï¼æ»ä½æ¥çï¼é¶æ·è´ææ¯å¯ä»¥ææä»¶ä¼ è¾çæ§è½æé«è³å°ä¸åä»¥ä¸ã\n\nèå¨javaä¸­ï¼mappedbytebufferå°±è°ç¨äºmmapï¼transferto/transferfromå°±æ¯sendfileæ¹æ³ã\n\nå¦ææ¶åå°æä»¶ä¼ è¾ï¼transfertoæ¯é¦éï¼ä½æ¯å¦ææ¶åå°å¯¹åå­æ°æ®çä¿®æ¹éç¨mappedbytebufferã",charsets:{cjk:!0},lastUpdated:"2023/08/06, 23:48:49",lastUpdatedTimestamp:1691336929e3},{title:"ç¼å­ä¸è´æ§åè®®ï¼MESI",frontmatter:{title:"ç¼å­ä¸è´æ§åè®®ï¼MESI",date:"2023-08-02T13:17:16.000Z",permalink:"/pages/ee38bc/"},regularPath:"/02.%E6%96%87%E7%AB%A0/60.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/20.%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AE%EF%BC%9AMESI.html",relativePath:"02.æç« /60.æä½ç³»ç»/20.ç¼å­ä¸è´æ§åè®®ï¼MESI.md",key:"v-62c5b9aa",path:"/pages/ee38bc/",headers:[{level:2,title:"1. Cache",slug:"_1-cache",normalizedTitle:"1. cache",charIndex:2},{level:2,title:"2. ç¼å­ä¸è´æ§é®é¢",slug:"_2-ç¼å­ä¸è´æ§é®é¢",normalizedTitle:"2. ç¼å­ä¸è´æ§é®é¢",charIndex:592},{level:2,title:"3. æ»çº¿åæ¢",slug:"_3-æ»çº¿åæ¢",normalizedTitle:"3. æ»çº¿åæ¢",charIndex:1331},{level:2,title:"4. MESIåè®®",slug:"_4-mesiåè®®",normalizedTitle:"4. mesiåè®®",charIndex:1622}],headersStr:"1. Cache 2. ç¼å­ä¸è´æ§é®é¢ 3. æ»çº¿åæ¢ 4. MESIåè®®",content:"# 1. Cache\n\nä¸ºä»ä¹ CPU è¦æç¼å­ï¼\n\nCPU è¦ä»åå­ä¸­åæ°æ®ï¼ä½æ¯ CPU å¤ªå¿«äºï¼åå­å¤ªæ¢äºï¼éåº¦å·®å¼è¿å¤§å¯¼è´ CPU çæ§è½æ æ³å©ç¨ãæä»¥æä½ç³»ç»ä½¿ç¨ Cache ä½ä¸º CPU ä¸åå­ä¹é´çç¼å­ãå°±å Redis å¨ Javaç¨åºä¸MySQLä¹é´åå½ç¼å­ä½ç¨ä¼¼çã\n\nCache éå¸¸åä¸ºä¸çº§ ï¼L1ãL2ãL3ãçº§å«è¶ä½ï¼ç¦» CPU è¶è¿ï¼éåº¦è¶å¿«ï¼ä½æ¯å­å¨å®¹éè¶å°ã\n\nå¨å¤æ ¸ CPU ä¸­ï¼æ¯ä¸ª CPU é½æåèªç L1 ä¸ L2ï¼èL3æ¯ææ CPU å±äº«ç ã\n\nCache æ¯ç±å¾å¤ä¸ª Cache Line ç»æçï¼CPU Line æ¯ CPU ä»åå­è¯»åæ°æ®çåºæ¬åä½ï¼è CPU Line æ¯ç±åç§æ å¿ï¼Tagï¼+ æ°æ®åï¼Data Blockï¼ç»æï¼ä½ å¯ä»¥å¨ä¸å¾æ¸æ°ççå°ï¼\n\näºå®ä¸ï¼æ°æ®ä¸åæ¯åªæè¯»æä½ï¼è¿æåæä½ï¼é£ä¹å¦ææ°æ®åå¥ Cache ä¹åï¼åå­ä¸ Cache ç¸å¯¹åºçæ°æ®å°ä¼ä¸åï¼è¿ç§æåµä¸ Cache ååå­æ°æ®é½ä¸ä¸è´äºï¼äºæ¯æä»¬è¯å®æ¯è¦æ Cache ä¸­çæ°æ®åæ­¥å°åå­éçã\n\næä¸¤ç§åæ¹å¼ï¼\n\n 1. åç´è¾¾ ï¼Write Throughï¼åå¥æ°æ®æ¶ä¸ä»å¾ç¼å­ä¸­åï¼è¿è¦å¾åå­ä¸­åã\n 2. åå ï¼Write Backï¼åæ°æ®æ¶åªå¾ç¼å­ä¸­åï¼å¹¶ææ°æ®æ è®°ä¸ºèæ°æ®ï¼åæ°æ®æ¶éå°èæ°æ®å°±ä¼å°èæ°æ®åæ­¥å°åå­ã\n\n\n# 2. ç¼å­ä¸è´æ§é®é¢\n\nç°å¨ç CPU é½æ¯å¤æ ¸çï¼ç±äº L1 ä¸ L2 æ¯ CPU ç¬èªæ¥æçï¼é£ä¹å°±ä¼å¸¦æ¥ç¼å­ä¸è´æ§é®é¢ï¼å¦æä¸è½è§£å³ç¼å­ä¸è´æ§é®é¢ï¼é£å°±ä¼é æç»æéè¯¯ã\n\né£ä¹ä»ä¹æ¯ç¼å­ä¸è´æ§é®é¢å¢ï¼ä¸ºä»ä¹ä¼åºç°ç¼å­ä¸è´æ§é®é¢ï¼\n\nåå¦ç°å¨åä¸¤ä¸ªæ ¸ï¼CPU A ä¸ CPU Bï¼å¨ä»ä»¬ç L1 ä¸­é½æä¸ä¸ªåé i = 0ã\n\nç°å¨ A å°å®ä¿®æ¹ä¸º1ï¼è¿æ²¡æ¥çåå·å°åå­ä¸­å°±è¢« B è¯»åäºï¼B è¯»åçæ°æ® i = 0ã\n\nä½æ¯ B æ¯ A æ§è¡çæï¼A åæ i æ¹äºï¼é£ä¹ B å¾å°ç i çåºä¸º 1ã\n\nè¿å°±æ¯ç¼å­ä¸è´æ§é®é¢ã\n\næ³è¦è§£å³è¿ä¸ªé®é¢ï¼å°±è¦ä¿è¯ä»¥ä¸ä¸¤ç¹ ï¼\n\n>  1. åä¼ æ­ ï¼ä¸ä¸ª CPU ä¿®æ¹äºå±äº«åéï¼è¦ éç¥ å¶ä»ææ CPUã\n>  2. äºç©çä¸²è¡å ï¼è¿ä¸ª âéç¥â è¢« ä¸åCPU æ¥æ¶çé¡ºåºåºè¯¥ç¸åã\n\nç¬¬ä¸ç¹å¾å®¹æçè§£ï¼ä¸ä¸ª CPU ä¿®æ¹äºå±äº«åéï¼å¨å·æ°å°åå­ä¹åå°±è¦éç¥å«ç CPUï¼ä»¥ååºç°ç¼å­ä¸ä¸è´é®é¢ã\n\nç¬¬äºç¹æç¹ç¯è¿·ç³ï¼æ¥ä¸¾ä¸ªä¾å­ï¼\n\nCPU A ååºäºä¸¤æ¡éç¥ ï¼A å° i ä¿®æ¹ä¸º 100ãA å° i ä¿®æ¹ä¸º 200\n\nå¦æåºç°ä»¥ä¸æåµï¼é£ä¹æç»ç»æå°±ä¼å¯¼è´ä¸ä¸æ ·ï¼\n\n * CPU B æ¥æ¶çéç¥é¡ºåºä¸º ï¼A å° i ä¿®æ¹ä¸º 200ãA å° i ä¿®æ¹ä¸º 100ã\n   å¨ CPU B ä¸­ï¼i çæç»ç»æä¸º 100\n * CPU C æ¥æ¶çéç¥é¡ºåºä¸º ï¼A å° i ä¿®æ¹ä¸º 100ãA å° i ä¿®æ¹ä¸º 200ã\n   å¨ CPU C ä¸­ï¼i çæç»ç»æä¸º 200\n\næä»¥ï¼æä»¬è¦ä¿è¯ B å·æ ¸å¿å C å·æ ¸å¿é½è½çå°ç¸åé¡ºåºçæ°æ®ååã\n\næ¥ä¸æ¥çä¸ä¸ CPU æ¯å¦ä½å®ç° åä¼ æ­ å äºå¡çä¸²è¡å çã\n\n\n# 3. æ»çº¿åæ¢\n\nåä¼ æ­æºå¶å¾ç®å ï¼å½æä¸ª CPU æ ¸å¿æ´æ°äº Cache ä¸­çæ°æ®ï¼è¦æè¯¥äºä»¶å¹¿æ­éç¥å°å¶ä»æ ¸å¿ã\n\næå¸¸è§å®ç°çæ¹å¼æ¯æ»çº¿åæ¢ï¼Bus Snoopingï¼ ï¼æä¸ª CPU æ´æ°äºæ°æ®æ¶ä¼å°ä¿®æ¹ä»¥å¹¿æ­çå½¢å¼åéå° æ»çº¿ï¼èå¶ä» CPUæ¶å»çå¬æ»çº¿ï¼ä¸æ¦åçåä¿¡å·ï¼ç«å»æ£æ¥èªå·±ç Cache ä¸­æ¯å¦æè¿ä¸ªæ°æ®ï¼å¦ææå°±æè¿ä¸ªåæä½åæ­¥è¿æ¥ã\n\næ»çº¿åæ¢æºå¶å¾ç®åï¼ä½æ¯ CPU è¦æ¶å»çå¬æ»çº¿ï¼è¿æ å¼äºä¼å¢å å¾å¤è´æãå¹¶ä¸æ»çº¿åæ¢åªè½å®ç°åä¼ æ­ï¼ä¸è½å®ç° äºå¡çä¸²è¡åã\n\nMESI åè®®å°±éè¿ æ»çº¿åæ¢æºå¶ å®ç°äº äºå¡çä¸²è¡åï¼åå°äºç¼å­çä¸è´æ§ã\n\n\n# 4. MESIåè®®\n\nMESI åè®®å¶å®æ¯ 4 ä¸ªç¶æåè¯çå¼å¤´å­æ¯ç¼©åï¼åå«æ¯ï¼\n\n * Modifiedï¼å·²ä¿®æ¹\n * Exclusiveï¼ç¬å \n * Sharedï¼å±äº«\n * Invalidatedï¼å·²å¤±æ\n\nè¿åä¸ªç¶ææ¥æ è®° Cache Line åä¸ªä¸åçç¶æã\n\nãå·²ä¿®æ¹ãç¶æå°±æ¯æä»¬åé¢æå°çèæ è®°ï¼ä»£è¡¨è¯¥ Cache Block ä¸çæ°æ®å·²ç»è¢«æ´æ°è¿ï¼ä½æ¯è¿æ²¡æåå°åå­éãå¦æ CPU ä¸­æä¸ªæ°æ®æ¯å·²ä¿®æ¹ï¼é£ä¹å¯ä»¥ç´æ¥å¯¹è¿ä¸ªæ°æ®åï¼ä¸éè¦éç¥å¶ä» CPUã\n\nãå·²å¤±æãç¶æï¼è¡¨ç¤ºçæ¯è¿ä¸ª Cache Block éçæ°æ®å·²ç»å¤±æäºï¼ä¸å¯ä»¥è¯»åè¯¥ç¶æçæ°æ®ã\n\nãç¬å ãåãå±äº«ãç¶æé½ä»£è¡¨ Cache Block éçæ°æ®æ¯å¹²åçï¼ä¹å°±æ¯è¯´ï¼è¿ä¸ªæ¶å Cache Block éçæ°æ®ååå­éé¢çæ°æ®æ¯ä¸è´æ§çã\n\nãç¬å ãåãå±äº«ãçå·®å«å¨äºï¼ç¬å ç¶æçæ¶åï¼æ°æ®åªå­å¨å¨ä¸ä¸ª CPU æ ¸å¿ç Cache éï¼èå¶ä» CPU æ ¸å¿ç Cache æ²¡æè¯¥æ°æ®ãè¿ä¸ªæ¶åï¼å¦æè¦åç¬å ç Cache åæ°æ®ï¼å°±å¯ä»¥ç´æ¥èªç±å°åå¥ï¼èä¸éè¦éç¥å¶ä» CPU æ ¸å¿ï¼å ä¸ºåªæä½ è¿æè¿ä¸ªæ°æ®ï¼å°±ä¸å­å¨ç¼å­ä¸è´æ§çé®é¢äºï¼äºæ¯å°±å¯ä»¥éä¾¿æä½è¯¥æ°æ®ã\n\nå¦å¤ï¼å¨ãç¬å ãç¶æä¸çæ°æ®ï¼å¦ææå¶ä»æ ¸å¿ä»åå­è¯»åäºç¸åçæ°æ®å°åèªç Cache ï¼é£ä¹è¿ä¸ªæ¶åï¼ç¬å ç¶æä¸çæ°æ®å°±ä¼åæå±äº«ç¶æã\n\né£ä¹ï¼ãå±äº«ãç¶æä»£è¡¨çç¸åçæ°æ®å¨å¤ä¸ª CPU æ ¸å¿ç Cache éé½æï¼æä»¥å½æä»¬è¦æ´æ° Cache éé¢çæ°æ®çæ¶åä¸è½ç´æ¥ä¿®æ¹ï¼èæ¯è¦ååææçå¶ä» CPU æ ¸å¿å¹¿æ­ä¸ä¸ªè¯·æ±ï¼è¦æ±åæå¶ä»æ ¸å¿ç Cache ä¸­å¯¹åºç Cache Line æ è®°ä¸ºãæ æãç¶æï¼ç¶ååæ´æ°å½å Cache éé¢çæ°æ®ã\n\né£ä¹MESIå¦ä½å®ç°äºå¡çä¸²è¡åå¢ï¼\n\nå½ä¸ä¸ªå¤çå¨è¦ä¿®æ¹ä¸ä¸ªç¼å­è¡æ¶ï¼å®é¦åå°è¯¥ç¼å­è¡çç¶æè®¾ç½®ä¸ºä¿®æ¹ç¶æï¼ç¶åå°è¯¥ç¼å­è¡çæ°æ®å¤å¶å°èªå·±çç¼å­ä¸­ã æ­¤æ¶ï¼å¶ä»å¤çå¨æ æ³è®¿é®è¯¥ç¼å­è¡ãå¶ä»å¤çå¨å¦æè¦è®¿é®è¯¥ç¼å­è¡ï¼å¿é¡»åå°å¶ç¶æè®¾ç½®ä¸ºæ æï¼ç¶åä»ä¸»å­ä¸­è¯»åææ°çæ°æ®ã è¿æ ·ï¼æ¯ä¸ªå¤çå¨é½å¯ä»¥æç§é¡ºåºæ§è¡äºå¡ï¼ä¿è¯äºäºå¡çä¸²è¡åã",normalizedContent:"# 1. cache\n\nä¸ºä»ä¹ cpu è¦æç¼å­ï¼\n\ncpu è¦ä»åå­ä¸­åæ°æ®ï¼ä½æ¯ cpu å¤ªå¿«äºï¼åå­å¤ªæ¢äºï¼éåº¦å·®å¼è¿å¤§å¯¼è´ cpu çæ§è½æ æ³å©ç¨ãæä»¥æä½ç³»ç»ä½¿ç¨ cache ä½ä¸º cpu ä¸åå­ä¹é´çç¼å­ãå°±å redis å¨ javaç¨åºä¸mysqlä¹é´åå½ç¼å­ä½ç¨ä¼¼çã\n\ncache éå¸¸åä¸ºä¸çº§ ï¼l1ãl2ãl3ãçº§å«è¶ä½ï¼ç¦» cpu è¶è¿ï¼éåº¦è¶å¿«ï¼ä½æ¯å­å¨å®¹éè¶å°ã\n\nå¨å¤æ ¸ cpu ä¸­ï¼æ¯ä¸ª cpu é½æåèªç l1 ä¸ l2ï¼èl3æ¯ææ cpu å±äº«ç ã\n\ncache æ¯ç±å¾å¤ä¸ª cache line ç»æçï¼cpu line æ¯ cpu ä»åå­è¯»åæ°æ®çåºæ¬åä½ï¼è cpu line æ¯ç±åç§æ å¿ï¼tagï¼+ æ°æ®åï¼data blockï¼ç»æï¼ä½ å¯ä»¥å¨ä¸å¾æ¸æ°ççå°ï¼\n\näºå®ä¸ï¼æ°æ®ä¸åæ¯åªæè¯»æä½ï¼è¿æåæä½ï¼é£ä¹å¦ææ°æ®åå¥ cache ä¹åï¼åå­ä¸ cache ç¸å¯¹åºçæ°æ®å°ä¼ä¸åï¼è¿ç§æåµä¸ cache ååå­æ°æ®é½ä¸ä¸è´äºï¼äºæ¯æä»¬è¯å®æ¯è¦æ cache ä¸­çæ°æ®åæ­¥å°åå­éçã\n\næä¸¤ç§åæ¹å¼ï¼\n\n 1. åç´è¾¾ ï¼write throughï¼åå¥æ°æ®æ¶ä¸ä»å¾ç¼å­ä¸­åï¼è¿è¦å¾åå­ä¸­åã\n 2. åå ï¼write backï¼åæ°æ®æ¶åªå¾ç¼å­ä¸­åï¼å¹¶ææ°æ®æ è®°ä¸ºèæ°æ®ï¼åæ°æ®æ¶éå°èæ°æ®å°±ä¼å°èæ°æ®åæ­¥å°åå­ã\n\n\n# 2. ç¼å­ä¸è´æ§é®é¢\n\nç°å¨ç cpu é½æ¯å¤æ ¸çï¼ç±äº l1 ä¸ l2 æ¯ cpu ç¬èªæ¥æçï¼é£ä¹å°±ä¼å¸¦æ¥ç¼å­ä¸è´æ§é®é¢ï¼å¦æä¸è½è§£å³ç¼å­ä¸è´æ§é®é¢ï¼é£å°±ä¼é æç»æéè¯¯ã\n\né£ä¹ä»ä¹æ¯ç¼å­ä¸è´æ§é®é¢å¢ï¼ä¸ºä»ä¹ä¼åºç°ç¼å­ä¸è´æ§é®é¢ï¼\n\nåå¦ç°å¨åä¸¤ä¸ªæ ¸ï¼cpu a ä¸ cpu bï¼å¨ä»ä»¬ç l1 ä¸­é½æä¸ä¸ªåé i = 0ã\n\nç°å¨ a å°å®ä¿®æ¹ä¸º1ï¼è¿æ²¡æ¥çåå·å°åå­ä¸­å°±è¢« b è¯»åäºï¼b è¯»åçæ°æ® i = 0ã\n\nä½æ¯ b æ¯ a æ§è¡çæï¼a åæ i æ¹äºï¼é£ä¹ b å¾å°ç i çåºä¸º 1ã\n\nè¿å°±æ¯ç¼å­ä¸è´æ§é®é¢ã\n\næ³è¦è§£å³è¿ä¸ªé®é¢ï¼å°±è¦ä¿è¯ä»¥ä¸ä¸¤ç¹ ï¼\n\n>  1. åä¼ æ­ ï¼ä¸ä¸ª cpu ä¿®æ¹äºå±äº«åéï¼è¦ éç¥ å¶ä»ææ cpuã\n>  2. äºç©çä¸²è¡å ï¼è¿ä¸ª âéç¥â è¢« ä¸åcpu æ¥æ¶çé¡ºåºåºè¯¥ç¸åã\n\nç¬¬ä¸ç¹å¾å®¹æçè§£ï¼ä¸ä¸ª cpu ä¿®æ¹äºå±äº«åéï¼å¨å·æ°å°åå­ä¹åå°±è¦éç¥å«ç cpuï¼ä»¥ååºç°ç¼å­ä¸ä¸è´é®é¢ã\n\nç¬¬äºç¹æç¹ç¯è¿·ç³ï¼æ¥ä¸¾ä¸ªä¾å­ï¼\n\ncpu a ååºäºä¸¤æ¡éç¥ ï¼a å° i ä¿®æ¹ä¸º 100ãa å° i ä¿®æ¹ä¸º 200\n\nå¦æåºç°ä»¥ä¸æåµï¼é£ä¹æç»ç»æå°±ä¼å¯¼è´ä¸ä¸æ ·ï¼\n\n * cpu b æ¥æ¶çéç¥é¡ºåºä¸º ï¼a å° i ä¿®æ¹ä¸º 200ãa å° i ä¿®æ¹ä¸º 100ã\n   å¨ cpu b ä¸­ï¼i çæç»ç»æä¸º 100\n * cpu c æ¥æ¶çéç¥é¡ºåºä¸º ï¼a å° i ä¿®æ¹ä¸º 100ãa å° i ä¿®æ¹ä¸º 200ã\n   å¨ cpu c ä¸­ï¼i çæç»ç»æä¸º 200\n\næä»¥ï¼æä»¬è¦ä¿è¯ b å·æ ¸å¿å c å·æ ¸å¿é½è½çå°ç¸åé¡ºåºçæ°æ®ååã\n\næ¥ä¸æ¥çä¸ä¸ cpu æ¯å¦ä½å®ç° åä¼ æ­ å äºå¡çä¸²è¡å çã\n\n\n# 3. æ»çº¿åæ¢\n\nåä¼ æ­æºå¶å¾ç®å ï¼å½æä¸ª cpu æ ¸å¿æ´æ°äº cache ä¸­çæ°æ®ï¼è¦æè¯¥äºä»¶å¹¿æ­éç¥å°å¶ä»æ ¸å¿ã\n\næå¸¸è§å®ç°çæ¹å¼æ¯æ»çº¿åæ¢ï¼bus snoopingï¼ ï¼æä¸ª cpu æ´æ°äºæ°æ®æ¶ä¼å°ä¿®æ¹ä»¥å¹¿æ­çå½¢å¼åéå° æ»çº¿ï¼èå¶ä» cpuæ¶å»çå¬æ»çº¿ï¼ä¸æ¦åçåä¿¡å·ï¼ç«å»æ£æ¥èªå·±ç cache ä¸­æ¯å¦æè¿ä¸ªæ°æ®ï¼å¦ææå°±æè¿ä¸ªåæä½åæ­¥è¿æ¥ã\n\næ»çº¿åæ¢æºå¶å¾ç®åï¼ä½æ¯ cpu è¦æ¶å»çå¬æ»çº¿ï¼è¿æ å¼äºä¼å¢å å¾å¤è´æãå¹¶ä¸æ»çº¿åæ¢åªè½å®ç°åä¼ æ­ï¼ä¸è½å®ç° äºå¡çä¸²è¡åã\n\nmesi åè®®å°±éè¿ æ»çº¿åæ¢æºå¶ å®ç°äº äºå¡çä¸²è¡åï¼åå°äºç¼å­çä¸è´æ§ã\n\n\n# 4. mesiåè®®\n\nmesi åè®®å¶å®æ¯ 4 ä¸ªç¶æåè¯çå¼å¤´å­æ¯ç¼©åï¼åå«æ¯ï¼\n\n * modifiedï¼å·²ä¿®æ¹\n * exclusiveï¼ç¬å \n * sharedï¼å±äº«\n * invalidatedï¼å·²å¤±æ\n\nè¿åä¸ªç¶ææ¥æ è®° cache line åä¸ªä¸åçç¶æã\n\nãå·²ä¿®æ¹ãç¶æå°±æ¯æä»¬åé¢æå°çèæ è®°ï¼ä»£è¡¨è¯¥ cache block ä¸çæ°æ®å·²ç»è¢«æ´æ°è¿ï¼ä½æ¯è¿æ²¡æåå°åå­éãå¦æ cpu ä¸­æä¸ªæ°æ®æ¯å·²ä¿®æ¹ï¼é£ä¹å¯ä»¥ç´æ¥å¯¹è¿ä¸ªæ°æ®åï¼ä¸éè¦éç¥å¶ä» cpuã\n\nãå·²å¤±æãç¶æï¼è¡¨ç¤ºçæ¯è¿ä¸ª cache block éçæ°æ®å·²ç»å¤±æäºï¼ä¸å¯ä»¥è¯»åè¯¥ç¶æçæ°æ®ã\n\nãç¬å ãåãå±äº«ãç¶æé½ä»£è¡¨ cache block éçæ°æ®æ¯å¹²åçï¼ä¹å°±æ¯è¯´ï¼è¿ä¸ªæ¶å cache block éçæ°æ®ååå­éé¢çæ°æ®æ¯ä¸è´æ§çã\n\nãç¬å ãåãå±äº«ãçå·®å«å¨äºï¼ç¬å ç¶æçæ¶åï¼æ°æ®åªå­å¨å¨ä¸ä¸ª cpu æ ¸å¿ç cache éï¼èå¶ä» cpu æ ¸å¿ç cache æ²¡æè¯¥æ°æ®ãè¿ä¸ªæ¶åï¼å¦æè¦åç¬å ç cache åæ°æ®ï¼å°±å¯ä»¥ç´æ¥èªç±å°åå¥ï¼èä¸éè¦éç¥å¶ä» cpu æ ¸å¿ï¼å ä¸ºåªæä½ è¿æè¿ä¸ªæ°æ®ï¼å°±ä¸å­å¨ç¼å­ä¸è´æ§çé®é¢äºï¼äºæ¯å°±å¯ä»¥éä¾¿æä½è¯¥æ°æ®ã\n\nå¦å¤ï¼å¨ãç¬å ãç¶æä¸çæ°æ®ï¼å¦ææå¶ä»æ ¸å¿ä»åå­è¯»åäºç¸åçæ°æ®å°åèªç cache ï¼é£ä¹è¿ä¸ªæ¶åï¼ç¬å ç¶æä¸çæ°æ®å°±ä¼åæå±äº«ç¶æã\n\né£ä¹ï¼ãå±äº«ãç¶æä»£è¡¨çç¸åçæ°æ®å¨å¤ä¸ª cpu æ ¸å¿ç cache éé½æï¼æä»¥å½æä»¬è¦æ´æ° cache éé¢çæ°æ®çæ¶åä¸è½ç´æ¥ä¿®æ¹ï¼èæ¯è¦ååææçå¶ä» cpu æ ¸å¿å¹¿æ­ä¸ä¸ªè¯·æ±ï¼è¦æ±åæå¶ä»æ ¸å¿ç cache ä¸­å¯¹åºç cache line æ è®°ä¸ºãæ æãç¶æï¼ç¶ååæ´æ°å½å cache éé¢çæ°æ®ã\n\né£ä¹mesiå¦ä½å®ç°äºå¡çä¸²è¡åå¢ï¼\n\nå½ä¸ä¸ªå¤çå¨è¦ä¿®æ¹ä¸ä¸ªç¼å­è¡æ¶ï¼å®é¦åå°è¯¥ç¼å­è¡çç¶æè®¾ç½®ä¸ºä¿®æ¹ç¶æï¼ç¶åå°è¯¥ç¼å­è¡çæ°æ®å¤å¶å°èªå·±çç¼å­ä¸­ã æ­¤æ¶ï¼å¶ä»å¤çå¨æ æ³è®¿é®è¯¥ç¼å­è¡ãå¶ä»å¤çå¨å¦æè¦è®¿é®è¯¥ç¼å­è¡ï¼å¿é¡»åå°å¶ç¶æè®¾ç½®ä¸ºæ æï¼ç¶åä»ä¸»å­ä¸­è¯»åææ°çæ°æ®ã è¿æ ·ï¼æ¯ä¸ªå¤çå¨é½å¯ä»¥æç§é¡ºåºæ§è¡äºå¡ï¼ä¿è¯äºäºå¡çä¸²è¡åã",charsets:{cjk:!0},lastUpdated:"2023/08/02, 23:56:18",lastUpdatedTimestamp:1690991778e3},{title:"TCPãUDPåè®®",frontmatter:{title:"TCPãUDPåè®®",date:"2023-06-14T19:44:57.000Z",permalink:"/pages/424c75/"},regularPath:"/02.%E6%96%87%E7%AB%A0/70.%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/10.TCP%E3%80%81UDP%E5%8D%8F%E8%AE%AE.html",relativePath:"02.æç« /70.è®¡ç®æºç½ç»/10.TCPãUDPåè®®.md",key:"v-04afedb8",path:"/pages/424c75/",headers:[{level:2,title:"1. æ¦è¿°",slug:"_1-æ¦è¿°",normalizedTitle:"1. æ¦è¿°",charIndex:16},{level:2,title:"2. ç«¯å£å· å¤ç¨ åç¨",slug:"_2-ç«¯å£å·-å¤ç¨-åç¨",normalizedTitle:"2. ç«¯å£å· å¤ç¨ åç¨",charIndex:689},{level:2,title:"3. TCP",slug:"_3-tcp",normalizedTitle:"3. tcp",charIndex:1147},{level:3,title:"3.1 TCPé¦é¨æ ¼å¼",slug:"_3-1-tcpé¦é¨æ ¼å¼",normalizedTitle:"3.1 tcpé¦é¨æ ¼å¼",charIndex:1158},{level:3,title:"3.2 å»ºç«è¿æ¥-ä¸æ¬¡æ¡æ",slug:"_3-2-å»ºç«è¿æ¥-ä¸æ¬¡æ¡æ",normalizedTitle:"3.2 å»ºç«è¿æ¥-ä¸æ¬¡æ¡æ",charIndex:3131},{level:3,title:"3.3 éæ¾è¿æ¥-åæ¬¡æ¥æ",slug:"_3-3-éæ¾è¿æ¥-åæ¬¡æ¥æ",normalizedTitle:"3.3 éæ¾è¿æ¥-åæ¬¡æ¥æ",charIndex:4816},{level:3,title:"3.4 TCPæµéæ§å¶",slug:"_3-4-tcpæµéæ§å¶",normalizedTitle:"3.4 tcpæµéæ§å¶",charIndex:6329},{level:3,title:"3.5 TCPæ¥å¡æ§å¶",slug:"_3-5-tcpæ¥å¡æ§å¶",normalizedTitle:"3.5 tcpæ¥å¡æ§å¶",charIndex:7173},{level:3,title:"3.6 TCPå¯é ä¼ è¾çå®ç°",slug:"_3-6-tcpå¯é ä¼ è¾çå®ç°",normalizedTitle:"3.6 tcpå¯é ä¼ è¾çå®ç°",charIndex:7724},{level:3,title:"3.7 TCPè¶æ¶éä¼ ",slug:"_3-7-tcpè¶æ¶éä¼ ",normalizedTitle:"3.7 tcpè¶æ¶éä¼ ",charIndex:8906},{level:2,title:"4. UDP",slug:"_4-udp",normalizedTitle:"4. udp",charIndex:9616},{level:2,title:"5.TCPä¸UDPçåºå«",slug:"_5-tcpä¸udpçåºå«",normalizedTitle:"5.tcpä¸udpçåºå«",charIndex:9845}],headersStr:"1. æ¦è¿° 2. ç«¯å£å· å¤ç¨ åç¨ 3. TCP 3.1 TCPé¦é¨æ ¼å¼ 3.2 å»ºç«è¿æ¥-ä¸æ¬¡æ¡æ 3.3 éæ¾è¿æ¥-åæ¬¡æ¥æ 3.4 TCPæµéæ§å¶ 3.5 TCPæ¥å¡æ§å¶ 3.6 TCPå¯é ä¼ è¾çå®ç° 3.7 TCPè¶æ¶éä¼  4. UDP 5.TCPä¸UDPçåºå«",content:"# TCP UDPåè®®\n\n\n# 1. æ¦è¿°\n\nTCPãUDPåè®®æ¯TCP/IPä½ç³»ç»æä¼ è¾å±ä¸­çä¸¤ä¸ªéè¦åè®®ã\n\nå¦å¾æç¤ºä¸ºè®¡ç®æºç½ç»åå±æ¨¡åï¼\n\n\n\n**IPåè®®**æ¯ç½éå±ä¸­çæ ¸å¿åè®®ï¼å®å¯ä»¥äºèä¸åçç½ç»æ¥å£ï¼å¹¶åå¶ä¸å±æä¾æ è¿æ¥ãä¸å¯é çæ°æ®ä¼ è¾æå¡ã\n\nTCP/IPä½ç³»ç»æçåºç¨å±ä¸­åå«è®¸å¤§éçåºç¨å±åè®®ï¼å¶ä¸­æäºåºç¨å±åè®®éè¦ä½¿ç¨å¯é ä¼ è¾æå¡ï¼ä¾å¦æµè§ç½é¡µãä¼ è¾æä»¶ç­ï¼è¿äºæ°æ®ä¸æ¦ä¼ è¾å¤±è´¥ä¼é ææ æ³æ½åçå±å®³ãèæäºåéè¦ä½¿ç¨ä¸å¯é ä¼ è¾æå¡ï¼ä¾å¦é³è§é¢éè¯ç­ï¼å°éçæ°æ®ä¼ è¾éè¯¯å¹¶ä¸ä¼å¯¹æ­æ¾é æå¤§å½±åã\n\nç±äºåºç¨å±éè¦ä½¿ç¨å¯é åä¸å¯é ä¸¤ç§ä¼ è¾æå¡ï¼ä½IPåè®®åªè½æä¾ä¸å¯é ä¼ è¾æå¡ï¼äºæ¯å°±éè¦ä¼ è¾å±æ¥æä¾å¯é /ä¸å¯é çä¼ è¾æå¡ã\n\nå¶ä¸­TCPæä¾å¯é æ§ä¼ è¾æå¡ï¼UDPæä¾ä¸å¯é ä¼ è¾æå¡ã\n\nTCP ï¼Transmission Control Protocolï¼ä¼ è¾æ§å¶åè®®ï¼ä¸ºä¸å±æä¾çæ¯é¢åè¿æ¥çå¯é çæ°æ®ä¼ è¾æå¡ãä½¿ç¨TCPéä¿¡çåæ¹ï¼å¨ä¼ éæ°æ®ä¹åå¿é¡»é¦åå»ºç«TCPè¿æ¥ï¼é»è¾è¿æ¥ï¼èéç©çè¿æ¥ï¼ãæ°æ®ä¼ è¾ç»æåå¿é¡»è¦éæ¾TCPè¿æ¥ãTCPä¸ºäºå®ç°å¯é ä¼ è¾ï¼å°±å¿é¡»ä½¿ç¨å¾å¤æªæ½ï¼ä¾å¦TCPè¿æ¥ç®¡çãç¡®è®¤æºå¶ãè¶æ¶éä¼ ãæµéæ§å¶ãæ¥å¡æ§å¶ç­ãTCPçå®ç°å¤æï¼æ¥æé¦é¨è¾å¤§ï¼å ç¨å¤çæºèµæºæ¯è¾å¤ã\n\nUDP ï¼User Datagram Protocolï¼ç¨æ·æ°æ®æ¥åè®®ï¼ä¸ºå¶ä¸å±æä¾çæ¯æ è¿æ¥çä¸å¯é çæ°æ®ä¼ è¾æå¡ï¼å æ­¤ä¸éè¦å®ç°å¯é ä¼ è¾çåç§æºå¶ãä½¿ç¨UDPéä¿¡çåæ¹ï¼å¨ä¼ éæ°æ®ä¹åä¸éè¦å»ºç«è¿æ¥ãUDPçå®ç°ç®åï¼ç¨æ·æ°æ®æ¥é¦é¨æ¯è¾å°ã\n\n\n# 2. ç«¯å£å· å¤ç¨ åç¨\n\nç«¯å£å· ï¼è¿è¡å¨è®¡ç®æºä¸çè¿ç¨ä½¿ç¨è¿ç¨æ è¯ç¬¦PIDæ¥åºåï¼ä½æ¯å ç¹ç½ä¸çè®¡ç®æºä½¿ç¨æä½ç³»ç»å¤æï¼ä¸åçæä½ç³»ç»åæä¸åæ ¼å¼çè¿ç¨æ è¯ç¬¦ï¼ä¸ºäºä½¿è¿è¡å¨ä¸åæä½ç³»ç»çè®¡ç®æºçåºç¨è¿ç¨ä¹é´è½å¤è¿è¡éä¿¡ï¼å°±å¿é¡»ä½¿ç¨ç»ä¸çæ¹æ³å¯¹TCP/IPä½ç³»çåºç¨è¿ç¨è¿è¡æ è¯ï¼èè¿ä¸ªæ è¯æ¹æ³å°±æ¯**ç«¯å£å·**ï¼è¿è¾å±ä½¿ç¨ç«¯å£å·æ¥åºååºç¨å±çä¸ååºç¨è¿ç¨ãç«¯å£å·åªå·ææ¬å°æä¹ï¼å³ç«¯å£å·åªæ¯ä¸ºäºæ è¯æ¬è®¡ç®æºåºç¨è¿ç¨ï¼å¨å ç¹ç½ä¸­ï¼ä¸åçè®¡ç®æºä¸­çç¸åç«¯å£æ²¡æèç³»ï¼ä½ çµèä¸ç8080ç«¯å£è·æçµèä¸ç8080ç«¯å£ä¸ç¹å³ç³»æ²¡æã\n\nåéæ¹çå¤ç¨ ï¼åºç¨å±æ¥æç»è¿ä¼ è¾å±TCPåè®®è¿è¡å°è£ï¼ç§°ä¸ºTCPå¤ç¨ãåºç¨å±æ¥æç»è¿ä¼ è¾å±UDPåè®®å°è£ï¼ç§°ä¸ºUDPå¤ç¨ãä¼ è¾å±çæ¥æç»è¿ç½ç»å±IPåè®®çå°è£ï¼ç§°ä¸ºIPå¤ç¨\n\næ¥æ¶æ¹çåç¨ï¼ç½ç»å±ä½¿ç¨IPåè®®è§£ææ¥åçIPæ°æ®æ¥ï¼ç§°ä¸ºIPåç¨ãä¼ è¾å±ä½¿ç¨TCPåè®®è§£ææ¥åçTCPæ°æ®æ¥ï¼ç§°ä¸ºTCPåç¨ãä¼ è¾å±ä½¿ç¨UDPåè®®è§£ææ¥åçUDPæ°æ®æ¥ï¼ç§°ä¸ºUDPåç¨ã\n\n\n\nâ\n\n\n# 3. TCP\n\n\n# 3.1 TCPé¦é¨æ ¼å¼\n\nTCPåè®®å¤äºä¼ è¾å±ï¼å®åä¸å±ï¼åºç¨å±ï¼æä¾é¢åè¿æ¥çå¯é ä¼ è¾æå¡ï¼ä¸ºäºå®ç°å¯é ä¼ è¾ï¼éç¨äº**é¢åå­èæµ**çæ¹å¼ã\n\nTCPå¨åéæ°æ®æ¶ä»åéç¼å­ä¸­ååºä¸é¨åæå¨é¨å­èå¹¶ç»å¶æ·»å ä¸ä¸ªé¦é¨ä½¿ä¹æä¸ºTCPæ¥ææ®µåå¨åéç»ä¸å±ãä¸ä¸ªTCPæ¥ææ®µç±é¦é¨åæ°æ®è½½è·ä¸¤é¨åç»æï¼TCPå®ç°è¿æ¥ç®¡çãç¡®è®¤æºå¶ãè¶æ¶éä¼ ãæµéæ§å¶ãæ¥å¡æ§å¶è¿äºåè½é½ä½ç°å¨å®é¦é¨ä¸­åå­æ®µçä½ç¨ã\n\nTCPé¦é¨ç±ä¸¤é¨åææ ï¼20å­èçåºå®é¦é¨åæå¤§40å­èçæ©å±é¦é¨ãä¹å°±æ¯è¯´ï¼ä¸ä¸ªTCPé¦é¨çå­èæ°å¨20~60å­èä¹é´ã\n\n\n\næºç«¯å£ ï¼16æ¯ç¹ï¼å³ä¸¤å­èï¼åå¥æºç«¯å£å·ï¼ç¨äºæ è¯åéè¯¥TCPæ¥ææ®µçåºç¨è¿ç¨ã\n\nç®çç«¯å£ ï¼16æ¯ç¹ï¼å³ä¸¤å­èï¼åå¥ç®çç«¯å£å·ï¼ç¨äºæ è¯æ¥åè¯¥TCPæ¥ææ®µçåºç¨è¿ç¨ã\n\nåå¦æä»¬ä½¿ç¨webæå¡127.0.0.1:8080è¿ç¨è®¿é®MySQLæå¡å¨48.104.60.218:3306ï¼æºç«¯å£å°±æ¯æä»¬èªå·±çIPå°åä¸­çç«¯å£8080ï¼ç®çç«¯å£å°±æ¯MySQLæå¡å¨çIPå°åä¸­çç«¯å£3306ã\n\næ¥ä¸æ¥ççä¸TCPå®ç°å¯é æ§ä¼ è¾æå³çä¸ä¸ªå­æ®µ ï¼åºå·ãç¡®è®¤å·ãACKã\n\nåºå· ï¼å 32æ¯ç¹ï¼åå¼èå´[0, 2^32 - 1]ï¼åºå·å¢å å°æåä¸ä¸ªåï¼ä¸ä¸ä¸ªåºå·å°±ååå°0ãåºå·çå¼ç¨æ¥æåºæ¬TCPæ¥ææ®µ**æ°æ®è½½è·**ç¬¬ä¸ä¸ªå­èçåºå·ãå¦å¾æç¤ºï¼é¦é¨çåºå·å³ä¸ºæ°æ®è½½è·ç¬¬ä¸ä¸ªå­èçåºå·122ã\n\n\n\nç¡®è®¤å· ï¼å 32æ¯ç¹ï¼åå¼èå´[0, 2^32 - 1]ï¼ç¡®è®¤å¥½å¢å å°æåä¸ä¸ªåï¼ä¸ä¸ä¸ªç¡®è®¤å¥½ååå°0ãç¡®è®¤å·çå¼ç¨äºæåºæææ¶å°å¯¹æ¹ä¸ä¸ä¸ªTCPæ¥ææ®µçæ°æ®è½½è·çç¬¬ä¸ä¸ªå­èçåºå·ï¼åæ¶ä¹æ¯å¯¹ä¹åæ¶å°çæææ°æ®çç¡®è®¤ãå¯ä»¥è¿æ ·çè§£ï¼è¥ç¡®è®¤å·ä¸ºnï¼åä»£è¡¨ä¹åå·²ç»æåæ¥æ¶å°åºå·ä¸ºn-1çæ¥ææ®µï¼ä¸ä¸æ¬¡æææ¶å°åºå·ä¸ºnçæ¥ææ®µãåªæACKæ è¯çå¼ä¸º1æ¶ï¼ç¡®è®¤å·å­æ®µæææã\n\nACK ï¼ç¡®æ å¿ä½ï¼åå¼ä¸º1æ¶ç¡®è®¤å·æææï¼åå¼ä¸º0æ¶ç¡®è®¤å·æ æãTCPè§å®ï¼è¿æ¥å»ºç«åææçTCPæ¥ææ®µé½å¿é¡»æACKç½®ä¸º1ã\n\nå¦å¾ï¼å®¢æ·ç«¯åæå¡ç«¯åéä¸ä¸ªTCPæ°æ®æ¥ï¼åºå·ä¸º200ä»£è¡¨æ­¤æ°æ®æ¥çæ°æ®è½½è·é¨åçç¬¬ä¸ä¸ªå­èçåºå·ä¸º200ãç¡®è®¤å·ä¸º800ä»£è¡¨å®¢æ·ç«¯å·²ç»æ¶å°æå¡ç«¯åéçåºå·ä¸º799å·ä»¥åä¹åçæ°æ®æ¥ï¼ç°å¨æ³è¦åºå·ä¸º800çæ°æ®æ¥ãACKçå¼ä¸º1ä¿è¯ç¡®è®¤å·ææãæ°æ®è½½è·é¿åº¦ä»£è¡¨æ­¤æ¬¡ä¼ è¾çå­èæ°ãä¹å°±æ¯è¯´ï¼æ­¤æ¬¡ä¼ è¾çæ°æ®è½½è·é¨åçåºå·ä¸º 200 - 300ã\n\n\n\næ°æ®åç§» ï¼å 4æ¯ç¹ï¼å¹¶ä»¥4å­èä¸ºåä½ãç¨äºæåºTCPæ¥ææ®µçæ°æ®è½½è·é¨åçèµ·å§å¤è·ç¦»TCPæ¥ææ®µçèµ·å§å¤æå¤è¿ãè¿ä¸ªå­æ®µå®éä¸æ¯æåºäºTCPæ¥ææ®µçé¦é¨æå¤å°ä¸ªå­èãåæ¶ï¼å®çå¼æ¯é¦é¨å­èæ°é¤ä»¥4çãé¦é¨çå­èæ°èå´ä¸ºï¼20 ~ 60ï¼æä»¥æ°æ®åç§»å­æ®µçå¼èå´ä¸º 5~15ï¼å³ 0101å°1111ã\n\nä¿ç ï¼å 6æ¯ç¹ï¼ä¿çä»¥åä½¿ç¨ãç®åå¼ä¸º0ã\n\nçªå£ ï¼å 16æ¯ç¹ï¼ä»¥å­èä¸ºåä½ãæåºåéæ¬æ¥ææ®µçä¸æ¹çæ¥æ¶çªå£ãçªå£å¼ä½ä¸ºæ¥æ¶æ¹è®©åéæ¹è®¾ç½®å¶åéçªå£çä¾æ®ãè¿æ¯ä»¥æ¥æ¶æ¹çæ¥åè½åæ¥æ§å¶åéæ¹çåéè½åï¼ç§°ä¸ºæµéæ§å¶ãéè¦æ³¨æçæ¯ï¼åéçªå£çå¤§å°è¿åå³äºæ¥å¡çªå£çå¤§å°ï¼ä¹å°±æ¯ä»æ¥æ¶çªå£åæ¥å¡çªå£ä¸­åæå°å¼ã\n\næ ¡éªå ï¼å 16æ¯ç¹ï¼ç¨äºæ£æ¥æ´ä¸ªTCPæ¥ææ®µå¨ä¼ è¾è¿ç¨ä¸­æ¯å¦åºç°äºè¯¯ç ã\n\nç´§æ¥æé ï¼å 16æ¯ç¹ï¼ä»¥å­èä¸ºåä½ï¼ç¨æ¥ææç´§æ¥æ°æ®çé¿åº¦ãå½åéæ¹æç´§æ¥æ°æ®æ¶ï¼å¯å°ç´§æ¥æ°æ®æéå°åéç¼å­çæåé¢ï¼å¹¶ç«å»å°è£å°ä¸ä¸ªTCPæ¥æä¸­è¿è¡åéãç´§æ¥æéä¼æåºæ¬æ¥ææ®µæ°æ®è½½è·é¨ååå«äºå¤é¿çç´§æ¥æ°æ®ï¼ç´§æ¥æ°æ®ä¹åæ¯æ®éæ°æ®ã\n\nSYN ï¼åæ­¥æ å¿ä½ï¼å¨TCPè¿æ¥å»ºç«æ¶ç¨æ¥åæ­¥åºå·ãTCPè§å®ï¼SYNå¼ä¸º1æ¶ä»£è¡¨æ­£å¨å»ºç«è¿æ¥ï¼æ­¤æ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\nFIN ï¼ç»æ­¢æ å¿ä½ï¼ç¨äºéæ¾TCPè¿æ¥ãTCPè§å®ï¼FINå¼ä¸º1æ¶ä»£è¡¨æ­£å¨éæ¾è¿æ¥ï¼æ­¤æ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\nRST ï¼å¤ä½æ å¿ä½ï¼ç¨äºå¤ä½TCPè¿æ¥ãå½RSTä¸º1æ¶ï¼è¡¨ç¤ºTCPè¿æ¥åºç°äºå¼å¸¸ï¼æ­¤æ¶å¿é¡»åæ­å¼è¿æ¥ï¼åéæ°å»ºç«è¿æ¥ãRSTè¿ç¨æ¥æç»éæ³æ¥ææ®µææç»TCPè¿æ¥ã\n\nPSH ï¼æ¨éæ å¿ä½ï¼ç¨æ¥å®ç°æ¨éæä½ãå½æ¥åæ¹æ¶å°è¯¥æ å¿ä½ä¸º1çæ¥ææ®µä¼å°½å¿«ä¸äº¤åºç¨è¿ç¨ï¼èä¸å¿ç­å°æ¥æ¶ç¼å­é½å¡«æ»¡åååä¸äº¤ä»ã\n\nURG ï¼ç´§æ¥æ å¿ä½ï¼ä¸ç´§æ¥æéå­æ®µå±åå®ç°ç´§æ¥æä½ãç´§æ¥æ å¿ä½URGä¸º1æ¶ï¼ç´§æ¥æéææï¼ä¸º0æ¶ç´§æ¥æéæ æã\n\néé¡¹ ï¼éé¡¹ä¸­çå­æ®µé½æ¯å¯éå¼ï¼æ©å±åè½ãéé¡¹çå­èæ°å¯å\n\nå¡«å ï¼ç±äºéé¡¹çå­èæ°å¯åï¼é£å°±ä½¿ç¨å¡«åå­æ®µç¡®ä¿æ¥ææ®µé¦é¨è½è¢«4æ´é¤ãåå¦éé¡¹æ3å­èï¼é£ä¹å¡«åå°±åªæ1ä¸ªå­èã\n\nä¸ºä»ä¹ä¸å®è¦ç¡®ä¿é¦é¨å­èæ°è¦è½è¢«4æ´é¤ï¼å ä¸ºæ°æ®åç§»å­æ®µçå¼æ¯é¦é¨å­èæ°é¤ä»¥4ã\n\n\n\n\n# 3.2 å»ºç«è¿æ¥-ä¸æ¬¡æ¡æ\n\nTCPæ¯é¢åè¿æ¥çåè®®ï¼å®åºäºè¿è¾è¿æ¥æ¥ä¼ éTCPæ¥ææ®µãTCPè¿è¾è¿æ¥çå»ºç«åéæ¾æ¯æ¯ä¸æ¬¡é¢åå¨è¿æ¥çéä¿¡ä¸­å¿ä¸å¯å°çè¿ç¨ã\n\nTCPè¿è¾è¿æ¥åä¸ºä»¥ä¸ä¸ä¸ªé¶æ®µï¼\n\n 1. éè¿ä¸æ¬¡æ¡æå»ºç«TCPè¿æ¥\n 2. è¿è¡æ°æ®ä¼ è¾\n 3. éè¿åæ¬¡æ¥ææ­å¼TCPè¿æ¥\n\nåæ¥ä»ç»ä¸ä¸TCPè¿æ¥çå»ºç« ï¼ä¸æ¥ææ¡æ\n\næåï¼TCPå®¢æ·ç«¯ä¸TCPæå¡ç«¯çTCPè¿ç¨é½å¤äºå³é­ç¶æï¼å³CLOSEDã\n\nä¸å¼å§ï¼TCPæå¡ç«¯ååå»ºTCPä¼ è¾æ§å¶åï¼ç¨äºå­å¨TCPè¿æ¥ä¸­çä»¥ä¸éè¦ä¿¡æ¯ï¼ä¾å¦TCPè¿æ¥è¡¨ãæååéåæ¥åç¼å­çæéãæåéä¼ éåçæé...TCPæå¡ç«¯åå»ºä¼ è¾æ§å¶ååå°±è¿å¥çå¬ç¶æï¼LISTENï¼ç­å¾æ¥åTCPå®¢æ·ç«¯çè¿æ¥è¯·æ±ã\n\nTCPå®¢æ·ç«¯å¨åèµ·è¿æ¥è¯·æ±ä¹åä¹è¦åå»ºä¼ è¾æ§å¶åï¼ä¹ååèµ·è¿æ¥è¯·æ±ã\n\n\n\nç¬¬ä¸æ¬¡æ¡æ ï¼\n\nTCPå®¢æ·ç«¯è¿ç¨åTCPæå¡ç«¯è¿ç¨åéTCPè¿æ¥è¯·æ±æ¥ææ®µï¼å¹¶è¿å¥åæ­¥å·²åéç¶æï¼SYN-SENDï¼ã\n\næ­¤è¿æ¥è¯·æ±æ¥ææ®µé¦é¨ä¸­çå¼ï¼\n\n * SYN ï¼1ï¼è¡¨æè¿æ¯ä¸ä¸ªTCPè¿æ¥è¯·æ±æ¥ææ®µãåæ¶è§å®æ­¤æ¶çæ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\n * åºå·(seq) ï¼åå§å¼x\n\n\n\nç¬¬äºæ¬¡æ¡æ ï¼\n\nTCPæå¡ç«¯æ¥æ¶å°è¯·æ±è¿æ¥æ¥æåï¼å¦æåæè¿æ¥ï¼ä¼åTCPå®¢æ·ç«¯åé è¿æ¥è¯·æ±ç¡®è®¤æ¥ææ®µï¼å¹¶è¿å¥åæ­¥å·²æ¥åç¶æï¼SYN-RCVDï¼ã\n\nè¯¥æ¥ææ®µé¦é¨ä¸­çå¼ï¼\n\n * SYN ï¼1ï¼è¡¨æç°å¨æ­£å¨è¿è¡TCPè¿æ¥ãåæ¶è§å®æ­¤æ¶çæ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\n * ACK ï¼ä½¿ç¡®è®¤å·çæã\n\n * ç¡®è®¤å·(ack) ï¼ç±äºå®¢æ·ç«¯åéçåºå·ä¸ºxï¼é£ä¹ç¡®è®¤å·å°±æ¯x+1ï¼ä»£è¡¨âæå·²ç»æ¶å°åºå·ä¸ºxä»¥åä¹åçæ°æ®äºï¼ä½ ä¸æ¬¡ç»æåx+1å§âã\n\n * åºå·(seq) ï¼åå§å¼yã\n\nç¬¬ä¸æ¬¡æ¡æ ï¼\n\nTCPå®¢æ·ç«¯æ¶å°è¿æ¥è¯·æ±ç¡®è®¤æ¥ææ®µåï¼è¿éè¦åTCPæå¡ç«¯è¿ç¨åéä¸ä¸ª**æ®éçTCPç¡®è®¤æ¥ææ®µï¼å¹¶è¿å¥è¿æ¥å·²å»ºç«ç¶æï¼ESTABLISHEDï¼ãç±äºæ¯ä¸ä¸ªæ®é**çè¿æ¥å»ºç«æ¥ææ®µï¼æä»¥å®çSYNå­æ®µå¼å¹¶ä¸ä¸º1ï¼æä»¥è¿ä¸ªæ¥ææ®µå¯ä»¥æºå¸¦æ°æ®ï¼ä½æ¯å®ä¸æºå¸¦æ°æ®ã\n\nï¼TCPè§å®ï¼SYNä¸º1çæ¥ææ®µä¸è½æºå¸¦æ°æ®ï¼æ¥ææ®µåéæ¶æ¶èä¸ä¸ªåºå·ãSYNä¸ä¸º1çæ¥ææ®µå¯ä»¥æºå¸¦æ°æ®ï¼å¦æä¸æºå¸¦æ°æ®ï¼ä¸æ¶èåºå·ï¼\n\nè¯¥æ¥ææ®µçé¦é¨å¼ï¼\n\n * ACK ï¼1ï¼ä¿è¯ç¡®è®¤ä½å¯ç¨ã\n * åºå·(seq) ï¼x+1ï¼å ä¸ºTCPæå¡ç«¯ä¸æ¬¡åçæ¥æä¸­çç¡®è®¤å·ä¸ºx+1ãç±äºSYNå¼ä¸ä¸º1ï¼å¹¶ä¸æ²¡ææºå¸¦æ°æ®ï¼æx+1è¿ä¸ªåºå·ä¸æ¬¡è¿è½ç¨ï¼ä¹å°±æ¯å»ºç«è¿æ¥åè¿å¯ä»¥åä½¿ç¨ä¸æ¬¡x+1è¿ä¸ªåºå·ã\n * ç¡®è®¤å·(ack) ï¼y+1ï¼å ä¸ºTCPæå¡ç«¯ä¸æ¬¡åéçæ¥ææ®µçåºå·ä¸ºyï¼æä»¥æä»¬è¿æ¬¡åéy+1ï¼è¡¨ç¤ºæä»¬å·²ç»æ¥æ¶å°äºåºå·yä»¥åä¹åçæ°æ®ï¼ä¸æ¬¡æä»¬æ³è¦åºå·ä¸ºy+1çæ°æ®ã\n\n\n\nå½TCPæå¡ç«¯æ¥æ¶å°TCPå®¢æ·ç«¯ç¬¬äºæ¬¡æ¥ææ¶ï¼æå¡ç«¯ä¹è¿å¥è¿æ¥å·²å»ºç«ç¶æï¼ESTABLISHEDï¼ã\n\n\n\nç°å¨ï¼åæ¹é½å·²è¿å¥è¿æ¥å»ºç«ç¶æï¼å¯ä»¥æ ¹æ®å·²ç»å»ºç«å¥½çTCPè¿æ¥è¿è¡å¯é çæ°æ®ä¼ è¾ã\n\n> é£ä¹ä¸ºä»ä¹å»ºç«TCPè¿æ¥ä¸å®éè¦ä¸æ¬¡å¢ï¼ä¸ºä»ä¹ä¸è½æ¯ä¸¤æ¬¡ï¼ä¸ºä»ä¹ä¸è½ä½¿ç¨ä¸¤æ¬¡æ¥ææ¡æå»ºç«è¿æ¥å¢ï¼\n\næ¥ä¸æ¥ççä¸¤æ¥ææ¡æä¼åºç°çé®é¢ ï¼\n\nTCPå®¢æ·ç«¯ååºè¯·æ±è¿æ¥æ¥æï¼ä½æ¯å ä¸ºç½ç»é®é¢é¿æ¶é´åæ»å¨ç½ç»ä¸­ï¼äºæ¯è§¦åè¶æ¶éä¼ æºå¶ï¼TCPå®¢æ·ç«¯éæ°åèµ·TCPè¿æ¥è¯·æ±æ¥ææ®µï¼è¿æ¬¡æåå»ºç«è¿æ¥ãä¹åä¾¿æ¯æ°æ®çä¼ è¾ï¼æåæ°æ®ä¼ è¾å®æï¼æå¡ç«¯ä¸å®¢æ·ç«¯æ­å¼è¿æ¥ã\n\n\n\næ­å¼è¿æ¥åçªç¶ï¼ä¸æ¬¡å ä¸ºç½ç»é®é¢æ»åçTCPè¿æ¥è¯·æ±åéå°äºTCPæå¡ç«¯ï¼æå¡ç«¯ä»¥ä¸ºå®¢æ·ç«¯æ³è¦åæ¬¡å»ºç«TCPè¿æ¥ï¼äºæ¯æå¡ç«¯è¿å¥çå¬ï¼LISTENï¼ç¶æå¹¶åå®¢æ·ç«¯åéè¿æ¥è¯·æ±ç¡®è®¤æ¥æï¼ä½æ¯å®¢æ·ç«¯æ­¤æ¶ä¸ºå³é­ç¶æï¼å¯¹è¿æ¥è¯·æ±ç¡®è®¤æ¥æä¸äºçç¬ï¼äºæ¯æå¡ç«¯ä¸ç´å¤äºçå¬ç¶æå¹¶åéè¿æ¥è¯·æ±ç¡®è®¤æ¥æãè¿å°±é æäºTCPæå¡ç«¯èµæºçæµªè´¹ã\n\n\n\nç»¼ä¸æè¿°ï¼éç¨ä¸æ¥ææ¡æèä¸æ¯ä¸¤æ¥ææ¡ææ¯ä¸ºäºé²æ­¢å·²å¤±æçè¿æ¥è¯·æ±æ¥ææ®µçªç¶ä¼ éå°äºTCPæå¡ç«¯å èå¯¼è´çéè¯¯ã\n\n\n# 3.3 éæ¾è¿æ¥-åæ¬¡æ¥æ\n\nTCPéè¿åæ¬¡æ¥ææ¥ç»æTCPçè¿æ¥ã\n\nå¨æ­å¼è¿æ¥ä¹åï¼å®¢æ·ç«¯ä¸æå¡ç«¯é½å¤äºè¿æ¥å·²å»ºç«ç¶æï¼ESTABLISHEDï¼ã\n\nç¬¬ä¸æ¬¡æ¥æ ï¼\n\nTCPå®¢æ·ç«¯ä¼åéTCPè¿æ¥éæ¾æ¥ææ®µï¼è¿å¥ç»æ­¢ç­å¾1ç¶æï¼FIN-WAIT-1ï¼ãTCPè¿æ¥éæ¾æ¥ææ®µçå­æ®µå¼ä¸ºï¼\n\n * FIN ï¼1ï¼ä»£è¡¨æ­¤æ¶æ­£å¨éæ¾TCPè¿æ¥ï¼æ­¤æ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n * ACK ï¼ä½¿ç¡®è®¤å·çæã\n * seq(åºå·) ï¼uï¼ä»£è¡¨æ­¤æ¥ææ®µçæ°æ®è½½è·çç¬¬ä¸ä¸ªå­èçåºå·ä¸ºuã\n * ack(ç¡®è®¤å·) ï¼vï¼ä»£è¡¨å·²ç»æ¶å°åºå·ä¸ºv-1çæ°æ®ï¼ä¸æ¬¡æ³è¦åºå·ä¸ºvçæ°æ®ã\n\n\n\nç¬¬äºæ¬¡æ¥æ ï¼\n\næå¡ç«¯æ¥æ¶å°å®¢æ·ç«¯åéçTCPè¿æ¥éæ¾æ¥ææ®µåï¼ä¼åå®¢æ·ç«¯åéä¸ä¸ªæ®éçTCPç¡®è®¤æ¥ææ®µï¼å¹¶è¿å¥å³é­ç­å¾ç¶æï¼CLOSE-WAITï¼ã\n\nï¼æ­¤æ¶çTCPè¿æ¥è¿å¥äºåå³é­ç¶æï¼å ä¸ºå®¢æ·ç«¯å°æå¡ç«¯çTCPè¿æ¥è¿å¥å³é­ç¶æï¼å ä¸ºå®¢æ·ç«¯å·²ç»æ²¡ææ°æ®è¦åéäºï¼ä½æ¯æå¡ç«¯å°å®¢æ·ç«¯çTCPè¿æ¥ééè¿æ²¡å³é­ï¼å ä¸ºæå¡ç«¯è¦ç»§ç»­åéé£äºè¿æªåéå®æ¯çæ°æ®ãï¼\n\næ­¤æ¥ææ®µçå­æ®µå¼ ï¼\n\n * ACK ï¼1ï¼ä¿è¯ç¡®è®¤å·ææ\n * åºå·(seq) ï¼vï¼ä»£è¡¨æ­¤æ¥ææ®µçæ°æ®è½½è·çç¬¬ä¸ä¸ªå­èçåºå·ä¸ºvã\n * ç¡®è®¤å·(ack) ï¼u+1ï¼ä»£è¡¨å·²ç»æ¶å°å®¢æ·ç«¯åéçç¬¬uæ¡æ°æ®ï¼ä¸æ¬¡æ³è¦u+1ã\n\nTCPå®¢æ·ç«¯æ¶å°TCPæå¡ç«¯åéçTCPç¡®è®¤æ¥ææ®µåå°±ä¼è¿å¥ç»æ­¢ç­å¾2ç¶æï¼FIN-WAIT2ï¼ã\n\n\n\nç¬¬ä¸æ¬¡æ¥æ ï¼\n\nå½TCPæå¡ç«¯ææå©ä½æ°æ®åéå®æ¯åï¼TCPæå¡ç«¯ä¼åéTCPè¿æ¥éæ¾æ¥ææ®µï¼å¹¶è¿å¥æåç¡®è®¤ç¶æï¼LAST-ACKï¼ã\n\nè¯¥æ¥ææ®µçå­æ®µï¼\n\n * FIN ï¼1ï¼è¡¨ç¤ºæ­£å¨éæ¾è¿æ¥ã\n * ACK ï¼1ï¼ä¿è¯ç¡®è®¤å·ææã\n * åºå·(seq) ï¼wï¼ä¸ºä»ä¹ä¸æ¯v+1ï¼å ä¸ºç¬¬äºæ¬¡æ¥æä¹åå¯è½ä¼ è¾äºå¶ä»å©ä½æ°æ®æ¥ã\n * ç¡®è®¤å·(ack) ï¼u+1ãä¸ºä»ä¹æ¯u+1ï¼ä¸æ¯ååéäºå©ä½æ°æ®åï¼å ä¸ºå©ä½æ°æ®æ¥åªæ¯æå¡ç«¯åå®¢æ·ç«¯åéï¼å®¢æ·ç«¯åæå¡ç«¯çTCPè¿æ¥ééå·²ç»æ­å¼ã\n\n\n\nç¬¬åæ¬¡æ¥æï¼\n\næ¶å°æå¡ç«¯åéçTCPè¿æ¥éæ¾æ¥ææ®µåï¼å®¢æ·ç«¯åéæ®éçç¡®è®¤æ¥ææ®µï¼ä¹åè¿å¥æ¶é´ç­å¾ç¶æï¼TIME-WAITï¼ã\n\næ¶å°è¯¥æ¥ææ®µåï¼æå¡ç«¯å³é­ãå¤äºæ¶é´ç­å¾ç¶æ2MSL(2mins)åï¼å®¢æ·ç«¯TCPè¿æ¥å³é­ã\n\nè¯¥æ¥æå­æ®µå¼ ï¼\n\n * ACK ï¼1ï¼ä¿è¯ç¡®è®¤å·ææ\n * åºå·(seq) ï¼u+1\n * ç¡®è®¤å·(ack) ï¼w+1\n\n> ä¸ºä»ä¹å®¢æ·ç«¯è¿è¦ç­å¾ä¸¤åéåå³é­TCPè¿æ¥å¢ï¼\n> \n> åå¦ä¸è¿è¡ç­å¾èç´æ¥å³é­ï¼ä¹å°±æ¯å®¢æ·ç«¯åéç¬¬åæ¬¡æ¥æä¹åç«å³å³é­TCPè¿æ¥ãé£ä¹å¦ææåä¸ä¸ªç¡®è®¤æ¥æä¸¢å¤±ï¼æ­¤æ¶å®¢æ·ç«¯å·²ç»å³é­ï¼ä½æå¡ç«¯è¿å¨ç­å¾æåçç¡®è®¤ä¿æ¥æï¼ä¸ç´æ²¡ç­å°å°±ä¼è§¦åè¶æ¶éä¼ æºå¶åéç¬¬ä¸æ¬¡æ¥ææ¥æï¼ä½æ¯å®¢æ·ç«¯å·²ç»å³é­ï¼é£ä¹æå¡ç«¯å°±ä¼ä¸ç´åéç¬¬ä¸æ¬¡æ¥ææ¥æï¼éå¸¸æµªè´¹èµæºãèç­å¾ä¸¤åéå°±å¯ä»¥è§£å³è¿ä¸ªé®é¢ï¼å®¢æ·ç«¯æè¶³å¤æ¶é´ç­å¾æå¡ç«¯åéçè¶æ¶éä¼ æ¥æã\n\n\n\nè³æ­¤ï¼åæ¥ææ¥æè¿ç¨å®æ¯ã\n\næ¥ä¸æ¥ççä¿æ´»è®¡æ¶å¨ ï¼\n\nå¨å®¢æ·ç«¯ä¸æå¡ç«¯å»ºç«è¿æ¥åï¼å¦æå®¢æ·ç«¯åºç°æéï¼åºå½ææªæ½è®©æå¡ç«¯ä¸»å¨æ­å¼è¿æ¥èä¸æ¯ä¸ç´ç­å¾ä¸å»ãè¿æ¶å°±è¦ä½¿ç¨å°ä¿æ´»è®¡æ¶å¨ã\n\n * TCPæå¡å¨è¿ç¨æ¯æ¶å°ä¸æ¬¡TCPå®¢æ·è¿ç¨çæ°æ®ï¼å°±éæ°è®¾ç½®å¹¶å¯å¨ä¿æ´»è®¡æ¶å¨(å®æ¶2å°æ¶)ã\n * è¥2å°æ¶åæ²¡æ¥æ¶å°TCPå®¢æ·ç«¯åéçæ°æ®ï¼åå½ä¿æ´»è®¡æ¶å¨å°æ¶åï¼TCPæå¡å¨åTCPå®¢æ·ç«¯åéä¸ä¸ªæ¢æµæ¥ææ®µï¼ä»¥ååæ¯75ç§åéä¸æ¬¡ï¼è¥è¿ç»­10ä¸ªæ¥ææ®µé½æ ååºï¼TCPæå¡ç«¯ä¸»å¨æ­å¼TCPè¿æ¥ã\n\n\n# 3.4 TCPæµéæ§å¶\n\nä¸ºä»ä¹éè¦æµéæ§å¶ï¼ä¸è¬æ¥è¯´ï¼æä»¬æ´å å¸æä¼ è¾éåº¦è¶å¿«è¶å¥½ï¼ä½æ¯å¦æåéæ¹åéæ°æ®çéåº¦è¿å¿«ï¼ä¼å¯¼è´æ¥åæ¹æ¥ä¸åæ¥æ¶ï¼è¿å°±ä¼é ææ°æ®çä¸¢å¤±ã\n\næä»¥æµéæ§å¶å°±æ¯ä¸ºäºè®©åéæ¹åéçéçä¸è¦å¤ªå¿«ï¼è¦è®©æ¥åæ¹æ¥å¾åæ¥æ¶ã\n\nTCPçæµéæ§å¶æ¯éè¿æ»å¨çªå£æ¥å®ç°çãå¦ææ­¤æ¶AåBä¼ è¾æ°æ®ï¼å¨ä¼ è¾æ°æ®åBåè¯Aï¼æçæ¥æ¶çªå£rwnd=400(receiver window)ãè¿è¡¨ç¤º ï¼åéæ¹Açåéçªå£ä¸è½è¶è¿æ¥åæ¹Bçæ¥æ¶çªå£çå¼ï¼ä¹å°±æ¯400å­èã\n\nåå¦Bæåçæ¥æ¶çªå£å¤§å°ä¸º400ï¼é£ä¹Aå¯ä»¥åé400å­èçæ°æ®ãBæ¥æ¶400å­èæ°æ®å¹¶åéç¡®è®¤åï¼è¿400å­èçæ°æ®ä¼åä»Açåéç¼å­ä¸­å é¤ãç°å¨AæååBåéäº400å­èçæ°æ®ï¼ä½æ¯Bçæ¥æ¶ç¼å­æ²¡å¤å°ç©ºé´äºï¼äºæ¯Bå¯¹Aè¯´ï¼æçæ¥æ¶çªå£ä¸ºrwnd=300ãè¿è¡¨ç¤ºåéæ¹Açåéçªå£ä¸è½è¶è¿300å­èãå°±è¿æ ·ï¼å¦æåéåBçåéç¼å­è¿æ²¡è¾åºç©ºé´ï¼ä¼ç»§ç»­åå°æ¥æ¶çªå£ç´å°Bçåéç¼å­æ²¡æç©ºé´ï¼è¿æ¶BåAåéçrwnd=0ï¼å³é¶çªå£éç¥ï¼ä»£è¡¨ä¸è¦ååéæ°æ®äºï¼ç­æè¾åºç©ºé´åè¯´å§ã\n\n> å¦æAåéçæ°æ®ä¸¢å¤±æä¹åå¢ï¼\n\nAç»Båéæ¶æ¯ï¼å¦ææ°æ®ä¸¢å¤±ï¼å¹¶ä¸ä¼å½±åAåç»­æ°æ®çåéï¼Båéçackæ¶æ¯ä¼åè¯Aåªäºæ°æ®è¿æ²¡æåéï¼å°æ¶Aéæ°åéå³å¯ã\n\n> å¦æBåéçrwndä¸¢å¤±æä¹åå¢ï¼\n\nå¦æBåéç»Açrwndä¸¢å¤±ï¼Aä¸ç´å¨ç­å¾Båéççªå£éç¥(rwnd)ä»¥ä¾¿è®¾ç½®èªå·±çåéçªå£ï¼èä¸»æºBä»¥ä¸ºAå·²ç»æ¥æ¶å°çªå£éç¥ï¼ä»å°±ä¸ç´ç­å¾Aåéçæ°æ®ï¼è¿å°±ä¼é ææ­»éçå±é¢ãä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼TCPä¸ºæ¯ä¸ä¸ªè¿æ¥è®¾ç½®ä¸ä¸ªæç»­å®æ¶å¨ã\n\nå¦æBç»Aåéé¶çªå£éç¥ï¼æç»­è®¡æ¶å¨ä¼éæ°è®¡æ¶ï¼å½æç»­è®¡æ¶å¨è¶æ¶æ¶ï¼è¯æå·²ç»å¾ä¹æ²¡ææ¶å°é¶çªå£éç¥äºï¼Aå°±ç»Båéä¸ä¸ªæ¢æµæ¥æï¼Bæ¥æ¶è¯¥æ¥æåï¼å°èªå·±çæ¥æ¶çªå£å¼åéç»Aï¼å¦ææ­¤å¼ä¸º0ï¼åæç»­è®¡æ¶å¨éæ°è®¡æ¶ï¼å¦ææ­¤å¼ä¸ºå¶ä»å¼ï¼Aå°å¶åéçªå£å¤§å°è®¾ç½®ä¸ºæ­¤å¼ãäºæ¯æ­»éé®é¢å¾ä»¥è§£å³ã\n\n\n# 3.5 TCPæ¥å¡æ§å¶\n\næ¥å¡ ï¼å¯¹ç½ç»ä¸­æä¸èµæºçéæ±è¶è¿äºè¯¥èµæºæè½æä¾çå¯ç¨é¨åï¼ç½ç»æ§è½å°±è¦ååãè¿ç§æåµå«åæ¥å¡ï¼congestionï¼ã\n\nè¥åºç°æ¥å¡èä¸è¿è¡æ§å¶ï¼æ´ä¸ªç½ç»çååéå°éè¾å¥è´è·çå¢å¤§èä¸éã\n\nTCPå¯¹æ¥å¡æ§å¶æä¾äºåç§ç®æ³ ï¼\n\n 1. æ¢å¼å§ï¼slow-startï¼\n 2. æ¥å¡é¿åï¼congestion avoidanceï¼\n 3. å¿«éä¼ ï¼fast retransmitï¼\n 4. å¿«æ¢å¤ï¼fast recoveryï¼\n\nä¸ºäºç®åèµ·è§ï¼æä»¬åè®¾åéæ¹Aï¼æ¥æ¶æ¹Bï¼Aåªåéæ°æ®æ¥ï¼Båªåéç¡®è®¤æ¥ãå¹¶ä¸æ¥æ¶æ¹çæ¥æ¶çªå£è¶³å¤å¤§ï¼æ­¤æ¶åéæ¹çåéçªå£å°±åªåæ¥å¡æ§å¶çå½±åã\n\nåéæ¹ç»´æ¤ä¸ä¸ªå«åæ¥å¡çªå£cwndçç¶æåéï¼å¶å¼åå³äºç½ç»çæ¥å¡ç¨åº¦ï¼å¹¶ä¸å¨æååã\n\n * æ¥å¡çªå£cwndçç»´æ¤ååï¼åªè¦ç½ç»æ²¡æåºç°æ¥å¡ï¼æ¥å¡çªå£å°±åå¢å¤§ä¸äºãç½ç»åºç°æ¥å¡ï¼æ¥å¡çªå£å°±åå°ä¸äºã\n * å¤æ­åºç°ç½ç»æ¥å¡çä¾æ®ï¼æ²¡æææ¶æ¶å°åºå½å°è¾¾çç¡®è®¤æ¥ææ®µï¼å³åçè¶æ¶ï¼\n\nåéæ¹å°æ¥å¡çªå£ä½ä¸ºåéçªå£swndï¼å³swnd = cwndã\n\nå·ä½çæ¥å¡æ§å¶å¯ä»¥åè ï¼https://juejin.cn/post/6844903664566403085\n\nå®å¨æ¯è®²ä¸åºæ¥ð¢\n\n\n# 3.6 TCPå¯é ä¼ è¾çå®ç°\n\nTCPåºäºä»¥å­èä¸ºåä½çæ»å¨çªå£æ¥å®ç°å¯é ä¼ è¾ã\n\nå¦å¾Aä¸Bå»ºç«äºTCPè¿æ¥\n\nï¼ç®åèµ·è§ï¼æä»¬åè®¾æ°æ®åæ¹é¢åéå¹¶ä¸æ²¡ææ¥å¡å½±åï¼å³Aåéæ°æ®æ¥ææ®µï¼Båªåéç¡®è®¤æ¥ææ®µï¼å¹¶ä¸åéçªå£ä¸ä¼åå°æ¥å¡æ§å¶çå½±åï¼\n\nä¸æ¹è¡¨æ ¼ä¸ºå¾ä¼ è¾çæ°æ®çåºå·ã\n\n\n\nè¿æ¥å»ºç«åBç»Aåéä¸ä¸ªç¡®è®¤æ¥ææ®µï¼rwnd=20, ack=23ï¼ä»£è¡¨æ»å¨çªå£å¤§å°ä¸º20ï¼ä¸ä¸æ¬¡ç»æä¼ åºå·ä¸º23çæ°æ®ã\n\nåéæ¹æ¥æ¶å°è¿ä¸ªç¡®è®¤æ¥ææ®µåæé åºèªå·±çåéçªå£ï¼å¤§å°ä¸º20å­èï¼åéçªå£ä»åºå·ä¸º23çæ°æ®å¼å§ï¼å®ç§°ä¸ºåæ²¿ï¼ç´å°åºå·ä¸º42çæ°æ®ç»æï¼å®ç§°ä¸ºåæ²¿ã\n\nå¹¶ä¸ï¼ç±äºack=23ï¼åéæ¹Aå¯ä»¥å°23å·ä»¥åçæ°æ®ä»åéç¼å­ä¸­å é¤ï¼å¨æ¥æ¶å°ackä¹åï¼åéçªå£ä¸­çæ°æ®é½è¦çå¨åéç¼å­ä¸­ã\n\nåéçªå£ä¸­çæ°æ®é½æ¯å¯ä»¥åéçæ°æ®ï¼åéçªå£åæ²¿å³è¾¹çæ°æ®é½æ¯ä¸åè®¸åéçæ°æ®ã\n\nåæ²¿çç§»å¨æåµæä¸¤ç§ ï¼ä¸å¨ãåç§»\n\nåæ²¿çç§»å¨æåµæä¸ç§ ï¼ä¸å¨ãåç§»ãåç§»ã\n\næ¥ä¸æ¥AåBåé10ä¸ªå­èçæ°æ®ï¼åºå·ä¸º23-33çæ°æ®è¢«åéåºå»ï¼ä½æ¯å¹¶ä¸ä¼ä»åéç¼å­ä¸­å é¤ï¼å ä¸ºè¿æ²¡ææ¶å°ç¡®è®¤ackã\n\n\n\nåå¦æ¥æ¶æ¹Bæ¶å°äºåºå·ä¸º25-27çæ°æ®ï¼ç±äº23-24çæ°æ®è¿æ²¡æ¥æ¶å°ï¼æä»¥Båéçç¡®è®¤æ¥æçç¡®è®¤å·ä»ä¸º23ãè¿æ¯æ¥æ¶æ¹å¯¹23å·æ°æ®åèµ·çç¬¬ä¸æ¬¡éå¤ç¡®è®¤ï¼å æ­¤ä¸ä¼è§¦åè¶æ¶éä¼ æºå¶ãåæ¶æ¥æ¶çªå£ä¸º20æ²¡åã\n\n\n\nå½ä»¥å23-24å·æ°æ®ä¼ å°æ¥æ¶æ¹ï¼æ¥æ¶æ¹å°±ä¼åéå¯¹äº23-27å·æ°æ®çç¡®è®¤æ¥æï¼å¦ærwndçå¼ä»ä¸º20ï¼æ¥æ¶æ¹å°±ä¼å°æ¥æ¶çªå£ç§»å¨å°28-47å·æ°æ®ã\n\nåéæ¹æ¶å°è¯¥ç¡®è®¤æ¥æåå°23-27å·æ°æ®ä»åéç¼å­ä¸­å é¤ãåæ¶åéçªå£ç§»å¨å°28-47å·æ°æ®ã\n\n\n\nå½åéæ¹åéçæ°æ®è¿è¿æ æ³å°è¾¾æ¥æ¶æ¹ï¼éä¼ è®¡æ¶å¨è¶æ¶ï¼ä¼éä¼ åéçªå£åå·²åéçæ°æ®ï¼å¹¶éæ°å¯å¨éä¼ è®¡æ¶å¨ã\n\næ³¨æ ï¼\n\n 1. è½ç¶åéæ¹çåéçªå£æ¯æ ¹æ®æ¥æ¶æ¹çæ¥æ¶çªå£è®¾ç½®çï¼ä½æ¯å¨åä¸æ¶å»ï¼åéæ¹çåéçªå£å¹¶ä¸æ»æ¯åæ¥æ¶æ¹çæ¥æ¶çªå£ä¸æ ·å¤§ã\n    \n    å ä¸ºç½ç»å·æä¸å®çå»¶æ¶æ§ã\n\n 2. å¯¹äºä¸æåºåå·å°è¾¾çæ°æ®åºè¯¥å¦ä½å¤çï¼TCPå¹¶æ æç¡®è§å®\n    \n    * å¦æä¸¢å¼ï¼è½ç¶å®ç°æ´ç®åäºï¼ä½æ¯ä¼æµªè´¹å¾å¤ç½ç»èµæºã\n    * éå¸¸å­å¨å¨æ¥æ¶çªå£ä¸­ï¼ç­å°å­èæµä¸­æç¼ºå°çå­èæ¶å°åï¼åæåºå·äº¤ä»ç»ä¸å±çåºç¨è¿ç¨ã\n\n 3. TCPè¦æ±æ¥æ¶æ¹å¿é¡»æç´¯ç§¯ç¡®è®¤åæå¸¦ç¡®è®¤æºå¶ï¼è¿æ ·å¯ä»¥åå°ä¼ è¾å¼éãæ¥æ¶æ¹å¯ä»¥å¨åéçæ¶ååéç¡®è®¤ï¼ä¹å¯ä»¥å¨èªå·±ææ°æ®è¦åéæ¶æç¡®è®¤ä¿¡æ¯æå¸¦ä¸ãä½æ¯æ¥æ¶æ¹ä¸åºè¯¥è¿åæ¨è¿åéç¡®è®¤æ¶æ¯ï¼å¦åä¼è§¦åè¶æ¶éä¼ æµªè´¹èµæºã\n\n 4. TCPæ¯å¨åå·¥éä¿¡ï¼éä¿¡åæ¹é½å¨åéåæ¥åæ¥ææ®µï¼å æ­¤ï¼æ¯ä¸æ¹é½æèªå·±çåéçªå£åæ¥æ¶çªå£ãå¨è°å°è¿äºçªå£æ¶ï¼ä¸å®è¦åºåå¼ã\n\n\n# 3.7 TCPè¶æ¶éä¼ \n\nåæä¸ç´åè¯´å¦ææä¸æ®µæ¥æè¿è¿æ²¡æåéä¼è§¦åè¶æ¶éä¼ ï¼ä½å¹¶æ²¡æè¯´å¦ä½éæ©éä¼ çæ¶æºï¼ç°å¨å°±æ¥è¯´è¯´TCPå¯¹äºè¶æ¶éä¼ çæ¶æºéæ©ã\n\nè¶æ¶éä¼ æ¶é´ï¼RTOï¼çéæ©æ¯è®¡ç®æºç½ç»æå¤æçé®é¢ä¹ä¸ã\n\nåå¦åéæ¹ä¸ºAï¼æ¥æ¶æ¹ä¸ºBãåéæ¹Aåæ¥æ¶æ¹Båéæ°æ®æ¥ï¼å¹¶è®°å½æ¶é´ï¼Aæ¶å°Bçè¿åçç¡®è®¤æ¥ææ®µååæ¬¡è®°å½æ¶é´ã\n\nè¿ä¸¤ä¸ªæ¶é´çå·®å¼ä¸ºå¾è¿æ¶é´RTTãå¦æè¶æ¶éä¼ æ¶é´è®¾ç½®çæ¯RTTå°å¾å¤ï¼ä¼è§¦åä¸å¿è¦çéä¼ ãå¦æè®¾ç½®çæ¯RTTå¤§å¾å¤ï¼è¿è¿ä¸è¶æ¶éä¼ å¤ªå½±åæçãæä»¥æä»¬è¦æ¾å°ä¸ä¸ªæ­£å¥½çæ¶é´ï¼è¿ä¸ªæ¶é´æ¯RTTå¤§ä¸ç¹ï¼ä½å¤§çä¸å¤ã\n\n\n\nå¬èµ·æ¥å¾ç®åï¼ä½æ¯å¤æçç½ç»ç¯å¢ä½¿ä¼ è¾éçå¤æå¤åï¼RTTä¹è·çååï¼æ©ä¸è·æä¸çç½ç»éçå·®å«é½å¾å¤§ãæä»¥è¶æ¶éä¼ æ¶é´ï¼RTOï¼çéæ©æ¯è®¡ç®æºç½ç»æå¤æçé®é¢ä¹ä¸ã\n\nè¿æ¶åå°±ä¸è½ä»¥åæ¬¡RTTçå¼ç¡®å®RTOçå¼ï¼èæ¯ä½¿ç¨å¾å¤æ¬¡RTTçå¼éè¿ä¸å®çç®æ³æ¥è®¡ç®åºä¸ä¸ªæ´å åéçRTOã\n\næä»¬ä½¿ç¨RTTä»£è¡¨éè¿è®¡ç®å¾åºçRTTçå¼ï¼RTT(i)ä»£è¡¨æ¯ä¸æ¬¡TCPéä¿¡äº§ççRTTå¼\n\nå½ç¬¬ä¸æ¬¡RTTäº§çæ¶ï¼æç»RTTçå¼ç­äºç¬¬ä¸æ¬¡RTTçå¼ãRTT = RTT(1)\n\nRTTå¤èµ·æ¥çæ¶åï¼ä½¿ç¨å¬å¼ ï¼\n\n> RTT = (1-a)* ä¸ä¸æ¬¡RTT + a*RTT(i)\n\nå¨ä¸å¼ä¸­ï¼0 â¤ a < 1ï¼è¥aæ¥è¿äº0ï¼åRTT(i)å¯¹RTTçå¼çå½±åä¸å¤§ãè¥aæ¥è¿äº1ï¼åRTT(i)å¯¹RTTçå½±åè¾å¤§ãæ åRFC298å»ºè®®açå¼ä¸º1/8\n\nå½éè¿æ¯ä¸æ¬¡çæ ·æ¬è®¡ç®å¾åºæç»RTTåï¼æä»¬å°±å¯ä»¥è§å®è¶æ¶éä¼ æ¶é´RTOç¥å¤§äºRTTäºã\n\n> è³æ­¤ï¼TCPå°±åä¸æ®µè½äºã\n\n\n# 4. UDP\n\nç±äºUDPååºç¨å±æä¾æ è¿æ¥ä¸å¯é çéä¿¡æå¡ï¼æä»¥å®æ éåTCPé£æ ·å®ç°æµéæ§å¶ãæ¥å¡æ§å¶ç­ç­åè½ï¼å®çå­æ®µä¹ååç®åã\n\nä¸ä¸ªUDPç¨æ·æ°æ®æ¥åæ ·ç±é¦é¨ä¸æ°æ®è½½è·ä¸¤é¨åç»æï¼é¦é¨æ ¼å¼å¦å¾æç¤ºã\n\n\n\nå®åªæåä¸ªå­æ®µï¼æ¯ä¸ªå­æ®µä¸¤ä¸ªå­èå±å«ä¸ªå­èãç±äºUDPæä¾æ è¿æ¥ä¸å¯é çæå¡ï¼æä»¥å®åªå¨ç½éå±çåºç¡ä¸æ·»å äºç«¯å£å·çåºåã\n\n> è³æ­¤ï¼UDPåä¸æ®µè½ãããææªï¼UDPçåè½ä¼å¨ä¸å°èUDPä¸TCPçåºå«ä¸­æ³¨æãå ä¸ºå®å¨å¤ªå°ããã\n\n\n# 5.TCPä¸UDPçåºå«\n\nTCPä¸UDPææçåºå«é½æ¯åºäºä¸ä¸ªæ¡ä»¶ ï¼TCPæä¾æè¿æ¥å¯é æ§ä¼ è¾æå¡ï¼UDPæä¾æ è¿æ¥ä¸å¯é æå¡ã\n\nå¦æTCPä¸æä¾å¯é æå¡ï¼é£ä»ä¿©å°±ä¸æ ·äºã\n\n 1. TCPä¼ è¾æ°æ®åéè¦ä¸æ¥ææ¡æå»ºç«è¿æ¥ï¼ä¼ è¾æ°æ®ç»ææ¶åæ¥ææ¥ææ­å¼è¿æ¥ã\n    \n    UDPå¯ä»¥éæ¶åéæ°æ®ãåªè¦ä½ ç¥éå®çIPå°±å¯ä»¥çªç¶åéæ°æ®ã\n\n 2. TCPåªæ¯æä¸å¯¹ä¸çsoloæ¨¡å¼ï¼è¿æ¥åªè½å¨ä¸¤ä¸ªä¸»æºä¹é´è¿è¡ã\n    \n    UDPæ¯æåæ­ãå¤æ­ãå¹¿æ­ã\n\n 3. å½åºç¨å±æ¥æåéå°ä¼ è¾å±æ¶\n    \n    TCPå°åºç¨å±ä¼ è¾çæ¥ææåä¸ºå¤ä¸ªå­èæµæ ä¸åºå·ï¼åå ä¸TCPé¦é¨å°è£ä¸ºTCPæ°æ®æ¥ï¼åæ ¹æ®åéç­ç¥åéç»ä¸å±ãTCPæ¯é¢åå­èæµçã\n    \n    UDPä»ä»å°åºç¨å±æ¥æé¦é¨æ·»å ä¸ä¸ªUDPé¦é¨å°è£ä¸ºUDPæ°æ®æ¥ï¼å°±å°è¯¥æ°æ®æ¥åéç»æ¥åæ¹ãUDPæ¯é¢åæ°æ®æ¥çã\n\n 4. å¦ææ°æ®ä¼ è¾è¿ç¨ä¸­æ°æ®ä¸¢å¤±ãè¯¯ç \n    \n    TCPä¼éæ°åéæè§¦åéä¼ æºå¶ã\n    \n    UDPå¥ä¹ä¸å¹²ã\n\næåï¼å¯¹æ¯ä¸ä¸UDPæ°æ®æ¥é¦é¨ä»¥åTCPæ°æ®æ¥çé¦é¨æ ¼å¼ï¼\n\n",normalizedContent:"# tcp udpåè®®\n\n\n# 1. æ¦è¿°\n\ntcpãudpåè®®æ¯tcp/ipä½ç³»ç»æä¼ è¾å±ä¸­çä¸¤ä¸ªéè¦åè®®ã\n\nå¦å¾æç¤ºä¸ºè®¡ç®æºç½ç»åå±æ¨¡åï¼\n\n\n\n**ipåè®®**æ¯ç½éå±ä¸­çæ ¸å¿åè®®ï¼å®å¯ä»¥äºèä¸åçç½ç»æ¥å£ï¼å¹¶åå¶ä¸å±æä¾æ è¿æ¥ãä¸å¯é çæ°æ®ä¼ è¾æå¡ã\n\ntcp/ipä½ç³»ç»æçåºç¨å±ä¸­åå«è®¸å¤§éçåºç¨å±åè®®ï¼å¶ä¸­æäºåºç¨å±åè®®éè¦ä½¿ç¨å¯é ä¼ è¾æå¡ï¼ä¾å¦æµè§ç½é¡µãä¼ è¾æä»¶ç­ï¼è¿äºæ°æ®ä¸æ¦ä¼ è¾å¤±è´¥ä¼é ææ æ³æ½åçå±å®³ãèæäºåéè¦ä½¿ç¨ä¸å¯é ä¼ è¾æå¡ï¼ä¾å¦é³è§é¢éè¯ç­ï¼å°éçæ°æ®ä¼ è¾éè¯¯å¹¶ä¸ä¼å¯¹æ­æ¾é æå¤§å½±åã\n\nç±äºåºç¨å±éè¦ä½¿ç¨å¯é åä¸å¯é ä¸¤ç§ä¼ è¾æå¡ï¼ä½ipåè®®åªè½æä¾ä¸å¯é ä¼ è¾æå¡ï¼äºæ¯å°±éè¦ä¼ è¾å±æ¥æä¾å¯é /ä¸å¯é çä¼ è¾æå¡ã\n\nå¶ä¸­tcpæä¾å¯é æ§ä¼ è¾æå¡ï¼udpæä¾ä¸å¯é ä¼ è¾æå¡ã\n\ntcp ï¼transmission control protocolï¼ä¼ è¾æ§å¶åè®®ï¼ä¸ºä¸å±æä¾çæ¯é¢åè¿æ¥çå¯é çæ°æ®ä¼ è¾æå¡ãä½¿ç¨tcpéä¿¡çåæ¹ï¼å¨ä¼ éæ°æ®ä¹åå¿é¡»é¦åå»ºç«tcpè¿æ¥ï¼é»è¾è¿æ¥ï¼èéç©çè¿æ¥ï¼ãæ°æ®ä¼ è¾ç»æåå¿é¡»è¦éæ¾tcpè¿æ¥ãtcpä¸ºäºå®ç°å¯é ä¼ è¾ï¼å°±å¿é¡»ä½¿ç¨å¾å¤æªæ½ï¼ä¾å¦tcpè¿æ¥ç®¡çãç¡®è®¤æºå¶ãè¶æ¶éä¼ ãæµéæ§å¶ãæ¥å¡æ§å¶ç­ãtcpçå®ç°å¤æï¼æ¥æé¦é¨è¾å¤§ï¼å ç¨å¤çæºèµæºæ¯è¾å¤ã\n\nudp ï¼user datagram protocolï¼ç¨æ·æ°æ®æ¥åè®®ï¼ä¸ºå¶ä¸å±æä¾çæ¯æ è¿æ¥çä¸å¯é çæ°æ®ä¼ è¾æå¡ï¼å æ­¤ä¸éè¦å®ç°å¯é ä¼ è¾çåç§æºå¶ãä½¿ç¨udpéä¿¡çåæ¹ï¼å¨ä¼ éæ°æ®ä¹åä¸éè¦å»ºç«è¿æ¥ãudpçå®ç°ç®åï¼ç¨æ·æ°æ®æ¥é¦é¨æ¯è¾å°ã\n\n\n# 2. ç«¯å£å· å¤ç¨ åç¨\n\nç«¯å£å· ï¼è¿è¡å¨è®¡ç®æºä¸çè¿ç¨ä½¿ç¨è¿ç¨æ è¯ç¬¦pidæ¥åºåï¼ä½æ¯å ç¹ç½ä¸çè®¡ç®æºä½¿ç¨æä½ç³»ç»å¤æï¼ä¸åçæä½ç³»ç»åæä¸åæ ¼å¼çè¿ç¨æ è¯ç¬¦ï¼ä¸ºäºä½¿è¿è¡å¨ä¸åæä½ç³»ç»çè®¡ç®æºçåºç¨è¿ç¨ä¹é´è½å¤è¿è¡éä¿¡ï¼å°±å¿é¡»ä½¿ç¨ç»ä¸çæ¹æ³å¯¹tcp/ipä½ç³»çåºç¨è¿ç¨è¿è¡æ è¯ï¼èè¿ä¸ªæ è¯æ¹æ³å°±æ¯**ç«¯å£å·**ï¼è¿è¾å±ä½¿ç¨ç«¯å£å·æ¥åºååºç¨å±çä¸ååºç¨è¿ç¨ãç«¯å£å·åªå·ææ¬å°æä¹ï¼å³ç«¯å£å·åªæ¯ä¸ºäºæ è¯æ¬è®¡ç®æºåºç¨è¿ç¨ï¼å¨å ç¹ç½ä¸­ï¼ä¸åçè®¡ç®æºä¸­çç¸åç«¯å£æ²¡æèç³»ï¼ä½ çµèä¸ç8080ç«¯å£è·æçµèä¸ç8080ç«¯å£ä¸ç¹å³ç³»æ²¡æã\n\nåéæ¹çå¤ç¨ ï¼åºç¨å±æ¥æç»è¿ä¼ è¾å±tcpåè®®è¿è¡å°è£ï¼ç§°ä¸ºtcpå¤ç¨ãåºç¨å±æ¥æç»è¿ä¼ è¾å±udpåè®®å°è£ï¼ç§°ä¸ºudpå¤ç¨ãä¼ è¾å±çæ¥æç»è¿ç½ç»å±ipåè®®çå°è£ï¼ç§°ä¸ºipå¤ç¨\n\næ¥æ¶æ¹çåç¨ï¼ç½ç»å±ä½¿ç¨ipåè®®è§£ææ¥åçipæ°æ®æ¥ï¼ç§°ä¸ºipåç¨ãä¼ è¾å±ä½¿ç¨tcpåè®®è§£ææ¥åçtcpæ°æ®æ¥ï¼ç§°ä¸ºtcpåç¨ãä¼ è¾å±ä½¿ç¨udpåè®®è§£ææ¥åçudpæ°æ®æ¥ï¼ç§°ä¸ºudpåç¨ã\n\n\n\nâ\n\n\n# 3. tcp\n\n\n# 3.1 tcpé¦é¨æ ¼å¼\n\ntcpåè®®å¤äºä¼ è¾å±ï¼å®åä¸å±ï¼åºç¨å±ï¼æä¾é¢åè¿æ¥çå¯é ä¼ è¾æå¡ï¼ä¸ºäºå®ç°å¯é ä¼ è¾ï¼éç¨äº**é¢åå­èæµ**çæ¹å¼ã\n\ntcpå¨åéæ°æ®æ¶ä»åéç¼å­ä¸­ååºä¸é¨åæå¨é¨å­èå¹¶ç»å¶æ·»å ä¸ä¸ªé¦é¨ä½¿ä¹æä¸ºtcpæ¥ææ®µåå¨åéç»ä¸å±ãä¸ä¸ªtcpæ¥ææ®µç±é¦é¨åæ°æ®è½½è·ä¸¤é¨åç»æï¼tcpå®ç°è¿æ¥ç®¡çãç¡®è®¤æºå¶ãè¶æ¶éä¼ ãæµéæ§å¶ãæ¥å¡æ§å¶è¿äºåè½é½ä½ç°å¨å®é¦é¨ä¸­åå­æ®µçä½ç¨ã\n\ntcpé¦é¨ç±ä¸¤é¨åææ ï¼20å­èçåºå®é¦é¨åæå¤§40å­èçæ©å±é¦é¨ãä¹å°±æ¯è¯´ï¼ä¸ä¸ªtcpé¦é¨çå­èæ°å¨20~60å­èä¹é´ã\n\n\n\næºç«¯å£ ï¼16æ¯ç¹ï¼å³ä¸¤å­èï¼åå¥æºç«¯å£å·ï¼ç¨äºæ è¯åéè¯¥tcpæ¥ææ®µçåºç¨è¿ç¨ã\n\nç®çç«¯å£ ï¼16æ¯ç¹ï¼å³ä¸¤å­èï¼åå¥ç®çç«¯å£å·ï¼ç¨äºæ è¯æ¥åè¯¥tcpæ¥ææ®µçåºç¨è¿ç¨ã\n\nåå¦æä»¬ä½¿ç¨webæå¡127.0.0.1:8080è¿ç¨è®¿é®mysqlæå¡å¨48.104.60.218:3306ï¼æºç«¯å£å°±æ¯æä»¬èªå·±çipå°åä¸­çç«¯å£8080ï¼ç®çç«¯å£å°±æ¯mysqlæå¡å¨çipå°åä¸­çç«¯å£3306ã\n\næ¥ä¸æ¥ççä¸tcpå®ç°å¯é æ§ä¼ è¾æå³çä¸ä¸ªå­æ®µ ï¼åºå·ãç¡®è®¤å·ãackã\n\nåºå· ï¼å 32æ¯ç¹ï¼åå¼èå´[0, 2^32 - 1]ï¼åºå·å¢å å°æåä¸ä¸ªåï¼ä¸ä¸ä¸ªåºå·å°±ååå°0ãåºå·çå¼ç¨æ¥æåºæ¬tcpæ¥ææ®µ**æ°æ®è½½è·**ç¬¬ä¸ä¸ªå­èçåºå·ãå¦å¾æç¤ºï¼é¦é¨çåºå·å³ä¸ºæ°æ®è½½è·ç¬¬ä¸ä¸ªå­èçåºå·122ã\n\n\n\nç¡®è®¤å· ï¼å 32æ¯ç¹ï¼åå¼èå´[0, 2^32 - 1]ï¼ç¡®è®¤å¥½å¢å å°æåä¸ä¸ªåï¼ä¸ä¸ä¸ªç¡®è®¤å¥½ååå°0ãç¡®è®¤å·çå¼ç¨äºæåºæææ¶å°å¯¹æ¹ä¸ä¸ä¸ªtcpæ¥ææ®µçæ°æ®è½½è·çç¬¬ä¸ä¸ªå­èçåºå·ï¼åæ¶ä¹æ¯å¯¹ä¹åæ¶å°çæææ°æ®çç¡®è®¤ãå¯ä»¥è¿æ ·çè§£ï¼è¥ç¡®è®¤å·ä¸ºnï¼åä»£è¡¨ä¹åå·²ç»æåæ¥æ¶å°åºå·ä¸ºn-1çæ¥ææ®µï¼ä¸ä¸æ¬¡æææ¶å°åºå·ä¸ºnçæ¥ææ®µãåªæackæ è¯çå¼ä¸º1æ¶ï¼ç¡®è®¤å·å­æ®µæææã\n\nack ï¼ç¡®æ å¿ä½ï¼åå¼ä¸º1æ¶ç¡®è®¤å·æææï¼åå¼ä¸º0æ¶ç¡®è®¤å·æ æãtcpè§å®ï¼è¿æ¥å»ºç«åææçtcpæ¥ææ®µé½å¿é¡»æackç½®ä¸º1ã\n\nå¦å¾ï¼å®¢æ·ç«¯åæå¡ç«¯åéä¸ä¸ªtcpæ°æ®æ¥ï¼åºå·ä¸º200ä»£è¡¨æ­¤æ°æ®æ¥çæ°æ®è½½è·é¨åçç¬¬ä¸ä¸ªå­èçåºå·ä¸º200ãç¡®è®¤å·ä¸º800ä»£è¡¨å®¢æ·ç«¯å·²ç»æ¶å°æå¡ç«¯åéçåºå·ä¸º799å·ä»¥åä¹åçæ°æ®æ¥ï¼ç°å¨æ³è¦åºå·ä¸º800çæ°æ®æ¥ãackçå¼ä¸º1ä¿è¯ç¡®è®¤å·ææãæ°æ®è½½è·é¿åº¦ä»£è¡¨æ­¤æ¬¡ä¼ è¾çå­èæ°ãä¹å°±æ¯è¯´ï¼æ­¤æ¬¡ä¼ è¾çæ°æ®è½½è·é¨åçåºå·ä¸º 200 - 300ã\n\n\n\næ°æ®åç§» ï¼å 4æ¯ç¹ï¼å¹¶ä»¥4å­èä¸ºåä½ãç¨äºæåºtcpæ¥ææ®µçæ°æ®è½½è·é¨åçèµ·å§å¤è·ç¦»tcpæ¥ææ®µçèµ·å§å¤æå¤è¿ãè¿ä¸ªå­æ®µå®éä¸æ¯æåºäºtcpæ¥ææ®µçé¦é¨æå¤å°ä¸ªå­èãåæ¶ï¼å®çå¼æ¯é¦é¨å­èæ°é¤ä»¥4çãé¦é¨çå­èæ°èå´ä¸ºï¼20 ~ 60ï¼æä»¥æ°æ®åç§»å­æ®µçå¼èå´ä¸º 5~15ï¼å³ 0101å°1111ã\n\nä¿ç ï¼å 6æ¯ç¹ï¼ä¿çä»¥åä½¿ç¨ãç®åå¼ä¸º0ã\n\nçªå£ ï¼å 16æ¯ç¹ï¼ä»¥å­èä¸ºåä½ãæåºåéæ¬æ¥ææ®µçä¸æ¹çæ¥æ¶çªå£ãçªå£å¼ä½ä¸ºæ¥æ¶æ¹è®©åéæ¹è®¾ç½®å¶åéçªå£çä¾æ®ãè¿æ¯ä»¥æ¥æ¶æ¹çæ¥åè½åæ¥æ§å¶åéæ¹çåéè½åï¼ç§°ä¸ºæµéæ§å¶ãéè¦æ³¨æçæ¯ï¼åéçªå£çå¤§å°è¿åå³äºæ¥å¡çªå£çå¤§å°ï¼ä¹å°±æ¯ä»æ¥æ¶çªå£åæ¥å¡çªå£ä¸­åæå°å¼ã\n\næ ¡éªå ï¼å 16æ¯ç¹ï¼ç¨äºæ£æ¥æ´ä¸ªtcpæ¥ææ®µå¨ä¼ è¾è¿ç¨ä¸­æ¯å¦åºç°äºè¯¯ç ã\n\nç´§æ¥æé ï¼å 16æ¯ç¹ï¼ä»¥å­èä¸ºåä½ï¼ç¨æ¥ææç´§æ¥æ°æ®çé¿åº¦ãå½åéæ¹æç´§æ¥æ°æ®æ¶ï¼å¯å°ç´§æ¥æ°æ®æéå°åéç¼å­çæåé¢ï¼å¹¶ç«å»å°è£å°ä¸ä¸ªtcpæ¥æä¸­è¿è¡åéãç´§æ¥æéä¼æåºæ¬æ¥ææ®µæ°æ®è½½è·é¨ååå«äºå¤é¿çç´§æ¥æ°æ®ï¼ç´§æ¥æ°æ®ä¹åæ¯æ®éæ°æ®ã\n\nsyn ï¼åæ­¥æ å¿ä½ï¼å¨tcpè¿æ¥å»ºç«æ¶ç¨æ¥åæ­¥åºå·ãtcpè§å®ï¼synå¼ä¸º1æ¶ä»£è¡¨æ­£å¨å»ºç«è¿æ¥ï¼æ­¤æ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\nfin ï¼ç»æ­¢æ å¿ä½ï¼ç¨äºéæ¾tcpè¿æ¥ãtcpè§å®ï¼finå¼ä¸º1æ¶ä»£è¡¨æ­£å¨éæ¾è¿æ¥ï¼æ­¤æ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\nrst ï¼å¤ä½æ å¿ä½ï¼ç¨äºå¤ä½tcpè¿æ¥ãå½rstä¸º1æ¶ï¼è¡¨ç¤ºtcpè¿æ¥åºç°äºå¼å¸¸ï¼æ­¤æ¶å¿é¡»åæ­å¼è¿æ¥ï¼åéæ°å»ºç«è¿æ¥ãrstè¿ç¨æ¥æç»éæ³æ¥ææ®µææç»tcpè¿æ¥ã\n\npsh ï¼æ¨éæ å¿ä½ï¼ç¨æ¥å®ç°æ¨éæä½ãå½æ¥åæ¹æ¶å°è¯¥æ å¿ä½ä¸º1çæ¥ææ®µä¼å°½å¿«ä¸äº¤åºç¨è¿ç¨ï¼èä¸å¿ç­å°æ¥æ¶ç¼å­é½å¡«æ»¡åååä¸äº¤ä»ã\n\nurg ï¼ç´§æ¥æ å¿ä½ï¼ä¸ç´§æ¥æéå­æ®µå±åå®ç°ç´§æ¥æä½ãç´§æ¥æ å¿ä½urgä¸º1æ¶ï¼ç´§æ¥æéææï¼ä¸º0æ¶ç´§æ¥æéæ æã\n\néé¡¹ ï¼éé¡¹ä¸­çå­æ®µé½æ¯å¯éå¼ï¼æ©å±åè½ãéé¡¹çå­èæ°å¯å\n\nå¡«å ï¼ç±äºéé¡¹çå­èæ°å¯åï¼é£å°±ä½¿ç¨å¡«åå­æ®µç¡®ä¿æ¥ææ®µé¦é¨è½è¢«4æ´é¤ãåå¦éé¡¹æ3å­èï¼é£ä¹å¡«åå°±åªæ1ä¸ªå­èã\n\nä¸ºä»ä¹ä¸å®è¦ç¡®ä¿é¦é¨å­èæ°è¦è½è¢«4æ´é¤ï¼å ä¸ºæ°æ®åç§»å­æ®µçå¼æ¯é¦é¨å­èæ°é¤ä»¥4ã\n\n\n\n\n# 3.2 å»ºç«è¿æ¥-ä¸æ¬¡æ¡æ\n\ntcpæ¯é¢åè¿æ¥çåè®®ï¼å®åºäºè¿è¾è¿æ¥æ¥ä¼ étcpæ¥ææ®µãtcpè¿è¾è¿æ¥çå»ºç«åéæ¾æ¯æ¯ä¸æ¬¡é¢åå¨è¿æ¥çéä¿¡ä¸­å¿ä¸å¯å°çè¿ç¨ã\n\ntcpè¿è¾è¿æ¥åä¸ºä»¥ä¸ä¸ä¸ªé¶æ®µï¼\n\n 1. éè¿ä¸æ¬¡æ¡æå»ºç«tcpè¿æ¥\n 2. è¿è¡æ°æ®ä¼ è¾\n 3. éè¿åæ¬¡æ¥ææ­å¼tcpè¿æ¥\n\nåæ¥ä»ç»ä¸ä¸tcpè¿æ¥çå»ºç« ï¼ä¸æ¥ææ¡æ\n\næåï¼tcpå®¢æ·ç«¯ä¸tcpæå¡ç«¯çtcpè¿ç¨é½å¤äºå³é­ç¶æï¼å³closedã\n\nä¸å¼å§ï¼tcpæå¡ç«¯ååå»ºtcpä¼ è¾æ§å¶åï¼ç¨äºå­å¨tcpè¿æ¥ä¸­çä»¥ä¸éè¦ä¿¡æ¯ï¼ä¾å¦tcpè¿æ¥è¡¨ãæååéåæ¥åç¼å­çæéãæåéä¼ éåçæé...tcpæå¡ç«¯åå»ºä¼ è¾æ§å¶ååå°±è¿å¥çå¬ç¶æï¼listenï¼ç­å¾æ¥åtcpå®¢æ·ç«¯çè¿æ¥è¯·æ±ã\n\ntcpå®¢æ·ç«¯å¨åèµ·è¿æ¥è¯·æ±ä¹åä¹è¦åå»ºä¼ è¾æ§å¶åï¼ä¹ååèµ·è¿æ¥è¯·æ±ã\n\n\n\nç¬¬ä¸æ¬¡æ¡æ ï¼\n\ntcpå®¢æ·ç«¯è¿ç¨åtcpæå¡ç«¯è¿ç¨åétcpè¿æ¥è¯·æ±æ¥ææ®µï¼å¹¶è¿å¥åæ­¥å·²åéç¶æï¼syn-sendï¼ã\n\næ­¤è¿æ¥è¯·æ±æ¥ææ®µé¦é¨ä¸­çå¼ï¼\n\n * syn ï¼1ï¼è¡¨æè¿æ¯ä¸ä¸ªtcpè¿æ¥è¯·æ±æ¥ææ®µãåæ¶è§å®æ­¤æ¶çæ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\n * åºå·(seq) ï¼åå§å¼x\n\n\n\nç¬¬äºæ¬¡æ¡æ ï¼\n\ntcpæå¡ç«¯æ¥æ¶å°è¯·æ±è¿æ¥æ¥æåï¼å¦æåæè¿æ¥ï¼ä¼åtcpå®¢æ·ç«¯åé è¿æ¥è¯·æ±ç¡®è®¤æ¥ææ®µï¼å¹¶è¿å¥åæ­¥å·²æ¥åç¶æï¼syn-rcvdï¼ã\n\nè¯¥æ¥ææ®µé¦é¨ä¸­çå¼ï¼\n\n * syn ï¼1ï¼è¡¨æç°å¨æ­£å¨è¿è¡tcpè¿æ¥ãåæ¶è§å®æ­¤æ¶çæ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n\n * ack ï¼ä½¿ç¡®è®¤å·çæã\n\n * ç¡®è®¤å·(ack) ï¼ç±äºå®¢æ·ç«¯åéçåºå·ä¸ºxï¼é£ä¹ç¡®è®¤å·å°±æ¯x+1ï¼ä»£è¡¨âæå·²ç»æ¶å°åºå·ä¸ºxä»¥åä¹åçæ°æ®äºï¼ä½ ä¸æ¬¡ç»æåx+1å§âã\n\n * åºå·(seq) ï¼åå§å¼yã\n\nç¬¬ä¸æ¬¡æ¡æ ï¼\n\ntcpå®¢æ·ç«¯æ¶å°è¿æ¥è¯·æ±ç¡®è®¤æ¥ææ®µåï¼è¿éè¦åtcpæå¡ç«¯è¿ç¨åéä¸ä¸ª**æ®éçtcpç¡®è®¤æ¥ææ®µï¼å¹¶è¿å¥è¿æ¥å·²å»ºç«ç¶æï¼establishedï¼ãç±äºæ¯ä¸ä¸ªæ®é**çè¿æ¥å»ºç«æ¥ææ®µï¼æä»¥å®çsynå­æ®µå¼å¹¶ä¸ä¸º1ï¼æä»¥è¿ä¸ªæ¥ææ®µå¯ä»¥æºå¸¦æ°æ®ï¼ä½æ¯å®ä¸æºå¸¦æ°æ®ã\n\nï¼tcpè§å®ï¼synä¸º1çæ¥ææ®µä¸è½æºå¸¦æ°æ®ï¼æ¥ææ®µåéæ¶æ¶èä¸ä¸ªåºå·ãsynä¸ä¸º1çæ¥ææ®µå¯ä»¥æºå¸¦æ°æ®ï¼å¦æä¸æºå¸¦æ°æ®ï¼ä¸æ¶èåºå·ï¼\n\nè¯¥æ¥ææ®µçé¦é¨å¼ï¼\n\n * ack ï¼1ï¼ä¿è¯ç¡®è®¤ä½å¯ç¨ã\n * åºå·(seq) ï¼x+1ï¼å ä¸ºtcpæå¡ç«¯ä¸æ¬¡åçæ¥æä¸­çç¡®è®¤å·ä¸ºx+1ãç±äºsynå¼ä¸ä¸º1ï¼å¹¶ä¸æ²¡ææºå¸¦æ°æ®ï¼æx+1è¿ä¸ªåºå·ä¸æ¬¡è¿è½ç¨ï¼ä¹å°±æ¯å»ºç«è¿æ¥åè¿å¯ä»¥åä½¿ç¨ä¸æ¬¡x+1è¿ä¸ªåºå·ã\n * ç¡®è®¤å·(ack) ï¼y+1ï¼å ä¸ºtcpæå¡ç«¯ä¸æ¬¡åéçæ¥ææ®µçåºå·ä¸ºyï¼æä»¥æä»¬è¿æ¬¡åéy+1ï¼è¡¨ç¤ºæä»¬å·²ç»æ¥æ¶å°äºåºå·yä»¥åä¹åçæ°æ®ï¼ä¸æ¬¡æä»¬æ³è¦åºå·ä¸ºy+1çæ°æ®ã\n\n\n\nå½tcpæå¡ç«¯æ¥æ¶å°tcpå®¢æ·ç«¯ç¬¬äºæ¬¡æ¥ææ¶ï¼æå¡ç«¯ä¹è¿å¥è¿æ¥å·²å»ºç«ç¶æï¼establishedï¼ã\n\n\n\nç°å¨ï¼åæ¹é½å·²è¿å¥è¿æ¥å»ºç«ç¶æï¼å¯ä»¥æ ¹æ®å·²ç»å»ºç«å¥½çtcpè¿æ¥è¿è¡å¯é çæ°æ®ä¼ è¾ã\n\n> é£ä¹ä¸ºä»ä¹å»ºç«tcpè¿æ¥ä¸å®éè¦ä¸æ¬¡å¢ï¼ä¸ºä»ä¹ä¸è½æ¯ä¸¤æ¬¡ï¼ä¸ºä»ä¹ä¸è½ä½¿ç¨ä¸¤æ¬¡æ¥ææ¡æå»ºç«è¿æ¥å¢ï¼\n\næ¥ä¸æ¥ççä¸¤æ¥ææ¡æä¼åºç°çé®é¢ ï¼\n\ntcpå®¢æ·ç«¯ååºè¯·æ±è¿æ¥æ¥æï¼ä½æ¯å ä¸ºç½ç»é®é¢é¿æ¶é´åæ»å¨ç½ç»ä¸­ï¼äºæ¯è§¦åè¶æ¶éä¼ æºå¶ï¼tcpå®¢æ·ç«¯éæ°åèµ·tcpè¿æ¥è¯·æ±æ¥ææ®µï¼è¿æ¬¡æåå»ºç«è¿æ¥ãä¹åä¾¿æ¯æ°æ®çä¼ è¾ï¼æåæ°æ®ä¼ è¾å®æï¼æå¡ç«¯ä¸å®¢æ·ç«¯æ­å¼è¿æ¥ã\n\n\n\næ­å¼è¿æ¥åçªç¶ï¼ä¸æ¬¡å ä¸ºç½ç»é®é¢æ»åçtcpè¿æ¥è¯·æ±åéå°äºtcpæå¡ç«¯ï¼æå¡ç«¯ä»¥ä¸ºå®¢æ·ç«¯æ³è¦åæ¬¡å»ºç«tcpè¿æ¥ï¼äºæ¯æå¡ç«¯è¿å¥çå¬ï¼listenï¼ç¶æå¹¶åå®¢æ·ç«¯åéè¿æ¥è¯·æ±ç¡®è®¤æ¥æï¼ä½æ¯å®¢æ·ç«¯æ­¤æ¶ä¸ºå³é­ç¶æï¼å¯¹è¿æ¥è¯·æ±ç¡®è®¤æ¥æä¸äºçç¬ï¼äºæ¯æå¡ç«¯ä¸ç´å¤äºçå¬ç¶æå¹¶åéè¿æ¥è¯·æ±ç¡®è®¤æ¥æãè¿å°±é æäºtcpæå¡ç«¯èµæºçæµªè´¹ã\n\n\n\nç»¼ä¸æè¿°ï¼éç¨ä¸æ¥ææ¡æèä¸æ¯ä¸¤æ¥ææ¡ææ¯ä¸ºäºé²æ­¢å·²å¤±æçè¿æ¥è¯·æ±æ¥ææ®µçªç¶ä¼ éå°äºtcpæå¡ç«¯å èå¯¼è´çéè¯¯ã\n\n\n# 3.3 éæ¾è¿æ¥-åæ¬¡æ¥æ\n\ntcpéè¿åæ¬¡æ¥ææ¥ç»ætcpçè¿æ¥ã\n\nå¨æ­å¼è¿æ¥ä¹åï¼å®¢æ·ç«¯ä¸æå¡ç«¯é½å¤äºè¿æ¥å·²å»ºç«ç¶æï¼establishedï¼ã\n\nç¬¬ä¸æ¬¡æ¥æ ï¼\n\ntcpå®¢æ·ç«¯ä¼åétcpè¿æ¥éæ¾æ¥ææ®µï¼è¿å¥ç»æ­¢ç­å¾1ç¶æï¼fin-wait-1ï¼ãtcpè¿æ¥éæ¾æ¥ææ®µçå­æ®µå¼ä¸ºï¼\n\n * fin ï¼1ï¼ä»£è¡¨æ­¤æ¶æ­£å¨éæ¾tcpè¿æ¥ï¼æ­¤æ¥ææ®µä¸è½æºå¸¦æ°æ®ã\n * ack ï¼ä½¿ç¡®è®¤å·çæã\n * seq(åºå·) ï¼uï¼ä»£è¡¨æ­¤æ¥ææ®µçæ°æ®è½½è·çç¬¬ä¸ä¸ªå­èçåºå·ä¸ºuã\n * ack(ç¡®è®¤å·) ï¼vï¼ä»£è¡¨å·²ç»æ¶å°åºå·ä¸ºv-1çæ°æ®ï¼ä¸æ¬¡æ³è¦åºå·ä¸ºvçæ°æ®ã\n\n\n\nç¬¬äºæ¬¡æ¥æ ï¼\n\næå¡ç«¯æ¥æ¶å°å®¢æ·ç«¯åéçtcpè¿æ¥éæ¾æ¥ææ®µåï¼ä¼åå®¢æ·ç«¯åéä¸ä¸ªæ®éçtcpç¡®è®¤æ¥ææ®µï¼å¹¶è¿å¥å³é­ç­å¾ç¶æï¼close-waitï¼ã\n\nï¼æ­¤æ¶çtcpè¿æ¥è¿å¥äºåå³é­ç¶æï¼å ä¸ºå®¢æ·ç«¯å°æå¡ç«¯çtcpè¿æ¥è¿å¥å³é­ç¶æï¼å ä¸ºå®¢æ·ç«¯å·²ç»æ²¡ææ°æ®è¦åéäºï¼ä½æ¯æå¡ç«¯å°å®¢æ·ç«¯çtcpè¿æ¥ééè¿æ²¡å³é­ï¼å ä¸ºæå¡ç«¯è¦ç»§ç»­åéé£äºè¿æªåéå®æ¯çæ°æ®ãï¼\n\næ­¤æ¥ææ®µçå­æ®µå¼ ï¼\n\n * ack ï¼1ï¼ä¿è¯ç¡®è®¤å·ææ\n * åºå·(seq) ï¼vï¼ä»£è¡¨æ­¤æ¥ææ®µçæ°æ®è½½è·çç¬¬ä¸ä¸ªå­èçåºå·ä¸ºvã\n * ç¡®è®¤å·(ack) ï¼u+1ï¼ä»£è¡¨å·²ç»æ¶å°å®¢æ·ç«¯åéçç¬¬uæ¡æ°æ®ï¼ä¸æ¬¡æ³è¦u+1ã\n\ntcpå®¢æ·ç«¯æ¶å°tcpæå¡ç«¯åéçtcpç¡®è®¤æ¥ææ®µåå°±ä¼è¿å¥ç»æ­¢ç­å¾2ç¶æï¼fin-wait2ï¼ã\n\n\n\nç¬¬ä¸æ¬¡æ¥æ ï¼\n\nå½tcpæå¡ç«¯ææå©ä½æ°æ®åéå®æ¯åï¼tcpæå¡ç«¯ä¼åétcpè¿æ¥éæ¾æ¥ææ®µï¼å¹¶è¿å¥æåç¡®è®¤ç¶æï¼last-ackï¼ã\n\nè¯¥æ¥ææ®µçå­æ®µï¼\n\n * fin ï¼1ï¼è¡¨ç¤ºæ­£å¨éæ¾è¿æ¥ã\n * ack ï¼1ï¼ä¿è¯ç¡®è®¤å·ææã\n * åºå·(seq) ï¼wï¼ä¸ºä»ä¹ä¸æ¯v+1ï¼å ä¸ºç¬¬äºæ¬¡æ¥æä¹åå¯è½ä¼ è¾äºå¶ä»å©ä½æ°æ®æ¥ã\n * ç¡®è®¤å·(ack) ï¼u+1ãä¸ºä»ä¹æ¯u+1ï¼ä¸æ¯ååéäºå©ä½æ°æ®åï¼å ä¸ºå©ä½æ°æ®æ¥åªæ¯æå¡ç«¯åå®¢æ·ç«¯åéï¼å®¢æ·ç«¯åæå¡ç«¯çtcpè¿æ¥ééå·²ç»æ­å¼ã\n\n\n\nç¬¬åæ¬¡æ¥æï¼\n\næ¶å°æå¡ç«¯åéçtcpè¿æ¥éæ¾æ¥ææ®µåï¼å®¢æ·ç«¯åéæ®éçç¡®è®¤æ¥ææ®µï¼ä¹åè¿å¥æ¶é´ç­å¾ç¶æï¼time-waitï¼ã\n\næ¶å°è¯¥æ¥ææ®µåï¼æå¡ç«¯å³é­ãå¤äºæ¶é´ç­å¾ç¶æ2msl(2mins)åï¼å®¢æ·ç«¯tcpè¿æ¥å³é­ã\n\nè¯¥æ¥æå­æ®µå¼ ï¼\n\n * ack ï¼1ï¼ä¿è¯ç¡®è®¤å·ææ\n * åºå·(seq) ï¼u+1\n * ç¡®è®¤å·(ack) ï¼w+1\n\n> ä¸ºä»ä¹å®¢æ·ç«¯è¿è¦ç­å¾ä¸¤åéåå³é­tcpè¿æ¥å¢ï¼\n> \n> åå¦ä¸è¿è¡ç­å¾èç´æ¥å³é­ï¼ä¹å°±æ¯å®¢æ·ç«¯åéç¬¬åæ¬¡æ¥æä¹åç«å³å³é­tcpè¿æ¥ãé£ä¹å¦ææåä¸ä¸ªç¡®è®¤æ¥æä¸¢å¤±ï¼æ­¤æ¶å®¢æ·ç«¯å·²ç»å³é­ï¼ä½æå¡ç«¯è¿å¨ç­å¾æåçç¡®è®¤ä¿æ¥æï¼ä¸ç´æ²¡ç­å°å°±ä¼è§¦åè¶æ¶éä¼ æºå¶åéç¬¬ä¸æ¬¡æ¥ææ¥æï¼ä½æ¯å®¢æ·ç«¯å·²ç»å³é­ï¼é£ä¹æå¡ç«¯å°±ä¼ä¸ç´åéç¬¬ä¸æ¬¡æ¥ææ¥æï¼éå¸¸æµªè´¹èµæºãèç­å¾ä¸¤åéå°±å¯ä»¥è§£å³è¿ä¸ªé®é¢ï¼å®¢æ·ç«¯æè¶³å¤æ¶é´ç­å¾æå¡ç«¯åéçè¶æ¶éä¼ æ¥æã\n\n\n\nè³æ­¤ï¼åæ¥ææ¥æè¿ç¨å®æ¯ã\n\næ¥ä¸æ¥ççä¿æ´»è®¡æ¶å¨ ï¼\n\nå¨å®¢æ·ç«¯ä¸æå¡ç«¯å»ºç«è¿æ¥åï¼å¦æå®¢æ·ç«¯åºç°æéï¼åºå½ææªæ½è®©æå¡ç«¯ä¸»å¨æ­å¼è¿æ¥èä¸æ¯ä¸ç´ç­å¾ä¸å»ãè¿æ¶å°±è¦ä½¿ç¨å°ä¿æ´»è®¡æ¶å¨ã\n\n * tcpæå¡å¨è¿ç¨æ¯æ¶å°ä¸æ¬¡tcpå®¢æ·è¿ç¨çæ°æ®ï¼å°±éæ°è®¾ç½®å¹¶å¯å¨ä¿æ´»è®¡æ¶å¨(å®æ¶2å°æ¶)ã\n * è¥2å°æ¶åæ²¡æ¥æ¶å°tcpå®¢æ·ç«¯åéçæ°æ®ï¼åå½ä¿æ´»è®¡æ¶å¨å°æ¶åï¼tcpæå¡å¨åtcpå®¢æ·ç«¯åéä¸ä¸ªæ¢æµæ¥ææ®µï¼ä»¥ååæ¯75ç§åéä¸æ¬¡ï¼è¥è¿ç»­10ä¸ªæ¥ææ®µé½æ ååºï¼tcpæå¡ç«¯ä¸»å¨æ­å¼tcpè¿æ¥ã\n\n\n# 3.4 tcpæµéæ§å¶\n\nä¸ºä»ä¹éè¦æµéæ§å¶ï¼ä¸è¬æ¥è¯´ï¼æä»¬æ´å å¸æä¼ è¾éåº¦è¶å¿«è¶å¥½ï¼ä½æ¯å¦æåéæ¹åéæ°æ®çéåº¦è¿å¿«ï¼ä¼å¯¼è´æ¥åæ¹æ¥ä¸åæ¥æ¶ï¼è¿å°±ä¼é ææ°æ®çä¸¢å¤±ã\n\næä»¥æµéæ§å¶å°±æ¯ä¸ºäºè®©åéæ¹åéçéçä¸è¦å¤ªå¿«ï¼è¦è®©æ¥åæ¹æ¥å¾åæ¥æ¶ã\n\ntcpçæµéæ§å¶æ¯éè¿æ»å¨çªå£æ¥å®ç°çãå¦ææ­¤æ¶aåbä¼ è¾æ°æ®ï¼å¨ä¼ è¾æ°æ®åbåè¯aï¼æçæ¥æ¶çªå£rwnd=400(receiver window)ãè¿è¡¨ç¤º ï¼åéæ¹açåéçªå£ä¸è½è¶è¿æ¥åæ¹bçæ¥æ¶çªå£çå¼ï¼ä¹å°±æ¯400å­èã\n\nåå¦bæåçæ¥æ¶çªå£å¤§å°ä¸º400ï¼é£ä¹aå¯ä»¥åé400å­èçæ°æ®ãbæ¥æ¶400å­èæ°æ®å¹¶åéç¡®è®¤åï¼è¿400å­èçæ°æ®ä¼åä»açåéç¼å­ä¸­å é¤ãç°å¨aæååbåéäº400å­èçæ°æ®ï¼ä½æ¯bçæ¥æ¶ç¼å­æ²¡å¤å°ç©ºé´äºï¼äºæ¯bå¯¹aè¯´ï¼æçæ¥æ¶çªå£ä¸ºrwnd=300ãè¿è¡¨ç¤ºåéæ¹açåéçªå£ä¸è½è¶è¿300å­èãå°±è¿æ ·ï¼å¦æåéåbçåéç¼å­è¿æ²¡è¾åºç©ºé´ï¼ä¼ç»§ç»­åå°æ¥æ¶çªå£ç´å°bçåéç¼å­æ²¡æç©ºé´ï¼è¿æ¶båaåéçrwnd=0ï¼å³é¶çªå£éç¥ï¼ä»£è¡¨ä¸è¦ååéæ°æ®äºï¼ç­æè¾åºç©ºé´åè¯´å§ã\n\n> å¦æaåéçæ°æ®ä¸¢å¤±æä¹åå¢ï¼\n\naç»båéæ¶æ¯ï¼å¦ææ°æ®ä¸¢å¤±ï¼å¹¶ä¸ä¼å½±åaåç»­æ°æ®çåéï¼båéçackæ¶æ¯ä¼åè¯aåªäºæ°æ®è¿æ²¡æåéï¼å°æ¶aéæ°åéå³å¯ã\n\n> å¦æbåéçrwndä¸¢å¤±æä¹åå¢ï¼\n\nå¦æbåéç»açrwndä¸¢å¤±ï¼aä¸ç´å¨ç­å¾båéççªå£éç¥(rwnd)ä»¥ä¾¿è®¾ç½®èªå·±çåéçªå£ï¼èä¸»æºbä»¥ä¸ºaå·²ç»æ¥æ¶å°çªå£éç¥ï¼ä»å°±ä¸ç´ç­å¾aåéçæ°æ®ï¼è¿å°±ä¼é ææ­»éçå±é¢ãä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼tcpä¸ºæ¯ä¸ä¸ªè¿æ¥è®¾ç½®ä¸ä¸ªæç»­å®æ¶å¨ã\n\nå¦æbç»aåéé¶çªå£éç¥ï¼æç»­è®¡æ¶å¨ä¼éæ°è®¡æ¶ï¼å½æç»­è®¡æ¶å¨è¶æ¶æ¶ï¼è¯æå·²ç»å¾ä¹æ²¡ææ¶å°é¶çªå£éç¥äºï¼aå°±ç»båéä¸ä¸ªæ¢æµæ¥æï¼bæ¥æ¶è¯¥æ¥æåï¼å°èªå·±çæ¥æ¶çªå£å¼åéç»aï¼å¦ææ­¤å¼ä¸º0ï¼åæç»­è®¡æ¶å¨éæ°è®¡æ¶ï¼å¦ææ­¤å¼ä¸ºå¶ä»å¼ï¼aå°å¶åéçªå£å¤§å°è®¾ç½®ä¸ºæ­¤å¼ãäºæ¯æ­»éé®é¢å¾ä»¥è§£å³ã\n\n\n# 3.5 tcpæ¥å¡æ§å¶\n\næ¥å¡ ï¼å¯¹ç½ç»ä¸­æä¸èµæºçéæ±è¶è¿äºè¯¥èµæºæè½æä¾çå¯ç¨é¨åï¼ç½ç»æ§è½å°±è¦ååãè¿ç§æåµå«åæ¥å¡ï¼congestionï¼ã\n\nè¥åºç°æ¥å¡èä¸è¿è¡æ§å¶ï¼æ´ä¸ªç½ç»çååéå°éè¾å¥è´è·çå¢å¤§èä¸éã\n\ntcpå¯¹æ¥å¡æ§å¶æä¾äºåç§ç®æ³ ï¼\n\n 1. æ¢å¼å§ï¼slow-startï¼\n 2. æ¥å¡é¿åï¼congestion avoidanceï¼\n 3. å¿«éä¼ ï¼fast retransmitï¼\n 4. å¿«æ¢å¤ï¼fast recoveryï¼\n\nä¸ºäºç®åèµ·è§ï¼æä»¬åè®¾åéæ¹aï¼æ¥æ¶æ¹bï¼aåªåéæ°æ®æ¥ï¼båªåéç¡®è®¤æ¥ãå¹¶ä¸æ¥æ¶æ¹çæ¥æ¶çªå£è¶³å¤å¤§ï¼æ­¤æ¶åéæ¹çåéçªå£å°±åªåæ¥å¡æ§å¶çå½±åã\n\nåéæ¹ç»´æ¤ä¸ä¸ªå«åæ¥å¡çªå£cwndçç¶æåéï¼å¶å¼åå³äºç½ç»çæ¥å¡ç¨åº¦ï¼å¹¶ä¸å¨æååã\n\n * æ¥å¡çªå£cwndçç»´æ¤ååï¼åªè¦ç½ç»æ²¡æåºç°æ¥å¡ï¼æ¥å¡çªå£å°±åå¢å¤§ä¸äºãç½ç»åºç°æ¥å¡ï¼æ¥å¡çªå£å°±åå°ä¸äºã\n * å¤æ­åºç°ç½ç»æ¥å¡çä¾æ®ï¼æ²¡æææ¶æ¶å°åºå½å°è¾¾çç¡®è®¤æ¥ææ®µï¼å³åçè¶æ¶ï¼\n\nåéæ¹å°æ¥å¡çªå£ä½ä¸ºåéçªå£swndï¼å³swnd = cwndã\n\nå·ä½çæ¥å¡æ§å¶å¯ä»¥åè ï¼https://juejin.cn/post/6844903664566403085\n\nå®å¨æ¯è®²ä¸åºæ¥ð¢\n\n\n# 3.6 tcpå¯é ä¼ è¾çå®ç°\n\ntcpåºäºä»¥å­èä¸ºåä½çæ»å¨çªå£æ¥å®ç°å¯é ä¼ è¾ã\n\nå¦å¾aä¸bå»ºç«äºtcpè¿æ¥\n\nï¼ç®åèµ·è§ï¼æä»¬åè®¾æ°æ®åæ¹é¢åéå¹¶ä¸æ²¡ææ¥å¡å½±åï¼å³aåéæ°æ®æ¥ææ®µï¼båªåéç¡®è®¤æ¥ææ®µï¼å¹¶ä¸åéçªå£ä¸ä¼åå°æ¥å¡æ§å¶çå½±åï¼\n\nä¸æ¹è¡¨æ ¼ä¸ºå¾ä¼ è¾çæ°æ®çåºå·ã\n\n\n\nè¿æ¥å»ºç«åbç»aåéä¸ä¸ªç¡®è®¤æ¥ææ®µï¼rwnd=20, ack=23ï¼ä»£è¡¨æ»å¨çªå£å¤§å°ä¸º20ï¼ä¸ä¸æ¬¡ç»æä¼ åºå·ä¸º23çæ°æ®ã\n\nåéæ¹æ¥æ¶å°è¿ä¸ªç¡®è®¤æ¥ææ®µåæé åºèªå·±çåéçªå£ï¼å¤§å°ä¸º20å­èï¼åéçªå£ä»åºå·ä¸º23çæ°æ®å¼å§ï¼å®ç§°ä¸ºåæ²¿ï¼ç´å°åºå·ä¸º42çæ°æ®ç»æï¼å®ç§°ä¸ºåæ²¿ã\n\nå¹¶ä¸ï¼ç±äºack=23ï¼åéæ¹aå¯ä»¥å°23å·ä»¥åçæ°æ®ä»åéç¼å­ä¸­å é¤ï¼å¨æ¥æ¶å°ackä¹åï¼åéçªå£ä¸­çæ°æ®é½è¦çå¨åéç¼å­ä¸­ã\n\nåéçªå£ä¸­çæ°æ®é½æ¯å¯ä»¥åéçæ°æ®ï¼åéçªå£åæ²¿å³è¾¹çæ°æ®é½æ¯ä¸åè®¸åéçæ°æ®ã\n\nåæ²¿çç§»å¨æåµæä¸¤ç§ ï¼ä¸å¨ãåç§»\n\nåæ²¿çç§»å¨æåµæä¸ç§ ï¼ä¸å¨ãåç§»ãåç§»ã\n\næ¥ä¸æ¥aåbåé10ä¸ªå­èçæ°æ®ï¼åºå·ä¸º23-33çæ°æ®è¢«åéåºå»ï¼ä½æ¯å¹¶ä¸ä¼ä»åéç¼å­ä¸­å é¤ï¼å ä¸ºè¿æ²¡ææ¶å°ç¡®è®¤ackã\n\n\n\nåå¦æ¥æ¶æ¹bæ¶å°äºåºå·ä¸º25-27çæ°æ®ï¼ç±äº23-24çæ°æ®è¿æ²¡æ¥æ¶å°ï¼æä»¥båéçç¡®è®¤æ¥æçç¡®è®¤å·ä»ä¸º23ãè¿æ¯æ¥æ¶æ¹å¯¹23å·æ°æ®åèµ·çç¬¬ä¸æ¬¡éå¤ç¡®è®¤ï¼å æ­¤ä¸ä¼è§¦åè¶æ¶éä¼ æºå¶ãåæ¶æ¥æ¶çªå£ä¸º20æ²¡åã\n\n\n\nå½ä»¥å23-24å·æ°æ®ä¼ å°æ¥æ¶æ¹ï¼æ¥æ¶æ¹å°±ä¼åéå¯¹äº23-27å·æ°æ®çç¡®è®¤æ¥æï¼å¦ærwndçå¼ä»ä¸º20ï¼æ¥æ¶æ¹å°±ä¼å°æ¥æ¶çªå£ç§»å¨å°28-47å·æ°æ®ã\n\nåéæ¹æ¶å°è¯¥ç¡®è®¤æ¥æåå°23-27å·æ°æ®ä»åéç¼å­ä¸­å é¤ãåæ¶åéçªå£ç§»å¨å°28-47å·æ°æ®ã\n\n\n\nå½åéæ¹åéçæ°æ®è¿è¿æ æ³å°è¾¾æ¥æ¶æ¹ï¼éä¼ è®¡æ¶å¨è¶æ¶ï¼ä¼éä¼ åéçªå£åå·²åéçæ°æ®ï¼å¹¶éæ°å¯å¨éä¼ è®¡æ¶å¨ã\n\næ³¨æ ï¼\n\n 1. è½ç¶åéæ¹çåéçªå£æ¯æ ¹æ®æ¥æ¶æ¹çæ¥æ¶çªå£è®¾ç½®çï¼ä½æ¯å¨åä¸æ¶å»ï¼åéæ¹çåéçªå£å¹¶ä¸æ»æ¯åæ¥æ¶æ¹çæ¥æ¶çªå£ä¸æ ·å¤§ã\n    \n    å ä¸ºç½ç»å·æä¸å®çå»¶æ¶æ§ã\n\n 2. å¯¹äºä¸æåºåå·å°è¾¾çæ°æ®åºè¯¥å¦ä½å¤çï¼tcpå¹¶æ æç¡®è§å®\n    \n    * å¦æä¸¢å¼ï¼è½ç¶å®ç°æ´ç®åäºï¼ä½æ¯ä¼æµªè´¹å¾å¤ç½ç»èµæºã\n    * éå¸¸å­å¨å¨æ¥æ¶çªå£ä¸­ï¼ç­å°å­èæµä¸­æç¼ºå°çå­èæ¶å°åï¼åæåºå·äº¤ä»ç»ä¸å±çåºç¨è¿ç¨ã\n\n 3. tcpè¦æ±æ¥æ¶æ¹å¿é¡»æç´¯ç§¯ç¡®è®¤åæå¸¦ç¡®è®¤æºå¶ï¼è¿æ ·å¯ä»¥åå°ä¼ è¾å¼éãæ¥æ¶æ¹å¯ä»¥å¨åéçæ¶ååéç¡®è®¤ï¼ä¹å¯ä»¥å¨èªå·±ææ°æ®è¦åéæ¶æç¡®è®¤ä¿¡æ¯æå¸¦ä¸ãä½æ¯æ¥æ¶æ¹ä¸åºè¯¥è¿åæ¨è¿åéç¡®è®¤æ¶æ¯ï¼å¦åä¼è§¦åè¶æ¶éä¼ æµªè´¹èµæºã\n\n 4. tcpæ¯å¨åå·¥éä¿¡ï¼éä¿¡åæ¹é½å¨åéåæ¥åæ¥ææ®µï¼å æ­¤ï¼æ¯ä¸æ¹é½æèªå·±çåéçªå£åæ¥æ¶çªå£ãå¨è°å°è¿äºçªå£æ¶ï¼ä¸å®è¦åºåå¼ã\n\n\n# 3.7 tcpè¶æ¶éä¼ \n\nåæä¸ç´åè¯´å¦ææä¸æ®µæ¥æè¿è¿æ²¡æåéä¼è§¦åè¶æ¶éä¼ ï¼ä½å¹¶æ²¡æè¯´å¦ä½éæ©éä¼ çæ¶æºï¼ç°å¨å°±æ¥è¯´è¯´tcpå¯¹äºè¶æ¶éä¼ çæ¶æºéæ©ã\n\nè¶æ¶éä¼ æ¶é´ï¼rtoï¼çéæ©æ¯è®¡ç®æºç½ç»æå¤æçé®é¢ä¹ä¸ã\n\nåå¦åéæ¹ä¸ºaï¼æ¥æ¶æ¹ä¸ºbãåéæ¹aåæ¥æ¶æ¹båéæ°æ®æ¥ï¼å¹¶è®°å½æ¶é´ï¼aæ¶å°bçè¿åçç¡®è®¤æ¥ææ®µååæ¬¡è®°å½æ¶é´ã\n\nè¿ä¸¤ä¸ªæ¶é´çå·®å¼ä¸ºå¾è¿æ¶é´rttãå¦æè¶æ¶éä¼ æ¶é´è®¾ç½®çæ¯rttå°å¾å¤ï¼ä¼è§¦åä¸å¿è¦çéä¼ ãå¦æè®¾ç½®çæ¯rttå¤§å¾å¤ï¼è¿è¿ä¸è¶æ¶éä¼ å¤ªå½±åæçãæä»¥æä»¬è¦æ¾å°ä¸ä¸ªæ­£å¥½çæ¶é´ï¼è¿ä¸ªæ¶é´æ¯rttå¤§ä¸ç¹ï¼ä½å¤§çä¸å¤ã\n\n\n\nå¬èµ·æ¥å¾ç®åï¼ä½æ¯å¤æçç½ç»ç¯å¢ä½¿ä¼ è¾éçå¤æå¤åï¼rttä¹è·çååï¼æ©ä¸è·æä¸çç½ç»éçå·®å«é½å¾å¤§ãæä»¥è¶æ¶éä¼ æ¶é´ï¼rtoï¼çéæ©æ¯è®¡ç®æºç½ç»æå¤æçé®é¢ä¹ä¸ã\n\nè¿æ¶åå°±ä¸è½ä»¥åæ¬¡rttçå¼ç¡®å®rtoçå¼ï¼èæ¯ä½¿ç¨å¾å¤æ¬¡rttçå¼éè¿ä¸å®çç®æ³æ¥è®¡ç®åºä¸ä¸ªæ´å åéçrtoã\n\næä»¬ä½¿ç¨rttä»£è¡¨éè¿è®¡ç®å¾åºçrttçå¼ï¼rtt(i)ä»£è¡¨æ¯ä¸æ¬¡tcpéä¿¡äº§ççrttå¼\n\nå½ç¬¬ä¸æ¬¡rttäº§çæ¶ï¼æç»rttçå¼ç­äºç¬¬ä¸æ¬¡rttçå¼ãrtt = rtt(1)\n\nrttå¤èµ·æ¥çæ¶åï¼ä½¿ç¨å¬å¼ ï¼\n\n> rtt = (1-a)* ä¸ä¸æ¬¡rtt + a*rtt(i)\n\nå¨ä¸å¼ä¸­ï¼0 â¤ a < 1ï¼è¥aæ¥è¿äº0ï¼årtt(i)å¯¹rttçå¼çå½±åä¸å¤§ãè¥aæ¥è¿äº1ï¼årtt(i)å¯¹rttçå½±åè¾å¤§ãæ årfc298å»ºè®®açå¼ä¸º1/8\n\nå½éè¿æ¯ä¸æ¬¡çæ ·æ¬è®¡ç®å¾åºæç»rttåï¼æä»¬å°±å¯ä»¥è§å®è¶æ¶éä¼ æ¶é´rtoç¥å¤§äºrttäºã\n\n> è³æ­¤ï¼tcpå°±åä¸æ®µè½äºã\n\n\n# 4. udp\n\nç±äºudpååºç¨å±æä¾æ è¿æ¥ä¸å¯é çéä¿¡æå¡ï¼æä»¥å®æ éåtcpé£æ ·å®ç°æµéæ§å¶ãæ¥å¡æ§å¶ç­ç­åè½ï¼å®çå­æ®µä¹ååç®åã\n\nä¸ä¸ªudpç¨æ·æ°æ®æ¥åæ ·ç±é¦é¨ä¸æ°æ®è½½è·ä¸¤é¨åç»æï¼é¦é¨æ ¼å¼å¦å¾æç¤ºã\n\n\n\nå®åªæåä¸ªå­æ®µï¼æ¯ä¸ªå­æ®µä¸¤ä¸ªå­èå±å«ä¸ªå­èãç±äºudpæä¾æ è¿æ¥ä¸å¯é çæå¡ï¼æä»¥å®åªå¨ç½éå±çåºç¡ä¸æ·»å äºç«¯å£å·çåºåã\n\n> è³æ­¤ï¼udpåä¸æ®µè½ãããææªï¼udpçåè½ä¼å¨ä¸å°èudpä¸tcpçåºå«ä¸­æ³¨æãå ä¸ºå®å¨å¤ªå°ããã\n\n\n# 5.tcpä¸udpçåºå«\n\ntcpä¸udpææçåºå«é½æ¯åºäºä¸ä¸ªæ¡ä»¶ ï¼tcpæä¾æè¿æ¥å¯é æ§ä¼ è¾æå¡ï¼udpæä¾æ è¿æ¥ä¸å¯é æå¡ã\n\nå¦ætcpä¸æä¾å¯é æå¡ï¼é£ä»ä¿©å°±ä¸æ ·äºã\n\n 1. tcpä¼ è¾æ°æ®åéè¦ä¸æ¥ææ¡æå»ºç«è¿æ¥ï¼ä¼ è¾æ°æ®ç»ææ¶åæ¥ææ¥ææ­å¼è¿æ¥ã\n    \n    udpå¯ä»¥éæ¶åéæ°æ®ãåªè¦ä½ ç¥éå®çipå°±å¯ä»¥çªç¶åéæ°æ®ã\n\n 2. tcpåªæ¯æä¸å¯¹ä¸çsoloæ¨¡å¼ï¼è¿æ¥åªè½å¨ä¸¤ä¸ªä¸»æºä¹é´è¿è¡ã\n    \n    udpæ¯æåæ­ãå¤æ­ãå¹¿æ­ã\n\n 3. å½åºç¨å±æ¥æåéå°ä¼ è¾å±æ¶\n    \n    tcpå°åºç¨å±ä¼ è¾çæ¥ææåä¸ºå¤ä¸ªå­èæµæ ä¸åºå·ï¼åå ä¸tcpé¦é¨å°è£ä¸ºtcpæ°æ®æ¥ï¼åæ ¹æ®åéç­ç¥åéç»ä¸å±ãtcpæ¯é¢åå­èæµçã\n    \n    udpä»ä»å°åºç¨å±æ¥æé¦é¨æ·»å ä¸ä¸ªudpé¦é¨å°è£ä¸ºudpæ°æ®æ¥ï¼å°±å°è¯¥æ°æ®æ¥åéç»æ¥åæ¹ãudpæ¯é¢åæ°æ®æ¥çã\n\n 4. å¦ææ°æ®ä¼ è¾è¿ç¨ä¸­æ°æ®ä¸¢å¤±ãè¯¯ç \n    \n    tcpä¼éæ°åéæè§¦åéä¼ æºå¶ã\n    \n    udpå¥ä¹ä¸å¹²ã\n\næåï¼å¯¹æ¯ä¸ä¸udpæ°æ®æ¥é¦é¨ä»¥åtcpæ°æ®æ¥çé¦é¨æ ¼å¼ï¼\n\n",charsets:{cjk:!0},lastUpdated:"2023/06/14, 19:46:55",lastUpdatedTimestamp:1686743215e3},{title:"åå­ç±»",frontmatter:{title:"åå­ç±»",date:"2023-07-17T21:28:31.000Z",permalink:"/pages/0776e3/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/100.%E5%8E%9F%E5%AD%90%E7%B1%BB.html",relativePath:"02.æç« /75.Javaå¹¶å/100.åå­ç±».md",key:"v-4cfac2ae",path:"/pages/0776e3/",headers:[{level:2,title:"åå­ç±»",slug:"åå­ç±»",normalizedTitle:"åå­ç±»",charIndex:2}],headersStr:"åå­ç±»",content:"# åå­ç±»\n\nåå­ç±»æ¯å¯¹ CAS ææ³çåºç¨ã\nä»ä¹æ¯åå­ç±»ï¼\nå¯¹äº int ç±»åï¼å /åæä½å¹¶ä¸æ¯ä¸æ¬¡æ§çï¼è½ç¶æä»¬å¨åä»£ç çæ¶åç´æ¥ i++ãi-- äºï¼ä½æ¯å¨åºå±å¶å®åä¸ºä¸æ­¥ ï¼\n\n 1. æåéä»å°åä¸­ååº\n 2. ç»åéå /å\n 3. å°åéæ¾å°å°åä¸­\n\nå¦ææ³è¦å®ç°å¤çº¿ç¨ä¸ int ç±»å i++ ççº¿ç¨å®å¨å°±å¿é¡»ä½¿ç¨ synchronized åèµ·æ¥ã\n\nsynchronized(lock) {\n    i++\n}\n\n\nä½æ¯ä½¿ç¨ java.util.concurrent.atomic åä¸çåå­ç±»å°±ä¸éè¦å  synchronized éã\n\n\nä¸ºä»ä¹è¯´ åå­ç±»æ¯å¯¹ CAS ææ³çåºç¨ å¢ ï¼\nä¸¾ä¸ªä¾å­ï¼çç AtomicInteger çé¨åä»£ç ï¼\n\npublic final int getAndIncrement() {\n    return unsafe.getAndAddInt(this, valueOffset, 1);\n}\npublic final int getAndDecrement() {\n    return unsafe.getAndAddInt(this, valueOffset, -1);\n}\npublic final int getAndAdd(int delta) {\n    return unsafe.getAndAddInt(this, valueOffset, delta);\n}\npublic final int incrementAndGet() {\n    return unsafe.getAndAddInt(this, valueOffset, 1) + 1;\n}\npublic final int decrementAndGet() {\n    return unsafe.getAndAddInt(this, valueOffset, -1) - 1;\n}\npublic final int addAndGet(int delta) {\n    return unsafe.getAndAddInt(this, valueOffset, delta) + delta;\n}\n\n\nå¨é½åå©äº Unsafe ç±»çä¸äºæ¹æ³ï¼è Unsafe æä¾äºæ´å åºå±çå¯¹äº CAS å®ç°ã\nä¹å°±æ¯è¯´åå­ç±»çåå­ç¹ç¹æ¯ Unsafe ä½¿ç¨ CAS ä¿è¯çã",normalizedContent:"# åå­ç±»\n\nåå­ç±»æ¯å¯¹ cas ææ³çåºç¨ã\nä»ä¹æ¯åå­ç±»ï¼\nå¯¹äº int ç±»åï¼å /åæä½å¹¶ä¸æ¯ä¸æ¬¡æ§çï¼è½ç¶æä»¬å¨åä»£ç çæ¶åç´æ¥ i++ãi-- äºï¼ä½æ¯å¨åºå±å¶å®åä¸ºä¸æ­¥ ï¼\n\n 1. æåéä»å°åä¸­ååº\n 2. ç»åéå /å\n 3. å°åéæ¾å°å°åä¸­\n\nå¦ææ³è¦å®ç°å¤çº¿ç¨ä¸ int ç±»å i++ ççº¿ç¨å®å¨å°±å¿é¡»ä½¿ç¨ synchronized åèµ·æ¥ã\n\nsynchronized(lock) {\n    i++\n}\n\n\nä½æ¯ä½¿ç¨ java.util.concurrent.atomic åä¸çåå­ç±»å°±ä¸éè¦å  synchronized éã\n\n\nä¸ºä»ä¹è¯´ åå­ç±»æ¯å¯¹ cas ææ³çåºç¨ å¢ ï¼\nä¸¾ä¸ªä¾å­ï¼çç atomicinteger çé¨åä»£ç ï¼\n\npublic final int getandincrement() {\n    return unsafe.getandaddint(this, valueoffset, 1);\n}\npublic final int getanddecrement() {\n    return unsafe.getandaddint(this, valueoffset, -1);\n}\npublic final int getandadd(int delta) {\n    return unsafe.getandaddint(this, valueoffset, delta);\n}\npublic final int incrementandget() {\n    return unsafe.getandaddint(this, valueoffset, 1) + 1;\n}\npublic final int decrementandget() {\n    return unsafe.getandaddint(this, valueoffset, -1) - 1;\n}\npublic final int addandget(int delta) {\n    return unsafe.getandaddint(this, valueoffset, delta) + delta;\n}\n\n\nå¨é½åå©äº unsafe ç±»çä¸äºæ¹æ³ï¼è unsafe æä¾äºæ´å åºå±çå¯¹äº cas å®ç°ã\nä¹å°±æ¯è¯´åå­ç±»çåå­ç¹ç¹æ¯ unsafe ä½¿ç¨ cas ä¿è¯çã",charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"è®¡ç®æºç½ç»äºå±ç½ç»æ¨¡å",frontmatter:{title:"è®¡ç®æºç½ç»äºå±ç½ç»æ¨¡å",date:"2023-06-14T19:44:30.000Z",permalink:"/pages/71bea1/"},regularPath:"/02.%E6%96%87%E7%AB%A0/70.%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/4.%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BA%94%E5%B1%82%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.html",relativePath:"02.æç« /70.è®¡ç®æºç½ç»/4.è®¡ç®æºç½ç»äºå±ç½ç»æ¨¡å.md",key:"v-366aefd3",path:"/pages/71bea1/",headers:[{level:2,title:"0. æ¦è¿°",slug:"_0-æ¦è¿°",normalizedTitle:"0. æ¦è¿°",charIndex:13},{level:2,title:"1. åºç¨å±",slug:"_1-åºç¨å±",normalizedTitle:"1. åºç¨å±",charIndex:226},{level:2,title:"2. è¿è¾å±",slug:"_2-è¿è¾å±",normalizedTitle:"2. è¿è¾å±",charIndex:332},{level:2,title:"3. ç½ç»å±",slug:"_3-ç½ç»å±",normalizedTitle:"3. ç½ç»å±",charIndex:628},{level:2,title:"4. æ°æ®é¾è·¯å±",slug:"_4-æ°æ®é¾è·¯å±",normalizedTitle:"4. æ°æ®é¾è·¯å±",charIndex:778},{level:2,title:"5. ç©çå±",slug:"_5-ç©çå±",normalizedTitle:"5. ç©çå±",charIndex:1006}],headersStr:"0. æ¦è¿° 1. åºç¨å± 2. è¿è¾å± 3. ç½ç»å± 4. æ°æ®é¾è·¯å± 5. ç©çå±",content:"# äºå±ç½ç»æ¨¡å\n\n\n# 0. æ¦è¿°\n\nè®¡ç®æºç½ç»å¯ä»¥åä¸º7å±ã5å±ã4å±ç½ç»æ¨¡å\n\n\n\nå¶ä¸­5å±æ¨¡åä»ä¸å°ä¸ä¾æ¬¡ä¸ºï¼\n\n 5. åºç¨å± ï¼äº«åå¶ä¸åå±æä¾çæå¡ï¼è§£å³éè¿åºç¨è¿ç¨çäº¤äºæ¥å®ç°ç¹å®ç½ç»åºç¨çé®é¢\n\n 6. ä¼ è¾å± ï¼è§£å³è¿ç¨ä¹é´åºäºç½ç»çéä¿¡é®é¢\n\n 7. ç½ç»å± ï¼è§£å³åç»å¨å¤ä¸ªç½ç»ä¸ä¼ è¾çé®é¢\n\n 8. æ°æ®é¾è·¯å± ï¼è§£å³åç»å¨ä¸ä¸ªç½ç»ï¼æä¸æ®µé¾è·¯ï¼ä¸ä¼ è¾çé®é¢\n\n 9. ç©çå± ï¼è§£å³ä½¿ç¨ä½ç§ä¿¡å·æ¥ä¼ è¾æ¯ç¹çé®é¢\n\n\n\n\n# 1. åºç¨å±\n\nåºç¨å±æ¶è®¡ç®æºç½ç»ä½ç³»ç»æçæé¡¶å±ï¼æ¯è®¾è®¡åå»ºç«è®¡ç®æºç½ç»çæç»ç®çï¼ä¹æ¯è®¡ç®æºç½ç»ä¸­åå±æå¿«çä¸é¨åã\n\nå¶å¸¸ç¨çåè®®æ ï¼å¨æä¸»æºéç½®åè®®DHCPï¼è¶ææ¬ä¼ è¾åè®®HTTPãHTTPS\n\n\n# 2. è¿è¾å±\n\nç©çå±ãæ°æ®é¾è·¯å±ä»¥åç½ç»å±å±åè§£å³äºå°ä¸»æºéè¿å¼æç½ç»äºèèµ·æ¥æé¢ä¸´çé®é¢ï¼å®ç°äºä¸»æºå°ä¸»æºçéä¿¡ã\n\nä½å®éä¸è®¡ç®æºç½ç»ä¸­è¿è¡éä¿¡ççæ­£å®ä½æ¯ä½äºéä¿¡ä¸¤ç«¯ä¸»æºçè¿ç¨ï¼è¿ä¸ªè¿ç¨å°±ç±è¿è¾å±å®æã\n\nè¿è¾å±ååºç¨å±å±è½äºä¸é¢ç½ç»æ ¸å¿çç»èï¼å¦ç½ç»ææãè·¯ç±éæ©ï¼ï¼å®ä½¿åºç¨è¿ç¨çè§çå¥½åæ¯å¨ä¸¤ä¸ªè¿è¾å±å®ä½ä¹é´æä¸æ¡ç«¯å°ç«¯çé»è¾éä¿¡ä¿¡éãæ³¨æåªæ¯é»è¾ä¸çï¼ä¸æ¯ç©çä¸çãå®ç»åºç¨å±æä¾äºæ è¿æ¥ä¸å¯é çä¼ è¾æå¡ä»¥åé¢åè¿æ¥çå¯é ä¼ è¾æå¡ã\n\næ ¹æ®åºç¨éæ±çä¸åï¼è¿è¾å±ä¸ºåºç¨å±æä¾äºä¸¤ç§ä¸åçåºç¨åè®®ï¼å³æ è¿æ¥çUDPåé¢åè¿æ¥çTCPãæ´ä¸ªè¿è¾å±å´ç»è¿ä¸¤ä¸ªåè®®å±å¼ã\n\n\n\n\n# 3. ç½ç»å±\n\nç½ç»å±çä¸»è¦ä»»å¡å°±æ¯å°åç»ä»æºä¸»æºç»è¿å¤ä¸ªç½ç»åå¤æ®µé¾è·¯ä¼ è¾å°ç®çä¸»æºï¼å¯ä»¥å°è¯¥ä»»å¡ååä¸ºåç»è½¬ååè·¯ç±éæ©ä¸¤ç§éè¦çåè½ã\n\nç½ç»å±åå¶ä¸å±ï¼åºç¨å±ãè¿è¾å±ï¼æä¾çä¸¤ç§æå¡ ï¼é¢åè¿æ¥çèçµè·¯æå¡ãæ è¿æ¥çæ°æ®æ¥æå¡ã\n\nå¶ä¸»è¦çåè®®ä¸º ï¼ç½éåè®®IPãè·¯ç±åè®®RIP\n\n\n\n\n# 4. æ°æ®é¾è·¯å±\n\næ°æ®é¾è·¯å±å¨äºå±æ¨¡åä¸­ä½äºç©çå±çä¸é¨ï¼å¶ä»é¨åçä¸é¨ã\n\né¾è·¯ï¼Linkï¼æ¯æä»ä¸ä¸ªèç¹å°ç¸é»èç¹çä¸æ®µç©ççº¿è·¯ï¼èä¸­é´æ²¡æä»»ä½å¶ä»çäº¤æ¢èç¹ã\n\næ°æ®é¾è·¯ï¼Data Linkï¼æ¯åºäºé¾è·¯çãå¨ä¸æ¡é¾è·¯ä¸ä¼ è¾æ°æ®æ¶ï¼é¤äºéè¦é¾è·¯æ¬èº«ï¼è¿éè¦ä¸äºå¿è¦çéä¿¡åè®®æ¥æ§å¶è¿äºæ°æ®çä¼ è¾ï¼æå®ç°è¿äºåè®®çç¡¬ä»¶åè½¯ä»¶å å°é¾è·¯ä¸ï¼å°±ææäºæ°æ®é¾è·¯ã\n\nå¸§ï¼Frameï¼æ¯æ°æ®é¾è·¯å±å¯¹ç­å®ä½ä¹é´å¨æ°´å¹³æ¹åè¿è¡é»è¾éä¿¡çåè®®æ°æ®ååPDUã\n\n\n# 5. ç©çå±\n\nç©çå±è§£å³äºå¨åç§ä¼ è¾åªä½ä¸ä¼ è¾æ¯ç¹0å1çé®é¢ï¼è¿èç»æ°æ®é¾è·¯å±æä¾âéæâä¼ è¾æ¯ç¹æµçæå¡ãæè°âéæâæ¯ææ°æ®é¾è·¯å±ä¸ç¥éä¹ä¸å¿ç¥éç©çå±ç©¶ç«å¦ä½ä¼ è¾æ¯ç¹æµçï¼å®åªéè¦äº«åç©çå±æä¾çä¼ è¾æå¡å³å¯ã\n\nâ",normalizedContent:"# äºå±ç½ç»æ¨¡å\n\n\n# 0. æ¦è¿°\n\nè®¡ç®æºç½ç»å¯ä»¥åä¸º7å±ã5å±ã4å±ç½ç»æ¨¡å\n\n\n\nå¶ä¸­5å±æ¨¡åä»ä¸å°ä¸ä¾æ¬¡ä¸ºï¼\n\n 5. åºç¨å± ï¼äº«åå¶ä¸åå±æä¾çæå¡ï¼è§£å³éè¿åºç¨è¿ç¨çäº¤äºæ¥å®ç°ç¹å®ç½ç»åºç¨çé®é¢\n\n 6. ä¼ è¾å± ï¼è§£å³è¿ç¨ä¹é´åºäºç½ç»çéä¿¡é®é¢\n\n 7. ç½ç»å± ï¼è§£å³åç»å¨å¤ä¸ªç½ç»ä¸ä¼ è¾çé®é¢\n\n 8. æ°æ®é¾è·¯å± ï¼è§£å³åç»å¨ä¸ä¸ªç½ç»ï¼æä¸æ®µé¾è·¯ï¼ä¸ä¼ è¾çé®é¢\n\n 9. ç©çå± ï¼è§£å³ä½¿ç¨ä½ç§ä¿¡å·æ¥ä¼ è¾æ¯ç¹çé®é¢\n\n\n\n\n# 1. åºç¨å±\n\nåºç¨å±æ¶è®¡ç®æºç½ç»ä½ç³»ç»æçæé¡¶å±ï¼æ¯è®¾è®¡åå»ºç«è®¡ç®æºç½ç»çæç»ç®çï¼ä¹æ¯è®¡ç®æºç½ç»ä¸­åå±æå¿«çä¸é¨åã\n\nå¶å¸¸ç¨çåè®®æ ï¼å¨æä¸»æºéç½®åè®®dhcpï¼è¶ææ¬ä¼ è¾åè®®httpãhttps\n\n\n# 2. è¿è¾å±\n\nç©çå±ãæ°æ®é¾è·¯å±ä»¥åç½ç»å±å±åè§£å³äºå°ä¸»æºéè¿å¼æç½ç»äºèèµ·æ¥æé¢ä¸´çé®é¢ï¼å®ç°äºä¸»æºå°ä¸»æºçéä¿¡ã\n\nä½å®éä¸è®¡ç®æºç½ç»ä¸­è¿è¡éä¿¡ççæ­£å®ä½æ¯ä½äºéä¿¡ä¸¤ç«¯ä¸»æºçè¿ç¨ï¼è¿ä¸ªè¿ç¨å°±ç±è¿è¾å±å®æã\n\nè¿è¾å±ååºç¨å±å±è½äºä¸é¢ç½ç»æ ¸å¿çç»èï¼å¦ç½ç»ææãè·¯ç±éæ©ï¼ï¼å®ä½¿åºç¨è¿ç¨çè§çå¥½åæ¯å¨ä¸¤ä¸ªè¿è¾å±å®ä½ä¹é´æä¸æ¡ç«¯å°ç«¯çé»è¾éä¿¡ä¿¡éãæ³¨æåªæ¯é»è¾ä¸çï¼ä¸æ¯ç©çä¸çãå®ç»åºç¨å±æä¾äºæ è¿æ¥ä¸å¯é çä¼ è¾æå¡ä»¥åé¢åè¿æ¥çå¯é ä¼ è¾æå¡ã\n\næ ¹æ®åºç¨éæ±çä¸åï¼è¿è¾å±ä¸ºåºç¨å±æä¾äºä¸¤ç§ä¸åçåºç¨åè®®ï¼å³æ è¿æ¥çudpåé¢åè¿æ¥çtcpãæ´ä¸ªè¿è¾å±å´ç»è¿ä¸¤ä¸ªåè®®å±å¼ã\n\n\n\n\n# 3. ç½ç»å±\n\nç½ç»å±çä¸»è¦ä»»å¡å°±æ¯å°åç»ä»æºä¸»æºç»è¿å¤ä¸ªç½ç»åå¤æ®µé¾è·¯ä¼ è¾å°ç®çä¸»æºï¼å¯ä»¥å°è¯¥ä»»å¡ååä¸ºåç»è½¬ååè·¯ç±éæ©ä¸¤ç§éè¦çåè½ã\n\nç½ç»å±åå¶ä¸å±ï¼åºç¨å±ãè¿è¾å±ï¼æä¾çä¸¤ç§æå¡ ï¼é¢åè¿æ¥çèçµè·¯æå¡ãæ è¿æ¥çæ°æ®æ¥æå¡ã\n\nå¶ä¸»è¦çåè®®ä¸º ï¼ç½éåè®®ipãè·¯ç±åè®®rip\n\n\n\n\n# 4. æ°æ®é¾è·¯å±\n\næ°æ®é¾è·¯å±å¨äºå±æ¨¡åä¸­ä½äºç©çå±çä¸é¨ï¼å¶ä»é¨åçä¸é¨ã\n\né¾è·¯ï¼linkï¼æ¯æä»ä¸ä¸ªèç¹å°ç¸é»èç¹çä¸æ®µç©ççº¿è·¯ï¼èä¸­é´æ²¡æä»»ä½å¶ä»çäº¤æ¢èç¹ã\n\næ°æ®é¾è·¯ï¼data linkï¼æ¯åºäºé¾è·¯çãå¨ä¸æ¡é¾è·¯ä¸ä¼ è¾æ°æ®æ¶ï¼é¤äºéè¦é¾è·¯æ¬èº«ï¼è¿éè¦ä¸äºå¿è¦çéä¿¡åè®®æ¥æ§å¶è¿äºæ°æ®çä¼ è¾ï¼æå®ç°è¿äºåè®®çç¡¬ä»¶åè½¯ä»¶å å°é¾è·¯ä¸ï¼å°±ææäºæ°æ®é¾è·¯ã\n\nå¸§ï¼frameï¼æ¯æ°æ®é¾è·¯å±å¯¹ç­å®ä½ä¹é´å¨æ°´å¹³æ¹åè¿è¡é»è¾éä¿¡çåè®®æ°æ®ååpduã\n\n\n# 5. ç©çå±\n\nç©çå±è§£å³äºå¨åç§ä¼ è¾åªä½ä¸ä¼ è¾æ¯ç¹0å1çé®é¢ï¼è¿èç»æ°æ®é¾è·¯å±æä¾âéæâä¼ è¾æ¯ç¹æµçæå¡ãæè°âéæâæ¯ææ°æ®é¾è·¯å±ä¸ç¥éä¹ä¸å¿ç¥éç©çå±ç©¶ç«å¦ä½ä¼ è¾æ¯ç¹æµçï¼å®åªéè¦äº«åç©çå±æä¾çä¼ è¾æå¡å³å¯ã\n\nâ",charsets:{cjk:!0},lastUpdated:"2023/06/14, 19:46:55",lastUpdatedTimestamp:1686743215e3},{title:"FutureTaskä¸­çééå¨æ¨¡å¼",frontmatter:{title:"FutureTaskä¸­çééå¨æ¨¡å¼",date:"2024-02-22T19:57:13.000Z",permalink:"/pages/c1826d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/250.FutureTask%E4%B8%AD%E7%9A%84%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F.html",relativePath:"02.æç« /75.Javaå¹¶å/250.FutureTaskä¸­çééå¨æ¨¡å¼.md",key:"v-11139ae4",path:"/pages/c1826d/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:2,title:"2. æ­£æ",slug:"_2-æ­£æ",normalizedTitle:"2. æ­£æ",charIndex:206}],headersStr:"1. åè¨ 2. æ­£æ",content:"# 1. åè¨\n\nFutureTask çæºç è§£æ ï¼https://2382546457.github.io/pages/937dd3/\n\nè¿ç¯æç« æ¥è®²ä¸ä¸ FutureTask ä½¿ç¨çééå¨è®¾è®¡æ¨¡å¼ã\n\nééå¨è®¾è®¡æ¨¡å¼å¨ç½ä¸çè§£æä¹å¾å¤ï¼æ»èè¨ä¹ä¸å¥è¯ ï¼å°ä¸ä¸ªç±»è½¬æ¢ä¸ºæ³è¦çå¦ä¸ä¸ªç±»ã\n\næ½è±¡ï¼å¾æ½è±¡ï¼å¹¶ä¸ç½ä¸å¾å¤æç« ä¸¾çä¾å­ä¹å¾çï¼æ¬çæç« ä½ å°çå° JDK æºç å±é¢å¯¹äº ééå¨è®¾è®¡æ¨¡å¼çä½¿ç¨ã\n\n\n# 2. æ­£æ\n\nåé¡¾ä¸ä¸ FutureTask çä½¿ç¨ï¼æä¸¤ç§æ¹å¼ ï¼\n\n 1. è·å¾ä»»å¡æ§è¡è¿åå¼ç Callable\n    \n            FutureTask<Integer> task = new FutureTask<>(() -> {\n                int a = 10;\n                return a * 10;\n            });\n    \n\n 2. è·å¾æå®è¿åå¼ç Runnable\n    \n            FutureTask<Integer> task = new FutureTask<>(() -> {\n                System.out.println();\n                System.out.println();\n                System.out.println();\n            }, 1);\n    \n\nä½æ¯å¦æä½ çè¿ FutureTask çæºç å°±ä¼ç¥éï¼FutureTask åé¨åªæä¸ä¸ª Callable ç±»åçåéï¼é£æä»¬æäº¤ç Runnable æä¹åæ Callable å¢ï¼è¿å°±æ¯ FutureTask ä¸­çééå¨æ¨¡å¼ã\n\næ¥çæäº¤ Runnable æ¶çæé æ¹æ³ï¼\n\npublic FutureTask(Runnable runnable, V result) {\n    this.callable = Executors.callable(runnable, result);\n    this.state = NEW;       // ensure visibility of callable\n}\n\n\nå½æäº¤ Runnable æ¶ï¼ä½¿ç¨ Executors.callable(runnable, result) å°±å¯ä»¥è¿åä¸ä¸ª Callable ç±»åçåéã\n\nè¿éæä»¬çæµ ï¼Executors.callable æ¹æ³ä¼è¿åä¸ä¸ª Callable çå®ç°ç±»\n\n    public static <T> Callable<T> callable(Runnable task, T result) {\n        if (task == null)\n            throw new NullPointerException();\n        return new RunnableAdapter<T>(task, result);\n    }\n\n\næç¶ï¼çå° RunnableAdapter æ²¡ ï¼åªè¦çå° Adapter å°±è½ç¥éå®ä½¿ç¨äºééå¨æ¨¡å¼äºãRunnableAdapter ç»§æ¿äº Callable ï¼å¨ call æ¹æ³ä¸­è°ç¨äº Runnable.run()\n\n    static final class RunnableAdapter<T> implements Callable<T> {\n        final Runnable task;\n        final T result;\n        RunnableAdapter(Runnable task, T result) {\n            this.task = task;\n            this.result = result;\n        }\n        public T call() {\n            task.run();\n            return result;\n        }\n    }\n\n\né£ä¹ FutureTask å¨ä½¿ç¨ callable.call() æ¶æä¸¤ç§å¯è½ ï¼\n\n 1. è°ç¨äºæä»¬æäº¤ç Callable å®ç°ç±»\n 2. è°ç¨äºç»è¿ééå¨æ¨¡å¼ä¿®é¥°ä¹åç RunnableAdapterï¼å¨ call() æ¹æ³ä¸­è°ç¨ Runnable.run()",normalizedContent:"# 1. åè¨\n\nfuturetask çæºç è§£æ ï¼https://2382546457.github.io/pages/937dd3/\n\nè¿ç¯æç« æ¥è®²ä¸ä¸ futuretask ä½¿ç¨çééå¨è®¾è®¡æ¨¡å¼ã\n\nééå¨è®¾è®¡æ¨¡å¼å¨ç½ä¸çè§£æä¹å¾å¤ï¼æ»èè¨ä¹ä¸å¥è¯ ï¼å°ä¸ä¸ªç±»è½¬æ¢ä¸ºæ³è¦çå¦ä¸ä¸ªç±»ã\n\næ½è±¡ï¼å¾æ½è±¡ï¼å¹¶ä¸ç½ä¸å¾å¤æç« ä¸¾çä¾å­ä¹å¾çï¼æ¬çæç« ä½ å°çå° jdk æºç å±é¢å¯¹äº ééå¨è®¾è®¡æ¨¡å¼çä½¿ç¨ã\n\n\n# 2. æ­£æ\n\nåé¡¾ä¸ä¸ futuretask çä½¿ç¨ï¼æä¸¤ç§æ¹å¼ ï¼\n\n 1. è·å¾ä»»å¡æ§è¡è¿åå¼ç callable\n    \n            futuretask<integer> task = new futuretask<>(() -> {\n                int a = 10;\n                return a * 10;\n            });\n    \n\n 2. è·å¾æå®è¿åå¼ç runnable\n    \n            futuretask<integer> task = new futuretask<>(() -> {\n                system.out.println();\n                system.out.println();\n                system.out.println();\n            }, 1);\n    \n\nä½æ¯å¦æä½ çè¿ futuretask çæºç å°±ä¼ç¥éï¼futuretask åé¨åªæä¸ä¸ª callable ç±»åçåéï¼é£æä»¬æäº¤ç runnable æä¹åæ callable å¢ï¼è¿å°±æ¯ futuretask ä¸­çééå¨æ¨¡å¼ã\n\næ¥çæäº¤ runnable æ¶çæé æ¹æ³ï¼\n\npublic futuretask(runnable runnable, v result) {\n    this.callable = executors.callable(runnable, result);\n    this.state = new;       // ensure visibility of callable\n}\n\n\nå½æäº¤ runnable æ¶ï¼ä½¿ç¨ executors.callable(runnable, result) å°±å¯ä»¥è¿åä¸ä¸ª callable ç±»åçåéã\n\nè¿éæä»¬çæµ ï¼executors.callable æ¹æ³ä¼è¿åä¸ä¸ª callable çå®ç°ç±»\n\n    public static <t> callable<t> callable(runnable task, t result) {\n        if (task == null)\n            throw new nullpointerexception();\n        return new runnableadapter<t>(task, result);\n    }\n\n\næç¶ï¼çå° runnableadapter æ²¡ ï¼åªè¦çå° adapter å°±è½ç¥éå®ä½¿ç¨äºééå¨æ¨¡å¼äºãrunnableadapter ç»§æ¿äº callable ï¼å¨ call æ¹æ³ä¸­è°ç¨äº runnable.run()\n\n    static final class runnableadapter<t> implements callable<t> {\n        final runnable task;\n        final t result;\n        runnableadapter(runnable task, t result) {\n            this.task = task;\n            this.result = result;\n        }\n        public t call() {\n            task.run();\n            return result;\n        }\n    }\n\n\né£ä¹ futuretask å¨ä½¿ç¨ callable.call() æ¶æä¸¤ç§å¯è½ ï¼\n\n 1. è°ç¨äºæä»¬æäº¤ç callable å®ç°ç±»\n 2. è°ç¨äºç»è¿ééå¨æ¨¡å¼ä¿®é¥°ä¹åç runnableadapterï¼å¨ call() æ¹æ³ä¸­è°ç¨ runnable.run()",charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"FutureTaskæºç è§£æ",frontmatter:{title:"FutureTaskæºç è§£æ",date:"2023-11-25T21:05:37.000Z",permalink:"/pages/937dd3/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/200.FutureTask%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html",relativePath:"02.æç« /75.Javaå¹¶å/200.FutureTaskæºç è§£æ.md",key:"v-98ff3c9c",path:"/pages/937dd3/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. FutureTask ä¸­çåé",slug:"_2-futuretask-ä¸­çåé",normalizedTitle:"2. futuretask ä¸­çåé",charIndex:1484},{level:3,title:"2.1 FutureTask ä¸­çç¶æåé",slug:"_2-1-futuretask-ä¸­çç¶æåé",normalizedTitle:"2.1 futuretask ä¸­çç¶æåé",charIndex:1647},{level:3,title:"2.2 FutureTask ä¸­çé¾è¡¨åé",slug:"_2-2-futuretask-ä¸­çé¾è¡¨åé",normalizedTitle:"2.2 futuretask ä¸­çé¾è¡¨åé",charIndex:3591},{level:2,title:"3. FutureTask.run()",slug:"_3-futuretask-run",normalizedTitle:"3. futuretask.run()",charIndex:7623},{level:2,title:"4. FutureTask.get()",slug:"_4-futuretask-get",normalizedTitle:"4. futuretask.get()",charIndex:8930},{level:2,title:"5. FutureTask.set()",slug:"_5-futuretask-set",normalizedTitle:"5. futuretask.set()",charIndex:11249},{level:2,title:"6. æ»ç»",slug:"_6-æ»ç»",normalizedTitle:"6. æ»ç»",charIndex:14936}],headersStr:"1. ç®è¿° 2. FutureTask ä¸­çåé 2.1 FutureTask ä¸­çç¶æåé 2.2 FutureTask ä¸­çé¾è¡¨åé 3. FutureTask.run() 4. FutureTask.get() 5. FutureTask.set() 6. æ»ç»",content:'# 1. ç®è¿°\n\nFutureTask å®ç°äº RunnableãFutureï¼å¯ä»¥è¿è¡ä»»å¡çå¼æ­¥æ§è¡ï¼ä½æ¯ FutureTask ä¼é»å¡ä¸»çº¿ç¨ã\n\nå®æä¾äºä¸¤ä¸ªåè½ ï¼\n\n 1. æ§è¡ä»»å¡\n 2. é»å¡ç­å¾ä»»å¡æ§è¡å®æ¯\n\npublic static void main(String[] args) throws ExecutionException, InterruptedException {\n    Callable<String> callable = new Callable<String>() {\n        @Override\n        public String call() throws Exception {\n            // å¤çä¸å¡\n            return "æ§è¡ç»æ";\n        }\n    };\n\n    FutureTask<String> futureTask = new FutureTask<>(callable);\n    // æ§è¡ä»»å¡\n    futureTask.run();\n    // é»å¡ç­å¾ç»æ\n    futureTask.get();\n}\n\n\nä»ä»£ç ä¸­å¯ä»¥çæµ ï¼\n\n * FutureTask åé¨æä¸ä¸ª Callable åé\n * FutureTask.run() è°ç¨äº callable.call() å»è·åç»æ\n * æ­¤æ¶ FutureTask.get() çç»æä¼æ¯nullï¼ææ§è¡ FutureTask.get() ççº¿ç¨ä¼é»å¡ï¼Callable.call() æ¹æ³è¿è¡ã\n * Callable.run() æ¹æ³ç»æï¼å°è¿è¡çç»æäº¤ç» FutureTaskï¼FutureTask åæ­¢é»å¡ã\n\n\n\næ³è¦ææ FutureTask çæºç ï¼å¿é¡»è¦ææå®åäºä»ä¹ï¼æ ¹æ®ä¸é¢çéè¿°å¯ä»¥ç®åçæµï¼\n\n 1. FutureTask ä¸­çåéä¸ä»æ Callableï¼è¿æ Callable æ§è¡åçç»æ resultï¼Callable æ§è¡åå°ç»æè®¾ç½®ç» resultã\n 2. FutureTask.get() æ¹æ³ç¨ while(true) å¾ªç¯æ£æ¥resultï¼å¦æä¸ºç©ºè¯´ææ²¡æ§è¡å®ï¼ç»§ç»­å¾ªç¯ï¼å¦æä¸ä¸ºç©ºè¯´æå·²ç»æ§è¡ç»æï¼éåºå¾ªç¯å¹¶è¿åç»æã\n\nç®åå®ç°ä¸ä¸FutureTask\n\npublic class FutureTask<T> {\n    // ä»»å¡\n    private Callable<T> callable;\n    // ç»æ\n    private T result;\n    \n    public void run() {\n    \tr = callable.call();    \n    \tresult = r;\n    }\n    \n    public T get() {\n        while (true) {\n            if (result == null) {\n                // å½åçº¿ç¨è®©åºæ§è¡æï¼ä¹å°±æ¯ä¸»çº¿ç¨è®©åºæ§è¡æã\n                Thread.yield();\n            } else {\n            \treturn T;    \n            }\n        }\n    }\n}\n\n\nä½æ¯çæ­£ç FutureTask æä¸ä¼è¿ä¹ç®åãæ¥ä¸æ¥è¿å¥ FutureTask çæºç ä¸æ¢ç©¶ç«ã\n\n\n# 2. FutureTask ä¸­çåé\n\næ ¹æ®ä¹åçåæï¼FutureTaskå·²ç»æäºä¸¤ä¸ªåé ï¼\n\npublic class FutureTask<T> {\n    // ä»»å¡\n    private Callable<T> callable;\n    // ç»æ\n    private T outcome;\n}\n\n\n\n# 2.1 FutureTask ä¸­çç¶æåé\n\næä»¬åæä½¿ç¨ result ç»æåéåå½äºå¤æ­ä»»å¡æ¯å¦ç»æçæ å¿ï¼å¶å® FutureTask æ²¡æç¨å®ï¼èæ¯å®ä¹äºå ä¸ªç¶æåé ï¼\n\n// å½åç¶æ\nprivate volatile int state;\n\n// NEW æ°å»ºç¶æï¼è¡¨ç¤ºè¿ä¸ª FutureTaskè¿æ²¡æå¼å§è¿è¡\nprivate static final int NEW = 0;\n// COMPLETING å®æç¶æï¼ è¡¨ç¤º FutureTask ä»»å¡å·²ç»è®¡ç®å®æ¯äºï¼ä½æ¯è¿æä¸äºåç»­æä½æ²¡æå®æã\nprivate static final int COMPLETING   = 1;\n\n// FutureTask ä»»å¡å®ç»ï¼æ­£å¸¸å®æï¼æ²¡æåçå¼å¸¸\nprivate static final int NORMAL       = 2;\n// FutureTask ä»»å¡å®ç»ï¼å ä¸ºåçå¼å¸¸ã\nprivate static final int EXCEPTIONAL  = 3;\n// FutureTask ä»»å¡å®ç»ï¼å ä¸ºåæ¶ä»»å¡\nprivate static final int CANCELLED    = 4;\n// FutureTask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼ä¸è¿åèµ·äºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\nprivate static final int INTERRUPTING = 5;\n// FutureTask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼å·²ç»å®æäºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\nprivate static final int INTERRUPTED  = 6;\n\n\nä¸ºä»ä¹æäº outcome ç»æåéè¿è¦ä½¿ç¨ç¶æåéæ¥è¡¨ç¤ºä»»å¡æ¯å¦ç»æå¢ï¼\n\nå ä¸º FutureTask æ§è¡çä»»å¡æ¢å¯ä»¥æ¯ Callableï¼åå¯ä»¥æ¯ Runnableï¼Runnable å¯æ²¡æè¿åå¼å¦ï¼æä»¥ä½¿ç¨ç¶æåéæ¥è¡¨ç¤ºä»»å¡æ¯å¦æ§è¡ç»æ\n\npublic FutureTask(Callable<V> callable);\n\npublic FutureTask(Runnable runnable, Void result);\n\n\nè¿äºç¶æåéå¤§è´å¯ä»¥åä¸ºä¸¤ç§ ï¼å·²æ§è¡ãæªæ§è¡ã\n\nå¦æ state > COMPLETING å°±è¯´æä»»å¡å·²ç»æ§è¡å®äºï¼ä¸ç®¡æ¯æ­£å¸¸æ§è¡è¿æ¯å¼å¸¸æ§è¡ï¼åæ­£ç°å¨è¦æç»æresultè¿åç»ä¸»çº¿ç¨ã\n\nCOMPLETING è¿ä¸ªç¶æå¾ç¹æ®ï¼å¦æ state = COMPLETINGï¼é£ä¹è¿ä¸ªä»»å¡ç®æ¯å·²ç»æ§è¡å®äºï¼ä½æ¯è¿æä¸äºåéè¿æ²¡ææ¹åï¼æä»¥ä½ å¯ä»¥çè§£ä¸º ï¼callable æ§è¡å®äºï¼ä½ future æ²¡æ§è¡å®ã\n\nè®²å°ç°å¨ï¼FutureTask ä¸­çåéå±æ ï¼\n\npublic class FutureTask<T> {\n    // ä»»å¡\n    private Callable<T> callable;\n    // ç»æ\n    private Object outcome;\n    // å½åç¶æ\n    private volatile int state;\n\n    // NEW æ°å»ºç¶æï¼è¡¨ç¤ºè¿ä¸ª FutureTaskè¿æ²¡æå¼å§è¿è¡\n    private static final int NEW = 0;\n    // COMPLETING å®æç¶æï¼ è¡¨ç¤º FutureTask ä»»å¡å·²ç»è®¡ç®å®æ¯äº\n    // ä½æ¯è¿æä¸äºåç»­æä½ï¼ä¾å¦å¤éç­å¾çº¿ç¨æä½ï¼è¿æ²¡æå®æã\n    private static final int COMPLETING   = 1;\n\n    // FutureTask ä»»å¡å®ç»ï¼æ­£å¸¸å®æï¼æ²¡æåçå¼å¸¸\n    private static final int NORMAL       = 2;\n    // FutureTask ä»»å¡å®ç»ï¼å ä¸ºåçå¼å¸¸ã\n    private static final int EXCEPTIONAL  = 3;\n    // FutureTask ä»»å¡å®ç»ï¼å ä¸ºåæ¶ä»»å¡\n    private static final int CANCELLED    = 4;\n    // FutureTask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼ä¸è¿åèµ·äºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\n    private static final int INTERRUPTING = 5;\n    // FutureTask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼å·²ç»å®æäºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\n    private static final int INTERRUPTED  = 6;\n}\n\n\n\n# 2.2 FutureTask ä¸­çé¾è¡¨åé\n\nFutureTask ä½¿ç¨çåºæ¯æ¯å¹¶åç¯å¢ï¼å¤§æ¦çæ¯å¤çº¿ç¨æ¥æåä¸ä¸ª callableï¼ç¶åä¸èµ·æ§è¡ future.runãfuture.get\n\næä»¥è¦ä¿è¯å³ä½¿å¨å¹¶åç¯å¢ä¸ï¼åä¸ä¸ª callable ä¹åªè½æ§è¡ä¸æ¬¡ã\n\n * ä½¿ç¨ runner ä»£è¡¨æåè°ç¨ future.run() ççº¿ç¨ï¼å½å¤ä¸ªçº¿ç¨ä½¿ç¨ CAS å° runner è®¾ç½®ä¸ºèªå·±æ¶ï¼åªæä¸ä¸ªè½æå\n * å¶ä»çº¿ç¨è°ç¨ future.run() å¤±è´¥åå¹¶ä¸æå¼å¸¸ï¼èæ¯ç»§ç»­åä¸æ§è¡ future.get()ï¼å¦æ callable æ§è¡æ¶é´è¿é¿ï¼å¶ä»çº¿ç¨å¿é¡»å°è£ä¸ºé¾è¡¨çèç¹ï¼é»å¡ç­å¾ï¼ä¸ç´å°ä»»å¡æ§è¡å®æ¯æ¶éåè¿è¡¨å°ä»ä»¬å¤éã\n\npublic class FutureTask<V> implements RunnableFuture<V> {\n\t// ä»»å¡çæ§è¡ç¶æ\n    private volatile int state;\n    // æ°å»ºï¼æªæ§è¡\n    private static final int NEW          = 0;\n    // æ­£å¨æ§è¡ï¼æªæ§è¡ç»æ\n    private static final int COMPLETING   = 1;\n    // å·²æ§è¡ç»æï¼æ­£å¸¸æ§è¡ç»æ\n    private static final int NORMAL       = 2;\n    // å·²æ§è¡ç»æï¼å¼å¸¸æ§è¡ç»æ\n    private static final int EXCEPTIONAL  = 3;\n    // å·²æ§è¡ç»æï¼è¢«åæ­¢\n    private static final int CANCELLED    = 4;\n    // å·²æ§è¡ç»æï¼åèµ·äºä¸­æ­è¯·æ±\n    private static final int INTERRUPTING = 5;\n    // å·²æ§è¡ç»æï¼å®æäºä¸­æ­è¯·æ±\n    private static final int INTERRUPTED  = 6;\n\n\t// éè¦æ§è¡çä»»å¡\n    private Callable<V> callable;\n\t// æ§è¡ç»æï¼å¦ææ¯æ­£å¸¸æ§è¡ï¼outcomeä¸ºç»æãå¦ææ¯å¼å¸¸æ§è¡ï¼outcomeæ¯å¼å¸¸ã\n    private Object outcome; \n    // è°ç¨ callable.run() ççº¿ç¨ã\n    private volatile Thread runner;\n    \n    // ææè¢«é»å¡çé¾è¡¨èç¹ï¼åå«æçº¿ç¨\n    private volatile WaitNode waiters;\n    static final class WaitNode {\n        volatile Thread thread;\n        volatile WaitNode next;\n        WaitNode() { thread = Thread.currentThread(); }\n    }\n}\n\n\nä½ä¸ºé¾è¡¨èç¹ WaitNodeï¼å¶å® FutureTask ä¸­å¹¶æ²¡æå®ç°å¶ä»åå®¹å»ç»´æ¤è¿ä¸ªé¾è¡¨ï¼èæ¯ç²æ´çä½¿ç¨ Unsafe å»æ§è¡å°èç¹æ·»å å°é¾è¡¨ä¸­çæä½ã\n\nprivate static final sun.misc.Unsafe UNSAFE;\n// stateåéçå°å\nprivate static final long stateOffset;\n// runnerçº¿ç¨çå°å\nprivate static final long runnerOffset;\n// å¶ä»è°ç¨ futureTask.get() è¿å¥é»å¡ççº¿ç¨çå°å\nprivate static final long waitersOffset;\nstatic {\n    try {\n        UNSAFE = sun.misc.Unsafe.getUnsafe();\n        Class<?> k = FutureTask.class;\n        stateOffset = UNSAFE.objectFieldOffset\n            (k.getDeclaredField("state"));\n        runnerOffset = UNSAFE.objectFieldOffset\n            (k.getDeclaredField("runner"));\n        waitersOffset = UNSAFE.objectFieldOffset\n            (k.getDeclaredField("waiters"));\n    } catch (Exception e) {\n        throw new Error(e);\n    }\n}\n\n\néè¿ Unsafe å¾å° stateãrunnerãwaiterçå°åï¼ä»¥åå°±å¯ä»¥ç¨ Unsafe.CAS() æä½è¿äºåéã\n\nå°ç°å¨ï¼FutureTask çåéå¨é¨ä»ç»å®æï¼è´´ä¸ä¸ä»£ç ï¼\n\npublic class FutureTask<V> implements RunnableFuture<V> {\n\t// ä»»å¡çæ§è¡ç¶æ\n    private volatile int state;\n    // æ°å»ºï¼æªæ§è¡\n    private static final int NEW          = 0;\n    // æ­£å¨æ§è¡ï¼æªæ§è¡ç»æ\n    private static final int COMPLETING   = 1;\n    // å·²æ§è¡ç»æï¼æ­£å¸¸æ§è¡ç»æ\n    private static final int NORMAL       = 2;\n    // å·²æ§è¡ç»æï¼å¼å¸¸æ§è¡ç»æ\n    private static final int EXCEPTIONAL  = 3;\n    // å·²æ§è¡ç»æï¼è¢«åæ­¢\n    private static final int CANCELLED    = 4;\n    // å·²æ§è¡ç»æï¼åèµ·äºä¸­æ­è¯·æ±\n    private static final int INTERRUPTING = 5;\n    // å·²æ§è¡ç»æï¼å®æäºä¸­æ­è¯·æ±\n    private static final int INTERRUPTED  = 6;\n\n\t// éè¦æ§è¡çä»»å¡\n    private Callable<V> callable;\n\t// æ§è¡ç»æï¼å¦ææ¯æ­£å¸¸æ§è¡ï¼outcomeä¸ºç»æãå¦ææ¯å¼å¸¸æ§è¡ï¼outcomeæ¯å¼å¸¸ã\n    private Object outcome; \n    // è°ç¨ callable.run() ççº¿ç¨ã\n    private volatile Thread runner;\n    \n    // ææè¢«é»å¡çé¾è¡¨èç¹ï¼åå«æçº¿ç¨\n    private volatile WaitNode waiters;\n    static final class WaitNode {\n        volatile Thread thread;\n        volatile WaitNode next;\n        WaitNode() { thread = Thread.currentThread(); }\n    }\n    \n    private static final sun.misc.Unsafe UNSAFE;\n    // stateåéçå°å\n    private static final long stateOffset;\n    // runnerçº¿ç¨çå°å\n    private static final long runnerOffset;\n    // å¶ä»è°ç¨ futureTask.get() è¿å¥é»å¡ççº¿ç¨çå°å\n    private static final long waitersOffset;\n    static {\n        try {\n            UNSAFE = sun.misc.Unsafe.getUnsafe();\n            Class<?> k = FutureTask.class;\n            stateOffset = UNSAFE.objectFieldOffset\n                (k.getDeclaredField("state"));\n            runnerOffset = UNSAFE.objectFieldOffset\n                (k.getDeclaredField("runner"));\n            waitersOffset = UNSAFE.objectFieldOffset\n                (k.getDeclaredField("waiters"));\n        } catch (Exception e) {\n            throw new Error(e);\n        }\n    }\n}\n\n\nåä»ç»ä¸ä¸ ï¼\n\n * callable ï¼è¢«æ§è¡çä»»å¡\n * outcome ï¼ç»æåé\n * state ï¼ç¶æåé\n * runner ï¼æåè°åº¦ future.run() ççº¿ç¨\n * waiter ï¼ææç­å¾ç»æççº¿ç¨çå¤´èç¹ã\n\n\n# 3. FutureTask.run()\n\nå¦æè®©å±ä»¬åå©ä¸é¢çåéå®ç° runæ¹æ³å¦ä½å®ç°ï¼\n\né¦åè¦åå¤æ­ï¼å¯è½æå¤ä¸ªçº¿ç¨è°ç¨äº FutureTask.run()ä½æ¯åªæä¸ä¸ªå¯ä»¥æåè°ç¨ï¼å¦ä½å¤æ­ï¼\n\nstate åéå runnerOfferset åé\n\nif (state != NEW ||\n    !UNSAFE.compareAndSwapObject(this, runnerOffset,\n                                 null, Thread.currentThread())) {\n    return;\n}\n\n\n * state != NEW ï¼callableå·²ç»è¢«å«ççº¿ç¨è¿è¡äºï¼stateä¸åæ¯æ°åå»ºäºã\n * ä½¿ç¨ CAS å°è¿è¡ callable ç runner ä» null æ¹ä¸ºæ­¤çº¿ç¨ï¼å¤±è´¥äºå°±ä»£è¡¨æ²¡æ¢è¿ã\n\nè¿ä¸ªå¤æ­æ¯ä¸ºäºé²æ­¢ä»»å¡å¤æ¬¡æ§è¡ãå¦æè½èµ°åºè¿ä¸ªå¤æ­ï¼ä¹å°±æ¿å°äºæ§è¡ä»»å¡çæå©ï¼æ­¤æ¶ç runnerå·²ç»ä¸ºæ¬çº¿ç¨äºã\n\nif (state != NEW ||\n    !UNSAFE.compareAndSwapObject(this, runnerOffset,\n                                 null, Thread.currentThread())) {\n    return;\n}\ntry {\n    Callable<V> c = callable;\n    if (c != null && state == NEW) {\n        V result;\n        boolean ran;\n        try {\n            result = c.call();\n            ran = true;\n        } catch (Throwable ex) {\n            result = null;\n            ran = false;\n            setException(ex);\n        }\n        if (ran)\n            set(result);\n    }\n} finally {\n    runner = null;\n    int s = state;\n    if (s >= INTERRUPTING)\n        handlePossibleCancellationInterrupt(s);\n}\n\n\nå¶å®é»è¾ä¹æºç®åï¼æ¿å° callable ä¹åè°ç¨å®ï¼å¦ææ²¡æå¼å¸¸å°±æ§è¡ set(result) æ¹æ³ï¼ç²ç set() æ¹æ³å°±æ¯å° result åéèµå¼ç» outcome çï¼ä½æ¯ç­æ¡ä¸ä¼å¨æ­¤å¤æ­æã\n\næ´ä¸ª run() çé»è¾ ï¼\n\n 1. æ¢ callable.call() çæ§è¡æï¼æ²¡æ¢å°å°±éåºï¼å»æ§è¡ future.get()\n 2. æ¢å°çå°±æ§è¡ callable.call()ï¼ç¶åå°ç»æèµå¼ç» outcome\n\n\n# 4. FutureTask.get()\n\nget() å°±æ¯FutureTask é»å¡çæ ¸å¿äºï¼å®é»å¡çä¸æ¯ callable çº¿ç¨ï¼èæ¯è°ç¨ FutureTask.get() ççº¿ç¨ï¼æä»¥è¿æ¯æ¯è¾å¥½å®ç°çã\n\nä¸å±æä¸¤ç§å®ç°æ¹å¼ï¼ä¸ç§æ¯æ éé»å¡ï¼ä¸ç§æ¯éæ¶é»å¡ãåæ¥çä¸ä¸æ éé»å¡ã\n\npublic V get() throws InterruptedException, ExecutionException {\n    int s = state;\n    // å¦æä»»å¡è¿æªæ§è¡å®æ¯ï¼çº¿ç¨å°ä¼è¢«é»å¡å¨è¿ä¸ªifä¸­\n    if (s <= COMPLETING)\n        s = awaitDone(false, 0L);\n    \n    // èµ°å°è¿éççº¿ç¨æä¸¤ç§æåµ ï¼\n    // 1. ä»»å¡æ§è¡çé£å¿«ï¼çº¿ç¨åæ ¹æ²¡é»å¡\n    // 2. çº¿ç¨ifä¹åè¿å¥é»å¡ç¶æï¼ç¶åä»»å¡æ§è¡å®åè¢«å¤éäºï¼èªç¶èµ°å°äºreturnï¼å¯ä»¥å°ç»æè¿åã\n    return report(s);\n}\n\n\nå¦æ state > COMPLETINGï¼è¯´ææç»æäºï¼ç»ææ¯æ­£å¸¸çè¿æ¯å¼å¸¸çåä¸è®ºï¼åæ­£å¯ä»¥è¿åä¸ä¸ªç»æã\n\nå¦æ state <= COMPLETINGï¼è¯´ææªæ§è¡ææ­£å¨æ§è¡ï¼é£ä¹å°±å¯ä»¥é»å¡å½åçº¿ç¨äºã\n\nè®©å½åçº¿ç¨é»å¡æ¯å¨ awaitDone ä¸­å®ç°ç ï¼\n\n// timed : æ¯å¦ä¸ºéæ¶é»å¡\n// nanos : å¦ææ¯éæ¶é»å¡ï¼éæ¶å¤ä¹\nprivate int awaitDone(boolean timed, long nanos)\n    throws InterruptedException {\n    // åå¤æ­ä¸ä¸æ¯å¦éæ¶ï¼å¦æéæ¶ï¼è®¡ç®åºç»æéæ¶çæ¶é´ã\n    final long deadline = timed ? System.nanoTime() + nanos : 0L;\n    WaitNode q = null;\n    boolean queued = false;\n    // æ­»å¾ªç¯\n    for (;;) {\n        if (Thread.interrupted()) {\n            removeWaiter(q);\n            throw new InterruptedException();\n        }\n\t\t// ç±äºä»»å¡éæ¶å¯è½æ§è¡ç»æï¼æä»¥æ¯æ¬¡å¾ªç¯é½éæ°è·åå½åç¶æ\n        int s = state;\n        // å¦æå¤§äº COMPLETING è¯´æå·²ç»æ§è¡å®äºï¼å°ç¶æè¿å\n        // ç±äºæ¯æ­»å¾ªç¯éåï¼ç¬¬næ¬¡éåçæ¶å stateæ»ææ§è¡æåé£ä¸å¤©\n        if (s > COMPLETING) {\n            if (q != null)\n                q.thread = null;\n            return s;\n        }\n        // å¦ææ­£å¨æ§è¡ï¼å½åçº¿ç¨è®©åºCPU\n        else if (s == COMPLETING) \n            Thread.yield();\n        // å¦æ q == Nullï¼é£æä»¬å°±è¦å°å½åçº¿ç¨å°è£ä¸º èç¹ï¼ä¸æ¬¡å¾ªç¯å°±å¯ä»¥æ¾å°é»å¡é¾è¡¨ä¸­\n        // è¯¥çº¿ç¨ç¬¬ä¸æ¬¡å¾ªç¯ä¼è¢«å°è£ä¸ºèç¹ï¼ä¸ä¸æ¬¡å¾ªç¯æä¼è¢«æ¾å¥é»å¡é¾è¡¨\n        else if (q == null)\n            q = new WaitNode();\n        // å¦æå½åçº¿ç¨çèç¹è¿æ²¡ææ¾å¥é»å¡é¾è¡¨ä¸­ï¼ç°å¨å°±æ¾å¥ã\n        else if (!queued)\n            queued = UNSAFE.compareAndSwapObject(this, waitersOffset,\n                                                 q.next = waiters, q);\n        // å¦æè¦éæ¶é»å¡ï¼è·åä¸ä¸é»å¡æ¶é´ï¼è°ç¨ LockSupport.parkNanos()\n        // ä¸ç¨æå¿è¿ä¸ªçº¿ç¨éä¸æ¥ï¼run() ä¸­è°ç¨ç finishCompletion() ä¼å°ææ park ççº¿ç¨ unpark\n        else if (timed) {\n            nanos = deadline - System.nanoTime();\n            if (nanos <= 0L) {\n                removeWaiter(q);\n                return state;\n            }\n            LockSupport.parkNanos(this, nanos);\n        }\n        // å¦åå°±ç´æ¥park\n        else\n            LockSupport.park(this);\n    }\n}\n\n\nææè°ç¨ FutureTask.get() ççº¿ç¨é½ä¼è¿å¥é»å¡é¾è¡¨å¶å®å°±æ¯æ¨ä¸ªæå¨ waiters ç next ä¸ï¼å¦æ FutureTask.run() ä¸­èµ°åºäº callable.call() ï¼å¨ set(result) æ¶ä¼å°ææ park ççº¿ç¨å¤éã\n\n\n# 5. FutureTask.set()\n\nä»»å¡æ§è¡æååè°ç¨ FutureTask.set(result) æ¹æ³å°ç»æèµå¼ç» outcomeï¼åå°ææçº¿ç¨å¤éã\n\nprotected void set(V v) {\n    // CASæä½å°stateä» NEW æ¹ä¸º COMPLETING\n    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n        outcome = v;\n        // CASæä½å°stateä» COMPLETING æ¹ä¸º NORMAL\n        UNSAFE.putOrderedInt(this, stateOffset, NORMAL); \n        // å¤éé»å¡ççº¿ç¨ä»¬\n        finishCompletion();\n    }\n}\n\n\nå½ä»»å¡æ§è¡å®æ¯çæ¶åï¼set() è°ç¨ CAS å° state ä» NEW æ¹ä¸º COMPLETINGï¼å¦ææ´æ¹æåï¼å°±å°ä»»å¡æ§è¡çç»æèµå¼ç» outcomeï¼åç¨ CAS å° state æ¹ä¸º NORMALï¼æ­¤æ¶ï¼ä»»å¡æ­£å¼æ§è¡å®æãä½æ¯æ¥ä¸æ¥è¿éè¦å¤éå¶ä»ç­å¾ç»æççº¿ç¨ ï¼finishCompletion()\n\nprivate void finishCompletion() {\n\t// ä¸ºä»ä¹è¦åéå¾ªç¯ï¼å¶å®è¿éæä¸æã\n    for (WaitNode q; (q = waiters) != null;) {\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            for (;;) {\n                // ååºæ­¤èç¹ççº¿ç¨ï¼è°ç¨ LockSupport.unpatk(t) å¤éæ­¤èç¹\n                Thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    LockSupport.unpark(t);\n                }\n                WaitNode next = q.next;\n                // å¦æq.nextä¸ºç©ºï¼è¯´æ qæ¯æåä¸ä¸ªèç¹ï¼éåºå¾ªç¯\n                if (next == null)\n                    break;\n                // å¦æ q.next ä¸ä¸ºç©ºï¼ç»§ç»­å¾ªç¯ï¼ç®çæ¯å°ææèç¹ççº¿ç¨å¤é\n                // æ¹ä¾¿gc\n                q.next = null; \n                // å° q æ¹ä¸º next\n                q = next;\n            }\n            break;\n        }\n    }\n\t// é©å­å½æ°ï¼äº¤ç»ç¨åºåå®ç°\n    done();\n\t// ä»»å¡æ§è¡å®æ¯ï¼ææç­å¾çº¿ç¨å·²ç»å¤éï¼å¯ä»¥å° callable ç½®ä¸ºç©º\n    callable = null;        // to reduce footprint\n}\n\n\nåææä»¬è¯´ ï¼state = COMPLETING ä»£è¡¨ callable å·²ç»æ§è¡å®äºï¼FutureTask æ²¡æ§è¡å®ï¼ç°å¨ä½ ç¥éå¥ææäºå§ãå ä¸ºä»»å¡è½ç¶æ§è¡å®äºï¼ä½æ¯è¿æå¾å¤é»å¡ç­å¾çé¾è¡¨æ²¡æ notify èµ·æ¥ï¼å®ä»¬è¿å¨ç­å¾ã\n\nå¥½äºï¼åççæºç åæä¸ä¸æ§è¡æµç¨ ï¼\n\npublic void run() {\n    // 1. å¤æ­callableæ¯å¦å·²ç»è¢«å«ççº¿ç¨å¯å¨\n    if (state != NEW ||\n        !UNSAFE.compareAndSwapObject(this, runnerOffset,\n                                     null, Thread.currentThread()))\n        return;\n    // èµ°å°è¿éè¯´æcallableæ²¡æè¢«å«ççº¿ç¨å¯å¨ï¼æ­¤çº¿ç¨å¯ä»¥å¯å¨ callable\n    try {\n        // æ¿å° callable\n        Callable<V> c = callable;\n        // åæ¬¡å¤æ­\n        if (c != null && state == NEW) {\n            V result;\n            boolean ran;\n            try {\n                // æ§è¡ä»»å¡\n                result = c.call();\n                ran = true;\n            } catch (Throwable ex) {\n                result = null;\n                ran = false;\n                setException(ex);\n            }\n            // å¦æranä¸ºtrue:\n            // 1. å°ç¶ææ¹ä¸º COMPLETING\n            // 2. å°ç»æèµå¼ç» outcome\n            // 3. å°ç¶ææ¹ä¸º Normal\n            // 4. å¤éææé»å¡ççº¿ç¨\n            if (ran)\n                set(result);\n        }\n    } finally {\n        // æ§è¡å®äºå° runnerç½®ä¸ºç©º\n        runner = null;\n        int s = state;\n        if (s >= INTERRUPTING)\n            handlePossibleCancellationInterrupt(s);\n    }\n}\n\n// 1. å°ç¶ææ¹ä¸º COMPLETING\n// 2. å°ç»æèµå¼ç» outcome\n// 3. å°ç¶ææ¹ä¸º Normal\n// 4. å¤éææé»å¡ççº¿ç¨\nprotected void set(V v) {\n    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) {\n        outcome = v;\n        UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state\n        finishCompletion();\n    }\n}\n\n// å¤éææé»å¡ç­å¾ççº¿ç¨\nprivate void finishCompletion() {\n    // assert state > COMPLETING;\n    for (WaitNode q; (q = waiters) != null;) {\n        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) {\n            for (;;) {\n                Thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    LockSupport.unpark(t);\n                }\n                WaitNode next = q.next;\n                if (next == null)\n                    break;\n                q.next = null; // unlink to help gc\n                q = next;\n            }\n            break;\n        }\n    }\n    done();\n    callable = null;        // to reduce footprint\n}\n\n\n\n# 6. æ»ç»\n\nå°è¿éå°±è®²å®äºï¼è·å°ä¼ä¼´ä»¬è®¨è®ºçæ¶åæè§é¾çå°æ¹å°±æ¯ FutureTask å¯¹é»å¡é¾è¡¨çç®¡çï¼æ¯å¦æ·»å èç¹ãå é¤èç¹ï¼å¹¶æ²¡æç¨ Java åï¼ä¹ä¸è½è¿ä¹è¯´ï¼åæ­£å°±æ¯ debug çæ¶åç¡®å®ççä¸å¤ªæ¸ä¸ãå¶å® FutureTask ç®ä¸æ³¨éä¹æ480è¡ï¼å»ææ³¨éä¼°è®¡å°± 300è¡äºï¼ä¸é¾éè¯»',normalizedContent:'# 1. ç®è¿°\n\nfuturetask å®ç°äº runnableãfutureï¼å¯ä»¥è¿è¡ä»»å¡çå¼æ­¥æ§è¡ï¼ä½æ¯ futuretask ä¼é»å¡ä¸»çº¿ç¨ã\n\nå®æä¾äºä¸¤ä¸ªåè½ ï¼\n\n 1. æ§è¡ä»»å¡\n 2. é»å¡ç­å¾ä»»å¡æ§è¡å®æ¯\n\npublic static void main(string[] args) throws executionexception, interruptedexception {\n    callable<string> callable = new callable<string>() {\n        @override\n        public string call() throws exception {\n            // å¤çä¸å¡\n            return "æ§è¡ç»æ";\n        }\n    };\n\n    futuretask<string> futuretask = new futuretask<>(callable);\n    // æ§è¡ä»»å¡\n    futuretask.run();\n    // é»å¡ç­å¾ç»æ\n    futuretask.get();\n}\n\n\nä»ä»£ç ä¸­å¯ä»¥çæµ ï¼\n\n * futuretask åé¨æä¸ä¸ª callable åé\n * futuretask.run() è°ç¨äº callable.call() å»è·åç»æ\n * æ­¤æ¶ futuretask.get() çç»æä¼æ¯nullï¼ææ§è¡ futuretask.get() ççº¿ç¨ä¼é»å¡ï¼callable.call() æ¹æ³è¿è¡ã\n * callable.run() æ¹æ³ç»æï¼å°è¿è¡çç»æäº¤ç» futuretaskï¼futuretask åæ­¢é»å¡ã\n\n\n\næ³è¦ææ futuretask çæºç ï¼å¿é¡»è¦ææå®åäºä»ä¹ï¼æ ¹æ®ä¸é¢çéè¿°å¯ä»¥ç®åçæµï¼\n\n 1. futuretask ä¸­çåéä¸ä»æ callableï¼è¿æ callable æ§è¡åçç»æ resultï¼callable æ§è¡åå°ç»æè®¾ç½®ç» resultã\n 2. futuretask.get() æ¹æ³ç¨ while(true) å¾ªç¯æ£æ¥resultï¼å¦æä¸ºç©ºè¯´ææ²¡æ§è¡å®ï¼ç»§ç»­å¾ªç¯ï¼å¦æä¸ä¸ºç©ºè¯´æå·²ç»æ§è¡ç»æï¼éåºå¾ªç¯å¹¶è¿åç»æã\n\nç®åå®ç°ä¸ä¸futuretask\n\npublic class futuretask<t> {\n    // ä»»å¡\n    private callable<t> callable;\n    // ç»æ\n    private t result;\n    \n    public void run() {\n    \tr = callable.call();    \n    \tresult = r;\n    }\n    \n    public t get() {\n        while (true) {\n            if (result == null) {\n                // å½åçº¿ç¨è®©åºæ§è¡æï¼ä¹å°±æ¯ä¸»çº¿ç¨è®©åºæ§è¡æã\n                thread.yield();\n            } else {\n            \treturn t;    \n            }\n        }\n    }\n}\n\n\nä½æ¯çæ­£ç futuretask æä¸ä¼è¿ä¹ç®åãæ¥ä¸æ¥è¿å¥ futuretask çæºç ä¸æ¢ç©¶ç«ã\n\n\n# 2. futuretask ä¸­çåé\n\næ ¹æ®ä¹åçåæï¼futuretaskå·²ç»æäºä¸¤ä¸ªåé ï¼\n\npublic class futuretask<t> {\n    // ä»»å¡\n    private callable<t> callable;\n    // ç»æ\n    private t outcome;\n}\n\n\n\n# 2.1 futuretask ä¸­çç¶æåé\n\næä»¬åæä½¿ç¨ result ç»æåéåå½äºå¤æ­ä»»å¡æ¯å¦ç»æçæ å¿ï¼å¶å® futuretask æ²¡æç¨å®ï¼èæ¯å®ä¹äºå ä¸ªç¶æåé ï¼\n\n// å½åç¶æ\nprivate volatile int state;\n\n// new æ°å»ºç¶æï¼è¡¨ç¤ºè¿ä¸ª futuretaskè¿æ²¡æå¼å§è¿è¡\nprivate static final int new = 0;\n// completing å®æç¶æï¼ è¡¨ç¤º futuretask ä»»å¡å·²ç»è®¡ç®å®æ¯äºï¼ä½æ¯è¿æä¸äºåç»­æä½æ²¡æå®æã\nprivate static final int completing   = 1;\n\n// futuretask ä»»å¡å®ç»ï¼æ­£å¸¸å®æï¼æ²¡æåçå¼å¸¸\nprivate static final int normal       = 2;\n// futuretask ä»»å¡å®ç»ï¼å ä¸ºåçå¼å¸¸ã\nprivate static final int exceptional  = 3;\n// futuretask ä»»å¡å®ç»ï¼å ä¸ºåæ¶ä»»å¡\nprivate static final int cancelled    = 4;\n// futuretask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼ä¸è¿åèµ·äºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\nprivate static final int interrupting = 5;\n// futuretask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼å·²ç»å®æäºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\nprivate static final int interrupted  = 6;\n\n\nä¸ºä»ä¹æäº outcome ç»æåéè¿è¦ä½¿ç¨ç¶æåéæ¥è¡¨ç¤ºä»»å¡æ¯å¦ç»æå¢ï¼\n\nå ä¸º futuretask æ§è¡çä»»å¡æ¢å¯ä»¥æ¯ callableï¼åå¯ä»¥æ¯ runnableï¼runnable å¯æ²¡æè¿åå¼å¦ï¼æä»¥ä½¿ç¨ç¶æåéæ¥è¡¨ç¤ºä»»å¡æ¯å¦æ§è¡ç»æ\n\npublic futuretask(callable<v> callable);\n\npublic futuretask(runnable runnable, void result);\n\n\nè¿äºç¶æåéå¤§è´å¯ä»¥åä¸ºä¸¤ç§ ï¼å·²æ§è¡ãæªæ§è¡ã\n\nå¦æ state > completing å°±è¯´æä»»å¡å·²ç»æ§è¡å®äºï¼ä¸ç®¡æ¯æ­£å¸¸æ§è¡è¿æ¯å¼å¸¸æ§è¡ï¼åæ­£ç°å¨è¦æç»æresultè¿åç»ä¸»çº¿ç¨ã\n\ncompleting è¿ä¸ªç¶æå¾ç¹æ®ï¼å¦æ state = completingï¼é£ä¹è¿ä¸ªä»»å¡ç®æ¯å·²ç»æ§è¡å®äºï¼ä½æ¯è¿æä¸äºåéè¿æ²¡ææ¹åï¼æä»¥ä½ å¯ä»¥çè§£ä¸º ï¼callable æ§è¡å®äºï¼ä½ future æ²¡æ§è¡å®ã\n\nè®²å°ç°å¨ï¼futuretask ä¸­çåéå±æ ï¼\n\npublic class futuretask<t> {\n    // ä»»å¡\n    private callable<t> callable;\n    // ç»æ\n    private object outcome;\n    // å½åç¶æ\n    private volatile int state;\n\n    // new æ°å»ºç¶æï¼è¡¨ç¤ºè¿ä¸ª futuretaskè¿æ²¡æå¼å§è¿è¡\n    private static final int new = 0;\n    // completing å®æç¶æï¼ è¡¨ç¤º futuretask ä»»å¡å·²ç»è®¡ç®å®æ¯äº\n    // ä½æ¯è¿æä¸äºåç»­æä½ï¼ä¾å¦å¤éç­å¾çº¿ç¨æä½ï¼è¿æ²¡æå®æã\n    private static final int completing   = 1;\n\n    // futuretask ä»»å¡å®ç»ï¼æ­£å¸¸å®æï¼æ²¡æåçå¼å¸¸\n    private static final int normal       = 2;\n    // futuretask ä»»å¡å®ç»ï¼å ä¸ºåçå¼å¸¸ã\n    private static final int exceptional  = 3;\n    // futuretask ä»»å¡å®ç»ï¼å ä¸ºåæ¶ä»»å¡\n    private static final int cancelled    = 4;\n    // futuretask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼ä¸è¿åèµ·äºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\n    private static final int interrupting = 5;\n    // futuretask ä»»å¡å®ç»ï¼ä¹æ¯åæ¶ä»»å¡ï¼å·²ç»å®æäºä¸­æ­è¿è¡ä»»å¡çº¿ç¨çä¸­æ­è¯·æ±\n    private static final int interrupted  = 6;\n}\n\n\n\n# 2.2 futuretask ä¸­çé¾è¡¨åé\n\nfuturetask ä½¿ç¨çåºæ¯æ¯å¹¶åç¯å¢ï¼å¤§æ¦çæ¯å¤çº¿ç¨æ¥æåä¸ä¸ª callableï¼ç¶åä¸èµ·æ§è¡ future.runãfuture.get\n\næä»¥è¦ä¿è¯å³ä½¿å¨å¹¶åç¯å¢ä¸ï¼åä¸ä¸ª callable ä¹åªè½æ§è¡ä¸æ¬¡ã\n\n * ä½¿ç¨ runner ä»£è¡¨æåè°ç¨ future.run() ççº¿ç¨ï¼å½å¤ä¸ªçº¿ç¨ä½¿ç¨ cas å° runner è®¾ç½®ä¸ºèªå·±æ¶ï¼åªæä¸ä¸ªè½æå\n * å¶ä»çº¿ç¨è°ç¨ future.run() å¤±è´¥åå¹¶ä¸æå¼å¸¸ï¼èæ¯ç»§ç»­åä¸æ§è¡ future.get()ï¼å¦æ callable æ§è¡æ¶é´è¿é¿ï¼å¶ä»çº¿ç¨å¿é¡»å°è£ä¸ºé¾è¡¨çèç¹ï¼é»å¡ç­å¾ï¼ä¸ç´å°ä»»å¡æ§è¡å®æ¯æ¶éåè¿è¡¨å°ä»ä»¬å¤éã\n\npublic class futuretask<v> implements runnablefuture<v> {\n\t// ä»»å¡çæ§è¡ç¶æ\n    private volatile int state;\n    // æ°å»ºï¼æªæ§è¡\n    private static final int new          = 0;\n    // æ­£å¨æ§è¡ï¼æªæ§è¡ç»æ\n    private static final int completing   = 1;\n    // å·²æ§è¡ç»æï¼æ­£å¸¸æ§è¡ç»æ\n    private static final int normal       = 2;\n    // å·²æ§è¡ç»æï¼å¼å¸¸æ§è¡ç»æ\n    private static final int exceptional  = 3;\n    // å·²æ§è¡ç»æï¼è¢«åæ­¢\n    private static final int cancelled    = 4;\n    // å·²æ§è¡ç»æï¼åèµ·äºä¸­æ­è¯·æ±\n    private static final int interrupting = 5;\n    // å·²æ§è¡ç»æï¼å®æäºä¸­æ­è¯·æ±\n    private static final int interrupted  = 6;\n\n\t// éè¦æ§è¡çä»»å¡\n    private callable<v> callable;\n\t// æ§è¡ç»æï¼å¦ææ¯æ­£å¸¸æ§è¡ï¼outcomeä¸ºç»æãå¦ææ¯å¼å¸¸æ§è¡ï¼outcomeæ¯å¼å¸¸ã\n    private object outcome; \n    // è°ç¨ callable.run() ççº¿ç¨ã\n    private volatile thread runner;\n    \n    // ææè¢«é»å¡çé¾è¡¨èç¹ï¼åå«æçº¿ç¨\n    private volatile waitnode waiters;\n    static final class waitnode {\n        volatile thread thread;\n        volatile waitnode next;\n        waitnode() { thread = thread.currentthread(); }\n    }\n}\n\n\nä½ä¸ºé¾è¡¨èç¹ waitnodeï¼å¶å® futuretask ä¸­å¹¶æ²¡æå®ç°å¶ä»åå®¹å»ç»´æ¤è¿ä¸ªé¾è¡¨ï¼èæ¯ç²æ´çä½¿ç¨ unsafe å»æ§è¡å°èç¹æ·»å å°é¾è¡¨ä¸­çæä½ã\n\nprivate static final sun.misc.unsafe unsafe;\n// stateåéçå°å\nprivate static final long stateoffset;\n// runnerçº¿ç¨çå°å\nprivate static final long runneroffset;\n// å¶ä»è°ç¨ futuretask.get() è¿å¥é»å¡ççº¿ç¨çå°å\nprivate static final long waitersoffset;\nstatic {\n    try {\n        unsafe = sun.misc.unsafe.getunsafe();\n        class<?> k = futuretask.class;\n        stateoffset = unsafe.objectfieldoffset\n            (k.getdeclaredfield("state"));\n        runneroffset = unsafe.objectfieldoffset\n            (k.getdeclaredfield("runner"));\n        waitersoffset = unsafe.objectfieldoffset\n            (k.getdeclaredfield("waiters"));\n    } catch (exception e) {\n        throw new error(e);\n    }\n}\n\n\néè¿ unsafe å¾å° stateãrunnerãwaiterçå°åï¼ä»¥åå°±å¯ä»¥ç¨ unsafe.cas() æä½è¿äºåéã\n\nå°ç°å¨ï¼futuretask çåéå¨é¨ä»ç»å®æï¼è´´ä¸ä¸ä»£ç ï¼\n\npublic class futuretask<v> implements runnablefuture<v> {\n\t// ä»»å¡çæ§è¡ç¶æ\n    private volatile int state;\n    // æ°å»ºï¼æªæ§è¡\n    private static final int new          = 0;\n    // æ­£å¨æ§è¡ï¼æªæ§è¡ç»æ\n    private static final int completing   = 1;\n    // å·²æ§è¡ç»æï¼æ­£å¸¸æ§è¡ç»æ\n    private static final int normal       = 2;\n    // å·²æ§è¡ç»æï¼å¼å¸¸æ§è¡ç»æ\n    private static final int exceptional  = 3;\n    // å·²æ§è¡ç»æï¼è¢«åæ­¢\n    private static final int cancelled    = 4;\n    // å·²æ§è¡ç»æï¼åèµ·äºä¸­æ­è¯·æ±\n    private static final int interrupting = 5;\n    // å·²æ§è¡ç»æï¼å®æäºä¸­æ­è¯·æ±\n    private static final int interrupted  = 6;\n\n\t// éè¦æ§è¡çä»»å¡\n    private callable<v> callable;\n\t// æ§è¡ç»æï¼å¦ææ¯æ­£å¸¸æ§è¡ï¼outcomeä¸ºç»æãå¦ææ¯å¼å¸¸æ§è¡ï¼outcomeæ¯å¼å¸¸ã\n    private object outcome; \n    // è°ç¨ callable.run() ççº¿ç¨ã\n    private volatile thread runner;\n    \n    // ææè¢«é»å¡çé¾è¡¨èç¹ï¼åå«æçº¿ç¨\n    private volatile waitnode waiters;\n    static final class waitnode {\n        volatile thread thread;\n        volatile waitnode next;\n        waitnode() { thread = thread.currentthread(); }\n    }\n    \n    private static final sun.misc.unsafe unsafe;\n    // stateåéçå°å\n    private static final long stateoffset;\n    // runnerçº¿ç¨çå°å\n    private static final long runneroffset;\n    // å¶ä»è°ç¨ futuretask.get() è¿å¥é»å¡ççº¿ç¨çå°å\n    private static final long waitersoffset;\n    static {\n        try {\n            unsafe = sun.misc.unsafe.getunsafe();\n            class<?> k = futuretask.class;\n            stateoffset = unsafe.objectfieldoffset\n                (k.getdeclaredfield("state"));\n            runneroffset = unsafe.objectfieldoffset\n                (k.getdeclaredfield("runner"));\n            waitersoffset = unsafe.objectfieldoffset\n                (k.getdeclaredfield("waiters"));\n        } catch (exception e) {\n            throw new error(e);\n        }\n    }\n}\n\n\nåä»ç»ä¸ä¸ ï¼\n\n * callable ï¼è¢«æ§è¡çä»»å¡\n * outcome ï¼ç»æåé\n * state ï¼ç¶æåé\n * runner ï¼æåè°åº¦ future.run() ççº¿ç¨\n * waiter ï¼ææç­å¾ç»æççº¿ç¨çå¤´èç¹ã\n\n\n# 3. futuretask.run()\n\nå¦æè®©å±ä»¬åå©ä¸é¢çåéå®ç° runæ¹æ³å¦ä½å®ç°ï¼\n\né¦åè¦åå¤æ­ï¼å¯è½æå¤ä¸ªçº¿ç¨è°ç¨äº futuretask.run()ä½æ¯åªæä¸ä¸ªå¯ä»¥æåè°ç¨ï¼å¦ä½å¤æ­ï¼\n\nstate åéå runnerofferset åé\n\nif (state != new ||\n    !unsafe.compareandswapobject(this, runneroffset,\n                                 null, thread.currentthread())) {\n    return;\n}\n\n\n * state != new ï¼callableå·²ç»è¢«å«ççº¿ç¨è¿è¡äºï¼stateä¸åæ¯æ°åå»ºäºã\n * ä½¿ç¨ cas å°è¿è¡ callable ç runner ä» null æ¹ä¸ºæ­¤çº¿ç¨ï¼å¤±è´¥äºå°±ä»£è¡¨æ²¡æ¢è¿ã\n\nè¿ä¸ªå¤æ­æ¯ä¸ºäºé²æ­¢ä»»å¡å¤æ¬¡æ§è¡ãå¦æè½èµ°åºè¿ä¸ªå¤æ­ï¼ä¹å°±æ¿å°äºæ§è¡ä»»å¡çæå©ï¼æ­¤æ¶ç runnerå·²ç»ä¸ºæ¬çº¿ç¨äºã\n\nif (state != new ||\n    !unsafe.compareandswapobject(this, runneroffset,\n                                 null, thread.currentthread())) {\n    return;\n}\ntry {\n    callable<v> c = callable;\n    if (c != null && state == new) {\n        v result;\n        boolean ran;\n        try {\n            result = c.call();\n            ran = true;\n        } catch (throwable ex) {\n            result = null;\n            ran = false;\n            setexception(ex);\n        }\n        if (ran)\n            set(result);\n    }\n} finally {\n    runner = null;\n    int s = state;\n    if (s >= interrupting)\n        handlepossiblecancellationinterrupt(s);\n}\n\n\nå¶å®é»è¾ä¹æºç®åï¼æ¿å° callable ä¹åè°ç¨å®ï¼å¦ææ²¡æå¼å¸¸å°±æ§è¡ set(result) æ¹æ³ï¼ç²ç set() æ¹æ³å°±æ¯å° result åéèµå¼ç» outcome çï¼ä½æ¯ç­æ¡ä¸ä¼å¨æ­¤å¤æ­æã\n\næ´ä¸ª run() çé»è¾ ï¼\n\n 1. æ¢ callable.call() çæ§è¡æï¼æ²¡æ¢å°å°±éåºï¼å»æ§è¡ future.get()\n 2. æ¢å°çå°±æ§è¡ callable.call()ï¼ç¶åå°ç»æèµå¼ç» outcome\n\n\n# 4. futuretask.get()\n\nget() å°±æ¯futuretask é»å¡çæ ¸å¿äºï¼å®é»å¡çä¸æ¯ callable çº¿ç¨ï¼èæ¯è°ç¨ futuretask.get() ççº¿ç¨ï¼æä»¥è¿æ¯æ¯è¾å¥½å®ç°çã\n\nä¸å±æä¸¤ç§å®ç°æ¹å¼ï¼ä¸ç§æ¯æ éé»å¡ï¼ä¸ç§æ¯éæ¶é»å¡ãåæ¥çä¸ä¸æ éé»å¡ã\n\npublic v get() throws interruptedexception, executionexception {\n    int s = state;\n    // å¦æä»»å¡è¿æªæ§è¡å®æ¯ï¼çº¿ç¨å°ä¼è¢«é»å¡å¨è¿ä¸ªifä¸­\n    if (s <= completing)\n        s = awaitdone(false, 0l);\n    \n    // èµ°å°è¿éççº¿ç¨æä¸¤ç§æåµ ï¼\n    // 1. ä»»å¡æ§è¡çé£å¿«ï¼çº¿ç¨åæ ¹æ²¡é»å¡\n    // 2. çº¿ç¨ifä¹åè¿å¥é»å¡ç¶æï¼ç¶åä»»å¡æ§è¡å®åè¢«å¤éäºï¼èªç¶èµ°å°äºreturnï¼å¯ä»¥å°ç»æè¿åã\n    return report(s);\n}\n\n\nå¦æ state > completingï¼è¯´ææç»æäºï¼ç»ææ¯æ­£å¸¸çè¿æ¯å¼å¸¸çåä¸è®ºï¼åæ­£å¯ä»¥è¿åä¸ä¸ªç»æã\n\nå¦æ state <= completingï¼è¯´ææªæ§è¡ææ­£å¨æ§è¡ï¼é£ä¹å°±å¯ä»¥é»å¡å½åçº¿ç¨äºã\n\nè®©å½åçº¿ç¨é»å¡æ¯å¨ awaitdone ä¸­å®ç°ç ï¼\n\n// timed : æ¯å¦ä¸ºéæ¶é»å¡\n// nanos : å¦ææ¯éæ¶é»å¡ï¼éæ¶å¤ä¹\nprivate int awaitdone(boolean timed, long nanos)\n    throws interruptedexception {\n    // åå¤æ­ä¸ä¸æ¯å¦éæ¶ï¼å¦æéæ¶ï¼è®¡ç®åºç»æéæ¶çæ¶é´ã\n    final long deadline = timed ? system.nanotime() + nanos : 0l;\n    waitnode q = null;\n    boolean queued = false;\n    // æ­»å¾ªç¯\n    for (;;) {\n        if (thread.interrupted()) {\n            removewaiter(q);\n            throw new interruptedexception();\n        }\n\t\t// ç±äºä»»å¡éæ¶å¯è½æ§è¡ç»æï¼æä»¥æ¯æ¬¡å¾ªç¯é½éæ°è·åå½åç¶æ\n        int s = state;\n        // å¦æå¤§äº completing è¯´æå·²ç»æ§è¡å®äºï¼å°ç¶æè¿å\n        // ç±äºæ¯æ­»å¾ªç¯éåï¼ç¬¬næ¬¡éåçæ¶å stateæ»ææ§è¡æåé£ä¸å¤©\n        if (s > completing) {\n            if (q != null)\n                q.thread = null;\n            return s;\n        }\n        // å¦ææ­£å¨æ§è¡ï¼å½åçº¿ç¨è®©åºcpu\n        else if (s == completing) \n            thread.yield();\n        // å¦æ q == nullï¼é£æä»¬å°±è¦å°å½åçº¿ç¨å°è£ä¸º èç¹ï¼ä¸æ¬¡å¾ªç¯å°±å¯ä»¥æ¾å°é»å¡é¾è¡¨ä¸­\n        // è¯¥çº¿ç¨ç¬¬ä¸æ¬¡å¾ªç¯ä¼è¢«å°è£ä¸ºèç¹ï¼ä¸ä¸æ¬¡å¾ªç¯æä¼è¢«æ¾å¥é»å¡é¾è¡¨\n        else if (q == null)\n            q = new waitnode();\n        // å¦æå½åçº¿ç¨çèç¹è¿æ²¡ææ¾å¥é»å¡é¾è¡¨ä¸­ï¼ç°å¨å°±æ¾å¥ã\n        else if (!queued)\n            queued = unsafe.compareandswapobject(this, waitersoffset,\n                                                 q.next = waiters, q);\n        // å¦æè¦éæ¶é»å¡ï¼è·åä¸ä¸é»å¡æ¶é´ï¼è°ç¨ locksupport.parknanos()\n        // ä¸ç¨æå¿è¿ä¸ªçº¿ç¨éä¸æ¥ï¼run() ä¸­è°ç¨ç finishcompletion() ä¼å°ææ park ççº¿ç¨ unpark\n        else if (timed) {\n            nanos = deadline - system.nanotime();\n            if (nanos <= 0l) {\n                removewaiter(q);\n                return state;\n            }\n            locksupport.parknanos(this, nanos);\n        }\n        // å¦åå°±ç´æ¥park\n        else\n            locksupport.park(this);\n    }\n}\n\n\nææè°ç¨ futuretask.get() ççº¿ç¨é½ä¼è¿å¥é»å¡é¾è¡¨å¶å®å°±æ¯æ¨ä¸ªæå¨ waiters ç next ä¸ï¼å¦æ futuretask.run() ä¸­èµ°åºäº callable.call() ï¼å¨ set(result) æ¶ä¼å°ææ park ççº¿ç¨å¤éã\n\n\n# 5. futuretask.set()\n\nä»»å¡æ§è¡æååè°ç¨ futuretask.set(result) æ¹æ³å°ç»æèµå¼ç» outcomeï¼åå°ææçº¿ç¨å¤éã\n\nprotected void set(v v) {\n    // casæä½å°stateä» new æ¹ä¸º completing\n    if (unsafe.compareandswapint(this, stateoffset, new, completing)) {\n        outcome = v;\n        // casæä½å°stateä» completing æ¹ä¸º normal\n        unsafe.putorderedint(this, stateoffset, normal); \n        // å¤éé»å¡ççº¿ç¨ä»¬\n        finishcompletion();\n    }\n}\n\n\nå½ä»»å¡æ§è¡å®æ¯çæ¶åï¼set() è°ç¨ cas å° state ä» new æ¹ä¸º completingï¼å¦ææ´æ¹æåï¼å°±å°ä»»å¡æ§è¡çç»æèµå¼ç» outcomeï¼åç¨ cas å° state æ¹ä¸º normalï¼æ­¤æ¶ï¼ä»»å¡æ­£å¼æ§è¡å®æãä½æ¯æ¥ä¸æ¥è¿éè¦å¤éå¶ä»ç­å¾ç»æççº¿ç¨ ï¼finishcompletion()\n\nprivate void finishcompletion() {\n\t// ä¸ºä»ä¹è¦åéå¾ªç¯ï¼å¶å®è¿éæä¸æã\n    for (waitnode q; (q = waiters) != null;) {\n        if (unsafe.compareandswapobject(this, waitersoffset, q, null)) {\n            for (;;) {\n                // ååºæ­¤èç¹ççº¿ç¨ï¼è°ç¨ locksupport.unpatk(t) å¤éæ­¤èç¹\n                thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    locksupport.unpark(t);\n                }\n                waitnode next = q.next;\n                // å¦æq.nextä¸ºç©ºï¼è¯´æ qæ¯æåä¸ä¸ªèç¹ï¼éåºå¾ªç¯\n                if (next == null)\n                    break;\n                // å¦æ q.next ä¸ä¸ºç©ºï¼ç»§ç»­å¾ªç¯ï¼ç®çæ¯å°ææèç¹ççº¿ç¨å¤é\n                // æ¹ä¾¿gc\n                q.next = null; \n                // å° q æ¹ä¸º next\n                q = next;\n            }\n            break;\n        }\n    }\n\t// é©å­å½æ°ï¼äº¤ç»ç¨åºåå®ç°\n    done();\n\t// ä»»å¡æ§è¡å®æ¯ï¼ææç­å¾çº¿ç¨å·²ç»å¤éï¼å¯ä»¥å° callable ç½®ä¸ºç©º\n    callable = null;        // to reduce footprint\n}\n\n\nåææä»¬è¯´ ï¼state = completing ä»£è¡¨ callable å·²ç»æ§è¡å®äºï¼futuretask æ²¡æ§è¡å®ï¼ç°å¨ä½ ç¥éå¥ææäºå§ãå ä¸ºä»»å¡è½ç¶æ§è¡å®äºï¼ä½æ¯è¿æå¾å¤é»å¡ç­å¾çé¾è¡¨æ²¡æ notify èµ·æ¥ï¼å®ä»¬è¿å¨ç­å¾ã\n\nå¥½äºï¼åççæºç åæä¸ä¸æ§è¡æµç¨ ï¼\n\npublic void run() {\n    // 1. å¤æ­callableæ¯å¦å·²ç»è¢«å«ççº¿ç¨å¯å¨\n    if (state != new ||\n        !unsafe.compareandswapobject(this, runneroffset,\n                                     null, thread.currentthread()))\n        return;\n    // èµ°å°è¿éè¯´æcallableæ²¡æè¢«å«ççº¿ç¨å¯å¨ï¼æ­¤çº¿ç¨å¯ä»¥å¯å¨ callable\n    try {\n        // æ¿å° callable\n        callable<v> c = callable;\n        // åæ¬¡å¤æ­\n        if (c != null && state == new) {\n            v result;\n            boolean ran;\n            try {\n                // æ§è¡ä»»å¡\n                result = c.call();\n                ran = true;\n            } catch (throwable ex) {\n                result = null;\n                ran = false;\n                setexception(ex);\n            }\n            // å¦æranä¸ºtrue:\n            // 1. å°ç¶ææ¹ä¸º completing\n            // 2. å°ç»æèµå¼ç» outcome\n            // 3. å°ç¶ææ¹ä¸º normal\n            // 4. å¤éææé»å¡ççº¿ç¨\n            if (ran)\n                set(result);\n        }\n    } finally {\n        // æ§è¡å®äºå° runnerç½®ä¸ºç©º\n        runner = null;\n        int s = state;\n        if (s >= interrupting)\n            handlepossiblecancellationinterrupt(s);\n    }\n}\n\n// 1. å°ç¶ææ¹ä¸º completing\n// 2. å°ç»æèµå¼ç» outcome\n// 3. å°ç¶ææ¹ä¸º normal\n// 4. å¤éææé»å¡ççº¿ç¨\nprotected void set(v v) {\n    if (unsafe.compareandswapint(this, stateoffset, new, completing)) {\n        outcome = v;\n        unsafe.putorderedint(this, stateoffset, normal); // final state\n        finishcompletion();\n    }\n}\n\n// å¤éææé»å¡ç­å¾ççº¿ç¨\nprivate void finishcompletion() {\n    // assert state > completing;\n    for (waitnode q; (q = waiters) != null;) {\n        if (unsafe.compareandswapobject(this, waitersoffset, q, null)) {\n            for (;;) {\n                thread t = q.thread;\n                if (t != null) {\n                    q.thread = null;\n                    locksupport.unpark(t);\n                }\n                waitnode next = q.next;\n                if (next == null)\n                    break;\n                q.next = null; // unlink to help gc\n                q = next;\n            }\n            break;\n        }\n    }\n    done();\n    callable = null;        // to reduce footprint\n}\n\n\n\n# 6. æ»ç»\n\nå°è¿éå°±è®²å®äºï¼è·å°ä¼ä¼´ä»¬è®¨è®ºçæ¶åæè§é¾çå°æ¹å°±æ¯ futuretask å¯¹é»å¡é¾è¡¨çç®¡çï¼æ¯å¦æ·»å èç¹ãå é¤èç¹ï¼å¹¶æ²¡æç¨ java åï¼ä¹ä¸è½è¿ä¹è¯´ï¼åæ­£å°±æ¯ debug çæ¶åç¡®å®ççä¸å¤ªæ¸ä¸ãå¶å® futuretask ç®ä¸æ³¨éä¹æ480è¡ï¼å»ææ³¨éä¼°è®¡å°± 300è¡äºï¼ä¸é¾éè¯»',charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"çº¿ç¨æ± ",frontmatter:{title:"çº¿ç¨æ± ",date:"2023-07-16T18:36:54.000Z",permalink:"/pages/671511/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/300.%E7%BA%BF%E7%A8%8B%E6%B1%A0.html",relativePath:"02.æç« /75.Javaå¹¶å/300.çº¿ç¨æ± .md",key:"v-d0b615f8",path:"/pages/671511/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:2,title:"2. æ¦è¿°",slug:"_2-æ¦è¿°",normalizedTitle:"2. æ¦è¿°",charIndex:12},{level:2,title:"3. ExecutorãExecutorService",slug:"_3-executorãexecutorservice",normalizedTitle:"3. executorãexecutorservice",charIndex:278},{level:2,title:"4. ThreadPoolExecutor",slug:"_4-threadpoolexecutor",normalizedTitle:"4. threadpoolexecutor",charIndex:1412},{level:3,title:"4.1 ä¸ä¸ªæ ¸å¿åæ°",slug:"_4-1-ä¸ä¸ªæ ¸å¿åæ°",normalizedTitle:"4.1 ä¸ä¸ªæ ¸å¿åæ°",charIndex:1438},{level:3,title:"4.2 çå½å¨æç®¡ç",slug:"_4-2-çå½å¨æç®¡ç",normalizedTitle:"4.2 çå½å¨æç®¡ç",charIndex:2340},{level:3,title:"4.3 ä»»å¡æ§è¡æºå¶",slug:"_4-3-ä»»å¡æ§è¡æºå¶",normalizedTitle:"4.3 ä»»å¡æ§è¡æºå¶",charIndex:3233},{level:2,title:"5. çº¿ç¨æ± ç¨å°çéå",slug:"_5-çº¿ç¨æ± ç¨å°çéå",normalizedTitle:"5. çº¿ç¨æ± ç¨å°çéå",charIndex:5489},{level:3,title:"5.0 é»å¡éåä¸éé»å¡éå",slug:"_5-0-é»å¡éåä¸éé»å¡éå",normalizedTitle:"5.0 é»å¡éåä¸éé»å¡éå",charIndex:5593},{level:3,title:"5.1 ArrayBlockingQueue",slug:"_5-1-arrayblockingqueue",normalizedTitle:"5.1 arrayblockingqueue",charIndex:6427},{level:3,title:"5.2 LinkedBlockingQueue",slug:"_5-2-linkedblockingqueue",normalizedTitle:"5.2 linkedblockingqueue",charIndex:8857},{level:3,title:"5.3 SynchronousQueue",slug:"_5-3-synchronousqueue",normalizedTitle:"5.3 synchronousqueue",charIndex:9721},{level:2,title:"6. çº¿ç¨æ± ç¨å°çæç»ç­ç¥",slug:"_6-çº¿ç¨æ± ç¨å°çæç»ç­ç¥",normalizedTitle:"6. çº¿ç¨æ± ç¨å°çæç»ç­ç¥",charIndex:10634},{level:2,title:"7. Executors",slug:"_7-executors",normalizedTitle:"7. executors",charIndex:12476},{level:2,title:"8. çº¿ç¨æ± åæ°çéç½®",slug:"_8-çº¿ç¨æ± åæ°çéç½®",normalizedTitle:"8. çº¿ç¨æ± åæ°çéç½®",charIndex:14077}],headersStr:"1. åè¨ 2. æ¦è¿° 3. ExecutorãExecutorService 4. ThreadPoolExecutor 4.1 ä¸ä¸ªæ ¸å¿åæ° 4.2 çå½å¨æç®¡ç 4.3 ä»»å¡æ§è¡æºå¶ 5. çº¿ç¨æ± ç¨å°çéå 5.0 é»å¡éåä¸éé»å¡éå 5.1 ArrayBlockingQueue 5.2 LinkedBlockingQueue 5.3 SynchronousQueue 6. çº¿ç¨æ± ç¨å°çæç»ç­ç¥ 7. Executors 8. çº¿ç¨æ± åæ°çéç½®",content:'# 1. åè¨\n\n\n# 2. æ¦è¿°\n\nè³äºä¸ºä»ä¹è¦æçº¿ç¨æ± ï¼Javaéé¢æå¾å¤æ± ï¼ä¾å¦å¸¸éæ± ãæ°æ®åºè¿æ¥æ± ãçº¿ç¨æ± .....ä»ä»¬é½ä½ç°äºä¸ç§æ± åææ³ï¼ä»ä¹æ¯æ± åææ³å¢ï¼å°±æ¯éè¿åå»ºåç®¡çå¯éå¤ä½¿ç¨çèµæºæ¥æé«èµæºçå©ç¨çï¼è¿èæé«æ§è½ã\n\n> çº¿ç¨æ± ç®èè¨ä¹ï¼å°±æ¯ä¸ä¸ªæè®¸å¤çº¿ç¨çå®¹å¨ï¼è¿äºçº¿ç¨å¹¶ä¸è·æä»¬å¹³æ¶ä½¿ç¨ççº¿ç¨ä¸æ ·éç¨éä¸¢ï¼èæ¯å°å®ä»¬æ¾å¨å®¹å¨ä¹å°±æ¯çº¿ç¨æ± ä¸­ï¼ä»¥ä¾¿å¯ä»¥éå¤ä½¿ç¨ï¼åå°çº¿ç¨éå¤åå»ºåéæ¯å¸¦æ¥çæ§è½æ¶èã\n\né¦åæ¥çä¸ä¸ThreadPoolExecutorçUMLç±»å¾ï¼äºè§£ä¸ThreadPoolExecutorçç»§æ¿å³ç³»ã\n\n\n\n\n# 3. ExecutorãExecutorService\n\nåæ¥çä¸ä¸Executorï¼\n\npublic interface Executor {\n    void execute(Runnable command);\n}\n\n\nå¯ä»¥çå°ï¼Executor è¿ä¸ªæ¥å£ååç®åï¼åªæä¾äºä¸ä¸ª executor æ¹æ³ï¼ä¹å°±æ¯æ§è¡æ¹æ³ãå®ç°äºè¿ä¸ªæ¹æ³çäººè¦å»å®æçº¿ç¨çä¸»è¦é»è¾ï¼ä¹å°±æ¯æ§è¡ã\n\næ¥ä¸æ¥ç ExecutorService ï¼\n\npublic interface ExecutorService extends Executor {\n    void shutdown();  \n    List<Runnable> shutdownNow();\n    boolean isShutdown();\n    boolean isTerminated();\n    boolean awaitTermination(long timeout, TimeUnit unit)\n        throws InterruptedException;\n\n    <T> Future<T> submit(Callable<T> task);\n    <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks)\n        throws InterruptedException;\n    // è¿æä¸äºæ¹æ³ä¸ååä¸¾\n}\n\n\nExecutorServiceæä¾äºå¯¹äºçº¿ç¨æ± æä½çæå¡ï¼ä¾å¦ä»»å¡çæäº¤submitãå¤æ­çº¿ç¨æ± çç¶æisShutdown....\n\nExecutorServiceæ¥å£å¢å äºä¸äºè½åï¼\nï¼1ï¼æ©åæ§è¡ä»»å¡çè½åï¼è¡¥åå¯ä»¥ä¸ºä¸ä¸ªæä¸æ¹å¼æ­¥ä»»å¡çæFutureçæ¹æ³ï¼\nï¼2ï¼æä¾äºç®¡æ§çº¿ç¨æ± çæ¹æ³ï¼æ¯å¦åæ­¢çº¿ç¨æ± çè¿è¡ãAbstractExecutorServiceåæ¯ä¸å±çæ½è±¡ç±»ï¼å°æ§è¡ä»»å¡çæµç¨ä¸²èäºèµ·æ¥ï¼ä¿è¯ä¸å±çå®ç°åªéå³æ³¨ä¸ä¸ªæ§è¡ä»»å¡çæ¹æ³å³å¯ã\n\n> é£ä¹å½æä»¬ä½¿ç¨ ThreadPoolExecutor æ¶å°±å¯ä»¥æè¯å°ï¼\n> \n>  * ä¸»è¦çæ§è¡æ¹æ³æ¯ å®ç°Executorçã\n>  * åè½æ¹æ³æ¯ å®ç°ExecutorService çã\n\nExecutoråExecutorServiceæä¾äºä¸ç§ææ³ ï¼å°ä»»å¡çæäº¤åä»»å¡çæ§è¡è§£è¦ã\n\nç¨æ·æ éå³æ³¨å¦ä½åå»ºçº¿ç¨ãå¦ä½è°åº¦çº¿ç¨æ¥æ§è¡ä»»å¡ï¼ç¨æ·åªéæä¾Runnableå¯¹è±¡ï¼å°ä»»å¡çè¿è¡é»è¾æäº¤å°æ§è¡å¨(Executor)ä¸­ï¼ç±Executoræ¡æ¶å®æçº¿ç¨çè°éåä»»å¡çæ§è¡é¨åã\n\n\n# 4. ThreadPoolExecutor\n\n\n# 4.1 ä¸ä¸ªæ ¸å¿åæ°\n\nåªè¦å­¦ä¹  ThreadPoolExector ï¼ç»ä¸å¼å®çä¸ä¸ªåæ°ã\n\npublic ThreadPoolExecutor(int corePoolSize,\n                          int maximumPoolSize,\n                          long keepAliveTime,\n                          TimeUnit unit,\n                          BlockingQueue<Runnable> workQueue,\n                          ThreadFactory threadFactory,\n                          RejectedExecutionHandler handler) \n\n\n 1. corePoolSize ï¼æ ¸å¿çº¿ç¨æ°ï¼é»è®¤æåµä¸ï¼æ ¸å¿çº¿ç¨æ°ä¼ä¸ç´å­æ´»ã\n\n 2. maximumPoolSize ï¼æå¤§çº¿ç¨æ°ï¼æ ¸å¿çº¿ç¨æ°+ä¸´æ¶çº¿ç¨æ°çæ»åã\n    \n    é¤äºæ ¸å¿çº¿ç¨æ°ä¹å¤ççº¿ç¨æ°ç§°ä¸ºä¸´æ¶çº¿ç¨ï¼maximumPoolSize - corePoolSize ï¼ï¼ä¸´æ¶çº¿ç¨å¦æä¸å®æ¶é´åæ¥æ¶ä¸å°ä»»å¡ä¼æ­»äº¡ã\n\n 3. keepAliveTime ï¼ä¸´æ¶çº¿ç¨æ¥æ¶ä¸å°ä»»å¡æ¶çæ­»äº¡æ¶é´ã\n\n 4. unit ï¼æ¶é´çåä½\n\n 5. workQueue ï¼é»å¡éåï¼å­æ¾ä»»å¡çå°æ¹ã\n\n 6. threadFactory ï¼çº¿ç¨å·¥åï¼ææçº¿ç¨å¨è¿éè¢«åå»ºã\n\n 7. handler ï¼å½ä»»å¡å®å¨å¤ªå¤æ¶æ§è¡çæç»ä»»å¡çç­ç¥ã\n\nçº¿ç¨æ± çå·¥ä½æµç¨\n\nå½æ ¸å¿çº¿ç¨æ°æç©ºé²æ°æ¶ï¼ææä»»å¡é½ä¼è¢«æ ¸å¿çº¿ç¨å¤çï¼\n\nå½æ ¸å¿çº¿ç¨é½å¿ç¢æ¶ï¼ä»»å¡é¦åå°è¾¾é»å¡éåä¸­ç­å¾ï¼æ ¸å¿çº¿ç¨æ§è¡å®æä¸çä»»å¡åä¼å»ä»»å¡éåä¸­åä»»å¡ã\n\nå½ä»»å¡éåæ»¡åä¼åå»ºä¸´æ¶çº¿ç¨æ§è¡ä»»å¡ï¼ä¸´æ¶çº¿ç¨ä¹ä¼ä»ä»»å¡éåä¸­åä»»å¡æ§è¡ã\n\nå½ä»»å¡éåæ»¡äºå¹¶ä¸å¨é¨çº¿ç¨é½å¨å·¥ä½ä¸­ï¼è¿æ¯ææ°çä»»å¡å°è¾¾ï¼å°±ä¼æ§è¡æç»ç­ç¥ã\n\n\n# 4.2 çå½å¨æç®¡ç\n\nçº¿ç¨æ± è¿è¡çç¶æå¹¶ä¸æ¯ç¨æ·æ¾å¼è®¾ç½®çï¼èæ¯ä¼´éççº¿ç¨æ± çè¿è¡ç±åé¨æ¥ç»´æ¤ãçº¿ç¨æ± åé¨ä½¿ç¨ä¸ä¸ªåéç»´æ¤ä¸¤ä¸ªå¼ï¼è¿è¡ç¶æ(runState)åçº¿ç¨æ°é (workerCount)ã\nå¨å·ä½å®ç°ä¸­ï¼çº¿ç¨æ± å°è¿è¡ç¶æ(runState)ãçº¿ç¨æ°é (workerCount)ä¸¤ä¸ªå³é®åæ°çç»´æ¤æ¾å¨äºä¸èµ·ï¼ç±åä¸ä¸ªåéç®¡çï¼\n\nprivate final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n\n\nctlè¿ä¸ªAtomicIntegerç±»åçåéï¼æ¯å¯¹çº¿ç¨æ± çè¿è¡ç¶æ(runState)ãçº¿ç¨æ°é (workerCount) ä¸¤ä¸ªä¿¡æ¯çæ±æ»ï¼ é«3ä½ä¿å­runStateï¼ä½29ä½ä¿å­workerCountï¼ä¸¤ä¸ªåéä¹é´äºä¸å¹²æ°ãç¨ä¸ä¸ªåéå»å­å¨ä¸¤ä¸ªå¼ï¼å¯é¿åå¨åç¸å³å³ç­æ¶åºç°ä¸ä¸è´çæåµï¼ä¸å¿ä¸ºäºç»´æ¤ä¸¤èçä¸è´èå ç¨éèµæºã\n\n// COUNT_BITS = 32 - 3 = 29\n// CAPACITY = 1 << 29 - 1\nprivate static final int COUNT_BITS = Integer.SIZE - 3;\nprivate static final int CAPACITY   = (1 << COUNT_BITS) - 1;\n\n//è®¡ç®å½åè¿è¡ç¶æ\nprivate static int runStateOf(int c)     { \n    return c & ~CAPACITY; \n} \n//è®¡ç®å½åçº¿ç¨æ°é\nprivate static int workerCountOf(int c)  { \n    return c & CAPACITY; \n}  \n//éè¿ç¶æåçº¿ç¨æ°çæctl\nprivate static int ctlOf(int rs, int wc) { \n    return rs | wc; \n}   \n\n\nThreadPoolExecutorçè¿è¡ç¶ææ5ç§ï¼åå«ä¸ºï¼\n\nå¶çå½å¨æè½¬æ¢å¦ä¸å¥æç¤ºï¼\n\n\n# 4.3 ä»»å¡æ§è¡æºå¶\n\nä»»å¡è°åº¦æ¯çº¿ç¨æ± çä¸»è¦å¥å£ï¼å½ç¨æ·æäº¤äºä¸ä¸ªä»»å¡ï¼æ¥ä¸æ¥è¿ä¸ªä»»å¡å°å¦ä½æ§è¡é½æ¯ç±è¿ä¸ªé¶æ®µå³å®çãäºè§£è¿é¨åå°±ç¸å½äºäºè§£äºçº¿ç¨æ± çæ ¸å¿è¿è¡æºå¶ã\n\né¦åï¼ææä»»å¡çè°åº¦é½æ¯ç±executeæ¹æ³å®æçï¼è¿é¨åå®æçå·¥ä½æ¯ï¼æ£æ¥ç°å¨çº¿ç¨æ± çè¿è¡ç¶æãè¿è¡çº¿ç¨æ°ãè¿è¡ç­ç¥ï¼å³å®æ¥ä¸æ¥æ§è¡çæµç¨ï¼æ¯ç´æ¥ç³è¯·çº¿ç¨æ§è¡ï¼ææ¯ç¼å²å°éåä¸­æ§è¡ï¼äº¦ææ¯ç´æ¥æç»è¯¥ä»»å¡ãå¶æ§è¡è¿ç¨å¦ä¸ï¼\n\n 1. é¦åæ£æµçº¿ç¨æ± è¿è¡ç¶æï¼å¦æä¸æ¯RUNNINGï¼åç´æ¥æç»ï¼çº¿ç¨æ± è¦ä¿è¯å¨RUNNINGçç¶æä¸æ§è¡ä»»å¡ã\n 2. å¦æworkerCount < corePoolSizeï¼ååå»ºå¹¶å¯å¨ä¸ä¸ªçº¿ç¨æ¥æ§è¡æ°æäº¤çä»»å¡ã\n 3. å¦æworkerCount >= corePoolSizeï¼ä¸çº¿ç¨æ± åçé»å¡éåæªæ»¡ï¼åå°ä»»å¡æ·»å å°è¯¥é»å¡éåä¸­ã\n 4. å¦æworkerCount >= corePoolSize && workerCount < maximumPoolSizeï¼ä¸çº¿ç¨æ± åçé»å¡éåå·²æ»¡ï¼ååå»ºå¹¶å¯å¨ä¸ä¸ªçº¿ç¨æ¥æ§è¡æ°æäº¤çä»»å¡ã\n 5. å¦æworkerCount >= maximumPoolSizeï¼å¹¶ä¸çº¿ç¨æ± åçé»å¡éåå·²æ»¡, åæ ¹æ®æç»ç­ç¥æ¥å¤çè¯¥ä»»å¡, é»è®¤çå¤çæ¹å¼æ¯ç´æ¥æå¼å¸¸ã\n\næ¥çä¸ä¸å®ç execute æºç  ï¼\n\npublic void execute(Runnable command) {\n    if (command == null)\n        throw new NullPointerException();\n    \n    // è·åctlï¼ç¨äºæ£æ¥çº¿ç¨æ± ççº¿ç¨æ°ä»¥åçº¿ç¨æ± ç¶æ\n    int c = ctl.get();\n    \n    // å¦æå½åä»»å¡æ°å°äºæ ¸å¿çº¿ç¨æ°ï¼ç´æ¥ä½¿ç¨æ ¸å¿çº¿ç¨\n    if (workerCountOf(c) < corePoolSize) {\n        //æ§è¡addWorker,ä¼åå»ºä¸ä¸ªæ ¸å¿çº¿ç¨ï¼å¦æåå»ºå¤±è´¥ï¼éæ°è·åctl\n        if (addWorker(command, true))\n            return;\n        c = ctl.get();\n    }\n    \n    // å¦æçº¿ç¨æ± è¿æ´»çï¼é£ä¹å°±å¯ä»¥å°å®å å¥é»å¡éå, (ä¹ä»ä»æ¯å å¥éåï¼å¹¶æ²¡ææ§è¡)\n    if (isRunning(c) && workQueue.offer(command)) {\n        //åæ¬¡è·åctlï¼è¿è¡åéæ£ç´¢ï¼ä¹å°±æ¯å¯¹çº¿ç¨æ± çç¶æåæ¬¡æ£æ¥ä¸éï¼\n        int recheck = ctl.get();\n        \n        //å¦æçº¿ç¨æ± æ¯ä¸æ¯å¤äºRUNNINGçç¶æï¼é£ä¹å°±ä¼å°ä»»å¡ä»éåä¸­ç§»é¤ï¼\n        if (! isRunning(recheck) && remove(command))\n            reject(command);\n        //å¦æç§»é¤å¤±è´¥ï¼åä¼å¤æ­å·¥ä½çº¿ç¨æ¯å¦ä¸º0 ï¼å¦æè¿ä¸º0 å°±åå»ºä¸ä¸ªéæ ¸å¿çº¿ç¨\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n    }\n\t//å¦æç§»é¤æåï¼å°±æ§è¡æç»ç­ç¥ï¼å ä¸ºçº¿ç¨æ± å·²ç»ä¸å¯ç¨äºï¼\n    else if (!addWorker(command, false))\n        reject(command);\n}\n\n\n\nå¯ä»¥çå°ï¼åå»ºæ ¸å¿çº¿ç¨åéæ ¸å¿çº¿ç¨é½æ¯è°ç¨addWorkeræ¹æ³\n\n// å¦æRunnableä¸ç©ºï¼ä¸coreä¸ºtrueï¼åè¯æåå»ºçæ¯æ ¸å¿çº¿ç¨ã\n// å¦æRunnableä¸ºç©ºï¼ä¸coreä¸ºfalse, åè¯æåå»ºçæ¯éæ ¸å¿çº¿ç¨ã\nprivate boolean addWorker(Runnable firstTask, boolean core)\n\n\naddWorkerï¼æå¶ä»æ­¥éª¤é½å¿½ç¥ï¼æ¥çæä»¬æäº¤çä¸ä¸ªä»»å¡æ¯å¦ä½è¢«å¤ççã\n\nprivate boolean addWorker(Runnable firstTask, boolean core) {\n        w = new Worker(firstTask);\n}\n\n\nnew äºä¸ä¸ªWorkerï¼é£ä¹è¿ä¸ªWorkeræ¯ä»ä¹ï¼\n\nWorker(Runnable firstTask) {\n    setState(-1); // inhibit interrupts until runWorker\n    this.firstTask = firstTask;\n    this.thread = getThreadFactory().newThread(this);\n}\n\n\nä» getThreadFactory().newThread(this) å¯ä»¥çåºï¼å°±æå½åçWorkerå¯¹è±¡ä½ä¸ºä»»å¡ä¼ ç»äºæ°å»ºççº¿ç¨ï¼è¿æ ·å¯å¨çº¿ç¨æ¶ï¼å®ä¹å°±å¯å¨äºã\n\n> é£ä¹æèä¸ä¸ªé®é¢ï¼å¦æä»»å¡æ°éå°äºæ ¸å¿çº¿ç¨æ°å¹¶ä¸åæ¥ä¸ä¸ªä»»å¡ï¼æ¯ä¼åè®©ç©ºé²çæ ¸å¿çº¿ç¨æ§è¡ä»»å¡è¿æ¯ç´æ¥åå»ºä¸ä¸ªæ ¸å¿çº¿ç¨å¢ï¼\n> \n> åæçä»£ç ä¸æ¯å·²ç»æç­æ¡äºåï¼å½è°ç¨addWorkeræ·»å ä¸ä¸ªä»»å¡çæ¶åï¼å¦ææ ¸å¿çº¿ç¨æ°è¿æ²¡æåå»ºæ»¡ï¼ä¼ååå»ºæ ¸å¿çº¿ç¨ã\n\n\n# 5. çº¿ç¨æ± ç¨å°çéå\n\nä¸ºä»ä¹è¦å­¦ä¹ é»å¡éåï¼\nçº¿ç¨æ± å¯ä»¥é«æå©ç¨çº¿ç¨ï¼ä¹å°±æ¯è¯´çº¿ç¨å¯ä»¥å¨æä¸ªå°æ¹ä¸ç´æ¿ä»»å¡å»æ§è¡ï¼èä¸æ§è¡å®äºä¹åè¿ä¸æ­»äº¡ï¼é£ä¹å»åªéæ¿ä»»å¡å¢ï¼è¿æ¶åå°±éè¦æä¸ä¸ªå®¹å¨ï¼é»å¡éåã\n\n\n# 5.0 é»å¡éåä¸éé»å¡éå\n\n 1. é»å¡éå\n    * å¥é ï¼å¦æéåæ»¡äºï¼ä¸ç´ç­å¾ç´å°æä½ç½®å°±å¥éã\n    * åºé ï¼å¦æéåä¸­æ²¡æå¼ï¼ä¸ç´ç­å¾ç´å°éåä¸­æå¼æä¼åºéã\n 2. éé»å¡éå\n    * å¥é ï¼éåæä½ç½®å°±å¥éï¼æ²¡ä½ç½®å°±è¿åfalseæèæ¥éã\n    * åºé ï¼éåä¸­æå¼å°±åºéï¼æ²¡æå¼å°±è¿åNULLæèæ¥éã\n\néé»å¡éåä¸­çå ä¸ªä¸»è¦æ¹æ³ï¼add(T)ãremove()ãoffer(T)ãpoll()ãpeek()ã\n\né»å¡éåæ¥æéé»å¡éåçå¨é¨æ¹æ³ï¼èä¸è¿å¤äºå ä¸ªæ¹æ³ï¼put(T)ãtake()ãoffer(T, timeout)ãpoll(T, timeout)ã\n\nè¿å ä¸ªæ¹æ³å®ç°äºé»å¡ææï¼ä¹æ¯ä¸é¢ä»ç»çé»å¡éåä¸éé»å¡éåçåºå«ï¼æ¥ç®åççputæ¹æ³æ¯æä¹å®ç° é»å¡ åè½çï¼\n\npublic void put(E e) throws InterruptedException {\n    checkNotNull(e);\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        while (count == items.length)\n            notFull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n\n\nput()æ¹æ³æ¯åéåä¸­æ·»å åç´ ï¼ä¸è¿æ¥åæ£æ¥åç´ æ¯å¦ä¸ºç©ºï¼æ¥çå°±å éï¼ç¶åwhileå¤æ­ç°æåç´ æ¯å¦ç­äºéåçæå¤§é¿åº¦ï¼å¦æç­äºï¼è¯´æéè¦é»å¡ï¼é£å°±è°ç¨awaitæ¹æ³è¿è¡é»å¡ç­å¾ãè¿å°±å®ç°äºé»å¡åè½ã\n\n> å¨JUCä¸­ï¼å¤§å¤æ°ä½¿ç¨é»å¡éåãå½ç¶ä¹æä½¿ç¨éé»å¡éåã\n> \n> ä½æ¯ç±äºæ¬ç¯æ¯ çº¿ç¨æ± ç¸å³æç« ï¼æåªä»ç»çº¿ç¨æ± ç¸å³çè¿å ä¸ªé»å¡éåã\n\n\n# 5.1 ArrayBlockingQueue\n\nåºäºæ°ç»å®ç°çé»å¡éåï¼æ¯æå¬å¹³ä¸éå¬å¹³æ¨¡å¼ï¼é»è®¤éå¬å¹³ã\n\nå ä¸ºæ¯åºäºæ°ç»å®ç°çï¼æä»¥å¨æå»ºæ¶éè¦æå®åå§å®¹éã\n\npublic ArrayBlockingQueue(int capacity) \npublic ArrayBlockingQueue(int capacity, boolean fair)\n// æä¾äºåæ°æå®è¯¥éåæ¯é»å¡è¿æ¯éé»å¡ã\npublic ArrayBlockingQueue(int capacity, boolean fair, Collection<? extends E> c)\n\n\nä¸å±ä¸ä¸ªæé å¨ï¼é½è¦æå®åå§å¤§å°ãæ°æ®å¨é¨å­å¨å¨æ°ç»ä¸­ãå¹¶ä¸è¿ä¸ªæ°ç»ä¸è½æ©å®¹ï¼å ä¸ºæ²¡ææä¾ç¸å³æ©å®¹æ¹æ³ã\n\n// å­å¨åç´ çæ°ç»\nfinal Object[] items;\n\n// ä¸ä¸æ¬¡ takeãpollãpeekå°è¦æä½çä¸æ \nint takeIndex;\n\n// ä¸ä¸æ¬¡ putãofferãaddå°è¦æä½çä¸æ \nint putIndex;\n\n// ç°æåç´ çæ°éã\nint count;\n\n\néè¿ takeIndex å putIndex ç¡®å®æä½çä¸æ ï¼éè¿ count ç¡®å®æä½æ¯å¦è¦é»å¡ã\n\nè¯åè¯´åæ¥ï¼å¦ä½å®ç°çé»å¡ï¼å¦ä½å®ç°çå¬å¹³ä¸éå¬å¹³ï¼\n\nåå©Conditionå®ç°é»å¡ï¼åå©ReentrantLockå®ç°å¬å¹³ä¸éå¬å¹³ã\n\n> å®ç°é»å¡ï¼\n\nArrayBlockingQueueä¸­æä¸¤ä¸ªConditionå¯¹è±¡ï¼notEmptyä¸notFullï¼ä¸ä¸ªæ¯ç¨äºå¤ç©ºï¼ä¸ä¸ªæ¯ç¨äºå¤æ»¡ã\n\nprivate final Condition notEmpty;\nprivate final Condition notFull;\n\n\nConditionæ¯ç¨æ¥å¹²å¥çï¼\n\nç®èè¨ä¹ï¼Conditionæä¾äºawait()æ¹æ³å°å½åçº¿ç¨é»å¡ï¼å¹¶æä¾signal()æ¹æ³æ¯æå¦å¤ä¸ä¸ªçº¿ç¨å°å·²ç»é»å¡ççº¿ç¨å¤éã\n\næä»¥å¦ä½å®ç°é»å¡å¢ï¼\nå½æ»¡çæ¶åä½¿ç¨notFull.await()é»å¡å½åçº¿ç¨ï¼å½ç©ºçæ¶åä½¿ç¨notEmpty.await()é»å¡å½åçº¿ç¨ï¼å½å¼¹åºä¸ä¸ªåç´ çæ¶åè°ç¨signalæ¹æ³å¤éçº¿ç¨è¿æ¥æ¢ä½ç½®ï¼å½æ¾å¥ä¸ä¸ªåç´ çæ¶åéç¥çº¿ç¨è¿æ¥ååç´ ã\næºç å¦ä¸ï¼å é¤é¨ååä½ä»£ç ï¼ï¼\n\n// å½æ»¡çæ¶åä½¿ç¨notFull.await()é»å¡å½åçº¿ç¨\npublic void put(E e) throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        // éåæ»¡äº\n        while (count == items.length)\n            //  notFull.await å°å½åçº¿ç¨é»å¡\n            notFull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n// å½åºéæ¶ï¼å°é»å¡ççº¿ç¨å¤é\nprivate E dequeue() {\n    final Object[] items = this.items;\n    @SuppressWarnings("unchecked")\n    E x = (E) items[takeIndex];\n    items[takeIndex] = null;\n    if (++takeIndex == items.length)\n        takeIndex = 0;\n    count--;\n    if (itrs != null)\n        itrs.elementDequeued();\n    // å°é»å¡ççº¿ç¨å¤é\n    notFull.signal();\n    return x;\n}\n\n\n// å½ç©ºçæ¶åä½¿ç¨notEmpty.await()é»å¡å½åçº¿ç¨\npublic E poll(long timeout, TimeUnit unit) throws InterruptedException {\n    final ReentrantLock lock = this.lock;\n    lock.lockInterruptibly();\n    try {\n        // éåä¸ºç©º\n        while (count == 0) {\n            // notEmpty.await å°å½åçº¿ç¨é»å¡\n            nanos = notEmpty.awaitNanos(nanos);\n        }\n        return dequeue();\n    } finally {\n        lock.unlock();\n    }\n}\n// å½å¥éæ¶ï¼å°å¯¹åºçº¿ç¨å¤é\nprivate void enqueue(E x) {\n    final Object[] items = this.items;\n    items[putIndex] = x;\n    if (++putIndex == items.length)\n        putIndex = 0;\n    count++;\n    // å°é»å¡çº¿ç¨å¤é\n    notEmpty.signal();\n}\n\n\n> å®ç°å¬å¹³ãéå¬å¹³\n\nåé¨æReentrantLockï¼ç±äºConditionæ¯åå©Lockæè½åæ¥ä½ç¨çï¼æä»¥å½Lockçå®ç°ç±»ReentrantLockæ¯æå¬å¹³éä¸éå¬å¹³éæ¶ï¼é»å¡åçå¤éèªç¶ä¹å°±æ¥æå¬å¹³ä¸éå¬å¹³çè½åã\n\n\n# 5.2 LinkedBlockingQueue\n\nåºäºé¾è¡¨å®ç°çé»å¡éåãåªæ¯æéå¬å¹³æ¨¡å¼ï¼\nï¼å ä¸ºæ²¡æåæ°å»æå® ReentrantLock çå¬å¹³ä¸éå¬å¹³æ¨¡å¼ï¼æä»¥å®åªæ¯æéå¬å¹³æ¨¡å¼ãï¼\n\nLinkedBlockingQueueå¯ä»¥æå®å¤§å°ï¼å¦æä¸æå®ï¼é»è®¤ä¸æå¤§å°±æ¯Integer.MAX_VALUEã\n\npublic LinkedBlockingQueue() {\n    this(Integer.MAX_VALUE);\n}\npublic LinkedBlockingQueue(int capacity);\npublic LinkedBlockingQueue(Collection<? extends E> c) ;\n\n\nä¸ºä»ä¹è¯´å®æ¯åºäºé¾è¡¨å®ç°çï¼å ä¸ºåé¨å°è£äºä¸ä¸ªéæåé¨ç±»ï¼ä¹å°±æ¯é¾è¡¨èç¹\n\nstatic class Node<E> {\n    E item;\n\n    Node<E> next;\n\n    Node(E x) { item = x; }\n}\n\n\nä»Nodeçæååéå¯ä»¥çåºï¼è¿æ¯ä¸ä¸ªåé¾è¡¨ï¼å ä¸ºå®åªæä¸ä¸ªnextæéã\n\næä»¥å¯ä»¥è¯´LinkedBlockingQueueå¶å®æ¯ä¸ä¸ªç±åé¾è¡¨ç»æçãåªæ¯æéå¬å¹³æ¨¡å¼çãå¯ä»¥æå®å¤§å°çé»å¡éåã\n\nä¸ArrayBlockingQueueçåºå«ä¸æ­¢è¿äºï¼LinkedBlockingQueueåé¨æä¸¤æéï¼ArrayBlockingQueueåªæä¸æ\n\nprivate final ReentrantLock takeLock = new ReentrantLock();\nprivate final Condition notEmpty = takeLock.newCondition();\n\n\nprivate final ReentrantLock putLock = new ReentrantLock();\nprivate final Condition notFull = putLock.newCondition();\n\n\n\n# 5.3 SynchronousQueue\n\nä¸é¢ä¸¤ç§éåé½æ¯æççæå¤§ä¹å°±Integer.MAX_VALUEï¼è¿ä¸ªéåæ¯æ çç....éï¼è¿ä¸ªéåä¸å­å¨æ°æ®ðå®åªæ¯æ°æ®çæ¬è¿å·¥ã\n\nSynchronousQueue å¨æå¥æ°æ®æ¶å¿é¡»ç­å¾å¦ä¸ä¸ªçº¿ç¨æ¥åèµ°è¯¥æ°æ®ï¼åä¹äº¦ç¶ã\n\nSynchronousQueueçå®ç°æ¹å¼æ¯åºäº TransferQueue æ¥å£ï¼å®æä¾äºä¸¤ä¸ªä¸»è¦çæ¹æ³ï¼put()åtake()ãput()æ¹æ³ç¨äºæå¥åç´ ï¼å¦ææ²¡æå¦ä¸ä¸ªçº¿ç¨æ­£å¨ç­å¾æ¥æ¶è¯¥åç´ ï¼åæå¥æä½å°ä¸ç´é»å¡ï¼ç´å°æå¦ä¸ä¸ªçº¿ç¨è°ç¨take()æ¹æ³æ¥åèµ°è¯¥åç´ ãtake()æ¹æ³ç¨äºåèµ°åç´ ï¼å¦ææ²¡æå¦ä¸ä¸ªçº¿ç¨æ­£å¨ç­å¾æå¥åç´ ï¼ååèµ°æä½å°ä¸ç´é»å¡ï¼ç´å°æå¦ä¸ä¸ªçº¿ç¨è°ç¨put()æ¹æ³æ¥æå¥åç´ ã\n\n// putæ¾åç´ æ¶ï¼å¦ææå¶ä»çº¿ç¨æ­£å¨ç­å¾çååç´ ï¼å°±ç»ä»ï¼å¦ææ²¡æå°±é»å¡ã\npublic void put(E e) throws InterruptedException {\n    if (e == null) throw new NullPointerException();\n    if (transferer.transfer(e, false, 0) == null) {\n        Thread.interrupted();\n        throw new InterruptedException();\n    }\n}\n\n// takeååç´ æ¶ï¼å¦ææåç´ å°±æ¿èµ°ï¼å¦ææ²¡åç´ å°±é»å¡(Thread.interrupted)\npublic E take() throws InterruptedException {\n    E e = transferer.transfer(null, false, 0);\n    if (e != null)\n        return e;\n    Thread.interrupted();\n    throw new InterruptedException();\n}\n\n\nå·ä½çå¬å¹³ä¸éå¬å¹³å®ç°æ¹å¼å¯ä»¥åç§è¿ç¯æç« ï¼SynchronousQueueå®ç°\n\n\n# 6. çº¿ç¨æ± ç¨å°çæç»ç­ç¥\n\næç»ç­ç¥çé¡¶çº§æ¥å£ ï¼RejectedExecutionHandler\n\npublic interface RejectedExecutionHandler {\n    void rejectedExecution(Runnable r, ThreadPoolExecutor executor);\n}\n\n\nåªæä¾ä¸ä¸ªæ¹æ³ï¼rejectedExecutionï¼å³å®å¶å·ä½çæç»ç­ç¥çæ§è¡é»è¾ã\n\n\n\n 1. AbortPolicy ï¼æåºå¼å¸¸ï¼ç»æ­¢ä»»å¡ã\n    \n    æåºæç»æ§è¡ RejectedExecutionHandler çå¼å¸¸ä¿¡æ¯ãè¿ä¹æ¯çº¿ç¨æ± é»è®¤çæç»ç­ç¥ã\n    \n    public static class AbortPolicy implements RejectedExecutionHandler {\n    \n        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n            throw new RejectedExecutionException("Task " + r.toString() +\n                                                 " rejected from " +\n                                                 e.toString());\n        }\n    }\n    \n\n 2. CallerRunsPolicy ï¼ä½¿ç¨è°ç¨çº¿ç¨æ§è¡ä»»å¡ã\n    \n    å½è§¦åè¯¥æç»ç­ç¥æ¶ï¼åªè¦çº¿ç¨æ± è¿æ²¡æå³é­ï¼å°±ä½¿ç¨ è°ç¨è¿ä¸ªæç»ç­ç¥ççº¿ç¨æ¥æ§è¡ä»»å¡ãä¸è¬å¹¶åæ¯è¾å°ï¼æ§è½è¦æ±ä¸é«ï¼ä¸åè®¸å¤±è´¥ãä½æ¯æ¯è°ç¨èèªå·±æ§è¡ä»»å¡ï¼å¦æå¹¶åæ¯è¾é«ä¼äº§çé»å¡ã\n    \n    public static class CallerRunsPolicy implements RejectedExecutionHandler {\n    \n        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n            // å¦æçº¿ç¨æ± è¿æ²¡åæ­¢ï¼å°±ä½¿ç¨å½åçº¿ç¨æ§è¡ä»»å¡\n            if (!e.isShutdown()) {\n                r.run();\n            }\n        }\n    }\n    \n\n 3. DiscardPolicy ï¼ç´æ¥ä¸¢å¼ï¼è¿å¼å¸¸é½ä¸æã\n    \n    public static class DiscardPolicy implements RejectedExecutionHandler {\n    \n        // æ¹æ³çå®ç°ä¸è¡é½æ²¡æ...\n        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n        }\n    }\n    \n\n 4. DiscardOldestPolicy ï¼ä¸¢å¼éåæèçä»»å¡ï¼å°è¯¥ä»»å¡æ·»å è¿å»ã\n    \n    å½è§¦åè¯¥æç»ç­ç¥æ¶ï¼åªè¦çº¿ç¨æ± è¿æªå³é­ï¼ä¸¢å¼é»å¡éåä¸­æèçä¸ä¸ªä»»å¡ï¼ä¹å°±æ¯éå¤´ä»»å¡ï¼ï¼å¹¶å°æ°ä»»å¡å å¥éåå°¾é¨ã\n    \n    public static class DiscardOldestPolicy implements RejectedExecutionHandler {\n         \n        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {\n            if (!e.isShutdown()) {\n                // ç±äºéåæ¯FIFOï¼é£ä¹pollåºæ¥çä¸å®æ¯éå¤´åç´ ï¼ä¹å°±æ¯éåä¸­æèçä»»å¡ã\n                e.getQueue().poll();\n                e.execute(r);\n            }\n        }\n    }\n    \n\n\n# 7. Executors\n\næ¯æ¬¡åå»ºçº¿ç¨æ± é½è¦å¡«7ä¸ªåæ°å¤ªéº»ç¦äºï¼æä»¥Javaä¸ºæä»¬æä¾äºå·¥å·ç±» ï¼Executorsã\n\nç®åä»ç»ä¸ä¸ä½¿ç¨è¿ä¸ªExecutorså¯ä»¥åå»ºä»ä¹æ ·ççº¿ç¨æ± ï¼\n\n 1. newSingleThreadExecutor()\n    \n    åçº¿ç¨ççº¿ç¨æ± ï¼æ ¸å¿çº¿ç¨æ°ä¸º1ï¼æå¤§çº¿ç¨æ°ä¸º1ï¼ä½¿ç¨é¾è¡¨å®ç°çé»å¡éåï¼ç¸å½äºè¿ä¸ªçº¿ç¨ä¸­åªæä¸ä¸ªçº¿ç¨å¨å·¥ä½ãå¤ä½çä»»å¡å¨é¨æè¿é»å¡éåä¸­ãå°±ååçº¿ç¨å¨ä¸²è¡æ§è¡ä»»å¡ä¸æ ·ï¼ä½æ¯ä¹æäºåºå« ï¼å¦æè¿ä¸ªå¯ä¸ççº¿ç¨åºç°äºå¼å¸¸ï¼çº¿ç¨æ± ä¼åå»ºä¸ä¸ªæ°ççº¿ç¨æ¥ä»£æ¿å®ã\n    \n    public static ExecutorService newSingleThreadExecutor() {\n        return new FinalizableDelegatedExecutorService\n            (new ThreadPoolExecutor(1, 1,\n                                    0L, TimeUnit.MILLISECONDS,\n                                    new LinkedBlockingQueue<Runnable>()));\n    }\n    \n\n 2. newFixedThreadPool(nThreads, threadFactory)\n    \n    æ ¸å¿çº¿ç¨æ°åæå¤§çº¿ç¨æ°é½ç±å¼åèæå®ï¼å¨é¨çº¿ç¨é½å¤äºæ´»è·ç¶æï¼ä¸ä¼æ­»äº¡ï¼ï¼ä½¿ç¨é¾è¡¨å®ç°çé»å¡éåãä¸æ¦æä¸ªçº¿ç¨åºç°å¼å¸¸ï¼çº¿ç¨æ± ä¼è¡¥åä¸ä¸ªçº¿ç¨ãæäº¤å°çº¿ç¨æ± çä»»å¡è¿å¤å¯è½ä¼å¯¼è´åå­æº¢åºã\n    \n    public static ExecutorService newFixedThreadPool(int nThreads, \n                                                     ThreadFactory threadFactory) {\n        return new ThreadPoolExecutor(nThreads, nThreads,\n                                      0L, TimeUnit.MILLISECONDS,\n                                      new LinkedBlockingQueue<Runnable>(),\n                                      threadFactory);\n    }\n    \n\n 3. newCachedThreadPool()\n    \n    å¯ç¼å­ççº¿ç¨æ± ï¼æ ¸å¿çº¿ç¨æ°ä¸º0ï¼å½çº¿ç¨æ± ä¸­ççº¿ç¨æ°éè¶è¿äºè¿è¡ä»»å¡æéè¦ççº¿ç¨æ°ï¼é£ä¹å¯ä»¥åæ¶ç©ºé²ççº¿ç¨ï¼é»è®¤æ¯60såæ¶ï¼åæ¶å½ä»»å¡å¢å çæ¶åï¼çº¿ç¨æ± åå¯ä»¥åå»ºæ°ççº¿ç¨æ¥å¤çä»»å¡ã\n    \n    public static ExecutorService newCachedThreadPool() {\n        return new ThreadPoolExecutor(0, Integer.MAX_VALUE,\n                                      60L, TimeUnit.SECONDS,\n                                      new SynchronousQueue<Runnable>());\n    }\n    \n\n> éè¦æ³¨æçæ¯ ï¼ä¸å»ºè®®ä½¿ç¨è¿å ä¸ªå·²æççº¿ç¨æ± ï¼å»ºè®®èªå·±æ ¹æ®ä»»å¡çç¹ç¹ï¼IOå¯éãCPUå¯éï¼æ¥åå»ºçº¿ç¨æ± ã\n\n\n# 8. çº¿ç¨æ± åæ°çéç½®\n\nçº¿ç¨æ± æ7ä¸ªåæ°ï¼é£è¯¥å¦ä½éç½®å®ä»¬ä½¿å¾å©çæå¤§åå¢ï¼\nè¿è¦ççº¿ç¨æ± éè¦æ§è¡çä»»å¡æ¯CPUå¯éåè¿æ¯IOå¯éåã\n\n 1. CPUå¯éå ï¼ä»»å¡ä¸­å«æå¤§éçè®¡ç®ï¼ä¾å¦ä¸è§å½æ°ãä½è¿ç®ãåå¨çè®¡ç®.... CPUå¯éåä¹å«è®¡ç®å¯éå\n 2. IOå¯éå ï¼ä»»å¡ä¸­å«æå¤§éçIOæä½ãä¾å¦ï¼è¯»åæä»¶ãè®¿é®æ°æ®åºãä½¿ç¨ä¸­é´ä»¶...\n\nä¸ççä¸äºçº¿ç¨æ± åæ°éç½®æ¹æ¡ï¼ è½ç¶æ¹æ¡å¾å¤ï¼ä½æ¯æä»¬å¹¶æ²¡æå¾åºéç¨ççº¿ç¨æ± è®¡ç®æ¹å¼ãå¹¶åä»»å¡çæ§è¡æåµåä»»å¡ç±»åç¸å³ï¼IOå¯éååCPUå¯éåçä»»å¡è¿è¡èµ·æ¥çæåµå·®å¼éå¸¸å¤§ï¼ ä½è¿ç§å æ¯æ¯è¾é¾åçé¢ä¼°çï¼è¿å¯¼è´å¾é¾æä¸ä¸ªç®åææçéç¨å¬å¼å¸®æä»¬ç´æ¥è®¡ç®åºç»æã\n\næè\n\næ¢ç¶ä¸è½å¤ä¿è¯ä¸æ¬¡è®¡ç®åºæ¥åéçåæ°ï¼é£ä¹æ¯å¦å¯ä»¥å°ä¿®æ¹çº¿ç¨æ± åæ°çææ¬éä¸æ¥ï¼è¿æ ·è³å°å¯ä»¥åçæéçæ¶åå¯ä»¥å¿«éè°æ´ä»èç¼©ç­æéæ¢å¤çæ¶é´å¢ï¼\nåºäºè¿ä¸ªæèï¼æ¯å¦å¯ä»¥å°çº¿ç¨æ± çåæ°ä»ä»£ç ä¸­è¿ç§»å°åå¸å¼éç½®ä¸­å¿ä¸ï¼å®ç°çº¿ç¨æ± åæ°å¯å¨æéç½®åå³æ¶çæ\n\nè¿å°±æ¯å¨æçº¿ç¨æ± çç±æ¥ãä»ä¹ï¼å¦ä½å®ç°ï¼æä¸ä¼ï¼åèç¾å¢å¼æºé¡¹ç® DynamicTp ï¼ç¾å¢å¨æçº¿ç¨æ± å®è·µæè·¯',normalizedContent:'# 1. åè¨\n\n\n# 2. æ¦è¿°\n\nè³äºä¸ºä»ä¹è¦æçº¿ç¨æ± ï¼javaéé¢æå¾å¤æ± ï¼ä¾å¦å¸¸éæ± ãæ°æ®åºè¿æ¥æ± ãçº¿ç¨æ± .....ä»ä»¬é½ä½ç°äºä¸ç§æ± åææ³ï¼ä»ä¹æ¯æ± åææ³å¢ï¼å°±æ¯éè¿åå»ºåç®¡çå¯éå¤ä½¿ç¨çèµæºæ¥æé«èµæºçå©ç¨çï¼è¿èæé«æ§è½ã\n\n> çº¿ç¨æ± ç®èè¨ä¹ï¼å°±æ¯ä¸ä¸ªæè®¸å¤çº¿ç¨çå®¹å¨ï¼è¿äºçº¿ç¨å¹¶ä¸è·æä»¬å¹³æ¶ä½¿ç¨ççº¿ç¨ä¸æ ·éç¨éä¸¢ï¼èæ¯å°å®ä»¬æ¾å¨å®¹å¨ä¹å°±æ¯çº¿ç¨æ± ä¸­ï¼ä»¥ä¾¿å¯ä»¥éå¤ä½¿ç¨ï¼åå°çº¿ç¨éå¤åå»ºåéæ¯å¸¦æ¥çæ§è½æ¶èã\n\né¦åæ¥çä¸ä¸threadpoolexecutorçumlç±»å¾ï¼äºè§£ä¸threadpoolexecutorçç»§æ¿å³ç³»ã\n\n\n\n\n# 3. executorãexecutorservice\n\nåæ¥çä¸ä¸executorï¼\n\npublic interface executor {\n    void execute(runnable command);\n}\n\n\nå¯ä»¥çå°ï¼executor è¿ä¸ªæ¥å£ååç®åï¼åªæä¾äºä¸ä¸ª executor æ¹æ³ï¼ä¹å°±æ¯æ§è¡æ¹æ³ãå®ç°äºè¿ä¸ªæ¹æ³çäººè¦å»å®æçº¿ç¨çä¸»è¦é»è¾ï¼ä¹å°±æ¯æ§è¡ã\n\næ¥ä¸æ¥ç executorservice ï¼\n\npublic interface executorservice extends executor {\n    void shutdown();  \n    list<runnable> shutdownnow();\n    boolean isshutdown();\n    boolean isterminated();\n    boolean awaittermination(long timeout, timeunit unit)\n        throws interruptedexception;\n\n    <t> future<t> submit(callable<t> task);\n    <t> list<future<t>> invokeall(collection<? extends callable<t>> tasks)\n        throws interruptedexception;\n    // è¿æä¸äºæ¹æ³ä¸ååä¸¾\n}\n\n\nexecutorserviceæä¾äºå¯¹äºçº¿ç¨æ± æä½çæå¡ï¼ä¾å¦ä»»å¡çæäº¤submitãå¤æ­çº¿ç¨æ± çç¶æisshutdown....\n\nexecutorserviceæ¥å£å¢å äºä¸äºè½åï¼\nï¼1ï¼æ©åæ§è¡ä»»å¡çè½åï¼è¡¥åå¯ä»¥ä¸ºä¸ä¸ªæä¸æ¹å¼æ­¥ä»»å¡çæfutureçæ¹æ³ï¼\nï¼2ï¼æä¾äºç®¡æ§çº¿ç¨æ± çæ¹æ³ï¼æ¯å¦åæ­¢çº¿ç¨æ± çè¿è¡ãabstractexecutorserviceåæ¯ä¸å±çæ½è±¡ç±»ï¼å°æ§è¡ä»»å¡çæµç¨ä¸²èäºèµ·æ¥ï¼ä¿è¯ä¸å±çå®ç°åªéå³æ³¨ä¸ä¸ªæ§è¡ä»»å¡çæ¹æ³å³å¯ã\n\n> é£ä¹å½æä»¬ä½¿ç¨ threadpoolexecutor æ¶å°±å¯ä»¥æè¯å°ï¼\n> \n>  * ä¸»è¦çæ§è¡æ¹æ³æ¯ å®ç°executorçã\n>  * åè½æ¹æ³æ¯ å®ç°executorservice çã\n\nexecutoråexecutorserviceæä¾äºä¸ç§ææ³ ï¼å°ä»»å¡çæäº¤åä»»å¡çæ§è¡è§£è¦ã\n\nç¨æ·æ éå³æ³¨å¦ä½åå»ºçº¿ç¨ãå¦ä½è°åº¦çº¿ç¨æ¥æ§è¡ä»»å¡ï¼ç¨æ·åªéæä¾runnableå¯¹è±¡ï¼å°ä»»å¡çè¿è¡é»è¾æäº¤å°æ§è¡å¨(executor)ä¸­ï¼ç±executoræ¡æ¶å®æçº¿ç¨çè°éåä»»å¡çæ§è¡é¨åã\n\n\n# 4. threadpoolexecutor\n\n\n# 4.1 ä¸ä¸ªæ ¸å¿åæ°\n\nåªè¦å­¦ä¹  threadpoolexector ï¼ç»ä¸å¼å®çä¸ä¸ªåæ°ã\n\npublic threadpoolexecutor(int corepoolsize,\n                          int maximumpoolsize,\n                          long keepalivetime,\n                          timeunit unit,\n                          blockingqueue<runnable> workqueue,\n                          threadfactory threadfactory,\n                          rejectedexecutionhandler handler) \n\n\n 1. corepoolsize ï¼æ ¸å¿çº¿ç¨æ°ï¼é»è®¤æåµä¸ï¼æ ¸å¿çº¿ç¨æ°ä¼ä¸ç´å­æ´»ã\n\n 2. maximumpoolsize ï¼æå¤§çº¿ç¨æ°ï¼æ ¸å¿çº¿ç¨æ°+ä¸´æ¶çº¿ç¨æ°çæ»åã\n    \n    é¤äºæ ¸å¿çº¿ç¨æ°ä¹å¤ççº¿ç¨æ°ç§°ä¸ºä¸´æ¶çº¿ç¨ï¼maximumpoolsize - corepoolsize ï¼ï¼ä¸´æ¶çº¿ç¨å¦æä¸å®æ¶é´åæ¥æ¶ä¸å°ä»»å¡ä¼æ­»äº¡ã\n\n 3. keepalivetime ï¼ä¸´æ¶çº¿ç¨æ¥æ¶ä¸å°ä»»å¡æ¶çæ­»äº¡æ¶é´ã\n\n 4. unit ï¼æ¶é´çåä½\n\n 5. workqueue ï¼é»å¡éåï¼å­æ¾ä»»å¡çå°æ¹ã\n\n 6. threadfactory ï¼çº¿ç¨å·¥åï¼ææçº¿ç¨å¨è¿éè¢«åå»ºã\n\n 7. handler ï¼å½ä»»å¡å®å¨å¤ªå¤æ¶æ§è¡çæç»ä»»å¡çç­ç¥ã\n\nçº¿ç¨æ± çå·¥ä½æµç¨\n\nå½æ ¸å¿çº¿ç¨æ°æç©ºé²æ°æ¶ï¼ææä»»å¡é½ä¼è¢«æ ¸å¿çº¿ç¨å¤çï¼\n\nå½æ ¸å¿çº¿ç¨é½å¿ç¢æ¶ï¼ä»»å¡é¦åå°è¾¾é»å¡éåä¸­ç­å¾ï¼æ ¸å¿çº¿ç¨æ§è¡å®æä¸çä»»å¡åä¼å»ä»»å¡éåä¸­åä»»å¡ã\n\nå½ä»»å¡éåæ»¡åä¼åå»ºä¸´æ¶çº¿ç¨æ§è¡ä»»å¡ï¼ä¸´æ¶çº¿ç¨ä¹ä¼ä»ä»»å¡éåä¸­åä»»å¡æ§è¡ã\n\nå½ä»»å¡éåæ»¡äºå¹¶ä¸å¨é¨çº¿ç¨é½å¨å·¥ä½ä¸­ï¼è¿æ¯ææ°çä»»å¡å°è¾¾ï¼å°±ä¼æ§è¡æç»ç­ç¥ã\n\n\n# 4.2 çå½å¨æç®¡ç\n\nçº¿ç¨æ± è¿è¡çç¶æå¹¶ä¸æ¯ç¨æ·æ¾å¼è®¾ç½®çï¼èæ¯ä¼´éççº¿ç¨æ± çè¿è¡ç±åé¨æ¥ç»´æ¤ãçº¿ç¨æ± åé¨ä½¿ç¨ä¸ä¸ªåéç»´æ¤ä¸¤ä¸ªå¼ï¼è¿è¡ç¶æ(runstate)åçº¿ç¨æ°é (workercount)ã\nå¨å·ä½å®ç°ä¸­ï¼çº¿ç¨æ± å°è¿è¡ç¶æ(runstate)ãçº¿ç¨æ°é (workercount)ä¸¤ä¸ªå³é®åæ°çç»´æ¤æ¾å¨äºä¸èµ·ï¼ç±åä¸ä¸ªåéç®¡çï¼\n\nprivate final atomicinteger ctl = new atomicinteger(ctlof(running, 0));\n\n\nctlè¿ä¸ªatomicintegerç±»åçåéï¼æ¯å¯¹çº¿ç¨æ± çè¿è¡ç¶æ(runstate)ãçº¿ç¨æ°é (workercount) ä¸¤ä¸ªä¿¡æ¯çæ±æ»ï¼ é«3ä½ä¿å­runstateï¼ä½29ä½ä¿å­workercountï¼ä¸¤ä¸ªåéä¹é´äºä¸å¹²æ°ãç¨ä¸ä¸ªåéå»å­å¨ä¸¤ä¸ªå¼ï¼å¯é¿åå¨åç¸å³å³ç­æ¶åºç°ä¸ä¸è´çæåµï¼ä¸å¿ä¸ºäºç»´æ¤ä¸¤èçä¸è´èå ç¨éèµæºã\n\n// count_bits = 32 - 3 = 29\n// capacity = 1 << 29 - 1\nprivate static final int count_bits = integer.size - 3;\nprivate static final int capacity   = (1 << count_bits) - 1;\n\n//è®¡ç®å½åè¿è¡ç¶æ\nprivate static int runstateof(int c)     { \n    return c & ~capacity; \n} \n//è®¡ç®å½åçº¿ç¨æ°é\nprivate static int workercountof(int c)  { \n    return c & capacity; \n}  \n//éè¿ç¶æåçº¿ç¨æ°çæctl\nprivate static int ctlof(int rs, int wc) { \n    return rs | wc; \n}   \n\n\nthreadpoolexecutorçè¿è¡ç¶ææ5ç§ï¼åå«ä¸ºï¼\n\nå¶çå½å¨æè½¬æ¢å¦ä¸å¥æç¤ºï¼\n\n\n# 4.3 ä»»å¡æ§è¡æºå¶\n\nä»»å¡è°åº¦æ¯çº¿ç¨æ± çä¸»è¦å¥å£ï¼å½ç¨æ·æäº¤äºä¸ä¸ªä»»å¡ï¼æ¥ä¸æ¥è¿ä¸ªä»»å¡å°å¦ä½æ§è¡é½æ¯ç±è¿ä¸ªé¶æ®µå³å®çãäºè§£è¿é¨åå°±ç¸å½äºäºè§£äºçº¿ç¨æ± çæ ¸å¿è¿è¡æºå¶ã\n\né¦åï¼ææä»»å¡çè°åº¦é½æ¯ç±executeæ¹æ³å®æçï¼è¿é¨åå®æçå·¥ä½æ¯ï¼æ£æ¥ç°å¨çº¿ç¨æ± çè¿è¡ç¶æãè¿è¡çº¿ç¨æ°ãè¿è¡ç­ç¥ï¼å³å®æ¥ä¸æ¥æ§è¡çæµç¨ï¼æ¯ç´æ¥ç³è¯·çº¿ç¨æ§è¡ï¼ææ¯ç¼å²å°éåä¸­æ§è¡ï¼äº¦ææ¯ç´æ¥æç»è¯¥ä»»å¡ãå¶æ§è¡è¿ç¨å¦ä¸ï¼\n\n 1. é¦åæ£æµçº¿ç¨æ± è¿è¡ç¶æï¼å¦æä¸æ¯runningï¼åç´æ¥æç»ï¼çº¿ç¨æ± è¦ä¿è¯å¨runningçç¶æä¸æ§è¡ä»»å¡ã\n 2. å¦æworkercount < corepoolsizeï¼ååå»ºå¹¶å¯å¨ä¸ä¸ªçº¿ç¨æ¥æ§è¡æ°æäº¤çä»»å¡ã\n 3. å¦æworkercount >= corepoolsizeï¼ä¸çº¿ç¨æ± åçé»å¡éåæªæ»¡ï¼åå°ä»»å¡æ·»å å°è¯¥é»å¡éåä¸­ã\n 4. å¦æworkercount >= corepoolsize && workercount < maximumpoolsizeï¼ä¸çº¿ç¨æ± åçé»å¡éåå·²æ»¡ï¼ååå»ºå¹¶å¯å¨ä¸ä¸ªçº¿ç¨æ¥æ§è¡æ°æäº¤çä»»å¡ã\n 5. å¦æworkercount >= maximumpoolsizeï¼å¹¶ä¸çº¿ç¨æ± åçé»å¡éåå·²æ»¡, åæ ¹æ®æç»ç­ç¥æ¥å¤çè¯¥ä»»å¡, é»è®¤çå¤çæ¹å¼æ¯ç´æ¥æå¼å¸¸ã\n\næ¥çä¸ä¸å®ç execute æºç  ï¼\n\npublic void execute(runnable command) {\n    if (command == null)\n        throw new nullpointerexception();\n    \n    // è·åctlï¼ç¨äºæ£æ¥çº¿ç¨æ± ççº¿ç¨æ°ä»¥åçº¿ç¨æ± ç¶æ\n    int c = ctl.get();\n    \n    // å¦æå½åä»»å¡æ°å°äºæ ¸å¿çº¿ç¨æ°ï¼ç´æ¥ä½¿ç¨æ ¸å¿çº¿ç¨\n    if (workercountof(c) < corepoolsize) {\n        //æ§è¡addworker,ä¼åå»ºä¸ä¸ªæ ¸å¿çº¿ç¨ï¼å¦æåå»ºå¤±è´¥ï¼éæ°è·åctl\n        if (addworker(command, true))\n            return;\n        c = ctl.get();\n    }\n    \n    // å¦æçº¿ç¨æ± è¿æ´»çï¼é£ä¹å°±å¯ä»¥å°å®å å¥é»å¡éå, (ä¹ä»ä»æ¯å å¥éåï¼å¹¶æ²¡ææ§è¡)\n    if (isrunning(c) && workqueue.offer(command)) {\n        //åæ¬¡è·åctlï¼è¿è¡åéæ£ç´¢ï¼ä¹å°±æ¯å¯¹çº¿ç¨æ± çç¶æåæ¬¡æ£æ¥ä¸éï¼\n        int recheck = ctl.get();\n        \n        //å¦æçº¿ç¨æ± æ¯ä¸æ¯å¤äºrunningçç¶æï¼é£ä¹å°±ä¼å°ä»»å¡ä»éåä¸­ç§»é¤ï¼\n        if (! isrunning(recheck) && remove(command))\n            reject(command);\n        //å¦æç§»é¤å¤±è´¥ï¼åä¼å¤æ­å·¥ä½çº¿ç¨æ¯å¦ä¸º0 ï¼å¦æè¿ä¸º0 å°±åå»ºä¸ä¸ªéæ ¸å¿çº¿ç¨\n        else if (workercountof(recheck) == 0)\n            addworker(null, false);\n    }\n\t//å¦æç§»é¤æåï¼å°±æ§è¡æç»ç­ç¥ï¼å ä¸ºçº¿ç¨æ± å·²ç»ä¸å¯ç¨äºï¼\n    else if (!addworker(command, false))\n        reject(command);\n}\n\n\n\nå¯ä»¥çå°ï¼åå»ºæ ¸å¿çº¿ç¨åéæ ¸å¿çº¿ç¨é½æ¯è°ç¨addworkeræ¹æ³\n\n// å¦ærunnableä¸ç©ºï¼ä¸coreä¸ºtrueï¼åè¯æåå»ºçæ¯æ ¸å¿çº¿ç¨ã\n// å¦ærunnableä¸ºç©ºï¼ä¸coreä¸ºfalse, åè¯æåå»ºçæ¯éæ ¸å¿çº¿ç¨ã\nprivate boolean addworker(runnable firsttask, boolean core)\n\n\naddworkerï¼æå¶ä»æ­¥éª¤é½å¿½ç¥ï¼æ¥çæä»¬æäº¤çä¸ä¸ªä»»å¡æ¯å¦ä½è¢«å¤ççã\n\nprivate boolean addworker(runnable firsttask, boolean core) {\n        w = new worker(firsttask);\n}\n\n\nnew äºä¸ä¸ªworkerï¼é£ä¹è¿ä¸ªworkeræ¯ä»ä¹ï¼\n\nworker(runnable firsttask) {\n    setstate(-1); // inhibit interrupts until runworker\n    this.firsttask = firsttask;\n    this.thread = getthreadfactory().newthread(this);\n}\n\n\nä» getthreadfactory().newthread(this) å¯ä»¥çåºï¼å°±æå½åçworkerå¯¹è±¡ä½ä¸ºä»»å¡ä¼ ç»äºæ°å»ºççº¿ç¨ï¼è¿æ ·å¯å¨çº¿ç¨æ¶ï¼å®ä¹å°±å¯å¨äºã\n\n> é£ä¹æèä¸ä¸ªé®é¢ï¼å¦æä»»å¡æ°éå°äºæ ¸å¿çº¿ç¨æ°å¹¶ä¸åæ¥ä¸ä¸ªä»»å¡ï¼æ¯ä¼åè®©ç©ºé²çæ ¸å¿çº¿ç¨æ§è¡ä»»å¡è¿æ¯ç´æ¥åå»ºä¸ä¸ªæ ¸å¿çº¿ç¨å¢ï¼\n> \n> åæçä»£ç ä¸æ¯å·²ç»æç­æ¡äºåï¼å½è°ç¨addworkeræ·»å ä¸ä¸ªä»»å¡çæ¶åï¼å¦ææ ¸å¿çº¿ç¨æ°è¿æ²¡æåå»ºæ»¡ï¼ä¼ååå»ºæ ¸å¿çº¿ç¨ã\n\n\n# 5. çº¿ç¨æ± ç¨å°çéå\n\nä¸ºä»ä¹è¦å­¦ä¹ é»å¡éåï¼\nçº¿ç¨æ± å¯ä»¥é«æå©ç¨çº¿ç¨ï¼ä¹å°±æ¯è¯´çº¿ç¨å¯ä»¥å¨æä¸ªå°æ¹ä¸ç´æ¿ä»»å¡å»æ§è¡ï¼èä¸æ§è¡å®äºä¹åè¿ä¸æ­»äº¡ï¼é£ä¹å»åªéæ¿ä»»å¡å¢ï¼è¿æ¶åå°±éè¦æä¸ä¸ªå®¹å¨ï¼é»å¡éåã\n\n\n# 5.0 é»å¡éåä¸éé»å¡éå\n\n 1. é»å¡éå\n    * å¥é ï¼å¦æéåæ»¡äºï¼ä¸ç´ç­å¾ç´å°æä½ç½®å°±å¥éã\n    * åºé ï¼å¦æéåä¸­æ²¡æå¼ï¼ä¸ç´ç­å¾ç´å°éåä¸­æå¼æä¼åºéã\n 2. éé»å¡éå\n    * å¥é ï¼éåæä½ç½®å°±å¥éï¼æ²¡ä½ç½®å°±è¿åfalseæèæ¥éã\n    * åºé ï¼éåä¸­æå¼å°±åºéï¼æ²¡æå¼å°±è¿ånullæèæ¥éã\n\néé»å¡éåä¸­çå ä¸ªä¸»è¦æ¹æ³ï¼add(t)ãremove()ãoffer(t)ãpoll()ãpeek()ã\n\né»å¡éåæ¥æéé»å¡éåçå¨é¨æ¹æ³ï¼èä¸è¿å¤äºå ä¸ªæ¹æ³ï¼put(t)ãtake()ãoffer(t, timeout)ãpoll(t, timeout)ã\n\nè¿å ä¸ªæ¹æ³å®ç°äºé»å¡ææï¼ä¹æ¯ä¸é¢ä»ç»çé»å¡éåä¸éé»å¡éåçåºå«ï¼æ¥ç®åççputæ¹æ³æ¯æä¹å®ç° é»å¡ åè½çï¼\n\npublic void put(e e) throws interruptedexception {\n    checknotnull(e);\n    final reentrantlock lock = this.lock;\n    lock.lockinterruptibly();\n    try {\n        while (count == items.length)\n            notfull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n\n\nput()æ¹æ³æ¯åéåä¸­æ·»å åç´ ï¼ä¸è¿æ¥åæ£æ¥åç´ æ¯å¦ä¸ºç©ºï¼æ¥çå°±å éï¼ç¶åwhileå¤æ­ç°æåç´ æ¯å¦ç­äºéåçæå¤§é¿åº¦ï¼å¦æç­äºï¼è¯´æéè¦é»å¡ï¼é£å°±è°ç¨awaitæ¹æ³è¿è¡é»å¡ç­å¾ãè¿å°±å®ç°äºé»å¡åè½ã\n\n> å¨jucä¸­ï¼å¤§å¤æ°ä½¿ç¨é»å¡éåãå½ç¶ä¹æä½¿ç¨éé»å¡éåã\n> \n> ä½æ¯ç±äºæ¬ç¯æ¯ çº¿ç¨æ± ç¸å³æç« ï¼æåªä»ç»çº¿ç¨æ± ç¸å³çè¿å ä¸ªé»å¡éåã\n\n\n# 5.1 arrayblockingqueue\n\nåºäºæ°ç»å®ç°çé»å¡éåï¼æ¯æå¬å¹³ä¸éå¬å¹³æ¨¡å¼ï¼é»è®¤éå¬å¹³ã\n\nå ä¸ºæ¯åºäºæ°ç»å®ç°çï¼æä»¥å¨æå»ºæ¶éè¦æå®åå§å®¹éã\n\npublic arrayblockingqueue(int capacity) \npublic arrayblockingqueue(int capacity, boolean fair)\n// æä¾äºåæ°æå®è¯¥éåæ¯é»å¡è¿æ¯éé»å¡ã\npublic arrayblockingqueue(int capacity, boolean fair, collection<? extends e> c)\n\n\nä¸å±ä¸ä¸ªæé å¨ï¼é½è¦æå®åå§å¤§å°ãæ°æ®å¨é¨å­å¨å¨æ°ç»ä¸­ãå¹¶ä¸è¿ä¸ªæ°ç»ä¸è½æ©å®¹ï¼å ä¸ºæ²¡ææä¾ç¸å³æ©å®¹æ¹æ³ã\n\n// å­å¨åç´ çæ°ç»\nfinal object[] items;\n\n// ä¸ä¸æ¬¡ takeãpollãpeekå°è¦æä½çä¸æ \nint takeindex;\n\n// ä¸ä¸æ¬¡ putãofferãaddå°è¦æä½çä¸æ \nint putindex;\n\n// ç°æåç´ çæ°éã\nint count;\n\n\néè¿ takeindex å putindex ç¡®å®æä½çä¸æ ï¼éè¿ count ç¡®å®æä½æ¯å¦è¦é»å¡ã\n\nè¯åè¯´åæ¥ï¼å¦ä½å®ç°çé»å¡ï¼å¦ä½å®ç°çå¬å¹³ä¸éå¬å¹³ï¼\n\nåå©conditionå®ç°é»å¡ï¼åå©reentrantlockå®ç°å¬å¹³ä¸éå¬å¹³ã\n\n> å®ç°é»å¡ï¼\n\narrayblockingqueueä¸­æä¸¤ä¸ªconditionå¯¹è±¡ï¼notemptyä¸notfullï¼ä¸ä¸ªæ¯ç¨äºå¤ç©ºï¼ä¸ä¸ªæ¯ç¨äºå¤æ»¡ã\n\nprivate final condition notempty;\nprivate final condition notfull;\n\n\nconditionæ¯ç¨æ¥å¹²å¥çï¼\n\nç®èè¨ä¹ï¼conditionæä¾äºawait()æ¹æ³å°å½åçº¿ç¨é»å¡ï¼å¹¶æä¾signal()æ¹æ³æ¯æå¦å¤ä¸ä¸ªçº¿ç¨å°å·²ç»é»å¡ççº¿ç¨å¤éã\n\næä»¥å¦ä½å®ç°é»å¡å¢ï¼\nå½æ»¡çæ¶åä½¿ç¨notfull.await()é»å¡å½åçº¿ç¨ï¼å½ç©ºçæ¶åä½¿ç¨notempty.await()é»å¡å½åçº¿ç¨ï¼å½å¼¹åºä¸ä¸ªåç´ çæ¶åè°ç¨signalæ¹æ³å¤éçº¿ç¨è¿æ¥æ¢ä½ç½®ï¼å½æ¾å¥ä¸ä¸ªåç´ çæ¶åéç¥çº¿ç¨è¿æ¥ååç´ ã\næºç å¦ä¸ï¼å é¤é¨ååä½ä»£ç ï¼ï¼\n\n// å½æ»¡çæ¶åä½¿ç¨notfull.await()é»å¡å½åçº¿ç¨\npublic void put(e e) throws interruptedexception {\n    final reentrantlock lock = this.lock;\n    lock.lockinterruptibly();\n    try {\n        // éåæ»¡äº\n        while (count == items.length)\n            //  notfull.await å°å½åçº¿ç¨é»å¡\n            notfull.await();\n        enqueue(e);\n    } finally {\n        lock.unlock();\n    }\n}\n// å½åºéæ¶ï¼å°é»å¡ççº¿ç¨å¤é\nprivate e dequeue() {\n    final object[] items = this.items;\n    @suppresswarnings("unchecked")\n    e x = (e) items[takeindex];\n    items[takeindex] = null;\n    if (++takeindex == items.length)\n        takeindex = 0;\n    count--;\n    if (itrs != null)\n        itrs.elementdequeued();\n    // å°é»å¡ççº¿ç¨å¤é\n    notfull.signal();\n    return x;\n}\n\n\n// å½ç©ºçæ¶åä½¿ç¨notempty.await()é»å¡å½åçº¿ç¨\npublic e poll(long timeout, timeunit unit) throws interruptedexception {\n    final reentrantlock lock = this.lock;\n    lock.lockinterruptibly();\n    try {\n        // éåä¸ºç©º\n        while (count == 0) {\n            // notempty.await å°å½åçº¿ç¨é»å¡\n            nanos = notempty.awaitnanos(nanos);\n        }\n        return dequeue();\n    } finally {\n        lock.unlock();\n    }\n}\n// å½å¥éæ¶ï¼å°å¯¹åºçº¿ç¨å¤é\nprivate void enqueue(e x) {\n    final object[] items = this.items;\n    items[putindex] = x;\n    if (++putindex == items.length)\n        putindex = 0;\n    count++;\n    // å°é»å¡çº¿ç¨å¤é\n    notempty.signal();\n}\n\n\n> å®ç°å¬å¹³ãéå¬å¹³\n\nåé¨æreentrantlockï¼ç±äºconditionæ¯åå©lockæè½åæ¥ä½ç¨çï¼æä»¥å½lockçå®ç°ç±»reentrantlockæ¯æå¬å¹³éä¸éå¬å¹³éæ¶ï¼é»å¡åçå¤éèªç¶ä¹å°±æ¥æå¬å¹³ä¸éå¬å¹³çè½åã\n\n\n# 5.2 linkedblockingqueue\n\nåºäºé¾è¡¨å®ç°çé»å¡éåãåªæ¯æéå¬å¹³æ¨¡å¼ï¼\nï¼å ä¸ºæ²¡æåæ°å»æå® reentrantlock çå¬å¹³ä¸éå¬å¹³æ¨¡å¼ï¼æä»¥å®åªæ¯æéå¬å¹³æ¨¡å¼ãï¼\n\nlinkedblockingqueueå¯ä»¥æå®å¤§å°ï¼å¦æä¸æå®ï¼é»è®¤ä¸æå¤§å°±æ¯integer.max_valueã\n\npublic linkedblockingqueue() {\n    this(integer.max_value);\n}\npublic linkedblockingqueue(int capacity);\npublic linkedblockingqueue(collection<? extends e> c) ;\n\n\nä¸ºä»ä¹è¯´å®æ¯åºäºé¾è¡¨å®ç°çï¼å ä¸ºåé¨å°è£äºä¸ä¸ªéæåé¨ç±»ï¼ä¹å°±æ¯é¾è¡¨èç¹\n\nstatic class node<e> {\n    e item;\n\n    node<e> next;\n\n    node(e x) { item = x; }\n}\n\n\nä»nodeçæååéå¯ä»¥çåºï¼è¿æ¯ä¸ä¸ªåé¾è¡¨ï¼å ä¸ºå®åªæä¸ä¸ªnextæéã\n\næä»¥å¯ä»¥è¯´linkedblockingqueueå¶å®æ¯ä¸ä¸ªç±åé¾è¡¨ç»æçãåªæ¯æéå¬å¹³æ¨¡å¼çãå¯ä»¥æå®å¤§å°çé»å¡éåã\n\nä¸arrayblockingqueueçåºå«ä¸æ­¢è¿äºï¼linkedblockingqueueåé¨æä¸¤æéï¼arrayblockingqueueåªæä¸æ\n\nprivate final reentrantlock takelock = new reentrantlock();\nprivate final condition notempty = takelock.newcondition();\n\n\nprivate final reentrantlock putlock = new reentrantlock();\nprivate final condition notfull = putlock.newcondition();\n\n\n\n# 5.3 synchronousqueue\n\nä¸é¢ä¸¤ç§éåé½æ¯æççæå¤§ä¹å°±integer.max_valueï¼è¿ä¸ªéåæ¯æ çç....éï¼è¿ä¸ªéåä¸å­å¨æ°æ®ðå®åªæ¯æ°æ®çæ¬è¿å·¥ã\n\nsynchronousqueue å¨æå¥æ°æ®æ¶å¿é¡»ç­å¾å¦ä¸ä¸ªçº¿ç¨æ¥åèµ°è¯¥æ°æ®ï¼åä¹äº¦ç¶ã\n\nsynchronousqueueçå®ç°æ¹å¼æ¯åºäº transferqueue æ¥å£ï¼å®æä¾äºä¸¤ä¸ªä¸»è¦çæ¹æ³ï¼put()åtake()ãput()æ¹æ³ç¨äºæå¥åç´ ï¼å¦ææ²¡æå¦ä¸ä¸ªçº¿ç¨æ­£å¨ç­å¾æ¥æ¶è¯¥åç´ ï¼åæå¥æä½å°ä¸ç´é»å¡ï¼ç´å°æå¦ä¸ä¸ªçº¿ç¨è°ç¨take()æ¹æ³æ¥åèµ°è¯¥åç´ ãtake()æ¹æ³ç¨äºåèµ°åç´ ï¼å¦ææ²¡æå¦ä¸ä¸ªçº¿ç¨æ­£å¨ç­å¾æå¥åç´ ï¼ååèµ°æä½å°ä¸ç´é»å¡ï¼ç´å°æå¦ä¸ä¸ªçº¿ç¨è°ç¨put()æ¹æ³æ¥æå¥åç´ ã\n\n// putæ¾åç´ æ¶ï¼å¦ææå¶ä»çº¿ç¨æ­£å¨ç­å¾çååç´ ï¼å°±ç»ä»ï¼å¦ææ²¡æå°±é»å¡ã\npublic void put(e e) throws interruptedexception {\n    if (e == null) throw new nullpointerexception();\n    if (transferer.transfer(e, false, 0) == null) {\n        thread.interrupted();\n        throw new interruptedexception();\n    }\n}\n\n// takeååç´ æ¶ï¼å¦ææåç´ å°±æ¿èµ°ï¼å¦ææ²¡åç´ å°±é»å¡(thread.interrupted)\npublic e take() throws interruptedexception {\n    e e = transferer.transfer(null, false, 0);\n    if (e != null)\n        return e;\n    thread.interrupted();\n    throw new interruptedexception();\n}\n\n\nå·ä½çå¬å¹³ä¸éå¬å¹³å®ç°æ¹å¼å¯ä»¥åç§è¿ç¯æç« ï¼synchronousqueueå®ç°\n\n\n# 6. çº¿ç¨æ± ç¨å°çæç»ç­ç¥\n\næç»ç­ç¥çé¡¶çº§æ¥å£ ï¼rejectedexecutionhandler\n\npublic interface rejectedexecutionhandler {\n    void rejectedexecution(runnable r, threadpoolexecutor executor);\n}\n\n\nåªæä¾ä¸ä¸ªæ¹æ³ï¼rejectedexecutionï¼å³å®å¶å·ä½çæç»ç­ç¥çæ§è¡é»è¾ã\n\n\n\n 1. abortpolicy ï¼æåºå¼å¸¸ï¼ç»æ­¢ä»»å¡ã\n    \n    æåºæç»æ§è¡ rejectedexecutionhandler çå¼å¸¸ä¿¡æ¯ãè¿ä¹æ¯çº¿ç¨æ± é»è®¤çæç»ç­ç¥ã\n    \n    public static class abortpolicy implements rejectedexecutionhandler {\n    \n        public void rejectedexecution(runnable r, threadpoolexecutor e) {\n            throw new rejectedexecutionexception("task " + r.tostring() +\n                                                 " rejected from " +\n                                                 e.tostring());\n        }\n    }\n    \n\n 2. callerrunspolicy ï¼ä½¿ç¨è°ç¨çº¿ç¨æ§è¡ä»»å¡ã\n    \n    å½è§¦åè¯¥æç»ç­ç¥æ¶ï¼åªè¦çº¿ç¨æ± è¿æ²¡æå³é­ï¼å°±ä½¿ç¨ è°ç¨è¿ä¸ªæç»ç­ç¥ççº¿ç¨æ¥æ§è¡ä»»å¡ãä¸è¬å¹¶åæ¯è¾å°ï¼æ§è½è¦æ±ä¸é«ï¼ä¸åè®¸å¤±è´¥ãä½æ¯æ¯è°ç¨èèªå·±æ§è¡ä»»å¡ï¼å¦æå¹¶åæ¯è¾é«ä¼äº§çé»å¡ã\n    \n    public static class callerrunspolicy implements rejectedexecutionhandler {\n    \n        public void rejectedexecution(runnable r, threadpoolexecutor e) {\n            // å¦æçº¿ç¨æ± è¿æ²¡åæ­¢ï¼å°±ä½¿ç¨å½åçº¿ç¨æ§è¡ä»»å¡\n            if (!e.isshutdown()) {\n                r.run();\n            }\n        }\n    }\n    \n\n 3. discardpolicy ï¼ç´æ¥ä¸¢å¼ï¼è¿å¼å¸¸é½ä¸æã\n    \n    public static class discardpolicy implements rejectedexecutionhandler {\n    \n        // æ¹æ³çå®ç°ä¸è¡é½æ²¡æ...\n        public void rejectedexecution(runnable r, threadpoolexecutor e) {\n        }\n    }\n    \n\n 4. discardoldestpolicy ï¼ä¸¢å¼éåæèçä»»å¡ï¼å°è¯¥ä»»å¡æ·»å è¿å»ã\n    \n    å½è§¦åè¯¥æç»ç­ç¥æ¶ï¼åªè¦çº¿ç¨æ± è¿æªå³é­ï¼ä¸¢å¼é»å¡éåä¸­æèçä¸ä¸ªä»»å¡ï¼ä¹å°±æ¯éå¤´ä»»å¡ï¼ï¼å¹¶å°æ°ä»»å¡å å¥éåå°¾é¨ã\n    \n    public static class discardoldestpolicy implements rejectedexecutionhandler {\n         \n        public void rejectedexecution(runnable r, threadpoolexecutor e) {\n            if (!e.isshutdown()) {\n                // ç±äºéåæ¯fifoï¼é£ä¹pollåºæ¥çä¸å®æ¯éå¤´åç´ ï¼ä¹å°±æ¯éåä¸­æèçä»»å¡ã\n                e.getqueue().poll();\n                e.execute(r);\n            }\n        }\n    }\n    \n\n\n# 7. executors\n\næ¯æ¬¡åå»ºçº¿ç¨æ± é½è¦å¡«7ä¸ªåæ°å¤ªéº»ç¦äºï¼æä»¥javaä¸ºæä»¬æä¾äºå·¥å·ç±» ï¼executorsã\n\nç®åä»ç»ä¸ä¸ä½¿ç¨è¿ä¸ªexecutorså¯ä»¥åå»ºä»ä¹æ ·ççº¿ç¨æ± ï¼\n\n 1. newsinglethreadexecutor()\n    \n    åçº¿ç¨ççº¿ç¨æ± ï¼æ ¸å¿çº¿ç¨æ°ä¸º1ï¼æå¤§çº¿ç¨æ°ä¸º1ï¼ä½¿ç¨é¾è¡¨å®ç°çé»å¡éåï¼ç¸å½äºè¿ä¸ªçº¿ç¨ä¸­åªæä¸ä¸ªçº¿ç¨å¨å·¥ä½ãå¤ä½çä»»å¡å¨é¨æè¿é»å¡éåä¸­ãå°±ååçº¿ç¨å¨ä¸²è¡æ§è¡ä»»å¡ä¸æ ·ï¼ä½æ¯ä¹æäºåºå« ï¼å¦æè¿ä¸ªå¯ä¸ççº¿ç¨åºç°äºå¼å¸¸ï¼çº¿ç¨æ± ä¼åå»ºä¸ä¸ªæ°ççº¿ç¨æ¥ä»£æ¿å®ã\n    \n    public static executorservice newsinglethreadexecutor() {\n        return new finalizabledelegatedexecutorservice\n            (new threadpoolexecutor(1, 1,\n                                    0l, timeunit.milliseconds,\n                                    new linkedblockingqueue<runnable>()));\n    }\n    \n\n 2. newfixedthreadpool(nthreads, threadfactory)\n    \n    æ ¸å¿çº¿ç¨æ°åæå¤§çº¿ç¨æ°é½ç±å¼åèæå®ï¼å¨é¨çº¿ç¨é½å¤äºæ´»è·ç¶æï¼ä¸ä¼æ­»äº¡ï¼ï¼ä½¿ç¨é¾è¡¨å®ç°çé»å¡éåãä¸æ¦æä¸ªçº¿ç¨åºç°å¼å¸¸ï¼çº¿ç¨æ± ä¼è¡¥åä¸ä¸ªçº¿ç¨ãæäº¤å°çº¿ç¨æ± çä»»å¡è¿å¤å¯è½ä¼å¯¼è´åå­æº¢åºã\n    \n    public static executorservice newfixedthreadpool(int nthreads, \n                                                     threadfactory threadfactory) {\n        return new threadpoolexecutor(nthreads, nthreads,\n                                      0l, timeunit.milliseconds,\n                                      new linkedblockingqueue<runnable>(),\n                                      threadfactory);\n    }\n    \n\n 3. newcachedthreadpool()\n    \n    å¯ç¼å­ççº¿ç¨æ± ï¼æ ¸å¿çº¿ç¨æ°ä¸º0ï¼å½çº¿ç¨æ± ä¸­ççº¿ç¨æ°éè¶è¿äºè¿è¡ä»»å¡æéè¦ççº¿ç¨æ°ï¼é£ä¹å¯ä»¥åæ¶ç©ºé²ççº¿ç¨ï¼é»è®¤æ¯60såæ¶ï¼åæ¶å½ä»»å¡å¢å çæ¶åï¼çº¿ç¨æ± åå¯ä»¥åå»ºæ°ççº¿ç¨æ¥å¤çä»»å¡ã\n    \n    public static executorservice newcachedthreadpool() {\n        return new threadpoolexecutor(0, integer.max_value,\n                                      60l, timeunit.seconds,\n                                      new synchronousqueue<runnable>());\n    }\n    \n\n> éè¦æ³¨æçæ¯ ï¼ä¸å»ºè®®ä½¿ç¨è¿å ä¸ªå·²æççº¿ç¨æ± ï¼å»ºè®®èªå·±æ ¹æ®ä»»å¡çç¹ç¹ï¼ioå¯éãcpuå¯éï¼æ¥åå»ºçº¿ç¨æ± ã\n\n\n# 8. çº¿ç¨æ± åæ°çéç½®\n\nçº¿ç¨æ± æ7ä¸ªåæ°ï¼é£è¯¥å¦ä½éç½®å®ä»¬ä½¿å¾å©çæå¤§åå¢ï¼\nè¿è¦ççº¿ç¨æ± éè¦æ§è¡çä»»å¡æ¯cpuå¯éåè¿æ¯ioå¯éåã\n\n 1. cpuå¯éå ï¼ä»»å¡ä¸­å«æå¤§éçè®¡ç®ï¼ä¾å¦ä¸è§å½æ°ãä½è¿ç®ãåå¨çè®¡ç®.... cpuå¯éåä¹å«è®¡ç®å¯éå\n 2. ioå¯éå ï¼ä»»å¡ä¸­å«æå¤§éçioæä½ãä¾å¦ï¼è¯»åæä»¶ãè®¿é®æ°æ®åºãä½¿ç¨ä¸­é´ä»¶...\n\nä¸ççä¸äºçº¿ç¨æ± åæ°éç½®æ¹æ¡ï¼ è½ç¶æ¹æ¡å¾å¤ï¼ä½æ¯æä»¬å¹¶æ²¡æå¾åºéç¨ççº¿ç¨æ± è®¡ç®æ¹å¼ãå¹¶åä»»å¡çæ§è¡æåµåä»»å¡ç±»åç¸å³ï¼ioå¯éååcpuå¯éåçä»»å¡è¿è¡èµ·æ¥çæåµå·®å¼éå¸¸å¤§ï¼ ä½è¿ç§å æ¯æ¯è¾é¾åçé¢ä¼°çï¼è¿å¯¼è´å¾é¾æä¸ä¸ªç®åææçéç¨å¬å¼å¸®æä»¬ç´æ¥è®¡ç®åºç»æã\n\næè\n\næ¢ç¶ä¸è½å¤ä¿è¯ä¸æ¬¡è®¡ç®åºæ¥åéçåæ°ï¼é£ä¹æ¯å¦å¯ä»¥å°ä¿®æ¹çº¿ç¨æ± åæ°çææ¬éä¸æ¥ï¼è¿æ ·è³å°å¯ä»¥åçæéçæ¶åå¯ä»¥å¿«éè°æ´ä»èç¼©ç­æéæ¢å¤çæ¶é´å¢ï¼\nåºäºè¿ä¸ªæèï¼æ¯å¦å¯ä»¥å°çº¿ç¨æ± çåæ°ä»ä»£ç ä¸­è¿ç§»å°åå¸å¼éç½®ä¸­å¿ä¸ï¼å®ç°çº¿ç¨æ± åæ°å¯å¨æéç½®åå³æ¶çæ\n\nè¿å°±æ¯å¨æçº¿ç¨æ± çç±æ¥ãä»ä¹ï¼å¦ä½å®ç°ï¼æä¸ä¼ï¼åèç¾å¢å¼æºé¡¹ç® dynamictp ï¼ç¾å¢å¨æçº¿ç¨æ± å®è·µæè·¯',charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"CAS",frontmatter:{title:"CAS",date:"2023-07-17T02:01:44.000Z",permalink:"/pages/56d8fa/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/50.CAS.html",relativePath:"02.æç« /75.Javaå¹¶å/50.CAS.md",key:"v-040c55f4",path:"/pages/56d8fa/",headers:[{level:2,title:"1. ä»ä¹æ¯CAS",slug:"_1-ä»ä¹æ¯cas",normalizedTitle:"1. ä»ä¹æ¯cas",charIndex:2},{level:2,title:"2. CAS å¦ä½å®ç°",slug:"_2-cas-å¦ä½å®ç°",normalizedTitle:"2. cas å¦ä½å®ç°",charIndex:457},{level:2,title:"3. ABAé®é¢",slug:"_3-abaé®é¢",normalizedTitle:"3. abaé®é¢",charIndex:1002}],headersStr:"1. ä»ä¹æ¯CAS 2. CAS å¦ä½å®ç° 3. ABAé®é¢",content:"# 1. ä»ä¹æ¯CAS\n\nCASï¼å¨ç§° Compare and Swapï¼æ¯å®ç°å¹¶åç®æ³æ¶å¸¸ç¨å°çä¸ç§ææ¯ã\n\nå®åå«äºä¸ä¸ªæä½æ°ï¼\n\n * åå­ä½ç½®\n * é¢æåå¼\n * æ´æ°å¼\n\nä¹å°±æ¯ ï¼æ¯è¾åå­ä¸­çå¼è·é¢æçæ§å¼æ¯å¦ç¸åï¼å¦æç¸åå°±äº¤æ¢ï¼ä¸åå°±ä¸äº¤æ¢ã\n\nä½¿ç¨Cè¹æ¥å®ç°å°±æ¯è¿æ ·çï¼\n\nbool compareAndSwap(int* address, int oldValue, int newValue) {\n    if (*address == oldValue) {\n        *address = newValue;\n    }\n}\n\n\nCASæ¯ä¹è§éçå¶ä¸­ä¸ç§ï¼å¯ä»¥éè¿ while(true)éåCASæ¥å®ç°ä¹è§éï¼\n\nfor (;;) {\n    bool result = compareAndSwap(&a, oldValue, newValue);\n    // å¦ææ¹å¤±è´¥äºæèæ¹æåäºä¹åçä¸å¡é»è¾....\n    if (result) {\n    } \n}\n\n\n\n# 2. CAS å¦ä½å®ç°\n\njava ç CAS å©ç¨ççæ¯ Unsafe è¿ä¸ªç±»æä¾ç CAS æä½ï¼ç®èè¨ä¹ï¼æ¯å ä¸ºç¡¬ä»¶äºä»¥äºæ¯æï¼è½¯ä»¶å±é¢æè½åå°ã\n\næå°è¯å¨Javaæºç ä¸­æ¾å°å¯¹äºcompareAndSwapçå®ç°ï¼åç°ä¸è¿æ¯å¾å³~ å ä¸ºæ¯cè¹åç~\n\nå¦ä¸æ¯å¨ Unsafeç±» ä¸­å®ä¹çé¨åæ¹æ³ï¼\n\n// var1 : è¦æä½çå¯¹è±¡\n// var2 : è¦æä½çåéçå°å\n// var4 : æ§å¼\n// var5 : æ°å¼\npublic final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5);\n\npublic final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);\n\npublic final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6);\n\n\nå½ç¶äºï¼Unsafe ç±»ä¸ä»å¯ä»¥ä½¿ç¨CASæä½ï¼è¿å¯ä»¥æä½åå­...\n\n\n# 3. ABAé®é¢\n\nCASå¥½ç¨ï¼ä½æ¯ä¼é æABAé®é¢ãä»ä¹æ¯ABAé®é¢ï¼\n\nåè®¾å­å¨ä¸¤ä¸ªçº¿ç¨ t1 å t2ã æä¸ä¸ªå±äº«åé numï¼åå§å¼ä¸º A æ¥ä¸æ¥ï¼ çº¿ç¨ t1 æ³ä½¿ç¨ CAS æ num å¼æ¹æ Z, é£ä¹å°±éè¦\n\n * åè¯»å num çå¼, è®°å½å° oldNum åéä¸­\n * ä½¿ç¨ CAS å¤å®å½å num çå¼æ¯å¦ä¸º Aï¼ å¦æä¸º Aï¼å°±ä¿®æ¹æ Z.\n\nä½æ¯ï¼ å¨ t1 æ§è¡è¿ä¸¤ä¸ªæä½ä¹é´ï¼ t2 çº¿ç¨å¯è½æ num çå¼ä» A æ¹æäº Bï¼ åä» B æ¹æäº A å°è¿ä¸æ­¥, t1 çº¿ç¨æ æ³åºåå½åè¿ä¸ªåéå§ç»æ¯ Aï¼ è¿æ¯ç»åäºä¸ä¸ªååè¿ç¨ã\n\nå¶å®è¿æ ·çè¿è¡è¿ç¨å¨ä»£ç ä¸æ²¡æéï¼ä½æ¯çº¿ç¨ t1 è¯å®æ³è¦èªå·±çæä½æ¯åå­çï¼å¨æä½æ¶æ²¡æå¶ä»çº¿ç¨æ¹æ¥æ¹å»ãè¿å°±å¥½æ¯ï¼æä»¬ä¹°ä¸ä¸ªææºï¼æ æ³å¤å®è¿ä¸ªææºæ¯ååºåçæ°ææºï¼è¿æ¯å«äººç¨æ§äºåç¿»æ°è¿çææºã\n\næä¹è§£å³ CAS é®é¢å¢ï¼\n\nabaçå³é®æ¯å¼ä¼åå¤æ¨ªè·³~~å¦æçº¦å®æ°æ®åªè½åæ¹åååï¼é®é¢å°±è¿åèè§£äºï¼åªè½å¢å ï¼æèåªè½åå°ï¼\n\nå¦æéæ±è¦æ±è¯¥æ°å¼ï¼æ¢è½å¢å ä¹è½åå°ï¼åºè¯¥æä¹åï¼å¯ä»¥å¼å¥å¦å¤ä¸ä¸ªçæ¬å·åéï¼çº¦å®çæ¬å·åªè½å¢å ~~\n\næ¯æ¬¡CASå¯¹æ¯çæ¶åï¼å°±ä¸æ¯å¯¹æ¯æ°å¼æ¬èº«ï¼èæ¯å¯¹æ¯çæ¬å·ï¼ï¼\n\nå¨ CAS æ¯è¾æ°æ®å½åå¼åæ§å¼çåæ¶, ä¹è¦æ¯è¾çæ¬å·æ¯å¦ç¬¦åé¢æ",normalizedContent:"# 1. ä»ä¹æ¯cas\n\ncasï¼å¨ç§° compare and swapï¼æ¯å®ç°å¹¶åç®æ³æ¶å¸¸ç¨å°çä¸ç§ææ¯ã\n\nå®åå«äºä¸ä¸ªæä½æ°ï¼\n\n * åå­ä½ç½®\n * é¢æåå¼\n * æ´æ°å¼\n\nä¹å°±æ¯ ï¼æ¯è¾åå­ä¸­çå¼è·é¢æçæ§å¼æ¯å¦ç¸åï¼å¦æç¸åå°±äº¤æ¢ï¼ä¸åå°±ä¸äº¤æ¢ã\n\nä½¿ç¨cè¹æ¥å®ç°å°±æ¯è¿æ ·çï¼\n\nbool compareandswap(int* address, int oldvalue, int newvalue) {\n    if (*address == oldvalue) {\n        *address = newvalue;\n    }\n}\n\n\ncasæ¯ä¹è§éçå¶ä¸­ä¸ç§ï¼å¯ä»¥éè¿ while(true)éåcasæ¥å®ç°ä¹è§éï¼\n\nfor (;;) {\n    bool result = compareandswap(&a, oldvalue, newvalue);\n    // å¦ææ¹å¤±è´¥äºæèæ¹æåäºä¹åçä¸å¡é»è¾....\n    if (result) {\n    } \n}\n\n\n\n# 2. cas å¦ä½å®ç°\n\njava ç cas å©ç¨ççæ¯ unsafe è¿ä¸ªç±»æä¾ç cas æä½ï¼ç®èè¨ä¹ï¼æ¯å ä¸ºç¡¬ä»¶äºä»¥äºæ¯æï¼è½¯ä»¶å±é¢æè½åå°ã\n\næå°è¯å¨javaæºç ä¸­æ¾å°å¯¹äºcompareandswapçå®ç°ï¼åç°ä¸è¿æ¯å¾å³~ å ä¸ºæ¯cè¹åç~\n\nå¦ä¸æ¯å¨ unsafeç±» ä¸­å®ä¹çé¨åæ¹æ³ï¼\n\n// var1 : è¦æä½çå¯¹è±¡\n// var2 : è¦æä½çåéçå°å\n// var4 : æ§å¼\n// var5 : æ°å¼\npublic final native boolean compareandswapobject(object var1, long var2, object var4, object var5);\n\npublic final native boolean compareandswapint(object var1, long var2, int var4, int var5);\n\npublic final native boolean compareandswaplong(object var1, long var2, long var4, long var6);\n\n\nå½ç¶äºï¼unsafe ç±»ä¸ä»å¯ä»¥ä½¿ç¨casæä½ï¼è¿å¯ä»¥æä½åå­...\n\n\n# 3. abaé®é¢\n\ncaså¥½ç¨ï¼ä½æ¯ä¼é æabaé®é¢ãä»ä¹æ¯abaé®é¢ï¼\n\nåè®¾å­å¨ä¸¤ä¸ªçº¿ç¨ t1 å t2ã æä¸ä¸ªå±äº«åé numï¼åå§å¼ä¸º a æ¥ä¸æ¥ï¼ çº¿ç¨ t1 æ³ä½¿ç¨ cas æ num å¼æ¹æ z, é£ä¹å°±éè¦\n\n * åè¯»å num çå¼, è®°å½å° oldnum åéä¸­\n * ä½¿ç¨ cas å¤å®å½å num çå¼æ¯å¦ä¸º aï¼ å¦æä¸º aï¼å°±ä¿®æ¹æ z.\n\nä½æ¯ï¼ å¨ t1 æ§è¡è¿ä¸¤ä¸ªæä½ä¹é´ï¼ t2 çº¿ç¨å¯è½æ num çå¼ä» a æ¹æäº bï¼ åä» b æ¹æäº a å°è¿ä¸æ­¥, t1 çº¿ç¨æ æ³åºåå½åè¿ä¸ªåéå§ç»æ¯ aï¼ è¿æ¯ç»åäºä¸ä¸ªååè¿ç¨ã\n\nå¶å®è¿æ ·çè¿è¡è¿ç¨å¨ä»£ç ä¸æ²¡æéï¼ä½æ¯çº¿ç¨ t1 è¯å®æ³è¦èªå·±çæä½æ¯åå­çï¼å¨æä½æ¶æ²¡æå¶ä»çº¿ç¨æ¹æ¥æ¹å»ãè¿å°±å¥½æ¯ï¼æä»¬ä¹°ä¸ä¸ªææºï¼æ æ³å¤å®è¿ä¸ªææºæ¯ååºåçæ°ææºï¼è¿æ¯å«äººç¨æ§äºåç¿»æ°è¿çææºã\n\næä¹è§£å³ cas é®é¢å¢ï¼\n\nabaçå³é®æ¯å¼ä¼åå¤æ¨ªè·³~~å¦æçº¦å®æ°æ®åªè½åæ¹åååï¼é®é¢å°±è¿åèè§£äºï¼åªè½å¢å ï¼æèåªè½åå°ï¼\n\nå¦æéæ±è¦æ±è¯¥æ°å¼ï¼æ¢è½å¢å ä¹è½åå°ï¼åºè¯¥æä¹åï¼å¯ä»¥å¼å¥å¦å¤ä¸ä¸ªçæ¬å·åéï¼çº¦å®çæ¬å·åªè½å¢å ~~\n\næ¯æ¬¡caså¯¹æ¯çæ¶åï¼å°±ä¸æ¯å¯¹æ¯æ°å¼æ¬èº«ï¼èæ¯å¯¹æ¯çæ¬å·ï¼ï¼\n\nå¨ cas æ¯è¾æ°æ®å½åå¼åæ§å¼çåæ¶, ä¹è¦æ¯è¾çæ¬å·æ¯å¦ç¬¦åé¢æ",charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"çº¿ç¨æ± æºç è§£æ",frontmatter:{title:"çº¿ç¨æ± æºç è§£æ",date:"2024-01-21T21:31:55.000Z",permalink:"/pages/79cb1d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/400.%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html",relativePath:"02.æç« /75.Javaå¹¶å/400.çº¿ç¨æ± æºç è§£æ.md",key:"v-9062bd3c",path:"/pages/79cb1d/",headers:[{level:2,title:"1. Worker",slug:"_1-worker",normalizedTitle:"1. worker",charIndex:2},{level:3,title:"1.1 Worker çä¸å¯éå¥é",slug:"_1-1-worker-çä¸å¯éå¥é",normalizedTitle:"1.1 worker çä¸å¯éå¥é",charIndex:559},{level:3,title:"1.2 Worker.run()",slug:"_1-2-worker-run",normalizedTitle:"1.2 worker.run()",charIndex:1409},{level:2,title:"2. ThreadPoolExecutor",slug:"_2-threadpoolexecutor",normalizedTitle:"2. threadpoolexecutor",charIndex:5428},{level:3,title:"2.1 çº¿ç¨æ± åé",slug:"_2-1-çº¿ç¨æ± åé",normalizedTitle:"2.1 çº¿ç¨æ± åé",charIndex:5571},{level:3,title:"2.2 execute",slug:"_2-2-execute",normalizedTitle:"2.2 execute",charIndex:8249},{level:3,title:"2.3 shutdown",slug:"_2-3-shutdown",normalizedTitle:"2.3 shutdown",charIndex:11374},{level:3,title:"2.4 shutdownNow",slug:"_2-4-shutdownnow",normalizedTitle:"2.4 shutdownnow",charIndex:12226},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:12570}],headersStr:"1. Worker 1.1 Worker çä¸å¯éå¥é 1.2 Worker.run() 2. ThreadPoolExecutor 2.1 çº¿ç¨æ± åé 2.2 execute 2.3 shutdown 2.4 shutdownNow 3. æ»ç»",content:'# 1. Worker\n\nWorker æ¯çº¿ç¨å¨çº¿ç¨æ± ä¸­çè¡¨ç°å½¢å¼ï¼å®å¹¶ä¸æ¯ä¸ä¸ªçº¿ç¨ï¼Worker ç»§æ¿äº Runnableï¼å¯ä»¥ä½¿ç¨çº¿ç¨å·¥åæ ¹æ® Worker åå»ºä¸ä¸ªçº¿ç¨\n\nthreadFactory.newThread(worker);\n\n\næ¥çç Worker ä¸­çåéï¼\n\n// Worker ç»§æ¿ AQS å®ç°äºä¸å¯éå¥é\nprivate final class Worker extends AbstractQueuedSynchronizer implements Runnable {\n\t// è¿ä¸ª Worker å°è£ççº¿ç¨\n    final Thread thread;\n    \n\t// è¿ä¸ª Worker çä»»å¡\n    Runnable firstTask;\n\t\n    // è¿ä¸ªçº¿ç¨æ§è¡è¿çä»»å¡æ°é\n    volatile long completedTasks;\n}\n\n\nå¯ä»¥çå° Worker ä¸ä»ç»§æ¿äº Runnableï¼è¿ç»§æ¿äº AQSï¼å®ç»§æ¿ AQS æ¯ä¸ºäºå®ç°ä¸å¯éå¥éï¼ä¸é¢ä¼å·ä½ä»ç»Worker çä¸å¯éå¥éã\n\nå¼å¾ä¸æçæ¯ï¼è½ç¶æä»¬å¹³æ¶ä½¿ç¨çº¿ç¨æ± æ¶ä¼æå® æ ¸å¿çº¿ç¨æ°ãæå¤§çº¿ç¨æ°ï¼ä½æ¯çº¿ç¨è¢«å°è£ä¸º Worker æ¶ä¸ä¼åºåè¿ä¸ªçº¿ç¨æ¯æ ¸å¿çº¿ç¨è¿æ¯ä¸´æ¶çº¿ç¨ã\n\n\n# 1.1 Worker çä¸å¯éå¥é\n\nå¦æä½ å¯¹ AQS ä¸çè§£æä¸çæï¼å¯ä»¥éè¯»ä¸ä¸æçå¦ä¸ç¯æç«  ï¼AQSæºç è§£æ\n\nWorker å®ç°çæ¯ä¸å¯éå¥éï¼ä¸å¯éå¥éå®ç°èµ·æ¥æ¯è¾ç®å ï¼\n\nprotected boolean tryAcquire(int unused) {\n    if (compareAndSetState(0, 1)) {\n        setExclusiveOwnerThread(Thread.currentThread());\n        return true;\n    }\n    return false;\n}\n\n\n * å¯éå¥é ï¼å¦æéå·²ç»è¢«å æï¼è¿è¦å¤æ­å æéççº¿ç¨æ¯å¦æ¯èªå·±ã\n * ä¸å¯éå¥é ï¼å¦æéå·²ç»è¢«å æï¼ä¸åå¤æ­ç´æ¥è¿åå éå¤±è´¥ã\n\nWorker çå éé»è¾æ¯å° state å¼ä» 0 æ¹ä¸º 1ï¼å¦ææåå°±è¿å trueï¼å¦æå¤±è´¥å°±è¿å falseã\n\nä½æ¯ Worker ä¸ºä»ä¹è¦å éåè½å¢ ï¼\n\nçº¿ç¨æ± æä¸ä¸ªæ¹æ³ ï¼shutdown() ï¼å°±æ¯è¦åæ­¢ææççº¿ç¨ï¼ä½æ¯å¦æè¯¥çº¿ç¨æ­£å¨æ§è¡ä»»å¡ï¼åç­å¾å®æ§è¡ç»æåå³é­å®ã\n\nWorker å¨æ§è¡ä»»å¡æ¶è¦å éï¼æ§è¡ç»ææ¶è§£éï¼çº¿ç¨æ± åæ­¢çº¿ç¨æ¶ä¹å éï¼å¦æå éæåå°±çæå³é­è¯¥çº¿ç¨ã\n\nè¿æ ·å°±å¯ä»¥é¿åçº¿ç¨æ± å°æ­£å¨æ§è¡ä»»å¡ççº¿ç¨ç»å³é­äºã\n\nå¶å®çº¿ç¨æ± è¿æä¸ä¸ªæ¹æ³ ï¼shutdownNow()ï¼å®å¯ä¸ç®¡çº¿ç¨æ¯å¦æ­£å¨æ§è¡ï¼ç´æ¥å³é­ã\n\né£ä¹ shutdown å shutdownNow æ¹æ³å·¥ä½çåºå«å°±æ¯ ï¼\n\n 1. shutdown() ï¼å³é­çº¿ç¨æ± ä¸­çææçº¿ç¨ãå¦æçº¿ç¨æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æã\n    \n    éåææ Workerï¼è°ç¨ worker.tryLock() å¦ææ¢éå¤±è´¥è¯´æè¿ä¸ª Worker æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æååå³é­ã\n\n 2. shutdownNow() ï¼å³é­çº¿ç¨æ± ä¸­çææçº¿ç¨\n    \n    éåææ Workerï¼ç´æ¥å³é­ã\n\n\n# 1.2 Worker.run()\n\nWorker æ¯ä¸ä¸ªçº¿ç¨ï¼é£æä»¬å°±ç»ä¸å¼å®ç run() æ¹æ³ï¼å¨è¿éå¯ä»¥çæµä¸ä¸ Worker.run() çé»è¾ï¼\n\n 1. å¾ªç¯ä»é»å¡éåä¸­åä»»å¡\n 2. å¦æè¶æ¶ï¼å¤æ­æ¯å¦ç»æ­¢å¾ªç¯ï¼ç»æ­¢å¾ªç¯å®éä¸è¿ä¸ªçº¿ç¨å°±æ§è¡ç»æäºï¼ç¸å½äºçº¿ç¨æ­»äº¡ã\n 3. ä»ä¹æ¶åç»æ­¢å¾ªç¯ ï¼å¦æå½åçº¿ç¨æ± ä¸­ççº¿ç¨æ°é < æ ¸å¿çº¿ç¨æ°ï¼é£æä»¬ä¸è½è®©çº¿ç¨ç»æ­¢ã\n\nç¶åå¯ä»¥çä¸ä¸æºç ï¼ççåæä»¬çæµçæ¯å¦æå·®å¼ ï¼\n\n// Worker çº¿ç¨ä¸å¯å¨å°±ä¼è°ç¨ runWorker æ¹æ³ï¼runWorker æ¹æ³å¨ ThreadPoolExecutor ä¸­\npublic void run() {\n    runWorker(this);\n}\n\n\nç±äº Worker æ¯ ThreadPoolExecutor çåé¨ç±»ï¼æä»¥ Worker.run() çé»è¾æ¯ç± ThreadPoolExecutor.runWorker() æ¥å®ç°çã\n\nçº¿ç¨æ± éé¢ççº¿ç¨å¶å®åçæ éå°±æ¯ä¸¤ä»¶äº ï¼è·åä»»å¡ãæ§è¡ä»»å¡ã\n\n 1. è·åä»»å¡ï¼è·åä»»å¡æä¸¤ç§éå¾\n    * åå»º Worker æ¶æå®å¥½çï¼è¿ä¸ªåªæç¬¬ä¸æ¬¡å¾ªç¯å¯è½æ¿å°\n    * ä»é»å¡éåä¸­è·åçï¼ä½æ¯é»å¡éåä¸­ä¸ä¸å®æï¼å¤æ­çº¿ç¨è½å¦æ­»äº¡çé»è¾ä¹æ¯å¨è¿éåçã\n 2. æ§è¡ä»»å¡\n\n// å·¥ä½çº¿ç¨å¯å¨åå°±ä¼æ§è¡è¿ä¸ªæ¹æ³\nfinal void runWorker(Worker w) {\n    // æ¿å°å½åçº¿ç¨ï¼ç±äºç°å¨è¿è¡è¿ä¸ªæ¹æ³çæ¯ worker.run()ï¼æä»¥å½åçº¿ç¨å®éä¸å°±æ¯ worker.thread\n    Thread wt = Thread.currentThread();\n    // æ¿å°è¯¥çº¿ç¨ç task\n    Runnable task = w.firstTask;\n    // å·²ç»æä»»å¡æ¿åºæ¥äºï¼å°å¶ç½®ç©º\n    w.firstTask = null;\n    // éæ¾é--------å­ç, è¿éææ²¡ææä¸ºå¥è¦éæ¾éã\n    w.unlock(); \n    // è¿è¡è¿ç¨ä¸­æ¯å¦åºç°äºå¼å¸¸\n    boolean completedAbruptly = true;\n    try {\n        // ç¬¬ä¸æ¬¡è¿è¡æ¶ task != nullï¼ä¸ä¼æ§è¡ task.getTask() çé»è¾\n        // ç¬¬äºæ¬¡è¿è¡æ¶ task == nullï¼ä¼è°ç¨ task.getTask() ä»é»å¡éåä¸­è·åä»»å¡\n        // æ³¨æï¼è¿éç getTask å¦æè·åå°äº nullï¼å¾ªç¯å°±ä¼ç»æï¼è¯¥çº¿ç¨å°±ä¼ç»æ­¢\n        while (task != null || (task = getTask()) != null) {\n            // å éï¼è¡¨ç¤ºè¯¥çº¿ç¨æ­£å¨è¿è¡ä»»å¡ï¼ä¸åè®¸ææ­\n            w.lock();\n            try {\n                // ç±ç¨åºåå®ç°çé»è¾, é©å­å½æ°\n                beforeExecute(wt, task);\n                // å¯è½ä¼æåºçå¼å¸¸\n                Throwable thrown = null;\n                // æ§è¡è¯¥ä»»å¡\n                task.run();\n                \n            } finally {\n                task = null;\n                w.completedTasks++;\n                w.unlock();\n            }\n        }\n        completedAbruptly = false;\n    } finally {\n        // çº¿ç¨éåºï¼ä¹å°±æ¯æä»¬å´éç"çº¿ç¨æ­»äº¡"\n        processWorkerExit(w, completedAbruptly);\n    }\n}\n\n\nä¸é¢çä¸ä¸ getTask() æ¹æ³ï¼è¿ä¸ªæ¹æ³ç¹å«éè¦ï¼å®ä¼å¤æ­è¿ä¸ªçº¿ç¨æ¯å¦æèµæ ¼æ­»äº¡ï¼ç»åä¸é¢ runWorker çä»£ç æ¥çï¼åªè¦ getTask() è¿å nullï¼è¿ä¸ªçº¿ç¨å°±ç®æ­»äºã\n\næä»¬å¯ä»¥å¤§æ¦æ³ä¸ä¸çº¿ç¨å¯ä»¥æ­»äº¡çæ¡ä»¶ï¼\n\n 1. ä¸åè®¸æ ¸å¿çº¿ç¨æ­»äº¡æ¶ ï¼\n    \n    å½çº¿ç¨æ°é > æ ¸å¿çº¿ç¨æ°ï¼ä¹å°±æ¯æä¸´æ¶çº¿ç¨ï¼ä»é»å¡éåä¸­åæ°æ®è¶æ¶äºï¼ä¹å°±æ¯éåä¸­æ²¡æä»»å¡ï¼é£ä¹æ­¤çº¿ç¨å¯ä»¥æ­»äº¡ã\n    \n    æ³¨æ ï¼ä»é»å¡éåä¸­åæ°æ® è¿ä¸ªæä½çæç»­æ¶é´ == ä¸´æ¶çº¿ç¨çæ­»äº¡æ¶é´ã\n\n 2. åè®¸æ ¸å¿çº¿ç¨æ­»äº¡æ¶ ï¼\n    \n    çº¿ç¨æ°é < æå¤§çº¿ç¨æ°ï¼ä»éåä¸­åä»»å¡è¶æ¶ï¼å¹¶ä¸éåä¸­æ²¡æä»»å¡ã\n\næºç ä¸­çå¤æ­é»è¾æ¯è¾é¾æ ï¼\n\nprivate Runnable getTask() {\n    // é»å¡è·åä»»å¡æ¯å¦è¶æ¶\n    boolean timedOut = false; \n    for (;;) {\n        int c = ctl.get();\n        // è·åçº¿ç¨æ± çç¶æ\n        int rs = runStateOf(c);\n        // rs >= SHUTDOWNé½ä¸æ­£å¸¸ã\n        // å¦æçº¿ç¨æ± å·²ç»è°ç¨äº threadPool.shutdown()ï¼ç¬¦åä¸åæ¡ä»¶ä¸­çä»»ä½ä¸ä¸ªé½ä¼è¿ånull\n        // 1. çº¿ç¨æ± çç¶æ >= STOPï¼ä¸åå¤çææ¥æ¶ä»»å¡\n        // 2. ä»»å¡éåä¸ºç©ºï¼å·²ç»å¤çå®äº\n        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {\n            decrementWorkerCount();\n            return null;\n        }\n        \n\t\t// è·åçº¿ç¨æ± ä¸­ççº¿ç¨æ°é\n        int wc = workerCountOf(c);\n\n\t\t// ä»¥ä¸çå¤æ­æ¯å³å®æ­¤çº¿ç¨æ¯å¦è¦æ­»äº¡\n        // çº¿ç¨æ­»äº¡çæ¡ä»¶:\n        // 1. ä¸åè®¸æ ¸å¿çº¿ç¨æ­»äº¡ : \n        //     æ ¸å¿çº¿ç¨æ° < çº¿ç¨æ°é < æå¤§çº¿ç¨æ°ï¼å¹¶ä¸ä»éåä¸­åä»»å¡è¶æ¶ï¼å¹¶ä¸éåä¸­æ²¡æä»»å¡\n        // 2. åè®¸æ ¸å¿çº¿ç¨æ­»äº¡ : çº¿ç¨æ°é < æå¤§çº¿ç¨æ°ï¼ä»éåä¸­åä»»å¡è¶æ¶ï¼å¹¶ä¸éåä¸­æ²¡æä»»å¡\n        // 3. çº¿ç¨æ°é > æå¤§çº¿ç¨æ°\n        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\n        if ((wc > maximumPoolSize || (timed && timedOut))\n            && (wc > 1 || workQueue.isEmpty())) {\n            if (compareAndDecrementWorkerCount(c))\n                return null;\n            continue;\n        }\n\n        try {\n            // å¦æå¨è¿éåºç°ä¸­æ­å¼å¸¸ï¼å¯è½æ¯çº¿ç¨æ± è°ç¨äº shutdownï¼\n            // è¯¥çº¿ç¨ä¼è¿å¥ä¸ä¸ä¸ªå¾ªç¯å¹¶å¨ç¬¬ä¸ä¸ªifä¸­è¿å nullï¼è¾¾å°åæ­¢çº¿ç¨/ææ­»çº¿ç¨çç®æ ã\n            Runnable r = timed ?\n                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\n            workQueue.take();\n            if (r != null)\n                return r;\n            timedOut = true;\n        } catch (InterruptedException retry) {\n            timedOut = false;\n        }\n    }\n}\n\n\nè¿éé¢æä¸ªæææçå¤æ­é»è¾ ï¼\n\nboolean timed = allowCoreThreadTimeOut || wc > corePoolSize;\n\nRunnable r = timed ?\n    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :\nworkQueue.take();\n\n\nä¸è¬æåµä¸æä»¬ä¸ä¼åè®¸æ ¸å¿çº¿ç¨æ­»äº¡ï¼é£ä¹ timed è¿ä¸ªåéå°±åå³äºå½åçº¿ç¨çæ°éæ¯å¦å¤§äºæ ¸å¿çº¿ç¨çæ°éã\n\n 1. å¦æå¤§äºï¼è¯´ææ­¤æ¶æä¸´æ¶çº¿ç¨ï¼é£ä¹æ­¤çº¿ç¨çèº«ä»½å°±æ¯ä¸´æ¶çº¿ç¨ï¼åä»»å¡æ¶é»å¡ keepAliveTime è¿ä¹é¿æ¶é´ãå¦æé»å¡äº keepAliveTime è¿æ²¡ææ¿å°ä»»å¡ï¼å°±ä¼è¿å¥ä¸ä¸ä¸ªå¾ªç¯ï¼å¤æ­æ­¤çº¿ç¨æ¯å¦è¦æ­»äº¡ã\n\n 2. å¦æå°äºï¼è¯´ææ­¤æ¶æ²¡æä¸´æ¶çº¿ç¨ï¼é£ä¹æ­¤çº¿ç¨çèº«ä»½å°±æ¯æ ¸å¿çº¿ç¨ï¼åä»»å¡æ¶æ°¸ä¹é»å¡ã\n\nè³æ­¤ï¼Worker çæºç å°±è¯´å®äºï¼çº¿ç¨æ± ä¸­ççº¿ç¨å¹¶ä¸ä¼åºåæ ¸å¿çº¿ç¨ä¸ä¸´æ¶çº¿ç¨ï¼å®åªä¼ä¿è¯çº¿ç¨æ± ä¸­å§ç»æ corePoolSize ä¸ªçº¿ç¨ä¿ææ´»è·ã\n\n\n# 2. ThreadPoolExecutor\n\næºç å¤§æ¦æ 1000 å¤è¡ï¼æ ¹æ¬ä¸éè¦çå®ï¼éè¦æä¸¤ä¸ªæ¹æ³ ï¼\n\n 1. æäº¤ä»»å¡ execute ï¼å¨è¿éå¯ä»¥çå°çº¿ç¨æ± çå·¥ä½æµç¨ä»¥åçº¿ç¨çåå»ºè¿ç¨ã\n 2. å³é­çº¿ç¨æ±  shutdown ï¼å¨è¿éå¯ä»¥çå°çº¿ç¨æ± çä¸åå³é­é»è¾ã\n\n\n# 2.1 çº¿ç¨æ± åé\n\npublic class ThreadPoolExecutor extends AbstractExecutorService {\n    // çº¿ç¨æ± çç¶æåçº¿ç¨æ°é\n    // é«ä¸ä½è¡¨ç¤ºçº¿ç¨æ± çç¶æ\n    // ä½29ä½è¡¨ç¤ºçº¿ç¨æ± ä¸­ççº¿ç¨æ°é\n    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\n\n    private static final int COUNT_BITS = Integer.SIZE - 3;\n    // 1 << 29 = 00010000 00000000 00000000 00000000\n    // åå1 = 00001111 11111111 11111111 11111111\n    // ctl & CAPACITY å¯ä»¥å¾å°çº¿ç¨æ°é \n    private static final int CAPACITY   = (1 << COUNT_BITS) - 1;\n\n\t// çº¿ç¨æ± çäºç§ç¶æï¼å¨ ctl çé«ä¸ä½è¡¨ç¤º\n    // 111 00000 00000000 00000000 00000000\n    // æ­£å¨è¿è¡\t\t\n    private static final int RUNNING    = -1 << COUNT_BITS;\n    \n    // 000 00000 00000000 00000000 00000000\n    // å·²ç»è°ç¨äº shutdownï¼ä½æ¯éé¢ççº¿ç¨è¿æ²¡æåæ­¢\n    private static final int SHUTDOWN   =  0 << COUNT_BITS;\n    \n    // 001 00000 00000000 00000000 00000000\n    private static final int STOP       =  1 << COUNT_BITS;\n    // 010 00000 00000000 00000000 00000000\n    private static final int TIDYING    =  2 << COUNT_BITS;\n    // 011 00000 00000000 00000000 00000000\n    private static final int TERMINATED =  3 << COUNT_BITS;\n\n\t// ä¼ å¥ ctlï¼è¿åçº¿ç¨æ± çç¶æ\n    private static int runStateOf(int c)     { return c & ~CAPACITY; }\n    // ä¼ å¥ ctlï¼è¿åçº¿ç¨æ°é\n    private static int workerCountOf(int c)  { return c & CAPACITY; }\n    // ä¼ å¥çº¿ç¨æ± çç¶æåçº¿ç¨æ°éï¼è¿åctl\n    private static int ctlOf(int rs, int wc) { return rs | wc; }\n\n\n\n\t// CASçæ¹å¼å¢å å·¥ä½çº¿ç¨çæ°éï¼å¢å ä¸ä¸ª\n    private boolean compareAndIncrementWorkerCount(int expect) {\n        return ctl.compareAndSet(expect, expect + 1);\n    }\n\n\t// CASçæ¹å¼åå°å·¥ä½çº¿ç¨çæ°éï¼åå°ä¸ä¸ª\n    private boolean compareAndDecrementWorkerCount(int expect) {\n        return ctl.compareAndSet(expect, expect - 1);\n    }\n\n\n    // ä¿å­å·¥ä½çº¿ç¨çéå\n    private final HashSet<Worker> workers = new HashSet<Worker>();\n\n    \n   \t// çº¿ç¨æ± çç¶æéï¼æ¹åçº¿ç¨æ± ç¶ææ¶è¦å è¿ä¸ªé\n    private final ReentrantLock mainLock = new ReentrantLock();\n\n    // çº¿ç¨æ± çæ¡ä»¶éï¼å¨çº¿ç¨æ± çç¶æåçæ¹åæ¶ï¼ä½¿ç¨è¿ä¸ªæ¡ä»¶ééç¥ææç­å¾ççº¿ç¨é»å¡æèå¤é\n    private final Condition termination = mainLock.newCondition();\n\n    // çº¿ç¨æ± ä¸­æ¾ç»åºç°è¿çæå¤§ççº¿ç¨æ°é\n    private int largestPoolSize;\n\n    // å·²ç»å®æçä»»å¡æ°é\n    private long completedTaskCount;\n\n    \n\t// ä¸é¢æ¯æ ¸å¿åæ°ï¼ä¹å°±æ¯éè¦æä»¬æå®ç7ä¸ªåæ°\n    // çº¿ç¨æ± çé»å¡éå\n    private final BlockingQueue<Runnable> workQueue;\n\t// çº¿ç¨å·¥å\n    private volatile ThreadFactory threadFactory;\n\t// æç»ç­ç¥\n    private volatile RejectedExecutionHandler handler;\n\t// ä¸´æ¶çº¿ç¨å­æ´»æ¶é´\n    private volatile long keepAliveTime;\n    // æ¯å¦åè®¸æ ¸å¿çº¿ç¨æ­»äº¡\n    private volatile boolean allowCoreThreadTimeOut;\n    // æ ¸å¿çº¿ç¨æ°\n    private volatile int corePoolSize;\n    // æå¤§çº¿ç¨æ° = æ ¸å¿çº¿ç¨æ° + ä¸´æ¶çº¿ç¨æ°\n    private volatile int maximumPoolSize;\n\n    // é»è®¤çæç»ç­ç¥ï¼æç»æ§è¡å¹¶æåºå¼å¸¸\n    private static final RejectedExecutionHandler defaultHandler =\n        new AbortPolicy();\n\n}\n\n\n\n# 2.2 execute\n\nçº¿ç¨æ± çå·¥ä½æµç¨æ¯èå«è¡äº ï¼\n\n\n\nè¿ä¸ªæ­¥éª¤æ¯æ­£ç¡®çï¼æä»¬ä¹å¯ä»¥æç§è¿ä¸ªæ­¥éª¤æ¥éè¯»æºç  ï¼\n\n// æäº¤ä»»å¡\npublic void execute(Runnable command) {\n    if (command == null)\n        throw new NullPointerException();\n    // è·å ctl\n    int c = ctl.get();\n    // å¦æçº¿ç¨æ°é < æ ¸å¿çº¿ç¨\n    if (workerCountOf(c) < corePoolSize) {\n        // æ·»å æ ¸å¿çº¿ç¨\n        // addWorker: å¤æ­è½å¦åå»ºçº¿ç¨ï¼ç¶åååå»ºçº¿ç¨\n        // å¦æè¿å trueï¼è¯´æåå»ºæåï¼ç´æ¥ç»æï¼è¿ä¸ªä»»å¡ä¼äº¤ç»æ°å»ºççº¿ç¨å»æ§è¡\n        // å¦æè¿å falseï¼è¯´æçº¿ç¨æ± ç¶æå¼å¸¸ï¼æèçº¿ç¨æ°éè¶äº\n        if (addWorker(command, true))\n            return;\n        c = ctl.get();\n    }\n    // å°ä»»å¡æ¾å¥é»å¡éåä¸­\n    if (isRunning(c) && workQueue.offer(command)) {\n        int recheck = ctl.get();\n        if (!isRunning(recheck) && remove(command))\n            reject(command);\n        // å¦æç°å¨æ²¡ææ­£å¨è¿è¡ççº¿ç¨ï¼å°±åå»ºä¸ä¸ªçº¿ç¨å¤çä»»å¡\n        else if (workerCountOf(recheck) == 0)\n            addWorker(null, false);\n    }\n    // å¦ææ¾å¥éåå¤±è´¥ï¼æ°å»ºä¸´æ¶çº¿ç¨å¤çä»»å¡\n    // å¦ææ°å»ºä¸´æ¶çº¿ç¨å¤±è´¥ï¼å°±æ§è¡æç»ç­ç¥\n    else if (!addWorker(command, false))\n        reject(command);\n}\n\n\næä¸ä¸ªç»è ï¼å½æå®æ ¸å¿çº¿ç¨æ°éä¸º 0 æ¶ï¼ä¹ä¼åå»ºä¸ä¸ªçº¿ç¨ï¼å¹¶ä¸å¨é»å¡éåæ»¡ä¹åé½åªæè¿ä¸ä¸ªçº¿ç¨å¤çä»»å¡ã\n\næ¥ä¸æ¥éè¦çå°±æ¯ addWorker() ï¼å®æ¯å·ä½åå»ºçº¿ç¨çå°æ¹ ï¼\n\n// æ·»å çº¿ç¨ \nprivate boolean addWorker(Runnable firstTask, boolean core) {\n    retry:\n    for (;;) {\n        int c = ctl.get();\n        int rs = runStateOf(c);\n\n        // å¤æ­çº¿ç¨æ± çç¶æï¼å¦ææ¯å·²ç»å³é­ï¼é£å°±ä¸è½ååå»ºçº¿ç¨\n        if (rs >= SHUTDOWN &&\n            !(rs == SHUTDOWN && firstTask == null && !workQueue.isEmpty()))\n            return false;\n\n        for (;;) {\n            int wc = workerCountOf(c);\n            // å¦æçº¿ç¨æ°éå¤§äºæå¤§æ°éï¼è¯å®æ²¡æ³ç»§ç»­åå»º\n            // å¦æç°å¨è¦åå»ºçæ¯æ ¸å¿çº¿ç¨ï¼wcå°±è·æ ¸å¿çº¿ç¨æ°å¤æ­\n            // å¦æçº¿ç¨è¦åå»ºçæ¯ä¸´æ¶çº¿ç¨ï¼wcå°±è·æå¤§çº¿ç¨æ°å¤æ­\n            // å¦æå¤§äºäºï¼å°±æ²¡æ³åå»ºçº¿ç¨äºï¼è¿åfalse\n            if (wc >= CAPACITY ||\n                wc >= (core ? corePoolSize : maximumPoolSize))\n                return false;\n\n            // å¯ä»¥åå»ºï¼ä¿®æ¹ä¸ä¸çº¿ç¨æ°é\n            if (compareAndIncrementWorkerCount(c))\n                break retry;\n            c = ctl.get();  \n            if (runStateOf(c) != rs)\n                continue retry;\n\n        }\n    }\n    // ä¸é¢æ¯æ£æ¥è½å¦åå»ºçº¿ç¨\n    // ä¸é¢å¼å§åå»ºçº¿ç¨\n    boolean workerStarted = false;\n    boolean workerAdded = false;\n    Worker w = null;\n    try {\n        w = new Worker(firstTask);\n        final Thread t = w.thread;\n        if (t != null) {\n            final ReentrantLock mainLock = this.mainLock;\n            mainLock.lock();\n            try {\n\n                int rs = runStateOf(ctl.get());\n\n                if (rs < SHUTDOWN ||\n                    (rs == SHUTDOWN && firstTask == null)) {\n                    if (t.isAlive()) // precheck that t is startable\n                        throw new IllegalThreadStateException();\n                    // å°æ°å»ºç Worker æ¾å¥éåä¸­\n                    workers.add(w);\n                    int s = workers.size();\n                    if (s > largestPoolSize)\n                        largestPoolSize = s;\n                    workerAdded = true;\n                }\n            } finally {\n                mainLock.unlock();\n            }\n            if (workerAdded) {\n                t.start();\n                workerStarted = true;\n            }\n        }\n    } finally {\n        if (! workerStarted)\n            addWorkerFailed(w);\n    }\n    return workerStarted;\n}\n\n\n\n# 2.3 shutdown\n\nåé¢è¯´è¿ï¼shutdown()æ¹æ³å³é­çº¿ç¨æ± ä¸­çææçº¿ç¨ãå¦æçº¿ç¨æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æã\n\nå·ä½çè¿ç¨ ï¼éåææ Workerï¼è°ç¨ worker.tryLock() å¦ææ¢éå¤±è´¥è¯´æè¿ä¸ª Worker æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æååå³é­ã\n\n// éåçº¿ç¨æ± ä¸­çææçº¿ç¨ï¼å¦æè¯¥çº¿ç¨æ­£å¨è¿è¡ï¼ç­å¾å¶è¿è¡ç»æåç»æ­¢å®\nprivate void interruptIdleWorkers(boolean onlyOne) {\n    final ReentrantLock mainLock = this.mainLock;\n    mainLock.lock();\n    try {\n        // éåææ worker\n        for (Worker w : workers) {\n            Thread t = w.thread;\n            // è¿éä¼æ¢éï¼å¦ææ²¡æ¢å°å°±ä¼é»å¡å¨è¿é\n            // åæ¶ä¹å°±è¯´æè¿ä¸ªçº¿ç¨æ­£å¨å¤çä»»å¡ï¼é£å°±ç­å®å¤çå®äºåå³é­å®\n            if (!t.isInterrupted() && w.tryLock()) {\n                try {\n                    t.interrupt();\n                } catch (SecurityException ignore) {\n                } finally {\n                    w.unlock();\n                }\n            }\n            if (onlyOne)\n                break;\n        }\n    } finally {\n        mainLock.unlock();\n    }\n}\n\n\n\n# 2.4 shutdownNow\n\nå³é­çº¿ç¨æ± ä¸­çææçº¿ç¨ãéåææ Workerï¼ç´æ¥å³é­ã\n\n// éåçº¿ç¨æ± ä¸­çææçº¿ç¨ï¼è°ç¨è¯¥çº¿ç¨ç interruptIfStartedæ¹æ³åæ­¢è¯¥çº¿ç¨\n// å¼ºè¡åæ­¢\nprivate void interruptWorkers() {\n    final ReentrantLock mainLock = this.mainLock;\n    mainLock.lock();\n    try {\n        for (Worker w : workers)\n            w.interruptIfStarted();\n    } finally {\n        mainLock.unlock();\n    }\n}\n\n\n\n# 3. æ»ç»\n\nè¿æ¬¡çæºç å¯¹ææ¥è¯´ææç¨çæ¯ä¸¤ç¹ ï¼\n\n 1. æç¥éäºçº¿ç¨æ± ä¸­ççº¿ç¨å¹¶ä¸ä¼ä¸¥æ ¼åºåæ ¸å¿çº¿ç¨åéæ ¸å¿çº¿ç¨ï¼å®åªä¼ä¿è¯æ± å­ä¸­æè¿ä¹å¤çº¿ç¨ä¸ç´æ´»çã\n 2. æç¥éäºå½æ ¸å¿çº¿ç¨æ°æå®ä¸º 0 æ¶ï¼çº¿ç¨æ± ä¹ä¼åå»ºä¸ä¸ªçº¿ç¨å»å¤çä»»å¡ï¼ç±äºæ ¸å¿çº¿ç¨æ°ä¸º0ï¼è¿ä¸ªçº¿ç¨æ¯ä¼æ­»çã',normalizedContent:'# 1. worker\n\nworker æ¯çº¿ç¨å¨çº¿ç¨æ± ä¸­çè¡¨ç°å½¢å¼ï¼å®å¹¶ä¸æ¯ä¸ä¸ªçº¿ç¨ï¼worker ç»§æ¿äº runnableï¼å¯ä»¥ä½¿ç¨çº¿ç¨å·¥åæ ¹æ® worker åå»ºä¸ä¸ªçº¿ç¨\n\nthreadfactory.newthread(worker);\n\n\næ¥çç worker ä¸­çåéï¼\n\n// worker ç»§æ¿ aqs å®ç°äºä¸å¯éå¥é\nprivate final class worker extends abstractqueuedsynchronizer implements runnable {\n\t// è¿ä¸ª worker å°è£ççº¿ç¨\n    final thread thread;\n    \n\t// è¿ä¸ª worker çä»»å¡\n    runnable firsttask;\n\t\n    // è¿ä¸ªçº¿ç¨æ§è¡è¿çä»»å¡æ°é\n    volatile long completedtasks;\n}\n\n\nå¯ä»¥çå° worker ä¸ä»ç»§æ¿äº runnableï¼è¿ç»§æ¿äº aqsï¼å®ç»§æ¿ aqs æ¯ä¸ºäºå®ç°ä¸å¯éå¥éï¼ä¸é¢ä¼å·ä½ä»ç»worker çä¸å¯éå¥éã\n\nå¼å¾ä¸æçæ¯ï¼è½ç¶æä»¬å¹³æ¶ä½¿ç¨çº¿ç¨æ± æ¶ä¼æå® æ ¸å¿çº¿ç¨æ°ãæå¤§çº¿ç¨æ°ï¼ä½æ¯çº¿ç¨è¢«å°è£ä¸º worker æ¶ä¸ä¼åºåè¿ä¸ªçº¿ç¨æ¯æ ¸å¿çº¿ç¨è¿æ¯ä¸´æ¶çº¿ç¨ã\n\n\n# 1.1 worker çä¸å¯éå¥é\n\nå¦æä½ å¯¹ aqs ä¸çè§£æä¸çæï¼å¯ä»¥éè¯»ä¸ä¸æçå¦ä¸ç¯æç«  ï¼aqsæºç è§£æ\n\nworker å®ç°çæ¯ä¸å¯éå¥éï¼ä¸å¯éå¥éå®ç°èµ·æ¥æ¯è¾ç®å ï¼\n\nprotected boolean tryacquire(int unused) {\n    if (compareandsetstate(0, 1)) {\n        setexclusiveownerthread(thread.currentthread());\n        return true;\n    }\n    return false;\n}\n\n\n * å¯éå¥é ï¼å¦æéå·²ç»è¢«å æï¼è¿è¦å¤æ­å æéççº¿ç¨æ¯å¦æ¯èªå·±ã\n * ä¸å¯éå¥é ï¼å¦æéå·²ç»è¢«å æï¼ä¸åå¤æ­ç´æ¥è¿åå éå¤±è´¥ã\n\nworker çå éé»è¾æ¯å° state å¼ä» 0 æ¹ä¸º 1ï¼å¦ææåå°±è¿å trueï¼å¦æå¤±è´¥å°±è¿å falseã\n\nä½æ¯ worker ä¸ºä»ä¹è¦å éåè½å¢ ï¼\n\nçº¿ç¨æ± æä¸ä¸ªæ¹æ³ ï¼shutdown() ï¼å°±æ¯è¦åæ­¢ææççº¿ç¨ï¼ä½æ¯å¦æè¯¥çº¿ç¨æ­£å¨æ§è¡ä»»å¡ï¼åç­å¾å®æ§è¡ç»æåå³é­å®ã\n\nworker å¨æ§è¡ä»»å¡æ¶è¦å éï¼æ§è¡ç»ææ¶è§£éï¼çº¿ç¨æ± åæ­¢çº¿ç¨æ¶ä¹å éï¼å¦æå éæåå°±çæå³é­è¯¥çº¿ç¨ã\n\nè¿æ ·å°±å¯ä»¥é¿åçº¿ç¨æ± å°æ­£å¨æ§è¡ä»»å¡ççº¿ç¨ç»å³é­äºã\n\nå¶å®çº¿ç¨æ± è¿æä¸ä¸ªæ¹æ³ ï¼shutdownnow()ï¼å®å¯ä¸ç®¡çº¿ç¨æ¯å¦æ­£å¨æ§è¡ï¼ç´æ¥å³é­ã\n\né£ä¹ shutdown å shutdownnow æ¹æ³å·¥ä½çåºå«å°±æ¯ ï¼\n\n 1. shutdown() ï¼å³é­çº¿ç¨æ± ä¸­çææçº¿ç¨ãå¦æçº¿ç¨æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æã\n    \n    éåææ workerï¼è°ç¨ worker.trylock() å¦ææ¢éå¤±è´¥è¯´æè¿ä¸ª worker æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æååå³é­ã\n\n 2. shutdownnow() ï¼å³é­çº¿ç¨æ± ä¸­çææçº¿ç¨\n    \n    éåææ workerï¼ç´æ¥å³é­ã\n\n\n# 1.2 worker.run()\n\nworker æ¯ä¸ä¸ªçº¿ç¨ï¼é£æä»¬å°±ç»ä¸å¼å®ç run() æ¹æ³ï¼å¨è¿éå¯ä»¥çæµä¸ä¸ worker.run() çé»è¾ï¼\n\n 1. å¾ªç¯ä»é»å¡éåä¸­åä»»å¡\n 2. å¦æè¶æ¶ï¼å¤æ­æ¯å¦ç»æ­¢å¾ªç¯ï¼ç»æ­¢å¾ªç¯å®éä¸è¿ä¸ªçº¿ç¨å°±æ§è¡ç»æäºï¼ç¸å½äºçº¿ç¨æ­»äº¡ã\n 3. ä»ä¹æ¶åç»æ­¢å¾ªç¯ ï¼å¦æå½åçº¿ç¨æ± ä¸­ççº¿ç¨æ°é < æ ¸å¿çº¿ç¨æ°ï¼é£æä»¬ä¸è½è®©çº¿ç¨ç»æ­¢ã\n\nç¶åå¯ä»¥çä¸ä¸æºç ï¼ççåæä»¬çæµçæ¯å¦æå·®å¼ ï¼\n\n// worker çº¿ç¨ä¸å¯å¨å°±ä¼è°ç¨ runworker æ¹æ³ï¼runworker æ¹æ³å¨ threadpoolexecutor ä¸­\npublic void run() {\n    runworker(this);\n}\n\n\nç±äº worker æ¯ threadpoolexecutor çåé¨ç±»ï¼æä»¥ worker.run() çé»è¾æ¯ç± threadpoolexecutor.runworker() æ¥å®ç°çã\n\nçº¿ç¨æ± éé¢ççº¿ç¨å¶å®åçæ éå°±æ¯ä¸¤ä»¶äº ï¼è·åä»»å¡ãæ§è¡ä»»å¡ã\n\n 1. è·åä»»å¡ï¼è·åä»»å¡æä¸¤ç§éå¾\n    * åå»º worker æ¶æå®å¥½çï¼è¿ä¸ªåªæç¬¬ä¸æ¬¡å¾ªç¯å¯è½æ¿å°\n    * ä»é»å¡éåä¸­è·åçï¼ä½æ¯é»å¡éåä¸­ä¸ä¸å®æï¼å¤æ­çº¿ç¨è½å¦æ­»äº¡çé»è¾ä¹æ¯å¨è¿éåçã\n 2. æ§è¡ä»»å¡\n\n// å·¥ä½çº¿ç¨å¯å¨åå°±ä¼æ§è¡è¿ä¸ªæ¹æ³\nfinal void runworker(worker w) {\n    // æ¿å°å½åçº¿ç¨ï¼ç±äºç°å¨è¿è¡è¿ä¸ªæ¹æ³çæ¯ worker.run()ï¼æä»¥å½åçº¿ç¨å®éä¸å°±æ¯ worker.thread\n    thread wt = thread.currentthread();\n    // æ¿å°è¯¥çº¿ç¨ç task\n    runnable task = w.firsttask;\n    // å·²ç»æä»»å¡æ¿åºæ¥äºï¼å°å¶ç½®ç©º\n    w.firsttask = null;\n    // éæ¾é--------å­ç, è¿éææ²¡ææä¸ºå¥è¦éæ¾éã\n    w.unlock(); \n    // è¿è¡è¿ç¨ä¸­æ¯å¦åºç°äºå¼å¸¸\n    boolean completedabruptly = true;\n    try {\n        // ç¬¬ä¸æ¬¡è¿è¡æ¶ task != nullï¼ä¸ä¼æ§è¡ task.gettask() çé»è¾\n        // ç¬¬äºæ¬¡è¿è¡æ¶ task == nullï¼ä¼è°ç¨ task.gettask() ä»é»å¡éåä¸­è·åä»»å¡\n        // æ³¨æï¼è¿éç gettask å¦æè·åå°äº nullï¼å¾ªç¯å°±ä¼ç»æï¼è¯¥çº¿ç¨å°±ä¼ç»æ­¢\n        while (task != null || (task = gettask()) != null) {\n            // å éï¼è¡¨ç¤ºè¯¥çº¿ç¨æ­£å¨è¿è¡ä»»å¡ï¼ä¸åè®¸ææ­\n            w.lock();\n            try {\n                // ç±ç¨åºåå®ç°çé»è¾, é©å­å½æ°\n                beforeexecute(wt, task);\n                // å¯è½ä¼æåºçå¼å¸¸\n                throwable thrown = null;\n                // æ§è¡è¯¥ä»»å¡\n                task.run();\n                \n            } finally {\n                task = null;\n                w.completedtasks++;\n                w.unlock();\n            }\n        }\n        completedabruptly = false;\n    } finally {\n        // çº¿ç¨éåºï¼ä¹å°±æ¯æä»¬å´éç"çº¿ç¨æ­»äº¡"\n        processworkerexit(w, completedabruptly);\n    }\n}\n\n\nä¸é¢çä¸ä¸ gettask() æ¹æ³ï¼è¿ä¸ªæ¹æ³ç¹å«éè¦ï¼å®ä¼å¤æ­è¿ä¸ªçº¿ç¨æ¯å¦æèµæ ¼æ­»äº¡ï¼ç»åä¸é¢ runworker çä»£ç æ¥çï¼åªè¦ gettask() è¿å nullï¼è¿ä¸ªçº¿ç¨å°±ç®æ­»äºã\n\næä»¬å¯ä»¥å¤§æ¦æ³ä¸ä¸çº¿ç¨å¯ä»¥æ­»äº¡çæ¡ä»¶ï¼\n\n 1. ä¸åè®¸æ ¸å¿çº¿ç¨æ­»äº¡æ¶ ï¼\n    \n    å½çº¿ç¨æ°é > æ ¸å¿çº¿ç¨æ°ï¼ä¹å°±æ¯æä¸´æ¶çº¿ç¨ï¼ä»é»å¡éåä¸­åæ°æ®è¶æ¶äºï¼ä¹å°±æ¯éåä¸­æ²¡æä»»å¡ï¼é£ä¹æ­¤çº¿ç¨å¯ä»¥æ­»äº¡ã\n    \n    æ³¨æ ï¼ä»é»å¡éåä¸­åæ°æ® è¿ä¸ªæä½çæç»­æ¶é´ == ä¸´æ¶çº¿ç¨çæ­»äº¡æ¶é´ã\n\n 2. åè®¸æ ¸å¿çº¿ç¨æ­»äº¡æ¶ ï¼\n    \n    çº¿ç¨æ°é < æå¤§çº¿ç¨æ°ï¼ä»éåä¸­åä»»å¡è¶æ¶ï¼å¹¶ä¸éåä¸­æ²¡æä»»å¡ã\n\næºç ä¸­çå¤æ­é»è¾æ¯è¾é¾æ ï¼\n\nprivate runnable gettask() {\n    // é»å¡è·åä»»å¡æ¯å¦è¶æ¶\n    boolean timedout = false; \n    for (;;) {\n        int c = ctl.get();\n        // è·åçº¿ç¨æ± çç¶æ\n        int rs = runstateof(c);\n        // rs >= shutdowné½ä¸æ­£å¸¸ã\n        // å¦æçº¿ç¨æ± å·²ç»è°ç¨äº threadpool.shutdown()ï¼ç¬¦åä¸åæ¡ä»¶ä¸­çä»»ä½ä¸ä¸ªé½ä¼è¿ånull\n        // 1. çº¿ç¨æ± çç¶æ >= stopï¼ä¸åå¤çææ¥æ¶ä»»å¡\n        // 2. ä»»å¡éåä¸ºç©ºï¼å·²ç»å¤çå®äº\n        if (rs >= shutdown && (rs >= stop || workqueue.isempty())) {\n            decrementworkercount();\n            return null;\n        }\n        \n\t\t// è·åçº¿ç¨æ± ä¸­ççº¿ç¨æ°é\n        int wc = workercountof(c);\n\n\t\t// ä»¥ä¸çå¤æ­æ¯å³å®æ­¤çº¿ç¨æ¯å¦è¦æ­»äº¡\n        // çº¿ç¨æ­»äº¡çæ¡ä»¶:\n        // 1. ä¸åè®¸æ ¸å¿çº¿ç¨æ­»äº¡ : \n        //     æ ¸å¿çº¿ç¨æ° < çº¿ç¨æ°é < æå¤§çº¿ç¨æ°ï¼å¹¶ä¸ä»éåä¸­åä»»å¡è¶æ¶ï¼å¹¶ä¸éåä¸­æ²¡æä»»å¡\n        // 2. åè®¸æ ¸å¿çº¿ç¨æ­»äº¡ : çº¿ç¨æ°é < æå¤§çº¿ç¨æ°ï¼ä»éåä¸­åä»»å¡è¶æ¶ï¼å¹¶ä¸éåä¸­æ²¡æä»»å¡\n        // 3. çº¿ç¨æ°é > æå¤§çº¿ç¨æ°\n        boolean timed = allowcorethreadtimeout || wc > corepoolsize;\n\n        if ((wc > maximumpoolsize || (timed && timedout))\n            && (wc > 1 || workqueue.isempty())) {\n            if (compareanddecrementworkercount(c))\n                return null;\n            continue;\n        }\n\n        try {\n            // å¦æå¨è¿éåºç°ä¸­æ­å¼å¸¸ï¼å¯è½æ¯çº¿ç¨æ± è°ç¨äº shutdownï¼\n            // è¯¥çº¿ç¨ä¼è¿å¥ä¸ä¸ä¸ªå¾ªç¯å¹¶å¨ç¬¬ä¸ä¸ªifä¸­è¿å nullï¼è¾¾å°åæ­¢çº¿ç¨/ææ­»çº¿ç¨çç®æ ã\n            runnable r = timed ?\n                workqueue.poll(keepalivetime, timeunit.nanoseconds) :\n            workqueue.take();\n            if (r != null)\n                return r;\n            timedout = true;\n        } catch (interruptedexception retry) {\n            timedout = false;\n        }\n    }\n}\n\n\nè¿éé¢æä¸ªæææçå¤æ­é»è¾ ï¼\n\nboolean timed = allowcorethreadtimeout || wc > corepoolsize;\n\nrunnable r = timed ?\n    workqueue.poll(keepalivetime, timeunit.nanoseconds) :\nworkqueue.take();\n\n\nä¸è¬æåµä¸æä»¬ä¸ä¼åè®¸æ ¸å¿çº¿ç¨æ­»äº¡ï¼é£ä¹ timed è¿ä¸ªåéå°±åå³äºå½åçº¿ç¨çæ°éæ¯å¦å¤§äºæ ¸å¿çº¿ç¨çæ°éã\n\n 1. å¦æå¤§äºï¼è¯´ææ­¤æ¶æä¸´æ¶çº¿ç¨ï¼é£ä¹æ­¤çº¿ç¨çèº«ä»½å°±æ¯ä¸´æ¶çº¿ç¨ï¼åä»»å¡æ¶é»å¡ keepalivetime è¿ä¹é¿æ¶é´ãå¦æé»å¡äº keepalivetime è¿æ²¡ææ¿å°ä»»å¡ï¼å°±ä¼è¿å¥ä¸ä¸ä¸ªå¾ªç¯ï¼å¤æ­æ­¤çº¿ç¨æ¯å¦è¦æ­»äº¡ã\n\n 2. å¦æå°äºï¼è¯´ææ­¤æ¶æ²¡æä¸´æ¶çº¿ç¨ï¼é£ä¹æ­¤çº¿ç¨çèº«ä»½å°±æ¯æ ¸å¿çº¿ç¨ï¼åä»»å¡æ¶æ°¸ä¹é»å¡ã\n\nè³æ­¤ï¼worker çæºç å°±è¯´å®äºï¼çº¿ç¨æ± ä¸­ççº¿ç¨å¹¶ä¸ä¼åºåæ ¸å¿çº¿ç¨ä¸ä¸´æ¶çº¿ç¨ï¼å®åªä¼ä¿è¯çº¿ç¨æ± ä¸­å§ç»æ corepoolsize ä¸ªçº¿ç¨ä¿ææ´»è·ã\n\n\n# 2. threadpoolexecutor\n\næºç å¤§æ¦æ 1000 å¤è¡ï¼æ ¹æ¬ä¸éè¦çå®ï¼éè¦æä¸¤ä¸ªæ¹æ³ ï¼\n\n 1. æäº¤ä»»å¡ execute ï¼å¨è¿éå¯ä»¥çå°çº¿ç¨æ± çå·¥ä½æµç¨ä»¥åçº¿ç¨çåå»ºè¿ç¨ã\n 2. å³é­çº¿ç¨æ±  shutdown ï¼å¨è¿éå¯ä»¥çå°çº¿ç¨æ± çä¸åå³é­é»è¾ã\n\n\n# 2.1 çº¿ç¨æ± åé\n\npublic class threadpoolexecutor extends abstractexecutorservice {\n    // çº¿ç¨æ± çç¶æåçº¿ç¨æ°é\n    // é«ä¸ä½è¡¨ç¤ºçº¿ç¨æ± çç¶æ\n    // ä½29ä½è¡¨ç¤ºçº¿ç¨æ± ä¸­ççº¿ç¨æ°é\n    private final atomicinteger ctl = new atomicinteger(ctlof(running, 0));\n\n    private static final int count_bits = integer.size - 3;\n    // 1 << 29 = 00010000 00000000 00000000 00000000\n    // åå1 = 00001111 11111111 11111111 11111111\n    // ctl & capacity å¯ä»¥å¾å°çº¿ç¨æ°é \n    private static final int capacity   = (1 << count_bits) - 1;\n\n\t// çº¿ç¨æ± çäºç§ç¶æï¼å¨ ctl çé«ä¸ä½è¡¨ç¤º\n    // 111 00000 00000000 00000000 00000000\n    // æ­£å¨è¿è¡\t\t\n    private static final int running    = -1 << count_bits;\n    \n    // 000 00000 00000000 00000000 00000000\n    // å·²ç»è°ç¨äº shutdownï¼ä½æ¯éé¢ççº¿ç¨è¿æ²¡æåæ­¢\n    private static final int shutdown   =  0 << count_bits;\n    \n    // 001 00000 00000000 00000000 00000000\n    private static final int stop       =  1 << count_bits;\n    // 010 00000 00000000 00000000 00000000\n    private static final int tidying    =  2 << count_bits;\n    // 011 00000 00000000 00000000 00000000\n    private static final int terminated =  3 << count_bits;\n\n\t// ä¼ å¥ ctlï¼è¿åçº¿ç¨æ± çç¶æ\n    private static int runstateof(int c)     { return c & ~capacity; }\n    // ä¼ å¥ ctlï¼è¿åçº¿ç¨æ°é\n    private static int workercountof(int c)  { return c & capacity; }\n    // ä¼ å¥çº¿ç¨æ± çç¶æåçº¿ç¨æ°éï¼è¿åctl\n    private static int ctlof(int rs, int wc) { return rs | wc; }\n\n\n\n\t// casçæ¹å¼å¢å å·¥ä½çº¿ç¨çæ°éï¼å¢å ä¸ä¸ª\n    private boolean compareandincrementworkercount(int expect) {\n        return ctl.compareandset(expect, expect + 1);\n    }\n\n\t// casçæ¹å¼åå°å·¥ä½çº¿ç¨çæ°éï¼åå°ä¸ä¸ª\n    private boolean compareanddecrementworkercount(int expect) {\n        return ctl.compareandset(expect, expect - 1);\n    }\n\n\n    // ä¿å­å·¥ä½çº¿ç¨çéå\n    private final hashset<worker> workers = new hashset<worker>();\n\n    \n   \t// çº¿ç¨æ± çç¶æéï¼æ¹åçº¿ç¨æ± ç¶ææ¶è¦å è¿ä¸ªé\n    private final reentrantlock mainlock = new reentrantlock();\n\n    // çº¿ç¨æ± çæ¡ä»¶éï¼å¨çº¿ç¨æ± çç¶æåçæ¹åæ¶ï¼ä½¿ç¨è¿ä¸ªæ¡ä»¶ééç¥ææç­å¾ççº¿ç¨é»å¡æèå¤é\n    private final condition termination = mainlock.newcondition();\n\n    // çº¿ç¨æ± ä¸­æ¾ç»åºç°è¿çæå¤§ççº¿ç¨æ°é\n    private int largestpoolsize;\n\n    // å·²ç»å®æçä»»å¡æ°é\n    private long completedtaskcount;\n\n    \n\t// ä¸é¢æ¯æ ¸å¿åæ°ï¼ä¹å°±æ¯éè¦æä»¬æå®ç7ä¸ªåæ°\n    // çº¿ç¨æ± çé»å¡éå\n    private final blockingqueue<runnable> workqueue;\n\t// çº¿ç¨å·¥å\n    private volatile threadfactory threadfactory;\n\t// æç»ç­ç¥\n    private volatile rejectedexecutionhandler handler;\n\t// ä¸´æ¶çº¿ç¨å­æ´»æ¶é´\n    private volatile long keepalivetime;\n    // æ¯å¦åè®¸æ ¸å¿çº¿ç¨æ­»äº¡\n    private volatile boolean allowcorethreadtimeout;\n    // æ ¸å¿çº¿ç¨æ°\n    private volatile int corepoolsize;\n    // æå¤§çº¿ç¨æ° = æ ¸å¿çº¿ç¨æ° + ä¸´æ¶çº¿ç¨æ°\n    private volatile int maximumpoolsize;\n\n    // é»è®¤çæç»ç­ç¥ï¼æç»æ§è¡å¹¶æåºå¼å¸¸\n    private static final rejectedexecutionhandler defaulthandler =\n        new abortpolicy();\n\n}\n\n\n\n# 2.2 execute\n\nçº¿ç¨æ± çå·¥ä½æµç¨æ¯èå«è¡äº ï¼\n\n\n\nè¿ä¸ªæ­¥éª¤æ¯æ­£ç¡®çï¼æä»¬ä¹å¯ä»¥æç§è¿ä¸ªæ­¥éª¤æ¥éè¯»æºç  ï¼\n\n// æäº¤ä»»å¡\npublic void execute(runnable command) {\n    if (command == null)\n        throw new nullpointerexception();\n    // è·å ctl\n    int c = ctl.get();\n    // å¦æçº¿ç¨æ°é < æ ¸å¿çº¿ç¨\n    if (workercountof(c) < corepoolsize) {\n        // æ·»å æ ¸å¿çº¿ç¨\n        // addworker: å¤æ­è½å¦åå»ºçº¿ç¨ï¼ç¶åååå»ºçº¿ç¨\n        // å¦æè¿å trueï¼è¯´æåå»ºæåï¼ç´æ¥ç»æï¼è¿ä¸ªä»»å¡ä¼äº¤ç»æ°å»ºççº¿ç¨å»æ§è¡\n        // å¦æè¿å falseï¼è¯´æçº¿ç¨æ± ç¶æå¼å¸¸ï¼æèçº¿ç¨æ°éè¶äº\n        if (addworker(command, true))\n            return;\n        c = ctl.get();\n    }\n    // å°ä»»å¡æ¾å¥é»å¡éåä¸­\n    if (isrunning(c) && workqueue.offer(command)) {\n        int recheck = ctl.get();\n        if (!isrunning(recheck) && remove(command))\n            reject(command);\n        // å¦æç°å¨æ²¡ææ­£å¨è¿è¡ççº¿ç¨ï¼å°±åå»ºä¸ä¸ªçº¿ç¨å¤çä»»å¡\n        else if (workercountof(recheck) == 0)\n            addworker(null, false);\n    }\n    // å¦ææ¾å¥éåå¤±è´¥ï¼æ°å»ºä¸´æ¶çº¿ç¨å¤çä»»å¡\n    // å¦ææ°å»ºä¸´æ¶çº¿ç¨å¤±è´¥ï¼å°±æ§è¡æç»ç­ç¥\n    else if (!addworker(command, false))\n        reject(command);\n}\n\n\næä¸ä¸ªç»è ï¼å½æå®æ ¸å¿çº¿ç¨æ°éä¸º 0 æ¶ï¼ä¹ä¼åå»ºä¸ä¸ªçº¿ç¨ï¼å¹¶ä¸å¨é»å¡éåæ»¡ä¹åé½åªæè¿ä¸ä¸ªçº¿ç¨å¤çä»»å¡ã\n\næ¥ä¸æ¥éè¦çå°±æ¯ addworker() ï¼å®æ¯å·ä½åå»ºçº¿ç¨çå°æ¹ ï¼\n\n// æ·»å çº¿ç¨ \nprivate boolean addworker(runnable firsttask, boolean core) {\n    retry:\n    for (;;) {\n        int c = ctl.get();\n        int rs = runstateof(c);\n\n        // å¤æ­çº¿ç¨æ± çç¶æï¼å¦ææ¯å·²ç»å³é­ï¼é£å°±ä¸è½ååå»ºçº¿ç¨\n        if (rs >= shutdown &&\n            !(rs == shutdown && firsttask == null && !workqueue.isempty()))\n            return false;\n\n        for (;;) {\n            int wc = workercountof(c);\n            // å¦æçº¿ç¨æ°éå¤§äºæå¤§æ°éï¼è¯å®æ²¡æ³ç»§ç»­åå»º\n            // å¦æç°å¨è¦åå»ºçæ¯æ ¸å¿çº¿ç¨ï¼wcå°±è·æ ¸å¿çº¿ç¨æ°å¤æ­\n            // å¦æçº¿ç¨è¦åå»ºçæ¯ä¸´æ¶çº¿ç¨ï¼wcå°±è·æå¤§çº¿ç¨æ°å¤æ­\n            // å¦æå¤§äºäºï¼å°±æ²¡æ³åå»ºçº¿ç¨äºï¼è¿åfalse\n            if (wc >= capacity ||\n                wc >= (core ? corepoolsize : maximumpoolsize))\n                return false;\n\n            // å¯ä»¥åå»ºï¼ä¿®æ¹ä¸ä¸çº¿ç¨æ°é\n            if (compareandincrementworkercount(c))\n                break retry;\n            c = ctl.get();  \n            if (runstateof(c) != rs)\n                continue retry;\n\n        }\n    }\n    // ä¸é¢æ¯æ£æ¥è½å¦åå»ºçº¿ç¨\n    // ä¸é¢å¼å§åå»ºçº¿ç¨\n    boolean workerstarted = false;\n    boolean workeradded = false;\n    worker w = null;\n    try {\n        w = new worker(firsttask);\n        final thread t = w.thread;\n        if (t != null) {\n            final reentrantlock mainlock = this.mainlock;\n            mainlock.lock();\n            try {\n\n                int rs = runstateof(ctl.get());\n\n                if (rs < shutdown ||\n                    (rs == shutdown && firsttask == null)) {\n                    if (t.isalive()) // precheck that t is startable\n                        throw new illegalthreadstateexception();\n                    // å°æ°å»ºç worker æ¾å¥éåä¸­\n                    workers.add(w);\n                    int s = workers.size();\n                    if (s > largestpoolsize)\n                        largestpoolsize = s;\n                    workeradded = true;\n                }\n            } finally {\n                mainlock.unlock();\n            }\n            if (workeradded) {\n                t.start();\n                workerstarted = true;\n            }\n        }\n    } finally {\n        if (! workerstarted)\n            addworkerfailed(w);\n    }\n    return workerstarted;\n}\n\n\n\n# 2.3 shutdown\n\nåé¢è¯´è¿ï¼shutdown()æ¹æ³å³é­çº¿ç¨æ± ä¸­çææçº¿ç¨ãå¦æçº¿ç¨æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æã\n\nå·ä½çè¿ç¨ ï¼éåææ workerï¼è°ç¨ worker.trylock() å¦ææ¢éå¤±è´¥è¯´æè¿ä¸ª worker æ­£å¨æ§è¡ä»»å¡ï¼ç­å¾å¶æ§è¡ç»æååå³é­ã\n\n// éåçº¿ç¨æ± ä¸­çææçº¿ç¨ï¼å¦æè¯¥çº¿ç¨æ­£å¨è¿è¡ï¼ç­å¾å¶è¿è¡ç»æåç»æ­¢å®\nprivate void interruptidleworkers(boolean onlyone) {\n    final reentrantlock mainlock = this.mainlock;\n    mainlock.lock();\n    try {\n        // éåææ worker\n        for (worker w : workers) {\n            thread t = w.thread;\n            // è¿éä¼æ¢éï¼å¦ææ²¡æ¢å°å°±ä¼é»å¡å¨è¿é\n            // åæ¶ä¹å°±è¯´æè¿ä¸ªçº¿ç¨æ­£å¨å¤çä»»å¡ï¼é£å°±ç­å®å¤çå®äºåå³é­å®\n            if (!t.isinterrupted() && w.trylock()) {\n                try {\n                    t.interrupt();\n                } catch (securityexception ignore) {\n                } finally {\n                    w.unlock();\n                }\n            }\n            if (onlyone)\n                break;\n        }\n    } finally {\n        mainlock.unlock();\n    }\n}\n\n\n\n# 2.4 shutdownnow\n\nå³é­çº¿ç¨æ± ä¸­çææçº¿ç¨ãéåææ workerï¼ç´æ¥å³é­ã\n\n// éåçº¿ç¨æ± ä¸­çææçº¿ç¨ï¼è°ç¨è¯¥çº¿ç¨ç interruptifstartedæ¹æ³åæ­¢è¯¥çº¿ç¨\n// å¼ºè¡åæ­¢\nprivate void interruptworkers() {\n    final reentrantlock mainlock = this.mainlock;\n    mainlock.lock();\n    try {\n        for (worker w : workers)\n            w.interruptifstarted();\n    } finally {\n        mainlock.unlock();\n    }\n}\n\n\n\n# 3. æ»ç»\n\nè¿æ¬¡çæºç å¯¹ææ¥è¯´ææç¨çæ¯ä¸¤ç¹ ï¼\n\n 1. æç¥éäºçº¿ç¨æ± ä¸­ççº¿ç¨å¹¶ä¸ä¼ä¸¥æ ¼åºåæ ¸å¿çº¿ç¨åéæ ¸å¿çº¿ç¨ï¼å®åªä¼ä¿è¯æ± å­ä¸­æè¿ä¹å¤çº¿ç¨ä¸ç´æ´»çã\n 2. æç¥éäºå½æ ¸å¿çº¿ç¨æ°æå®ä¸º 0 æ¶ï¼çº¿ç¨æ± ä¹ä¼åå»ºä¸ä¸ªçº¿ç¨å»å¤çä»»å¡ï¼ç±äºæ ¸å¿çº¿ç¨æ°ä¸º0ï¼è¿ä¸ªçº¿ç¨æ¯ä¼æ­»çã',charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"AQSæºç è§£æ",frontmatter:{title:"AQSæºç è§£æ",date:"2023-12-21T23:27:11.000Z",permalink:"/pages/6c8c00/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/60.AQS%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html",relativePath:"02.æç« /75.Javaå¹¶å/60.AQSæºç è§£æ.md",key:"v-230aad5c",path:"/pages/6c8c00/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. AQS çä¸äºéè¦å±æ§",slug:"_2-aqs-çä¸äºéè¦å±æ§",normalizedTitle:"2. aqs çä¸äºéè¦å±æ§",charIndex:609},{level:3,title:"2.1 Node",slug:"_2-1-node",normalizedTitle:"2.1 node",charIndex:628},{level:3,title:"2.2 åæ­¥éå",slug:"_2-2-åæ­¥éå",normalizedTitle:"2.2 åæ­¥éå",charIndex:1913},{level:3,title:"2.3 ç­å¾éå",slug:"_2-3-ç­å¾éå",normalizedTitle:"2.3 ç­å¾éå",charIndex:2166},{level:3,title:"2.4 stateç¶æå¼",slug:"_2-4-stateç¶æå¼",normalizedTitle:"2.4 stateç¶æå¼",charIndex:2619},{level:3,title:"2.5 å°ç»",slug:"_2-5-å°ç»",normalizedTitle:"2.5 å°ç»",charIndex:2972},{level:2,title:"3. çº¿ç¨å éå¤±è´¥å",slug:"_3-çº¿ç¨å éå¤±è´¥å",normalizedTitle:"3. çº¿ç¨å éå¤±è´¥å",charIndex:3376},{level:3,title:"3.1 å°å½åçº¿ç¨å å¥åæ­¥éå",slug:"_3-1-å°å½åçº¿ç¨å å¥åæ­¥éå",normalizedTitle:"3.1 å°å½åçº¿ç¨å å¥åæ­¥éå",charIndex:4229},{level:3,title:"3.2 å°å½åçº¿ç¨é»å¡",slug:"_3-2-å°å½åçº¿ç¨é»å¡",normalizedTitle:"3.2 å°å½åçº¿ç¨é»å¡",charIndex:5591},{level:2,title:"4. éæ¾éå",slug:"_4-éæ¾éå",normalizedTitle:"4. éæ¾éå",charIndex:7283},{level:2,title:"5. Condition",slug:"_5-condition",normalizedTitle:"5. condition",charIndex:8626},{level:3,title:"5.1 Condition.await()",slug:"_5-1-condition-await",normalizedTitle:"5.1 condition.await()",charIndex:9279},{level:3,title:"5.2 Condition.signal()",slug:"_5-2-condition-signal",normalizedTitle:"5.2 condition.signal()",charIndex:10459},{level:2,title:"5. æ»ç»",slug:"_5-æ»ç»",normalizedTitle:"5. æ»ç»",charIndex:11649}],headersStr:"1. ç®è¿° 2. AQS çä¸äºéè¦å±æ§ 2.1 Node 2.2 åæ­¥éå 2.3 ç­å¾éå 2.4 stateç¶æå¼ 2.5 å°ç» 3. çº¿ç¨å éå¤±è´¥å 3.1 å°å½åçº¿ç¨å å¥åæ­¥éå 3.2 å°å½åçº¿ç¨é»å¡ 4. éæ¾éå 5. Condition 5.1 Condition.await() 5.2 Condition.signal() 5. æ»ç»",content:"# 1. ç®è¿°\n\nJUC åä¸çå¾å¤ç±»é½ä¾é  AQSï¼å¨ç¥é AQS æ¯ä¸ä¸ªæ½è±¡ç±»ä¹åï¼æä¸åº¦ä»¥ä¸º AQSæ¯JUCçåºç³ è¿å¥è¯çæææ¯ï¼JUCåä¸å¾å¤ç±»é½å®ç°/ç»§æ¿äº AQSï¼æ¯å¦ ReentrantLock å®ç°äº AQS... ä½æ¯æéäºã\n\n\n\nå¯ä»¥çå°ï¼AQS æå¾å¤åä¸º Syncçå®ç°ç±»ï¼è¿äº Sync åå¸å¨ä¸åçç±»ä¸­ï¼é£ä¹ AQSæ¯JUCçåºç³ çææå°±åºè¯¥æ¯ï¼å½ä¸ä¸ªå·¥å·ç±»æ³è¦ä½¿ç¨ AQS æä¾çåºæ¬åè½æ¶ï¼ä¼åä¸ä¸ªåé¨ç±» Sync ç»§æ¿ AQSã\n\nåæ¬¡å¼ºè° ï¼AQS æ¯ä¸ä¸ªå·¥å·ï¼å®æ²¡æå éåè½ãå®çè®¸å¤å®ç°ç±»ï¼å¤§å¤å«å Syncï¼å®ç°äºå éåè½ï¼æ¯å¦å¬å¹³å éãéå¬å¹³å éãå è¯»åéãå å¬å¹³é.....\n\nAQS æä¾äºä»ä¹åè½å¢ï¼å¦ææ²¡ææ¢å°éå°±ä¼è®©çº¿ç¨é»å¡ç­å¾ã\n\nå½æä¸ªç±»æ³è¦ä½¿ç¨ AQS æä¾çåºæ¬åè½æ¶ï¼åªéè¦ç»§æ¿å®å¹¶å®ç°é£äºè¿æ²¡æå®ç°çæ¹æ³å°±å¯ä»¥ï¼è¿æ¯å¸åçæ¨¡æ¿æ¹æ³è®¾è®¡æ¨¡å¼ã\n\nAQS æ¬èº«æ²¡ææ¢éåè½ï¼å¤§å¤æ°æç« ä¼ä» ReentrantLock å¥æï¼ä½æ¯è¿ä¼è®©è¯»èä¹±å¥ï¼åå­¦èå¾å®¹æå¯¹ ReentrantLock ä¸ AQS è¿·è¿·ç³ç³åä¸æ¸ï¼æä»¥æ¬ç¯æç« ä¼æ½è±¡è¡¨è¾¾ âå éâ è¿ä¸ªæ¦å¿µï¼ä¹å°±æ¯ä¸è®²è§£å éåè½ï¼èæ¯ç®ç¥çä»¥ âæçº¿ç¨æ¢éå¤±è´¥â æ¥è¡¨è¾¾ã\n\nç­æ AQS æä¾çåè½ä»ç»æ¸æ¥äºåä»ç» ReentrantLockãCountDownLatch å¯¹å®çå®ç°ã\n\n\n# 2. AQS çä¸äºéè¦å±æ§\n\n\n# 2.1 Node\n\nç°å¨å¯ä»¥æ½ç©ºçä¸ä¸ç®å½ï¼æ¯ä¸æ¯æåæ­¥éååç­å¾éåè¿ä¸¤ä¸ªå°æ é¢ï¼è¿ä¸ªNodeç±»å°±æ¯ç»æåæ­¥éååé»å¡éåçèç¹ãåæ¬æ³è¦å¨åæ­¥éåä¸­ç´æ¥å° Node å¼åºï¼ä½æ¯ä¼å æ­¤è®©æç« åå¾æ··ä¹±ï¼æä»¥æå³å®åä»ç»Nodeã\n\nAQSä¸­æä¸ä¸ªéæåé¨ç±»ï¼Nodeãè¿ä¸ªNodeå¯ä»¥æ½è±¡ä¸ºçº¿ç¨ï¼ä¹è®¸è¯´å®å°±ä»£è¡¨ççº¿ç¨æ´å å¦¥å½ã\n\nstatic final class Node {\n    // æ­¤Nodeä»£è¡¨ççº¿ç¨\n    volatile Thread thread;\n    // pre å next ææäºååé¾è¡¨ï¼ç»æAQSçåæ­¥éå\n    // æ­¤Nodeçåä¸ä¸ªç»ç¹\n    volatile Node prev;\n\t// æ­¤Nodeçåä¸ä¸ªèç¹\n    volatile Node next;\n    // nextWaiter ææäºååé¾è¡¨ï¼ç»æäºAQSçç­å¾éå\n    Node nextWaiter;\n    // èç¹çç¶æ\n    volatile int waitStatus;\n}\n\n\n * next å prev ç¨äºå®ç°åæ­¥éåï¼åºäºååé¾è¡¨ï¼\n * nextWaiter ç¨äºå®ç°ç­å¾éåï¼åºäºåé¾è¡¨ï¼ï¼è¿ä¸ª nextWaiter ç¨äº Condition.await()\n\nå ä¸º Node ä»£è¡¨ççº¿ç¨ï¼æä»¥å®æä¾äºå ä¸ªç¶æå¼æ¥ä»£è¡¨çº¿ç¨å¨éåä¸­çç¶æ ï¼\n\n// Nodeçç¶æé»è®¤ä¸º 0\n\n// æ­¤ä»»å¡å·²åæ¶\nstatic final int CANCELLED =  1;\n\n// å½åèç¹çä¸ä¸ä¸ªèç¹æèµ·äº\nstatic final int SIGNAL    = -1;\n\n// å½åèç¹å¨ç­å¾éåä¸­\nstatic final int CONDITION = -2;\n\n// ä¸å±äº«æ¨¡å¼ç¸å³ï¼å¨å±äº«æ¨¡å¼ä¸­ï¼è¯¥ç¶ææ è¯ç»ç¹ççº¿ç¨å¤äºå¯è¿è¡ç¶æã\nstatic final int PROPAGATE = -3;\n\n\nè°æ¥æè¿äºç¶æå¼å¢ï¼waitStatus\n\nçº¿ç¨é½æ¯ä»¥ Node å½¢å¼ä¿å­å¨ AQS ä¸­çï¼Nodeä¸­æä¾äºå ç§ç¶æä¾çº¿ç¨ä½¿ç¨ï¼ä¾å¦ å·²åæ¶ï¼1ï¼ãé»è®¤ï¼0ï¼ãæèµ·ï¼-1ï¼ãç­å¾ï¼-2ï¼....\n\nåæ¶ï¼å¦æä½ æ­£å¨çæºç ï¼è¿ä¼çå°ä¸¤ä¸ªå±æ§ :\n\n// å±äº«æ¨¡å¼\nstatic final Node SHARED = new Node();\n// ç¬å æ¨¡å¼\nstatic final Node EXCLUSIVE = null;\n\n\nSHARED å EXCLUSIVE ä¸¤ä¸ªåè¯çææå¾ææ¾ ï¼å±äº«åç¬å ã\n\n 1. ç¬å æ¨¡å¼å³å½éè¢«æä¸ªçº¿ç¨æåè·åæ¶ï¼å¶ä»çº¿ç¨æ æ³è·åå°è¯¥éï¼åä¸æ¶é´åªæä¸ä¸ªçº¿ç¨è½æ¿å°éæ§è¡ï¼éçç¶æåªæ0å1ä¸¤ç§æåµãä¾å¦ ReentrantLockï¼ä¸æ¬¡åªæä¸ä¸ªçº¿ç¨å¯ä»¥å·¥ä½ã\n 2. å±äº«æ¨¡å¼å³å½éè¢«æä¸ªçº¿ç¨æåè·åæ¶ï¼å¶ä»çº¿ç¨ä»ç¶å¯è½è·åå°è¯¥éï¼åä¸æ¶é´æå¤ä¸ªçº¿ç¨å¯ä»¥æ¿å°éååå·¥ä½ï¼éçç¶æå¤§äºæç­äº0ãä¾å¦ CountDownLatchï¼ä¸æ¬¡å¯ä»¥æå¤ä¸ªçº¿ç¨å·¥ä½ã\n\n\n# 2.2 åæ­¥éå\n\nè¿ä¸ªåæ­¥éåæ¯ç±ååé¾è¡¨å®ç°çãä»ä¸é¢æè¯´çå¯ä»¥ç¥éï¼AQSä¸­çåæ­¥éåæ¯ç±Nodeç»æãNodeä¸­çprevånextè¿æ¥ã\n\nåªæèç¹è¯å®ä¸è¡ï¼AQSä¸­æä¸¤ä¸ªå±æ§æ§å¶è¿ä¸ªååé¾è¡¨ï¼head å tail ãå³å¤´åå°¾ãå¤´æ¯ä¸ä¸ªèæèç¹ï¼å®éé¢ç threadåé ä¸ç´æ¯NULLå¹¶ä¸ä¼ä»£è¡¨åªä¸ªçº¿ç¨ï¼å°¾æ¯æå·ä½æä¹çï¼ä¼ä»£è¡¨æä¸ä¸ªçº¿ç¨ãå³ï¼å¤´èç¹æ æä¹ï¼å¶ä»èç¹é½ä»£è¡¨ä¸ä¸ªçº¿ç¨ã\n\n\n\næ³¨æå½ï¼åæ­¥éåçå¤´èç¹æ¯æ æä¹çï¼çº¿ç¨å°è£çèç¹ä¸è½æä¸ºå¤´èç¹ï¼åªè½æä¸ºå¤´èç¹åçèç¹ã\n\n\n# 2.3 ç­å¾éå\n\nNodeç»æç­å¾éåï¼Nodeä¸­çnextWaiterè¿æ¥æä¸ºç­å¾éåã\n\n\n\nå¥æªçæ¯ï¼å½æå¨AQSä¸­å¯»æ¾ä¸ç®¡çåæ­¥éåçheadåtailç±»ä¼¼çå±æ§æ¶å¹¶æ²¡ææ¾å°ï¼ä½æè¿æ¯æ¾å°äºç®¡çç­å¾éåçå±æ§ï¼firstWaiterãlastWaiter\n\nå®å¨AQSå¦ä¸ä¸ªåé¨ç±»ä¸­ ï¼ConditionObjectã\n\nè¯´æ¥ä¹æ¯ï¼å°± âç­å¾éåâ è¿ä¸ªè¯èè¨ï¼ç­å¾è¯å®æ¯å®çä¸å¤§ç¹ç¹ãé£ä¹å¦ä½å®ç°ç­å¾ï¼ä¸ä¸ªæ¯Objectç±»ä¸­çwaitæ¹æ³ï¼å¦ä¸ä¸ªå°±æ¯ Condition ç await æ¹æ³ãé£ä¹å°±å¥½è§£éäºï¼\n\n> ConditionObject æä¾äºè®© Node ç­å¾çæ¹æ³ï¼ä¾å¦ awaitãsignal...éè¿ Node.nextWaiter å°çº¿ç¨ä¸²ä¸ºä¸ä¸ªç­å¾éåï¼å¹¶ä¸ä½¿ç¨ firstWaiter å lastWaiter æ§å¶/ç®¡ç ç­å¾éåã\n\næ³¨æå½ï¼ç­å¾éåç firstWaiter å¯ä¸æ¯æ æä¹çå¦ï¼çº¿ç¨å°è£ä¸º Node åå¯ä»¥æä¸º firstWaiter\n\n\n# 2.4 stateç¶æå¼\n\nè¿æ¯ä¸ä¸ªéå¸¸éè¦çå±æ§ã\n\nprivate volatile int state;\n\n\næ¯ç«AQSæä¾çæ¯å¹¶åæ¯æï¼æå¹¶åå°±è¦æéï¼é£ä¹ä¸ä¸ªçº¿ç¨ææ ·æç®æ¿å°éå¢ï¼\n\nstate ä¸ä¸º 0 çæ¶åè¯æè¿ä¸ªéè¢«å æäºã\n\nåæ¶ï¼ç±äº AQS å¹¶æ²¡æè¦æ±å®ç°ç±»å¿é¡»ææ ·ææ ·ï¼æä»¥å®ç°ç±»ä»¬ä¹æ state ç¨çè±éè¡å¨ï¼ä¾å¦ï¼\n\n 1. å¨ ReentrantLock ä¸­ï¼state ä¸º 0 ä»£è¡¨éè¿æªè¢«å æï¼å¦æä¸º 1 ä»£è¡¨è¢«å æï¼å¦æå¤§äº 1 ä»£è¡¨éå¥ã\n 2. å¨ CountDownLatch ä¸­ï¼state ä»£è¡¨çä»»å¡æ°éã\n 3. å¨ ReentrantReadWriteLock ä¸­ï¼å° state ç 32 ä¸ªå­èååä¸ºä¸¤é¨åï¼ä¸é¨åè¡¨ç¤ºè¯»éï¼ä¸é¨è¡¨ç¤ºåéã\n\n\n# 2.5 å°ç»\n\n 1. AQSæä¸¤ä¸ªéè¦çå±æ§ï¼Nodeåstateã\n\n 2. state æ¯ç¶æå¼ï¼ä¸è¬æ¥è¯´ä»£è¡¨éæ¯å¦è¢«ææï¼ä¸è¿å·ä½å«ä¹è¦çå®ç°ç±»å¦ä½æä½ã\n\n 3. å±äº«åç¬å  ï¼å±äº«æ¯åè®¸å¤ä¸ªçº¿ç¨å±åæ§è¡ä»»å¡ï¼ç¬å æ¯åä¸æ¶é´åªåè®¸ä¸ä¸ªçº¿ç¨æ§è¡\n\n 4. Nodeï¼æ¯çº¿ç¨çä»£è¡¨ï¼çº¿ç¨ä¼è¢«å°è£ä¸ºNodeå¨AQSä¸­å­å¨ã\n    \n    Nodeä¸­æä¸ä¸ªå±æ§ï¼nextãprevãnextWaiterã\n    \n    * nextåprevè¿æ¥Nodeæä¸ºåæ­¥éåãæ§å¶åæ­¥éåçå±æ§ head å tail å¨AQSä¸­ã\n    * nextWaiterè¿æ¥Nodeæä¸ºç­å¾éåãæ§å¶ç­å¾éåçå±æ§ firstWaiter å lastWaiter å¨ ConditionObject ä¸­ï¼AQSçåé¨ç±»ï¼\n    * ï¼è³äºåæ­¥éååç­å¾éåå°åºæä»ä¹ç¨ï¼ææ³å¨åç»­æ¢æ¢å±å¼ãï¼\n\n\n\n\n# 3. çº¿ç¨å éå¤±è´¥å\n\nå¨ä¸é¢è¯´è¿ï¼AQS èªèº«å¹¶ä¸æä¾å éåè½ï¼èæ¯å®ç°äºå éå¤±è´¥åçé»è¾ãè¿ä¹åæä»ä¹å¥½å¤å¢ï¼\n\nç¨åºåå¯ä»¥æ ¹æ®éè¦è¿è¡å éï¼æ¯å¦ä»¥ä¸åç§éå®ç°æ¶ï¼æ³è¦å éè¦æ»¡è¶³ä»ä¹æ¡ä»¶ï¼\n\n 1. ä¸å¯éå¥é ï¼éä¸è¢«ä»»ä½çº¿ç¨æææ¶æè½å éæå\n 2. å¯éå¥é ï¼éä¸è¢«ä»»ä½çº¿ç¨ææï¼ä½æ¯å¦ææ¯èªå·±ææï¼è¿å¯ä»¥å é\n 3. å¬å¹³é ï¼çº¿ç¨æ¢éä¹ååççææ²¡æå¶ä»çº¿ç¨æ­£å¨ç­å¾ï¼æ²¡æåæ¢éï¼æå°±è·å¨ä»ä»¬åé¢\n 4. éå¬å¹³é ï¼ç®¡å®å¢ç´æ¥æ¢ï¼æ¢ä¸å°åè¯´\n 5. è¯»åé ï¼è¯»éå¯å±äº«ï¼åééææ¥ã\n\nå¦ææ²¡æ AQSï¼è¿äºéå¨å®ç°çæ¶åé½è¦åä¸é âçº¿ç¨æ¢éå¤±è´¥åéè¦é»å¡ç­å¾â çé»è¾ï¼ä»£ç å¤ªåä½äºï¼AQS å¤§æä¸æ¥ï¼æå¸®ä½ ä»¬å®ç°ï¼ç¨åºååªè¦æ ¹æ®ç°å¨çæåµå¤æ­æ¯å¦æ¢éæåå°±è¡äºï¼æ¢éå¤±è´¥ççº¿ç¨äº¤ç»æã\n\né£ä¹ç°å¨å°±æ¥çç AQS å¦ä½å¯¹å¾æ¢éå¤±è´¥ççº¿ç¨çå§ã\n\nAQS éè¦å®çå­ç±»å®ç°çæ¹æ³æ¯ ï¼tryAcquire()ï¼ä¹å°±æ¯å°è¯è·åéï¼å¦æè·åæåäºå°±æ²¡ AQS è¦å¹²çäºäºï¼ä½æ¯å¦æå¤±è´¥ï¼é£ä¹å°±è¦å¤çå½åçº¿ç¨äºï¼\n\npublic final void acquire(int arg) {\n    // tryAcquireè®©å­ç±»å»å®ç°\n    // å¦æè·åéå¤±è´¥ï¼æ§è¡åé¢çé»è¾\n    if (!tryAcquire(arg) &&\n        // å°å½åçº¿ç¨å å¥å°åæ­¥éåä¸­ï¼å¹¶ä¸å°çº¿ç¨é»å¡\n        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n        // é»å¡åæ­¢åï¼è°ç¨è¯¥çº¿ç¨ç interruptæ¹æ³\n        selfInterrupt();\n}\n\n\ntryAcquire æ¹æ³ç±å­ç±»å®ç°ï¼é£ä¹ç°å¨æ¥çç addWaiter ä¸ acquireQueued è¿ä¸¤ä¸ªæ¹æ³\n\n 1. addWaiter ï¼å°å½åçº¿ç¨å°è£ä¸º Node å¹¶æ¾å¥åæ­¥éå\n 2. acquireQueued ï¼\n\n\n# 3.1 å°å½åçº¿ç¨å å¥åæ­¥éå\n\næ­¥éª¤åä¸ºä¸¤å¤§æ­¥ï¼æå»ºä¸ä¸ª Nodeãæ¾å°éåå°¾é¨ã\n\nä½ æ³æä¸ä¸ª Node æ¾å°ååé¾è¡¨çå°¾é¨ï¼å¤§æµæ¯è¿ä¸æ­¥ï¼\n\ntail.next = node;\nnode.pre = tail;\nnode = tail\n\n\nä¹å°±æ¯å°é¾è¡¨å°¾èç¹ç next æéæåèªå·±ï¼èªå·±ç pre æéæåå°¾èç¹ï¼æåèªå·±åæäºå°¾èç¹ã\n\nä½æ¯æ¾å¥éåå°¾é¨è¿ä¸ªå¨ä½è¯´å¾è½»å·§ï¼é®é¢å°±åºå¨è¿éï¼å½å¤ä¸ª Node æ³è¦æå¨åä¸ä¸ªå°¾èç¹ä¸æ¶ï¼ä¼åºç°å¹¶åæåµãä½æ¯ææå¾ç»å¾äºð\n\nAQS è§£å³å¹¶åæåµæ¯è¿æ ·åç ï¼åå° node.pre = tailï¼åä½¿ç¨ CAS å° node æä¸ºå°¾èç¹ï¼æåå° node.pre.next = nodeï¼å¦æ CAS å¤±è´¥ï¼è¯´æç°å¨åºç°å¹¶åæåµäºï¼å«ççº¿ç¨æ¢åä¸æ­¥å° Node åæäºå°¾èç¹ï¼æ­¤çº¿ç¨ç node åªè½æå¨é£ä¸ª node åé¢äºã\n\n// è°ç¨æ¥æº : addWaiter(Node.EXCLUSIVE)\n// ä½¿ç¨ Node.EXCLUSIVE ä½ä¸º mode çå¥åï¼modeä¸ºç©ºã\nprivate Node addWaiter(Node mode) {\n    // å°æ­¤çº¿ç¨å°è£ä¸ºç¬å æ¨¡å¼ç Node\n    Node node = new Node(Thread.currentThread(), mode);\n    // è·åé»å¡éåçå°¾èç¹\n    Node pred = tail;\n   \n    if (pred != null) {\n        // å¦æå°¾èç¹ä¸ä¸ºç©ºï¼ææ­¤èç¹æå¨å°¾èç¹åé¢\n        // é¦åæ§è¡ node.pre = pred\n        node.prev = pred;\n        // ç¶åä½¿ç¨CASçæ¹å¼å°nodeè®¾ç½®ä¸ºå°¾èç¹\n        // å¦æè®¾ç½®æåï¼å°±å¯ä»¥å°ä¹åå°¾èç¹çnextæåç°å¨çå°¾èç¹: pred.next = node\n        if (compareAndSetTail(pred, node)) {\n            pred.next = node;\n            // ä¸è¬æåµä¸ä¼å¨è¿éreturn\n            return node;\n        }\n    }\n    // å¦æåé¢æ²¡æreturnï¼è¯´æä»ä¹ï¼\n    // è¯´æCASå¤±è´¥äºï¼ä¹å°±æ¯åºç°äºå¹¶åè®¾ç½®å°¾èç¹çæåµï¼å³: å¤ä¸ªçº¿ç¨è®¾ç½®å°¾èç¹ï¼è¿ä¸ªçº¿ç¨è®¾ç½®å¤±è´¥äºã\n    // è½ç¶å¤±è´¥äºï¼é£è¿ä¸ªèç¹å¯ä»¥æå¨æ°æ¥çå°¾èç¹ä¸å~ \n    // æä»¥è¿ä¸ªæ¹æ³çé»è¾å°±æ¯å°æ­¤èç¹æå¨æ°æ¥çå°¾èç¹ä¸ï¼å°±ä¸åè¯¦ç»è§£éäº\n    enq(node);\n    return node;\n}\n\n// ç¨ CAS å°å°¾èç¹çå¼ä» expect æ¢æ update\nprivate final boolean compareAndSetTail(Node expect, Node update) {\n    return unsafe.compareAndSwapObject(this, tailOffset, expect, update);\n}\n\n\n\n# 3.2 å°å½åçº¿ç¨é»å¡\n\næ­¤æ¶ï¼node å·²ç»æä¸ºåæ­¥éåä¸­çå°¾èç¹äºï¼ä½æ¯çº¿ç¨è¿æ²¡æé»å¡ï¼AQS è¦åçå°±æ¯è®©æ¢éå¤±è´¥ççº¿ç¨é»å¡ï¼æä»¥è¿ä¸ªæ¹æ³è³å³éè¦ã\n\nä¸ä¸æ¥å°±æ¯æ­»å¾ªç¯ï¼å½åèç¹è½ç¶æ¯å°¾èç¹ï¼ä½æ¯å¦æå®ç pre æ¯å¤´èç¹ä»£è¡¨å¥ï¼ä»£è¡¨åæ­¥éåä¸­åªæå®ä¸ä¸ªçº¿ç¨ï¼é£æå°±å¾éæ°æ¢ä¸ä¸éäºï¼å¦ææ¢å¤±è´¥äºæåé»å¡ã\n\nfinal boolean acquireQueued(final Node node, int arg) {\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            // æ¿å°å½åèç¹çåä¸ä¸ªèç¹ï¼\n            // å¦ææ¯headèç¹ï¼å¯ä»¥å°è¯æ¢ä¸ä¸é\n            final Node p = node.predecessor();\n            // å¦æå½åèç¹çåä¸ä¸ªèç¹æ¯headèç¹ï¼å°è¯æ¢é\n            if (p == head && tryAcquire(arg)) {\n                // å¦ææ¢éæåï¼å°æ­¤èç¹åæheadåå¡èç¹\n                // setHead() æ¹æ³é¦åä¼å° Nodeåé¨ççº¿ç¨ç½®ä¸ºç©ºï¼ä¸ºå¥ç½®ä¸ºç©ºï¼\n                // é½æ¢å°éäºï¼è¿ä¸ªçº¿ç¨è¯å®ä¸éè¦å­å¨äºAQSä¸­äºã\n                setHead(node);\n                // ä¹åçheadèç¹ç½®ä¸ºç©ºï¼æ¹ä¾¿GC\n                p.next = null; \n                failed = false;\n                return interrupted;\n            }\n            // æ­¤èç¹çä¸ä¸ä¸ªèç¹ä¸æ¯å¤´èç¹ï¼æèæ¢éå¤±è´¥ï¼å°å½åçº¿ç¨ park èµ·æ¥\n            if (\n                // æ£æ¥ä¸ä¸èç¹çç¶æï¼å¦æå·²åæ¶å°±æ²¡å¿è¦é»å¡ç­å¾\n                shouldParkAfterFailedAcquire(p, node) &&\n                // è¿ä¸ªæ¹æ³å°å½åçº¿ç¨parkèµ·æ¥\n                parkAndCheckInterrupt()\n               )\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n\n// å°nodeåé¨ççº¿ç¨ç½®ä¸ºç©ºï¼åææ æä¹ç head èç¹\nprivate void setHead(Node node) {\n    head = node;\n    node.thread = null;\n    node.prev = null;\n}\n\n// å°å½åçº¿ç¨parkèµ·æ¥\nprivate final boolean parkAndCheckInterrupt() {\n    // â çº¿ç¨é»å¡å¨æ­¤å¤ç­å¾å¤é \n    LockSupport.park(this);\n    // è¿åå¯¹åºçº¿ç¨çä¸­æ­æ å¿ä½ï¼å¹¶ä¸å°ä¸­æ­æ å¿ä½éç½®åä¸ºfalse\n    return Thread.interrupted();\n}\n\n\næ³¨æ ï¼å½éè¢«éæ¾æ¶ï¼åªä¼å¤éåæ­¥éåä¸­ç¬¬ä¸ä¸ªèç¹ï¼ä¹å°±æ¯ head.nextãï¼è¿ä¸ªä¼å¨éæ¾éçé»è¾ä¸­è¯´ï¼\n\nå½é»å¡ççº¿ç¨è¢«å¤éï¼ä¹å°±ä»£è¡¨æ­¤èç¹æ¯ head.nextï¼é£ä¹æ­»å¾ªç¯ä¸­ç if æ¡ä»¶å°±å¯ä»¥èµ°éäºï¼äºæ¯æ­¤èç¹ä¼ä½¿ç¨ tryAcquire å°è¯è·åéï¼å¦æè·åæåå°±éåºå¾ªç¯ï¼å¦æè·åå¤±è´¥å°±è¿è¦é»å¡ã\n\n\n# 4. éæ¾éå\n\nAQSå½ç¶ä¸ä¼ç®¡æä¹éæ¾éï¼éæ¾éçé»è¾è®©å­ç±»å»å®ç°ï¼æ¯å¦ä¸å¯éå¥éç´æ¥éæ¾ï¼å¯éå¥éè¿è¦å¤æ­ä¸ä¸æ¯å¦éå¥ã\n\nAQS å®ç°çæ¯ä¹åè¢«é»å¡ççº¿ç¨æä¹åçé»è¾ã\n\npublic final boolean release(int arg) {\n    // éæ¾éçé»è¾è®©å­ç±»å®ç°\n    // ä¸æ¦éæ¾æåï¼AQSå°±å¼å§å¤éåæ­¥éåä¸­çç¬¬ä¸ä¸ªèç¹\n    if (tryRelease(arg)) {\n        // æ¿å°å¤´èç¹\n        Node h = head;\n        if (h != null && h.waitStatus != 0)\n            // å¤éå¤´èç¹åé¢é£ä¸ªèç¹\n            unparkSuccessor(h);\n        return true;\n    }\n    return false;\n}\n\n\nä¸åºæå¤çæåµä¸æ¯ç´æ¥å¤é head.next é£ä¸ªçº¿ç¨ï¼ä½æ¯ä¸åºæå¤çæåµä¸è¦åºæå¤äº ï¼\n\nhead åçç¬¬ä¸ä¸ªèç¹ä¸ºç©ºï¼æèè¯´å®çç¶æä¸ºåæ¶ï¼é£ä¹å°±ä»åæ­¥éåçå°¾é¨ååå¯»æ¾ä¸ä¸ªææä¹çèç¹å°å®å¤éï¼æ³¨æåªæ¾ä¸ä¸ªå¦ã\n\nå¹¶ä¸æä¸ä¸ªå°ç»è ï¼å¦æNodeçç¶æä¸ºåæ¶ï¼å®ä¸ä¼ä»åæ­¥éåä¸­ç§»é¤ï¼è¿ä¸ªç»èå¨ Condition ä¸­ä¼æ¶å\n\n// æ­¤æ¶ä¼ å¥çNodeä¸ºå¤´èç¹\nprivate void unparkSuccessor(Node node) {\n    int ws = node.waitStatus;\n    if (ws < 0)\n        compareAndSetWaitStatus(node, ws, 0);\n\t// æ¿å°å¤´èç¹åé¢çç¬¬ä¸ä¸ªèç¹\n    Node s = node.next;\n    // ä¸è¬æ¥è¯´ä¸ä¼èµ°è¿éï¼èæ¯ä¸é¢é£ä¸ªifï¼ç´æ¥å°çº¿ç¨å¤éã\n    // ä½æ¯èµ°è¿éçé»è¾æ¯å ä¸ºå¥å¢ï¼\n    // waitStatuså¨ä¸é¢æè®²è§£ï¼èç¹ç waitStatus > 0ä»£è¡¨æ­¤èç¹å·²ç»åæ¶\n    // æä»¥é»è¾å°±æ¯ï¼å¦æ head.next ä¸ºç©ºæèå·²ç»åæ¶ï¼å°±ä»åæ­¥éåçå°¾é¨å¼å§å¾åå¯»æ¾ï¼\n    // ç´å°æ¾å°ä¸ä¸ªæ²¡æåæ¶çèç¹\n    if (s == null || s.waitStatus > 0) {\n        s = null;\n        for (Node t = tail; t != null && t != node; t = t.prev)\n            if (t.waitStatus <= 0)\n                s = t;\n    }\n    // ç´æ¥å°è¿ä¸ªçº¿ç¨å¤éäº\n    if (s != null)\n        LockSupport.unpark(s.thread);\n}\n\n\næ­¥éª¤ ï¼æ¿å°å¤´èç¹åçç¬¬ä¸ä¸ªææä¹çèç¹ï¼å¦æè¿ä¸ªèç¹çç¶æä¸ºåæ¶ï¼è¯´æè¿ä¸ªèç¹åä»ç­å¾éåæ¾å°åæ­¥éåï¼è·³è¿å®ä»éåçå°¾é¨å¼å§æ¾ç¶ææ­£å¸¸çï¼æ¾å°ä¹åå°å®å¤é\n\nææçº¿ç¨çæ§è¡é½é»å¡å¨ acquireQueued æ¹æ³åé¨ï¼è¿ä¸ªä½ å¯ä»¥åä¸ç¿»ï¼ææè¯´ã\n\n\n# 5. Condition\n\nå¯è½åè¯´å® AQS å°±è¯´ Condition ä¼æäºå²è£æï¼å ä¸ºå¾é¾æ³è±¡ Condition ä¸ AQS æå¥å³ç³»ï¼å¯¹ï¼æå³ç³»ï¼è¿è®°å¾ AQS ç Node ä¸­æä¸ä¸ªæååé ï¼nextWaiter\n\næå¨ä¹åè¯´è¿ï¼AQS æ¬èº«çé»è¾å¹¶æ²¡æç¨å°è¿ä¸ªåéï¼èæ¯å¨ ConditionObject ä¸­ä½¿ç¨å°äºï¼æä»¥ AQS ä¸­ç¬¬äºä¸ªéååºç°äº ï¼ç­å¾éå\n\nç¬è®°\n\nè¯·ä½ æ³¨æç­å¾éåä¸åæ­¥éåçåºå«ãä¸è¦å°äºèæ··ä¸ºä¸è°\n\nstatic final class Node {\n    // æ­¤Nodeä»£è¡¨ççº¿ç¨\n    volatile Thread thread;\n    // ç¨äºåæ­¥éåï¼æ­¤Nodeçåä¸ä¸ªç»ç¹\n    volatile Node prev;\n\t// ç¨äºåæ­¥éåï¼æ­¤Nodeçåä¸ä¸ªèç¹\n    volatile Node next;\n    // ç¨äºç­å¾éåï¼ç­å¾éåæ¯ä¸ä¸ªååé¾è¡¨ç»æçéå\n    Node nextWaiter;\n    // èç¹çç¶æ\n    volatile int waitStatus;\n    // çç¥å¶ä»åé\n}\n\n\nå¸¸ç¨çè®©çº¿ç¨ç­å¾çæ¹æ³æä¸¤ç§ ï¼\n\n 1. Object.wait()\n 2. Condition.await()\n\nè½ç¶å®ç°ä¸ä¸æ ·ï¼ä½æ¯åçæ¯ä¸æ ·çï¼çº¿ç¨ç­å¾çåæè¯å®æ¯å·²ç»æ¥æéäºï¼è°ç¨ wait åä¼éæ¾éç¶åé»å¡ãè°ç¨ signal å°çº¿ç¨ä»ç­å¾ç¶æå¤éï¼è¿å¥é»å¡ç¶æï¼å¯ä»¥æ¢éã\n\n\n# 5.1 Condition.await()\n\nå¦ææ¯ä½ ï¼ä½ ä¼å¦ä½åå© AQS æ¥å®ç° Condition.await() å¢ï¼ä¸å°±æ¯éæ¾éä¹åé»å¡å~\n\n 1. å°æ­¤çº¿ç¨å°è£ä¸º Node å¹¶æ¾å¥ç­å¾éå\n 2. è°ç¨ AQS ç release éæ¾é\n 3. å°å½åçº¿ç¨é»å¡\n\nå¯¹ï¼å°±æ¯è¿ä¸æ­¥ï¼æ¥çç AQS ä¸­ç ConditionObject å¦ä½å®ç°è¿ä¸æ­¥ç ï¼\n\npublic final void await() throws InterruptedException {\n    if (Thread.interrupted())\n        throw new InterruptedException();\n    // å°å½åçº¿ç¨å°è£ä¸ºNodeï¼Nodeçç¶æä¸º-2ï¼ä¹å°±æ¯ç­å¾ï¼ç¶åæ¾å¥ç­å¾éå\n    // è¿æ¶ä¼å° node.waitStatus æ¹ä¸º CONDITION\n    Node node = addConditionWaiter();\n    // è°ç¨ release æ¹æ³éæ¾é\n    // è¿æ¶ä¼å° node.waitStatus æ¹ä¸º CANCELLED â è¿éç¹å«éè¦ï¼ï¼ï¼ï¼ï¼\n    // åæ¬¡å¼ºè°ï¼è¿éä¼å° node.waitStatus æ¹ä¸º CANCELLED \n    int savedState = fullyRelease(node);\n    int interruptMode = 0;\n    // å¤æ­ Node èç¹çç¶æ\n    // ç¬¬ä¸æ¬¡è¿å¥æ¶é½ä¼è¿åfalseï¼åååä¼è¿å¥æ¹æ³å°çº¿ç¨é»å¡\n    while (!isOnSyncQueue(node)) {\n        LockSupport.park(this);\n        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)\n            break;\n    }\n    // çº¿ç¨ä»ç­å¾ç¶ææ¢å¤åï¼è¿å¥åæ­¥éåç­å¾æ¢éï¼è¿éçé»è¾å°±æ¯ä¸é¢è¯´è¿äºçã\n    if (acquireQueued(node, savedState) && interruptMode != THROW_IE)\n        interruptMode = REINTERRUPT;\n    if (node.nextWaiter != null) // clean up if cancelled\n        unlinkCancelledWaiters();\n    if (interruptMode != 0)\n        reportInterruptAfterWait(interruptMode);\n}\n\n\n\n# 5.2 Condition.signal()\n\nå¦ææ¯ä½ ï¼ä½ ä¼å¦ä½åå© AQS æ¥å®ç° Condition.signal() å¢ï¼ä¸å°±æ¯å¤ééãæå®å å¥åæ­¥éåå~\n\nCondition.signal() ä¼å¤éå¨ç­å¾éåä¸­ç­å¾æ¶é´æé¿çèç¹ï¼é¦èç¹ï¼\n\n// ä¼ å¥çæ¯ç­å¾éåçå¤´èç¹ï¼çº¿ç¨æ¯å¯ä»¥æä¸ºå¤´èç¹çï¼\nprivate void doSignal(Node first) {\n    do {\n        // ä¸è¬ä¸ä¼èµ°è¿é\n        if ( (firstWaiter = first.nextWaiter) == null)\n            lastWaiter = null;\n        // å°å¤´èç¹çnextæéç½®ä¸ºç©º\n        first.nextWaiter = null;\n    } while (!transferForSignal(first) &&\n             (first = firstWaiter) != null);\n}\n\n\nfinal boolean transferForSignal(Node node) {\n    if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))\n        return false;\n    // å°è¯¥èç¹å å¥åæ­¥éåå°¾é¨\n    Node p = enq(node);\n    // ååå¨ awaitæ¹æ³ä¸­ï¼æç¹å«å¼ºè°äºï¼fullyRelease æ¹æ³ä¼å°èç¹çç¶ææ¹ä¸ºåæ¶\n    // ä¹å°±æ¯ node.waitStatus = 1, å³ ws = 1\n    int ws = p.waitStatus;\n    if (ws > 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))\n        LockSupport.unpark(node.thread);\n    return true;\n}\n\n\næè ï¼ä¸ºå¥è°ç¨ await() æ¹æ³è®©çº¿ç¨éæ¾éåï¼çº¿ç¨ Node çç¶æä¼åæåæ¶ï¼node.waitStatus = 1ï¼å¢ï¼\n\nå ä¸º signal æ¹æ³çæ­¥éª¤ä¸º ï¼\n\n 1. å° node æ¾å¥åæ­¥éå\n 2. å°çº¿ç¨å¤é\n\nå° node æ¾å¥åæ­¥éååï¼ä¸ä¸è¢«å¤éäºæä¹åï¼é£å°±è¦éè¿ä¸äºææ®µé²æ­¢è¿ç§æ¦çç¹å«å°çæåµåºç°ï¼ä¹å°±æ¯çº¿ç¨è°ç¨ await() è¿å¥ç­å¾ä¹ååå° Node çç¶æåæ åæ¶ï¼é£ä¹å°±ä¸ä¼è¢«è¯¯å¤éï¼çå¼åã\n\nCondition ç singalAll æ¹æ³ï¼ç¸å½äºå¯¹ç­å¾éåçæ¯ä¸ªèç¹åæ§è¡ä¸æ¬¡ singal æ¹æ³ï¼ææå°±æ¯å°ç­å¾éåä¸­ææèç¹å¨é¨ç§»å¨å°åæ­¥éåï¼å¹¶å¤éæ¯ä¸ªèç¹ççº¿ç¨ã\n\n\n# 5. æ»ç»\n\nè³æ­¤ï¼AQS çæ ¸å¿åè½å·²ç»è¯´å®äºï¼æ²¡æè®²å éãéæ¾éï¼å ä¸ºå éãéæ¾éçé»è¾æ¬æ¥å°±ä¸æ¯ AQS è¦å®æçåã\n\næä»¥å éä¸éæ¾éæä¼å¨ ReentrantLockãCountDownLatchãReadWriteLock ä¸­è®²ã",normalizedContent:"# 1. ç®è¿°\n\njuc åä¸çå¾å¤ç±»é½ä¾é  aqsï¼å¨ç¥é aqs æ¯ä¸ä¸ªæ½è±¡ç±»ä¹åï¼æä¸åº¦ä»¥ä¸º aqsæ¯jucçåºç³ è¿å¥è¯çæææ¯ï¼jucåä¸å¾å¤ç±»é½å®ç°/ç»§æ¿äº aqsï¼æ¯å¦ reentrantlock å®ç°äº aqs... ä½æ¯æéäºã\n\n\n\nå¯ä»¥çå°ï¼aqs æå¾å¤åä¸º syncçå®ç°ç±»ï¼è¿äº sync åå¸å¨ä¸åçç±»ä¸­ï¼é£ä¹ aqsæ¯jucçåºç³ çææå°±åºè¯¥æ¯ï¼å½ä¸ä¸ªå·¥å·ç±»æ³è¦ä½¿ç¨ aqs æä¾çåºæ¬åè½æ¶ï¼ä¼åä¸ä¸ªåé¨ç±» sync ç»§æ¿ aqsã\n\nåæ¬¡å¼ºè° ï¼aqs æ¯ä¸ä¸ªå·¥å·ï¼å®æ²¡æå éåè½ãå®çè®¸å¤å®ç°ç±»ï¼å¤§å¤å«å syncï¼å®ç°äºå éåè½ï¼æ¯å¦å¬å¹³å éãéå¬å¹³å éãå è¯»åéãå å¬å¹³é.....\n\naqs æä¾äºä»ä¹åè½å¢ï¼å¦ææ²¡ææ¢å°éå°±ä¼è®©çº¿ç¨é»å¡ç­å¾ã\n\nå½æä¸ªç±»æ³è¦ä½¿ç¨ aqs æä¾çåºæ¬åè½æ¶ï¼åªéè¦ç»§æ¿å®å¹¶å®ç°é£äºè¿æ²¡æå®ç°çæ¹æ³å°±å¯ä»¥ï¼è¿æ¯å¸åçæ¨¡æ¿æ¹æ³è®¾è®¡æ¨¡å¼ã\n\naqs æ¬èº«æ²¡ææ¢éåè½ï¼å¤§å¤æ°æç« ä¼ä» reentrantlock å¥æï¼ä½æ¯è¿ä¼è®©è¯»èä¹±å¥ï¼åå­¦èå¾å®¹æå¯¹ reentrantlock ä¸ aqs è¿·è¿·ç³ç³åä¸æ¸ï¼æä»¥æ¬ç¯æç« ä¼æ½è±¡è¡¨è¾¾ âå éâ è¿ä¸ªæ¦å¿µï¼ä¹å°±æ¯ä¸è®²è§£å éåè½ï¼èæ¯ç®ç¥çä»¥ âæçº¿ç¨æ¢éå¤±è´¥â æ¥è¡¨è¾¾ã\n\nç­æ aqs æä¾çåè½ä»ç»æ¸æ¥äºåä»ç» reentrantlockãcountdownlatch å¯¹å®çå®ç°ã\n\n\n# 2. aqs çä¸äºéè¦å±æ§\n\n\n# 2.1 node\n\nç°å¨å¯ä»¥æ½ç©ºçä¸ä¸ç®å½ï¼æ¯ä¸æ¯æåæ­¥éååç­å¾éåè¿ä¸¤ä¸ªå°æ é¢ï¼è¿ä¸ªnodeç±»å°±æ¯ç»æåæ­¥éååé»å¡éåçèç¹ãåæ¬æ³è¦å¨åæ­¥éåä¸­ç´æ¥å° node å¼åºï¼ä½æ¯ä¼å æ­¤è®©æç« åå¾æ··ä¹±ï¼æä»¥æå³å®åä»ç»nodeã\n\naqsä¸­æä¸ä¸ªéæåé¨ç±»ï¼nodeãè¿ä¸ªnodeå¯ä»¥æ½è±¡ä¸ºçº¿ç¨ï¼ä¹è®¸è¯´å®å°±ä»£è¡¨ççº¿ç¨æ´å å¦¥å½ã\n\nstatic final class node {\n    // æ­¤nodeä»£è¡¨ççº¿ç¨\n    volatile thread thread;\n    // pre å next ææäºååé¾è¡¨ï¼ç»æaqsçåæ­¥éå\n    // æ­¤nodeçåä¸ä¸ªç»ç¹\n    volatile node prev;\n\t// æ­¤nodeçåä¸ä¸ªèç¹\n    volatile node next;\n    // nextwaiter ææäºååé¾è¡¨ï¼ç»æäºaqsçç­å¾éå\n    node nextwaiter;\n    // èç¹çç¶æ\n    volatile int waitstatus;\n}\n\n\n * next å prev ç¨äºå®ç°åæ­¥éåï¼åºäºååé¾è¡¨ï¼\n * nextwaiter ç¨äºå®ç°ç­å¾éåï¼åºäºåé¾è¡¨ï¼ï¼è¿ä¸ª nextwaiter ç¨äº condition.await()\n\nå ä¸º node ä»£è¡¨ççº¿ç¨ï¼æä»¥å®æä¾äºå ä¸ªç¶æå¼æ¥ä»£è¡¨çº¿ç¨å¨éåä¸­çç¶æ ï¼\n\n// nodeçç¶æé»è®¤ä¸º 0\n\n// æ­¤ä»»å¡å·²åæ¶\nstatic final int cancelled =  1;\n\n// å½åèç¹çä¸ä¸ä¸ªèç¹æèµ·äº\nstatic final int signal    = -1;\n\n// å½åèç¹å¨ç­å¾éåä¸­\nstatic final int condition = -2;\n\n// ä¸å±äº«æ¨¡å¼ç¸å³ï¼å¨å±äº«æ¨¡å¼ä¸­ï¼è¯¥ç¶ææ è¯ç»ç¹ççº¿ç¨å¤äºå¯è¿è¡ç¶æã\nstatic final int propagate = -3;\n\n\nè°æ¥æè¿äºç¶æå¼å¢ï¼waitstatus\n\nçº¿ç¨é½æ¯ä»¥ node å½¢å¼ä¿å­å¨ aqs ä¸­çï¼nodeä¸­æä¾äºå ç§ç¶æä¾çº¿ç¨ä½¿ç¨ï¼ä¾å¦ å·²åæ¶ï¼1ï¼ãé»è®¤ï¼0ï¼ãæèµ·ï¼-1ï¼ãç­å¾ï¼-2ï¼....\n\nåæ¶ï¼å¦æä½ æ­£å¨çæºç ï¼è¿ä¼çå°ä¸¤ä¸ªå±æ§ :\n\n// å±äº«æ¨¡å¼\nstatic final node shared = new node();\n// ç¬å æ¨¡å¼\nstatic final node exclusive = null;\n\n\nshared å exclusive ä¸¤ä¸ªåè¯çææå¾ææ¾ ï¼å±äº«åç¬å ã\n\n 1. ç¬å æ¨¡å¼å³å½éè¢«æä¸ªçº¿ç¨æåè·åæ¶ï¼å¶ä»çº¿ç¨æ æ³è·åå°è¯¥éï¼åä¸æ¶é´åªæä¸ä¸ªçº¿ç¨è½æ¿å°éæ§è¡ï¼éçç¶æåªæ0å1ä¸¤ç§æåµãä¾å¦ reentrantlockï¼ä¸æ¬¡åªæä¸ä¸ªçº¿ç¨å¯ä»¥å·¥ä½ã\n 2. å±äº«æ¨¡å¼å³å½éè¢«æä¸ªçº¿ç¨æåè·åæ¶ï¼å¶ä»çº¿ç¨ä»ç¶å¯è½è·åå°è¯¥éï¼åä¸æ¶é´æå¤ä¸ªçº¿ç¨å¯ä»¥æ¿å°éååå·¥ä½ï¼éçç¶æå¤§äºæç­äº0ãä¾å¦ countdownlatchï¼ä¸æ¬¡å¯ä»¥æå¤ä¸ªçº¿ç¨å·¥ä½ã\n\n\n# 2.2 åæ­¥éå\n\nè¿ä¸ªåæ­¥éåæ¯ç±ååé¾è¡¨å®ç°çãä»ä¸é¢æè¯´çå¯ä»¥ç¥éï¼aqsä¸­çåæ­¥éåæ¯ç±nodeç»æãnodeä¸­çprevånextè¿æ¥ã\n\nåªæèç¹è¯å®ä¸è¡ï¼aqsä¸­æä¸¤ä¸ªå±æ§æ§å¶è¿ä¸ªååé¾è¡¨ï¼head å tail ãå³å¤´åå°¾ãå¤´æ¯ä¸ä¸ªèæèç¹ï¼å®éé¢ç threadåé ä¸ç´æ¯nullå¹¶ä¸ä¼ä»£è¡¨åªä¸ªçº¿ç¨ï¼å°¾æ¯æå·ä½æä¹çï¼ä¼ä»£è¡¨æä¸ä¸ªçº¿ç¨ãå³ï¼å¤´èç¹æ æä¹ï¼å¶ä»èç¹é½ä»£è¡¨ä¸ä¸ªçº¿ç¨ã\n\n\n\næ³¨æå½ï¼åæ­¥éåçå¤´èç¹æ¯æ æä¹çï¼çº¿ç¨å°è£çèç¹ä¸è½æä¸ºå¤´èç¹ï¼åªè½æä¸ºå¤´èç¹åçèç¹ã\n\n\n# 2.3 ç­å¾éå\n\nnodeç»æç­å¾éåï¼nodeä¸­çnextwaiterè¿æ¥æä¸ºç­å¾éåã\n\n\n\nå¥æªçæ¯ï¼å½æå¨aqsä¸­å¯»æ¾ä¸ç®¡çåæ­¥éåçheadåtailç±»ä¼¼çå±æ§æ¶å¹¶æ²¡ææ¾å°ï¼ä½æè¿æ¯æ¾å°äºç®¡çç­å¾éåçå±æ§ï¼firstwaiterãlastwaiter\n\nå®å¨aqså¦ä¸ä¸ªåé¨ç±»ä¸­ ï¼conditionobjectã\n\nè¯´æ¥ä¹æ¯ï¼å°± âç­å¾éåâ è¿ä¸ªè¯èè¨ï¼ç­å¾è¯å®æ¯å®çä¸å¤§ç¹ç¹ãé£ä¹å¦ä½å®ç°ç­å¾ï¼ä¸ä¸ªæ¯objectç±»ä¸­çwaitæ¹æ³ï¼å¦ä¸ä¸ªå°±æ¯ condition ç await æ¹æ³ãé£ä¹å°±å¥½è§£éäºï¼\n\n> conditionobject æä¾äºè®© node ç­å¾çæ¹æ³ï¼ä¾å¦ awaitãsignal...éè¿ node.nextwaiter å°çº¿ç¨ä¸²ä¸ºä¸ä¸ªç­å¾éåï¼å¹¶ä¸ä½¿ç¨ firstwaiter å lastwaiter æ§å¶/ç®¡ç ç­å¾éåã\n\næ³¨æå½ï¼ç­å¾éåç firstwaiter å¯ä¸æ¯æ æä¹çå¦ï¼çº¿ç¨å°è£ä¸º node åå¯ä»¥æä¸º firstwaiter\n\n\n# 2.4 stateç¶æå¼\n\nè¿æ¯ä¸ä¸ªéå¸¸éè¦çå±æ§ã\n\nprivate volatile int state;\n\n\næ¯ç«aqsæä¾çæ¯å¹¶åæ¯æï¼æå¹¶åå°±è¦æéï¼é£ä¹ä¸ä¸ªçº¿ç¨ææ ·æç®æ¿å°éå¢ï¼\n\nstate ä¸ä¸º 0 çæ¶åè¯æè¿ä¸ªéè¢«å æäºã\n\nåæ¶ï¼ç±äº aqs å¹¶æ²¡æè¦æ±å®ç°ç±»å¿é¡»ææ ·ææ ·ï¼æä»¥å®ç°ç±»ä»¬ä¹æ state ç¨çè±éè¡å¨ï¼ä¾å¦ï¼\n\n 1. å¨ reentrantlock ä¸­ï¼state ä¸º 0 ä»£è¡¨éè¿æªè¢«å æï¼å¦æä¸º 1 ä»£è¡¨è¢«å æï¼å¦æå¤§äº 1 ä»£è¡¨éå¥ã\n 2. å¨ countdownlatch ä¸­ï¼state ä»£è¡¨çä»»å¡æ°éã\n 3. å¨ reentrantreadwritelock ä¸­ï¼å° state ç 32 ä¸ªå­èååä¸ºä¸¤é¨åï¼ä¸é¨åè¡¨ç¤ºè¯»éï¼ä¸é¨è¡¨ç¤ºåéã\n\n\n# 2.5 å°ç»\n\n 1. aqsæä¸¤ä¸ªéè¦çå±æ§ï¼nodeåstateã\n\n 2. state æ¯ç¶æå¼ï¼ä¸è¬æ¥è¯´ä»£è¡¨éæ¯å¦è¢«ææï¼ä¸è¿å·ä½å«ä¹è¦çå®ç°ç±»å¦ä½æä½ã\n\n 3. å±äº«åç¬å  ï¼å±äº«æ¯åè®¸å¤ä¸ªçº¿ç¨å±åæ§è¡ä»»å¡ï¼ç¬å æ¯åä¸æ¶é´åªåè®¸ä¸ä¸ªçº¿ç¨æ§è¡\n\n 4. nodeï¼æ¯çº¿ç¨çä»£è¡¨ï¼çº¿ç¨ä¼è¢«å°è£ä¸ºnodeå¨aqsä¸­å­å¨ã\n    \n    nodeä¸­æä¸ä¸ªå±æ§ï¼nextãprevãnextwaiterã\n    \n    * nextåprevè¿æ¥nodeæä¸ºåæ­¥éåãæ§å¶åæ­¥éåçå±æ§ head å tail å¨aqsä¸­ã\n    * nextwaiterè¿æ¥nodeæä¸ºç­å¾éåãæ§å¶ç­å¾éåçå±æ§ firstwaiter å lastwaiter å¨ conditionobject ä¸­ï¼aqsçåé¨ç±»ï¼\n    * ï¼è³äºåæ­¥éååç­å¾éåå°åºæä»ä¹ç¨ï¼ææ³å¨åç»­æ¢æ¢å±å¼ãï¼\n\n\n\n\n# 3. çº¿ç¨å éå¤±è´¥å\n\nå¨ä¸é¢è¯´è¿ï¼aqs èªèº«å¹¶ä¸æä¾å éåè½ï¼èæ¯å®ç°äºå éå¤±è´¥åçé»è¾ãè¿ä¹åæä»ä¹å¥½å¤å¢ï¼\n\nç¨åºåå¯ä»¥æ ¹æ®éè¦è¿è¡å éï¼æ¯å¦ä»¥ä¸åç§éå®ç°æ¶ï¼æ³è¦å éè¦æ»¡è¶³ä»ä¹æ¡ä»¶ï¼\n\n 1. ä¸å¯éå¥é ï¼éä¸è¢«ä»»ä½çº¿ç¨æææ¶æè½å éæå\n 2. å¯éå¥é ï¼éä¸è¢«ä»»ä½çº¿ç¨ææï¼ä½æ¯å¦ææ¯èªå·±ææï¼è¿å¯ä»¥å é\n 3. å¬å¹³é ï¼çº¿ç¨æ¢éä¹ååççææ²¡æå¶ä»çº¿ç¨æ­£å¨ç­å¾ï¼æ²¡æåæ¢éï¼æå°±è·å¨ä»ä»¬åé¢\n 4. éå¬å¹³é ï¼ç®¡å®å¢ç´æ¥æ¢ï¼æ¢ä¸å°åè¯´\n 5. è¯»åé ï¼è¯»éå¯å±äº«ï¼åééææ¥ã\n\nå¦ææ²¡æ aqsï¼è¿äºéå¨å®ç°çæ¶åé½è¦åä¸é âçº¿ç¨æ¢éå¤±è´¥åéè¦é»å¡ç­å¾â çé»è¾ï¼ä»£ç å¤ªåä½äºï¼aqs å¤§æä¸æ¥ï¼æå¸®ä½ ä»¬å®ç°ï¼ç¨åºååªè¦æ ¹æ®ç°å¨çæåµå¤æ­æ¯å¦æ¢éæåå°±è¡äºï¼æ¢éå¤±è´¥ççº¿ç¨äº¤ç»æã\n\né£ä¹ç°å¨å°±æ¥çç aqs å¦ä½å¯¹å¾æ¢éå¤±è´¥ççº¿ç¨çå§ã\n\naqs éè¦å®çå­ç±»å®ç°çæ¹æ³æ¯ ï¼tryacquire()ï¼ä¹å°±æ¯å°è¯è·åéï¼å¦æè·åæåäºå°±æ²¡ aqs è¦å¹²çäºäºï¼ä½æ¯å¦æå¤±è´¥ï¼é£ä¹å°±è¦å¤çå½åçº¿ç¨äºï¼\n\npublic final void acquire(int arg) {\n    // tryacquireè®©å­ç±»å»å®ç°\n    // å¦æè·åéå¤±è´¥ï¼æ§è¡åé¢çé»è¾\n    if (!tryacquire(arg) &&\n        // å°å½åçº¿ç¨å å¥å°åæ­¥éåä¸­ï¼å¹¶ä¸å°çº¿ç¨é»å¡\n        acquirequeued(addwaiter(node.exclusive), arg))\n        // é»å¡åæ­¢åï¼è°ç¨è¯¥çº¿ç¨ç interruptæ¹æ³\n        selfinterrupt();\n}\n\n\ntryacquire æ¹æ³ç±å­ç±»å®ç°ï¼é£ä¹ç°å¨æ¥çç addwaiter ä¸ acquirequeued è¿ä¸¤ä¸ªæ¹æ³\n\n 1. addwaiter ï¼å°å½åçº¿ç¨å°è£ä¸º node å¹¶æ¾å¥åæ­¥éå\n 2. acquirequeued ï¼\n\n\n# 3.1 å°å½åçº¿ç¨å å¥åæ­¥éå\n\næ­¥éª¤åä¸ºä¸¤å¤§æ­¥ï¼æå»ºä¸ä¸ª nodeãæ¾å°éåå°¾é¨ã\n\nä½ æ³æä¸ä¸ª node æ¾å°ååé¾è¡¨çå°¾é¨ï¼å¤§æµæ¯è¿ä¸æ­¥ï¼\n\ntail.next = node;\nnode.pre = tail;\nnode = tail\n\n\nä¹å°±æ¯å°é¾è¡¨å°¾èç¹ç next æéæåèªå·±ï¼èªå·±ç pre æéæåå°¾èç¹ï¼æåèªå·±åæäºå°¾èç¹ã\n\nä½æ¯æ¾å¥éåå°¾é¨è¿ä¸ªå¨ä½è¯´å¾è½»å·§ï¼é®é¢å°±åºå¨è¿éï¼å½å¤ä¸ª node æ³è¦æå¨åä¸ä¸ªå°¾èç¹ä¸æ¶ï¼ä¼åºç°å¹¶åæåµãä½æ¯ææå¾ç»å¾äºð\n\naqs è§£å³å¹¶åæåµæ¯è¿æ ·åç ï¼åå° node.pre = tailï¼åä½¿ç¨ cas å° node æä¸ºå°¾èç¹ï¼æåå° node.pre.next = nodeï¼å¦æ cas å¤±è´¥ï¼è¯´æç°å¨åºç°å¹¶åæåµäºï¼å«ççº¿ç¨æ¢åä¸æ­¥å° node åæäºå°¾èç¹ï¼æ­¤çº¿ç¨ç node åªè½æå¨é£ä¸ª node åé¢äºã\n\n// è°ç¨æ¥æº : addwaiter(node.exclusive)\n// ä½¿ç¨ node.exclusive ä½ä¸º mode çå¥åï¼modeä¸ºç©ºã\nprivate node addwaiter(node mode) {\n    // å°æ­¤çº¿ç¨å°è£ä¸ºç¬å æ¨¡å¼ç node\n    node node = new node(thread.currentthread(), mode);\n    // è·åé»å¡éåçå°¾èç¹\n    node pred = tail;\n   \n    if (pred != null) {\n        // å¦æå°¾èç¹ä¸ä¸ºç©ºï¼ææ­¤èç¹æå¨å°¾èç¹åé¢\n        // é¦åæ§è¡ node.pre = pred\n        node.prev = pred;\n        // ç¶åä½¿ç¨casçæ¹å¼å°nodeè®¾ç½®ä¸ºå°¾èç¹\n        // å¦æè®¾ç½®æåï¼å°±å¯ä»¥å°ä¹åå°¾èç¹çnextæåç°å¨çå°¾èç¹: pred.next = node\n        if (compareandsettail(pred, node)) {\n            pred.next = node;\n            // ä¸è¬æåµä¸ä¼å¨è¿éreturn\n            return node;\n        }\n    }\n    // å¦æåé¢æ²¡æreturnï¼è¯´æä»ä¹ï¼\n    // è¯´æcaså¤±è´¥äºï¼ä¹å°±æ¯åºç°äºå¹¶åè®¾ç½®å°¾èç¹çæåµï¼å³: å¤ä¸ªçº¿ç¨è®¾ç½®å°¾èç¹ï¼è¿ä¸ªçº¿ç¨è®¾ç½®å¤±è´¥äºã\n    // è½ç¶å¤±è´¥äºï¼é£è¿ä¸ªèç¹å¯ä»¥æå¨æ°æ¥çå°¾èç¹ä¸å~ \n    // æä»¥è¿ä¸ªæ¹æ³çé»è¾å°±æ¯å°æ­¤èç¹æå¨æ°æ¥çå°¾èç¹ä¸ï¼å°±ä¸åè¯¦ç»è§£éäº\n    enq(node);\n    return node;\n}\n\n// ç¨ cas å°å°¾èç¹çå¼ä» expect æ¢æ update\nprivate final boolean compareandsettail(node expect, node update) {\n    return unsafe.compareandswapobject(this, tailoffset, expect, update);\n}\n\n\n\n# 3.2 å°å½åçº¿ç¨é»å¡\n\næ­¤æ¶ï¼node å·²ç»æä¸ºåæ­¥éåä¸­çå°¾èç¹äºï¼ä½æ¯çº¿ç¨è¿æ²¡æé»å¡ï¼aqs è¦åçå°±æ¯è®©æ¢éå¤±è´¥ççº¿ç¨é»å¡ï¼æä»¥è¿ä¸ªæ¹æ³è³å³éè¦ã\n\nä¸ä¸æ¥å°±æ¯æ­»å¾ªç¯ï¼å½åèç¹è½ç¶æ¯å°¾èç¹ï¼ä½æ¯å¦æå®ç pre æ¯å¤´èç¹ä»£è¡¨å¥ï¼ä»£è¡¨åæ­¥éåä¸­åªæå®ä¸ä¸ªçº¿ç¨ï¼é£æå°±å¾éæ°æ¢ä¸ä¸éäºï¼å¦ææ¢å¤±è´¥äºæåé»å¡ã\n\nfinal boolean acquirequeued(final node node, int arg) {\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            // æ¿å°å½åèç¹çåä¸ä¸ªèç¹ï¼\n            // å¦ææ¯headèç¹ï¼å¯ä»¥å°è¯æ¢ä¸ä¸é\n            final node p = node.predecessor();\n            // å¦æå½åèç¹çåä¸ä¸ªèç¹æ¯headèç¹ï¼å°è¯æ¢é\n            if (p == head && tryacquire(arg)) {\n                // å¦ææ¢éæåï¼å°æ­¤èç¹åæheadåå¡èç¹\n                // sethead() æ¹æ³é¦åä¼å° nodeåé¨ççº¿ç¨ç½®ä¸ºç©ºï¼ä¸ºå¥ç½®ä¸ºç©ºï¼\n                // é½æ¢å°éäºï¼è¿ä¸ªçº¿ç¨è¯å®ä¸éè¦å­å¨äºaqsä¸­äºã\n                sethead(node);\n                // ä¹åçheadèç¹ç½®ä¸ºç©ºï¼æ¹ä¾¿gc\n                p.next = null; \n                failed = false;\n                return interrupted;\n            }\n            // æ­¤èç¹çä¸ä¸ä¸ªèç¹ä¸æ¯å¤´èç¹ï¼æèæ¢éå¤±è´¥ï¼å°å½åçº¿ç¨ park èµ·æ¥\n            if (\n                // æ£æ¥ä¸ä¸èç¹çç¶æï¼å¦æå·²åæ¶å°±æ²¡å¿è¦é»å¡ç­å¾\n                shouldparkafterfailedacquire(p, node) &&\n                // è¿ä¸ªæ¹æ³å°å½åçº¿ç¨parkèµ·æ¥\n                parkandcheckinterrupt()\n               )\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelacquire(node);\n    }\n}\n\n// å°nodeåé¨ççº¿ç¨ç½®ä¸ºç©ºï¼åææ æä¹ç head èç¹\nprivate void sethead(node node) {\n    head = node;\n    node.thread = null;\n    node.prev = null;\n}\n\n// å°å½åçº¿ç¨parkèµ·æ¥\nprivate final boolean parkandcheckinterrupt() {\n    // â çº¿ç¨é»å¡å¨æ­¤å¤ç­å¾å¤é \n    locksupport.park(this);\n    // è¿åå¯¹åºçº¿ç¨çä¸­æ­æ å¿ä½ï¼å¹¶ä¸å°ä¸­æ­æ å¿ä½éç½®åä¸ºfalse\n    return thread.interrupted();\n}\n\n\næ³¨æ ï¼å½éè¢«éæ¾æ¶ï¼åªä¼å¤éåæ­¥éåä¸­ç¬¬ä¸ä¸ªèç¹ï¼ä¹å°±æ¯ head.nextãï¼è¿ä¸ªä¼å¨éæ¾éçé»è¾ä¸­è¯´ï¼\n\nå½é»å¡ççº¿ç¨è¢«å¤éï¼ä¹å°±ä»£è¡¨æ­¤èç¹æ¯ head.nextï¼é£ä¹æ­»å¾ªç¯ä¸­ç if æ¡ä»¶å°±å¯ä»¥èµ°éäºï¼äºæ¯æ­¤èç¹ä¼ä½¿ç¨ tryacquire å°è¯è·åéï¼å¦æè·åæåå°±éåºå¾ªç¯ï¼å¦æè·åå¤±è´¥å°±è¿è¦é»å¡ã\n\n\n# 4. éæ¾éå\n\naqså½ç¶ä¸ä¼ç®¡æä¹éæ¾éï¼éæ¾éçé»è¾è®©å­ç±»å»å®ç°ï¼æ¯å¦ä¸å¯éå¥éç´æ¥éæ¾ï¼å¯éå¥éè¿è¦å¤æ­ä¸ä¸æ¯å¦éå¥ã\n\naqs å®ç°çæ¯ä¹åè¢«é»å¡ççº¿ç¨æä¹åçé»è¾ã\n\npublic final boolean release(int arg) {\n    // éæ¾éçé»è¾è®©å­ç±»å®ç°\n    // ä¸æ¦éæ¾æåï¼aqså°±å¼å§å¤éåæ­¥éåä¸­çç¬¬ä¸ä¸ªèç¹\n    if (tryrelease(arg)) {\n        // æ¿å°å¤´èç¹\n        node h = head;\n        if (h != null && h.waitstatus != 0)\n            // å¤éå¤´èç¹åé¢é£ä¸ªèç¹\n            unparksuccessor(h);\n        return true;\n    }\n    return false;\n}\n\n\nä¸åºæå¤çæåµä¸æ¯ç´æ¥å¤é head.next é£ä¸ªçº¿ç¨ï¼ä½æ¯ä¸åºæå¤çæåµä¸è¦åºæå¤äº ï¼\n\nhead åçç¬¬ä¸ä¸ªèç¹ä¸ºç©ºï¼æèè¯´å®çç¶æä¸ºåæ¶ï¼é£ä¹å°±ä»åæ­¥éåçå°¾é¨ååå¯»æ¾ä¸ä¸ªææä¹çèç¹å°å®å¤éï¼æ³¨æåªæ¾ä¸ä¸ªå¦ã\n\nå¹¶ä¸æä¸ä¸ªå°ç»è ï¼å¦ænodeçç¶æä¸ºåæ¶ï¼å®ä¸ä¼ä»åæ­¥éåä¸­ç§»é¤ï¼è¿ä¸ªç»èå¨ condition ä¸­ä¼æ¶å\n\n// æ­¤æ¶ä¼ å¥çnodeä¸ºå¤´èç¹\nprivate void unparksuccessor(node node) {\n    int ws = node.waitstatus;\n    if (ws < 0)\n        compareandsetwaitstatus(node, ws, 0);\n\t// æ¿å°å¤´èç¹åé¢çç¬¬ä¸ä¸ªèç¹\n    node s = node.next;\n    // ä¸è¬æ¥è¯´ä¸ä¼èµ°è¿éï¼èæ¯ä¸é¢é£ä¸ªifï¼ç´æ¥å°çº¿ç¨å¤éã\n    // ä½æ¯èµ°è¿éçé»è¾æ¯å ä¸ºå¥å¢ï¼\n    // waitstatuså¨ä¸é¢æè®²è§£ï¼èç¹ç waitstatus > 0ä»£è¡¨æ­¤èç¹å·²ç»åæ¶\n    // æä»¥é»è¾å°±æ¯ï¼å¦æ head.next ä¸ºç©ºæèå·²ç»åæ¶ï¼å°±ä»åæ­¥éåçå°¾é¨å¼å§å¾åå¯»æ¾ï¼\n    // ç´å°æ¾å°ä¸ä¸ªæ²¡æåæ¶çèç¹\n    if (s == null || s.waitstatus > 0) {\n        s = null;\n        for (node t = tail; t != null && t != node; t = t.prev)\n            if (t.waitstatus <= 0)\n                s = t;\n    }\n    // ç´æ¥å°è¿ä¸ªçº¿ç¨å¤éäº\n    if (s != null)\n        locksupport.unpark(s.thread);\n}\n\n\næ­¥éª¤ ï¼æ¿å°å¤´èç¹åçç¬¬ä¸ä¸ªææä¹çèç¹ï¼å¦æè¿ä¸ªèç¹çç¶æä¸ºåæ¶ï¼è¯´æè¿ä¸ªèç¹åä»ç­å¾éåæ¾å°åæ­¥éåï¼è·³è¿å®ä»éåçå°¾é¨å¼å§æ¾ç¶ææ­£å¸¸çï¼æ¾å°ä¹åå°å®å¤é\n\nææçº¿ç¨çæ§è¡é½é»å¡å¨ acquirequeued æ¹æ³åé¨ï¼è¿ä¸ªä½ å¯ä»¥åä¸ç¿»ï¼ææè¯´ã\n\n\n# 5. condition\n\nå¯è½åè¯´å® aqs å°±è¯´ condition ä¼æäºå²è£æï¼å ä¸ºå¾é¾æ³è±¡ condition ä¸ aqs æå¥å³ç³»ï¼å¯¹ï¼æå³ç³»ï¼è¿è®°å¾ aqs ç node ä¸­æä¸ä¸ªæååé ï¼nextwaiter\n\næå¨ä¹åè¯´è¿ï¼aqs æ¬èº«çé»è¾å¹¶æ²¡æç¨å°è¿ä¸ªåéï¼èæ¯å¨ conditionobject ä¸­ä½¿ç¨å°äºï¼æä»¥ aqs ä¸­ç¬¬äºä¸ªéååºç°äº ï¼ç­å¾éå\n\nç¬è®°\n\nè¯·ä½ æ³¨æç­å¾éåä¸åæ­¥éåçåºå«ãä¸è¦å°äºèæ··ä¸ºä¸è°\n\nstatic final class node {\n    // æ­¤nodeä»£è¡¨ççº¿ç¨\n    volatile thread thread;\n    // ç¨äºåæ­¥éåï¼æ­¤nodeçåä¸ä¸ªç»ç¹\n    volatile node prev;\n\t// ç¨äºåæ­¥éåï¼æ­¤nodeçåä¸ä¸ªèç¹\n    volatile node next;\n    // ç¨äºç­å¾éåï¼ç­å¾éåæ¯ä¸ä¸ªååé¾è¡¨ç»æçéå\n    node nextwaiter;\n    // èç¹çç¶æ\n    volatile int waitstatus;\n    // çç¥å¶ä»åé\n}\n\n\nå¸¸ç¨çè®©çº¿ç¨ç­å¾çæ¹æ³æä¸¤ç§ ï¼\n\n 1. object.wait()\n 2. condition.await()\n\nè½ç¶å®ç°ä¸ä¸æ ·ï¼ä½æ¯åçæ¯ä¸æ ·çï¼çº¿ç¨ç­å¾çåæè¯å®æ¯å·²ç»æ¥æéäºï¼è°ç¨ wait åä¼éæ¾éç¶åé»å¡ãè°ç¨ signal å°çº¿ç¨ä»ç­å¾ç¶æå¤éï¼è¿å¥é»å¡ç¶æï¼å¯ä»¥æ¢éã\n\n\n# 5.1 condition.await()\n\nå¦ææ¯ä½ ï¼ä½ ä¼å¦ä½åå© aqs æ¥å®ç° condition.await() å¢ï¼ä¸å°±æ¯éæ¾éä¹åé»å¡å~\n\n 1. å°æ­¤çº¿ç¨å°è£ä¸º node å¹¶æ¾å¥ç­å¾éå\n 2. è°ç¨ aqs ç release éæ¾é\n 3. å°å½åçº¿ç¨é»å¡\n\nå¯¹ï¼å°±æ¯è¿ä¸æ­¥ï¼æ¥çç aqs ä¸­ç conditionobject å¦ä½å®ç°è¿ä¸æ­¥ç ï¼\n\npublic final void await() throws interruptedexception {\n    if (thread.interrupted())\n        throw new interruptedexception();\n    // å°å½åçº¿ç¨å°è£ä¸ºnodeï¼nodeçç¶æä¸º-2ï¼ä¹å°±æ¯ç­å¾ï¼ç¶åæ¾å¥ç­å¾éå\n    // è¿æ¶ä¼å° node.waitstatus æ¹ä¸º condition\n    node node = addconditionwaiter();\n    // è°ç¨ release æ¹æ³éæ¾é\n    // è¿æ¶ä¼å° node.waitstatus æ¹ä¸º cancelled â è¿éç¹å«éè¦ï¼ï¼ï¼ï¼ï¼\n    // åæ¬¡å¼ºè°ï¼è¿éä¼å° node.waitstatus æ¹ä¸º cancelled \n    int savedstate = fullyrelease(node);\n    int interruptmode = 0;\n    // å¤æ­ node èç¹çç¶æ\n    // ç¬¬ä¸æ¬¡è¿å¥æ¶é½ä¼è¿åfalseï¼åååä¼è¿å¥æ¹æ³å°çº¿ç¨é»å¡\n    while (!isonsyncqueue(node)) {\n        locksupport.park(this);\n        if ((interruptmode = checkinterruptwhilewaiting(node)) != 0)\n            break;\n    }\n    // çº¿ç¨ä»ç­å¾ç¶ææ¢å¤åï¼è¿å¥åæ­¥éåç­å¾æ¢éï¼è¿éçé»è¾å°±æ¯ä¸é¢è¯´è¿äºçã\n    if (acquirequeued(node, savedstate) && interruptmode != throw_ie)\n        interruptmode = reinterrupt;\n    if (node.nextwaiter != null) // clean up if cancelled\n        unlinkcancelledwaiters();\n    if (interruptmode != 0)\n        reportinterruptafterwait(interruptmode);\n}\n\n\n\n# 5.2 condition.signal()\n\nå¦ææ¯ä½ ï¼ä½ ä¼å¦ä½åå© aqs æ¥å®ç° condition.signal() å¢ï¼ä¸å°±æ¯å¤ééãæå®å å¥åæ­¥éåå~\n\ncondition.signal() ä¼å¤éå¨ç­å¾éåä¸­ç­å¾æ¶é´æé¿çèç¹ï¼é¦èç¹ï¼\n\n// ä¼ å¥çæ¯ç­å¾éåçå¤´èç¹ï¼çº¿ç¨æ¯å¯ä»¥æä¸ºå¤´èç¹çï¼\nprivate void dosignal(node first) {\n    do {\n        // ä¸è¬ä¸ä¼èµ°è¿é\n        if ( (firstwaiter = first.nextwaiter) == null)\n            lastwaiter = null;\n        // å°å¤´èç¹çnextæéç½®ä¸ºç©º\n        first.nextwaiter = null;\n    } while (!transferforsignal(first) &&\n             (first = firstwaiter) != null);\n}\n\n\nfinal boolean transferforsignal(node node) {\n    if (!compareandsetwaitstatus(node, node.condition, 0))\n        return false;\n    // å°è¯¥èç¹å å¥åæ­¥éåå°¾é¨\n    node p = enq(node);\n    // ååå¨ awaitæ¹æ³ä¸­ï¼æç¹å«å¼ºè°äºï¼fullyrelease æ¹æ³ä¼å°èç¹çç¶ææ¹ä¸ºåæ¶\n    // ä¹å°±æ¯ node.waitstatus = 1, å³ ws = 1\n    int ws = p.waitstatus;\n    if (ws > 0 || !compareandsetwaitstatus(p, ws, node.signal))\n        locksupport.unpark(node.thread);\n    return true;\n}\n\n\næè ï¼ä¸ºå¥è°ç¨ await() æ¹æ³è®©çº¿ç¨éæ¾éåï¼çº¿ç¨ node çç¶æä¼åæåæ¶ï¼node.waitstatus = 1ï¼å¢ï¼\n\nå ä¸º signal æ¹æ³çæ­¥éª¤ä¸º ï¼\n\n 1. å° node æ¾å¥åæ­¥éå\n 2. å°çº¿ç¨å¤é\n\nå° node æ¾å¥åæ­¥éååï¼ä¸ä¸è¢«å¤éäºæä¹åï¼é£å°±è¦éè¿ä¸äºææ®µé²æ­¢è¿ç§æ¦çç¹å«å°çæåµåºç°ï¼ä¹å°±æ¯çº¿ç¨è°ç¨ await() è¿å¥ç­å¾ä¹ååå° node çç¶æåæ åæ¶ï¼é£ä¹å°±ä¸ä¼è¢«è¯¯å¤éï¼çå¼åã\n\ncondition ç singalall æ¹æ³ï¼ç¸å½äºå¯¹ç­å¾éåçæ¯ä¸ªèç¹åæ§è¡ä¸æ¬¡ singal æ¹æ³ï¼ææå°±æ¯å°ç­å¾éåä¸­ææèç¹å¨é¨ç§»å¨å°åæ­¥éåï¼å¹¶å¤éæ¯ä¸ªèç¹ççº¿ç¨ã\n\n\n# 5. æ»ç»\n\nè³æ­¤ï¼aqs çæ ¸å¿åè½å·²ç»è¯´å®äºï¼æ²¡æè®²å éãéæ¾éï¼å ä¸ºå éãéæ¾éçé»è¾æ¬æ¥å°±ä¸æ¯ aqs è¦å®æçåã\n\næä»¥å éä¸éæ¾éæä¼å¨ reentrantlockãcountdownlatchãreadwritelock ä¸­è®²ã",charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"ReentrantReadWriteLock æºç è§£æ",frontmatter:{title:"ReentrantReadWriteLock æºç è§£æ",date:"2023-12-22T16:33:45.000Z",permalink:"/pages/6cfda5/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/70.ReentrantReadWriteLock.html",relativePath:"02.æç« /75.Javaå¹¶å/70.ReentrantReadWriteLock.md",key:"v-b5de3650",path:"/pages/6cfda5/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. ç±»ç»æ",slug:"_2-ç±»ç»æ",normalizedTitle:"2. ç±»ç»æ",charIndex:971},{level:2,title:"3. è¯»åééè¦çåé",slug:"_3-è¯»åééè¦çåé",normalizedTitle:"3. è¯»åééè¦çåé",charIndex:1158},{level:2,title:"4. å åé",slug:"_4-å åé",normalizedTitle:"4. å åé",charIndex:2271},{level:2,title:"5. å è¯»é",slug:"_5-å è¯»é",normalizedTitle:"5. å è¯»é",charIndex:3348}],headersStr:"1. ç®è¿° 2. ç±»ç»æ 3. è¯»åééè¦çåé 4. å åé 5. å è¯»é",content:'# 1. ç®è¿°\n\nåé¢å·²ç»ä»ç»äº AQSãReentrantLock çå®ç° ï¼\n\n * AQS ï¼\n * ReentrantLock\n\næ¬ç¯æç« ä¼ä»ç» ReentrantReadWriteLockï¼å¯éå¥è¯»åéï¼ï¼ä»åå­å¯ä»¥çåºæ¥ï¼è¿ä¸ªéå®ç°äº ReentrantLock + ReadWriteLock çåè½ï¼ä¹å°±æ¯ä¸ä»å¯ä»¥éå¥ãå¬å¹³ãéå¬å¹³ï¼è¿æä¾äºè¯»éãåéã\n\nå¨ä¸è¬æåµä¸ï¼ReentrantReadWriteLock è· ReentrantLock çåè½ä¸æ ·ï¼é½åªæä¾ å¯éå¥ãå¬å¹³éãéå¬å¹³éãã\n\nä½æ¯ ReentrantReadWriteLock ä¹æä¾äº è¯»éãåéï¼ä¸è¿éè¦æ¾å¼è·åè¯»ãåéã\n\n// åå»ºè¯»åéï¼è¿ä¸ªéçåè½è· ReentrantLock ä¸æ ·\nfinal ReentrantReadWriteLock readWriteLock = new ReentrantReadWriteLock();\n// è·å¾è¯»é\nfinal ReentrantReadWriteLock.ReadLock readLock = readWriteLock.readLock();\n// è·å¾åé\nfinal ReentrantReadWriteLock.WriteLock writeLock = readWriteLock.writeLock();\n\n// è¯»éä½¿ç¨\nreadLock.lock();\ntry {\n    // ä¸å¡ä»£ç ...\n} finally {\n    readLock.unlock();\n}\n\n// åéä½¿ç¨\nwriteLock.lock();\ntry {\n    // ä¸å¡ä»£ç ...\n} finally {\n    writeLock.unlock();\n}\n\n\nä»ä¹å«åè¯»åéï¼\n\n * è¯»é ï¼å¤ç»çº¿ç¨å¯ä»¥å±äº«è¯»éï¼å äºè¯»éä¸è½åå åéï¼ä½æ¯è¿å¯ä»¥å è¯»é\n * åé ï¼åéç¬å ï¼åªè¦æä¸ä¸ªåéï¼å°±ä¸è½å­å¨å¶ä»ä»»ä½éã\n\nä¹å°±æ¯ è¯»å±äº«ï¼åç¬å ãå¹¶ä¸ ReentrantReadWriteLock å®ç°äºééçº§ ï¼è·ååéåï¼å¯ä»¥å¨éæ¾åéåè·åè¯»éï¼å®ç°äºæ ç¼è¡æ¥ã\n\nå®ç°ééçº§æå¥å¥½å¤å¢ï¼ééçº§æ¯éæ¾åéåå è¯»éï¼ä¹å°±æ¯æ­¤çº¿ç¨æ³è¦è·åæ¬çº¿ç¨ä¿®æ¹ä¹åçææ°çæ°æ®ã\n\n\n# 2. ç±»ç»æ\n\næç§æ¯ä¾ï¼å éé»è¾ä»ç¶æ¯éåé¨çåä¸ª Sync å®ç°çãå¬å¹³äºéå¬å¹³éå°±ä¸è¯´äºï¼è¿éåªä»ç»è¯»éä¸åéã\n\n * Sync ï¼åé¨åå«è¯»åéçå®ç°ä»¥åå®ç°è¯»åééè¦çåé\n * ReadLock ï¼è°ç¨ Sync åç tryReadLock å°è¯è·åè¯»éã\n * WriteLock ï¼è°ç¨ Sync åç tryWriteLock å°è¯è·ååéã\n\n\n# 3. è¯»åééè¦çåé\n\nå®ç°è¯»åééè¦çä¾¿ä»¤é½å¨ Sync ç±»ä¸­ï¼å½ç¶äºï¼æéè¦çè¿å¾æ¯ AQS ä¸­ç stateã\n\nå¨ ReentrantLock ä¸­ï¼state è¡¨ç¤ºéå¥äºå æ¬¡ï¼å¨è¯»åéä¸­ä¹ç¨è¿ä¸ªåéï¼ä¸è¿å°å®åæä¸¤åï¼å ä¸º state æ 32 ä¸ªäºè¿å¶ä½ï¼æä»¥è¯»éãåéæ¯äººä¸å ï¼\n\n * state çé«16ä½ ï¼è¡¨ç¤ºè¯»é ï¼è¡¨ç¤ºæ 1 ~ n ä¸ªè¯»é\n * state çä½16ä½ ï¼è¡¨ç¤ºåéï¼åªè½ç±ä¸ä¸ªçº¿ç¨å æï¼å¯ä»¥éå¥\n\n//è¯» å éåçç¹\nstatic final int SHARED_SHIFT   = 16;\n//è¯»éæå°åä½ï¼åå¥½è¡¨ç¤ºå½åæ¥æä¸ä¸ªè¯»éçº¿ç¨\n// 00000000 00000001 00000000 00000000\nstatic final int SHARED_UNIT    = (1 << SHARED_SHIFT);\n\n// æ¯ææå¤§è¯»åæ¬¡æ°\nstatic final int MAX_COUNT      = (1 << SHARED_SHIFT) - 1;\n\n// åéæ©ç \n// 00000000 00000000 11111111 11111111\n// è®¡ç®æ¶å¾æ¹ä¾¿ï¼state &  EXCLUSIVE_MASK å°±å¯ä»¥å¾å°åéæ°é\nstatic final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1;\n\n\nstate çé«åå­ä½è¡¨ç¤ºè¯»çº¿ç¨æ°éï¼é£ä¹æä¹è¡¨ç¤ºæ¯ä¸ä¸ªçº¿ç¨éå¥äºå¤å°æ¬¡å¢ï¼é£å°±åªè½å­å¨å¨åä¸ªçº¿ç¨éé¢ï¼åªä¸ªå·¥å·å¯ä»¥å®ç°çº¿ç¨ç§æåéå¢ï¼ThreadLocal\n\nstatic final class ThreadLocalHoldCounter\n    extends ThreadLocal<HoldCounter> {\n    public HoldCounter initialValue() {\n        return new HoldCounter();\n    }\n}\n\nstatic final class HoldCounter {\n    int count = 0;\n    final long tid = getThreadId(Thread.currentThread());\n}\n\n\næ¯ä¸ä¸ªçº¿ç¨é½æä¸ä¸ª HoldCounterï¼æ¯ä¸ä¸ª HoldCounter ä¸­é½è®°å½ççº¿ç¨ id ä¸ è¯¥çº¿ç¨è·åäºå¤å°æ¬¡è¯»éã\n\nåééå¥æä¹è¡¨ç¤ºå¢ï¼æ­£å¸¸ç¨ state è¡¨ç¤ºåï¼åéåªè½æä¸ä¸ªçº¿ç¨å æï¼é£ä¹ state çä½16ä½å°±å¯ä»¥è¡¨ç¤ºå½åæ¢å åéçº¿ç¨çéå¥æ¬¡æ°äºã\n\n\n# 4. å åé\n\nå åéçé»è¾ç¸å¯¹ç®åï¼ç±äºåéä¸è¯»éä¸è½å±å­ï¼åå¤æ­ææ²¡æå¶ä»çº¿ç¨å æ® è¯»/åéï¼æ²¡æå°±å ï¼æå°±ç­å¾ã\n\n * state != 0 && è¯»é == 0 ï¼è¯´ææçº¿ç¨å æ®äºåéï¼ççæ¯ä¸æ¯èªå·±ï¼å¦ææ¯èªå·±å¯ä»¥éå¥\n * state != 0 && åé == 0 ï¼è¯´ææçº¿ç¨å æ®äºè¯»éï¼è¯»éä¸åéä¸è½å±å­ï¼å¹¶ä¸ä¸æ¯æè¯»éåçº§ä¸ºåéã\n\nfinal boolean tryWriteLock() {\n    // è·åå½åçº¿ç¨\n    Thread current = Thread.currentThread();\n    // è·å AQS ä¸­çç¶æ\n    int c = getState();\n    // å¦æc != 0ï¼è¯´æè¦ä¹åéè¢«å æ®ï¼è¦ä¹è¯»éè¢«å æ®\n    // å¦ææ¯èªå·±å æ®äºåéï¼é£å°±å¯ä»¥éå¥\n    if (c != 0) {\n        // è·ååéæ¯å¦è¢«éå¥ï¼å¦æw == 0ï¼è¯´æåéæ²¡æè¢«å æ®\n        // c != 0 å¹¶ä¸ w == 0 è¯´ææ²¡æå«ççº¿ç¨å æ®åéï¼åªå æ®äºè¯»é\n        // å¦æ w != 0ï¼è¯´æåéè¢«å æ®äºï¼é£å°±ççæ¯ä¸æ¯èªå·±ï¼å¦ææ¯èªå·±å°±å¯ä»¥éå¥\n        int w = exclusiveCount(c);\n        if (w == 0 || current != getExclusiveOwnerThread())\n            return false;\n        if (w == MAX_COUNT)\n            throw new Error("Maximum lock count exceeded");\n    }\n    // å¦æ c == 0ï¼è¯´æéæ²¡æè¢«æ¢ï¼å¯ä»¥å°è¯æ¢é\n    if (!compareAndSetState(c, c + 1))\n        // æ¢éå¤±è´¥è¿åfalse\n        return false;\n    // æ¢éæåï¼å°ç¬å çº¿ç¨åæèªå·±ï¼è¿å true\n    setExclusiveOwnerThread(current);\n    return true;\n}\n\nstatic int exclusiveCount(int c) { \n    return c & EXCLUSIVE_MASK; \n}\n\n\nReentrantReadWriteLock ä¸æ¯æè¯»éåçº§ä¸ºåéï¼æä»¥å¨å åéæ¶ä¸éè¦å¤æ­ä¹åææ²¡æè¯»éã\n\n\n# 5. å è¯»é\n\nReentrantReadWriteLock å è¯»éçè¿ç¨æ¯è¾å¤æï¼å ä¸ºæ¯æéçéçº§ï¼å³æ¯æå·²ç»æ¥æåéçæåµä¸åå»è·åè¯»éãæä»¥å¨å è¯»éçæ¶åï¼å¤æ­æ¡ä»¶å°±å¤ä¸ç¹ã\n\nfinal boolean tryReadLock() {\n    // è·åå½åçº¿ç¨\n    Thread current = Thread.currentThread();\n    // æ­»å¾ªç¯\n    for (;;) {\n        // è·å AQS çå½åç¶æ\n        int c = getState();\n        // å¦æç°å¨å·²ç»æåéï¼å¹¶ä¸æ¿å°åéçä¸æ¯èªå·±ï¼é£å°±ä¸è½å è¯»é\n        // å¦ææ¯èªå·±ï¼è¯´æè¦è¿è¡ééçº§\n        if (exclusiveCount(c) != 0 &&\n            getExclusiveOwnerThread() != current)\n            return false;\n        // è·åè¯»éççº¿ç¨çæ°éï¼å¤ªå¤äºå°±ä¸è®©è·åäº\n        int r = sharedCount(c);\n        if (r == MAX_COUNT)\n            throw new Error("Maximum lock count exceeded");\n        // å°è¿éå°±æ¯è·åå±äº«è¯»éçè¿ç¨\n        if (compareAndSetState(c, c + SHARED_UNIT)) {\n            // è®°å½ç¬¬ä¸ä¸ªæ¥æè¯»éççº¿ç¨\n            if (r == 0) {\n                firstReader = current;\n                firstReaderHoldCount = 1;\n            } else if (firstReader == current) {\n                firstReaderHoldCount++;\n            } else {\n                // å½åçº¿ç¨ç HoldCounter.count ++ \n                HoldCounter rh = cachedHoldCounter;\n                if (rh == null || rh.tid != getThreadId(current))\n                    cachedHoldCounter = rh = readHolds.get();\n                else if (rh.count == 0)\n                    readHolds.set(rh);\n                rh.count++;\n            }\n            return true;\n        }\n    }\n}\n',normalizedContent:'# 1. ç®è¿°\n\nåé¢å·²ç»ä»ç»äº aqsãreentrantlock çå®ç° ï¼\n\n * aqs ï¼\n * reentrantlock\n\næ¬ç¯æç« ä¼ä»ç» reentrantreadwritelockï¼å¯éå¥è¯»åéï¼ï¼ä»åå­å¯ä»¥çåºæ¥ï¼è¿ä¸ªéå®ç°äº reentrantlock + readwritelock çåè½ï¼ä¹å°±æ¯ä¸ä»å¯ä»¥éå¥ãå¬å¹³ãéå¬å¹³ï¼è¿æä¾äºè¯»éãåéã\n\nå¨ä¸è¬æåµä¸ï¼reentrantreadwritelock è· reentrantlock çåè½ä¸æ ·ï¼é½åªæä¾ å¯éå¥ãå¬å¹³éãéå¬å¹³éãã\n\nä½æ¯ reentrantreadwritelock ä¹æä¾äº è¯»éãåéï¼ä¸è¿éè¦æ¾å¼è·åè¯»ãåéã\n\n// åå»ºè¯»åéï¼è¿ä¸ªéçåè½è· reentrantlock ä¸æ ·\nfinal reentrantreadwritelock readwritelock = new reentrantreadwritelock();\n// è·å¾è¯»é\nfinal reentrantreadwritelock.readlock readlock = readwritelock.readlock();\n// è·å¾åé\nfinal reentrantreadwritelock.writelock writelock = readwritelock.writelock();\n\n// è¯»éä½¿ç¨\nreadlock.lock();\ntry {\n    // ä¸å¡ä»£ç ...\n} finally {\n    readlock.unlock();\n}\n\n// åéä½¿ç¨\nwritelock.lock();\ntry {\n    // ä¸å¡ä»£ç ...\n} finally {\n    writelock.unlock();\n}\n\n\nä»ä¹å«åè¯»åéï¼\n\n * è¯»é ï¼å¤ç»çº¿ç¨å¯ä»¥å±äº«è¯»éï¼å äºè¯»éä¸è½åå åéï¼ä½æ¯è¿å¯ä»¥å è¯»é\n * åé ï¼åéç¬å ï¼åªè¦æä¸ä¸ªåéï¼å°±ä¸è½å­å¨å¶ä»ä»»ä½éã\n\nä¹å°±æ¯ è¯»å±äº«ï¼åç¬å ãå¹¶ä¸ reentrantreadwritelock å®ç°äºééçº§ ï¼è·ååéåï¼å¯ä»¥å¨éæ¾åéåè·åè¯»éï¼å®ç°äºæ ç¼è¡æ¥ã\n\nå®ç°ééçº§æå¥å¥½å¤å¢ï¼ééçº§æ¯éæ¾åéåå è¯»éï¼ä¹å°±æ¯æ­¤çº¿ç¨æ³è¦è·åæ¬çº¿ç¨ä¿®æ¹ä¹åçææ°çæ°æ®ã\n\n\n# 2. ç±»ç»æ\n\næç§æ¯ä¾ï¼å éé»è¾ä»ç¶æ¯éåé¨çåä¸ª sync å®ç°çãå¬å¹³äºéå¬å¹³éå°±ä¸è¯´äºï¼è¿éåªä»ç»è¯»éä¸åéã\n\n * sync ï¼åé¨åå«è¯»åéçå®ç°ä»¥åå®ç°è¯»åééè¦çåé\n * readlock ï¼è°ç¨ sync åç tryreadlock å°è¯è·åè¯»éã\n * writelock ï¼è°ç¨ sync åç trywritelock å°è¯è·ååéã\n\n\n# 3. è¯»åééè¦çåé\n\nå®ç°è¯»åééè¦çä¾¿ä»¤é½å¨ sync ç±»ä¸­ï¼å½ç¶äºï¼æéè¦çè¿å¾æ¯ aqs ä¸­ç stateã\n\nå¨ reentrantlock ä¸­ï¼state è¡¨ç¤ºéå¥äºå æ¬¡ï¼å¨è¯»åéä¸­ä¹ç¨è¿ä¸ªåéï¼ä¸è¿å°å®åæä¸¤åï¼å ä¸º state æ 32 ä¸ªäºè¿å¶ä½ï¼æä»¥è¯»éãåéæ¯äººä¸å ï¼\n\n * state çé«16ä½ ï¼è¡¨ç¤ºè¯»é ï¼è¡¨ç¤ºæ 1 ~ n ä¸ªè¯»é\n * state çä½16ä½ ï¼è¡¨ç¤ºåéï¼åªè½ç±ä¸ä¸ªçº¿ç¨å æï¼å¯ä»¥éå¥\n\n//è¯» å éåçç¹\nstatic final int shared_shift   = 16;\n//è¯»éæå°åä½ï¼åå¥½è¡¨ç¤ºå½åæ¥æä¸ä¸ªè¯»éçº¿ç¨\n// 00000000 00000001 00000000 00000000\nstatic final int shared_unit    = (1 << shared_shift);\n\n// æ¯ææå¤§è¯»åæ¬¡æ°\nstatic final int max_count      = (1 << shared_shift) - 1;\n\n// åéæ©ç \n// 00000000 00000000 11111111 11111111\n// è®¡ç®æ¶å¾æ¹ä¾¿ï¼state &  exclusive_mask å°±å¯ä»¥å¾å°åéæ°é\nstatic final int exclusive_mask = (1 << shared_shift) - 1;\n\n\nstate çé«åå­ä½è¡¨ç¤ºè¯»çº¿ç¨æ°éï¼é£ä¹æä¹è¡¨ç¤ºæ¯ä¸ä¸ªçº¿ç¨éå¥äºå¤å°æ¬¡å¢ï¼é£å°±åªè½å­å¨å¨åä¸ªçº¿ç¨éé¢ï¼åªä¸ªå·¥å·å¯ä»¥å®ç°çº¿ç¨ç§æåéå¢ï¼threadlocal\n\nstatic final class threadlocalholdcounter\n    extends threadlocal<holdcounter> {\n    public holdcounter initialvalue() {\n        return new holdcounter();\n    }\n}\n\nstatic final class holdcounter {\n    int count = 0;\n    final long tid = getthreadid(thread.currentthread());\n}\n\n\næ¯ä¸ä¸ªçº¿ç¨é½æä¸ä¸ª holdcounterï¼æ¯ä¸ä¸ª holdcounter ä¸­é½è®°å½ççº¿ç¨ id ä¸ è¯¥çº¿ç¨è·åäºå¤å°æ¬¡è¯»éã\n\nåééå¥æä¹è¡¨ç¤ºå¢ï¼æ­£å¸¸ç¨ state è¡¨ç¤ºåï¼åéåªè½æä¸ä¸ªçº¿ç¨å æï¼é£ä¹ state çä½16ä½å°±å¯ä»¥è¡¨ç¤ºå½åæ¢å åéçº¿ç¨çéå¥æ¬¡æ°äºã\n\n\n# 4. å åé\n\nå åéçé»è¾ç¸å¯¹ç®åï¼ç±äºåéä¸è¯»éä¸è½å±å­ï¼åå¤æ­ææ²¡æå¶ä»çº¿ç¨å æ® è¯»/åéï¼æ²¡æå°±å ï¼æå°±ç­å¾ã\n\n * state != 0 && è¯»é == 0 ï¼è¯´ææçº¿ç¨å æ®äºåéï¼ççæ¯ä¸æ¯èªå·±ï¼å¦ææ¯èªå·±å¯ä»¥éå¥\n * state != 0 && åé == 0 ï¼è¯´ææçº¿ç¨å æ®äºè¯»éï¼è¯»éä¸åéä¸è½å±å­ï¼å¹¶ä¸ä¸æ¯æè¯»éåçº§ä¸ºåéã\n\nfinal boolean trywritelock() {\n    // è·åå½åçº¿ç¨\n    thread current = thread.currentthread();\n    // è·å aqs ä¸­çç¶æ\n    int c = getstate();\n    // å¦æc != 0ï¼è¯´æè¦ä¹åéè¢«å æ®ï¼è¦ä¹è¯»éè¢«å æ®\n    // å¦ææ¯èªå·±å æ®äºåéï¼é£å°±å¯ä»¥éå¥\n    if (c != 0) {\n        // è·ååéæ¯å¦è¢«éå¥ï¼å¦æw == 0ï¼è¯´æåéæ²¡æè¢«å æ®\n        // c != 0 å¹¶ä¸ w == 0 è¯´ææ²¡æå«ççº¿ç¨å æ®åéï¼åªå æ®äºè¯»é\n        // å¦æ w != 0ï¼è¯´æåéè¢«å æ®äºï¼é£å°±ççæ¯ä¸æ¯èªå·±ï¼å¦ææ¯èªå·±å°±å¯ä»¥éå¥\n        int w = exclusivecount(c);\n        if (w == 0 || current != getexclusiveownerthread())\n            return false;\n        if (w == max_count)\n            throw new error("maximum lock count exceeded");\n    }\n    // å¦æ c == 0ï¼è¯´æéæ²¡æè¢«æ¢ï¼å¯ä»¥å°è¯æ¢é\n    if (!compareandsetstate(c, c + 1))\n        // æ¢éå¤±è´¥è¿åfalse\n        return false;\n    // æ¢éæåï¼å°ç¬å çº¿ç¨åæèªå·±ï¼è¿å true\n    setexclusiveownerthread(current);\n    return true;\n}\n\nstatic int exclusivecount(int c) { \n    return c & exclusive_mask; \n}\n\n\nreentrantreadwritelock ä¸æ¯æè¯»éåçº§ä¸ºåéï¼æä»¥å¨å åéæ¶ä¸éè¦å¤æ­ä¹åææ²¡æè¯»éã\n\n\n# 5. å è¯»é\n\nreentrantreadwritelock å è¯»éçè¿ç¨æ¯è¾å¤æï¼å ä¸ºæ¯æéçéçº§ï¼å³æ¯æå·²ç»æ¥æåéçæåµä¸åå»è·åè¯»éãæä»¥å¨å è¯»éçæ¶åï¼å¤æ­æ¡ä»¶å°±å¤ä¸ç¹ã\n\nfinal boolean tryreadlock() {\n    // è·åå½åçº¿ç¨\n    thread current = thread.currentthread();\n    // æ­»å¾ªç¯\n    for (;;) {\n        // è·å aqs çå½åç¶æ\n        int c = getstate();\n        // å¦æç°å¨å·²ç»æåéï¼å¹¶ä¸æ¿å°åéçä¸æ¯èªå·±ï¼é£å°±ä¸è½å è¯»é\n        // å¦ææ¯èªå·±ï¼è¯´æè¦è¿è¡ééçº§\n        if (exclusivecount(c) != 0 &&\n            getexclusiveownerthread() != current)\n            return false;\n        // è·åè¯»éççº¿ç¨çæ°éï¼å¤ªå¤äºå°±ä¸è®©è·åäº\n        int r = sharedcount(c);\n        if (r == max_count)\n            throw new error("maximum lock count exceeded");\n        // å°è¿éå°±æ¯è·åå±äº«è¯»éçè¿ç¨\n        if (compareandsetstate(c, c + shared_unit)) {\n            // è®°å½ç¬¬ä¸ä¸ªæ¥æè¯»éççº¿ç¨\n            if (r == 0) {\n                firstreader = current;\n                firstreaderholdcount = 1;\n            } else if (firstreader == current) {\n                firstreaderholdcount++;\n            } else {\n                // å½åçº¿ç¨ç holdcounter.count ++ \n                holdcounter rh = cachedholdcounter;\n                if (rh == null || rh.tid != getthreadid(current))\n                    cachedholdcounter = rh = readholds.get();\n                else if (rh.count == 0)\n                    readholds.set(rh);\n                rh.count++;\n            }\n            return true;\n        }\n    }\n}\n',charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"ReentrantLock æºç è§£æ",frontmatter:{title:"ReentrantLock æºç è§£æ",date:"2023-12-22T13:21:37.000Z",permalink:"/pages/5031c2/"},regularPath:"/02.%E6%96%87%E7%AB%A0/75.Java%E5%B9%B6%E5%8F%91/65.ReentrantLock.html",relativePath:"02.æç« /75.Javaå¹¶å/65.ReentrantLock.md",key:"v-ff4b2134",path:"/pages/5031c2/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:2,title:"2. ç±»ç»æ",slug:"_2-ç±»ç»æ",normalizedTitle:"2. ç±»ç»æ",charIndex:309},{level:2,title:"3. éå¬å¹³é",slug:"_3-éå¬å¹³é",normalizedTitle:"3. éå¬å¹³é",charIndex:666},{level:2,title:"4. å¬å¹³é",slug:"_4-å¬å¹³é",normalizedTitle:"4. å¬å¹³é",charIndex:1727},{level:2,title:"5. éæ¾é",slug:"_5-éæ¾é",normalizedTitle:"5. éæ¾é",charIndex:2635},{level:2,title:"6. æ»ç»",slug:"_6-æ»ç»",normalizedTitle:"6. æ»ç»",charIndex:3246}],headersStr:"1. åè¨ 2. ç±»ç»æ 3. éå¬å¹³é 4. å¬å¹³é 5. éæ¾é 6. æ»ç»",content:'# 1. åè¨\n\néè¯»åè¯·åéè¯» ï¼AQSæºç è§£æ\n\nå¨ä¸ç¯æç« ä¸­ä»ç»äº AQS æä¾çåè½ ï¼\n\n 1. å éå¤±è´¥åï¼çº¿ç¨è¢«å°è£ä¸º Node æ¾å¥åæ­¥éåï¼ç¶åé»å¡\n 2. éæ¾éåï¼ä¼åå¤éåæ­¥éåä¸­çç¬¬ä¸ä¸ªçº¿ç¨ï¼å¦æè¯¥çº¿ç¨çç¶æä¸ºå·²åæ¶ï¼ä»åæ­¥éåçå°¾é¨ååæ¾å°æ­£å¸¸èç¹å¹¶å¤éå®ã\n\nåæ¶ï¼ä¸ºäºè®²è§£ä¸è¿°åè½çå®ç°æ¹å¼ï¼æç« ä¸­è¿ä»ç»äº AQS çåéï¼å¦æåªæ¯æ³å®ç°ä¸åç§ç±»çéï¼é£ä¹åªéè¦è¿äºåé ï¼\n\n 1. state\n 2. åæ­¥éå\n\nReentrantLock æ¯éå¸¸å¸¸ç¨çå¯éå¥éï¼å¹¶ä¸å®ç°äºå¬å¹³ãéå¬å¹³çå éæ¹å¼ï¼æ¥ä¸æ¥ççå®æ¯å¦ä½æ ¹æ® AQS æä¾çåè½å®ç°ç å¯éå¥ãå¬å¹³ãéå¬å¹³å§ã\n\n\n# 2. ç±»ç»æ\n\nå¨ä¸æä¸­ä»ç»è¿ï¼ä¸åçéå¨å®ç° âå éâ è¿ä¸ªåè½æ¶ï¼å®å¹¶ä¸ä¼èªå·±å®ç°ï¼èæ¯å¨åé¨ç±» Sync ä¸­å®ç°å éé»è¾ã\n\nReentrantLock ä¸å±æä¸ä¸ª Sync ç±»åçåé¨ç±» ï¼\n\n * Sync ï¼åé¨åå«éå¬å¹³éçå®ç° nonfairTryAcquireï¼æä¾æ½è±¡æ¹æ³ lock è¿è¡å é\n * NonfairSync ï¼éå¬å¹³éï¼ç»§æ¿äº Syncãèªå·±åé¨æ²¡æå®ç°éå¬å¹³çå éé»è¾ï¼èæ¯ç´æ¥è°ç¨ç¶ç±» Sync çéå¬å¹³å éé»è¾ã\n * FairSync ï¼å¬å¹³éï¼ç»§æ¿äº Sync\n\nçåå­å°±ç¥éæ¯å¥ææäºï¼ç»§æ¿å³ç³»å¦ä¸ ï¼\n\n           Sync\n         /     \\\n       /        \\\nNonfairSync    FairSync\n\n\n\n# 3. éå¬å¹³é\n\nå¦åææè¿°ï¼éå¬å¹³éä½ä¸º ReentrantLock çé»è®¤åè½ï¼ç± Sync å®ç°ï¼NonfairSync ç»§æ¿åå¯ä»¥ç´æ¥è°ç¨ã\n\nå¨ Sync ä¸­ï¼éå¬å¹³æ¹æ³çåå­ä¸º nonfairTryAcquire ï¼\n\nfinal boolean nonfairTryAcquire(int acquires) {\n    // è·åå½åçº¿ç¨\n    final Thread current = Thread.currentThread();\n    // è·å AQS ä¸­ç state ç¶æåé\n    int c = getState();\n    // å¦æç¶æåéä¸º0ï¼è¯´ææ²¡æçº¿ç¨æ¥æéï¼ç´æ¥å°è¯å é\n    if (c == 0) {\n        if (compareAndSetState(0, acquires)) {\n            // å¦æå éæåï¼å°éå½åçæ¥æèæ¹ä¸ºèªå·±\n            setExclusiveOwnerThread(current);\n            // è¿åå éæå\n            return true;\n        }\n    }\n    // å¦æ c != 0ï¼è¯´æéå·²ç»è¢«äººå æäºã\n    // ä½æ¯å¦æå æè¿ä¸ªéçæ¯èªå·±ï¼é£ä¹å¯ä»¥è¿è¡éå¥\n    else if (current == getExclusiveOwnerThread()) {\n        // éå¥æ¬¡æ°+1\n        int nextc = c + acquires;\n        if (nextc < 0) // overflow\n            throw new Error("Maximum lock count exceeded");\n        // state = nextc\n        setState(nextc);\n        // è¿åå éæå\n        return true;\n    }\n    // å¦åè¿åå éå¤±è´¥ï¼è¿åfalseåï¼å¼å§æ§è¡ AQS æä¾çå°éé»å¡çæ­¥éª¤\n    return false;\n}\n\n\nå¨å¹¶åæåµä¸ï¼AQS ä¸­çåæ­¥éåå¯è½è¿æå¾å¤ç­å¾æ¢éççº¿ç¨ï¼ä½æ¯éå¬å¹³ä¹æä»¥å«åéå¬å¹³ï¼æ¯å ä¸ºå®ä¸ä¸æ¥åæ¢éï¼æå¯ä¸ç®¡ä½ æå¤å°çº¿ç¨å¨ç­å¾ã\n\nå«äººé½å¨æéï¼æä¸å»ç´æ¥å°è¯æå¡åä¼ä¸ä¼åæå¡æãå¦æäººå®¶ä¸æå¡æï¼æåæéå~\n\n\n# 4. å¬å¹³é\n\nå¬å¹³éçé»è¾å¨ ReentrantLock.FairSync ä¸­å®ç° ï¼\n\néå¬å¹³éæ¯ç´æ¥æ¢éï¼å¬å¹³éå°±æ¯è¾æç´ è´¨äºï¼å®åçç°å¨ææ²¡æäººæ­£å¨æéï¼å¦æææéçï¼é£æä¹å»æéã\n\nprotected final boolean tryAcquire(int acquires) {\n    // è·åå½åçº¿ç¨\n    final Thread current = Thread.currentThread();\n    // è·å AQS ä¸­ç state ç¶æåé\n    int c = getState();\n    // state == 0ï¼è¯´æè½æ¢éï¼ä½æ¯å¬å¹³éæ¯æç´ è´¨ç\n    if (c == 0) {\n        // åæ¥ç AQS çåæ­¥éåä¸­æ¯å¦æå¶ä»çº¿ç¨æ­£å¨æé\n        // å¦ææï¼ç´æ¥éåºï¼æä¹å»æé\n        // å¦ææ²¡æï¼CAS è·åéï¼è·åéæåå°±å°ç¬å çº¿ç¨è®¾ç½®ä¸ºèªå·±ï¼ç¶åè¿åtrue\n        if (!hasQueuedPredecessors() &&\n            compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    // è¿ä¸ªè·åæçæ­¥éª¤æ¯ä¸æ ·çï¼ä¸åèµè¿°\n    else if (current == getExclusiveOwnerThread()) {\n        int nextc = c + acquires;\n        if (nextc < 0)\n            throw new Error("Maximum lock count exceeded");\n        setState(nextc);\n        return true;\n    }\n    // æ¢éå¤±è´¥è¿å falseï¼æ§è¡ AQS çé»è¾\n    return false;\n}\n\n\n\n# 5. éæ¾é\n\nåæ¥çç SyncãNonfairSyncãFairSync çç»æå¾ï¼\n\nä½ è½å¨ NonfairSyncãFairSync ä¸­æ¾å°éæ¾éçä»£ç åï¼\n\næ²¡æï¼å®ä»¬é½ç¨ Sync çéæ¾éé»è¾ ï¼tryRelease\n\næä»¥å¬å¹³éäºéå¬å¹³éçéæ¾éé»è¾æ¯ä¸æ ·çï¼é½æ¯å¯éå¥éçæ­¥éª¤ï¼å¦ææ²¡æéå¥ï¼ç´æ¥éæ¾ï¼å¦æéå¥äºï¼å° state - 1\n\nprotected final boolean tryRelease(int releases) {\n    int c = getState() - releases;\n    if (Thread.currentThread() != getExclusiveOwnerThread())\n        throw new IllegalMonitorStateException();\n    boolean free = false;\n    // state - 1 ä¹åå¦ææ¯0ï¼è¯ææ²¡æéå¥ï¼ç´æ¥éæ¾\n    // å¦æä¸ä¸º0ï¼ä¸è½éæ¾é\n    if (c == 0) {\n        free = true;\n        setExclusiveOwnerThread(null);\n    }\n    setState(c);\n    // éæ¾éæå/å¤±è´¥ãå¦æéå¥å°±æ¯éæ¾éå¤±è´¥ã\n    return free;\n}\n\n\n\n# 6. æ»ç»\n\næ¬ç¯æç« è½ç¶ä»ç»äºå¯éå¥ãå¬å¹³ãéå¬å¹³çå®ç°ï¼ä½æ¯å¹¶æ²¡æä¸¾ä¾å­ãç»å¾å¥çï¼å ä¸ºç»å¾å¤ªéº»ç¦äºãå¦æä½ æ³çä¸¾ä¾å­ï¼ææ¨èä¸ä¸ªåå®¢ ï¼https://github.com/crisxuan/bestJavaer/blob/master/java-concurrent/java-aqs.md',normalizedContent:'# 1. åè¨\n\néè¯»åè¯·åéè¯» ï¼aqsæºç è§£æ\n\nå¨ä¸ç¯æç« ä¸­ä»ç»äº aqs æä¾çåè½ ï¼\n\n 1. å éå¤±è´¥åï¼çº¿ç¨è¢«å°è£ä¸º node æ¾å¥åæ­¥éåï¼ç¶åé»å¡\n 2. éæ¾éåï¼ä¼åå¤éåæ­¥éåä¸­çç¬¬ä¸ä¸ªçº¿ç¨ï¼å¦æè¯¥çº¿ç¨çç¶æä¸ºå·²åæ¶ï¼ä»åæ­¥éåçå°¾é¨ååæ¾å°æ­£å¸¸èç¹å¹¶å¤éå®ã\n\nåæ¶ï¼ä¸ºäºè®²è§£ä¸è¿°åè½çå®ç°æ¹å¼ï¼æç« ä¸­è¿ä»ç»äº aqs çåéï¼å¦æåªæ¯æ³å®ç°ä¸åç§ç±»çéï¼é£ä¹åªéè¦è¿äºåé ï¼\n\n 1. state\n 2. åæ­¥éå\n\nreentrantlock æ¯éå¸¸å¸¸ç¨çå¯éå¥éï¼å¹¶ä¸å®ç°äºå¬å¹³ãéå¬å¹³çå éæ¹å¼ï¼æ¥ä¸æ¥ççå®æ¯å¦ä½æ ¹æ® aqs æä¾çåè½å®ç°ç å¯éå¥ãå¬å¹³ãéå¬å¹³å§ã\n\n\n# 2. ç±»ç»æ\n\nå¨ä¸æä¸­ä»ç»è¿ï¼ä¸åçéå¨å®ç° âå éâ è¿ä¸ªåè½æ¶ï¼å®å¹¶ä¸ä¼èªå·±å®ç°ï¼èæ¯å¨åé¨ç±» sync ä¸­å®ç°å éé»è¾ã\n\nreentrantlock ä¸å±æä¸ä¸ª sync ç±»åçåé¨ç±» ï¼\n\n * sync ï¼åé¨åå«éå¬å¹³éçå®ç° nonfairtryacquireï¼æä¾æ½è±¡æ¹æ³ lock è¿è¡å é\n * nonfairsync ï¼éå¬å¹³éï¼ç»§æ¿äº syncãèªå·±åé¨æ²¡æå®ç°éå¬å¹³çå éé»è¾ï¼èæ¯ç´æ¥è°ç¨ç¶ç±» sync çéå¬å¹³å éé»è¾ã\n * fairsync ï¼å¬å¹³éï¼ç»§æ¿äº sync\n\nçåå­å°±ç¥éæ¯å¥ææäºï¼ç»§æ¿å³ç³»å¦ä¸ ï¼\n\n           sync\n         /     \\\n       /        \\\nnonfairsync    fairsync\n\n\n\n# 3. éå¬å¹³é\n\nå¦åææè¿°ï¼éå¬å¹³éä½ä¸º reentrantlock çé»è®¤åè½ï¼ç± sync å®ç°ï¼nonfairsync ç»§æ¿åå¯ä»¥ç´æ¥è°ç¨ã\n\nå¨ sync ä¸­ï¼éå¬å¹³æ¹æ³çåå­ä¸º nonfairtryacquire ï¼\n\nfinal boolean nonfairtryacquire(int acquires) {\n    // è·åå½åçº¿ç¨\n    final thread current = thread.currentthread();\n    // è·å aqs ä¸­ç state ç¶æåé\n    int c = getstate();\n    // å¦æç¶æåéä¸º0ï¼è¯´ææ²¡æçº¿ç¨æ¥æéï¼ç´æ¥å°è¯å é\n    if (c == 0) {\n        if (compareandsetstate(0, acquires)) {\n            // å¦æå éæåï¼å°éå½åçæ¥æèæ¹ä¸ºèªå·±\n            setexclusiveownerthread(current);\n            // è¿åå éæå\n            return true;\n        }\n    }\n    // å¦æ c != 0ï¼è¯´æéå·²ç»è¢«äººå æäºã\n    // ä½æ¯å¦æå æè¿ä¸ªéçæ¯èªå·±ï¼é£ä¹å¯ä»¥è¿è¡éå¥\n    else if (current == getexclusiveownerthread()) {\n        // éå¥æ¬¡æ°+1\n        int nextc = c + acquires;\n        if (nextc < 0) // overflow\n            throw new error("maximum lock count exceeded");\n        // state = nextc\n        setstate(nextc);\n        // è¿åå éæå\n        return true;\n    }\n    // å¦åè¿åå éå¤±è´¥ï¼è¿åfalseåï¼å¼å§æ§è¡ aqs æä¾çå°éé»å¡çæ­¥éª¤\n    return false;\n}\n\n\nå¨å¹¶åæåµä¸ï¼aqs ä¸­çåæ­¥éåå¯è½è¿æå¾å¤ç­å¾æ¢éççº¿ç¨ï¼ä½æ¯éå¬å¹³ä¹æä»¥å«åéå¬å¹³ï¼æ¯å ä¸ºå®ä¸ä¸æ¥åæ¢éï¼æå¯ä¸ç®¡ä½ æå¤å°çº¿ç¨å¨ç­å¾ã\n\nå«äººé½å¨æéï¼æä¸å»ç´æ¥å°è¯æå¡åä¼ä¸ä¼åæå¡æãå¦æäººå®¶ä¸æå¡æï¼æåæéå~\n\n\n# 4. å¬å¹³é\n\nå¬å¹³éçé»è¾å¨ reentrantlock.fairsync ä¸­å®ç° ï¼\n\néå¬å¹³éæ¯ç´æ¥æ¢éï¼å¬å¹³éå°±æ¯è¾æç´ è´¨äºï¼å®åçç°å¨ææ²¡æäººæ­£å¨æéï¼å¦æææéçï¼é£æä¹å»æéã\n\nprotected final boolean tryacquire(int acquires) {\n    // è·åå½åçº¿ç¨\n    final thread current = thread.currentthread();\n    // è·å aqs ä¸­ç state ç¶æåé\n    int c = getstate();\n    // state == 0ï¼è¯´æè½æ¢éï¼ä½æ¯å¬å¹³éæ¯æç´ è´¨ç\n    if (c == 0) {\n        // åæ¥ç aqs çåæ­¥éåä¸­æ¯å¦æå¶ä»çº¿ç¨æ­£å¨æé\n        // å¦ææï¼ç´æ¥éåºï¼æä¹å»æé\n        // å¦ææ²¡æï¼cas è·åéï¼è·åéæåå°±å°ç¬å çº¿ç¨è®¾ç½®ä¸ºèªå·±ï¼ç¶åè¿åtrue\n        if (!hasqueuedpredecessors() &&\n            compareandsetstate(0, acquires)) {\n            setexclusiveownerthread(current);\n            return true;\n        }\n    }\n    // è¿ä¸ªè·åæçæ­¥éª¤æ¯ä¸æ ·çï¼ä¸åèµè¿°\n    else if (current == getexclusiveownerthread()) {\n        int nextc = c + acquires;\n        if (nextc < 0)\n            throw new error("maximum lock count exceeded");\n        setstate(nextc);\n        return true;\n    }\n    // æ¢éå¤±è´¥è¿å falseï¼æ§è¡ aqs çé»è¾\n    return false;\n}\n\n\n\n# 5. éæ¾é\n\nåæ¥çç syncãnonfairsyncãfairsync çç»æå¾ï¼\n\nä½ è½å¨ nonfairsyncãfairsync ä¸­æ¾å°éæ¾éçä»£ç åï¼\n\næ²¡æï¼å®ä»¬é½ç¨ sync çéæ¾éé»è¾ ï¼tryrelease\n\næä»¥å¬å¹³éäºéå¬å¹³éçéæ¾éé»è¾æ¯ä¸æ ·çï¼é½æ¯å¯éå¥éçæ­¥éª¤ï¼å¦ææ²¡æéå¥ï¼ç´æ¥éæ¾ï¼å¦æéå¥äºï¼å° state - 1\n\nprotected final boolean tryrelease(int releases) {\n    int c = getstate() - releases;\n    if (thread.currentthread() != getexclusiveownerthread())\n        throw new illegalmonitorstateexception();\n    boolean free = false;\n    // state - 1 ä¹åå¦ææ¯0ï¼è¯ææ²¡æéå¥ï¼ç´æ¥éæ¾\n    // å¦æä¸ä¸º0ï¼ä¸è½éæ¾é\n    if (c == 0) {\n        free = true;\n        setexclusiveownerthread(null);\n    }\n    setstate(c);\n    // éæ¾éæå/å¤±è´¥ãå¦æéå¥å°±æ¯éæ¾éå¤±è´¥ã\n    return free;\n}\n\n\n\n# 6. æ»ç»\n\næ¬ç¯æç« è½ç¶ä»ç»äºå¯éå¥ãå¬å¹³ãéå¬å¹³çå®ç°ï¼ä½æ¯å¹¶æ²¡æä¸¾ä¾å­ãç»å¾å¥çï¼å ä¸ºç»å¾å¤ªéº»ç¦äºãå¦æä½ æ³çä¸¾ä¾å­ï¼ææ¨èä¸ä¸ªåå®¢ ï¼https://github.com/crisxuan/bestjavaer/blob/master/java-concurrent/java-aqs.md',charsets:{cjk:!0},lastUpdated:"2024/02/28, 21:50:33",lastUpdatedTimestamp:1709128233e3},{title:"è´è½½åè¡¡ç®æ³",frontmatter:{title:"è´è½½åè¡¡ç®æ³",date:"2023-07-28T15:52:31.000Z",permalink:"/pages/97a05f/"},regularPath:"/02.%E6%96%87%E7%AB%A0/85.%E7%AE%97%E6%B3%95/1.%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95.html",relativePath:"02.æç« /85.ç®æ³/1.è´è½½åè¡¡ç®æ³.md",key:"v-68f17928",path:"/pages/97a05f/",headers:[{level:2,title:"0. ç®è¿°",slug:"_0-ç®è¿°",normalizedTitle:"0. ç®è¿°",charIndex:2},{level:2,title:"1. è½®è¯¢æ³",slug:"_1-è½®è¯¢æ³",normalizedTitle:"1. è½®è¯¢æ³",charIndex:113},{level:2,title:"2. å æè½®è¯¢æ³",slug:"_2-å æè½®è¯¢æ³",normalizedTitle:"2. å æè½®è¯¢æ³",charIndex:1478},{level:2,title:"3. éæºæ³",slug:"_3-éæºæ³",normalizedTitle:"3. éæºæ³",charIndex:3144},{level:2,title:"4. å æéæºæ³",slug:"_4-å æéæºæ³",normalizedTitle:"4. å æéæºæ³",charIndex:4414},{level:2,title:"5. æºå°ååå¸æ³",slug:"_5-æºå°ååå¸æ³",normalizedTitle:"5. æºå°ååå¸æ³",charIndex:6016}],headersStr:"0. ç®è¿° 1. è½®è¯¢æ³ 2. å æè½®è¯¢æ³ 3. éæºæ³ 4. å æéæºæ³ 5. æºå°ååå¸æ³",content:'# 0. ç®è¿°\n\nä»ä¹æ¯è´è½½åè¡¡ç®æ³ï¼\n\nå¨åå¸å¼ç³»ç»ä¸ï¼æä»¬å¯è½ä¼å°åä¸ä¸ªæå¡å¯å¨å¤æ¬¡å½¢æéç¾¤ï¼é£ä¹è¿ä¸ªéç¾¤ä¸­çå¤å°æºå¨å°ä¼å¦ä½åéæµ·éè¯·æ±æ¶ï¼\n\nè´è½½åè¡¡ç®æ³å°±æ¯ä»¥æç§ç®æ³çå½¢å¼å°è¿äºè¯·æ±åéç»ä¸åçæºå¨/å®ä¾ã\n\n\n# 1. è½®è¯¢æ³\n\nå°è¯·æ±é¡ºåºè½®æµå°åéå°ä¸åçå®ä¾ä¸ã å¦æå°æå¡å¨å®ä¾æ¾å°ä¸ä¸ª List ä¸­ï¼è½®è¯¢æ³çä½ç¨å°±æ¯æç§é¡ºåºéå Listã\n\nimport java.util.*; \nimport java.util.concurrent.ConcurrentHashMap; \n\npublic  class TestRoundRobin {  \n    // åè®¾è¿äºIPå°±æ¯æå¡å°åï¼é£ä¹è¦åçå°±æ¯å°è¯·æ±åéå°IPä¸ã\n    static Map<String,Integer> ipMap= new HashMap<>(); \n    static { \n        ipMap.put("192.168.13.1",1); \n        ipMap.put("192.168.13.2",1); \n        ipMap.put("192.168.13.3",1); \n    } \n\n    Integer  pos = 0; \n    public String RoundRobin(){ \n        Map<String,Integer> ipServerMap = new ConcurrentHashMap<>(); \n        ipServerMap.putAll(ipMap); \n        \n        // 2.ååºæ¥key,ä¹å°±æ¯IPå°åï¼æ¾å°setä¸­ \n        Set<String> ipset = ipServerMap.keySet(); \n        // 3.setæ¾å°listï¼è¦å¾ªç¯listååº \n        ArrayList<String> iplist = new ArrayList<String>(); \n        iplist.addAll(ipset); \n        String serverName = null; \n        // 4.å®ä¹ä¸ä¸ªå¾ªç¯çå¼ï¼å¦æå¤§äºsetå°±ä»0å¼å§ \n        synchronized(pos){ \n            if (pos >= ipset.size()){ \n                pos=0; \n            } \n            serverName = iplist.get(pos); \n            //è½®è¯¢+1 \n            pos ++; \n        } \n        return serverName; \n    } \n    public  static  void main(String[] args) { \n        TestRoundRobin testRoundRobin=new TestRoundRobin(); \n        for ( int i=0;i<10;i++){ \n            String serverIp = testRoundRobin.RoundRobin(); \n            System.out.println(serverIp); \n        } \n    } \n} \n\n\n\n# 2. å æè½®è¯¢æ³\n\nä¸åæå¡å¨çéç½®å¯è½æåºå«ï¼2æ ¸4Gçæå¡å¨è·1æ ¸2Gçæå¡å¨è½å¤ççè¯·æ±æ°éè¯å®ä¸åãæä»¬è¦å°½éå°è¯·æ±å¤åéå°éç½®å¥½çæå¡å¨ä¸ã\n\nç®åå®ç°ä¸ä¸å æè½®è¯¢ ï¼åå¦æéæ¯ n ï¼é£ä¹ä¸æ¬¡å¾ªç¯å°±åç»è¿ä¸ªæºå¨ n æ¬¡è¯·æ±ã\n\nimport java.util.*; \nimport java.util.concurrent.ConcurrentHashMap; \npublic  class TestWeightRobin { \n    // 1.map, key-ip, value-weight \n    static Map<String,Integer> ipMap = new HashMap<>(); \n    static { \n        ipMap.put("192.168.13.1",1); \n        ipMap.put("192.168.13.2",2); \n        ipMap.put("192.168.13.3",4); \n    } \n    Integer pos = 0; \n    public String WeightRobin() { \n        Map<String,Integer> ipServerMap = new ConcurrentHashMap<>(); \n        ipServerMap.putAll(ipMap); \n        // ååºææIP\n        Set<String> ipSet = ipServerMap.keySet(); \n        Iterator<String> ipIterator = ipSet.iterator(); \n        //å®ä¹ä¸ä¸ªlistæ¾ææserver ip\n        ArrayList<String> ipArrayList=new ArrayList<String>(); \n        \n        //å¾ªç¯setï¼æ ¹æ®setä¸­çå¯ä»¥å»å¾ç¥mapä¸­çvalueï¼ç»listä¸­æ·»å å¯¹åºæ°å­çserveræ°é \n        while (ipIterator.hasNext()){ \n            String serverName = ipIterator.next(); \n            Integer weight=ipServerMap.get(serverName); \n            for ( int i = 0;i < weight ;i++){ \n                ipArrayList.add(serverName); \n            } \n        } \n        String serverName=null; \n        if (pos>=ipArrayList.size()){ \n            pos=0; \n        } \n        serverName = ipArrayList.get(pos); \n        //è½®è¯¢+1 \n        pos ++; \n        return  serverName; \n    } \n    public  static  void main(String[] args) { \n        TestWeightRobin testWeightRobin=new TestWeightRobin(); \n        for ( int i = 0; i < 10; i++){ \n            String server = testWeightRobin.WeightRobin(); \n            System.out.println(server); \n        } \n    } \n}\n\n\n\n# 3. éæºæ³\n\néè¿ç³»ç»çéæºç®æ³ï¼æ ¹æ®åç«¯æå¡å¨çåè¡¨å¤§å°å¼æ¥éæºéåå¶ä¸­çä¸å°æå¡å¨è¿è¡è®¿é®ã\n\nç±æ¦çç»è®¡çè®ºå¯ä»¥å¾ç¥ï¼éçå®¢æ·ç«¯è°ç¨æå¡ç«¯çæ¬¡æ°å¢å¤ï¼ å¶å®éææè¶æ¥è¶æ¥è¿äºå¹³ååéè°ç¨éå°åç«¯çæ¯ä¸å°æå¡å¨ï¼ä¹å°±æ¯è½®è¯¢çç»æã\n\nimport java.util.*; \nimport java.util.concurrent.ConcurrentHashMap; \n\npublic  class TestRandom { \n    //    1.å®ä¹map, key-ip,value-weight \n    static Map<String,Integer> ipMap= new HashMap<>(); \n    static { \n        ipMap.put("192.168.13.1",1); \n        ipMap.put("192.168.13.2",2); \n        ipMap.put("192.168.13.3",4); \n    } \n    public String Random() { \n        Map<String,Integer> ipServerMap = new ConcurrentHashMap<>(); \n        ipServerMap.putAll(ipMap); \n        Set<String> ipSet = ipServerMap.keySet(); \n        //å®ä¹ä¸ä¸ªlistæ¾ææserver \n        ArrayList<String> ipArrayList = new ArrayList<String>(); \n        ipArrayList.addAll(ipSet); \n        //å¾ªç¯éæºæ° \n        Random random = new Random(); \n        \n        //éæºæ°å¨listæ°éä¸­åï¼1-list.sizeï¼ \n        int pos = random.nextInt(ipArrayList.size()); \n        String serverNameReturn = ipArrayList.get(pos); \n        return  serverNameReturn; \n    } \n    public  static  void main(String[] args) { \n        TestRandom testRandom=new TestRandom(); \n        for ( int i =0;i<10;i++){ \n            String server=testRandom.Random(); \n            System.out.println(server); \n        } \n    } \n} \n\n\n\n# 4. å æéæºæ³\n\nä¸å æè½®è¯¢æ³ä¸æ ·ï¼å æéæºæ³ä¹æ ¹æ®åç«¯æºå¨çéç½®ãç³»ç»çè´è½½åéä¸åçæéãä¸åçæ¯ï¼å®æ¯æç§æééæºè¯·æ±åç«¯æå¡å¨ï¼èéé¡ºåºã\n\nimport java.util.*; \nimport java.util.concurrent.ConcurrentHashMap; \npublic  class TestRobinRandom { \n    //    1.å®ä¹map, key-ip,value-weight \n    static Map<String,Integer> ipMap= new HashMap<>(); \n    static { \n        ipMap.put("192.168.13.1",1); \n        ipMap.put("192.168.13.2",2); \n        ipMap.put("192.168.13.3",4); \n    } \n    public String RobinRandom(){ \n        Map<String,Integer> ipServerMap = new ConcurrentHashMap<>(); \n        ipServerMap.putAll(ipMap); \n        Set<String> ipSet = ipServerMap.keySet(); \n        Iterator<String> ipIterator = ipSet.iterator(); \n        //å®ä¹ä¸ä¸ªlistæ¾ææserver \n        ArrayList<String> ipArrayList = new ArrayList<String>(); \n        //å¾ªç¯setï¼æ ¹æ®setä¸­çå¯ä»¥å»å¾ç¥mapä¸­çvalueï¼ç»listä¸­æ·»å å¯¹åºæ°å­çserveræ°é \n        while (ipIterator.hasNext()){ \n            String serverName=ipIterator.next(); \n            Integer weight = ipServerMap.get(serverName); \n            for (int i = 0; i < weight; i++){ \n                ipArrayList.add(serverName); \n            } \n        } \n        //å¾ªç¯éæºæ° \n        Random random = new Random(); \n        //éæºæ°å¨listæ°éä¸­åï¼1-list.sizeï¼ \n        int pos=random.nextInt(ipArrayList.size()); \n        String serverNameReturn = ipArrayList.get(pos); \n        return  serverNameReturn; \n    } \n    public  static  void main(String[] args) { \n        TestRobinRandom testRobinRandom = new TestRobinRandom(); \n        for ( int i =0;i<10;i++){ \n            String server = testRobinRandom.RobinRandom(); \n            System.out.println(server); \n        } \n    } \n} \n\n\n\n# 5. æºå°ååå¸æ³\n\næºå°ååå¸çææ³æ¯ æ ¹æ®è·åå®¢æ·ç«¯çIPå°åï¼éè¿åå¸å½æ°è®¡ç®å¾å°çä¸ä¸ªæ°å¼ï¼ç¨è¯¥æ°å¼å¯¹æå¡å¨åè¡¨çå¤§å°è¿è¡åæ¨¡è¿ç®ï¼å¾å°çç»æä¾¿æ¯å®¢æç«¯è¦è®¿é®æå¡å¨çåºå·ãéç¨æºå°ååå¸æ³è¿è¡è´è½½åè¡¡ï¼åä¸IPå°åçå®¢æ·ç«¯ï¼å½åç«¯æå¡å¨åè¡¨ä¸åæ¶ï¼å®æ¯æ¬¡é½ä¼æ å°å°åä¸å°åç«¯æå¡å¨è¿è¡è®¿é®ï¼\n\nimport java.util.ArrayList; \nimport java.util.HashMap; \nimport java.util.Map; \nimport java.util.Set; \nimport java.util.concurrent.ConcurrentHashMap; \n\npublic  class ipHash { \n    //    1.å®ä¹map, key-ip,value-weight \n    static Map<String,Integer> ipMap= new HashMap<>(); \n    static { \n        ipMap.put("192.168.13.1",1); \n        ipMap.put("192.168.13.2",2); \n        ipMap.put("192.168.13.3",4); \n    } \n    // clientIP: ç¨æ·IPå°å\n    public String ipHash(String clientIP){ \n        Map<String,Integer> ipServerMap = new ConcurrentHashMap<>(); \n        ipServerMap.putAll(ipMap); \n        //    2.ååºæ¥key,æ¾å°setä¸­ \n        Set<String> ipset = ipServerMap.keySet(); \n        //    3.setæ¾å°listï¼è¦å¾ªç¯listååº \n        ArrayList<String> iplist = new ArrayList<String>(); \n        iplist.addAll(ipset); \n        //å¯¹ipçhashcodeå¼åä½æ°ï¼æ¯æ¬¡é½ä¸æ ·ç \n        int hashCode = clientIP.hashCode(); \n        int serverListsize = iplist.size(); \n        int pos = hashCode % serverListsize; \n        return iplist.get(pos); \n    } \n    public  static  void main(String[] args) { \n        ipHash iphash=new ipHash(); \n        String servername= iphash.ipHash("192.168.21.2"); \n        System.out.println(servername); \n    } \n} \n\n\nä½æ¯å¢ï¼è¿ç§hashç®æ³æ¯éå¸¸æ®éçï¼ä½ å¯ä»¥äºè§£ä¸ä¸ä¸è´æ§åå¸ç®æ³ : ä¸è´æ§åå¸ç®æ³',normalizedContent:'# 0. ç®è¿°\n\nä»ä¹æ¯è´è½½åè¡¡ç®æ³ï¼\n\nå¨åå¸å¼ç³»ç»ä¸ï¼æä»¬å¯è½ä¼å°åä¸ä¸ªæå¡å¯å¨å¤æ¬¡å½¢æéç¾¤ï¼é£ä¹è¿ä¸ªéç¾¤ä¸­çå¤å°æºå¨å°ä¼å¦ä½åéæµ·éè¯·æ±æ¶ï¼\n\nè´è½½åè¡¡ç®æ³å°±æ¯ä»¥æç§ç®æ³çå½¢å¼å°è¿äºè¯·æ±åéç»ä¸åçæºå¨/å®ä¾ã\n\n\n# 1. è½®è¯¢æ³\n\nå°è¯·æ±é¡ºåºè½®æµå°åéå°ä¸åçå®ä¾ä¸ã å¦æå°æå¡å¨å®ä¾æ¾å°ä¸ä¸ª list ä¸­ï¼è½®è¯¢æ³çä½ç¨å°±æ¯æç§é¡ºåºéå listã\n\nimport java.util.*; \nimport java.util.concurrent.concurrenthashmap; \n\npublic  class testroundrobin {  \n    // åè®¾è¿äºipå°±æ¯æå¡å°åï¼é£ä¹è¦åçå°±æ¯å°è¯·æ±åéå°ipä¸ã\n    static map<string,integer> ipmap= new hashmap<>(); \n    static { \n        ipmap.put("192.168.13.1",1); \n        ipmap.put("192.168.13.2",1); \n        ipmap.put("192.168.13.3",1); \n    } \n\n    integer  pos = 0; \n    public string roundrobin(){ \n        map<string,integer> ipservermap = new concurrenthashmap<>(); \n        ipservermap.putall(ipmap); \n        \n        // 2.ååºæ¥key,ä¹å°±æ¯ipå°åï¼æ¾å°setä¸­ \n        set<string> ipset = ipservermap.keyset(); \n        // 3.setæ¾å°listï¼è¦å¾ªç¯listååº \n        arraylist<string> iplist = new arraylist<string>(); \n        iplist.addall(ipset); \n        string servername = null; \n        // 4.å®ä¹ä¸ä¸ªå¾ªç¯çå¼ï¼å¦æå¤§äºsetå°±ä»0å¼å§ \n        synchronized(pos){ \n            if (pos >= ipset.size()){ \n                pos=0; \n            } \n            servername = iplist.get(pos); \n            //è½®è¯¢+1 \n            pos ++; \n        } \n        return servername; \n    } \n    public  static  void main(string[] args) { \n        testroundrobin testroundrobin=new testroundrobin(); \n        for ( int i=0;i<10;i++){ \n            string serverip = testroundrobin.roundrobin(); \n            system.out.println(serverip); \n        } \n    } \n} \n\n\n\n# 2. å æè½®è¯¢æ³\n\nä¸åæå¡å¨çéç½®å¯è½æåºå«ï¼2æ ¸4gçæå¡å¨è·1æ ¸2gçæå¡å¨è½å¤ççè¯·æ±æ°éè¯å®ä¸åãæä»¬è¦å°½éå°è¯·æ±å¤åéå°éç½®å¥½çæå¡å¨ä¸ã\n\nç®åå®ç°ä¸ä¸å æè½®è¯¢ ï¼åå¦æéæ¯ n ï¼é£ä¹ä¸æ¬¡å¾ªç¯å°±åç»è¿ä¸ªæºå¨ n æ¬¡è¯·æ±ã\n\nimport java.util.*; \nimport java.util.concurrent.concurrenthashmap; \npublic  class testweightrobin { \n    // 1.map, key-ip, value-weight \n    static map<string,integer> ipmap = new hashmap<>(); \n    static { \n        ipmap.put("192.168.13.1",1); \n        ipmap.put("192.168.13.2",2); \n        ipmap.put("192.168.13.3",4); \n    } \n    integer pos = 0; \n    public string weightrobin() { \n        map<string,integer> ipservermap = new concurrenthashmap<>(); \n        ipservermap.putall(ipmap); \n        // ååºææip\n        set<string> ipset = ipservermap.keyset(); \n        iterator<string> ipiterator = ipset.iterator(); \n        //å®ä¹ä¸ä¸ªlistæ¾ææserver ip\n        arraylist<string> iparraylist=new arraylist<string>(); \n        \n        //å¾ªç¯setï¼æ ¹æ®setä¸­çå¯ä»¥å»å¾ç¥mapä¸­çvalueï¼ç»listä¸­æ·»å å¯¹åºæ°å­çserveræ°é \n        while (ipiterator.hasnext()){ \n            string servername = ipiterator.next(); \n            integer weight=ipservermap.get(servername); \n            for ( int i = 0;i < weight ;i++){ \n                iparraylist.add(servername); \n            } \n        } \n        string servername=null; \n        if (pos>=iparraylist.size()){ \n            pos=0; \n        } \n        servername = iparraylist.get(pos); \n        //è½®è¯¢+1 \n        pos ++; \n        return  servername; \n    } \n    public  static  void main(string[] args) { \n        testweightrobin testweightrobin=new testweightrobin(); \n        for ( int i = 0; i < 10; i++){ \n            string server = testweightrobin.weightrobin(); \n            system.out.println(server); \n        } \n    } \n}\n\n\n\n# 3. éæºæ³\n\néè¿ç³»ç»çéæºç®æ³ï¼æ ¹æ®åç«¯æå¡å¨çåè¡¨å¤§å°å¼æ¥éæºéåå¶ä¸­çä¸å°æå¡å¨è¿è¡è®¿é®ã\n\nç±æ¦çç»è®¡çè®ºå¯ä»¥å¾ç¥ï¼éçå®¢æ·ç«¯è°ç¨æå¡ç«¯çæ¬¡æ°å¢å¤ï¼ å¶å®éææè¶æ¥è¶æ¥è¿äºå¹³ååéè°ç¨éå°åç«¯çæ¯ä¸å°æå¡å¨ï¼ä¹å°±æ¯è½®è¯¢çç»æã\n\nimport java.util.*; \nimport java.util.concurrent.concurrenthashmap; \n\npublic  class testrandom { \n    //    1.å®ä¹map, key-ip,value-weight \n    static map<string,integer> ipmap= new hashmap<>(); \n    static { \n        ipmap.put("192.168.13.1",1); \n        ipmap.put("192.168.13.2",2); \n        ipmap.put("192.168.13.3",4); \n    } \n    public string random() { \n        map<string,integer> ipservermap = new concurrenthashmap<>(); \n        ipservermap.putall(ipmap); \n        set<string> ipset = ipservermap.keyset(); \n        //å®ä¹ä¸ä¸ªlistæ¾ææserver \n        arraylist<string> iparraylist = new arraylist<string>(); \n        iparraylist.addall(ipset); \n        //å¾ªç¯éæºæ° \n        random random = new random(); \n        \n        //éæºæ°å¨listæ°éä¸­åï¼1-list.sizeï¼ \n        int pos = random.nextint(iparraylist.size()); \n        string servernamereturn = iparraylist.get(pos); \n        return  servernamereturn; \n    } \n    public  static  void main(string[] args) { \n        testrandom testrandom=new testrandom(); \n        for ( int i =0;i<10;i++){ \n            string server=testrandom.random(); \n            system.out.println(server); \n        } \n    } \n} \n\n\n\n# 4. å æéæºæ³\n\nä¸å æè½®è¯¢æ³ä¸æ ·ï¼å æéæºæ³ä¹æ ¹æ®åç«¯æºå¨çéç½®ãç³»ç»çè´è½½åéä¸åçæéãä¸åçæ¯ï¼å®æ¯æç§æééæºè¯·æ±åç«¯æå¡å¨ï¼èéé¡ºåºã\n\nimport java.util.*; \nimport java.util.concurrent.concurrenthashmap; \npublic  class testrobinrandom { \n    //    1.å®ä¹map, key-ip,value-weight \n    static map<string,integer> ipmap= new hashmap<>(); \n    static { \n        ipmap.put("192.168.13.1",1); \n        ipmap.put("192.168.13.2",2); \n        ipmap.put("192.168.13.3",4); \n    } \n    public string robinrandom(){ \n        map<string,integer> ipservermap = new concurrenthashmap<>(); \n        ipservermap.putall(ipmap); \n        set<string> ipset = ipservermap.keyset(); \n        iterator<string> ipiterator = ipset.iterator(); \n        //å®ä¹ä¸ä¸ªlistæ¾ææserver \n        arraylist<string> iparraylist = new arraylist<string>(); \n        //å¾ªç¯setï¼æ ¹æ®setä¸­çå¯ä»¥å»å¾ç¥mapä¸­çvalueï¼ç»listä¸­æ·»å å¯¹åºæ°å­çserveræ°é \n        while (ipiterator.hasnext()){ \n            string servername=ipiterator.next(); \n            integer weight = ipservermap.get(servername); \n            for (int i = 0; i < weight; i++){ \n                iparraylist.add(servername); \n            } \n        } \n        //å¾ªç¯éæºæ° \n        random random = new random(); \n        //éæºæ°å¨listæ°éä¸­åï¼1-list.sizeï¼ \n        int pos=random.nextint(iparraylist.size()); \n        string servernamereturn = iparraylist.get(pos); \n        return  servernamereturn; \n    } \n    public  static  void main(string[] args) { \n        testrobinrandom testrobinrandom = new testrobinrandom(); \n        for ( int i =0;i<10;i++){ \n            string server = testrobinrandom.robinrandom(); \n            system.out.println(server); \n        } \n    } \n} \n\n\n\n# 5. æºå°ååå¸æ³\n\næºå°ååå¸çææ³æ¯ æ ¹æ®è·åå®¢æ·ç«¯çipå°åï¼éè¿åå¸å½æ°è®¡ç®å¾å°çä¸ä¸ªæ°å¼ï¼ç¨è¯¥æ°å¼å¯¹æå¡å¨åè¡¨çå¤§å°è¿è¡åæ¨¡è¿ç®ï¼å¾å°çç»æä¾¿æ¯å®¢æç«¯è¦è®¿é®æå¡å¨çåºå·ãéç¨æºå°ååå¸æ³è¿è¡è´è½½åè¡¡ï¼åä¸ipå°åçå®¢æ·ç«¯ï¼å½åç«¯æå¡å¨åè¡¨ä¸åæ¶ï¼å®æ¯æ¬¡é½ä¼æ å°å°åä¸å°åç«¯æå¡å¨è¿è¡è®¿é®ï¼\n\nimport java.util.arraylist; \nimport java.util.hashmap; \nimport java.util.map; \nimport java.util.set; \nimport java.util.concurrent.concurrenthashmap; \n\npublic  class iphash { \n    //    1.å®ä¹map, key-ip,value-weight \n    static map<string,integer> ipmap= new hashmap<>(); \n    static { \n        ipmap.put("192.168.13.1",1); \n        ipmap.put("192.168.13.2",2); \n        ipmap.put("192.168.13.3",4); \n    } \n    // clientip: ç¨æ·ipå°å\n    public string iphash(string clientip){ \n        map<string,integer> ipservermap = new concurrenthashmap<>(); \n        ipservermap.putall(ipmap); \n        //    2.ååºæ¥key,æ¾å°setä¸­ \n        set<string> ipset = ipservermap.keyset(); \n        //    3.setæ¾å°listï¼è¦å¾ªç¯listååº \n        arraylist<string> iplist = new arraylist<string>(); \n        iplist.addall(ipset); \n        //å¯¹ipçhashcodeå¼åä½æ°ï¼æ¯æ¬¡é½ä¸æ ·ç \n        int hashcode = clientip.hashcode(); \n        int serverlistsize = iplist.size(); \n        int pos = hashcode % serverlistsize; \n        return iplist.get(pos); \n    } \n    public  static  void main(string[] args) { \n        iphash iphash=new iphash(); \n        string servername= iphash.iphash("192.168.21.2"); \n        system.out.println(servername); \n    } \n} \n\n\nä½æ¯å¢ï¼è¿ç§hashç®æ³æ¯éå¸¸æ®éçï¼ä½ å¯ä»¥äºè§£ä¸ä¸ä¸è´æ§åå¸ç®æ³ : ä¸è´æ§åå¸ç®æ³',charsets:{cjk:!0},lastUpdated:"2023/11/09, 12:26:33",lastUpdatedTimestamp:1699503993e3},{title:"éæµç®æ³",frontmatter:{title:"éæµç®æ³",date:"2023-06-09T14:23:53.000Z",permalink:"/pages/5dba8e/"},regularPath:"/02.%E6%96%87%E7%AB%A0/85.%E7%AE%97%E6%B3%95/20.%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html",relativePath:"02.æç« /85.ç®æ³/20.éæµç®æ³.md",key:"v-20c514cb",path:"/pages/5dba8e/",headers:[{level:2,title:"1. ä»ä¹æ¯éæµ",slug:"_1-ä»ä¹æ¯éæµ",normalizedTitle:"1. ä»ä¹æ¯éæµ",charIndex:11},{level:2,title:"2. å¸¸è§çéæµç®æ³",slug:"_2-å¸¸è§çéæµç®æ³",normalizedTitle:"2. å¸¸è§çéæµç®æ³",charIndex:178},{level:3,title:"2.1 è®¡ç®å¨ç®æ³",slug:"_2-1-è®¡ç®å¨ç®æ³",normalizedTitle:"2.1 è®¡ç®å¨ç®æ³",charIndex:250},{level:3,title:"2.2 æ»å¨çªå£ç®æ³",slug:"_2-2-æ»å¨çªå£ç®æ³",normalizedTitle:"2.2 æ»å¨çªå£ç®æ³",charIndex:1595},{level:3,title:"2.3 ä»¤çæ¡¶ç®æ³",slug:"_2-3-ä»¤çæ¡¶ç®æ³",normalizedTitle:"2.3 ä»¤çæ¡¶ç®æ³",charIndex:4995},{level:3,title:"2.4 æ¼æ¡¶ç®æ³",slug:"_2-4-æ¼æ¡¶ç®æ³",normalizedTitle:"2.4 æ¼æ¡¶ç®æ³",charIndex:6553},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:7931}],headersStr:"1. ä»ä¹æ¯éæµ 2. å¸¸è§çéæµç®æ³ 2.1 è®¡ç®å¨ç®æ³ 2.2 æ»å¨çªå£ç®æ³ 2.3 ä»¤çæ¡¶ç®æ³ 2.4 æ¼æ¡¶ç®æ³ 3. æ»ç»",content:'# éæµç®æ³\n\n\n# 1. ä»ä¹æ¯éæµ\n\nä»ä¹æ¯éæµ\n\néæµï¼ä¹ç§°æµéæ§å¶ã\næ¯æå¨ç³»ç»é¢ä¸´é«å¹¶åæåµä¸ï¼éå¶æ°çè¯·æ±å¯¹ç³»ç»çè®¿é®ï¼ä»èä¿è¯ç³»ç»çç¨³å®æ§ã\n\nä¸¾ä¸äºä¾å­ï¼\n\n * æ¯åºä¼å¯¹äººæµéè¿è¡æ§å¶ï¼ä¾å¦æ¯å¤©åºå®åå¤å°é¨ç¥¨ã\n * è¿æ®µæ¶é´æå°çç§ç¤å¾ç«ï¼ä½æ¯åªææéçäººåå¤ï¼ç§ç¤çéåº¦å°±è¿ä¹å¿«ï¼å°±éè¦éåä¸äºæªæ½åå°äººæµéæ¿å¢å¸¦æ¥çå±å®³ã\n\n\n# 2. å¸¸è§çéæµç®æ³\n\nå¸¸è§çéæµç®æ³æï¼\n\nå¸¸è§çéæµç®æ³\n\n * è®¡æ°å¨ç®æ³\n * æ»å¨çªå£ç®æ³\n * ä»¤çæ¡¶ç®æ³\n * æ¼æ¡¶ç®æ³\n\n\n# 2.1 è®¡ç®å¨ç®æ³\n\nè®¡æ°å¨ç®æ³(åç§°åºå®çªå£ç®æ³)æ¯æç®åçéæµç®æ³ï¼éè¿å¨åä½æ¶é´åç»´æ¤ä¸ä¸ªè®¡æ°å¨æ¥æ§å¶è¯¥æ¶é´åçæå¤§è®¿é®éã\nä¾å¦ï¼å®ä¹ä¸ä¸ªcounter, å¨1såå¤ä¸ä¸ªè¯·æ±å°±æå®å 1ï¼å½è¶è¿100æ¶å°±ä¸å¤çæ­¤è¯·æ±ï¼å¯ä»¥åå°100æ¬¡/1sçéæµã\nåæèï¼ä½¿ç¨Redisçexpireå½ä»¤ç»ä¸ä¸ªkeyè®¾ç½®ä¸º1sççå½å¨æï¼å¨1såå¤ä¸æ¬¡è¯·æ±å°±å ä¸ï¼å°äº100å°±ä¸å¤çåç»­è¯·æ±ã1sç»æåè¿ä¸ªkeyå°±æ¶å¤±äºï¼ äºæ¯å°±å¯ä»¥éæ°æ¥æ¶å¶ä»è¯·æ±ã\n(ä¸é¢åªåä¸¾åºç®åçå®ç°)\n\npublic class CounterRateLimiter extends MyRateLimiter {\n    /**\n     * æ¯ç§éå¶è¯·æ±æ°\n     */\n    private final long permitsPerSecond;\n    /**\n     * ä¸ä¸ä¸ªçªå£çå¼å§æ¶é´\n     */\n    public long timestamp = System.currentTimeMillis();\n    /**\n     * è®¡æ°å¨\n     */\n    private int counter;\n\n    public CounterRateLimiter(long permitsPerSecond) {\n        this.permitsPerSecond = permitsPerSecond;\n    }\n\n    @Override\n    public synchronized boolean tryAcquire() {\n        long now = System.currentTimeMillis();\n        // çªå£åè¯·æ±æ°éå°äºéå¼ï¼æ´æ°è®¡æ°æ¾è¡ï¼å¦åæç»è¯·æ±\n        if (now - timestamp < 1000) {\n            if (counter < permitsPerSecond) {\n                counter++;\n                return true;\n            } else {\n                return false;\n            }\n        }\n        // æ¶é´çªå£è¿æï¼éç½®è®¡æ°å¨åæ¶é´æ³\n        counter = 0;\n        timestamp = now;\n        return true;\n    }\n}\n\n\nè®¡æ°å¨çä¼ç¹å¾ææ¾ï¼æäºå®ç°ãå ç¨åå­å°ï¼æ¯ç«äººå®¶åªæ¯ç¨å°äºä¸ä¸ªKeyã\nä½æ¯ç¼ºç¹ä¹å¾ææ¾ï¼åå¦æä»¬è¦å®ç°1séæµ100æ¬¡ï¼æ­¤æ¶æä¸ä¸ªæ¶æäººåå¨0.99så1.1sååèµ·100æ¬¡è¯·æ±ï¼å¨ç®æ³ç¼éè¿æ¯åè®¸çï¼ä½æ¯æ¢ä¸ä¸ªè§åº¦ï¼è½ç¶ä»å¨0s-1sçæµéæ­£ç¡®ï¼å¨1s-2sçæµéä¹æ­£ç¡®ï¼ä½æ¯å¨0.5s-1.5sä»åäº200æ¬¡è¯·æ±å\nè¿ä¸ªå°±æ¯è®¡æ°å¨ç®æ³çä¸´çæåºã ä¸´çæåºæ¯æ æ³æ¶é¤çï¼æ¯ç«1så2sä¹é´æé´éï¼0.1mså0.2msä¹é´è¿æ¯æé´éçãæä»¥æä»¬åªè½å°½éåå°ä¸´çæåºçå½±åï¼æ­¤æ¶å°±å¯ä»¥ä½¿ç¨æ»å¨çªå£ç®æ³ã\n\n\n# 2.2 æ»å¨çªå£ç®æ³\n\nä¸ºä»ä¹ç§°è®¡æ°å¨ç®æ³ä¸ºåºå®çªå£ç®æ³ï¼å ä¸ºå®çæ¶é´çªå£æ¯ä¸åçï¼ç¬¬1såç¬¬2sæ°¸è¿é½æ¯åå¼çï¼ä½æ¯æä»¬éè¿åæçå­¦ä¹ ä¹äºè§£å°æ¶é´ä¹é´æ¯æä¸´çæåºçï¼æä»¬åªææçªå£å¨èµ·æ¥ï¼æå¯ä»¥åå°ä¸´çæåºå¸¦æ¥çæå¤±ã\næä¹å¨å¢ï¼ æä»¬å¯ä»¥å°1såä¸º10ä¸ª100msï¼å½æ¶é´èµ°å°0.5sæ¶ï¼æä»¬è®°å½çå°æ¯0.5s - 1.5s çæµéï¼æ¶é´åå¾åèµ°å°0.6sï¼æä»¬è®°å½çå°±æ¯0.6s - 1.6sï¼æ¯æ¬¡ä¸¢å¤±ä¹åç100msï¼æ¯æ¬¡å½å¥ç°å¨ç100msï¼ è¿æ ·å°±å¯ä»¥åå°ä¸´çæåºå¸¦æ¥çæå¤±ã\nçå¾ï¼\nå¦å¾æç¤ºï¼æ»å¨çªå£ä¸å±æ10ä¸ªï¼æ¯ä¸ª100msï¼ä¸å±å°±æ¯1sãæ­¤æ¶æ»å¨çªå£æ»å°äº1.1s - 2.1s\nç¬¬1.1så°1.2såæ¥åäº3ä¸ªè¯·æ±ï¼1.2så°1.3sæ¥æ¶å°10ä¸ªè¯·æ±....\nè¿1såå±æ¥æ¶å°48ä¸ªè¯·æ±ï¼æä»¥å¹¶æ²¡æä»»ä½æµéè¢«ä¸¢å¼ã\nç°å¨æ¶é´ååç§»å¨0.1s:\nååç§»å¨0.1såï¼æ­¤æ¶ççªå£è®°å½çæ¯ 1.2s - 2.2s ä¹é´çè¯·æ±æ°ãä¹åçè®°å½è¢«ä¸¢å¼ï¼æ°å¢ç2.1s-2.2sè¢«çº³å¥çªå£ã\nè¿æ ·çå¥½å¤æ¯ä¸æ­çæ´æ°æ¶é´çªå£ï¼åå°äºä¸´çæåºçä¸åçã\n\nä½æ¯\n\næ»å¨çªå£ä¹åªæ¯åå°äºä¸´çæåºçå½±åï¼æ æ³å½»åºæ¶é¤ã\n\nä½¿ç¨Javaä»£ç å®ç°ä¸ä¸ªç®åçæ»å¨çªå£éæµï¼\n\npublic class SlidingWindowRateLimiter extends MyRateLimiter {\n    /**\n     * æ¯åééå¶è¯·æ±æ°\n     */\n    private final long permitsPerMinute;\n    /**\n     * è®¡æ°å¨, k-ä¸ºå½åçªå£çå¼å§æ¶é´å¼ç§ï¼valueä¸ºå½åçªå£çè®¡æ°\n     */\n    private final TreeMap<Long, Integer> counters;\n\n    public SlidingWindowRateLimiter(long permitsPerMinute) {\n        this.permitsPerMinute = permitsPerMinute;\n        this.counters = new TreeMap<>();\n    }\n\n    @Override\n    public synchronized boolean tryAcquire() {\n        // è·åå½åæ¶é´çæå¨çå­çªå£å¼ï¼ 10sä¸ä¸ªçªå£\n        long currentWindowTime = LocalDateTime.now().toEpochSecond(ZoneOffset.UTC) / 10 * 10;\n        // è·åå½åçªå£çè¯·æ±æ»é\n        int currentWindowCount = getCurrentWindowCount(currentWindowTime);\n        if (currentWindowCount >= permitsPerMinute) {\n            return false;\n        }\n        // è®¡æ°å¨ + 1\n        counters.merge(currentWindowTime, 1, Integer::sum);\n        return true;\n    }\n    /**\n     * è·åå½åçªå£ä¸­çææè¯·æ±æ°ï¼å¹¶å é¤æææ æçå­çªå£è®¡æ°å¨ï¼\n     *\n     * @param currentWindowTime å½åå­çªå£æ¶é´\n     * @return å½åçªå£ä¸­çè®¡æ°\n     */\n    private int getCurrentWindowCount(long currentWindowTime) {\n        // è®¡ç®åºçªå£çå¼å§ä½ç½®æ¶é´\n        long startTime = currentWindowTime - 50;\n        int result = 0;\n\n        // éåå½åå­å¨çè®¡æ°å¨ï¼å é¤æ æçå­çªå£è®¡æ°å¨ï¼å¹¶ç´¯å å½åçªå£ä¸­çææè®¡æ°å¨ä¹å\n        Iterator<Map.Entry<Long, Integer>> iterator = counters.entrySet().iterator();\n        while (iterator.hasNext()) {\n            Map.Entry<Long, Integer> entry = iterator.next();\n            if (entry.getKey() < startTime) {\n                iterator.remove();\n            } else {\n                result += entry.getValue();\n            }\n        }\n        return result;\n    }\n}\n\n\nåæ ·ï¼ä¹å¯ä»¥åå©Rediså®ç°æ»å¨çªå£éæµï¼ä½¿ç¨Redisçzsetç»ææ¥å®ç°ççå¾èæ~\nzsetçåç§°å¯ä»¥ä½¿ç¨å¯ä¸æ è¯ç¡®å®ï¼ä¾å¦userIdãipãè¯·æ±æ¹æ³...\nzsetéé¢çæ¯ä¸ä¸ªå¼å¯ä»¥è®¾ç½®ä¸ºå½åæ¶é´ã\næ¯ä¸ä¸ªå¼å¯¹åºçscoreå¯ä»¥è®¾ç½®ä¸ºå½åæ¶é´ã è¿æ ·ï¼Rediså¯ä»¥ç»zsetä¸­çææå¼æåºï¼å ä¸ºæ¯æ¶é´æ³ï¼æä»¥å®ä¼ä»å°å°å¤§æåºï¼åé¢æä»¬å é¤çæ¶åç´æ¥å°æä¸é¢çæ°æ®å é¤ï¼å å¤å°ï¼å°äºå½åæ¶é´ - 1000çå¨é¨å é¤å°±è¡äºã\nï¼ç°å¨æ³æ³ï¼ä¸é¢è¿ä¸ªä¾å­ä¸¾çå¾çï¼å¤§å®¶å¯ä»¥ç´æ¥çä»£ç ï¼\nä¸¾ä¸ªä¾å­ï¼ç±äºæ¶é´æ³çç²¾åº¦å¤ªç»ï¼ä¼å¯¹ç»å¾é æå¾å¤§çå°æ°ï¼è¿éæä»¬åè®¾æ¯ä¸ä¸ªæ¶é´æ³æ¯0.01sï¼\nç°å¨æ¯ç¬¬10sï¼zsetä¸­å·²ç»è®°å½äº 9-10 ç§ä¸­çææè¯·æ±ã\n\næ³å é¤çæ¶åï¼åªéè¦å é¤å°äº 1000 - 0.01 * 1000 = 910 çæ°æ®ï¼å°±å¯ä»¥åä¸ç»è®¡ 910 ~ 1010çæ°æ®äºã\n\nå¦æä¸ä¸ªzsetä¸­çåç´ è¶è¿äºæä¸ªéå¼ï¼ç´æ¥å°ä»¥åçè¯·æ±ä¸å¤çå³å¯ã\n\npublic boolean isActionAllowed(String userId, String actionKey, int period, int maxCount) {\n    // çæå¯ä¸çkey\n    String key = String.format("hist:%s:%s", userId, actionKey);\n    long nowTs = System.currentTimeMillis();\n    // ä½¿ç¨ç®¡é\n    Pipeline pipe = jedis.pipelined();\n    pipe.multi();\n    // æ·»å å½åæä½å½zsetä¸­\n    pipe.zadd(key, nowTs, "" + nowTs);\n    // æ´çzsetï¼å é¤æ¶é´çªå£å¤çæ°æ®\n    pipe.zremrangeByScore(key, 0, nowTs - period * 1000);\n    Response<Long> count = pipe.zcard(key);\n    pipe.expire(key, period + 1);\n    pipe.exec();\n    pipe.close();\n    \n    return count.get() <= maxCount;\n}\n\n\nä½ å¯è½å¿è®°äºpipelineçæä½ï¼æ¥çè¿ä¸ªæ¹æ³çä½ç¨ï¼\n\n> pipeline.zremrangeByScore(para1, para2, para3)\n> ç¬¬ä¸ä¸ªåæ° ï¼zsetçåç§°\n> ç¬¬äºä¸ªåæ° ï¼è¦å é¤çåæ°èå´çä¸é\n> ç¬¬ä¸ä¸ªåæ° ï¼è¦å é¤çåæ°èå´çä¸é\n\nä½¿ç¨pipelineè¿æä¸ä¸ªå¥½å¤ï¼å®æ¯æ¹éæä½ï¼æä½æäº¤åå¹¶ä¸ä¼é©¬ä¸æ§è¡ï¼èæ¯ç­å¶ä»æä½ä¸èµ·æ¹éæ§è¡ã\næ»å¨çªå£çä¼ç¹æ¯åå°äºä¸´çæåºçå½±åï¼ä½ç¼ºç¹ä¹å¾ææ¾ï¼ä¸å¥½å®ç°ãç»´æ¤é¾ã\n\n\n# 2.3 ä»¤çæ¡¶ç®æ³\n\nä»¤çæ¡¶ç®æ³ï¼å®æçæä»¤çæ¾å¥æ¡¶ä¸­ï¼è¯·æ±åå»æ¡¶ä¸­æ¿ä»¤çï¼å¦ææ¿å°ä»¤çå°±å¯ä»¥æ§è¡ï¼å¦ææ²¡æ¿å°ä»¤çå°±ä¸æ§è¡ã\næ¡¶ä¸­çä»¤çå¯ä»¥å ç§¯ï¼åå³äºæ¡¶çå¤§å°ã ä»¤çæ¡¶çå¤çè¿ç¨æ¯è¿æ ·çï¼\n\n * çäº§ä»¤ç\n   åè®¾æä»¬è®¾ç½®çåééçä¸ºr,é£ä¹æ¯é1/rç§ï¼å°±çäº§ä¸ä¸ªä»¤çæ¾å¥æ¡¶ä¸­ã\n * ä»¤çä¸é\n   åè®¾ä»¤çæ¡¶çä¸éä¸ºNï¼å¦æä»¤çæ¡¶å·²ç»æ»¡äºï¼é£ä¹æ¾è¿æ¥çä»¤çå°±ä¼è¢«ä¸¢å¼\n * æ¶èä»¤ç\n   æ¯å½æ¶å°ä¸ä¸ªè¯·æ±ï¼å°±æ¶èæ1ä¸ªä»¤ç\n * çªåæµé\n   å ä¸ºæ¡¶çä¸éä¸ºNï¼é£ä¹æå¤å°±åè®¸Nä¸ªè¯·æ±ççªåæµé\n * éæµå¤ç\n   å ä¸ºçäº§ä»¤ççéçæ¯åºå®çï¼æä»¥è¯·æ±çå¤çä¹æ¯éå®ç\n\npublic class TokenBucketLimiter {\n\n    private int capaticy; //ä»¤çæ¡¶å®¹é\n    private int rate; //ä»¤çäº§çéç\n    private int tokenAmount; //ä»¤çæ°é\n\n    public TokenBucketLimiter(int capaticy, int rate) {\n        this.capaticy = capaticy;\n        this.rate = rate;\n        tokenAmount = capaticy;\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                //ä»¥æå®éçæ¾ä»¤ç\n                while (true){\n                    synchronized (this){\n                        tokenAmount ++;\n                        if(tokenAmount > capaticy){\n                            tokenAmount = capaticy;\n                        }\n                    }\n                    try {\n                        Thread.sleep(1000 / rate);\n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        }).start();\n    }\n\n    public synchronized boolean tryAcquire(Request request){\n        // å¦ææ¡¶ä¸­è¿æä»¤çï¼æ¿èµ°ä¸ä¸ª \n        if(tokenAmount > 0){\n            tokenAmount --;\n            // è¿éçç¥å¤çè¯·æ±çä»£ç ....\n            return true;\n        }else{\n        \n            return false;\n        }\n\n    }\n    \n}\n \n\n\nä»¤çæ¡¶ç®æ³ä¸è¬ç¨äºä¿æ¤èªèº«çç³»ç»ï¼å¯¹å®¢æ·çè¯·æ±è¿è¡éæµï¼ä¿æ¤èªå·±ä¸è¢«çªåæµéæå®ãä½æ¯å®çç¼ºç¹å°±æ¯ä¼ä¸¢å¼å¾å¤è¯·æ±ã\n\n\n# 2.4 æ¼æ¡¶ç®æ³\n\nè·ä»¤çæ¡¶ç®æ³æç¹ç±»ä¼¼ï¼ä¸è¿ä»¤çæ¡¶ç®æ³æ¯å°ä»¤çæ¾å¥æ¡¶ä¸­ï¼èæ¼æ¡¶ç®æ³æ¯å°è¯·æ±æ¾å¥æ¡¶ä¸­ï¼ä»¥ä¸å®éåº¦å°è¯·æ±"æ¼åºæ¥"å¤çã\nè¿è·æ¶æ¯éåçææ³å°±å¾åäºãè¿ç§ç®æ³éç¨äºä¿æ¤å®¢æ·çç³»ç»ï¼å°½éä¸è®©å®¢æ·çæä½ä¸¢å¼ï¼å³ä½¿æ²¡åæ³ç¬¬ä¸æ¶é´å¤çï¼ä¹è¦å­èµ·æ¥æ¢æ¢æ¥ã\n\npublic class LeakyBucketLimiter {\n\n    private int capaticy;//æ¼æå®¹é\n    private int rate;//æ¼æéç\n    private int left;//å©ä½å®¹é\n    private LinkedList<Request> requestList;\n\n    public LeakyBucketLimiter(int capaticy, int rate) {\n        this.capaticy = capaticy;\n        this.rate = rate;\n        this.left = capaticy;\n        requestList = new LinkedList<>();\n\n        //å¼å¯ä¸ä¸ªå®æ¶çº¿ç¨ï¼ä»¥åºå®çéçå°æ¼æä¸­çè¯·æ±æµåºï¼è¿è¡å¤ç\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                while(true){\n                    if(!requestList.isEmpty()){\n                        Request request = requestList.removeFirst();\n                        // æ­¤æ¹æ³æ¯æ§è¡è¯·æ±çæ¹æ³\n                        handleRequest(request);\n                    }\n                    try {\n                        Thread.sleep(1000 / rate); //ç¡ç \n                    } catch (InterruptedException e) {\n                        e.printStackTrace();\n                    }\n                }\n            }\n        }).start();\n    }\n\n    public synchronized boolean tryAcquire(Request request){\n        if(left <= 0){\n            return false;\n        }else{\n            left --;\n            requestList.addLast(request);\n            return true;\n        }\n    }\n\n}\n\n \n\n\n\n# 3. æ»ç»\n\nä»¥ä¸å°±æ¯åç§å¸¸è§çéæµç®æ³çææ³åå®ç°ãç®æ³æ²¡æä¼å£ï¼åªææ¯å¦åé~',normalizedContent:'# éæµç®æ³\n\n\n# 1. ä»ä¹æ¯éæµ\n\nä»ä¹æ¯éæµ\n\néæµï¼ä¹ç§°æµéæ§å¶ã\næ¯æå¨ç³»ç»é¢ä¸´é«å¹¶åæåµä¸ï¼éå¶æ°çè¯·æ±å¯¹ç³»ç»çè®¿é®ï¼ä»èä¿è¯ç³»ç»çç¨³å®æ§ã\n\nä¸¾ä¸äºä¾å­ï¼\n\n * æ¯åºä¼å¯¹äººæµéè¿è¡æ§å¶ï¼ä¾å¦æ¯å¤©åºå®åå¤å°é¨ç¥¨ã\n * è¿æ®µæ¶é´æå°çç§ç¤å¾ç«ï¼ä½æ¯åªææéçäººåå¤ï¼ç§ç¤çéåº¦å°±è¿ä¹å¿«ï¼å°±éè¦éåä¸äºæªæ½åå°äººæµéæ¿å¢å¸¦æ¥çå±å®³ã\n\n\n# 2. å¸¸è§çéæµç®æ³\n\nå¸¸è§çéæµç®æ³æï¼\n\nå¸¸è§çéæµç®æ³\n\n * è®¡æ°å¨ç®æ³\n * æ»å¨çªå£ç®æ³\n * ä»¤çæ¡¶ç®æ³\n * æ¼æ¡¶ç®æ³\n\n\n# 2.1 è®¡ç®å¨ç®æ³\n\nè®¡æ°å¨ç®æ³(åç§°åºå®çªå£ç®æ³)æ¯æç®åçéæµç®æ³ï¼éè¿å¨åä½æ¶é´åç»´æ¤ä¸ä¸ªè®¡æ°å¨æ¥æ§å¶è¯¥æ¶é´åçæå¤§è®¿é®éã\nä¾å¦ï¼å®ä¹ä¸ä¸ªcounter, å¨1såå¤ä¸ä¸ªè¯·æ±å°±æå®å 1ï¼å½è¶è¿100æ¶å°±ä¸å¤çæ­¤è¯·æ±ï¼å¯ä»¥åå°100æ¬¡/1sçéæµã\nåæèï¼ä½¿ç¨redisçexpireå½ä»¤ç»ä¸ä¸ªkeyè®¾ç½®ä¸º1sççå½å¨æï¼å¨1såå¤ä¸æ¬¡è¯·æ±å°±å ä¸ï¼å°äº100å°±ä¸å¤çåç»­è¯·æ±ã1sç»æåè¿ä¸ªkeyå°±æ¶å¤±äºï¼ äºæ¯å°±å¯ä»¥éæ°æ¥æ¶å¶ä»è¯·æ±ã\n(ä¸é¢åªåä¸¾åºç®åçå®ç°)\n\npublic class counterratelimiter extends myratelimiter {\n    /**\n     * æ¯ç§éå¶è¯·æ±æ°\n     */\n    private final long permitspersecond;\n    /**\n     * ä¸ä¸ä¸ªçªå£çå¼å§æ¶é´\n     */\n    public long timestamp = system.currenttimemillis();\n    /**\n     * è®¡æ°å¨\n     */\n    private int counter;\n\n    public counterratelimiter(long permitspersecond) {\n        this.permitspersecond = permitspersecond;\n    }\n\n    @override\n    public synchronized boolean tryacquire() {\n        long now = system.currenttimemillis();\n        // çªå£åè¯·æ±æ°éå°äºéå¼ï¼æ´æ°è®¡æ°æ¾è¡ï¼å¦åæç»è¯·æ±\n        if (now - timestamp < 1000) {\n            if (counter < permitspersecond) {\n                counter++;\n                return true;\n            } else {\n                return false;\n            }\n        }\n        // æ¶é´çªå£è¿æï¼éç½®è®¡æ°å¨åæ¶é´æ³\n        counter = 0;\n        timestamp = now;\n        return true;\n    }\n}\n\n\nè®¡æ°å¨çä¼ç¹å¾ææ¾ï¼æäºå®ç°ãå ç¨åå­å°ï¼æ¯ç«äººå®¶åªæ¯ç¨å°äºä¸ä¸ªkeyã\nä½æ¯ç¼ºç¹ä¹å¾ææ¾ï¼åå¦æä»¬è¦å®ç°1séæµ100æ¬¡ï¼æ­¤æ¶æä¸ä¸ªæ¶æäººåå¨0.99så1.1sååèµ·100æ¬¡è¯·æ±ï¼å¨ç®æ³ç¼éè¿æ¯åè®¸çï¼ä½æ¯æ¢ä¸ä¸ªè§åº¦ï¼è½ç¶ä»å¨0s-1sçæµéæ­£ç¡®ï¼å¨1s-2sçæµéä¹æ­£ç¡®ï¼ä½æ¯å¨0.5s-1.5sä»åäº200æ¬¡è¯·æ±å\nè¿ä¸ªå°±æ¯è®¡æ°å¨ç®æ³çä¸´çæåºã ä¸´çæåºæ¯æ æ³æ¶é¤çï¼æ¯ç«1så2sä¹é´æé´éï¼0.1mså0.2msä¹é´è¿æ¯æé´éçãæä»¥æä»¬åªè½å°½éåå°ä¸´çæåºçå½±åï¼æ­¤æ¶å°±å¯ä»¥ä½¿ç¨æ»å¨çªå£ç®æ³ã\n\n\n# 2.2 æ»å¨çªå£ç®æ³\n\nä¸ºä»ä¹ç§°è®¡æ°å¨ç®æ³ä¸ºåºå®çªå£ç®æ³ï¼å ä¸ºå®çæ¶é´çªå£æ¯ä¸åçï¼ç¬¬1såç¬¬2sæ°¸è¿é½æ¯åå¼çï¼ä½æ¯æä»¬éè¿åæçå­¦ä¹ ä¹äºè§£å°æ¶é´ä¹é´æ¯æä¸´çæåºçï¼æä»¬åªææçªå£å¨èµ·æ¥ï¼æå¯ä»¥åå°ä¸´çæåºå¸¦æ¥çæå¤±ã\næä¹å¨å¢ï¼ æä»¬å¯ä»¥å°1såä¸º10ä¸ª100msï¼å½æ¶é´èµ°å°0.5sæ¶ï¼æä»¬è®°å½çå°æ¯0.5s - 1.5s çæµéï¼æ¶é´åå¾åèµ°å°0.6sï¼æä»¬è®°å½çå°±æ¯0.6s - 1.6sï¼æ¯æ¬¡ä¸¢å¤±ä¹åç100msï¼æ¯æ¬¡å½å¥ç°å¨ç100msï¼ è¿æ ·å°±å¯ä»¥åå°ä¸´çæåºå¸¦æ¥çæå¤±ã\nçå¾ï¼\nå¦å¾æç¤ºï¼æ»å¨çªå£ä¸å±æ10ä¸ªï¼æ¯ä¸ª100msï¼ä¸å±å°±æ¯1sãæ­¤æ¶æ»å¨çªå£æ»å°äº1.1s - 2.1s\nç¬¬1.1så°1.2såæ¥åäº3ä¸ªè¯·æ±ï¼1.2så°1.3sæ¥æ¶å°10ä¸ªè¯·æ±....\nè¿1såå±æ¥æ¶å°48ä¸ªè¯·æ±ï¼æä»¥å¹¶æ²¡æä»»ä½æµéè¢«ä¸¢å¼ã\nç°å¨æ¶é´ååç§»å¨0.1s:\nååç§»å¨0.1såï¼æ­¤æ¶ççªå£è®°å½çæ¯ 1.2s - 2.2s ä¹é´çè¯·æ±æ°ãä¹åçè®°å½è¢«ä¸¢å¼ï¼æ°å¢ç2.1s-2.2sè¢«çº³å¥çªå£ã\nè¿æ ·çå¥½å¤æ¯ä¸æ­çæ´æ°æ¶é´çªå£ï¼åå°äºä¸´çæåºçä¸åçã\n\nä½æ¯\n\næ»å¨çªå£ä¹åªæ¯åå°äºä¸´çæåºçå½±åï¼æ æ³å½»åºæ¶é¤ã\n\nä½¿ç¨javaä»£ç å®ç°ä¸ä¸ªç®åçæ»å¨çªå£éæµï¼\n\npublic class slidingwindowratelimiter extends myratelimiter {\n    /**\n     * æ¯åééå¶è¯·æ±æ°\n     */\n    private final long permitsperminute;\n    /**\n     * è®¡æ°å¨, k-ä¸ºå½åçªå£çå¼å§æ¶é´å¼ç§ï¼valueä¸ºå½åçªå£çè®¡æ°\n     */\n    private final treemap<long, integer> counters;\n\n    public slidingwindowratelimiter(long permitsperminute) {\n        this.permitsperminute = permitsperminute;\n        this.counters = new treemap<>();\n    }\n\n    @override\n    public synchronized boolean tryacquire() {\n        // è·åå½åæ¶é´çæå¨çå­çªå£å¼ï¼ 10sä¸ä¸ªçªå£\n        long currentwindowtime = localdatetime.now().toepochsecond(zoneoffset.utc) / 10 * 10;\n        // è·åå½åçªå£çè¯·æ±æ»é\n        int currentwindowcount = getcurrentwindowcount(currentwindowtime);\n        if (currentwindowcount >= permitsperminute) {\n            return false;\n        }\n        // è®¡æ°å¨ + 1\n        counters.merge(currentwindowtime, 1, integer::sum);\n        return true;\n    }\n    /**\n     * è·åå½åçªå£ä¸­çææè¯·æ±æ°ï¼å¹¶å é¤æææ æçå­çªå£è®¡æ°å¨ï¼\n     *\n     * @param currentwindowtime å½åå­çªå£æ¶é´\n     * @return å½åçªå£ä¸­çè®¡æ°\n     */\n    private int getcurrentwindowcount(long currentwindowtime) {\n        // è®¡ç®åºçªå£çå¼å§ä½ç½®æ¶é´\n        long starttime = currentwindowtime - 50;\n        int result = 0;\n\n        // éåå½åå­å¨çè®¡æ°å¨ï¼å é¤æ æçå­çªå£è®¡æ°å¨ï¼å¹¶ç´¯å å½åçªå£ä¸­çææè®¡æ°å¨ä¹å\n        iterator<map.entry<long, integer>> iterator = counters.entryset().iterator();\n        while (iterator.hasnext()) {\n            map.entry<long, integer> entry = iterator.next();\n            if (entry.getkey() < starttime) {\n                iterator.remove();\n            } else {\n                result += entry.getvalue();\n            }\n        }\n        return result;\n    }\n}\n\n\nåæ ·ï¼ä¹å¯ä»¥åå©rediså®ç°æ»å¨çªå£éæµï¼ä½¿ç¨redisçzsetç»ææ¥å®ç°ççå¾èæ~\nzsetçåç§°å¯ä»¥ä½¿ç¨å¯ä¸æ è¯ç¡®å®ï¼ä¾å¦useridãipãè¯·æ±æ¹æ³...\nzsetéé¢çæ¯ä¸ä¸ªå¼å¯ä»¥è®¾ç½®ä¸ºå½åæ¶é´ã\næ¯ä¸ä¸ªå¼å¯¹åºçscoreå¯ä»¥è®¾ç½®ä¸ºå½åæ¶é´ã è¿æ ·ï¼rediså¯ä»¥ç»zsetä¸­çææå¼æåºï¼å ä¸ºæ¯æ¶é´æ³ï¼æä»¥å®ä¼ä»å°å°å¤§æåºï¼åé¢æä»¬å é¤çæ¶åç´æ¥å°æä¸é¢çæ°æ®å é¤ï¼å å¤å°ï¼å°äºå½åæ¶é´ - 1000çå¨é¨å é¤å°±è¡äºã\nï¼ç°å¨æ³æ³ï¼ä¸é¢è¿ä¸ªä¾å­ä¸¾çå¾çï¼å¤§å®¶å¯ä»¥ç´æ¥çä»£ç ï¼\nä¸¾ä¸ªä¾å­ï¼ç±äºæ¶é´æ³çç²¾åº¦å¤ªç»ï¼ä¼å¯¹ç»å¾é æå¾å¤§çå°æ°ï¼è¿éæä»¬åè®¾æ¯ä¸ä¸ªæ¶é´æ³æ¯0.01sï¼\nç°å¨æ¯ç¬¬10sï¼zsetä¸­å·²ç»è®°å½äº 9-10 ç§ä¸­çææè¯·æ±ã\n\næ³å é¤çæ¶åï¼åªéè¦å é¤å°äº 1000 - 0.01 * 1000 = 910 çæ°æ®ï¼å°±å¯ä»¥åä¸ç»è®¡ 910 ~ 1010çæ°æ®äºã\n\nå¦æä¸ä¸ªzsetä¸­çåç´ è¶è¿äºæä¸ªéå¼ï¼ç´æ¥å°ä»¥åçè¯·æ±ä¸å¤çå³å¯ã\n\npublic boolean isactionallowed(string userid, string actionkey, int period, int maxcount) {\n    // çæå¯ä¸çkey\n    string key = string.format("hist:%s:%s", userid, actionkey);\n    long nowts = system.currenttimemillis();\n    // ä½¿ç¨ç®¡é\n    pipeline pipe = jedis.pipelined();\n    pipe.multi();\n    // æ·»å å½åæä½å½zsetä¸­\n    pipe.zadd(key, nowts, "" + nowts);\n    // æ´çzsetï¼å é¤æ¶é´çªå£å¤çæ°æ®\n    pipe.zremrangebyscore(key, 0, nowts - period * 1000);\n    response<long> count = pipe.zcard(key);\n    pipe.expire(key, period + 1);\n    pipe.exec();\n    pipe.close();\n    \n    return count.get() <= maxcount;\n}\n\n\nä½ å¯è½å¿è®°äºpipelineçæä½ï¼æ¥çè¿ä¸ªæ¹æ³çä½ç¨ï¼\n\n> pipeline.zremrangebyscore(para1, para2, para3)\n> ç¬¬ä¸ä¸ªåæ° ï¼zsetçåç§°\n> ç¬¬äºä¸ªåæ° ï¼è¦å é¤çåæ°èå´çä¸é\n> ç¬¬ä¸ä¸ªåæ° ï¼è¦å é¤çåæ°èå´çä¸é\n\nä½¿ç¨pipelineè¿æä¸ä¸ªå¥½å¤ï¼å®æ¯æ¹éæä½ï¼æä½æäº¤åå¹¶ä¸ä¼é©¬ä¸æ§è¡ï¼èæ¯ç­å¶ä»æä½ä¸èµ·æ¹éæ§è¡ã\næ»å¨çªå£çä¼ç¹æ¯åå°äºä¸´çæåºçå½±åï¼ä½ç¼ºç¹ä¹å¾ææ¾ï¼ä¸å¥½å®ç°ãç»´æ¤é¾ã\n\n\n# 2.3 ä»¤çæ¡¶ç®æ³\n\nä»¤çæ¡¶ç®æ³ï¼å®æçæä»¤çæ¾å¥æ¡¶ä¸­ï¼è¯·æ±åå»æ¡¶ä¸­æ¿ä»¤çï¼å¦ææ¿å°ä»¤çå°±å¯ä»¥æ§è¡ï¼å¦ææ²¡æ¿å°ä»¤çå°±ä¸æ§è¡ã\næ¡¶ä¸­çä»¤çå¯ä»¥å ç§¯ï¼åå³äºæ¡¶çå¤§å°ã ä»¤çæ¡¶çå¤çè¿ç¨æ¯è¿æ ·çï¼\n\n * çäº§ä»¤ç\n   åè®¾æä»¬è®¾ç½®çåééçä¸ºr,é£ä¹æ¯é1/rç§ï¼å°±çäº§ä¸ä¸ªä»¤çæ¾å¥æ¡¶ä¸­ã\n * ä»¤çä¸é\n   åè®¾ä»¤çæ¡¶çä¸éä¸ºnï¼å¦æä»¤çæ¡¶å·²ç»æ»¡äºï¼é£ä¹æ¾è¿æ¥çä»¤çå°±ä¼è¢«ä¸¢å¼\n * æ¶èä»¤ç\n   æ¯å½æ¶å°ä¸ä¸ªè¯·æ±ï¼å°±æ¶èæ1ä¸ªä»¤ç\n * çªåæµé\n   å ä¸ºæ¡¶çä¸éä¸ºnï¼é£ä¹æå¤å°±åè®¸nä¸ªè¯·æ±ççªåæµé\n * éæµå¤ç\n   å ä¸ºçäº§ä»¤ççéçæ¯åºå®çï¼æä»¥è¯·æ±çå¤çä¹æ¯éå®ç\n\npublic class tokenbucketlimiter {\n\n    private int capaticy; //ä»¤çæ¡¶å®¹é\n    private int rate; //ä»¤çäº§çéç\n    private int tokenamount; //ä»¤çæ°é\n\n    public tokenbucketlimiter(int capaticy, int rate) {\n        this.capaticy = capaticy;\n        this.rate = rate;\n        tokenamount = capaticy;\n        new thread(new runnable() {\n            @override\n            public void run() {\n                //ä»¥æå®éçæ¾ä»¤ç\n                while (true){\n                    synchronized (this){\n                        tokenamount ++;\n                        if(tokenamount > capaticy){\n                            tokenamount = capaticy;\n                        }\n                    }\n                    try {\n                        thread.sleep(1000 / rate);\n                    } catch (interruptedexception e) {\n                        e.printstacktrace();\n                    }\n                }\n            }\n        }).start();\n    }\n\n    public synchronized boolean tryacquire(request request){\n        // å¦ææ¡¶ä¸­è¿æä»¤çï¼æ¿èµ°ä¸ä¸ª \n        if(tokenamount > 0){\n            tokenamount --;\n            // è¿éçç¥å¤çè¯·æ±çä»£ç ....\n            return true;\n        }else{\n        \n            return false;\n        }\n\n    }\n    \n}\n \n\n\nä»¤çæ¡¶ç®æ³ä¸è¬ç¨äºä¿æ¤èªèº«çç³»ç»ï¼å¯¹å®¢æ·çè¯·æ±è¿è¡éæµï¼ä¿æ¤èªå·±ä¸è¢«çªåæµéæå®ãä½æ¯å®çç¼ºç¹å°±æ¯ä¼ä¸¢å¼å¾å¤è¯·æ±ã\n\n\n# 2.4 æ¼æ¡¶ç®æ³\n\nè·ä»¤çæ¡¶ç®æ³æç¹ç±»ä¼¼ï¼ä¸è¿ä»¤çæ¡¶ç®æ³æ¯å°ä»¤çæ¾å¥æ¡¶ä¸­ï¼èæ¼æ¡¶ç®æ³æ¯å°è¯·æ±æ¾å¥æ¡¶ä¸­ï¼ä»¥ä¸å®éåº¦å°è¯·æ±"æ¼åºæ¥"å¤çã\nè¿è·æ¶æ¯éåçææ³å°±å¾åäºãè¿ç§ç®æ³éç¨äºä¿æ¤å®¢æ·çç³»ç»ï¼å°½éä¸è®©å®¢æ·çæä½ä¸¢å¼ï¼å³ä½¿æ²¡åæ³ç¬¬ä¸æ¶é´å¤çï¼ä¹è¦å­èµ·æ¥æ¢æ¢æ¥ã\n\npublic class leakybucketlimiter {\n\n    private int capaticy;//æ¼æå®¹é\n    private int rate;//æ¼æéç\n    private int left;//å©ä½å®¹é\n    private linkedlist<request> requestlist;\n\n    public leakybucketlimiter(int capaticy, int rate) {\n        this.capaticy = capaticy;\n        this.rate = rate;\n        this.left = capaticy;\n        requestlist = new linkedlist<>();\n\n        //å¼å¯ä¸ä¸ªå®æ¶çº¿ç¨ï¼ä»¥åºå®çéçå°æ¼æä¸­çè¯·æ±æµåºï¼è¿è¡å¤ç\n        new thread(new runnable() {\n            @override\n            public void run() {\n                while(true){\n                    if(!requestlist.isempty()){\n                        request request = requestlist.removefirst();\n                        // æ­¤æ¹æ³æ¯æ§è¡è¯·æ±çæ¹æ³\n                        handlerequest(request);\n                    }\n                    try {\n                        thread.sleep(1000 / rate); //ç¡ç \n                    } catch (interruptedexception e) {\n                        e.printstacktrace();\n                    }\n                }\n            }\n        }).start();\n    }\n\n    public synchronized boolean tryacquire(request request){\n        if(left <= 0){\n            return false;\n        }else{\n            left --;\n            requestlist.addlast(request);\n            return true;\n        }\n    }\n\n}\n\n \n\n\n\n# 3. æ»ç»\n\nä»¥ä¸å°±æ¯åç§å¸¸è§çéæµç®æ³çææ³åå®ç°ãç®æ³æ²¡æä¼å£ï¼åªææ¯å¦åé~',charsets:{cjk:!0},lastUpdated:"2023/07/28, 15:53:40",lastUpdatedTimestamp:169053082e4},{title:"ä¸è´æ§åå¸ç®æ³",frontmatter:{title:"ä¸è´æ§åå¸ç®æ³",date:"2023-11-09T12:25:01.000Z",permalink:"/pages/7e25cb/"},regularPath:"/02.%E6%96%87%E7%AB%A0/85.%E7%AE%97%E6%B3%95/30.%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95.html",relativePath:"02.æç« /85.ç®æ³/30.ä¸è´æ§åå¸ç®æ³.md",key:"v-ed0ea22a",path:"/pages/7e25cb/",headers:[{level:2,title:"1. æ®éåå¸",slug:"_1-æ®éåå¸",normalizedTitle:"1. æ®éåå¸",charIndex:2},{level:2,title:"2. ä¸è´æ§åå¸",slug:"_2-ä¸è´æ§åå¸",normalizedTitle:"2. ä¸è´æ§åå¸",charIndex:445}],headersStr:"1. æ®éåå¸ 2. ä¸è´æ§åå¸",content:"# 1. æ®éåå¸\n\nå¨ä»ç»ä¸è´æ§åå¸ç®æ³ä¹åï¼åè¯´ä¸ä¸æ®éçåå¸ç®æ³ï¼ä»¥ä¾¿ä»ç»å®ä¿©çåºå«ã\n\nå¨è´è½½åè¡¡ä¸­ï¼ä½¿ç¨æ®éçåå¸ç®æ³è¿è¡è´è½½åè¡¡ï¼åå¦ç¨æ·ä¸ä¼ ä¸ä¸ªå¾çï¼æä»¬æä¸å°æå¡å¨å¯ä»¥å­å¨ï¼ä¸ä¼ å°åªä¸ä¸ªå¾çï¼\n\n 1. å°æå¡å¨ç¼å·ï¼0ã1ã2\n 2. å°å¾çè¿è¡åå¸ç®æ³ï¼hashï¼å¾çï¼= 13ï¼å¾å°ç hash å¼åè·æºå¨çæ°éåæ¨¡ï¼13 % 3 = 1ï¼å°å¾çå­å¨å°æå¡å¨1 ä¸­ã\n 3. ä»¥åè®¿é®è¯¥å¾çï¼æç§ä¸è¿°é¡ºåºå¾å°å­å¨å¾ççæºå¨å³å¯ã\n\nä½æ¯ï¼æ®éåå¸æä¸ªå¾å¤§çåå¤ï¼åå¦æåæ·»å äºä¸¤å°æºå¨ï¼æ­¤æ¶æºå¨æ°éåæ 5ï¼ä¹åé£å¼ å¾çä½¿ç¨ hashï¼å¾çï¼= 13ï¼åæ¨¡ 13 % 5 = 3ï¼äºæ¯ç¨åºå» æå¡å¨2 æ¾å¾çï¼ä½æ¯æä»¬çå¾çä¹åå­å¨å¨ æå¡å¨1ãbugä¸å°±æ¥äºï¼\n\n> çå°è¿éä½ åºè¯¥æè¯å°ï¼ä¸æ¦æå¡å¨æ°éä¿®æ¹ï¼hashä¹åçåæ¨¡è¿ç®å°±ä¼æ¹åï¼å¯¹åºçè®¡ç®ç»æä¹å°±æ¹åäºï¼ä¹åçè®¡ç®ç»æ ä¸ ç°å¨çè®¡ç®ç»æ ä¸ä¸æ ·ï¼ç»å¤§å¤æ°æ°æ®å°±éè¦éæ°å­å¨ãè¿æ¯ä¸ªè´å½éè¯¯ã\n\n\n# 2. ä¸è´æ§åå¸\n\næ®éåå¸å¤±è¯¯å°±å¤±è¯¯å¨å¯¹æºå¨æ°éåæ¨¡ä¸ï¼æä»¬ä¸å¯¹æºå¨æ°åæ¨¡ï¼å¯¹ 2^32 åæ¨¡ï¼ä»ä¹ææå¢ï¼\n\næä»¬é¦åå° [0ï¼ 2^32-1] å´æä¸ä¸ªååï¼\n\n\n\nå¦å¾ï¼0 çå·¦ä¾§å°±æ¯ 2^32-1ãæä»¬æè¿ä¸ªç± 2^32 ä¸ªæ°ç»æçååç§°ä¸ºåå¸ç¯\n\näºæ¯æä»¬å­å¾ççæ­¥éª¤åä¸ºï¼\n\nå°æå¡å¨çå°åè®¡ç®åå¸å¼ï¼hash(æå¡å¨)ï¼ç¨è¿ä¸ªå¼ä¸ 2^32 åæ¨¡ï¼é£ä¹æææå¡å¨é½ä¼å¨è¿ä¸ªååä¸ä»£è¡¨ä¸ä¸ªç¹\n\nå°è¦å­å¨çå¾çè®¡ç®åå¸å¼ï¼hash(å¾ç)ï¼ç¨è¿ä¸ªå¼ä¸ 2^32 åæ¨¡ï¼é£ä¹ææå¾çé½ä¼å¨è¿ä¸ªååä¸ä»£è¡¨ä¸ä¸ªç¹\n\næä¹ç»è¿äºå¾çéæ©ä¸ä¸ªæå¡å¨å¢ï¼åªéè¦å¨è¿ä¸ªç¯ä¸ä¸ç´å¾åéåå°±è¡äºï¼ä¸å¾ä¸­å·¦è¾¹ä¸ä¸ªå¾çå­å¨å¨æå¡å¨Aï¼å³è¾¹çä¸ä¸ªå¾çå­å¨å¨æå¡å¨Cã\n\nç¨åºæ¥æ¾æ¶ä¹å¯ä»¥è¿æ ·åï¼è®¡ç®hashå¼ -> ä¸ 2^32 åæ¨¡ -> æ¾å¨åå¸ç¯ä¸å¾å³æ¾ç¬¬ä¸ä¸ªæå¡å¨ã\n\néå°æå¡å¨å®æºæèæ°å¢æå¡å¨æ¶ï¼å°±å¯ä»¥åªç ´åä¸é¨åæ°æ®ï¼ä¿æ¤å¶ä½æ°æ®ã\n\nåå¦æ­¤æ¶ æå¡å¨C å®æºï¼é£ä¹å³è¾¹çä¸ä¸ªæä»¶å°±åªè½å­å¨å° æå¡å¨B ä¸­ï¼ä½æ¯ä¹ä»ä»æ¯ä¸ä¸ªæä»¶ã\n\nä¸è´æ§åå¸ççä¼ç¼ºç¹ï¼\n\n * ä¼ç¹ ï¼éå°èç¹ä¸ç¨³å®çæåµå¯ä»¥ä¿æ¤å¤æ°æ°æ®\n\n * ç¼ºç¹ ï¼å¨èç¹æ°éå¤ªå°çæåµä¸ï¼å®¹æå ä¸ºèç¹åå¸ä¸ååèé ææ°æ®å¾æé®é¢ï¼ä¹å°±æ¯è¢«ç¼å­çæ°æ®å¤§é½éä¸­å­å¨å¨æä¸ªèç¹ä¸ï¼ä»èåºç°æ°æ®åå¸ä¸ååçæåµï¼è¿ç§æåµè¢«ç§°ä¸ºåå¸å¾æ\n\nä¸ºäºè§£å³è¿ç§æ°æ®å¾æé®é¢ï¼ä¸è´æ§åå¸ç®æ³å¼å¥äºèæèç¹æºå¶ï¼å³å¯¹æ¯ä¸ä¸ªèç¹é½è®¡ç®å¤ä¸ªåå¸å¼ï¼æ¯ä¸ªè®¡ç®ç»æé½æ¾ç½®å¨åå¸ç¯ä¸ï¼ç§°ä¸ºèæèç¹ãä¸ä¸ªå®éçç©çèç¹å¯ä»¥å¯¹åºå¤ä¸ªèæèç¹ï¼èæèç¹è¶å¤ï¼åå¸ç¯ä¸çèç¹å°±è¶å¤ï¼æ°æ®è¢«åååéçæ¦çå°±è¶å¤§ï¼åå¸ç¯å¾æé æçå½±åå°±è¶å°ã",normalizedContent:"# 1. æ®éåå¸\n\nå¨ä»ç»ä¸è´æ§åå¸ç®æ³ä¹åï¼åè¯´ä¸ä¸æ®éçåå¸ç®æ³ï¼ä»¥ä¾¿ä»ç»å®ä¿©çåºå«ã\n\nå¨è´è½½åè¡¡ä¸­ï¼ä½¿ç¨æ®éçåå¸ç®æ³è¿è¡è´è½½åè¡¡ï¼åå¦ç¨æ·ä¸ä¼ ä¸ä¸ªå¾çï¼æä»¬æä¸å°æå¡å¨å¯ä»¥å­å¨ï¼ä¸ä¼ å°åªä¸ä¸ªå¾çï¼\n\n 1. å°æå¡å¨ç¼å·ï¼0ã1ã2\n 2. å°å¾çè¿è¡åå¸ç®æ³ï¼hashï¼å¾çï¼= 13ï¼å¾å°ç hash å¼åè·æºå¨çæ°éåæ¨¡ï¼13 % 3 = 1ï¼å°å¾çå­å¨å°æå¡å¨1 ä¸­ã\n 3. ä»¥åè®¿é®è¯¥å¾çï¼æç§ä¸è¿°é¡ºåºå¾å°å­å¨å¾ççæºå¨å³å¯ã\n\nä½æ¯ï¼æ®éåå¸æä¸ªå¾å¤§çåå¤ï¼åå¦æåæ·»å äºä¸¤å°æºå¨ï¼æ­¤æ¶æºå¨æ°éåæ 5ï¼ä¹åé£å¼ å¾çä½¿ç¨ hashï¼å¾çï¼= 13ï¼åæ¨¡ 13 % 5 = 3ï¼äºæ¯ç¨åºå» æå¡å¨2 æ¾å¾çï¼ä½æ¯æä»¬çå¾çä¹åå­å¨å¨ æå¡å¨1ãbugä¸å°±æ¥äºï¼\n\n> çå°è¿éä½ åºè¯¥æè¯å°ï¼ä¸æ¦æå¡å¨æ°éä¿®æ¹ï¼hashä¹åçåæ¨¡è¿ç®å°±ä¼æ¹åï¼å¯¹åºçè®¡ç®ç»æä¹å°±æ¹åäºï¼ä¹åçè®¡ç®ç»æ ä¸ ç°å¨çè®¡ç®ç»æ ä¸ä¸æ ·ï¼ç»å¤§å¤æ°æ°æ®å°±éè¦éæ°å­å¨ãè¿æ¯ä¸ªè´å½éè¯¯ã\n\n\n# 2. ä¸è´æ§åå¸\n\næ®éåå¸å¤±è¯¯å°±å¤±è¯¯å¨å¯¹æºå¨æ°éåæ¨¡ä¸ï¼æä»¬ä¸å¯¹æºå¨æ°åæ¨¡ï¼å¯¹ 2^32 åæ¨¡ï¼ä»ä¹ææå¢ï¼\n\næä»¬é¦åå° [0ï¼ 2^32-1] å´æä¸ä¸ªååï¼\n\n\n\nå¦å¾ï¼0 çå·¦ä¾§å°±æ¯ 2^32-1ãæä»¬æè¿ä¸ªç± 2^32 ä¸ªæ°ç»æçååç§°ä¸ºåå¸ç¯\n\näºæ¯æä»¬å­å¾ççæ­¥éª¤åä¸ºï¼\n\nå°æå¡å¨çå°åè®¡ç®åå¸å¼ï¼hash(æå¡å¨)ï¼ç¨è¿ä¸ªå¼ä¸ 2^32 åæ¨¡ï¼é£ä¹æææå¡å¨é½ä¼å¨è¿ä¸ªååä¸ä»£è¡¨ä¸ä¸ªç¹\n\nå°è¦å­å¨çå¾çè®¡ç®åå¸å¼ï¼hash(å¾ç)ï¼ç¨è¿ä¸ªå¼ä¸ 2^32 åæ¨¡ï¼é£ä¹ææå¾çé½ä¼å¨è¿ä¸ªååä¸ä»£è¡¨ä¸ä¸ªç¹\n\næä¹ç»è¿äºå¾çéæ©ä¸ä¸ªæå¡å¨å¢ï¼åªéè¦å¨è¿ä¸ªç¯ä¸ä¸ç´å¾åéåå°±è¡äºï¼ä¸å¾ä¸­å·¦è¾¹ä¸ä¸ªå¾çå­å¨å¨æå¡å¨aï¼å³è¾¹çä¸ä¸ªå¾çå­å¨å¨æå¡å¨cã\n\nç¨åºæ¥æ¾æ¶ä¹å¯ä»¥è¿æ ·åï¼è®¡ç®hashå¼ -> ä¸ 2^32 åæ¨¡ -> æ¾å¨åå¸ç¯ä¸å¾å³æ¾ç¬¬ä¸ä¸ªæå¡å¨ã\n\néå°æå¡å¨å®æºæèæ°å¢æå¡å¨æ¶ï¼å°±å¯ä»¥åªç ´åä¸é¨åæ°æ®ï¼ä¿æ¤å¶ä½æ°æ®ã\n\nåå¦æ­¤æ¶ æå¡å¨c å®æºï¼é£ä¹å³è¾¹çä¸ä¸ªæä»¶å°±åªè½å­å¨å° æå¡å¨b ä¸­ï¼ä½æ¯ä¹ä»ä»æ¯ä¸ä¸ªæä»¶ã\n\nä¸è´æ§åå¸ççä¼ç¼ºç¹ï¼\n\n * ä¼ç¹ ï¼éå°èç¹ä¸ç¨³å®çæåµå¯ä»¥ä¿æ¤å¤æ°æ°æ®\n\n * ç¼ºç¹ ï¼å¨èç¹æ°éå¤ªå°çæåµä¸ï¼å®¹æå ä¸ºèç¹åå¸ä¸ååèé ææ°æ®å¾æé®é¢ï¼ä¹å°±æ¯è¢«ç¼å­çæ°æ®å¤§é½éä¸­å­å¨å¨æä¸ªèç¹ä¸ï¼ä»èåºç°æ°æ®åå¸ä¸ååçæåµï¼è¿ç§æåµè¢«ç§°ä¸ºåå¸å¾æ\n\nä¸ºäºè§£å³è¿ç§æ°æ®å¾æé®é¢ï¼ä¸è´æ§åå¸ç®æ³å¼å¥äºèæèç¹æºå¶ï¼å³å¯¹æ¯ä¸ä¸ªèç¹é½è®¡ç®å¤ä¸ªåå¸å¼ï¼æ¯ä¸ªè®¡ç®ç»æé½æ¾ç½®å¨åå¸ç¯ä¸ï¼ç§°ä¸ºèæèç¹ãä¸ä¸ªå®éçç©çèç¹å¯ä»¥å¯¹åºå¤ä¸ªèæèç¹ï¼èæèç¹è¶å¤ï¼åå¸ç¯ä¸çèç¹å°±è¶å¤ï¼æ°æ®è¢«åååéçæ¦çå°±è¶å¤§ï¼åå¸ç¯å¾æé æçå½±åå°±è¶å°ã",charsets:{cjk:!0},lastUpdated:"2023/11/09, 20:11:05",lastUpdatedTimestamp:1699531865e3},{title:"éªè±ç®æ³",frontmatter:{title:"éªè±ç®æ³",date:"2023-11-09T21:07:05.000Z",permalink:"/pages/3fe609/"},regularPath:"/02.%E6%96%87%E7%AB%A0/85.%E7%AE%97%E6%B3%95/40.%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95.html",relativePath:"02.æç« /85.ç®æ³/40.éªè±ç®æ³.md",key:"v-218f759f",path:"/pages/3fe609/",headers:[{level:2,title:"1. æ¦å¿µ",slug:"_1-æ¦å¿µ",normalizedTitle:"1. æ¦å¿µ",charIndex:2},{level:2,title:"2. å®ç°Snowflake",slug:"_2-å®ç°snowflake",normalizedTitle:"2. å®ç°snowflake",charIndex:720}],headersStr:"1. æ¦å¿µ 2. å®ç°Snowflake",content:'# 1. æ¦å¿µ\n\néªè±ç®æ³æ¯ä¸ç§çæå¯ä¸IDçç®æ³ï¼ä¸»è¦ç¨äºåå¸å¼ç³»ç»ä¸­ãå®å¯ä»¥å¨ä¸ä¾èµæ°æ®åºç­å¶ä»è®¾å¤çæåµä¸ï¼çæå¨å±å¯ä¸çIDã\n\néªè±ç®æ³çæç ID ä¸º 64ä½æ´æ°ï¼å·ä½æ ¼å¼å¦ä¸ï¼\n\n\n\nå¾çå¤ªä¸æ¸æ°äºð¡ð¡ð¡ð¡\n\n * 1 ä¸ªç¬¦å·ä½ 0ï¼çæç ID éè¦æ¯æ­£æ´æ°ï¼æä»¥ç¬¦å·ä½å¿é¡»æ¯0\n * 41ä¸ªæ¶é´æ³ ï¼ä¸è¬ä½¿ç¨æ¯«ç§ä¸ºæ¶é´æ³ãå¦æä½¿ç¨æ¯«ç§ï¼2^41 â (12 * 30 * 24 * 60 * 60 * 1000) â 70ï¼å¯ä»¥ä½¿ç¨70å¹´\n * 10ä¸ªæºå¨æ è¯ ï¼å¶å®å¯ä»¥åå¼ï¼5 + 5ï¼æ°æ®ä¸­å¿æ è¯ + æºå¨æ è¯ï¼ä½æ¯ä¹å¯ä»¥æå®10ä½æ¥æ è¯ä¸ä¸ªæºå¨ã\n * 12ä¸ªè®¡æ°åºå· ï¼è®¡æ°åºå·è¡¨ç¤ºå¨æå®çæ¶é´æ³åè½çæçæå¤IDæ°ãè¥ä½¿ç¨æ¯«ç§ä¸ºæ¶é´æ³ï¼åè¡¨ç¤º 1æ¯«ç§æå¤çæ 2^12 ä¸ªåºå·ã\n\nä½æ¯åï¼ç®æ³æ¯æ­»çäººæ¯æ´»çï¼éªè±ç®æ³åªæ¯æä¾äºä¸ä¸ªææ³ï¼å°64ä½æ´æ°æå¼åä¸ªé¨ååå«è¡¨ç¤ºä¸åçææï¼åéè¿æ¶é´æ³æ¥å®ç°éå¢ï¼é£ä¹å¦ææçæºå¨æ°éä¸å¤ï¼å¯ä»¥åªç¨ 5 ä¸ªæ¯ç¹è¡¨ç¤ºæºå¨ï¼çä¸æ¥é£5ä¸ªå¯ä»¥ç¨äºå å¤§æ¶é´ç²¾åº¦ï¼ä¹å¯ä»¥ç¨äºå å¤§åä½æ¶é´ååºå·æ°éãåæ­£çä½ æä¹å®ç°å½~\n\nå¦æä½¿ç¨å¼æºç Snowflake çæå¨ï¼é£ä¹çæè§åå°±è·ä¸é¢è¯´çä¸æ ·ã\n\nSnowflakeä¹å¹¶ä¸å¨æ¯ä¼ç¹ï¼ç¼ºç¹å°±æ¯å®æ¯æ ¹æ®æ¶é´æ³çæIDçï¼ä½æ¯åä¸ªæºå¨ä¸çæ¶éå¯è½ä¸ä¸è´ï¼åæ¶å¦æä¸ä¸ªæºå¨çæ¶é´éåæ¨ï¼ä¼æIDéå¤æèä¹±åºçå¯è½ãæä¹è§£å³è¿ç§é®é¢å¢ï¼å©ç¨æå±ä½ï¼åæ¨ä¹ååæ©å±ä½ä¸å 1å°±å¯ä»¥äºï¼è¿æ ·IDä¾ç¶å¯ä»¥ä¿æå¯ä¸ãä½æ¯æ¾ä¸ªè¦æ±æä»¬æåé¢çåºä½æ°ï¼è¦ä¹ä»æºå¨idä¸­ï¼è¦ä¹ä»åºåå·ä¸­ï¼è¾åºä¸å®çä½ï¼å¨æ¶é´åæ¨çæ¶åï¼è¿ä¸ªä½ç½®+1.\n\n\n# 2. å®ç°Snowflake\n\nå¼æºçSnowflakeå¾å¤ï¼å°±ä¸åä»ç»äºï¼hutoolå°±å¯ä»¥ç¨ï¼ç¾åº¦ãç¾å¢ä¹æç¸å³çå®ç°ã\n\nå¨è¿éæ¾ä¸ä¸ªç½ä¸çå°çï¼\n\npublic class SnowFlakeUtil {\n \n    /**\n     * åå§æ¶é´æ³ï¼å¯ä»¥æ ¹æ®ä¸å¡éæ±æ´æ¹æ¶é´æ³\n     */\n    private final long twepoch = 11681452025134L;\n \n    /**\n     * æºå¨IDæå ä½æ°ï¼é¿åº¦ä¸º5ä½\n     */\n    private final long workerIdBits = 5L;\n \n    /**\n     * æ°æ®æ è¯IDæå ä½æ°ï¼é¿åº¦ä½5ä½\n     */\n    private final long datacenterIdBits = 5L;\n \n    /**\n     * æ¯æçæå¤§æºå¨idï¼ç»ææ¯31 (è¿ä¸ªç§»ä½ç®æ³å¯ä»¥å¾å¿«çè®¡ç®åºå ä½äºè¿å¶æ°æè½è¡¨ç¤ºçæå¤§åè¿å¶æ°)\n     */\n    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);\n \n    /**\n     * æ¯æçæå¤§æ°æ®æ è¯idï¼ç»ææ¯31\n     */\n    private final long maxDatacenterId = -1L ^ (-1L << datacenterIdBits);\n \n    /**\n     * åºåå¨idä¸­å çä½æ°ï¼é»è®¤12ä½\n     */\n    private final long sequenceBits = 12L;\n \n    /**\n     * å·¥ä½æºå¨IDåå·¦ç§»12ä½\n     */\n    private final long workerIdShift = sequenceBits;\n \n    /**\n     * æ°æ®æ è¯idåå·¦ç§»17ä½(12+5)\n     */\n    private final long dataCenterIdShift = sequenceBits + workerIdBits;\n \n    /**\n     * æ¶é´æªåå·¦ç§»22ä½(5+5+12)\n     */\n    private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;\n \n    /**\n     * åºåå·æå¤§å¼; çæåºåçæ©ç ï¼è¿éä¸º4095 (0b111111111111=0xfff=4095)\n     */\n    private final long sequenceMask = -1L ^ (-1L << sequenceBits);\n \n    /**\n     * å·¥ä½æºå¨ID(0~31)ï¼2è¿å¶5ä½  32ä½åæ1ä½ 31ä¸ª\n     */\n    private volatile long workerId;\n \n    /**\n     * æ°æ®ä¸­å¿ID(0~31)ï¼2è¿å¶5ä½  32ä½åæ1ä½ 31ä¸ª\n     */\n    private volatile long datacenterId;\n \n    /**\n     * æ¯«ç§ååºå(0~4095)ï¼2è¿å¶12ä½ 4096 - 1 = 4095ä¸ª\n     */\n    private volatile long sequence = 0L;\n \n    /**\n     * ä¸æ¬¡æ¶é´æ³ï¼åå§å¼ä¸ºè´æ°\n     */\n    private volatile long lastTimestamp = -1L;\n \n \n    // ==============================Constructors=====================================\n \n    /**\n     * æåæé \n     * @param workerId å·¥ä½æºå¨ID(0~31)\n     * @param datacenterId æ°æ®ä¸­å¿ID(0~31)\n     * @param sequence æ¯«ç§ååºå(0~4095)\n     */\n    public SnowFlakeUtil(long workerId, long datacenterId, long sequence){\n        // sanity check for workerId\n        if (workerId > maxWorkerId || workerId < 0) {\n            throw new IllegalArgumentException(String.format("worker Id can\'t be greater than %d or less than 0",maxWorkerId));\n        }\n        if (datacenterId > maxDatacenterId || datacenterId < 0) {\n            throw new IllegalArgumentException(String.format("datacenter Id can\'t be greater than %d or less than 0",maxDatacenterId));\n        }\n        System.out.printf("worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d",\n                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, workerId);\n \n        this.workerId = workerId;\n        this.datacenterId = datacenterId;\n        this.sequence = sequence;\n    }\n \n    // ==============================Methods==========================================\n \n    /**\n     * è·å¾ä¸ä¸ä¸ªID (è¯¥æ¹æ³æ¯çº¿ç¨å®å¨ç)\n     *  å¦æä¸ä¸ªçº¿ç¨åå¤è·åSynchronizedéï¼é£ä¹synchronizedéå°åæååéã\n     * @return çæçID\n     */\n    public synchronized long nextId() {\n        // è·åå½åæ¶é´çæ¶é´æ³ï¼åä½ï¼æ¯«ç§ï¼\n        long timestamp = timeGen();\n \n        // è·åå½åæ¶é´æ³å¦æå°äºä¸æ¬¡æ¶é´æ³ï¼åè¡¨ç¤ºæ¶é´æ³è·ååºç°å¼å¸¸\n        if (timestamp < lastTimestamp) {\n            System.err.printf("å½åæ¶é´æ³ä¸è½å°äºä¸æ¬¡æ¶é´æ³ï¼ä¸æ¬¡æ¶é´æ³ä¸ºï¼ %d.", lastTimestamp);\n            throw new RuntimeException(String.format("å½åæ¶é´æ³ä¸è½å°äºä¸æ¬¡æ¶é´æ³ï¼çæIDå¤±è´¥. æ¶é´æ³å·®å¼ï¼ %d milliseconds",\n                    lastTimestamp - timestamp));\n        }\n \n        // è·åå½åæ¶é´æ³å¦æç­äºä¸æ¬¡æ¶é´æ³ï¼åä¸æ¯«ç§åï¼ï¼åå¨åºåå·å ä¸ï¼å¦ååºåå·èµå¼ä¸º0ï¼ä»0å¼å§ã\n        if (lastTimestamp == timestamp) {\n            /* \n                é»è¾ï¼æææ¯è¯´ä¸ä¸ªæ¯«ç§åæå¤åªè½æ4096ä¸ªæ°å­ï¼æ è®ºä½ ä¼ éå¤å°è¿æ¥ï¼\n                    è¿ä¸ªä½è¿ç®ä¿è¯å§ç»å°±æ¯å¨4096è¿ä¸ªèå´åï¼é¿åä½ èªå·±ä¼ éä¸ªsequenceè¶è¿äº4096è¿ä¸ªèå´\n            */\n            // sequenceï¼æ¯«ç§ååºå(0~4095);  sequenceMask: åºåå·æå¤§å¼;\n            sequence = (sequence + 1) & sequenceMask;\n            /* é»è¾ï¼å½æä¸æ¯«ç§çæ¶é´ï¼äº§ççidæ° è¶è¿4095ï¼ç³»ç»ä¼è¿å¥ç­å¾ï¼ç´å°ä¸ä¸æ¯«ç§ï¼ç³»ç»ç»§ç»­äº§çID */\n            if (sequence == 0) {\n                timestamp = tilNextMillis(lastTimestamp);\n            }\n        } else {\n            sequence = 0;\n        }\n \n        // å°ä¸æ¬¡æ¶é´æ³å¼å·æ°ï¼é»è¾ï¼è®°å½ä¸ä¸æè¿ä¸æ¬¡çæidçæ¶é´æ³ï¼åä½æ¯æ¯«ç§ï¼\n        lastTimestamp = timestamp;\n \n        /* æ ¸å¿é»è¾ï¼çæä¸ä¸ª64bitçidï¼\n                  åå°å½åæ¶é´æ³å·¦ç§»ï¼æ¾å°41 bité£å¿ï¼\n                  å°æºæ¿idå·¦ç§»æ¾å°5 bité£å¿ï¼\n                  å°æºå¨idå·¦ç§»æ¾å°5 bité£å¿ï¼\n                  å°åºå·æ¾æå12 bit\n                  æåæ¼æ¥èµ·æ¥æä¸ä¸ª64 bitçäºè¿å¶æ°å­ï¼è½¬æ¢æ10è¿å¶å°±æ¯ä¸ªlongå */\n        /*\n         * è¿åç»æï¼\n         * (timestamp - twepoch) << timestampLeftShift) è¡¨ç¤ºå°æ¶é´æ³åå»åå§æ¶é´æ³ï¼åå·¦ç§»ç¸åºä½æ°\n         * (datacenterId << datacenterIdShift) è¡¨ç¤ºå°æ°æ®idå·¦ç§»ç¸åºä½æ°\n         * (workerId << workerIdShift) è¡¨ç¤ºå°å·¥ä½idå·¦ç§»ç¸åºä½æ°\n         * | æ¯æä½æè¿ç®ç¬¦ï¼ä¾å¦ï¼x | yï¼åªæå½xï¼yä¸ä¸º0çæ¶åç»ææä¸º0ï¼å¶å®æåµç»æé½ä¸º1ã\n         * å ä¸ºä¸ªé¨ååªæç¸åºä½ä¸çå¼ææä¹ï¼å¶å®ä½ä¸é½æ¯0ï¼æä»¥å°åé¨åçå¼è¿è¡ | è¿ç®å°±è½å¾å°æç»æ¼æ¥å¥½çid\n         */\n        return ((timestamp - twepoch) << timestampLeftShift) |\n                (datacenterId << dataCenterIdShift) |\n                (workerId << workerIdShift) |\n                sequence;\n    }\n \n    /**\n     * ä¸æ¬¡æ¶é´æ³ä¸å½åæ¶é´æ³è¿è¡æ¯è¾\n     * é»è¾ï¼å½æä¸æ¯«ç§çæ¶é´ï¼äº§ççidæ° è¶è¿4095ï¼ç³»ç»ä¼è¿å¥ç­å¾ï¼ç´å°ä¸ä¸æ¯«ç§ï¼ç³»ç»ç»§ç»­äº§çID\n     * @param lastTimestamp ä¸æ¬¡æ¶é´æ³\n     * @return è¥å½åæ¶é´æ³å°äºç­äºä¸æ¬¡æ¶é´æ³ï¼æ¶é´åæ¨äºï¼ï¼åè¿åææ°å½åæ¶é´æ³ï¼ å¦åï¼è¿åå½åæ¶é´æ³\n     */\n    private long tilNextMillis(long lastTimestamp) {\n        long timestamp = timeGen();\n        while (timestamp <= lastTimestamp) {\n            timestamp = timeGen();\n        }\n        return timestamp;\n    }\n \n    /**\n     * è·åç³»ç»æ¶é´æ³\n     * @return å½åæ¶é´çæ¶é´æ³ 14ä½\n     */\n    private long timeGen(){\n        return System.currentTimeMillis();\n    }\n \n    public static void main(String[] args) {\n        SnowFlakeUtil snowFlakeUtil = new SnowFlakeUtil(1,1,0);\n        System.out.println(snowFlakeUtil.timeGen());\n        for (int i = 0; i < 100; i++) {\n            System.out.println("éªè±ç®æ³çæç¬¬ã"+(i+1)+"ãä¸ªID:"+ snowFlakeUtil.nextId());\n        }\n \n    }\n \n}\n\n\nä»£ç è§£éçå¾è¯¦ç»ï¼æéå¸¸åæ¬¢è¿ç§ä»£ç æ³¨éè¯¦ç»çã',normalizedContent:'# 1. æ¦å¿µ\n\néªè±ç®æ³æ¯ä¸ç§çæå¯ä¸idçç®æ³ï¼ä¸»è¦ç¨äºåå¸å¼ç³»ç»ä¸­ãå®å¯ä»¥å¨ä¸ä¾èµæ°æ®åºç­å¶ä»è®¾å¤çæåµä¸ï¼çæå¨å±å¯ä¸çidã\n\néªè±ç®æ³çæç id ä¸º 64ä½æ´æ°ï¼å·ä½æ ¼å¼å¦ä¸ï¼\n\n\n\nå¾çå¤ªä¸æ¸æ°äºð¡ð¡ð¡ð¡\n\n * 1 ä¸ªç¬¦å·ä½ 0ï¼çæç id éè¦æ¯æ­£æ´æ°ï¼æä»¥ç¬¦å·ä½å¿é¡»æ¯0\n * 41ä¸ªæ¶é´æ³ ï¼ä¸è¬ä½¿ç¨æ¯«ç§ä¸ºæ¶é´æ³ãå¦æä½¿ç¨æ¯«ç§ï¼2^41 â (12 * 30 * 24 * 60 * 60 * 1000) â 70ï¼å¯ä»¥ä½¿ç¨70å¹´\n * 10ä¸ªæºå¨æ è¯ ï¼å¶å®å¯ä»¥åå¼ï¼5 + 5ï¼æ°æ®ä¸­å¿æ è¯ + æºå¨æ è¯ï¼ä½æ¯ä¹å¯ä»¥æå®10ä½æ¥æ è¯ä¸ä¸ªæºå¨ã\n * 12ä¸ªè®¡æ°åºå· ï¼è®¡æ°åºå·è¡¨ç¤ºå¨æå®çæ¶é´æ³åè½çæçæå¤idæ°ãè¥ä½¿ç¨æ¯«ç§ä¸ºæ¶é´æ³ï¼åè¡¨ç¤º 1æ¯«ç§æå¤çæ 2^12 ä¸ªåºå·ã\n\nä½æ¯åï¼ç®æ³æ¯æ­»çäººæ¯æ´»çï¼éªè±ç®æ³åªæ¯æä¾äºä¸ä¸ªææ³ï¼å°64ä½æ´æ°æå¼åä¸ªé¨ååå«è¡¨ç¤ºä¸åçææï¼åéè¿æ¶é´æ³æ¥å®ç°éå¢ï¼é£ä¹å¦ææçæºå¨æ°éä¸å¤ï¼å¯ä»¥åªç¨ 5 ä¸ªæ¯ç¹è¡¨ç¤ºæºå¨ï¼çä¸æ¥é£5ä¸ªå¯ä»¥ç¨äºå å¤§æ¶é´ç²¾åº¦ï¼ä¹å¯ä»¥ç¨äºå å¤§åä½æ¶é´ååºå·æ°éãåæ­£çä½ æä¹å®ç°å½~\n\nå¦æä½¿ç¨å¼æºç snowflake çæå¨ï¼é£ä¹çæè§åå°±è·ä¸é¢è¯´çä¸æ ·ã\n\nsnowflakeä¹å¹¶ä¸å¨æ¯ä¼ç¹ï¼ç¼ºç¹å°±æ¯å®æ¯æ ¹æ®æ¶é´æ³çæidçï¼ä½æ¯åä¸ªæºå¨ä¸çæ¶éå¯è½ä¸ä¸è´ï¼åæ¶å¦æä¸ä¸ªæºå¨çæ¶é´éåæ¨ï¼ä¼æidéå¤æèä¹±åºçå¯è½ãæä¹è§£å³è¿ç§é®é¢å¢ï¼å©ç¨æå±ä½ï¼åæ¨ä¹ååæ©å±ä½ä¸å 1å°±å¯ä»¥äºï¼è¿æ ·idä¾ç¶å¯ä»¥ä¿æå¯ä¸ãä½æ¯æ¾ä¸ªè¦æ±æä»¬æåé¢çåºä½æ°ï¼è¦ä¹ä»æºå¨idä¸­ï¼è¦ä¹ä»åºåå·ä¸­ï¼è¾åºä¸å®çä½ï¼å¨æ¶é´åæ¨çæ¶åï¼è¿ä¸ªä½ç½®+1.\n\n\n# 2. å®ç°snowflake\n\nå¼æºçsnowflakeå¾å¤ï¼å°±ä¸åä»ç»äºï¼hutoolå°±å¯ä»¥ç¨ï¼ç¾åº¦ãç¾å¢ä¹æç¸å³çå®ç°ã\n\nå¨è¿éæ¾ä¸ä¸ªç½ä¸çå°çï¼\n\npublic class snowflakeutil {\n \n    /**\n     * åå§æ¶é´æ³ï¼å¯ä»¥æ ¹æ®ä¸å¡éæ±æ´æ¹æ¶é´æ³\n     */\n    private final long twepoch = 11681452025134l;\n \n    /**\n     * æºå¨idæå ä½æ°ï¼é¿åº¦ä¸º5ä½\n     */\n    private final long workeridbits = 5l;\n \n    /**\n     * æ°æ®æ è¯idæå ä½æ°ï¼é¿åº¦ä½5ä½\n     */\n    private final long datacenteridbits = 5l;\n \n    /**\n     * æ¯æçæå¤§æºå¨idï¼ç»ææ¯31 (è¿ä¸ªç§»ä½ç®æ³å¯ä»¥å¾å¿«çè®¡ç®åºå ä½äºè¿å¶æ°æè½è¡¨ç¤ºçæå¤§åè¿å¶æ°)\n     */\n    private final long maxworkerid = -1l ^ (-1l << workeridbits);\n \n    /**\n     * æ¯æçæå¤§æ°æ®æ è¯idï¼ç»ææ¯31\n     */\n    private final long maxdatacenterid = -1l ^ (-1l << datacenteridbits);\n \n    /**\n     * åºåå¨idä¸­å çä½æ°ï¼é»è®¤12ä½\n     */\n    private final long sequencebits = 12l;\n \n    /**\n     * å·¥ä½æºå¨idåå·¦ç§»12ä½\n     */\n    private final long workeridshift = sequencebits;\n \n    /**\n     * æ°æ®æ è¯idåå·¦ç§»17ä½(12+5)\n     */\n    private final long datacenteridshift = sequencebits + workeridbits;\n \n    /**\n     * æ¶é´æªåå·¦ç§»22ä½(5+5+12)\n     */\n    private final long timestampleftshift = sequencebits + workeridbits + datacenteridbits;\n \n    /**\n     * åºåå·æå¤§å¼; çæåºåçæ©ç ï¼è¿éä¸º4095 (0b111111111111=0xfff=4095)\n     */\n    private final long sequencemask = -1l ^ (-1l << sequencebits);\n \n    /**\n     * å·¥ä½æºå¨id(0~31)ï¼2è¿å¶5ä½  32ä½åæ1ä½ 31ä¸ª\n     */\n    private volatile long workerid;\n \n    /**\n     * æ°æ®ä¸­å¿id(0~31)ï¼2è¿å¶5ä½  32ä½åæ1ä½ 31ä¸ª\n     */\n    private volatile long datacenterid;\n \n    /**\n     * æ¯«ç§ååºå(0~4095)ï¼2è¿å¶12ä½ 4096 - 1 = 4095ä¸ª\n     */\n    private volatile long sequence = 0l;\n \n    /**\n     * ä¸æ¬¡æ¶é´æ³ï¼åå§å¼ä¸ºè´æ°\n     */\n    private volatile long lasttimestamp = -1l;\n \n \n    // ==============================constructors=====================================\n \n    /**\n     * æåæé \n     * @param workerid å·¥ä½æºå¨id(0~31)\n     * @param datacenterid æ°æ®ä¸­å¿id(0~31)\n     * @param sequence æ¯«ç§ååºå(0~4095)\n     */\n    public snowflakeutil(long workerid, long datacenterid, long sequence){\n        // sanity check for workerid\n        if (workerid > maxworkerid || workerid < 0) {\n            throw new illegalargumentexception(string.format("worker id can\'t be greater than %d or less than 0",maxworkerid));\n        }\n        if (datacenterid > maxdatacenterid || datacenterid < 0) {\n            throw new illegalargumentexception(string.format("datacenter id can\'t be greater than %d or less than 0",maxdatacenterid));\n        }\n        system.out.printf("worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d",\n                timestampleftshift, datacenteridbits, workeridbits, sequencebits, workerid);\n \n        this.workerid = workerid;\n        this.datacenterid = datacenterid;\n        this.sequence = sequence;\n    }\n \n    // ==============================methods==========================================\n \n    /**\n     * è·å¾ä¸ä¸ä¸ªid (è¯¥æ¹æ³æ¯çº¿ç¨å®å¨ç)\n     *  å¦æä¸ä¸ªçº¿ç¨åå¤è·åsynchronizedéï¼é£ä¹synchronizedéå°åæååéã\n     * @return çæçid\n     */\n    public synchronized long nextid() {\n        // è·åå½åæ¶é´çæ¶é´æ³ï¼åä½ï¼æ¯«ç§ï¼\n        long timestamp = timegen();\n \n        // è·åå½åæ¶é´æ³å¦æå°äºä¸æ¬¡æ¶é´æ³ï¼åè¡¨ç¤ºæ¶é´æ³è·ååºç°å¼å¸¸\n        if (timestamp < lasttimestamp) {\n            system.err.printf("å½åæ¶é´æ³ä¸è½å°äºä¸æ¬¡æ¶é´æ³ï¼ä¸æ¬¡æ¶é´æ³ä¸ºï¼ %d.", lasttimestamp);\n            throw new runtimeexception(string.format("å½åæ¶é´æ³ä¸è½å°äºä¸æ¬¡æ¶é´æ³ï¼çæidå¤±è´¥. æ¶é´æ³å·®å¼ï¼ %d milliseconds",\n                    lasttimestamp - timestamp));\n        }\n \n        // è·åå½åæ¶é´æ³å¦æç­äºä¸æ¬¡æ¶é´æ³ï¼åä¸æ¯«ç§åï¼ï¼åå¨åºåå·å ä¸ï¼å¦ååºåå·èµå¼ä¸º0ï¼ä»0å¼å§ã\n        if (lasttimestamp == timestamp) {\n            /* \n                é»è¾ï¼æææ¯è¯´ä¸ä¸ªæ¯«ç§åæå¤åªè½æ4096ä¸ªæ°å­ï¼æ è®ºä½ ä¼ éå¤å°è¿æ¥ï¼\n                    è¿ä¸ªä½è¿ç®ä¿è¯å§ç»å°±æ¯å¨4096è¿ä¸ªèå´åï¼é¿åä½ èªå·±ä¼ éä¸ªsequenceè¶è¿äº4096è¿ä¸ªèå´\n            */\n            // sequenceï¼æ¯«ç§ååºå(0~4095);  sequencemask: åºåå·æå¤§å¼;\n            sequence = (sequence + 1) & sequencemask;\n            /* é»è¾ï¼å½æä¸æ¯«ç§çæ¶é´ï¼äº§ççidæ° è¶è¿4095ï¼ç³»ç»ä¼è¿å¥ç­å¾ï¼ç´å°ä¸ä¸æ¯«ç§ï¼ç³»ç»ç»§ç»­äº§çid */\n            if (sequence == 0) {\n                timestamp = tilnextmillis(lasttimestamp);\n            }\n        } else {\n            sequence = 0;\n        }\n \n        // å°ä¸æ¬¡æ¶é´æ³å¼å·æ°ï¼é»è¾ï¼è®°å½ä¸ä¸æè¿ä¸æ¬¡çæidçæ¶é´æ³ï¼åä½æ¯æ¯«ç§ï¼\n        lasttimestamp = timestamp;\n \n        /* æ ¸å¿é»è¾ï¼çæä¸ä¸ª64bitçidï¼\n                  åå°å½åæ¶é´æ³å·¦ç§»ï¼æ¾å°41 bité£å¿ï¼\n                  å°æºæ¿idå·¦ç§»æ¾å°5 bité£å¿ï¼\n                  å°æºå¨idå·¦ç§»æ¾å°5 bité£å¿ï¼\n                  å°åºå·æ¾æå12 bit\n                  æåæ¼æ¥èµ·æ¥æä¸ä¸ª64 bitçäºè¿å¶æ°å­ï¼è½¬æ¢æ10è¿å¶å°±æ¯ä¸ªlongå */\n        /*\n         * è¿åç»æï¼\n         * (timestamp - twepoch) << timestampleftshift) è¡¨ç¤ºå°æ¶é´æ³åå»åå§æ¶é´æ³ï¼åå·¦ç§»ç¸åºä½æ°\n         * (datacenterid << datacenteridshift) è¡¨ç¤ºå°æ°æ®idå·¦ç§»ç¸åºä½æ°\n         * (workerid << workeridshift) è¡¨ç¤ºå°å·¥ä½idå·¦ç§»ç¸åºä½æ°\n         * | æ¯æä½æè¿ç®ç¬¦ï¼ä¾å¦ï¼x | yï¼åªæå½xï¼yä¸ä¸º0çæ¶åç»ææä¸º0ï¼å¶å®æåµç»æé½ä¸º1ã\n         * å ä¸ºä¸ªé¨ååªæç¸åºä½ä¸çå¼ææä¹ï¼å¶å®ä½ä¸é½æ¯0ï¼æä»¥å°åé¨åçå¼è¿è¡ | è¿ç®å°±è½å¾å°æç»æ¼æ¥å¥½çid\n         */\n        return ((timestamp - twepoch) << timestampleftshift) |\n                (datacenterid << datacenteridshift) |\n                (workerid << workeridshift) |\n                sequence;\n    }\n \n    /**\n     * ä¸æ¬¡æ¶é´æ³ä¸å½åæ¶é´æ³è¿è¡æ¯è¾\n     * é»è¾ï¼å½æä¸æ¯«ç§çæ¶é´ï¼äº§ççidæ° è¶è¿4095ï¼ç³»ç»ä¼è¿å¥ç­å¾ï¼ç´å°ä¸ä¸æ¯«ç§ï¼ç³»ç»ç»§ç»­äº§çid\n     * @param lasttimestamp ä¸æ¬¡æ¶é´æ³\n     * @return è¥å½åæ¶é´æ³å°äºç­äºä¸æ¬¡æ¶é´æ³ï¼æ¶é´åæ¨äºï¼ï¼åè¿åææ°å½åæ¶é´æ³ï¼ å¦åï¼è¿åå½åæ¶é´æ³\n     */\n    private long tilnextmillis(long lasttimestamp) {\n        long timestamp = timegen();\n        while (timestamp <= lasttimestamp) {\n            timestamp = timegen();\n        }\n        return timestamp;\n    }\n \n    /**\n     * è·åç³»ç»æ¶é´æ³\n     * @return å½åæ¶é´çæ¶é´æ³ 14ä½\n     */\n    private long timegen(){\n        return system.currenttimemillis();\n    }\n \n    public static void main(string[] args) {\n        snowflakeutil snowflakeutil = new snowflakeutil(1,1,0);\n        system.out.println(snowflakeutil.timegen());\n        for (int i = 0; i < 100; i++) {\n            system.out.println("éªè±ç®æ³çæç¬¬ã"+(i+1)+"ãä¸ªid:"+ snowflakeutil.nextid());\n        }\n \n    }\n \n}\n\n\nä»£ç è§£éçå¾è¯¦ç»ï¼æéå¸¸åæ¬¢è¿ç§ä»£ç æ³¨éè¯¦ç»çã',charsets:{cjk:!0},lastUpdated:"2023/12/21, 16:18:02",lastUpdatedTimestamp:1703146682e3},{title:"CAPçè®º",frontmatter:{title:"CAPçè®º",date:"2023-11-03T00:16:23.000Z",permalink:"/pages/db9f45/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/1.%E7%90%86%E8%AE%BA/10.CAP%E7%90%86%E8%AE%BA.html",relativePath:"02.æç« /91.æ¡æ¶/1.çè®º/10.CAPçè®º.md",key:"v-1a0380cd",path:"/pages/db9f45/",headers:[{level:2,title:"1. CAP ç®ä»",slug:"_1-cap-ç®ä»",normalizedTitle:"1. cap ç®ä»",charIndex:2},{level:2,title:"2. ä¸ºä½åªè½ä¸éäºï¼",slug:"_2-ä¸ºä½åªè½ä¸éäº",normalizedTitle:"2. ä¸ºä½åªè½ä¸éäºï¼",charIndex:777},{level:3,title:"2.1 CP",slug:"_2-1-cp",normalizedTitle:"2.1 cp",charIndex:860},{level:3,title:"2.2 AP",slug:"_2-2-ap",normalizedTitle:"2.2 ap",charIndex:1029},{level:3,title:"2.3 CA",slug:"_2-3-ca",normalizedTitle:"2.3 ca",charIndex:1194},{level:2,title:"3. å¦ä½ææ©",slug:"_3-å¦ä½ææ©",normalizedTitle:"3. å¦ä½ææ©",charIndex:1286}],headersStr:"1. CAP ç®ä» 2. ä¸ºä½åªè½ä¸éäºï¼ 2.1 CP 2.2 AP 2.3 CA 3. å¦ä½ææ©",content:"# 1. CAP ç®ä»\n\n> CAPçè®ºæåº ï¼ä¸ä¸ªåå¸å¼ç³»ç»ä¸è½åæ¶æ»¡è¶³ä¸è´æ§ãé«å¯ç¨æ§ãååºå®¹éæ§ã\n\n\n\nCãAãP æ¯ä¸ä¸ªçº¦æå±æ§ ï¼\n\n 1. C ï¼Consistencyï¼ä¸è´æ§ãè®¿é®ææçèç¹ï¼å¾å°æ°æ®ç»ææ¯ä¸æ ·çã\n    \n    æ³¨æ ï¼è¿éç ä¸è´æ§ æçæ¯å¼ºä¸è´æ§ï¼ä¹å°±æ¯æ°æ®æ´æ°å®ï¼è®¿é®ä»»æèç¹çå°çæ°æ®å®å¨ä¸è´ï¼è¦åå¼±ä¸è´æ§ãæç»ä¸è´æ§åºåå¼ã\n\n 2. A ï¼Availabilityï¼å¯ç¨æ§ãææèç¹é½ä¿æé«å¯ç¨æ§ã\n    \n    æ³¨æ ï¼è¿éçé«å¯ç¨è¿åæ¬ï¼ä¸è½åºç°å»¶è¿ï¼å¦ èç¹B ç±äºç­å¾æ°æ®åæ­¥èé»å¡äºè¯·æ±ï¼é£ä¹ èç¹B å°±ä¸æ»¡è¶³é«å¯ç¨æ§ãA å°±æ¯æ»¡è¶³å®¢æ·ç«¯è®¿é®å§ç»è½æåå¤å³å¯(ä¸ç®¡åå¤çæ¯å¦æ­£ç¡®)\n\n 3. P ï¼Partition Toleranceï¼ååºå®¹éæ§ ãåå¸å¼ç³»ç»åºç°ç½ç»ååºçæ¶åï¼ä»ç¶è½å¤å¯¹å¤æä¾æå¡ã\n    \n    æ³¨æ ï¼è¿éçååºæçæ¯ç½ç»æä¹ä¸çååºãç±äºç½ç»æ¯ä¸å¯é çï¼ææèç¹å¯è½åºç°æ æ³éä¿¡çæåµï¼å¨èç¹è¢«è¿«ååºèæ æ³éä¿¡æ¶ï¼è¦ä¿è¯èç¹å¯ä»¥ç»§ç»­æå¡\n\nä»ä¹æ¯ååºï¼\n\nåå¸å¼ç³»ç»ä¸­ï¼å¤ä¸ªèç¹ä¹é´çç½ç»æ¬æ¥æ¯è¿éçï¼ä½æ¯å ä¸ºæäºæéï¼æ¯å¦æä¸ªèç¹åºäºé®é¢ï¼æäºèç¹ä¸å¦å¤çèç¹æ æ³éä¿¡äºï¼æ´ä¸ªç½ç»å°±è¢«åä¸ºä¸¤ä¸ªç½ç»ååºãæ æ³éä¿¡å°±æ æ³è¿è¡æ°æ®åæ­¥ãæç»ä¸¤ä¸ªååºä¼åºç°æ°æ®ä¸ä¸è´ã\n\n\n\nCAPçè®ºå¯¹äºé£äºæ¬èº«å¸¦ææ°æ®å­å¨çåå¸å¼ç³»ç»æ´å æç¨ï¼åè®¾ä¸ä¸ªåå¸å¼ç³»ç»çåä¸ªèç¹é½è¯»ååä¸ä¸ªMySQLï¼é£ä¹å¯¹äºè¿ä¸ªåå¸å¼ç³»ç»èè¨ï¼è®¨è®ºCAPæ²¡ææä¹ã\n\næä»¥å¨è®¨è®ºCAPçè®ºæ¶ï¼æ´å¤çæ¯éå¯¹é£äºææ°æ®å­å¨ãæ°æ®å¤å¶åºæ¯çåå¸å¼å­å¨ç³»ç»ï¼æ¯å¦MySQLãRedisã\n\nZookeeper ç¨çæ¯ CPï¼Eureka ç¨çæ¯ APï¼Nacos ä¸ä»æ¯æ CP ä¹æ¯æ APã\n\n\n# 2. ä¸ºä½åªè½ä¸éäºï¼\n\nåè®¾ç°å¨æä¸¤ä¸ªæºå­ ï¼æå¡å¨A ãæå¡å¨Bãå®ä»¬åé¨é½æä¸ä¸ªå¼ numberã\n\næ­¤æ¶ æå¡å¨A ä¸­ç number è¢«æ¹å...\n\n\n# 2.1 CP\n\næä»¬å¨ä¿è¯ ä¸è´æ§ãååºå®¹éæ§ï¼è¯è¯è½å¦åå®ç° é«å¯ç¨æ§ã\n\nä¸ºäºä¿è¯ä¸è´æ§ï¼æå¡å¨A ä¸­ number çæ¹åä¸å®è¦åéç» æå¡å¨Bï¼ä½æ¯å ä¸ºç½ç»åå ï¼æå¡å¨A åéç» æå¡å¨B çæ¶æ¯é»å¡æä¸¢å¤±ãé£ä¹æ°æ®å°±æå¯è½åºç°ä¸ä¸è´é®é¢ï¼ä½æ¯æä»¬æ³ä¿è¯ä¸è´æ§ï¼æä»¥æå¡B è¦åæ­¢æå¡ç­å¾æ°æ®åæ­¥ï¼é£ä¹å°±è¿åäºé«å¯ç¨æ§ã\n\n\n# 2.2 AP\n\næä»¬å¨ä¿è¯ é«å¯ç¨æ§ãååºå®¹éæ§ï¼è¯è¯è½å¦åå®ç° ä¸è´æ§ã\n\nä¸ºäºä¿è¯é«å¯ç¨æ§ï¼æå¡å¨A å æå¡å¨B é½å¿é¡»å¿«éååºãåæ ·çç±äºç½ç»ä¸å¯é ï¼æå¡å¨B è¿æ²¡æ¥å¾åæ¥æ¶å°æå¡å¨A åæ¥çæ°æ®åæ­¥è¯·æ±ï¼å°±è¦ååºç¨æ·çè·åæ°æ®è¯·æ±ï¼å¯¼è´ æå¡å¨A è¿åçæ°æ®ä¸ æå¡å¨B è¿åçæ°æ®ä¸ä¸è´ãè¿å°±æ æ³å®ç°ä¸è´æ§ã\n\n\n# 2.3 CA\n\nå¦æä¿è¯é«å¯ç¨åä¸è´æ§ï¼è½å¦ä¿è¯ååºåæ­£å¸¸æä¾æå¡ï¼\n\nç½ç»æ¯ä¸å¯é çï¼ä¸ä¸æä¸ªæ°æ®åæ­¥è¯·æ±å¨åéè¿ç¨ä¸­ä¸¢å¤±ï¼å°±ä¼å¯¼è´ååºç°è±¡ï¼åä¸ªç½ç»åºåçæ°æ®å°±ä¼ä¸ä¸è´ã\n\n\n# 3. å¦ä½ææ©\n\né¦åæèµ·ç è¦ä¿è¯ Pï¼å¦æååºäºï¼å¯ä»¥ææºå¨å°çé£ä¸ªåºåä¸»å¨ä¸çº¿ï¼ä¹ä¸è½è®©å®ä»¬ä¸è´æä¾éè¯¯æ°æ®ã\n\nå¨ä¿è¯ P çåºç¡ä¸åè° A å Cãå½ç¶ï¼å¦æä½ ä¸ä½¿ç¨åå¸å¼ç³»ç»ï¼é£è¯å®ä¸éè¦èèPï¼ä¹å°±ä¸ä¼ä¸éäºð",normalizedContent:"# 1. cap ç®ä»\n\n> capçè®ºæåº ï¼ä¸ä¸ªåå¸å¼ç³»ç»ä¸è½åæ¶æ»¡è¶³ä¸è´æ§ãé«å¯ç¨æ§ãååºå®¹éæ§ã\n\n\n\ncãaãp æ¯ä¸ä¸ªçº¦æå±æ§ ï¼\n\n 1. c ï¼consistencyï¼ä¸è´æ§ãè®¿é®ææçèç¹ï¼å¾å°æ°æ®ç»ææ¯ä¸æ ·çã\n    \n    æ³¨æ ï¼è¿éç ä¸è´æ§ æçæ¯å¼ºä¸è´æ§ï¼ä¹å°±æ¯æ°æ®æ´æ°å®ï¼è®¿é®ä»»æèç¹çå°çæ°æ®å®å¨ä¸è´ï¼è¦åå¼±ä¸è´æ§ãæç»ä¸è´æ§åºåå¼ã\n\n 2. a ï¼availabilityï¼å¯ç¨æ§ãææèç¹é½ä¿æé«å¯ç¨æ§ã\n    \n    æ³¨æ ï¼è¿éçé«å¯ç¨è¿åæ¬ï¼ä¸è½åºç°å»¶è¿ï¼å¦ èç¹b ç±äºç­å¾æ°æ®åæ­¥èé»å¡äºè¯·æ±ï¼é£ä¹ èç¹b å°±ä¸æ»¡è¶³é«å¯ç¨æ§ãa å°±æ¯æ»¡è¶³å®¢æ·ç«¯è®¿é®å§ç»è½æåå¤å³å¯(ä¸ç®¡åå¤çæ¯å¦æ­£ç¡®)\n\n 3. p ï¼partition toleranceï¼ååºå®¹éæ§ ãåå¸å¼ç³»ç»åºç°ç½ç»ååºçæ¶åï¼ä»ç¶è½å¤å¯¹å¤æä¾æå¡ã\n    \n    æ³¨æ ï¼è¿éçååºæçæ¯ç½ç»æä¹ä¸çååºãç±äºç½ç»æ¯ä¸å¯é çï¼ææèç¹å¯è½åºç°æ æ³éä¿¡çæåµï¼å¨èç¹è¢«è¿«ååºèæ æ³éä¿¡æ¶ï¼è¦ä¿è¯èç¹å¯ä»¥ç»§ç»­æå¡\n\nä»ä¹æ¯ååºï¼\n\nåå¸å¼ç³»ç»ä¸­ï¼å¤ä¸ªèç¹ä¹é´çç½ç»æ¬æ¥æ¯è¿éçï¼ä½æ¯å ä¸ºæäºæéï¼æ¯å¦æä¸ªèç¹åºäºé®é¢ï¼æäºèç¹ä¸å¦å¤çèç¹æ æ³éä¿¡äºï¼æ´ä¸ªç½ç»å°±è¢«åä¸ºä¸¤ä¸ªç½ç»ååºãæ æ³éä¿¡å°±æ æ³è¿è¡æ°æ®åæ­¥ãæç»ä¸¤ä¸ªååºä¼åºç°æ°æ®ä¸ä¸è´ã\n\n\n\ncapçè®ºå¯¹äºé£äºæ¬èº«å¸¦ææ°æ®å­å¨çåå¸å¼ç³»ç»æ´å æç¨ï¼åè®¾ä¸ä¸ªåå¸å¼ç³»ç»çåä¸ªèç¹é½è¯»ååä¸ä¸ªmysqlï¼é£ä¹å¯¹äºè¿ä¸ªåå¸å¼ç³»ç»èè¨ï¼è®¨è®ºcapæ²¡ææä¹ã\n\næä»¥å¨è®¨è®ºcapçè®ºæ¶ï¼æ´å¤çæ¯éå¯¹é£äºææ°æ®å­å¨ãæ°æ®å¤å¶åºæ¯çåå¸å¼å­å¨ç³»ç»ï¼æ¯å¦mysqlãredisã\n\nzookeeper ç¨çæ¯ cpï¼eureka ç¨çæ¯ apï¼nacos ä¸ä»æ¯æ cp ä¹æ¯æ apã\n\n\n# 2. ä¸ºä½åªè½ä¸éäºï¼\n\nåè®¾ç°å¨æä¸¤ä¸ªæºå­ ï¼æå¡å¨a ãæå¡å¨bãå®ä»¬åé¨é½æä¸ä¸ªå¼ numberã\n\næ­¤æ¶ æå¡å¨a ä¸­ç number è¢«æ¹å...\n\n\n# 2.1 cp\n\næä»¬å¨ä¿è¯ ä¸è´æ§ãååºå®¹éæ§ï¼è¯è¯è½å¦åå®ç° é«å¯ç¨æ§ã\n\nä¸ºäºä¿è¯ä¸è´æ§ï¼æå¡å¨a ä¸­ number çæ¹åä¸å®è¦åéç» æå¡å¨bï¼ä½æ¯å ä¸ºç½ç»åå ï¼æå¡å¨a åéç» æå¡å¨b çæ¶æ¯é»å¡æä¸¢å¤±ãé£ä¹æ°æ®å°±æå¯è½åºç°ä¸ä¸è´é®é¢ï¼ä½æ¯æä»¬æ³ä¿è¯ä¸è´æ§ï¼æä»¥æå¡b è¦åæ­¢æå¡ç­å¾æ°æ®åæ­¥ï¼é£ä¹å°±è¿åäºé«å¯ç¨æ§ã\n\n\n# 2.2 ap\n\næä»¬å¨ä¿è¯ é«å¯ç¨æ§ãååºå®¹éæ§ï¼è¯è¯è½å¦åå®ç° ä¸è´æ§ã\n\nä¸ºäºä¿è¯é«å¯ç¨æ§ï¼æå¡å¨a å æå¡å¨b é½å¿é¡»å¿«éååºãåæ ·çç±äºç½ç»ä¸å¯é ï¼æå¡å¨b è¿æ²¡æ¥å¾åæ¥æ¶å°æå¡å¨a åæ¥çæ°æ®åæ­¥è¯·æ±ï¼å°±è¦ååºç¨æ·çè·åæ°æ®è¯·æ±ï¼å¯¼è´ æå¡å¨a è¿åçæ°æ®ä¸ æå¡å¨b è¿åçæ°æ®ä¸ä¸è´ãè¿å°±æ æ³å®ç°ä¸è´æ§ã\n\n\n# 2.3 ca\n\nå¦æä¿è¯é«å¯ç¨åä¸è´æ§ï¼è½å¦ä¿è¯ååºåæ­£å¸¸æä¾æå¡ï¼\n\nç½ç»æ¯ä¸å¯é çï¼ä¸ä¸æä¸ªæ°æ®åæ­¥è¯·æ±å¨åéè¿ç¨ä¸­ä¸¢å¤±ï¼å°±ä¼å¯¼è´ååºç°è±¡ï¼åä¸ªç½ç»åºåçæ°æ®å°±ä¼ä¸ä¸è´ã\n\n\n# 3. å¦ä½ææ©\n\né¦åæèµ·ç è¦ä¿è¯ pï¼å¦æååºäºï¼å¯ä»¥ææºå¨å°çé£ä¸ªåºåä¸»å¨ä¸çº¿ï¼ä¹ä¸è½è®©å®ä»¬ä¸è´æä¾éè¯¯æ°æ®ã\n\nå¨ä¿è¯ p çåºç¡ä¸åè° a å cãå½ç¶ï¼å¦æä½ ä¸ä½¿ç¨åå¸å¼ç³»ç»ï¼é£è¯å®ä¸éè¦èèpï¼ä¹å°±ä¸ä¼ä¸éäºð",charsets:{cjk:!0},lastUpdated:"2023/11/03, 18:29:13",lastUpdatedTimestamp:1699007353e3},{title:"BASEçè®º",frontmatter:{title:"BASEçè®º",date:"2023-11-03T00:16:49.000Z",permalink:"/pages/793cbb/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/1.%E7%90%86%E8%AE%BA/20.BASE%E7%90%86%E8%AE%BA.html",relativePath:"02.æç« /91.æ¡æ¶/1.çè®º/20.BASEçè®º.md",key:"v-2232d43f",path:"/pages/793cbb/",headers:[{level:2,title:"1. ç®ä»",slug:"_1-ç®ä»",normalizedTitle:"1. ç®ä»",charIndex:2},{level:2,title:"2. æ ¸å¿ææ³",slug:"_2-æ ¸å¿ææ³",normalizedTitle:"2. æ ¸å¿ææ³",charIndex:201}],headersStr:"1. ç®ä» 2. æ ¸å¿ææ³",content:"# 1. ç®ä»\n\nBASE ï¼Basically Availableï¼åºæ¬å¯ç¨ï¼ãSoft-stateï¼è½¯ç¶æï¼ãEventually Consistentï¼æç»ä¸è´æ§ï¼\n\nBASE çè®ºå°±æ¯è¿ä¸ä¸ªåè¯çç¼©åï¼BASE çè®ºæ¯å¯¹ CAP ä¸­ä¸è´æ§ï¼Cï¼åå¯ç¨æ§ï¼Aï¼çæè¡¡çç»æï¼å¶æ¥æºäºå¯¹å¤§è§æ¨¡äºèç½ç³»ç»åå¸å¼å®è·µçç»éªï¼æ¯åºäº CAP çè®ºéæ­¥æ¼åèæ¥çï¼å®å¤§å¤§éä½äºæä»¬å¯¹äºç³»ç»çè¦æ±ã\n\n\n# 2. æ ¸å¿ææ³\n\nå³ä½¿æ æ³åå°å¼ºä¸è´æ§ï¼ä½æ¯ä¸ªåºç¨é½å¯ä»¥æ ¹æ®èªèº«ä¸å¡çç¹ç¹ï¼éç¨éå½çæ¹å¼æ¥ä½¿ç³»ç»æå°æç»ä¸è´æ§ã\n\n> ä¹å°±æ¯çºç²æ°æ®çä¸è´æ§æ¥æ»¡è¶³ç³»ç»çé«å¯ç¨æ§ï¼ç³»ç»ä¸é¨åæ°æ®ä¸å¯ç¨æèä¸ä¸è´æ¶ï¼ä»éè¦ä¿æç³»ç»æ´ä½çâä¸»è¦å¯ç¨âã\n\nBASE çè®ºæ¬è´¨ä¸æ¯å¯¹ CAP çå»¶ä¼¸åè¡¥åï¼æ´å·ä½å°è¯´ï¼æ¯å¯¹ CAP ä¸­ AP æ¹æ¡çä¸ä¸ªè¡¥åãå ä¸ºå®çºç²äºä¸é¨åä¸è´æ§ï¼éç¨æç»ä¸è´æ§æ¥æ¢åé«å¯ç¨æ§ã\n\n * åºæ¬å¯ç¨ ï¼åºæ¬å¯ç¨æ¯æåå¸å¼ç³»ç»å¨åºç°ä¸å¯é¢ç¥æéçæ¶åï¼åè®¸æå¤±é¨åå¯ç¨æ§ãä½æ¯è¿ä¸ç­ä»·äºä¸å¯ç¨ã\n   \n   ä»ä¹å«åè®¸æå¤±é¨åå¯ç¨æ§ï¼\n   \n   * ååºæ¶é´ä¸çæå¤± ï¼æ­£å¸¸æåµä¸ï¼å¤çç¨æ·è¯·æ±éè¦0.5sè¿åç»æï¼å¦æåºç°æéï¼ææ¥åç³»ç»å¨3såè¿åç»æ\n   * ç³»ç»åè½ä¸çæå¤± ï¼æ­£å¸¸æåµä¸ï¼ç¨æ·å¯ä»¥ä½¿ç¨ææç³»ç»çåè½ï¼å¦æåºç°æéï¼ææ¥åéæ ¸å¿åè½æ æ³ä½¿ç¨ã\n\n * è½¯ç¶æ ï¼è½¯ç¶ææåè®¸ç³»ç»ä¸­çæ°æ®å­å¨ä¸­é´ç¶æï¼å¹¶è®¤ä¸ºè¯¥ä¸­é´ç¶æçå­å¨ä¸ä¼å½±åç³»ç»çæ´ä½å¯ç¨æ§ï¼å³åè®¸ç³»ç»å¨ä¸åèç¹çæ°æ®å¯æ¬ä¹é´è¿è¡æ°æ®åæ­¥çè¿ç¨å­å¨å»¶è¿ã\n\n * æç»ä¸è´æ§ ï¼æç»ä¸è´æ§å¼ºè°çæ¯ç³»ç»ä¸­ææçæ°æ®å¯æ¬ï¼å¨ç»è¿ä¸æ®µæ¶é´çåæ­¥åï¼æç»è½å¤æå°çä¸ä¸ªä¸è´çç¶æãå æ­¤ï¼æç»ä¸è´æ§çæ¬è´¨æ¯éè¦ç³»ç»ä¿è¯æç»æ°æ®è½å¤è¾¾å°ä¸è´ï¼\n   \n   åå¸å¼ä¸­ï¼ä¸è´æ§çä¸ç§çº§å«ï¼\n   \n   * å¼ºä¸è´æ§ ï¼ç³»ç»åå¥äºä»ä¹ï¼è¯»åºæ¥å°±æ¯ä»ä¹\n   * å¼±ä¸è´æ§ ï¼ä¸ä¸å®å¯ä»¥è¯»åå°ææ°åå¥çå¼ï¼ä¹ä¸ä¿è¯å¤å°æ¶é´åè¯»åçæ°æ®æ¯ææ°çï¼åªæ¯ä¼å°½éä¿è¯æä¸ªæ¶å»è¾¾å°æ°æ®ä¸è´çç¶æã\n   * æç»ä¸è´æ§ ï¼å¼±ä¸è´æ§çåçº§çï¼ç³»ç»ä¼ä¿è¯å¨ä¸å®æ¶é´åè¾¾å°æ°æ®ä¸è´çç¶æã",normalizedContent:"# 1. ç®ä»\n\nbase ï¼basically availableï¼åºæ¬å¯ç¨ï¼ãsoft-stateï¼è½¯ç¶æï¼ãeventually consistentï¼æç»ä¸è´æ§ï¼\n\nbase çè®ºå°±æ¯è¿ä¸ä¸ªåè¯çç¼©åï¼base çè®ºæ¯å¯¹ cap ä¸­ä¸è´æ§ï¼cï¼åå¯ç¨æ§ï¼aï¼çæè¡¡çç»æï¼å¶æ¥æºäºå¯¹å¤§è§æ¨¡äºèç½ç³»ç»åå¸å¼å®è·µçç»éªï¼æ¯åºäº cap çè®ºéæ­¥æ¼åèæ¥çï¼å®å¤§å¤§éä½äºæä»¬å¯¹äºç³»ç»çè¦æ±ã\n\n\n# 2. æ ¸å¿ææ³\n\nå³ä½¿æ æ³åå°å¼ºä¸è´æ§ï¼ä½æ¯ä¸ªåºç¨é½å¯ä»¥æ ¹æ®èªèº«ä¸å¡çç¹ç¹ï¼éç¨éå½çæ¹å¼æ¥ä½¿ç³»ç»æå°æç»ä¸è´æ§ã\n\n> ä¹å°±æ¯çºç²æ°æ®çä¸è´æ§æ¥æ»¡è¶³ç³»ç»çé«å¯ç¨æ§ï¼ç³»ç»ä¸é¨åæ°æ®ä¸å¯ç¨æèä¸ä¸è´æ¶ï¼ä»éè¦ä¿æç³»ç»æ´ä½çâä¸»è¦å¯ç¨âã\n\nbase çè®ºæ¬è´¨ä¸æ¯å¯¹ cap çå»¶ä¼¸åè¡¥åï¼æ´å·ä½å°è¯´ï¼æ¯å¯¹ cap ä¸­ ap æ¹æ¡çä¸ä¸ªè¡¥åãå ä¸ºå®çºç²äºä¸é¨åä¸è´æ§ï¼éç¨æç»ä¸è´æ§æ¥æ¢åé«å¯ç¨æ§ã\n\n * åºæ¬å¯ç¨ ï¼åºæ¬å¯ç¨æ¯æåå¸å¼ç³»ç»å¨åºç°ä¸å¯é¢ç¥æéçæ¶åï¼åè®¸æå¤±é¨åå¯ç¨æ§ãä½æ¯è¿ä¸ç­ä»·äºä¸å¯ç¨ã\n   \n   ä»ä¹å«åè®¸æå¤±é¨åå¯ç¨æ§ï¼\n   \n   * ååºæ¶é´ä¸çæå¤± ï¼æ­£å¸¸æåµä¸ï¼å¤çç¨æ·è¯·æ±éè¦0.5sè¿åç»æï¼å¦æåºç°æéï¼ææ¥åç³»ç»å¨3såè¿åç»æ\n   * ç³»ç»åè½ä¸çæå¤± ï¼æ­£å¸¸æåµä¸ï¼ç¨æ·å¯ä»¥ä½¿ç¨ææç³»ç»çåè½ï¼å¦æåºç°æéï¼ææ¥åéæ ¸å¿åè½æ æ³ä½¿ç¨ã\n\n * è½¯ç¶æ ï¼è½¯ç¶ææåè®¸ç³»ç»ä¸­çæ°æ®å­å¨ä¸­é´ç¶æï¼å¹¶è®¤ä¸ºè¯¥ä¸­é´ç¶æçå­å¨ä¸ä¼å½±åç³»ç»çæ´ä½å¯ç¨æ§ï¼å³åè®¸ç³»ç»å¨ä¸åèç¹çæ°æ®å¯æ¬ä¹é´è¿è¡æ°æ®åæ­¥çè¿ç¨å­å¨å»¶è¿ã\n\n * æç»ä¸è´æ§ ï¼æç»ä¸è´æ§å¼ºè°çæ¯ç³»ç»ä¸­ææçæ°æ®å¯æ¬ï¼å¨ç»è¿ä¸æ®µæ¶é´çåæ­¥åï¼æç»è½å¤æå°çä¸ä¸ªä¸è´çç¶æãå æ­¤ï¼æç»ä¸è´æ§çæ¬è´¨æ¯éè¦ç³»ç»ä¿è¯æç»æ°æ®è½å¤è¾¾å°ä¸è´ï¼\n   \n   åå¸å¼ä¸­ï¼ä¸è´æ§çä¸ç§çº§å«ï¼\n   \n   * å¼ºä¸è´æ§ ï¼ç³»ç»åå¥äºä»ä¹ï¼è¯»åºæ¥å°±æ¯ä»ä¹\n   * å¼±ä¸è´æ§ ï¼ä¸ä¸å®å¯ä»¥è¯»åå°ææ°åå¥çå¼ï¼ä¹ä¸ä¿è¯å¤å°æ¶é´åè¯»åçæ°æ®æ¯ææ°çï¼åªæ¯ä¼å°½éä¿è¯æä¸ªæ¶å»è¾¾å°æ°æ®ä¸è´çç¶æã\n   * æç»ä¸è´æ§ ï¼å¼±ä¸è´æ§çåçº§çï¼ç³»ç»ä¼ä¿è¯å¨ä¸å®æ¶é´åè¾¾å°æ°æ®ä¸è´çç¶æã",charsets:{cjk:!0},lastUpdated:"2023/11/03, 18:29:13",lastUpdatedTimestamp:1699007353e3},{title:"Raftç®æ³",frontmatter:{title:"Raftç®æ³",date:"2023-11-03T18:28:49.000Z",permalink:"/pages/208bb3/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/1.%E7%90%86%E8%AE%BA/30.Raft%E7%AE%97%E6%B3%95.html",relativePath:"02.æç« /91.æ¡æ¶/1.çè®º/30.Raftç®æ³.md",key:"v-75b72c80",path:"/pages/208bb3/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. ä»»æ",slug:"_2-ä»»æ",normalizedTitle:"2. ä»»æ",charIndex:799},{level:2,title:"3. æ¥å¿",slug:"_3-æ¥å¿",normalizedTitle:"3. æ¥å¿",charIndex:1126},{level:2,title:"4. èç¹ç±»å",slug:"_4-èç¹ç±»å",normalizedTitle:"4. èç¹ç±»å",charIndex:1468},{level:3,title:"4.1 Follower è·éè",slug:"_4-1-follower-è·éè",normalizedTitle:"4.1 follower è·éè",charIndex:1779},{level:3,title:"4.2 Candidate åéè",slug:"_4-2-candidate-åéè",normalizedTitle:"4.2 candidate åéè",charIndex:2698},{level:3,title:"4.3 Leader é¢å¯¼è",slug:"_4-3-leader-é¢å¯¼è",normalizedTitle:"4.3 leader é¢å¯¼è",charIndex:3363},{level:2,title:"5. Leader çéä¸¾",slug:"_5-leader-çéä¸¾",normalizedTitle:"5. leader çéä¸¾",charIndex:3802},{level:2,title:"6. æç¥¨åè£",slug:"_6-æç¥¨åè£",normalizedTitle:"6. æç¥¨åè£",charIndex:4332},{level:2,title:"7. æ¥å¿å¤å¶",slug:"_7-æ¥å¿å¤å¶",normalizedTitle:"7. æ¥å¿å¤å¶",charIndex:4807},{level:2,title:"8. ä¿è¯æ°æ®å®å¨",slug:"_8-ä¿è¯æ°æ®å®å¨",normalizedTitle:"8. ä¿è¯æ°æ®å®å¨",charIndex:5729}],headersStr:"1. ç®è¿° 2. ä»»æ 3. æ¥å¿ 4. èç¹ç±»å 4.1 Follower è·éè 4.2 Candidate åéè 4.3 Leader é¢å¯¼è 5. Leader çéä¸¾ 6. æç¥¨åè£ 7. æ¥å¿å¤å¶ 8. ä¿è¯æ°æ®å®å¨",content:"# 1. ç®è¿°\n\nä»ä¹æ¯ Raft ç®æ³ï¼å®æ¯ä¸ç§åå¸å¼å±è¯ç®æ³ï¼è¿ä¸ªç®æ³æ¯å¹²å¥çå¢ï¼\n\nRaft æ¯ä¸ç§å±è¯ç®æ³ï¼å¶ç¹ç¹æ¯è®©å¤ä¸ªåä¸èéå¯¹æä¸ä»¶äºè¾¾æå®å¨ä¸è´ï¼ä¸ä»¶äºï¼ä¸ä¸ªç»è®ºã\n\nåæ¶ï¼å·²è¾¾æä¸è´çç»è®ºæ¯ä¸å¯æ¨ç¿»çãå¯ä»¥ä¸¾ä¸ä¸ªé¶è¡è´¦æ·çä¾å­æ¥è§£éå±è¯ç®æ³ï¼åå¦ç±ä¸æ¹æå¡å¨ç»æä¸ä¸ªéç¾¤æ¥ç»´æ¤é¶è¡è´¦æ·ç³»ç»ï¼å¦ææä¸ä¸ª Client åéç¾¤ç Leader ååºâå­ 100 åâçæä»¤ï¼é£ä¹å½éç¾¤è¿åæååºç­ä¹åï¼Client ååéç¾¤åèµ·æ¥è¯¢æ¶ï¼ä¸å®è½å¤æ¥å°è¢«å­å¨æåçè¿ 100 åé±ï¼å°±ç®ææºå¨åºç°ä¸å¯ç¨æåµï¼è¿ 100 åçè´¦ä¹ä¸å¯ç¯¡æ¹ãè¿å°±æ¯å±è¯ç®æ³è¦è¾¾å°çææã\n\nä¸é¢é£æ®µè¯æä¸ªéç¹ ï¼client åéç¾¤ä¸­ç Leader åéæ¶æ¯ãå¯¹ï¼æ´ä¸ªéç¾¤ä¸­åªæ Leader å¯ä»¥å¯¹å¤æä¾æå¡ã\n\nææåå¸å¼é¡¹ç®é½è¦ä½¿ç¨ Raft è¾¾æå±è¯åï¼\n\nä¸éè¦ï¼æä»¬åçä»ä¹ååãåå®¢ç³»ç»ï¼ä¸ºä»ä¹æ­å»ºéç¾¤ï¼ä¸ºä»ä¹åå¸å¼é¨ç½²ï¼ä¸æ¹é¢æ¯ä¸ºäºæ¿è½½æ´å¤çæµéï¼å¯ä»¥ç¨è´è½½åè¡¡ææ®µææµéååï¼å¦ä¸æ¹é¢æ¯å®³æåä½é¡¹ç®å®æºäºå°±æ æ³æä¾æå¡ã\n\nä½æ¯ Raft ç®æ³å¢ï¼ä¸æ´ä¸ªéç¾¤ä¸­åªæ Leader è½å¤æä¾æå¡ï¼æ æ³åå°è¯·æ±ååï¼æä»¥ä¸éåååè¯´çåºç¨åºæ¯ï¼é£ Raft æå¥ç¨å¢ï¼ä¸»è¦ç¨äºå¯¹æ°æ®ææçç³»ç»ï¼ä¾å¦æ°æ®å­å¨ãæä»¶å­å¨ï¼ç¨æ·ä¸ä¼ çæä»¶å¯ä»¥ä¿è¯åªè¦ä¸ä¼ æåå°±ä¸å®å®å¨ï¼å³ä½¿æèç¹å®æºæèæ´ä¸ªéç¾¤å®æºï¼å¨éç¾¤æ¢å¤åä»ç¶å¯ä»¥çå°è¿äºæä»¶ã\n\nRaft ç®æ³å Zookeeper çç®æ³å¾åï¼Zookeeper åå¥æ°æ®çæ­¥éª¤ ï¼ç¨æ·åéç¾¤åéåå½ä»¤ï¼Zookeeper ç Leader èç¹å¨å¾æ±åæ°ä»¥ä¸èç¹çåæä¹åæè½çã\n\nç°å¨æ¥ä»ç»ä¸ä¸ä»ä¹æ¯ Raftã\n\nç§ä½ é©¬èµï¼åæ¥æ¨èä¸ä¸ªBç«è§é¢ ï¼ãå¨ç»ï¼Raftç®æ³Leaderéä¸¾ãèè£åéä¸¾ãæ¥å¿å¤å¶ãä¿®å¤ä¸ä¸è´æ¥å¿åæ°æ®å®å¨ã\n\n\n# 2. ä»»æ\n\nRaftç®æ³å° Leader çå½é åä¸ºä¸ä¸ªä¸ªä»»æï¼Termï¼ï¼æ¯ä¸ä¸ªä»»æçå¼å§é½æ¯ Leader éä¸¾æ­¥éª¤ã\n\næ¯ä¸ä¸ªä»»æä»¥ä¸æ¬¡éä¸¾ä½ä¸ºèµ·ç¹ï¼æä»¥å½ä¸ä¸ªèç¹æä¸º Candidate å¹¶åå¶ä»èç¹æç¥¨æ¶ï¼ä¼å°èªå·±ç Term å 1ï¼è¡¨ç¤ºèªå·±è¦ç«äºè¿ä¸ªä»»æç Leaderãå¶ä»èç¹å¦æåæäºè¿ä¸ªè¯·æ±ï¼ä¼å°èªå·±ç Term ä¸è¯¥è¯·æ±ä¸­ç Term åæ­¥ã\n\næ¯å¦æ AãBãCãD ä¸ä¸ªèç¹ï¼A ä½ä¸º Term = 1 æ¶ç Leaderï¼é£ä¹ BãC å°±æ¯ Term = 1 æ¶çè·éèãæ­¤æ¶ A èç¹å®æºï¼B èç¹æ³è¦æä¸º Leaderï¼è¦åå°èªå·±ç Term + 1ï¼è¡¨ç¤ºèªå·±æ³è¦ç«äº Term = 2 æ¶ç Leaderã\n\n\n# 3. æ¥å¿\n\næ¥å¿æ¯èç¹ä¹é´ä¼ è¾çæ°æ®ï¼Raft è¢«ç§°ä¸ºå±è¯ç®æ³ï¼å°±æ¯å¯¹æ¥å¿çå±è¯ãå¦æä¸ä¸ªç³»ç»æ³è¦ä½¿ç¨ Raft ç®æ³å®ææé¡¹åè½ï¼é£ä¹æ¥å¿å°±æ¯éè¦æ´æ¹çä¸è¥¿ï¼æ¯å¦è¿ä¸ªç³»ç»è¦å­å¨æä»¶ï¼æä»¶æ°æ®å°±æ¯åä¸ªèç¹ä¹é´éè¦è¿è¡å±è¯çæ¥å¿ã\n\nå¨ Raft ä¸­ï¼æ¥å¿ç±ä¸ä¸ªéè¦é¨åç»æï¼\n\n * Term ID ï¼è¯¥æ¥å¿æ¯å¨åªä¸ªä»»æå½¢æç\n * Log Index ï¼è¯¥æ¥å¿å¨è¿ä¸ªä»»æåæ¯ç¬¬å ä¸ªæ¥å¿ï¼å½ç¶äºè¿ä¸ªLog Indexå¯ä»¥è·éTerm ID çæ¹åèæ¸é¶éè®¡ï¼ä¹å¯ä»¥ä¸ç´éå¢ï¼å°±çä½ æ¯æä¹å®ç° Raft ç®æ³äºã\n * Data ï¼è¯¥æ¥å¿è®°å½çæ°æ®æ¯å¥\n\næä»¥èç¹ä¹é´ä¼ è¾ç RPC Message å°±æ¯ ï¼ç¬¬ 1 ä¸ªä»»æçç¬¬ 4 æ¡æ¥å¿ï¼å­å¨çæ°æ®ä¸º abcdefg...\n\n\n# 4. èç¹ç±»å\n\néµå¾ª Raftç®æ³ çåå¸å¼éç¾¤ä¸­æ¯ä¸ªèç¹æ®æ¼ä»¥ä¸ä¸ç§è§è²ä¹ä¸ ï¼\n\n 1. Leader ï¼é¢å¯¼èãè´è´£åå®¢æ·ç«¯éä¿¡ï¼æ¥æ¶æ¥èªå®¢æ·ç«¯çå½ä»¤å¹¶åç» Followerï¼åå»ºæ¥å¿ãä¸ Follower åæ­¥æ¥å¿ã\n 2. Follower ï¼è·éèï¼ä¸ä¸ä¸èçæ§è¡æ¥èª Leader çå½ä»¤ï¼å¯ä»¥æç¥¨ç» Candidate ä½¿å¶æä¸º Leaderã\n 3. Candidate ï¼åéèï¼å½ Follower é¿æ¶é´æ²¡ææ¥æ¶å° Leader çæ¶æ¯æ¶ï¼Followerå°±ä¼æ­ç«¿èèµ·æä¸ºåéèã\n\nè§£éä¸ä¸ ï¼å¨ Raft ç³»ç»ä¸­å¹¶æ²¡æåºå®ç Leaderï¼æ¯ä¸ä¸ªèç¹é½ææä¸º Leader çæºä¼ã\n\n\n# 4.1 Follower è·éè\n\næ¥æ¶æ¥èª Leader çæ°æ®ï¼å¹¶ä¸ä¹åæ­¥ã\n\nå¦ææ²¡æ Leader æä¹åï¼éç¾¤åå¯å¨æ¶ï¼ææèç¹é½ä¸º Followerï¼æ¯ä¸ä¸ªèç¹ç»´æ¤ä¸ä¸ªéæºçè¿ææ¶é´ Timeoutï¼æ¶é´å°çæ¶åå°±ä¼åæ Candidateï¼ç»éç¾¤ä¸­å¶ä»èç¹åé RPC æ¶æ¯æç¥¨ï¼å¦æè¶è¿åæ°çèç¹åæï¼å®å°±åæ Leaderäºã\n\nå½ç¶äºï¼æ¯ç«ä¸æ¯è°é½è½å½ä¸ Leader çï¼å¦æ Follower å¨ Timeout æ¶é´åæ¥æ¶å° Candidate çæç¥¨æ¶æ¯ï¼æä¹å¤æ­æ¯å¦æç¥¨ç»å®å¢ï¼\n\n 1. åéèç Term ID æ¯èªå·±å°ï¼æç»æç¥¨ï¼å¦ææ¯èªå·±å¤§ç»§ç»­ä¸ä¸æ­¥\n 2. åéèçææ°æ¥å¿ç Term ID æ¯èªå·±ææ°æ¥å¿ç Term IDå°ï¼æç»æç¥¨ï¼å¦ææ¯èªå·±å¤§ç»§ç»­ä¸ä¸æ­¥\n 3. åéèçææ°æ¥å¿ç Index æ¯èªå·±å°ï¼æç»æç¥¨\n\nå¦æä¸é¢ä¸æ¡æ²¡æç­éæåéèï¼Follower ä¼æ¯æå®å½ Leaderï¼Follower è¦åçäº ï¼\n\n 1. å°èªå·±ç Term ID ä¸ åéèåæ­¥\n 2. åé RPC ç»è¿ä¸ªåéèæç¥¨\n\nå½ Follower æç¥¨æç»æåéèåï¼ä¼å°èªå·±ç Term ID ä¸è¯¥åéèä¿æä¸è´ã\n\nshow me code ï¼\n\nif (candidate.termId < this.termId) {\n    return false;\n}\nif (candidate.logTermID < this.logTermId) {\n    return false;\n}\nif (candidate.logIndex < this.logIndex) {\n    return false;\n} \n// å°èªå·±çä»»æä¸åéèåæ­¥\nthis.termId = candidate.termID;\n// ç»åéèåéRPCè¯·æ±ï¼åè¯å®æåæä½ å½ Leader\nthis.rpcServer.sendRPCVote(true);\n\n\nä¸ä¸ª Follower æ¯ä¸ä¸ªä»»æé½åªè½æåºä¸ç¥¨ãé¿åäºä¸ä¸ª Follower æ¯æå¤ä¸ª Candidate å½ Leader çæåµã\n\n\n# 4.2 Candidate åéè\n\nå½ Follower è¶æ¶ä¹ååæ Candidateï¼åæ Candidate åè¦åçäºï¼\n\n 1. æ Term å ä¸ï¼ä»£è¡¨è¦ç«äºè¿ä¸ªä»»æç Leader\n 2. ç»èªå·±æä¸ç¥¨\n 3. ç¶åç»éç¾¤ä¸­æ¯ä¸ä¸ªèç¹åéæç¥¨æ¶æ¯\n\næç¥¨ä¿¡æ¯ä¸­æºå¸¦çæ°æ®ï¼\n\n 1. Term ID\n 2. Last Log Term ID\n 3. Last Log Index\n\nå½é¿æ¶é´æ²¡æ Leader ç»èªå·±åæ¶æ¯æ¶ï¼Follower ä¼è®¤ä¸ºæ­¤æ¶æ²¡æ Leaderï¼çä¾¯å°ç¸å®æç§ä¹ï¼è¿æ¬¡æå½Leaderï¼æ­¤ Follower å°±æä¸º Candidateï¼ç»å¶ä»ç Follower åéæç¥¨è¯·æ±ãå¶ä»ç Follower ä¼æ ¹æ®ä¸é¢çæç¥¨è§åéæ©æ¯å¦ç»æ­¤ Candidate æç¥¨ã\n\nä¸ä¸æä¸ä¸ª Follower éè¿éä¸¾æä¸º Leaderï¼é£ä¹å®ä¼æ¯ä¸ä¸ªå¨æç»ææ Follower åéå¿è·³ï¼åè¯ä»ä»¬èå¤§è¿å¨ï¼ä½ ä»¬ä¸è¦å¤ªççã\n\néè¦æ³¨æçæ¯ï¼åéèä¼æç»ææå¶ä»åéèçæç¥¨è¯·æ±ï¼ä½æ¯å¦ææ¶å° Leader çå¿è·³è¯·æ±ï¼é£ä¹æ­¤åéèä¼æä¸ºè¯¥ Leader ç Follower\n\nåæ¶ï¼ä½ åºè¯¥ä¹çå°äº Follower ç timeout æ¶é´ä¸ºå¥æ¯éæºç\n\n> ç±äº Candidate ä¸ä¼åæå¶ä» Candidate çæç¥¨ï¼å¦æææ Follower ç timeout æ¶é´æ¯ä¸è´çï¼é£ä¹å¤§æ¦çåæ¶æä¸º Candidateï¼ä¼é æå¤æ¬¡éä¸¾é½æ æ³éä¸¾åº Leader çæåµã\n\n\n# 4.3 Leader é¢å¯¼è\n\nå½ä¸ä¸ª Candidate æä¸º Leader æ¶åï¼ä¼åææèç¹åéå±äº Leader çå¿è·³ï¼è¿ä¸ªå¿è·³å¯ä»¥è®© Candidate åæ Followerï¼åæ¶å°ææ Follower ç Timeout å·æ°ãå¹¶ä¸å¿è·³æ¯å®æ¶åéçã\n\nå½ Leader æ¶å° æ¥èªå®¢æ·ç«¯çè¯·æ±åï¼ä¼è¿è¡ä¸¤é¶æ®µ ï¼\n\n 1. å°è¯·æ±ï¼æèè¯´æ°æ®ï¼æ¾å¥æ¥å¿ä¸­ï¼åææ Follower åéè¿ä¸ªæ¥å¿\n 2. å½è¶è¿åæ°ç Follower åæ­¥æ¥å¿ä¹åï¼Leader ä¼å°è¿æ¡æ¥å¿è½çï¼å¹¶éç¥ Follower è¿è¡è½çã\n\nå½ç¶äºï¼æè¯´ è½ç åªæ¯å ä¸ºè½çå®¹æçè§£ï¼æ­£ç¡®çè¯´æ³æ¯ ï¼äº¤ç»ç¶ææºæ§è¡ã\n\nç¶ææºæ§è¡çå®éä¸å°±æ¯è¿ä¸ªç³»ç»çæ ¸å¿æä½ï¼æ¯å¦ ï¼\n\n 1. æä»¶ç³»ç»çç¶ææºæ§è¡çæ¯å°ç¨æ·æäº¤çæä»¶ä¿å­å°æ¬å°\n 2. é¶è¡ç³»ç»çç¶ææºæ§è¡çæä½æ¯å°ç¨æ·å­çé±ä¿å­å°æ°æ®åº\n\næä»¥è¯´ï¼æ ¹æ® Raft ç®æ³å®ç°ç³»ç»æ¶ï¼èªå®ä¹æ¥å¿åè¿è¦èªå®ä¹ç¶ææºã\n\n\n# 5. Leader çéä¸¾\n\næåææçèç¹é½æ¯ Followerï¼å¹¶ä¸æ¯ä¸ä¸ªèç¹é½ä¼çæä¸ä¸ªéæºç­å¾æ¶é´ï¼å¨è¿ä¸ªç­å¾æ¶é´ç»æä¹åè¿æ²¡æ Leader ç»æåæ¥æ¶æ¯ï¼é£æå°±åæ Candidate åå¶ä»èç¹æç¥¨ã\n\n\n\nå¾ä¸­ç S1ãS2...ä»£è¡¨èç¹åï¼åååé¨çæ°å­ 1 ä»£è¡¨ä»»æå·ï¼Termï¼ãååå¤é¢é£å±ç°è²è¿åº¦æ¡ä»£è¡¨éå³ç­å¾æ¶é´ã\n\nå¯ä»¥çå° S1 çç­å¾æ¶é´å·²ç»å¿«ç»æäºãç­å¾æ¶é´ä¸æ¦ç»æï¼S1 ä¼æä¸º Candidateï¼å¹¶ä¸ï¼\n\n * å°èªå·±çä»»æå ä¸\n * ç»èªå·±æä¸ç¥¨ï¼ååå¶ä»èç¹æç¥¨ï¼åé RequestVote RPC\n\n\n\nå¦å¾ï¼S1 çä»»æåä¸º 2ï¼åé¨å¤äº ä¸ä¸ªå®å¿é»åååä¸ªç©ºå¿ç½åï¼ä»£è¡¨ç°å¨åªæä¸ç¥¨ï¼æ¯èªå·±æçã\n\nS2ãS3ãS4ãS5 å¨æ¶å°è¿ä¸ªæç¥¨è¯·æ±åï¼ç±äºæ­¤æ¶æ²¡ææ¥å¿ï¼é£ä¹åªæ¯è¾ä»»æ Term IDãå¾ææ¾ S1 æ´èä¸ç­¹ã\n\né£ä¹ä¸åºæå¤çæåµä¸ï¼ S2ãS3ãS4ãS5 é½æ¯æ S1 å½é Leaderã\n\nä½æ¯ä¸åºæå¤çè¯è¦åºæå¤äºï¼\n\nS3ãS4ãS5 é½æ¯æ S1 å½é Leaderãåªæ S2 ä¸æ¯æï¼ä¸ºä»ä¹ï¼å ä¸º S2 çç­å¾æ¶é´ç»æäºï¼å®ä¹è¦æä¸º Candidate è¿è¡æç¥¨äºã\n\n\n# 6. æç¥¨åè£\n\nå¶ä»èç¹å¨æ¥æ¶å° S1 åéçæç¥¨è¯·æ±åï¼åç° S1 ç Term æ¯èªå·±å¤§ï¼äºæ¯æ¬£ç¶åæ S1ï¼å¹¶å°èªå·±çä»»æä¸ S1 è¿è¡åæ­¥ã\n\nä½æ¯ï¼S2 æä¸ºäº Candidateï¼Term åæ2ï¼Candidate ä¼æç»å¶ä» Candidate çæç¥¨ï¼æä»¥ S2 æç»äº S1 çæç¥¨ï¼\n\n\n\nå¾ä¸­ç RequestVote RPC æºå¤æºä¹±çï¼ä¸å±æä¸¤ç§æ¶æ¯ï¼\n\n 1. ä¸ç§æ¯ åæ/æç»S1æç¥¨ çè¯·æ±ã\n 2. ä¸ç§æ¯ S2 åå¶ä»èç¹åéçæç¥¨è¯·æ±ã\n\né£ä¹ S2 åéçæç¥¨è¯·æ±ä¸å®ä¸ä¼æåï¼å ä¸ºå¶ä»èç¹å·²ç»åæ S1 å½é Leader äºï¼ä¸ä¼éå¤æç¥¨ã\n\nåæ¥ S1 å·²ç»æä¸ºäº Leaderï¼ä¼åéå¿è·³åç¥å¶ä»èç¹ ï¼\n\n\n\nå½ S1 ç Leader å¿è·³å°è¾¾å¶ä»èç¹åï¼ä»ä»¬å°±é½åä¸º Followerã\n\néè¦æ³¨æçæ¯ï¼æ¯ä¸æ¬¡æ¥æ¶å°æ¥èª Leader çå¿è·³ï¼Follower é½å¿é¡»æ´æ°èªå·±çç­å¾æ¶é´ï¼éæ°ç­ãä½æ¯å¦æå¨ç­å¾æ¶é´ç»æçæ¶åè¿æ²¡æ Leader çå¿è·³ï¼è¯´æå®æ­»äºï¼æå¯åèä»£ä¹ã\n\n\n# 7. æ¥å¿å¤å¶\n\nè½ç¶è¯´æ¯æ¥å¿ï¼å¶å®å¨æä»¬çå®ç°ä¸­å¤å¶çä¹å¯ä»¥æ¯æ°æ®ï¼æä»¥è¿ä¸é¨åå¾éè¦ã\n\nå¨åé¢çåè¿°ä¸­ï¼S1 å·²ç»å½éäº Leaderï¼è¿æ¶å®æ¥æ¶å°äºç¨æ·äº§ççæ°æ®ï¼å¦ä¸ï¼\n\n\n\nS1 ç°å¨æä¸æ¡æ¥å¿ï¼æ¥å¿ç Term ID = 2ï¼ä»£è¡¨è¿æ¡æ¥å¿äº§çæ¶çä»»æä¸º2ãä¸ºä»ä¹æ¯èçº¿å¢ï¼\n\næä»¬å¯ä»¥å°èçº¿æ¥å¿çä½ä¸º è¿å­å¨äºåå­ä¸­çæ°æ®ï¼å¨åæ°èç¹ç»ä¸åå­ä¸­çæ°æ®åæè½å·æ°å°ç£çã\n\næ¯ä¸æ¯è· Zookeeper ä¸æ ·ã\n\né£ä¹æ¥å¿åæ­¥å°±æ¯ Leader ä¸­äº§ççæ¥å¿ï¼åéç» Follower å»åæ­¥ï¼å¦æåæ­¥æåå°±ç» Leader è¿åæåã\n\nå¦æä¸ä¸ªæ¥å¿åæ­¥è¯·æ±å¾å°åæ°ä»¥ä¸ç Follower çæ¯æï¼è¿ä¸ªæ¥å¿å°ä¼è¢«åå¥ç¶ææºï¼åå¥ç£çï¼ãLeader å°æ¥å¿åå¥ç£çåä¹ä¼éç¥ Follower è®©ä»ä»¬å°æ­¤æ¡æ¥å¿åå°ç£çã\n\nè¿ééè¦ä»ç»ä¸¤ä¸ªåé ï¼è¿ä¸¤ä¸ªåéè¦ç¨äºæ¥å¿åæ­¥ã\n\n 1. next index ï¼ä¸ä¸ä¸ªéè¦åæ­¥çæ¥å¿ä¸æ ã\n 2. match index ï¼å¯ä»¥åå¥ç£ççæå¤§ä¸æ ã\n\nå¨å¾éçè¡¨ç°å½¢å¼æ¯ ï¼ç®­å¤´æ¯ next indexï¼åç¹æ¯ match index\n\nè¡¥åå°ç°å¨ï¼æ¥ççLeader åéç» Follower çè¯·æ±ä¸­é½æåªäºæ°æ®ï¼\n\n 1. Leader ç next index ä½ç½®çæ¥å¿\n 2. Leader ç match indexï¼è¡¨ç¤ºææ Follower å¯ä»¥å° match index åçæ°æ®é½åå¥ç£çã\n\nå¤å¶ Index ä¸º 1 çæ¥å¿ ï¼å¯ä»¥çå° S2ãS3ãS4ãS5 é½åºç¨äºè¿æ¡æ¥å¿ãé£ä¹ Leader æ¥æ¶å°ææè¿ååï¼å°ä¼æ Index ä¸º 1 çæ¥å¿åå¥ç£çã\n\n\n\nç±äºè¶åæ°èç¹é½åæå° index = 1çæ¥å¿åæ­¥è¿åå­ãäºæ¯S1ä¸ä¸æ¡æ¶æ¯å°±æ¯\n\n * next index ï¼2\n * match index ï¼1\n\nå¶ä»èç¹å¨æ¥æ¶å°è¿ä¸ªæ¶æ¯æ¶ï¼å¦æåæï¼ä¼å° next index æ¥å¿å¤å¶å°åå­ä¸­ï¼match index çæ¥å¿åå¥ç£çä¸­ã\n\n\n\nå½åºç°æ°çèç¹è¿å¥éç¾¤æ¶ï¼Leader ä¼åéå¾å¤ä¸ª RPC è¯·æ±ç»å®è¿è¡æ¥å¿åæ­¥ã\n\n\n# 8. ä¿è¯æ°æ®å®å¨\n\nä¸é¢è¯´ Raft ç®æ³æ¯ä»¥ Leader ä¸ºä¸»çå¼ºä¸è´æ§ç®æ³ãé£ä¹å¦æåºç°ä»¥ä¸æåµï¼\n\n\n\nåè¯´ä¸ä¸æ¯ä»ä¹æåµå§ï¼å¨ S1ãS2ãS3ãS4 å¼å¿ææ¦çå·¥ä½æé´ï¼S5ä¸ç´å¤äºå®æºç¶æï¼æä»¥ S5 ä¸æ¡æ¥å¿é½æ²¡æãä½æ¯æ­¤æ¶ S1 å®æºäºï¼ä¸ä¸è®© S5 å½ä¸äº Leaderï¼S5 è¯å®è¦è¿è¡æ°æ®åæ­¥ï¼é¾éè®©å®å°å¶ä»èç¹çæ°æ®å¨é¨æ¸é¤åï¼\n\nè¯å®ä¸å¯ä»¥ï¼å«è¯´è®©å®åæ­¥æ°æ®äºï¼å°±è¿ Leader é½ä¸è½è®©å®å½ãè¿è®°å¾ä¹åè¯´ç âæç¥¨âåï¼\n\n\n\nS5 èéä¹åï¼é¦åå®ç Term å°±ä¸å®æ²¡æå¶ä»èç¹å¤§ï¼æ ¹æ¬æ²¡æå®å½ Leader çæºä¼ã\n\nå¶æ¬¡ï¼å°±ç®ä½ ç Term ä¾¥å¹¸è·å¶ä»èç¹ä¸æ ·å¤§äºï¼ä½æ¯ä½ æ¥å¿çTermæ²¡æå¶ä»èç¹å¤§ï¼å¶ä»èç¹æ ¹æ¬ä¸ä¼æä½ åã\n\næä»¥å¶ä»èç¹é½ä¸ä¼æ­ç S5 çæç¥¨ï¼å½ S2ãS3ãS4 å¶ä¸­ä¸ä¸ªèç¹è¶æ¶ï¼å°±ä¼å ä»»æç¶åæç¥¨ç¶åå½ä¸Leaderã",normalizedContent:"# 1. ç®è¿°\n\nä»ä¹æ¯ raft ç®æ³ï¼å®æ¯ä¸ç§åå¸å¼å±è¯ç®æ³ï¼è¿ä¸ªç®æ³æ¯å¹²å¥çå¢ï¼\n\nraft æ¯ä¸ç§å±è¯ç®æ³ï¼å¶ç¹ç¹æ¯è®©å¤ä¸ªåä¸èéå¯¹æä¸ä»¶äºè¾¾æå®å¨ä¸è´ï¼ä¸ä»¶äºï¼ä¸ä¸ªç»è®ºã\n\nåæ¶ï¼å·²è¾¾æä¸è´çç»è®ºæ¯ä¸å¯æ¨ç¿»çãå¯ä»¥ä¸¾ä¸ä¸ªé¶è¡è´¦æ·çä¾å­æ¥è§£éå±è¯ç®æ³ï¼åå¦ç±ä¸æ¹æå¡å¨ç»æä¸ä¸ªéç¾¤æ¥ç»´æ¤é¶è¡è´¦æ·ç³»ç»ï¼å¦ææä¸ä¸ª client åéç¾¤ç leader ååºâå­ 100 åâçæä»¤ï¼é£ä¹å½éç¾¤è¿åæååºç­ä¹åï¼client ååéç¾¤åèµ·æ¥è¯¢æ¶ï¼ä¸å®è½å¤æ¥å°è¢«å­å¨æåçè¿ 100 åé±ï¼å°±ç®ææºå¨åºç°ä¸å¯ç¨æåµï¼è¿ 100 åçè´¦ä¹ä¸å¯ç¯¡æ¹ãè¿å°±æ¯å±è¯ç®æ³è¦è¾¾å°çææã\n\nä¸é¢é£æ®µè¯æä¸ªéç¹ ï¼client åéç¾¤ä¸­ç leader åéæ¶æ¯ãå¯¹ï¼æ´ä¸ªéç¾¤ä¸­åªæ leader å¯ä»¥å¯¹å¤æä¾æå¡ã\n\nææåå¸å¼é¡¹ç®é½è¦ä½¿ç¨ raft è¾¾æå±è¯åï¼\n\nä¸éè¦ï¼æä»¬åçä»ä¹ååãåå®¢ç³»ç»ï¼ä¸ºä»ä¹æ­å»ºéç¾¤ï¼ä¸ºä»ä¹åå¸å¼é¨ç½²ï¼ä¸æ¹é¢æ¯ä¸ºäºæ¿è½½æ´å¤çæµéï¼å¯ä»¥ç¨è´è½½åè¡¡ææ®µææµéååï¼å¦ä¸æ¹é¢æ¯å®³æåä½é¡¹ç®å®æºäºå°±æ æ³æä¾æå¡ã\n\nä½æ¯ raft ç®æ³å¢ï¼ä¸æ´ä¸ªéç¾¤ä¸­åªæ leader è½å¤æä¾æå¡ï¼æ æ³åå°è¯·æ±ååï¼æä»¥ä¸éåååè¯´çåºç¨åºæ¯ï¼é£ raft æå¥ç¨å¢ï¼ä¸»è¦ç¨äºå¯¹æ°æ®ææçç³»ç»ï¼ä¾å¦æ°æ®å­å¨ãæä»¶å­å¨ï¼ç¨æ·ä¸ä¼ çæä»¶å¯ä»¥ä¿è¯åªè¦ä¸ä¼ æåå°±ä¸å®å®å¨ï¼å³ä½¿æèç¹å®æºæèæ´ä¸ªéç¾¤å®æºï¼å¨éç¾¤æ¢å¤åä»ç¶å¯ä»¥çå°è¿äºæä»¶ã\n\nraft ç®æ³å zookeeper çç®æ³å¾åï¼zookeeper åå¥æ°æ®çæ­¥éª¤ ï¼ç¨æ·åéç¾¤åéåå½ä»¤ï¼zookeeper ç leader èç¹å¨å¾æ±åæ°ä»¥ä¸èç¹çåæä¹åæè½çã\n\nç°å¨æ¥ä»ç»ä¸ä¸ä»ä¹æ¯ raftã\n\nç§ä½ é©¬èµï¼åæ¥æ¨èä¸ä¸ªbç«è§é¢ ï¼ãå¨ç»ï¼raftç®æ³leaderéä¸¾ãèè£åéä¸¾ãæ¥å¿å¤å¶ãä¿®å¤ä¸ä¸è´æ¥å¿åæ°æ®å®å¨ã\n\n\n# 2. ä»»æ\n\nraftç®æ³å° leader çå½é åä¸ºä¸ä¸ªä¸ªä»»æï¼termï¼ï¼æ¯ä¸ä¸ªä»»æçå¼å§é½æ¯ leader éä¸¾æ­¥éª¤ã\n\næ¯ä¸ä¸ªä»»æä»¥ä¸æ¬¡éä¸¾ä½ä¸ºèµ·ç¹ï¼æä»¥å½ä¸ä¸ªèç¹æä¸º candidate å¹¶åå¶ä»èç¹æç¥¨æ¶ï¼ä¼å°èªå·±ç term å 1ï¼è¡¨ç¤ºèªå·±è¦ç«äºè¿ä¸ªä»»æç leaderãå¶ä»èç¹å¦æåæäºè¿ä¸ªè¯·æ±ï¼ä¼å°èªå·±ç term ä¸è¯¥è¯·æ±ä¸­ç term åæ­¥ã\n\næ¯å¦æ aãbãcãd ä¸ä¸ªèç¹ï¼a ä½ä¸º term = 1 æ¶ç leaderï¼é£ä¹ bãc å°±æ¯ term = 1 æ¶çè·éèãæ­¤æ¶ a èç¹å®æºï¼b èç¹æ³è¦æä¸º leaderï¼è¦åå°èªå·±ç term + 1ï¼è¡¨ç¤ºèªå·±æ³è¦ç«äº term = 2 æ¶ç leaderã\n\n\n# 3. æ¥å¿\n\næ¥å¿æ¯èç¹ä¹é´ä¼ è¾çæ°æ®ï¼raft è¢«ç§°ä¸ºå±è¯ç®æ³ï¼å°±æ¯å¯¹æ¥å¿çå±è¯ãå¦æä¸ä¸ªç³»ç»æ³è¦ä½¿ç¨ raft ç®æ³å®ææé¡¹åè½ï¼é£ä¹æ¥å¿å°±æ¯éè¦æ´æ¹çä¸è¥¿ï¼æ¯å¦è¿ä¸ªç³»ç»è¦å­å¨æä»¶ï¼æä»¶æ°æ®å°±æ¯åä¸ªèç¹ä¹é´éè¦è¿è¡å±è¯çæ¥å¿ã\n\nå¨ raft ä¸­ï¼æ¥å¿ç±ä¸ä¸ªéè¦é¨åç»æï¼\n\n * term id ï¼è¯¥æ¥å¿æ¯å¨åªä¸ªä»»æå½¢æç\n * log index ï¼è¯¥æ¥å¿å¨è¿ä¸ªä»»æåæ¯ç¬¬å ä¸ªæ¥å¿ï¼å½ç¶äºè¿ä¸ªlog indexå¯ä»¥è·éterm id çæ¹åèæ¸é¶éè®¡ï¼ä¹å¯ä»¥ä¸ç´éå¢ï¼å°±çä½ æ¯æä¹å®ç° raft ç®æ³äºã\n * data ï¼è¯¥æ¥å¿è®°å½çæ°æ®æ¯å¥\n\næä»¥èç¹ä¹é´ä¼ è¾ç rpc message å°±æ¯ ï¼ç¬¬ 1 ä¸ªä»»æçç¬¬ 4 æ¡æ¥å¿ï¼å­å¨çæ°æ®ä¸º abcdefg...\n\n\n# 4. èç¹ç±»å\n\néµå¾ª raftç®æ³ çåå¸å¼éç¾¤ä¸­æ¯ä¸ªèç¹æ®æ¼ä»¥ä¸ä¸ç§è§è²ä¹ä¸ ï¼\n\n 1. leader ï¼é¢å¯¼èãè´è´£åå®¢æ·ç«¯éä¿¡ï¼æ¥æ¶æ¥èªå®¢æ·ç«¯çå½ä»¤å¹¶åç» followerï¼åå»ºæ¥å¿ãä¸ follower åæ­¥æ¥å¿ã\n 2. follower ï¼è·éèï¼ä¸ä¸ä¸èçæ§è¡æ¥èª leader çå½ä»¤ï¼å¯ä»¥æç¥¨ç» candidate ä½¿å¶æä¸º leaderã\n 3. candidate ï¼åéèï¼å½ follower é¿æ¶é´æ²¡ææ¥æ¶å° leader çæ¶æ¯æ¶ï¼followerå°±ä¼æ­ç«¿èèµ·æä¸ºåéèã\n\nè§£éä¸ä¸ ï¼å¨ raft ç³»ç»ä¸­å¹¶æ²¡æåºå®ç leaderï¼æ¯ä¸ä¸ªèç¹é½ææä¸º leader çæºä¼ã\n\n\n# 4.1 follower è·éè\n\næ¥æ¶æ¥èª leader çæ°æ®ï¼å¹¶ä¸ä¹åæ­¥ã\n\nå¦ææ²¡æ leader æä¹åï¼éç¾¤åå¯å¨æ¶ï¼ææèç¹é½ä¸º followerï¼æ¯ä¸ä¸ªèç¹ç»´æ¤ä¸ä¸ªéæºçè¿ææ¶é´ timeoutï¼æ¶é´å°çæ¶åå°±ä¼åæ candidateï¼ç»éç¾¤ä¸­å¶ä»èç¹åé rpc æ¶æ¯æç¥¨ï¼å¦æè¶è¿åæ°çèç¹åæï¼å®å°±åæ leaderäºã\n\nå½ç¶äºï¼æ¯ç«ä¸æ¯è°é½è½å½ä¸ leader çï¼å¦æ follower å¨ timeout æ¶é´åæ¥æ¶å° candidate çæç¥¨æ¶æ¯ï¼æä¹å¤æ­æ¯å¦æç¥¨ç»å®å¢ï¼\n\n 1. åéèç term id æ¯èªå·±å°ï¼æç»æç¥¨ï¼å¦ææ¯èªå·±å¤§ç»§ç»­ä¸ä¸æ­¥\n 2. åéèçææ°æ¥å¿ç term id æ¯èªå·±ææ°æ¥å¿ç term idå°ï¼æç»æç¥¨ï¼å¦ææ¯èªå·±å¤§ç»§ç»­ä¸ä¸æ­¥\n 3. åéèçææ°æ¥å¿ç index æ¯èªå·±å°ï¼æç»æç¥¨\n\nå¦æä¸é¢ä¸æ¡æ²¡æç­éæåéèï¼follower ä¼æ¯æå®å½ leaderï¼follower è¦åçäº ï¼\n\n 1. å°èªå·±ç term id ä¸ åéèåæ­¥\n 2. åé rpc ç»è¿ä¸ªåéèæç¥¨\n\nå½ follower æç¥¨æç»æåéèåï¼ä¼å°èªå·±ç term id ä¸è¯¥åéèä¿æä¸è´ã\n\nshow me code ï¼\n\nif (candidate.termid < this.termid) {\n    return false;\n}\nif (candidate.logtermid < this.logtermid) {\n    return false;\n}\nif (candidate.logindex < this.logindex) {\n    return false;\n} \n// å°èªå·±çä»»æä¸åéèåæ­¥\nthis.termid = candidate.termid;\n// ç»åéèåérpcè¯·æ±ï¼åè¯å®æåæä½ å½ leader\nthis.rpcserver.sendrpcvote(true);\n\n\nä¸ä¸ª follower æ¯ä¸ä¸ªä»»æé½åªè½æåºä¸ç¥¨ãé¿åäºä¸ä¸ª follower æ¯æå¤ä¸ª candidate å½ leader çæåµã\n\n\n# 4.2 candidate åéè\n\nå½ follower è¶æ¶ä¹ååæ candidateï¼åæ candidate åè¦åçäºï¼\n\n 1. æ term å ä¸ï¼ä»£è¡¨è¦ç«äºè¿ä¸ªä»»æç leader\n 2. ç»èªå·±æä¸ç¥¨\n 3. ç¶åç»éç¾¤ä¸­æ¯ä¸ä¸ªèç¹åéæç¥¨æ¶æ¯\n\næç¥¨ä¿¡æ¯ä¸­æºå¸¦çæ°æ®ï¼\n\n 1. term id\n 2. last log term id\n 3. last log index\n\nå½é¿æ¶é´æ²¡æ leader ç»èªå·±åæ¶æ¯æ¶ï¼follower ä¼è®¤ä¸ºæ­¤æ¶æ²¡æ leaderï¼çä¾¯å°ç¸å®æç§ä¹ï¼è¿æ¬¡æå½leaderï¼æ­¤ follower å°±æä¸º candidateï¼ç»å¶ä»ç follower åéæç¥¨è¯·æ±ãå¶ä»ç follower ä¼æ ¹æ®ä¸é¢çæç¥¨è§åéæ©æ¯å¦ç»æ­¤ candidate æç¥¨ã\n\nä¸ä¸æä¸ä¸ª follower éè¿éä¸¾æä¸º leaderï¼é£ä¹å®ä¼æ¯ä¸ä¸ªå¨æç»ææ follower åéå¿è·³ï¼åè¯ä»ä»¬èå¤§è¿å¨ï¼ä½ ä»¬ä¸è¦å¤ªççã\n\néè¦æ³¨æçæ¯ï¼åéèä¼æç»ææå¶ä»åéèçæç¥¨è¯·æ±ï¼ä½æ¯å¦ææ¶å° leader çå¿è·³è¯·æ±ï¼é£ä¹æ­¤åéèä¼æä¸ºè¯¥ leader ç follower\n\nåæ¶ï¼ä½ åºè¯¥ä¹çå°äº follower ç timeout æ¶é´ä¸ºå¥æ¯éæºç\n\n> ç±äº candidate ä¸ä¼åæå¶ä» candidate çæç¥¨ï¼å¦æææ follower ç timeout æ¶é´æ¯ä¸è´çï¼é£ä¹å¤§æ¦çåæ¶æä¸º candidateï¼ä¼é æå¤æ¬¡éä¸¾é½æ æ³éä¸¾åº leader çæåµã\n\n\n# 4.3 leader é¢å¯¼è\n\nå½ä¸ä¸ª candidate æä¸º leader æ¶åï¼ä¼åææèç¹åéå±äº leader çå¿è·³ï¼è¿ä¸ªå¿è·³å¯ä»¥è®© candidate åæ followerï¼åæ¶å°ææ follower ç timeout å·æ°ãå¹¶ä¸å¿è·³æ¯å®æ¶åéçã\n\nå½ leader æ¶å° æ¥èªå®¢æ·ç«¯çè¯·æ±åï¼ä¼è¿è¡ä¸¤é¶æ®µ ï¼\n\n 1. å°è¯·æ±ï¼æèè¯´æ°æ®ï¼æ¾å¥æ¥å¿ä¸­ï¼åææ follower åéè¿ä¸ªæ¥å¿\n 2. å½è¶è¿åæ°ç follower åæ­¥æ¥å¿ä¹åï¼leader ä¼å°è¿æ¡æ¥å¿è½çï¼å¹¶éç¥ follower è¿è¡è½çã\n\nå½ç¶äºï¼æè¯´ è½ç åªæ¯å ä¸ºè½çå®¹æçè§£ï¼æ­£ç¡®çè¯´æ³æ¯ ï¼äº¤ç»ç¶ææºæ§è¡ã\n\nç¶ææºæ§è¡çå®éä¸å°±æ¯è¿ä¸ªç³»ç»çæ ¸å¿æä½ï¼æ¯å¦ ï¼\n\n 1. æä»¶ç³»ç»çç¶ææºæ§è¡çæ¯å°ç¨æ·æäº¤çæä»¶ä¿å­å°æ¬å°\n 2. é¶è¡ç³»ç»çç¶ææºæ§è¡çæä½æ¯å°ç¨æ·å­çé±ä¿å­å°æ°æ®åº\n\næä»¥è¯´ï¼æ ¹æ® raft ç®æ³å®ç°ç³»ç»æ¶ï¼èªå®ä¹æ¥å¿åè¿è¦èªå®ä¹ç¶ææºã\n\n\n# 5. leader çéä¸¾\n\næåææçèç¹é½æ¯ followerï¼å¹¶ä¸æ¯ä¸ä¸ªèç¹é½ä¼çæä¸ä¸ªéæºç­å¾æ¶é´ï¼å¨è¿ä¸ªç­å¾æ¶é´ç»æä¹åè¿æ²¡æ leader ç»æåæ¥æ¶æ¯ï¼é£æå°±åæ candidate åå¶ä»èç¹æç¥¨ã\n\n\n\nå¾ä¸­ç s1ãs2...ä»£è¡¨èç¹åï¼åååé¨çæ°å­ 1 ä»£è¡¨ä»»æå·ï¼termï¼ãååå¤é¢é£å±ç°è²è¿åº¦æ¡ä»£è¡¨éå³ç­å¾æ¶é´ã\n\nå¯ä»¥çå° s1 çç­å¾æ¶é´å·²ç»å¿«ç»æäºãç­å¾æ¶é´ä¸æ¦ç»æï¼s1 ä¼æä¸º candidateï¼å¹¶ä¸ï¼\n\n * å°èªå·±çä»»æå ä¸\n * ç»èªå·±æä¸ç¥¨ï¼ååå¶ä»èç¹æç¥¨ï¼åé requestvote rpc\n\n\n\nå¦å¾ï¼s1 çä»»æåä¸º 2ï¼åé¨å¤äº ä¸ä¸ªå®å¿é»åååä¸ªç©ºå¿ç½åï¼ä»£è¡¨ç°å¨åªæä¸ç¥¨ï¼æ¯èªå·±æçã\n\ns2ãs3ãs4ãs5 å¨æ¶å°è¿ä¸ªæç¥¨è¯·æ±åï¼ç±äºæ­¤æ¶æ²¡ææ¥å¿ï¼é£ä¹åªæ¯è¾ä»»æ term idãå¾ææ¾ s1 æ´èä¸ç­¹ã\n\né£ä¹ä¸åºæå¤çæåµä¸ï¼ s2ãs3ãs4ãs5 é½æ¯æ s1 å½é leaderã\n\nä½æ¯ä¸åºæå¤çè¯è¦åºæå¤äºï¼\n\ns3ãs4ãs5 é½æ¯æ s1 å½é leaderãåªæ s2 ä¸æ¯æï¼ä¸ºä»ä¹ï¼å ä¸º s2 çç­å¾æ¶é´ç»æäºï¼å®ä¹è¦æä¸º candidate è¿è¡æç¥¨äºã\n\n\n# 6. æç¥¨åè£\n\nå¶ä»èç¹å¨æ¥æ¶å° s1 åéçæç¥¨è¯·æ±åï¼åç° s1 ç term æ¯èªå·±å¤§ï¼äºæ¯æ¬£ç¶åæ s1ï¼å¹¶å°èªå·±çä»»æä¸ s1 è¿è¡åæ­¥ã\n\nä½æ¯ï¼s2 æä¸ºäº candidateï¼term åæ2ï¼candidate ä¼æç»å¶ä» candidate çæç¥¨ï¼æä»¥ s2 æç»äº s1 çæç¥¨ï¼\n\n\n\nå¾ä¸­ç requestvote rpc æºå¤æºä¹±çï¼ä¸å±æä¸¤ç§æ¶æ¯ï¼\n\n 1. ä¸ç§æ¯ åæ/æç»s1æç¥¨ çè¯·æ±ã\n 2. ä¸ç§æ¯ s2 åå¶ä»èç¹åéçæç¥¨è¯·æ±ã\n\né£ä¹ s2 åéçæç¥¨è¯·æ±ä¸å®ä¸ä¼æåï¼å ä¸ºå¶ä»èç¹å·²ç»åæ s1 å½é leader äºï¼ä¸ä¼éå¤æç¥¨ã\n\nåæ¥ s1 å·²ç»æä¸ºäº leaderï¼ä¼åéå¿è·³åç¥å¶ä»èç¹ ï¼\n\n\n\nå½ s1 ç leader å¿è·³å°è¾¾å¶ä»èç¹åï¼ä»ä»¬å°±é½åä¸º followerã\n\néè¦æ³¨æçæ¯ï¼æ¯ä¸æ¬¡æ¥æ¶å°æ¥èª leader çå¿è·³ï¼follower é½å¿é¡»æ´æ°èªå·±çç­å¾æ¶é´ï¼éæ°ç­ãä½æ¯å¦æå¨ç­å¾æ¶é´ç»æçæ¶åè¿æ²¡æ leader çå¿è·³ï¼è¯´æå®æ­»äºï¼æå¯åèä»£ä¹ã\n\n\n# 7. æ¥å¿å¤å¶\n\nè½ç¶è¯´æ¯æ¥å¿ï¼å¶å®å¨æä»¬çå®ç°ä¸­å¤å¶çä¹å¯ä»¥æ¯æ°æ®ï¼æä»¥è¿ä¸é¨åå¾éè¦ã\n\nå¨åé¢çåè¿°ä¸­ï¼s1 å·²ç»å½éäº leaderï¼è¿æ¶å®æ¥æ¶å°äºç¨æ·äº§ççæ°æ®ï¼å¦ä¸ï¼\n\n\n\ns1 ç°å¨æä¸æ¡æ¥å¿ï¼æ¥å¿ç term id = 2ï¼ä»£è¡¨è¿æ¡æ¥å¿äº§çæ¶çä»»æä¸º2ãä¸ºä»ä¹æ¯èçº¿å¢ï¼\n\næä»¬å¯ä»¥å°èçº¿æ¥å¿çä½ä¸º è¿å­å¨äºåå­ä¸­çæ°æ®ï¼å¨åæ°èç¹ç»ä¸åå­ä¸­çæ°æ®åæè½å·æ°å°ç£çã\n\næ¯ä¸æ¯è· zookeeper ä¸æ ·ã\n\né£ä¹æ¥å¿åæ­¥å°±æ¯ leader ä¸­äº§ççæ¥å¿ï¼åéç» follower å»åæ­¥ï¼å¦æåæ­¥æåå°±ç» leader è¿åæåã\n\nå¦æä¸ä¸ªæ¥å¿åæ­¥è¯·æ±å¾å°åæ°ä»¥ä¸ç follower çæ¯æï¼è¿ä¸ªæ¥å¿å°ä¼è¢«åå¥ç¶ææºï¼åå¥ç£çï¼ãleader å°æ¥å¿åå¥ç£çåä¹ä¼éç¥ follower è®©ä»ä»¬å°æ­¤æ¡æ¥å¿åå°ç£çã\n\nè¿ééè¦ä»ç»ä¸¤ä¸ªåé ï¼è¿ä¸¤ä¸ªåéè¦ç¨äºæ¥å¿åæ­¥ã\n\n 1. next index ï¼ä¸ä¸ä¸ªéè¦åæ­¥çæ¥å¿ä¸æ ã\n 2. match index ï¼å¯ä»¥åå¥ç£ççæå¤§ä¸æ ã\n\nå¨å¾éçè¡¨ç°å½¢å¼æ¯ ï¼ç®­å¤´æ¯ next indexï¼åç¹æ¯ match index\n\nè¡¥åå°ç°å¨ï¼æ¥ççleader åéç» follower çè¯·æ±ä¸­é½æåªäºæ°æ®ï¼\n\n 1. leader ç next index ä½ç½®çæ¥å¿\n 2. leader ç match indexï¼è¡¨ç¤ºææ follower å¯ä»¥å° match index åçæ°æ®é½åå¥ç£çã\n\nå¤å¶ index ä¸º 1 çæ¥å¿ ï¼å¯ä»¥çå° s2ãs3ãs4ãs5 é½åºç¨äºè¿æ¡æ¥å¿ãé£ä¹ leader æ¥æ¶å°ææè¿ååï¼å°ä¼æ index ä¸º 1 çæ¥å¿åå¥ç£çã\n\n\n\nç±äºè¶åæ°èç¹é½åæå° index = 1çæ¥å¿åæ­¥è¿åå­ãäºæ¯s1ä¸ä¸æ¡æ¶æ¯å°±æ¯\n\n * next index ï¼2\n * match index ï¼1\n\nå¶ä»èç¹å¨æ¥æ¶å°è¿ä¸ªæ¶æ¯æ¶ï¼å¦æåæï¼ä¼å° next index æ¥å¿å¤å¶å°åå­ä¸­ï¼match index çæ¥å¿åå¥ç£çä¸­ã\n\n\n\nå½åºç°æ°çèç¹è¿å¥éç¾¤æ¶ï¼leader ä¼åéå¾å¤ä¸ª rpc è¯·æ±ç»å®è¿è¡æ¥å¿åæ­¥ã\n\n\n# 8. ä¿è¯æ°æ®å®å¨\n\nä¸é¢è¯´ raft ç®æ³æ¯ä»¥ leader ä¸ºä¸»çå¼ºä¸è´æ§ç®æ³ãé£ä¹å¦æåºç°ä»¥ä¸æåµï¼\n\n\n\nåè¯´ä¸ä¸æ¯ä»ä¹æåµå§ï¼å¨ s1ãs2ãs3ãs4 å¼å¿ææ¦çå·¥ä½æé´ï¼s5ä¸ç´å¤äºå®æºç¶æï¼æä»¥ s5 ä¸æ¡æ¥å¿é½æ²¡æãä½æ¯æ­¤æ¶ s1 å®æºäºï¼ä¸ä¸è®© s5 å½ä¸äº leaderï¼s5 è¯å®è¦è¿è¡æ°æ®åæ­¥ï¼é¾éè®©å®å°å¶ä»èç¹çæ°æ®å¨é¨æ¸é¤åï¼\n\nè¯å®ä¸å¯ä»¥ï¼å«è¯´è®©å®åæ­¥æ°æ®äºï¼å°±è¿ leader é½ä¸è½è®©å®å½ãè¿è®°å¾ä¹åè¯´ç âæç¥¨âåï¼\n\n\n\ns5 èéä¹åï¼é¦åå®ç term å°±ä¸å®æ²¡æå¶ä»èç¹å¤§ï¼æ ¹æ¬æ²¡æå®å½ leader çæºä¼ã\n\nå¶æ¬¡ï¼å°±ç®ä½ ç term ä¾¥å¹¸è·å¶ä»èç¹ä¸æ ·å¤§äºï¼ä½æ¯ä½ æ¥å¿çtermæ²¡æå¶ä»èç¹å¤§ï¼å¶ä»èç¹æ ¹æ¬ä¸ä¼æä½ åã\n\næä»¥å¶ä»èç¹é½ä¸ä¼æ­ç s5 çæç¥¨ï¼å½ s2ãs3ãs4 å¶ä¸­ä¸ä¸ªèç¹è¶æ¶ï¼å°±ä¼å ä»»æç¶åæç¥¨ç¶åå½ä¸leaderã",charsets:{cjk:!0},lastUpdated:"2023/12/21, 20:32:43",lastUpdatedTimestamp:1703161963e3},{title:"2. XXL-JOBçä½¿ç¨",frontmatter:{title:"2. XXL-JOBçä½¿ç¨",date:"2023-11-20T12:56:32.000Z",permalink:"/pages/fcb98f/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/100.XXL-JOB/2.XXL-JOB%E7%9A%84%E4%BD%BF%E7%94%A8.html",relativePath:"02.æç« /91.æ¡æ¶/100.XXL-JOB/2.XXL-JOBçä½¿ç¨.md",key:"v-64094560",path:"/pages/fcb98f/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. ç®åä»»å¡çæ§è¡",slug:"_1-ç®åä»»å¡çæ§è¡",normalizedTitle:"1. ç®åä»»å¡çæ§è¡",charIndex:312},{level:3,title:"1.2 æ·»å éç½®",slug:"_1-2-æ·»å éç½®",normalizedTitle:"1.2 æ·»å éç½®",charIndex:871},{level:3,title:"1.3 æ·»å ä»»å¡",slug:"_1-3-æ·»å ä»»å¡",normalizedTitle:"1.3 æ·»å ä»»å¡",charIndex:2946},{level:3,title:"1.4 æ§è¡ä»»å¡",slug:"_1-4-æ§è¡ä»»å¡",normalizedTitle:"1.4 æ§è¡ä»»å¡",charIndex:3938},{level:2,title:"2. æ¥å¿è®°å½",slug:"_2-æ¥å¿è®°å½",normalizedTitle:"2. æ¥å¿è®°å½",charIndex:4037},{level:2,title:"3. åºå®éçæ§è¡",slug:"_3-åºå®éçæ§è¡",normalizedTitle:"3. åºå®éçæ§è¡",charIndex:5939},{level:2,title:"4. æ§è¡ä»»å¡åæ°",slug:"_4-æ§è¡ä»»å¡åæ°",normalizedTitle:"4. æ§è¡ä»»å¡åæ°",charIndex:6022},{level:2,title:"5. ä»»å¡è¶æ¶æ¶é´",slug:"_5-ä»»å¡è¶æ¶æ¶é´",normalizedTitle:"5. ä»»å¡è¶æ¶æ¶é´",charIndex:6497}],headersStr:"0. åè¨ 1. ç®åä»»å¡çæ§è¡ 1.2 æ·»å éç½® 1.3 æ·»å ä»»å¡ 1.4 æ§è¡ä»»å¡ 2. æ¥å¿è®°å½ 3. åºå®éçæ§è¡ 4. æ§è¡ä»»å¡åæ° 5. ä»»å¡è¶æ¶æ¶é´",content:'# 0. åè¨\n\nä¸ä¸ç« å¸¦å¤§å®¶å®è£äº xxl-jobï¼ä¸è½½åºæ¥æºç ä¸å±ä¸ä¸ªå¤§æ¨¡åï¼\n\n- xxl-job-admin\n- xxl-job-core\n- xxl-job-executor-sample\n  - xxl-job-executor-sample-frameless\n  - xxl-job-executor-sample-springboot\n\n\n * xxl-job-admin ï¼è°åº¦ä¸­å¿\n * xxl-job-core ï¼æ ¸å¿ç±»ï¼å¶ä¸­æè°åº¦ä¸­å¿éè¦çåè½åæ§è¡å¨éè¦çææåè½ã\n * xxl-job-executor-sample ï¼xxl-jobæä¾çå®ä¾ï¼ææ æ¡æ¶çæ¬ãæ´åspringççæ¬\n\n\n# 1. ç®åä»»å¡çæ§è¡\n\nXxl-Job æä¾äºä¸ä¸ªæ³¨è§£ @XxlJobæ æ³¨å®æ¶ä»»å¡ï¼æä»¬åªéè¦å®ä¹ä¸ä¸ªbeanå¯¹è±¡ï¼å¨æ¹æ³ä¸å ä¸ @XxlJobæ³¨è§£ï¼è¿ä¸ªæ¹æ³å°±æä¸ºå®æ¶ä»»å¡æ¹æ³äºã\n\n@Target({ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\n@Inherited\npublic @interface XxlJob {\n    String value();\n\n    String init() default "";\n\n    String destroy() default "";\n}\n\n\nå¯ä»¥çå° @XxlJobåªè½æå®å®æ¶ä»»å¡çæ¹æ³åååå§åæ¹æ³ãéæ¯æ¹æ³ãä½æ¯ä¸ä¸ªå®æ¶ä»»å¡çå³é®åºè¯¥æ¯æ§è¡é¢çåï¼å¨åªéæå®å¢ï¼å¨webæ§å¶å°æå®ã\n\n\n\n###1.1 æ·»å ä¾èµ\n\nä¸å®è¦è·ä¸è½½ç xxl-job çæ¬ä¸è´ ï¼\n\n\x3c!-- xxl-job-core --\x3e\n<dependency>\n    <groupId>com.xuxueli</groupId>\n    <artifactId>xxl-job-core</artifactId>\n    <version>2.4.0</version>\n</dependency>\n\n\n\n# 1.2 æ·»å éç½®\n\n# web port\nserver.port=3999\n# no web\n#spring.main.web-environment=false\n\n# log config\nlogging.config=classpath:logback.xml\n\n\n### xxl-job admin address list, such as "http://address" or "http://address01,http://address02"\nxxl.job.admin.addresses=http://127.0.0.1:8080/xxl-job-admin\n\n### xxl-job, access token\nxxl.job.accessToken=default_token\n\n### xxl-job executor appname\nxxl.job.executor.appname=xxl-job-executor-sample\n### xxl-job executor registry-address: default use address to registry , otherwise use ip:port if address is null\nxxl.job.executor.address=\n### xxl-job executor server-info\nxxl.job.executor.ip=\nxxl.job.executor.port=9999\n### xxl-job executor log-path\nxxl.job.executor.logpath=/data/applogs/xxl-job/jobhandler\n### xxl-job executor log-retention-days\nxxl.job.executor.logretentiondays=30\n\n\nå¯¹äºï¼logging.config è¿ä¸ªæ¥å¿éç½® logback.xml ä½ å¦ææ²¡æçè¯å¯ä»¥æ xxl-job-executor-sample-springboot éçéç½®æ¿è¿æ¥ã\n\n\n@Configuration\npublic class XxlJobConfig {\n    private Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);\n    @Value("${xxl.job.admin.addresses}")\n    private String adminAddresses;\n    @Value("${xxl.job.accessToken}")\n    private String accessToken;\n    @Value("${xxl.job.executor.appname}")\n    private String appname;\n    @Value("${xxl.job.executor.port}")\n    private int port;\n    @Value("${xxl.job.executor.logpath}")\n    private String logPath;\n    @Value("${xxl.job.executor.logretentiondays}")\n    private int logRetentionDays;\n\n    @Bean\n    public XxlJobSpringExecutor xxlJobExecutor() {\n        logger.info(">>>>>>>>>>> xxl-job config init.");\n        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();\n        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);\n        xxlJobSpringExecutor.setAppname(appname);\n        // çç¥ IP å address çéç½®\n        xxlJobSpringExecutor.setPort(port);\n        xxlJobSpringExecutor.setAccessToken(accessToken);\n        xxlJobSpringExecutor.setLogPath(logPath);\n        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);\n\n        return xxlJobSpringExecutor;\n    }\n}\n\n\n\n# 1.3 æ·»å ä»»å¡\n\nXxl-jobä¸SpringBootæ´åæ¶\n\n 1. åä»£ç \n    \n    åå¦æä»¬æä¸ä¸ªéæ± ï¼æ¯åéæ£æ¥ååçåºå­æ¯å¦è¶³å¤ï¼å¦æä¸å¤å°±æéåå®¶æ·»å åºå­ã\n    \n    å¨ä»£ç ä¸­åªæ¯å®æä»»å¡ ï¼\n    \n    import com.xxl.job.core.handler.annotation.XxlJob;\n    import org.slf4j.Logger;\n    import org.slf4j.LoggerFactory;\n    import org.springframework.stereotype.Component;\n    \n    import java.util.Random;\n    \n    @Component\n    public class XxlJobHandler {\n        private static final Logger logger = LoggerFactory.getLogger(XxlJobHandler.class);\n        @XxlJob("checkStore")\n        public void check() {\n            logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n            System.out.println("æ£æ¥åºå­");\n            int store = new Random().nextInt(3);\n            if (store <= 0) {\n                System.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n            }\n            System.out.println("æ£æ¥å®æ¯");\n            logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n        }\n    }\n    \n\n 2. éç½®ä»»å¡\n    \n    æå¼webæ§å¶å°ï¼å¶ä»çæä»¬ä¸æä¹ä¸å¨ï¼ä½æ¯è¦ææ§è¡é¢çæ¹äº\n    \n    -- æ¯åéæå®çcornè¡¨è¾¾å¼ï¼\n    0 * * * * ? \n    \n    \n    ç¹å»æ°å¢ä»»å¡ï¼å°ä»¥ä¸åé¡¹å¡«å®å°±å¯ä»¥äºã\n    \n    \n\n\n# 1.4 æ§è¡ä»»å¡\n\nå¯å¨é¡¹ç®ï¼å°ä»»å¡ç¶ææ¹ä¸º å¯å¨ã\n\n\n\nä¸å±æ§è¡äºä¸æ¬¡~ å¯ä»¥çå°å®çç²¾ååº¦è¿æ¯è®é«çï¼\n\nå¥½äºï¼ç°å¨ä½ å¯ä»¥å»webçé¢å°è¿ä¸ªä»»å¡åæ­¢ï¼æèä½ å¯ä»¥ççè¿ä¸ªä»»å¡çå¶ä»ä¿¡æ¯\n\n\n# 2. æ¥å¿è®°å½\n\nä¸ºä»ä¹å°å®ä½ä¸ºåç¬ä¸ä¸ªç« èï¼å ä¸º xxl-job çæ¥å¿æ¯å¾å¤äººå°æ°&ç¦èºçå°æ¹ï¼å ä¸ºæ¯ä¸ä¸ªä»»å¡çæ¯ä¸æ¬¡æ§è¡é½å¯¹åºä¸ä¸ªæ¥å¿æä»¶ï¼å¦æä¸ä¸ªä»»å¡æ¯5sæ§è¡ä¸æ¬¡ï¼é£ä¹è¿ä¸ªä»»å¡ä¸å¤©å°±å¯ä»¥äº§åº 24 * 60 * 60 / 5 = 17280 ä¸ªæ¥å¿æä»¶ï¼åè®¾è¿ä¸ªä»»å¡å¨é¨æåï¼ä¸ä¸ªæä»¶åªæ1kbï¼é£å°±æ¯16Mã\n\nç°å¨æä»¬æ¥ççæ¥å¿é½è®°å½äºä»ä¹ï¼å¹¶ä¸å¨ä»£ç ä¸­å¦ä½å°éè¦ä¿¡æ¯è®°å½å° Xxl-Job çæ¥å¿æä»¶ä¸­ã\n\næ³çæ¥å¿å°±è¦ç¥éæ¥å¿å¨åªï¼æä»¬éè¿éç½®ï¼è®© xxl-job å¨æ¡é¢çææ¥å¿;\n\nxxl.job.executor.logpath=C:/Users/23825/Desktop/xxl-job/jobhandler\n\n\næªæ¥ææ³çæ¥å¿ï¼å°±å¯ä»¥å» C:/Users/23825/Desktop/xxl-job/jobhandler æ¥æ¾\n\nXxl-Job æä¾äºä¸ä¸ªå·¥å·ç±» ï¼XxlJobHelperï¼ä½¿ç¨ XxlJobHelper.log() å°±å¯ä»¥è®°å½æ¥å¿å°æä»¶ä¸­ã\n\n@Component\npublic class XxlJobHandler {\n    private static final Logger logger = LoggerFactory.getLogger(XxlJobHandler.class);\n    @XxlJob("checkStore")\n    public void check() {\n        logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n        int store = new Random().nextInt(3);\n        XxlJobHelper.log("æ£æ¥åºå­ï¼åºå­ä½é: {}", store);\n        if (store <= 0) {\n            System.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n        }\n        logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n    }\n}\n\n\nä¸è¿°ä»£ç ï¼æ¯æ¬¡æ£æ¥åºåºå­ä¹åé½å°åºå­è®°å½å°æ¥å¿ä¸­ï¼å¯å¨é¡¹ç®ï¼è¿è¡ä»»å¡\n\nå¥½äºï¼å¨æ§è¡å åéåï¼ä½ å¨æ¡é¢ä¼çå°å¦ä¸æä»¶å¤¹ï¼C:\\Users\\23825\\Desktop\\xxl-job\\jobhandler\\2023-11-19\n\nå¯ä»¥çæµ xxl-job ä¼ä¸ºæ¯ä¸å¤©åå»ºä¸ä¸ªæä»¶å¤¹ï¼æ¯ä¸æ¬¡æ§è¡ä»»å¡åå»ºä¸ä¸ªæä»¶ã\n\néä¾¿æå¼ä¸ä¸ªæ¥å¿æä»¶ï¼\n\n2023-11-19 22:52:00 [com.xxl.job.core.thread.JobThread#run]-[133]-[xxl-job, JobThread-2-1700405520094] <br>----------- xxl-job job execute start -----------<br>----------- Param:\n2023-11-19 22:52:00 [com.xiaohe.mailtest.job.XxlJobHandler#check]-[23]-[xxl-job, JobThread-2-1700405520094] æ£æ¥åºå­ï¼åºå­ä½é: 0\n2023-11-19 22:52:00 [com.xxl.job.core.thread.JobThread#run]-[179]-[xxl-job, JobThread-2-1700405520094] <br>----------- xxl-job job execute end(finish) -----------<br>----------- Result: handleCode=200, handleMsg = null\n2023-11-19 22:52:00 [com.xxl.job.core.thread.TriggerCallbackThread#callbackLog]-[197]-[xxl-job, executor TriggerCallbackThread] <br>----------- xxl-job job callback finish.\n\n\næ¥å¿å±æåé¨å\n\n 1. å¼å§æ§è¡çä¿¡æ¯ ï¼è´è´£æ§è¡ççº¿ç¨ç¼å·\n 2. ç¨åºåæå°çä¿¡æ¯ ï¼å®æ¶ä»»å¡çå¨éå®ç±»å+æ¹æ³åãè´è´£æ§è¡ççº¿ç¨ç¼å·ãèªå®ä¹çæ¥å¿ä¿¡æ¯\n 3. æ§è¡ç»æçä¿¡æ¯ ï¼æ§è¡çç»æ\n 4. åè°ä¿¡æ¯ ï¼æ§è¡å¨å°æ§è¡ç»æäº¤ç»è°åº¦ä¸­å¿\n\nå¦æä»¥åæ§è¡çæ¶ååºç°ä»ä¹bugå°±å¯ä»¥å¾æ¥å¿éé¢è®°å½ã\n\n\n# 3. åºå®éçæ§è¡\n\nåæçç®åä»»å¡æ¯å®æ¶æ§è¡ï¼æ¯ä¸åéæ§è¡ä¸æ¬¡ãç°å¨æ¥è¯è¯åºå®éçæ§è¡ï¼æä»¬å°éçè®¾ç½®ä¸ºæ¯60sæ§è¡ä¸æ¬¡ã\n\næ§è¡ä¹åçæ¥å¿æå°±ä¸åè´´äºã\n\n\n# 4. æ§è¡ä»»å¡åæ°\n\nXxl-Jobçå®æ¶ä»»å¡å¯ä»¥æå®åæ°ï¼è¿ä¸ªåæ°ä½¿ç¨ XxlJobHelper.getJobParam()è·åãè·åçæ¯ä¸æ´ä¸ªå­ç¬¦ä¸²ï¼ä½ éè¦å¨èªå·±çä»£ç ä¸­åå²è¿ä¸ªå­ç¬¦ä¸²è·å¾ä½ æ³è¦çåæ°ï¼\n\n@XxlJob("checkStore")\npublic void check() {\n    String jobParam = XxlJobHelper.getJobParam();\n    System.out.println("å®æ¶ä»»å¡çåæ°: " + jobParam);\n\n    logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n    int store = new Random().nextInt(3);\n    XxlJobHelper.log("æ£æ¥åºå­ï¼åºå­ä½é: {}", store);\n    if (store <= 0) {\n        System.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n    }\n    logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n}\n\n\n\n\n\n# 5. ä»»å¡è¶æ¶æ¶é´\n\nå¦æå¯¹ä»»å¡çæ§è¡æ¶é´æè¦æ±ï¼è¿å¯ä»¥è®¾ç½®ä»»å¡çæå¤§æ§è¡æ¶é´ï¼ä¹å°±æ¯ä»»å¡è¶æ¶æ¶é´\n\npublic void check() throws InterruptedException {\n    String jobParam = XxlJobHelper.getJobParam();\n    System.out.println("å®æ¶ä»»å¡çåæ°: " + jobParam);\n\n    Thread.sleep(5 * 1000);\n\n    logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n    int store = new Random().nextInt(3);\n    XxlJobHelper.log("æ£æ¥åºå­ï¼åºå­ä½é: {}", store);\n    if (store <= 0) {\n        System.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n    }\n    logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n}\n\n\næç»ä»»å¡è®¾ç½®çè¶æ¶æ¶é´æ¯3sï¼å¨ä»»å¡ä¸­ç¡äº5sï¼é£ä¹ä»»å¡ä¸å®ä¼è¶æ¶ã\n\n\n\nå¯ä»¥çå°ï¼è¿åææ¯ä¸¤æ¬¡æ§è¡ï¼ä½æ¯é½æ²¡ææ§è¡å° Thread.sleep() åé¢çä¸å¤§æ®µä»£ç \n\næå¼æ­¤ä»»å¡çè°åº¦æ¥å¿ï¼\n\n',normalizedContent:'# 0. åè¨\n\nä¸ä¸ç« å¸¦å¤§å®¶å®è£äº xxl-jobï¼ä¸è½½åºæ¥æºç ä¸å±ä¸ä¸ªå¤§æ¨¡åï¼\n\n- xxl-job-admin\n- xxl-job-core\n- xxl-job-executor-sample\n  - xxl-job-executor-sample-frameless\n  - xxl-job-executor-sample-springboot\n\n\n * xxl-job-admin ï¼è°åº¦ä¸­å¿\n * xxl-job-core ï¼æ ¸å¿ç±»ï¼å¶ä¸­æè°åº¦ä¸­å¿éè¦çåè½åæ§è¡å¨éè¦çææåè½ã\n * xxl-job-executor-sample ï¼xxl-jobæä¾çå®ä¾ï¼ææ æ¡æ¶çæ¬ãæ´åspringççæ¬\n\n\n# 1. ç®åä»»å¡çæ§è¡\n\nxxl-job æä¾äºä¸ä¸ªæ³¨è§£ @xxljobæ æ³¨å®æ¶ä»»å¡ï¼æä»¬åªéè¦å®ä¹ä¸ä¸ªbeanå¯¹è±¡ï¼å¨æ¹æ³ä¸å ä¸ @xxljobæ³¨è§£ï¼è¿ä¸ªæ¹æ³å°±æä¸ºå®æ¶ä»»å¡æ¹æ³äºã\n\n@target({elementtype.method})\n@retention(retentionpolicy.runtime)\n@inherited\npublic @interface xxljob {\n    string value();\n\n    string init() default "";\n\n    string destroy() default "";\n}\n\n\nå¯ä»¥çå° @xxljobåªè½æå®å®æ¶ä»»å¡çæ¹æ³åååå§åæ¹æ³ãéæ¯æ¹æ³ãä½æ¯ä¸ä¸ªå®æ¶ä»»å¡çå³é®åºè¯¥æ¯æ§è¡é¢çåï¼å¨åªéæå®å¢ï¼å¨webæ§å¶å°æå®ã\n\n\n\n###1.1 æ·»å ä¾èµ\n\nä¸å®è¦è·ä¸è½½ç xxl-job çæ¬ä¸è´ ï¼\n\n\x3c!-- xxl-job-core --\x3e\n<dependency>\n    <groupid>com.xuxueli</groupid>\n    <artifactid>xxl-job-core</artifactid>\n    <version>2.4.0</version>\n</dependency>\n\n\n\n# 1.2 æ·»å éç½®\n\n# web port\nserver.port=3999\n# no web\n#spring.main.web-environment=false\n\n# log config\nlogging.config=classpath:logback.xml\n\n\n### xxl-job admin address list, such as "http://address" or "http://address01,http://address02"\nxxl.job.admin.addresses=http://127.0.0.1:8080/xxl-job-admin\n\n### xxl-job, access token\nxxl.job.accesstoken=default_token\n\n### xxl-job executor appname\nxxl.job.executor.appname=xxl-job-executor-sample\n### xxl-job executor registry-address: default use address to registry , otherwise use ip:port if address is null\nxxl.job.executor.address=\n### xxl-job executor server-info\nxxl.job.executor.ip=\nxxl.job.executor.port=9999\n### xxl-job executor log-path\nxxl.job.executor.logpath=/data/applogs/xxl-job/jobhandler\n### xxl-job executor log-retention-days\nxxl.job.executor.logretentiondays=30\n\n\nå¯¹äºï¼logging.config è¿ä¸ªæ¥å¿éç½® logback.xml ä½ å¦ææ²¡æçè¯å¯ä»¥æ xxl-job-executor-sample-springboot éçéç½®æ¿è¿æ¥ã\n\n\n@configuration\npublic class xxljobconfig {\n    private logger logger = loggerfactory.getlogger(xxljobconfig.class);\n    @value("${xxl.job.admin.addresses}")\n    private string adminaddresses;\n    @value("${xxl.job.accesstoken}")\n    private string accesstoken;\n    @value("${xxl.job.executor.appname}")\n    private string appname;\n    @value("${xxl.job.executor.port}")\n    private int port;\n    @value("${xxl.job.executor.logpath}")\n    private string logpath;\n    @value("${xxl.job.executor.logretentiondays}")\n    private int logretentiondays;\n\n    @bean\n    public xxljobspringexecutor xxljobexecutor() {\n        logger.info(">>>>>>>>>>> xxl-job config init.");\n        xxljobspringexecutor xxljobspringexecutor = new xxljobspringexecutor();\n        xxljobspringexecutor.setadminaddresses(adminaddresses);\n        xxljobspringexecutor.setappname(appname);\n        // çç¥ ip å address çéç½®\n        xxljobspringexecutor.setport(port);\n        xxljobspringexecutor.setaccesstoken(accesstoken);\n        xxljobspringexecutor.setlogpath(logpath);\n        xxljobspringexecutor.setlogretentiondays(logretentiondays);\n\n        return xxljobspringexecutor;\n    }\n}\n\n\n\n# 1.3 æ·»å ä»»å¡\n\nxxl-jobä¸springbootæ´åæ¶\n\n 1. åä»£ç \n    \n    åå¦æä»¬æä¸ä¸ªéæ± ï¼æ¯åéæ£æ¥ååçåºå­æ¯å¦è¶³å¤ï¼å¦æä¸å¤å°±æéåå®¶æ·»å åºå­ã\n    \n    å¨ä»£ç ä¸­åªæ¯å®æä»»å¡ ï¼\n    \n    import com.xxl.job.core.handler.annotation.xxljob;\n    import org.slf4j.logger;\n    import org.slf4j.loggerfactory;\n    import org.springframework.stereotype.component;\n    \n    import java.util.random;\n    \n    @component\n    public class xxljobhandler {\n        private static final logger logger = loggerfactory.getlogger(xxljobhandler.class);\n        @xxljob("checkstore")\n        public void check() {\n            logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n            system.out.println("æ£æ¥åºå­");\n            int store = new random().nextint(3);\n            if (store <= 0) {\n                system.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n            }\n            system.out.println("æ£æ¥å®æ¯");\n            logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n        }\n    }\n    \n\n 2. éç½®ä»»å¡\n    \n    æå¼webæ§å¶å°ï¼å¶ä»çæä»¬ä¸æä¹ä¸å¨ï¼ä½æ¯è¦ææ§è¡é¢çæ¹äº\n    \n    -- æ¯åéæå®çcornè¡¨è¾¾å¼ï¼\n    0 * * * * ? \n    \n    \n    ç¹å»æ°å¢ä»»å¡ï¼å°ä»¥ä¸åé¡¹å¡«å®å°±å¯ä»¥äºã\n    \n    \n\n\n# 1.4 æ§è¡ä»»å¡\n\nå¯å¨é¡¹ç®ï¼å°ä»»å¡ç¶ææ¹ä¸º å¯å¨ã\n\n\n\nä¸å±æ§è¡äºä¸æ¬¡~ å¯ä»¥çå°å®çç²¾ååº¦è¿æ¯è®é«çï¼\n\nå¥½äºï¼ç°å¨ä½ å¯ä»¥å»webçé¢å°è¿ä¸ªä»»å¡åæ­¢ï¼æèä½ å¯ä»¥ççè¿ä¸ªä»»å¡çå¶ä»ä¿¡æ¯\n\n\n# 2. æ¥å¿è®°å½\n\nä¸ºä»ä¹å°å®ä½ä¸ºåç¬ä¸ä¸ªç« èï¼å ä¸º xxl-job çæ¥å¿æ¯å¾å¤äººå°æ°&ç¦èºçå°æ¹ï¼å ä¸ºæ¯ä¸ä¸ªä»»å¡çæ¯ä¸æ¬¡æ§è¡é½å¯¹åºä¸ä¸ªæ¥å¿æä»¶ï¼å¦æä¸ä¸ªä»»å¡æ¯5sæ§è¡ä¸æ¬¡ï¼é£ä¹è¿ä¸ªä»»å¡ä¸å¤©å°±å¯ä»¥äº§åº 24 * 60 * 60 / 5 = 17280 ä¸ªæ¥å¿æä»¶ï¼åè®¾è¿ä¸ªä»»å¡å¨é¨æåï¼ä¸ä¸ªæä»¶åªæ1kbï¼é£å°±æ¯16mã\n\nç°å¨æä»¬æ¥ççæ¥å¿é½è®°å½äºä»ä¹ï¼å¹¶ä¸å¨ä»£ç ä¸­å¦ä½å°éè¦ä¿¡æ¯è®°å½å° xxl-job çæ¥å¿æä»¶ä¸­ã\n\næ³çæ¥å¿å°±è¦ç¥éæ¥å¿å¨åªï¼æä»¬éè¿éç½®ï¼è®© xxl-job å¨æ¡é¢çææ¥å¿;\n\nxxl.job.executor.logpath=c:/users/23825/desktop/xxl-job/jobhandler\n\n\næªæ¥ææ³çæ¥å¿ï¼å°±å¯ä»¥å» c:/users/23825/desktop/xxl-job/jobhandler æ¥æ¾\n\nxxl-job æä¾äºä¸ä¸ªå·¥å·ç±» ï¼xxljobhelperï¼ä½¿ç¨ xxljobhelper.log() å°±å¯ä»¥è®°å½æ¥å¿å°æä»¶ä¸­ã\n\n@component\npublic class xxljobhandler {\n    private static final logger logger = loggerfactory.getlogger(xxljobhandler.class);\n    @xxljob("checkstore")\n    public void check() {\n        logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n        int store = new random().nextint(3);\n        xxljobhelper.log("æ£æ¥åºå­ï¼åºå­ä½é: {}", store);\n        if (store <= 0) {\n            system.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n        }\n        logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n    }\n}\n\n\nä¸è¿°ä»£ç ï¼æ¯æ¬¡æ£æ¥åºåºå­ä¹åé½å°åºå­è®°å½å°æ¥å¿ä¸­ï¼å¯å¨é¡¹ç®ï¼è¿è¡ä»»å¡\n\nå¥½äºï¼å¨æ§è¡å åéåï¼ä½ å¨æ¡é¢ä¼çå°å¦ä¸æä»¶å¤¹ï¼c:\\users\\23825\\desktop\\xxl-job\\jobhandler\\2023-11-19\n\nå¯ä»¥çæµ xxl-job ä¼ä¸ºæ¯ä¸å¤©åå»ºä¸ä¸ªæä»¶å¤¹ï¼æ¯ä¸æ¬¡æ§è¡ä»»å¡åå»ºä¸ä¸ªæä»¶ã\n\néä¾¿æå¼ä¸ä¸ªæ¥å¿æä»¶ï¼\n\n2023-11-19 22:52:00 [com.xxl.job.core.thread.jobthread#run]-[133]-[xxl-job, jobthread-2-1700405520094] <br>----------- xxl-job job execute start -----------<br>----------- param:\n2023-11-19 22:52:00 [com.xiaohe.mailtest.job.xxljobhandler#check]-[23]-[xxl-job, jobthread-2-1700405520094] æ£æ¥åºå­ï¼åºå­ä½é: 0\n2023-11-19 22:52:00 [com.xxl.job.core.thread.jobthread#run]-[179]-[xxl-job, jobthread-2-1700405520094] <br>----------- xxl-job job execute end(finish) -----------<br>----------- result: handlecode=200, handlemsg = null\n2023-11-19 22:52:00 [com.xxl.job.core.thread.triggercallbackthread#callbacklog]-[197]-[xxl-job, executor triggercallbackthread] <br>----------- xxl-job job callback finish.\n\n\næ¥å¿å±æåé¨å\n\n 1. å¼å§æ§è¡çä¿¡æ¯ ï¼è´è´£æ§è¡ççº¿ç¨ç¼å·\n 2. ç¨åºåæå°çä¿¡æ¯ ï¼å®æ¶ä»»å¡çå¨éå®ç±»å+æ¹æ³åãè´è´£æ§è¡ççº¿ç¨ç¼å·ãèªå®ä¹çæ¥å¿ä¿¡æ¯\n 3. æ§è¡ç»æçä¿¡æ¯ ï¼æ§è¡çç»æ\n 4. åè°ä¿¡æ¯ ï¼æ§è¡å¨å°æ§è¡ç»æäº¤ç»è°åº¦ä¸­å¿\n\nå¦æä»¥åæ§è¡çæ¶ååºç°ä»ä¹bugå°±å¯ä»¥å¾æ¥å¿éé¢è®°å½ã\n\n\n# 3. åºå®éçæ§è¡\n\nåæçç®åä»»å¡æ¯å®æ¶æ§è¡ï¼æ¯ä¸åéæ§è¡ä¸æ¬¡ãç°å¨æ¥è¯è¯åºå®éçæ§è¡ï¼æä»¬å°éçè®¾ç½®ä¸ºæ¯60sæ§è¡ä¸æ¬¡ã\n\næ§è¡ä¹åçæ¥å¿æå°±ä¸åè´´äºã\n\n\n# 4. æ§è¡ä»»å¡åæ°\n\nxxl-jobçå®æ¶ä»»å¡å¯ä»¥æå®åæ°ï¼è¿ä¸ªåæ°ä½¿ç¨ xxljobhelper.getjobparam()è·åãè·åçæ¯ä¸æ´ä¸ªå­ç¬¦ä¸²ï¼ä½ éè¦å¨èªå·±çä»£ç ä¸­åå²è¿ä¸ªå­ç¬¦ä¸²è·å¾ä½ æ³è¦çåæ°ï¼\n\n@xxljob("checkstore")\npublic void check() {\n    string jobparam = xxljobhelper.getjobparam();\n    system.out.println("å®æ¶ä»»å¡çåæ°: " + jobparam);\n\n    logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n    int store = new random().nextint(3);\n    xxljobhelper.log("æ£æ¥åºå­ï¼åºå­ä½é: {}", store);\n    if (store <= 0) {\n        system.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n    }\n    logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n}\n\n\n\n\n\n# 5. ä»»å¡è¶æ¶æ¶é´\n\nå¦æå¯¹ä»»å¡çæ§è¡æ¶é´æè¦æ±ï¼è¿å¯ä»¥è®¾ç½®ä»»å¡çæå¤§æ§è¡æ¶é´ï¼ä¹å°±æ¯ä»»å¡è¶æ¶æ¶é´\n\npublic void check() throws interruptedexception {\n    string jobparam = xxljobhelper.getjobparam();\n    system.out.println("å®æ¶ä»»å¡çåæ°: " + jobparam);\n\n    thread.sleep(5 * 1000);\n\n    logger.info("å¼å§æ§è¡å®æ¶ä»»å¡");\n    int store = new random().nextint(3);\n    xxljobhelper.log("æ£æ¥åºå­ï¼åºå­ä½é: {}", store);\n    if (store <= 0) {\n        system.out.println("ä¸è¥¿åçå¤ªå¿«äºï¼å¿«æ·»å åºå­");\n    }\n    logger.info("å®æ¶ä»»å¡æ§è¡å®æ¯");\n}\n\n\næç»ä»»å¡è®¾ç½®çè¶æ¶æ¶é´æ¯3sï¼å¨ä»»å¡ä¸­ç¡äº5sï¼é£ä¹ä»»å¡ä¸å®ä¼è¶æ¶ã\n\n\n\nå¯ä»¥çå°ï¼è¿åææ¯ä¸¤æ¬¡æ§è¡ï¼ä½æ¯é½æ²¡ææ§è¡å° thread.sleep() åé¢çä¸å¤§æ®µä»£ç \n\næå¼æ­¤ä»»å¡çè°åº¦æ¥å¿ï¼\n\n',charsets:{cjk:!0},lastUpdated:"2023/11/20, 13:00:13",lastUpdatedTimestamp:1700456413e3},{title:"1. XXL-JOBçå®è£",frontmatter:{title:"1. XXL-JOBçå®è£",date:"2023-11-20T12:56:32.000Z",permalink:"/pages/bb013b/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/100.XXL-JOB/1.XXL-JOB%E7%9A%84%E5%AE%89%E8%A3%85.html",relativePath:"02.æç« /91.æ¡æ¶/100.XXL-JOB/1.XXL-JOBçå®è£.md",key:"v-49c73577",path:"/pages/bb013b/",headers:[{level:2,title:"1. ä¸è½½",slug:"_1-ä¸è½½",normalizedTitle:"1. ä¸è½½",charIndex:2},{level:2,title:"2. å¯¼å¥SQL",slug:"_2-å¯¼å¥sql",normalizedTitle:"2. å¯¼å¥sql",charIndex:230},{level:2,title:"3. ä¿®æ¹éç½®æä»¶",slug:"_3-ä¿®æ¹éç½®æä»¶",normalizedTitle:"3. ä¿®æ¹éç½®æä»¶",charIndex:504},{level:2,title:"4. å¯å¨",slug:"_4-å¯å¨",normalizedTitle:"4. å¯å¨",charIndex:1352},{level:2,title:"5. æ§è¡å®ä¾",slug:"_5-æ§è¡å®ä¾",normalizedTitle:"5. æ§è¡å®ä¾",charIndex:1700}],headersStr:"1. ä¸è½½ 2. å¯¼å¥SQL 3. ä¿®æ¹éç½®æä»¶ 4. å¯å¨ 5. æ§è¡å®ä¾",content:'# 1. ä¸è½½\n\nXXL-JOBå®ç½ ï¼https://www.xuxueli.com/xxl-job/\n\nXXL-JOBæºç  ï¼\n\n * Gitee ï¼https://gitee.com/xuxueli0323/xxl-job\n * Github ï¼https://github.com/xuxueli/xxl-job/\n\nå°½éå»Giteeä¸è½½å§ï¼è¿æ ·å¿«ä¸ç¹ã\n\næ³¨æçæ¬å¦ï¼ä¸è½½ 2.4.0 æè 2.4.1 çï¼ä¸è¦ä¸è½½ 2.2.0 æä¹åçã\n\n\n# 2. å¯¼å¥SQL\n\nä»»å¡æ¯éè¦è®°å½çï¼æä»¥ XXL-JOB ä½ä¸ºä¸ä¸ª SpringBoot é¡¹ç®æ¯éè¦MySQLæ°æ®åºçå¨ä»¥ä¸ç®å½ä¸­æ¾å°SQLè¯­å¥ï¼\n\nxxl-job-master\\xxl-job-master\\doc\\db\\tables_xxl_job.sql\n\nå¨æ°æ®åºä¸­æ§è¡ï¼ä¸å±æå«å¼ è¡¨ï¼\n\nè¡¨å\nxxl_job_group\nxxl_job_info\nxxl_job_lock\nxxl_job_log\nxxl_job_log_report\nxxl_job_logglue\nxxl_job_registry\nxxl_job_user\n\n\n# 3. ä¿®æ¹éç½®æä»¶\n\næ¾å° xxl-job-admin é¡¹ç®ï¼ä¿®æ¹å®ç application.properties éç½®æä»¶\n\n 1. ä¿®æ¹æ°æ®æº ãå¿åã\n    \n    é¦åè¦å°æ°æ®åºæ¹ææä»¬ä¸è¿°å¯¼å¥çæ°æ®\n    \n    ### xxl-job, datasource\n    spring.datasource.url=jdbc:mysql://127.0.0.1:3309/xxl_job?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=Asia/Shanghai\n    spring.datasource.username=root\n    spring.datasource.password=1234\n    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver\n    \n\n 2. ä¿®æ¹æ¥å¿æä»¶ ãéåã\n    \n    è¿ä¸ªæ¶åå°è°åº¦ä¸­å¿ä¸æ§è¡å¨äºï¼ä½ å¯ä»¥ä¸å¿éç½®è¿ä¸å¤ä¸è¥¿ã\n    \n    ä¸ä¸ªé¡¹ç®çæ¥å¿æ¯éå¸¸éè¦çï¼å¨ xxl-job ä¸­ï¼æ¯ä¸å¤©å¯¹åºä¸ä¸ªæä»¶å¤¹ï¼è¿ä¸å¤©æ¯ä¸æ¬¡æ§è¡çä»»å¡é½å¯¹åºä¸ä¸ªæä»¶ï¼æä»¥ xxl-job æ¥å¿çä½ééå¸¸å¤§ãå¨éç½®æä»¶ä¸­ï¼xxl-job é»è®¤å¨Cçåå»ºæ¥å¿ï¼ä½ å¯ä»¥å°å®æ¾å¨æ¯è¾æ¾ç¼çä½ç½®ï¼å¨åé¢è®² xxl-job æ¥å¿ä½ç³»çæ¶åæ´å®¹ææ¾å°ã\n    \n    å¨ xxl-job-executor é¡¹ç®ä¸­æä¸ä¸ªå­é¡¹ç®ï¼xxl-job-executor-sample-springboot ç application.properties\n    \n    ### xxl-job executor log-path\n    xxl.job.executor.logpath=/data/applogs/xxl-job/jobhandler\n    \n\n\n# 4. å¯å¨\n\nå¦æä½ å·²ç»æ´æ¹å¥½äºä¸è¿°çéç½®æä»¶ï¼ç°å¨å°±å¯ä»¥è¿è¡xxl-job-adminäºï¼æ¾å° XxlJobAdminApplication å¯å¨ç±»ï¼ç¹å»è¿è¡åï¼\n\n20:27:40.009 logback [xxl-job, admin JobScheduleHelper#scheduleThread] INFO  c.x.j.a.c.thread.JobScheduleHelper - >>>>>>>>> init xxl-job admin scheduler success.\n\n\næ¾ç¤ºè¿ä¸ªç®æ¯è¿è¡æåï¼ç°å¨ä½ å¯ä»¥ç»å½webçé¢ï¼http://localhost:8080/xxl-job-admin\n\nç¨æ·å ï¼admin\n\nå¯ç  ï¼123456\n\nç»éæåçé¢ ï¼\n\n\n\n\n# 5. æ§è¡å®ä¾\n\nå¾å¤å¼æºé¡¹ç®é½æä¾äºexampleï¼xxl-jobä¹ä¸ä¾å¤ï¼å¨ xxl-job-executor é¡¹ç®ä¸­æä¸ä¸ªå­é¡¹ç®ï¼xxl-job-executor-sample-springboot å°±æ¯éæäºSpringBoot çå®ä¾ï¼æå¼å®ï¼è¿è¡ã\n\n20:36:01.962 logback [Thread-8] INFO  com.xxl.job.core.server.EmbedServer - >>>>>>>>>>> xxl-job remoting server start success, nettype = class com.xxl.job.core.server.EmbedServer, port = 9999\n\n\nåºç°è¿ä¸ªå°±æ¯è¿è¡æåäºã\n\nç°å¨æä¸¤ä¸ªè¿ç¨å¯å¨äºï¼\n\n\n\n * XxlJobAdminApplication ï¼è°åº¦ä¸­å¿\n * XxlJobExecutorApplication ï¼æ§è¡å¨\n\nå®ä¾çè·¯å¾ï¼com/xxl/job/executor/service/jobhandler/SampleXxlJob.java\n\næå¼åçå°ä¸ä¸ªç¤ºä¾ä»»å¡\n\n@Component\npublic class SampleXxlJob {\n    private static Logger logger = LoggerFactory.getLogger(SampleXxlJob.class);\n\n\n    /**\n     * 1ãç®åä»»å¡ç¤ºä¾ï¼Beanæ¨¡å¼ï¼\n     */\n    @XxlJob("demoJobHandler")\n    public void demoJobHandler() throws Exception {\n        System.out.println("ç®åä»»å¡å®ä¾æ§è¡äº");\n        // default success\n    }\n    \n    // ...çç¥å¶ä»çä»»å¡\n}\n\n\næä»¬æ³è¦è®©è¿ä¸ªä»»å¡è¿è¡è¯¥æä¹åï¼æå¼webçé¢ -> ä»»å¡ç®¡ç -> æµè¯ä»»å¡ä¸ -> æä½ -> æ§è¡ä¸æ¬¡ã\n\n\n\näºæ¯ï¼XxlJobExecutorApplication çæ§å¶å°å°±ä¼åºç° ï¼\n\nç®åä»»å¡å®ä¾æ§è¡äº\n',normalizedContent:'# 1. ä¸è½½\n\nxxl-jobå®ç½ ï¼https://www.xuxueli.com/xxl-job/\n\nxxl-jobæºç  ï¼\n\n * gitee ï¼https://gitee.com/xuxueli0323/xxl-job\n * github ï¼https://github.com/xuxueli/xxl-job/\n\nå°½éå»giteeä¸è½½å§ï¼è¿æ ·å¿«ä¸ç¹ã\n\næ³¨æçæ¬å¦ï¼ä¸è½½ 2.4.0 æè 2.4.1 çï¼ä¸è¦ä¸è½½ 2.2.0 æä¹åçã\n\n\n# 2. å¯¼å¥sql\n\nä»»å¡æ¯éè¦è®°å½çï¼æä»¥ xxl-job ä½ä¸ºä¸ä¸ª springboot é¡¹ç®æ¯éè¦mysqlæ°æ®åºçå¨ä»¥ä¸ç®å½ä¸­æ¾å°sqlè¯­å¥ï¼\n\nxxl-job-master\\xxl-job-master\\doc\\db\\tables_xxl_job.sql\n\nå¨æ°æ®åºä¸­æ§è¡ï¼ä¸å±æå«å¼ è¡¨ï¼\n\nè¡¨å\nxxl_job_group\nxxl_job_info\nxxl_job_lock\nxxl_job_log\nxxl_job_log_report\nxxl_job_logglue\nxxl_job_registry\nxxl_job_user\n\n\n# 3. ä¿®æ¹éç½®æä»¶\n\næ¾å° xxl-job-admin é¡¹ç®ï¼ä¿®æ¹å®ç application.properties éç½®æä»¶\n\n 1. ä¿®æ¹æ°æ®æº ãå¿åã\n    \n    é¦åè¦å°æ°æ®åºæ¹ææä»¬ä¸è¿°å¯¼å¥çæ°æ®\n    \n    ### xxl-job, datasource\n    spring.datasource.url=jdbc:mysql://127.0.0.1:3309/xxl_job?useunicode=true&characterencoding=utf-8&autoreconnect=true&servertimezone=asia/shanghai\n    spring.datasource.username=root\n    spring.datasource.password=1234\n    spring.datasource.driver-class-name=com.mysql.cj.jdbc.driver\n    \n\n 2. ä¿®æ¹æ¥å¿æä»¶ ãéåã\n    \n    è¿ä¸ªæ¶åå°è°åº¦ä¸­å¿ä¸æ§è¡å¨äºï¼ä½ å¯ä»¥ä¸å¿éç½®è¿ä¸å¤ä¸è¥¿ã\n    \n    ä¸ä¸ªé¡¹ç®çæ¥å¿æ¯éå¸¸éè¦çï¼å¨ xxl-job ä¸­ï¼æ¯ä¸å¤©å¯¹åºä¸ä¸ªæä»¶å¤¹ï¼è¿ä¸å¤©æ¯ä¸æ¬¡æ§è¡çä»»å¡é½å¯¹åºä¸ä¸ªæä»¶ï¼æä»¥ xxl-job æ¥å¿çä½ééå¸¸å¤§ãå¨éç½®æä»¶ä¸­ï¼xxl-job é»è®¤å¨cçåå»ºæ¥å¿ï¼ä½ å¯ä»¥å°å®æ¾å¨æ¯è¾æ¾ç¼çä½ç½®ï¼å¨åé¢è®² xxl-job æ¥å¿ä½ç³»çæ¶åæ´å®¹ææ¾å°ã\n    \n    å¨ xxl-job-executor é¡¹ç®ä¸­æä¸ä¸ªå­é¡¹ç®ï¼xxl-job-executor-sample-springboot ç application.properties\n    \n    ### xxl-job executor log-path\n    xxl.job.executor.logpath=/data/applogs/xxl-job/jobhandler\n    \n\n\n# 4. å¯å¨\n\nå¦æä½ å·²ç»æ´æ¹å¥½äºä¸è¿°çéç½®æä»¶ï¼ç°å¨å°±å¯ä»¥è¿è¡xxl-job-adminäºï¼æ¾å° xxljobadminapplication å¯å¨ç±»ï¼ç¹å»è¿è¡åï¼\n\n20:27:40.009 logback [xxl-job, admin jobschedulehelper#schedulethread] info  c.x.j.a.c.thread.jobschedulehelper - >>>>>>>>> init xxl-job admin scheduler success.\n\n\næ¾ç¤ºè¿ä¸ªç®æ¯è¿è¡æåï¼ç°å¨ä½ å¯ä»¥ç»å½webçé¢ï¼http://localhost:8080/xxl-job-admin\n\nç¨æ·å ï¼admin\n\nå¯ç  ï¼123456\n\nç»éæåçé¢ ï¼\n\n\n\n\n# 5. æ§è¡å®ä¾\n\nå¾å¤å¼æºé¡¹ç®é½æä¾äºexampleï¼xxl-jobä¹ä¸ä¾å¤ï¼å¨ xxl-job-executor é¡¹ç®ä¸­æä¸ä¸ªå­é¡¹ç®ï¼xxl-job-executor-sample-springboot å°±æ¯éæäºspringboot çå®ä¾ï¼æå¼å®ï¼è¿è¡ã\n\n20:36:01.962 logback [thread-8] info  com.xxl.job.core.server.embedserver - >>>>>>>>>>> xxl-job remoting server start success, nettype = class com.xxl.job.core.server.embedserver, port = 9999\n\n\nåºç°è¿ä¸ªå°±æ¯è¿è¡æåäºã\n\nç°å¨æä¸¤ä¸ªè¿ç¨å¯å¨äºï¼\n\n\n\n * xxljobadminapplication ï¼è°åº¦ä¸­å¿\n * xxljobexecutorapplication ï¼æ§è¡å¨\n\nå®ä¾çè·¯å¾ï¼com/xxl/job/executor/service/jobhandler/samplexxljob.java\n\næå¼åçå°ä¸ä¸ªç¤ºä¾ä»»å¡\n\n@component\npublic class samplexxljob {\n    private static logger logger = loggerfactory.getlogger(samplexxljob.class);\n\n\n    /**\n     * 1ãç®åä»»å¡ç¤ºä¾ï¼beanæ¨¡å¼ï¼\n     */\n    @xxljob("demojobhandler")\n    public void demojobhandler() throws exception {\n        system.out.println("ç®åä»»å¡å®ä¾æ§è¡äº");\n        // default success\n    }\n    \n    // ...çç¥å¶ä»çä»»å¡\n}\n\n\næä»¬æ³è¦è®©è¿ä¸ªä»»å¡è¿è¡è¯¥æä¹åï¼æå¼webçé¢ -> ä»»å¡ç®¡ç -> æµè¯ä»»å¡ä¸ -> æä½ -> æ§è¡ä¸æ¬¡ã\n\n\n\näºæ¯ï¼xxljobexecutorapplication çæ§å¶å°å°±ä¼åºç° ï¼\n\nç®åä»»å¡å®ä¾æ§è¡äº\n',charsets:{cjk:!0},lastUpdated:"2023/11/20, 13:00:13",lastUpdatedTimestamp:1700456413e3},{title:"XXL-JOBè´è½½åè¡¡ç­ç¥",frontmatter:{title:"XXL-JOBè´è½½åè¡¡ç­ç¥",date:"2023-08-17T17:41:45.000Z",permalink:"/pages/75326c/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/100.XXL-JOB/20.XXL-JOB%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5.html",relativePath:"02.æç« /91.æ¡æ¶/100.XXL-JOB/20.XXL-JOBè´è½½åè¡¡ç­ç¥.md",key:"v-2a546378",path:"/pages/75326c/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. éåç¬¬ä¸ä¸ªãæåä¸ä¸ª",slug:"_2-éåç¬¬ä¸ä¸ªãæåä¸ä¸ª",normalizedTitle:"2. éåç¬¬ä¸ä¸ªãæåä¸ä¸ª",charIndex:770},{level:2,title:"3. éæºéå",slug:"_3-éæºéå",normalizedTitle:"3. éæºéå",charIndex:623},{level:2,title:"4. è½®è¯¢",slug:"_4-è½®è¯¢",normalizedTitle:"4. è½®è¯¢",charIndex:632},{level:2,title:"5. LRU",slug:"_5-lru",normalizedTitle:"5. lru",charIndex:5464},{level:2,title:"6. LFU",slug:"_6-lfu",normalizedTitle:"6. lfu",charIndex:7745},{level:2,title:"7. hash",slug:"_7-hash",normalizedTitle:"7. hash",charIndex:671},{level:2,title:"8. å¿ç¢è½¬ç§»",slug:"_8-å¿ç¢è½¬ç§»",normalizedTitle:"8. å¿ç¢è½¬ç§»",charIndex:680},{level:2,title:"9. æéè½¬ç§»",slug:"_9-æéè½¬ç§»",normalizedTitle:"9. æéè½¬ç§»",charIndex:689}],headersStr:"1. ç®è¿° 2. éåç¬¬ä¸ä¸ªãæåä¸ä¸ª 3. éæºéå 4. è½®è¯¢ 5. LRU 6. LFU 7. hash 8. å¿ç¢è½¬ç§» 9. æéè½¬ç§»",content:'# 1. ç®è¿°\n\nç®æ³è¦æå¡äºä¸å¡æè½ä½ç°åºå®çä»·å¼ï¼ç®æ³åªæ¯æä¾äºæ´ä½ä¸çæè·¯ï¼è³äºå¦ä½å®ç°å®ï¼é£è¦çå·ä½çä¸å¡åºæ¯ï¼æä»¥æé¦åè¦ä»ç»ä¸ä¸ XXL-JOB ä½¿ç¨è´è½½åè¡¡ç­ç¥çèæ¯ ï¼ç±äºXXL-JOBçèªæå®ä½æ¯**åå¸å¼å®æ¶ä»»å¡æ¡æ¶ãæä»¥ä¸ä¸ªä»»å¡å¯è½é¨ç½²å¨å¤ä¸ªæå¡å¨ä¸ï¼ä½æ¯æä»¬åªæ³è¦ä¸ä¸ªæºå¨å¯ä»¥æ§è¡è¿ä¸ªä»»å¡**ãé£ä¹å¨æ§è¡çæ¶åå°±éè¦æéä¸ä¸ª IP å°åå»æ§è¡è¿ä¸ªä»»å¡ã\n\nXXL-JOB ä¸­ä½¿ç¨ç­ç¥è®¾è®¡æ¨¡å¼å®ç°è´è½½åè¡¡ç®æ³ï¼æºç å°åï¼XXL-JOBè´è½½åè¡¡ç­ç¥ã\n\né¦åæ¯é¡¶çº§æ¥å£ ï¼\n\npublic abstract class ExecutorRouter {\n\n    public abstract ReturnT<String> route(int jobId, \n                                          List<String> addressList);\n\n}\n\n\nææå®æ¹è£äºä¸ä¸ï¼route æ¹æ³çç¬¬ä¸ä¸ªåæ°å¨æºç ä¸­å¶å®å¹¶ä¸æ¯ jobIdï¼å®æ¯ä¸ä¸ªç±»ï¼ä½æ¯æç« çéç¹æ¯ä»ç»è´è½½åè¡¡ç®æ³ï¼æä»¥æ­¤å¤ç´æªäºå½ä½¿ç¨ jobIdãåä»ç»ä¸ä¸ä¸¤ä¸ªåæ°ï¼\n\n 1. jobId ï¼å®æ¶ä»»å¡çid\n 2. addressList ï¼è¯¥å®æ¶ä»»å¡å¯ä»¥è¢«è¿äº IP å°åæ§è¡ï¼ä½æ¯æä»¬è¦ä»ä¸­éåä¸ä¸ªã\n\nXXL-JOBä½¿ç¨çè´è½½åè¡¡ç­ç¥å±æ 9 ç§ï¼\n\n 1. éåç¬¬ä¸ä¸ª\n 2. éåæåä¸ä¸ª\n 3. éæºéå\n 4. è½®è¯¢\n 5. æè¿æå°ä½¿ç¨ï¼LRUï¼\n 6. æå°é¢çä½¿ç¨ï¼LFUï¼\n 7. hash\n 8. å¿ç¢è½¬ç§»\n 9. æéè½¬ç§»\n\nåä¸¤ç§å¤ªç®åäºï¼æ¾å¨ä¸èµ·ä»ç»ã\n\næåä¸¤ç§ç­ç¥å¶å®å°±å¾åä¸å¡äºï¼å¦æå¯¹XXL-JOBçäºè§£ä¸å¤çè¯å¯è½çä¸æï¼ä½æ¯æä¼å°½åå°å®åæç½ã\n\n\n# 2. éåç¬¬ä¸ä¸ªãæåä¸ä¸ª\n\nè¿ä¸¤ç§éå¸¸ç®åï¼æ¹æ³åæ°ä¸­å·²ç»æäº IPå°å éåï¼é£æä»¬ç´æ¥ list.get(0)ãlist.get(list.size() - 1) ä¸å°±è¡äºï¼\n\näºå®ä¸ XXL-JOB ç¡®å®æ¯è¿ä¹åçã\n\néåç¬¬ä¸ä¸ªï¼\n\npublic class ExecutorRouteFirst extends ExecutorRouter {\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList){\n        return new ReturnT<String>(addressList.get(0));\n    }\n\n}\n\n\néåæåä¸ä¸ª ï¼\n\npublic class ExecutorRouteLast extends ExecutorRouter {\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        return new ReturnT<String>(addressList.get(addressList.size()-1));\n    }\n\n}\n\n\næ¯ä¸æ¯å¾ç®åï¼æå°±ä¸åå¤è¯´äºåã\n\n\n# 3. éæºéå\n\nå¦æå¨ä¸ä¸ªéåä¸­éæºéåä¸ä¸ªæ°æ®ï¼ä½ ä¼æä¹åï¼çæä¸ä¸ªéæºæ°ï¼è¿ä¸ªéæºæ°çèå´ä¸ºï¼[0ï¼list.size() - 1]ãè¿æ ·ä¸å°±è¡äºåð\n\npublic class ExecutorRouteRandom extends ExecutorRouter {\n\n    private static Random localRandom = new Random();\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        String address = addressList.get(localRandom.nextInt(addressList.size()));\n        return new ReturnT<String>(address);\n    }\n\n}\n\n\n\n# 4. è½®è¯¢\n\nè¿ä¸ªå¬èµ·æ¥å¾å®¹æï¼ä½æ¯å®ç°çæ¶åéå¸¸ä¾èµäºä¸å¡ãXXL-JOBå¨å®ç°çæ¶åæ¯è¿æ ·åç ï¼å°ææå®æ¶ä»»å¡ä¸å®ä»¬å¯¹åºç IPå°å é½æ¾å¨ä¸ä¸ª Map ä¸­ç®¡çãä½æ¯å¦ä½è½®è¯¢å¢ï¼è¿æ ·æ²¡æåæ³è½®è¯¢åï¼æä»¬å¹¶ä¸ç¥éä¸ä¸æ¬¡è¯¥è°äºï¼æä»¥è¦æ¹åä¸ä¸æç»´ï¼æ¢ç¶å¨æ¹æ³åæ°ä¸­å·²ç»æäº IPå°å éåï¼é£ä¹å¯ä»¥å¨ Map ç value ä¸­è®°å½ï¼ä¸ä¸æ¬¡è¯¥ç¬¬å ä¸ªäºãæä»¥ Map ç key ä¸º å®æ¶ä»»å¡idï¼value ä¸º ä¸ä¸æ¬¡éè¦è½®è¯¢çä¸æ ã\n\nè¯´çæºç®åï¼æ¥çç xxl-job æ¯æä¹åçå§ï¼\n\npublic class ExecutorRouteRound extends ExecutorRouter {\n    // key : å®æ¶ä»»å¡id\n    // value : è¯¥idçå®æ¶ä»»å¡è½®è¯¢å°åªä¸ä¸ªä¸æ äºã\n    private static ConcurrentMap<Integer, AtomicInteger> routeCountEachJob \n        = new ConcurrentHashMap<>();\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        int count = count(jobId);\n        String address = addressList.get(count % addressList.size());\n        return new ReturnT<String>(address);\n    }\n    \n    // è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \n    private static int count(int jobId) {\n        AtomicInteger count = routeCountEachJob.get(jobId);\n        if (count == null || count.get() > 1000000) {\n            count = new AtomicInteger(0);\n        } else {\n            count.addAndGet(1);\n        }\n        routeCountEachJob.put(jobId, count);\n        return count.get();\n    }\n\n}\n\n\nä¸»è¦æ¯ count() æ¹æ³ï¼å®ä¼è·åæå®idçå®æ¶ä»»å¡è¯¥è½®è¯¢å°çä¸æ ã\n\n// è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \nprivate static int count(int jobId) {\n    AtomicInteger count = routeCountEachJob.get(jobId);\n    if (count == null) {\n        count = new AtomicInteger(0);\n    } else {\n        count.addAndGet(1);\n    }\n    routeCountEachJob.put(jobId, count);\n    return count.get();\n}\n\n\nå¦ææ­¤ å®æ¶ä»»å¡id å¨ Map ä¸­ä¸å­å¨ï¼é£å°±æ°å»ºä¸ä¸ªï¼å¹¶å°è½®è¯¢ä¸æ åå§åä¸º 0ï¼å¦æå·²ç»å­å¨å°±å°è½®è¯¢ä¸æ å ä¸ï¼ç¶åè¿åï¼è¿æ ·çé»è¾è¿æ¯æºç®åçã\n\nä½æ¯ä½ ææ²¡ææ³è¿ï¼å¦ææ­¤æ¶æ100ä¸ªå®æ¶ä»»å¡ï¼å®ä»¬é½ä½¿ç¨å°äºåæ ·ç100å°æºå¨ï¼é£ä¹å®ä»¬æ¯ä¸æ¬¡æ§è¡æ¶è´è½½åè¡¡å¾å°ç IPå°å æ¯ä¸æ ·çåã\n\nä½¿ç¨è´è½½åè¡¡ç®æ³çåå¿æ¯è®©è¯·æ±åæ£ï¼åå°æå¡å¨ååãä½æ­¤æ¶ææ¾è¿æ¯äºåå±±å¤§ãé£ææ ·æè½è®© è¿ç§æåµæ¶å¤±å¢ï¼\n\næä»¬å¯ä»¥ç»åå§çè½®è¯¢ä¸æ çæéæºå¼ï¼è¿æ ·å®ä»¬è½®è¯¢çé¡ºåºå°±ä¸ä¸æ ·äºï¼æä»ç¬¬ä¸ä¸ªå¼å§ï¼ä½ ä»ç¬¬äºä¸ªå¼å§ï¼æä»¬äºä¸å¹²æ°~ äºæ¯ï¼åå§å¼è®¾ç½®ä¸º 0 å°±ä¸å¯åï¼æä»¬è®¾ç½®0 - 100 ä»¥åçéæºå¼ã\n\n// è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \nprivate static int count(int jobId) {\n    AtomicInteger count = routeCountEachJob.get(jobId);\n    if (count == null) {\n        count = new AtomicInteger(new Random().nextInt(100));\n    } else {\n        count.addAndGet(1);\n    }\n    routeCountEachJob.put(jobId, count);\n    return count.get();\n}\n\n\nå¯ç°å¨è¿æ¯æé®é¢ï¼å¦æä¸ä¸ªå®æ¶ä»»å¡è½®è¯¢çæ¬¡æ°å¤ªå¤äºï¼è¶è¿äº int ç±»åçä¸éæä¹åï¼æä»¬éè¦å¨è½®è¯¢ä¸æ è¾¾å°æä¸ä¸ªéå¼æ¶å°å®éç½®ä¸ºéæºæ°ï¼ä¸æ­¢count == null æ¶å¯ä»¥è®¾ç½®éæºå¼ï¼count.get() > 1000000 æ¶ä¹å¯ä»¥ã\n\n// è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \nprivate static int count(int jobId) {\n    AtomicInteger count = routeCountEachJob.get(jobId);\n    if (count == null || count.get() > 1000000) {\n        count = new AtomicInteger(new Random().nextInt(100));\n    } else {\n        count.addAndGet(1);\n    }\n    routeCountEachJob.put(jobId, count);\n    return count.get();\n}\n\n\nç°å¨åæºç å·²ç»å¾æ¥è¿äºï¼æºç ä¸­æ¯ä»¥ä¸å¤©ä¸ºåä½éç½®å®æ¶ä»»å¡çè½®è¯¢ä¸æ çï¼å¦ä½éç½®ï¼ç´æ¥å° Map æ¸ç©ºã\n\npublic class ExecutorRouteRound extends ExecutorRouter {\n\n    private static ConcurrentMap<Integer, AtomicInteger> routeCountEachJob =\n        new ConcurrentHashMap<>();\n    \n    private static long CACHE_VALID_TIME = 0;\n    \n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        int count = count(jobId);\n        String address = addressList.get(count % addressList.size());\n        return new ReturnT<String>(address);\n    }\n\n    private static int count(int jobId) {\n        // æ¯å¤©é½æ¸ç©º Map\n        if (System.currentTimeMillis() > CACHE_VALID_TIME) {\n            routeCountEachJob.clear();\n            // å°è¿ææ¶é´æå®ä¸ºä¸å¤©å\n            CACHE_VALID_TIME = System.currentTimeMillis() + 1000*60*60*24;\n        }\n        \n        AtomicInteger count = routeCountEachJob.get(jobId);\n        if (count == null || count.get() > 1000000) {\n            // åå§åæ¶ä¸»å¨Randomä¸æ¬¡ï¼ç¼è§£é¦æ¬¡åå\n            count = new AtomicInteger(new Random().nextInt(100));\n        } else {\n            // count++\n            count.addAndGet(1);\n        }\n        routeCountEachJob.put(jobId, count);\n        return count.get();\n    }\n}\n\n\n\n# 5. LRU\n\nLRU æå°±ä¸åå¤åä»ç»äºå§ï¼ä¼åä½¿ç¨å¾ä¹æ²¡æä½¿ç¨è¿ç IP å°åï¼åå© Java æä¾ç LinkedHashMap å®ç°ã\n\nXXL-JOB å®ç° LRU ç®æ³æ¶ä¹æ¯ç¨å°äº Map ï¼key ä¸º ä»»å¡idï¼value ä¸º LinkedHashMapï¼åé¨å«æè¯¥å®æ¶ä»»å¡çææIPå°åã\n\npublic class ExecutorRouteLRU extends ExecutorRouter {\n    // key : å®æ¶ä»»å¡id\n    // value : LinkedHashMap, key : IPå°å\n    //                        value : IPå°å\n    // LinkedHashMapçkeyåvalueé½æ¯IPå°åï¼å¹¶æ²¡æä»ä¹ç¹æ®å«ä¹\n    private static ConcurrentMap<Integer, LinkedHashMap<String, String>> \n        jobLRUMap = new ConcurrentHashMap<Integer, LinkedHashMap<String, String>>();\n\n    // Mapä¸­æ°æ®çç¼å­æ¶é´\n    private static long CACHE_VALID_TIME = 0;\n\n    public String get(int jobId, List<String> addressList) {\n        // æ¯å¤©å·æ°\n        if (System.currentTimeMillis() > CACHE_VALID_TIME) {\n            jobLRUMap.clear();\n            CACHE_VALID_TIME = System.currentTimeMillis() + 1000*60*60*24;\n        }\n        \n        // æ ¹æ®å®æ¶ä»»å¡idä»jobLRUMapä¸­è·å¾å¯¹åºçMap\n        LinkedHashMap<String, String> lruItem = jobLRUMap.get(jobId);\n        if (lruItem == null) {\n            lruItem = new LinkedHashMap<String, String>(16, 0.75f, true);\n            // æMapæ¾å°jobLRUMapä¸­\n            jobLRUMap.putIfAbsent(jobId, lruItem);\n        }\n        // ç±äº jobLRUMap ä¸­ä¼å­å¨å®æ¶ä»»å¡å¯¹åºçææIPå°åï¼æä»¥è¦åä¼ å¥çææ°IPå°åååæ­¥\n        // å¤æ­ææ²¡ææ°æ·»å çIP\n        for (String address: addressList) {\n            //å¦ææå°±æå®å å¥å°lruItemä¸­\n            if (!lruItem.containsKey(address)) {\n                lruItem.put(address, address);\n            }\n        }\n        // å¤æ­ææ²¡æéè¦å é¤IP\n        List<String> delKeys = new ArrayList<>();\n        for (String existKey: lruItem.keySet()) {\n            if (!addressList.contains(existKey)) {\n                delKeys.add(existKey);\n            }\n        }\n        //æå°±ææ§è¡å¨å é¤\n        if (delKeys.size() > 0) {\n            for (String delKey: delKeys) {\n                lruItem.remove(delKey);\n            }\n        }\n        // è·åLinkedHashMapä¸­ç¬¬ä¸ä¸ªåç´ å¹¶è¿åã\n        String eldestKey = lruItem.entrySet().iterator().next().getKey();\n        String eldestValue = lruItem.get(eldestKey);\n        return eldestValue;\n    }\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        String address = get(jobId, addressList);\n        return new ReturnT<String>(address);\n    }\n    \n}\n\n\nå¯ä»¥çå°å¶å®æ²¡å¥æä½ï¼ä»£ç è¡æ°å¤çå°æ¹å°±æ¯ åæ­¥ Map ä¸­ç IP ä¸ä½ä¸ºåæ°ä¼ å¥ç IP å°åã\n\n\n# 6. LFU\n\nLFU ï¼ä¼åç¨é£äº ä½¿ç¨é¢çå°çã\n\nå¯ä»¥ä½¿ç¨ä¸ä¸ª Mapï¼keyè£å®æ¶ä»»å¡idï¼value è¿æ¯ä¸ä¸ªMapï¼è¿ä¸ªåé¨ç Map çkeyæ¯IP å°åï¼valueæ¯è¯¥ IP å°åçä½¿ç¨æ¬¡æ°ã\n\nConcurrentMap<Integer, HashMap<String, Integer>> jobLfuMap \n    = new ConcurrentHashMap<Integer, HashMap<String, Integer>>();\n\n\nå½è¦éæ©æ¶ï¼å°ä»»å¡idå¯¹åºç Map æååºæ¥ï¼æç§ ä½¿ç¨æ¬¡æ°æåºï¼å°ç¨çæå°çé£ä¸ªè¿åå°±è¡äº\n\npublic class ExecutorRouteLFU extends ExecutorRouter {\n    //è¿ä¸ªMapç¼å­çkey-valueä¸­çkeyå°±æ¯å®æ¶ä»»å¡çidï¼valueæ¯ä¸ä¸ªmapï¼è¿ä¸ªmapä¸­ç¼å­çæ¯æ§è¡å¨çå°ååè¯¥å°åè¢«ä½¿ç¨çæ¬¡æ°\n    private static ConcurrentMap<Integer, HashMap<String, Integer>> jobLfuMap \n        = new ConcurrentHashMap<Integer, HashMap<String, Integer>>();\n    private static long CACHE_VALID_TIME = 0;\n\n    public String get(int jobId, List<String> addressList) {\n        // æ¯å¤©é½æ´æ°\n        if (System.currentTimeMillis() > CACHE_VALID_TIME) {\n            jobLfuMap.clear();\n            CACHE_VALID_TIME = System.currentTimeMillis() + 1000*60*60*24;\n        }\n        // åéè¿å®æ¶ä»»å¡çidä»jobLfuMapä¸­è·å¾å¯¹åºçvalue\n        HashMap<String, Integer> lfuItemMap = jobLfuMap.get(jobId);\n        //å¦ævalueä¸ºç©ºï¼ååå»ºä¸ä¸ªMap\n        if (lfuItemMap == null) {\n            lfuItemMap = new HashMap<String, Integer>();\n            jobLfuMap.putIfAbsent(jobId, lfuItemMap);   \n        }\n        //ä¸é¢å¼å§éåæ§è¡å¨å°åéå\n        for (String address: addressList) {\n            // å¦ææ¯ç¬¬ä¸æ¬¡ä½¿ç¨ï¼æèä½¿ç¨æ¬¡æ°å¤ªå¤äºï¼å°±æ´æ°ä½¿ç¨æ¬¡æ°\n            if (!lfuItemMap.containsKey(address) || lfuItemMap.get(address) >1000000 ) {\n      \t\t\t// è¿éä½¿ç¨éæºæ°çåå : ä¸ºäºé¿åç¬¬ä¸æ¬¡è´è½½åè¡¡æ¶å¾å¤å®æ¶ä»»å¡é½éæ©äºåä¸å°æºå¨ï¼\n                // ä½¿ç¨éæºæ°é¿åè¿ä¸ªæåµã\n                lfuItemMap.put(address, new Random().nextInt(addressList.size()));\n            }\n        }\n        // å¼å§åæ­¥IPå°å\n        //å¤æ­ææ²¡æè¿æçIPå°å\n        List<String> delKeys = new ArrayList<>();\n        for (String existKey: lfuItemMap.keySet()) {\n            if (!addressList.contains(existKey)) {\n                delKeys.add(existKey);\n            }\n        }\n        //å¦ææå°±æè¿æçIPå°åä»lfuItemMapä¸­ç§»é¤\n        if (delKeys.size() > 0) {\n            for (String delKey: delKeys) {\n                lfuItemMap.remove(delKey);\n            }\n        } \n        // ä¸é¢å°±å¼å§éæ©å·ä½çæ§è¡å¨æ¥æ§è¡å®æ¶ä»»å¡äºï¼ælfuItemMapä¸­çæ°æ®è½¬ç§»å°lfuItemListä¸­\n        List<Map.Entry<String, Integer>> lfuItemList \n            = new ArrayList<Map.Entry<String, Integer>>(lfuItemMap.entrySet());\n        \n        // å°lfuItemListä¸­çæ°æ®æç§æ§è¡å¨çä½¿ç¨æ¬¡æ°åæåº\n        Collections.sort(lfuItemList, new Comparator<Map.Entry<String, Integer>>() {\n            @Override\n            public int compare(Map.Entry<String, Integer> o1, Map.Entry<String, Integer> o2) {\n                return o1.getValue().compareTo(o2.getValue());\n            }\n        });\n        // è·åå°çç¬¬ä¸ä¸ªå°±æ¯ä½¿ç¨æ¬¡æ°æå°çæ§è¡å¨\n        Map.Entry<String, Integer> addressItem = lfuItemList.get(0);\n        String minAddress = addressItem.getKey();\n        //å ä¸ºè¦æ¯ç¨å®äºï¼æä»¥ææ§è¡å¨çä½¿ç¨æ¬¡æ°å 1\n        addressItem.setValue(addressItem.getValue() + 1);\n        //è¿åæ§è¡å¨å°å\n        return addressItem.getKey();\n    }\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        String address = get(jobId, addressList);\n        return new ReturnT<String>(address);\n    }\n\n}\n\n\n\n# 7. hash\n\nè¿ä¸ªææ²¡æçæï¼ç­å°çæäºåè¯´å§\n\n// TODO\n\npublic class ExecutorRouteConsistentHash extends ExecutorRouter {\n\n    private static int VIRTUAL_NODE_NUM = 100;\n\n    private static long hash(String key) {\n        MessageDigest md5;\n        try {\n            md5 = MessageDigest.getInstance("MD5");\n        } catch (NoSuchAlgorithmException e) {\n            throw new RuntimeException("MD5 not supported", e);\n        }\n        md5.reset();\n        byte[] keyBytes = null;\n        try {\n            keyBytes = key.getBytes("UTF-8");\n        } catch (UnsupportedEncodingException e) {\n            throw new RuntimeException("Unknown string :" + key, e);\n        }\n        md5.update(keyBytes);\n        byte[] digest = md5.digest();\n        long hashCode = ((long) (digest[3] & 0xFF) << 24)\n                | ((long) (digest[2] & 0xFF) << 16)\n                | ((long) (digest[1] & 0xFF) << 8)\n                | (digest[0] & 0xFF);\n        long truncateHashCode = hashCode & 0xffffffffL;\n        return truncateHashCode;\n    }\n\n\n    public String hashJob(int jobId, List<String> addressList) {\n        TreeMap<Long, String> addressRing = new TreeMap<Long, String>();\n        for (String address: addressList) {\n            for (int i = 0; i < VIRTUAL_NODE_NUM; i++) {\n                long addressHash = hash("SHARD-" + address + "-NODE-" + i);\n                addressRing.put(addressHash, address);\n            }\n        }\n        long jobHash = hash(String.valueOf(jobId));\n        SortedMap<Long, String> lastRing = addressRing.tailMap(jobHash);\n        if (!lastRing.isEmpty()) {\n            return lastRing.get(lastRing.firstKey());\n        }\n        return addressRing.firstEntry().getValue();\n    }\n\n    @Override\n    public ReturnT<String> route(TriggerParam triggerParam, List<String> addressList) {\n        String address = hashJob(triggerParam.getJobId(), addressList);\n        return new ReturnT<String>(address);\n    }\n\n}\n\n\n\n# 8. å¿ç¢è½¬ç§»\n\nè§åææ ï¼å¦æè¯¥ IPå°å æ­£å¨æ§è¡è¯¥å®æ¶ä»»å¡ï¼é£ä¹æ­¤æ¬¡è´è½½åè¡¡å°±ä¸ä½¿ç¨è¿ä¸ªIPã\n\næä¹ç¥éè¯¥ IPå°å æ¯å¦å¨æ§è¡è¯¥å®æ¶ä»»å¡å¢ï¼åæ¶æ¯é®åã\n\nXXL-JOB ä¸ºä»»å¡åéäºçº¿ç¨ï¼ä¹å°±æ¯ä¸ä¸ªçº¿ç¨ä¸é¨è´è´£ä¸ç±»å®æ¶ä»»å¡ï¼é£ä¹æä»¬åªéè¦ç»è¯¥IPå°åæå¡å¨åéæ¶æ¯ï¼è¯¢é® è¯¥å®æ¶ä»»å¡idå¯¹åºççº¿ç¨æ¯å¦å¨å·¥ä½ä¸­ï¼å¦ææ²¡æå¨å·¥ä½ä¸­ï¼å¯ä»¥å°æ­¤ä»»å¡åéç»å®ï¼å¦æå¨å·¥ä½ä¸­ï¼é£å°±ä¸ææ°ä»äºï¼ç»§ç»­è¯¢é®ä¸ä¸ä¸ªIPã\n\npublic class ExecutorRouteBusyover extends ExecutorRouter {\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        StringBuffer idleBeatResultSB = new StringBuffer();\n        // éåIPå°å,æ¨ä¸ªè¯¢é®\n        for (String address : addressList) {\n            ReturnT<String> idleBeatResult = null;\n            try {\n                // å¾å°åæå®IPå°ååéæ¶æ¯çå®¢æ·ç«¯\n                ExecutorBiz executorBiz = XxlJobScheduler.getExecutorBiz(address);\n                // åå®¢æ·ç«¯åéå¿ç¢æ£æµè¯·æ±ï¼å¤æ­è¯¥æ§è¡å¨çå®æ¶ä»»å¡çº¿ç¨æ¯å¦æ­£å¨æ§è¡å¯¹åºçå®æ¶ä»»å¡\n                // å¦ææ­£å¨æ§è¡ï¼è¯´ææ¯è¾å¿ç¢ï¼å°±ä¸ä½¿ç¨è¯¥å°å\n                idleBeatResult = executorBiz.idleBeat(new IdleBeatParam(jobId));\n            } catch (Exception e) {\n                logger.error(e.getMessage(), e);\n                idleBeatResult = new ReturnT<String>(ReturnT.FAIL_CODE, ""+e );\n            }\n            idleBeatResultSB.append( (idleBeatResultSB.length()>0)?"<br><br>":"")\n                    .append(I18nUtil.getString("jobconf_idleBeat") + "ï¼")\n                    .append("<br>addressï¼").append(address)\n                    .append("<br>codeï¼").append(idleBeatResult.getCode())\n                    .append("<br>msgï¼").append(idleBeatResult.getMsg());\n            // å¦æä¸å¿ç¢å°±ç´æ¥ä½¿ç¨è¯¥å°å\n            if (idleBeatResult.getCode() == ReturnT.SUCCESS_CODE) {\n                idleBeatResult.setMsg(idleBeatResultSB.toString());\n                idleBeatResult.setContent(address);\n                return idleBeatResult;\n            }\n        }\n        // å¦æå¨é½å¨å¿ç¢ï¼ç´æ¥è¿åfail\n        return new ReturnT<String>(ReturnT.FAIL_CODE, idleBeatResultSB.toString());\n    }\n\n}\n\n\n\n# 9. æéè½¬ç§»\n\nè¿ä¸ªç­ç¥æ¯å¿ç¢è½¬ç§»å®¹æå®ç°ï¼æéè½¬ç§»å°±æ¯çç è¯¥IPå°åè½ä¸è½ç¨ï¼å¦æå®æ²¡æä¸çº¿å°±å¯ä»¥ä½¿ç¨ï¼å¦æä¸çº¿äºè¯å®ä¸è½ä½¿ç¨ãåªéè¦åæ¶æ¯é®é®å¯¹åºIPçæ§è¡å¨ã\n\npublic class ExecutorRouteFailover extends ExecutorRouter {\n\n    @Override\n    public ReturnT<String> route(int jobId, List<String> addressList) {\n        StringBuffer beatResultSB = new StringBuffer();\n        // éåå¾å°çæ§è¡å¨çIPå°å\n        for (String address : addressList) {\n            ReturnT<String> beatResult = null;\n            try {\n                // å¾å°è®¿é®æ§è¡å¨çå®¢æ·ç«¯\n                ExecutorBiz executorBiz = XxlJobScheduler.getExecutorBiz(address);\n                // åæ§è¡å¨åéå¿è·³æ£æµè¯·æ±ï¼çæ§è¡å¨æ¯å¦è¿å¨çº¿\n                beatResult = executorBiz.beat();\n            } catch (Exception e) {\n                logger.error(e.getMessage(), e);\n                beatResult = new ReturnT<String>(ReturnT.FAIL_CODE, ""+e );\n            }\n            beatResultSB.append( (beatResultSB.length()>0)?"<br><br>":"")\n                    .append(I18nUtil.getString("jobconf_beat") + "ï¼")\n                    .append("<br>addressï¼").append(address)\n                    .append("<br>codeï¼").append(beatResult.getCode())\n                    .append("<br>msgï¼").append(beatResult.getMsg());\n            // å¿è·³æ£æµæ²¡é®é¢ï¼å°±ç´æ¥ä½¿ç¨è¯¥æ§è¡å¨\n            if (beatResult.getCode() == ReturnT.SUCCESS_CODE) {\n\n                beatResult.setMsg(beatResultSB.toString());\n                beatResult.setContent(address);\n                return beatResult;\n            }\n        }\n        // æææ§è¡å¨é½ä¸è½æ§è¡\n        return new ReturnT<String>(ReturnT.FAIL_CODE, beatResultSB.toString());\n    }\n}\n',normalizedContent:'# 1. ç®è¿°\n\nç®æ³è¦æå¡äºä¸å¡æè½ä½ç°åºå®çä»·å¼ï¼ç®æ³åªæ¯æä¾äºæ´ä½ä¸çæè·¯ï¼è³äºå¦ä½å®ç°å®ï¼é£è¦çå·ä½çä¸å¡åºæ¯ï¼æä»¥æé¦åè¦ä»ç»ä¸ä¸ xxl-job ä½¿ç¨è´è½½åè¡¡ç­ç¥çèæ¯ ï¼ç±äºxxl-jobçèªæå®ä½æ¯**åå¸å¼å®æ¶ä»»å¡æ¡æ¶ãæä»¥ä¸ä¸ªä»»å¡å¯è½é¨ç½²å¨å¤ä¸ªæå¡å¨ä¸ï¼ä½æ¯æä»¬åªæ³è¦ä¸ä¸ªæºå¨å¯ä»¥æ§è¡è¿ä¸ªä»»å¡**ãé£ä¹å¨æ§è¡çæ¶åå°±éè¦æéä¸ä¸ª ip å°åå»æ§è¡è¿ä¸ªä»»å¡ã\n\nxxl-job ä¸­ä½¿ç¨ç­ç¥è®¾è®¡æ¨¡å¼å®ç°è´è½½åè¡¡ç®æ³ï¼æºç å°åï¼xxl-jobè´è½½åè¡¡ç­ç¥ã\n\né¦åæ¯é¡¶çº§æ¥å£ ï¼\n\npublic abstract class executorrouter {\n\n    public abstract returnt<string> route(int jobid, \n                                          list<string> addresslist);\n\n}\n\n\nææå®æ¹è£äºä¸ä¸ï¼route æ¹æ³çç¬¬ä¸ä¸ªåæ°å¨æºç ä¸­å¶å®å¹¶ä¸æ¯ jobidï¼å®æ¯ä¸ä¸ªç±»ï¼ä½æ¯æç« çéç¹æ¯ä»ç»è´è½½åè¡¡ç®æ³ï¼æä»¥æ­¤å¤ç´æªäºå½ä½¿ç¨ jobidãåä»ç»ä¸ä¸ä¸¤ä¸ªåæ°ï¼\n\n 1. jobid ï¼å®æ¶ä»»å¡çid\n 2. addresslist ï¼è¯¥å®æ¶ä»»å¡å¯ä»¥è¢«è¿äº ip å°åæ§è¡ï¼ä½æ¯æä»¬è¦ä»ä¸­éåä¸ä¸ªã\n\nxxl-jobä½¿ç¨çè´è½½åè¡¡ç­ç¥å±æ 9 ç§ï¼\n\n 1. éåç¬¬ä¸ä¸ª\n 2. éåæåä¸ä¸ª\n 3. éæºéå\n 4. è½®è¯¢\n 5. æè¿æå°ä½¿ç¨ï¼lruï¼\n 6. æå°é¢çä½¿ç¨ï¼lfuï¼\n 7. hash\n 8. å¿ç¢è½¬ç§»\n 9. æéè½¬ç§»\n\nåä¸¤ç§å¤ªç®åäºï¼æ¾å¨ä¸èµ·ä»ç»ã\n\næåä¸¤ç§ç­ç¥å¶å®å°±å¾åä¸å¡äºï¼å¦æå¯¹xxl-jobçäºè§£ä¸å¤çè¯å¯è½çä¸æï¼ä½æ¯æä¼å°½åå°å®åæç½ã\n\n\n# 2. éåç¬¬ä¸ä¸ªãæåä¸ä¸ª\n\nè¿ä¸¤ç§éå¸¸ç®åï¼æ¹æ³åæ°ä¸­å·²ç»æäº ipå°å éåï¼é£æä»¬ç´æ¥ list.get(0)ãlist.get(list.size() - 1) ä¸å°±è¡äºï¼\n\näºå®ä¸ xxl-job ç¡®å®æ¯è¿ä¹åçã\n\néåç¬¬ä¸ä¸ªï¼\n\npublic class executorroutefirst extends executorrouter {\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist){\n        return new returnt<string>(addresslist.get(0));\n    }\n\n}\n\n\néåæåä¸ä¸ª ï¼\n\npublic class executorroutelast extends executorrouter {\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        return new returnt<string>(addresslist.get(addresslist.size()-1));\n    }\n\n}\n\n\næ¯ä¸æ¯å¾ç®åï¼æå°±ä¸åå¤è¯´äºåã\n\n\n# 3. éæºéå\n\nå¦æå¨ä¸ä¸ªéåä¸­éæºéåä¸ä¸ªæ°æ®ï¼ä½ ä¼æä¹åï¼çæä¸ä¸ªéæºæ°ï¼è¿ä¸ªéæºæ°çèå´ä¸ºï¼[0ï¼list.size() - 1]ãè¿æ ·ä¸å°±è¡äºåð\n\npublic class executorrouterandom extends executorrouter {\n\n    private static random localrandom = new random();\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        string address = addresslist.get(localrandom.nextint(addresslist.size()));\n        return new returnt<string>(address);\n    }\n\n}\n\n\n\n# 4. è½®è¯¢\n\nè¿ä¸ªå¬èµ·æ¥å¾å®¹æï¼ä½æ¯å®ç°çæ¶åéå¸¸ä¾èµäºä¸å¡ãxxl-jobå¨å®ç°çæ¶åæ¯è¿æ ·åç ï¼å°ææå®æ¶ä»»å¡ä¸å®ä»¬å¯¹åºç ipå°å é½æ¾å¨ä¸ä¸ª map ä¸­ç®¡çãä½æ¯å¦ä½è½®è¯¢å¢ï¼è¿æ ·æ²¡æåæ³è½®è¯¢åï¼æä»¬å¹¶ä¸ç¥éä¸ä¸æ¬¡è¯¥è°äºï¼æä»¥è¦æ¹åä¸ä¸æç»´ï¼æ¢ç¶å¨æ¹æ³åæ°ä¸­å·²ç»æäº ipå°å éåï¼é£ä¹å¯ä»¥å¨ map ç value ä¸­è®°å½ï¼ä¸ä¸æ¬¡è¯¥ç¬¬å ä¸ªäºãæä»¥ map ç key ä¸º å®æ¶ä»»å¡idï¼value ä¸º ä¸ä¸æ¬¡éè¦è½®è¯¢çä¸æ ã\n\nè¯´çæºç®åï¼æ¥çç xxl-job æ¯æä¹åçå§ï¼\n\npublic class executorrouteround extends executorrouter {\n    // key : å®æ¶ä»»å¡id\n    // value : è¯¥idçå®æ¶ä»»å¡è½®è¯¢å°åªä¸ä¸ªä¸æ äºã\n    private static concurrentmap<integer, atomicinteger> routecounteachjob \n        = new concurrenthashmap<>();\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        int count = count(jobid);\n        string address = addresslist.get(count % addresslist.size());\n        return new returnt<string>(address);\n    }\n    \n    // è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \n    private static int count(int jobid) {\n        atomicinteger count = routecounteachjob.get(jobid);\n        if (count == null || count.get() > 1000000) {\n            count = new atomicinteger(0);\n        } else {\n            count.addandget(1);\n        }\n        routecounteachjob.put(jobid, count);\n        return count.get();\n    }\n\n}\n\n\nä¸»è¦æ¯ count() æ¹æ³ï¼å®ä¼è·åæå®idçå®æ¶ä»»å¡è¯¥è½®è¯¢å°çä¸æ ã\n\n// è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \nprivate static int count(int jobid) {\n    atomicinteger count = routecounteachjob.get(jobid);\n    if (count == null) {\n        count = new atomicinteger(0);\n    } else {\n        count.addandget(1);\n    }\n    routecounteachjob.put(jobid, count);\n    return count.get();\n}\n\n\nå¦ææ­¤ å®æ¶ä»»å¡id å¨ map ä¸­ä¸å­å¨ï¼é£å°±æ°å»ºä¸ä¸ªï¼å¹¶å°è½®è¯¢ä¸æ åå§åä¸º 0ï¼å¦æå·²ç»å­å¨å°±å°è½®è¯¢ä¸æ å ä¸ï¼ç¶åè¿åï¼è¿æ ·çé»è¾è¿æ¯æºç®åçã\n\nä½æ¯ä½ ææ²¡ææ³è¿ï¼å¦ææ­¤æ¶æ100ä¸ªå®æ¶ä»»å¡ï¼å®ä»¬é½ä½¿ç¨å°äºåæ ·ç100å°æºå¨ï¼é£ä¹å®ä»¬æ¯ä¸æ¬¡æ§è¡æ¶è´è½½åè¡¡å¾å°ç ipå°å æ¯ä¸æ ·çåã\n\nä½¿ç¨è´è½½åè¡¡ç®æ³çåå¿æ¯è®©è¯·æ±åæ£ï¼åå°æå¡å¨ååãä½æ­¤æ¶ææ¾è¿æ¯äºåå±±å¤§ãé£ææ ·æè½è®© è¿ç§æåµæ¶å¤±å¢ï¼\n\næä»¬å¯ä»¥ç»åå§çè½®è¯¢ä¸æ çæéæºå¼ï¼è¿æ ·å®ä»¬è½®è¯¢çé¡ºåºå°±ä¸ä¸æ ·äºï¼æä»ç¬¬ä¸ä¸ªå¼å§ï¼ä½ ä»ç¬¬äºä¸ªå¼å§ï¼æä»¬äºä¸å¹²æ°~ äºæ¯ï¼åå§å¼è®¾ç½®ä¸º 0 å°±ä¸å¯åï¼æä»¬è®¾ç½®0 - 100 ä»¥åçéæºå¼ã\n\n// è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \nprivate static int count(int jobid) {\n    atomicinteger count = routecounteachjob.get(jobid);\n    if (count == null) {\n        count = new atomicinteger(new random().nextint(100));\n    } else {\n        count.addandget(1);\n    }\n    routecounteachjob.put(jobid, count);\n    return count.get();\n}\n\n\nå¯ç°å¨è¿æ¯æé®é¢ï¼å¦æä¸ä¸ªå®æ¶ä»»å¡è½®è¯¢çæ¬¡æ°å¤ªå¤äºï¼è¶è¿äº int ç±»åçä¸éæä¹åï¼æä»¬éè¦å¨è½®è¯¢ä¸æ è¾¾å°æä¸ä¸ªéå¼æ¶å°å®éç½®ä¸ºéæºæ°ï¼ä¸æ­¢count == null æ¶å¯ä»¥è®¾ç½®éæºå¼ï¼count.get() > 1000000 æ¶ä¹å¯ä»¥ã\n\n// è·åæå®å®æ¶ä»»å¡idè½®è¯¢çä¸æ \nprivate static int count(int jobid) {\n    atomicinteger count = routecounteachjob.get(jobid);\n    if (count == null || count.get() > 1000000) {\n        count = new atomicinteger(new random().nextint(100));\n    } else {\n        count.addandget(1);\n    }\n    routecounteachjob.put(jobid, count);\n    return count.get();\n}\n\n\nç°å¨åæºç å·²ç»å¾æ¥è¿äºï¼æºç ä¸­æ¯ä»¥ä¸å¤©ä¸ºåä½éç½®å®æ¶ä»»å¡çè½®è¯¢ä¸æ çï¼å¦ä½éç½®ï¼ç´æ¥å° map æ¸ç©ºã\n\npublic class executorrouteround extends executorrouter {\n\n    private static concurrentmap<integer, atomicinteger> routecounteachjob =\n        new concurrenthashmap<>();\n    \n    private static long cache_valid_time = 0;\n    \n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        int count = count(jobid);\n        string address = addresslist.get(count % addresslist.size());\n        return new returnt<string>(address);\n    }\n\n    private static int count(int jobid) {\n        // æ¯å¤©é½æ¸ç©º map\n        if (system.currenttimemillis() > cache_valid_time) {\n            routecounteachjob.clear();\n            // å°è¿ææ¶é´æå®ä¸ºä¸å¤©å\n            cache_valid_time = system.currenttimemillis() + 1000*60*60*24;\n        }\n        \n        atomicinteger count = routecounteachjob.get(jobid);\n        if (count == null || count.get() > 1000000) {\n            // åå§åæ¶ä¸»å¨randomä¸æ¬¡ï¼ç¼è§£é¦æ¬¡åå\n            count = new atomicinteger(new random().nextint(100));\n        } else {\n            // count++\n            count.addandget(1);\n        }\n        routecounteachjob.put(jobid, count);\n        return count.get();\n    }\n}\n\n\n\n# 5. lru\n\nlru æå°±ä¸åå¤åä»ç»äºå§ï¼ä¼åä½¿ç¨å¾ä¹æ²¡æä½¿ç¨è¿ç ip å°åï¼åå© java æä¾ç linkedhashmap å®ç°ã\n\nxxl-job å®ç° lru ç®æ³æ¶ä¹æ¯ç¨å°äº map ï¼key ä¸º ä»»å¡idï¼value ä¸º linkedhashmapï¼åé¨å«æè¯¥å®æ¶ä»»å¡çææipå°åã\n\npublic class executorroutelru extends executorrouter {\n    // key : å®æ¶ä»»å¡id\n    // value : linkedhashmap, key : ipå°å\n    //                        value : ipå°å\n    // linkedhashmapçkeyåvalueé½æ¯ipå°åï¼å¹¶æ²¡æä»ä¹ç¹æ®å«ä¹\n    private static concurrentmap<integer, linkedhashmap<string, string>> \n        joblrumap = new concurrenthashmap<integer, linkedhashmap<string, string>>();\n\n    // mapä¸­æ°æ®çç¼å­æ¶é´\n    private static long cache_valid_time = 0;\n\n    public string get(int jobid, list<string> addresslist) {\n        // æ¯å¤©å·æ°\n        if (system.currenttimemillis() > cache_valid_time) {\n            joblrumap.clear();\n            cache_valid_time = system.currenttimemillis() + 1000*60*60*24;\n        }\n        \n        // æ ¹æ®å®æ¶ä»»å¡idä»joblrumapä¸­è·å¾å¯¹åºçmap\n        linkedhashmap<string, string> lruitem = joblrumap.get(jobid);\n        if (lruitem == null) {\n            lruitem = new linkedhashmap<string, string>(16, 0.75f, true);\n            // æmapæ¾å°joblrumapä¸­\n            joblrumap.putifabsent(jobid, lruitem);\n        }\n        // ç±äº joblrumap ä¸­ä¼å­å¨å®æ¶ä»»å¡å¯¹åºçææipå°åï¼æä»¥è¦åä¼ å¥çææ°ipå°åååæ­¥\n        // å¤æ­ææ²¡ææ°æ·»å çip\n        for (string address: addresslist) {\n            //å¦ææå°±æå®å å¥å°lruitemä¸­\n            if (!lruitem.containskey(address)) {\n                lruitem.put(address, address);\n            }\n        }\n        // å¤æ­ææ²¡æéè¦å é¤ip\n        list<string> delkeys = new arraylist<>();\n        for (string existkey: lruitem.keyset()) {\n            if (!addresslist.contains(existkey)) {\n                delkeys.add(existkey);\n            }\n        }\n        //æå°±ææ§è¡å¨å é¤\n        if (delkeys.size() > 0) {\n            for (string delkey: delkeys) {\n                lruitem.remove(delkey);\n            }\n        }\n        // è·ålinkedhashmapä¸­ç¬¬ä¸ä¸ªåç´ å¹¶è¿åã\n        string eldestkey = lruitem.entryset().iterator().next().getkey();\n        string eldestvalue = lruitem.get(eldestkey);\n        return eldestvalue;\n    }\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        string address = get(jobid, addresslist);\n        return new returnt<string>(address);\n    }\n    \n}\n\n\nå¯ä»¥çå°å¶å®æ²¡å¥æä½ï¼ä»£ç è¡æ°å¤çå°æ¹å°±æ¯ åæ­¥ map ä¸­ç ip ä¸ä½ä¸ºåæ°ä¼ å¥ç ip å°åã\n\n\n# 6. lfu\n\nlfu ï¼ä¼åç¨é£äº ä½¿ç¨é¢çå°çã\n\nå¯ä»¥ä½¿ç¨ä¸ä¸ª mapï¼keyè£å®æ¶ä»»å¡idï¼value è¿æ¯ä¸ä¸ªmapï¼è¿ä¸ªåé¨ç map çkeyæ¯ip å°åï¼valueæ¯è¯¥ ip å°åçä½¿ç¨æ¬¡æ°ã\n\nconcurrentmap<integer, hashmap<string, integer>> joblfumap \n    = new concurrenthashmap<integer, hashmap<string, integer>>();\n\n\nå½è¦éæ©æ¶ï¼å°ä»»å¡idå¯¹åºç map æååºæ¥ï¼æç§ ä½¿ç¨æ¬¡æ°æåºï¼å°ç¨çæå°çé£ä¸ªè¿åå°±è¡äº\n\npublic class executorroutelfu extends executorrouter {\n    //è¿ä¸ªmapç¼å­çkey-valueä¸­çkeyå°±æ¯å®æ¶ä»»å¡çidï¼valueæ¯ä¸ä¸ªmapï¼è¿ä¸ªmapä¸­ç¼å­çæ¯æ§è¡å¨çå°ååè¯¥å°åè¢«ä½¿ç¨çæ¬¡æ°\n    private static concurrentmap<integer, hashmap<string, integer>> joblfumap \n        = new concurrenthashmap<integer, hashmap<string, integer>>();\n    private static long cache_valid_time = 0;\n\n    public string get(int jobid, list<string> addresslist) {\n        // æ¯å¤©é½æ´æ°\n        if (system.currenttimemillis() > cache_valid_time) {\n            joblfumap.clear();\n            cache_valid_time = system.currenttimemillis() + 1000*60*60*24;\n        }\n        // åéè¿å®æ¶ä»»å¡çidä»joblfumapä¸­è·å¾å¯¹åºçvalue\n        hashmap<string, integer> lfuitemmap = joblfumap.get(jobid);\n        //å¦ævalueä¸ºç©ºï¼ååå»ºä¸ä¸ªmap\n        if (lfuitemmap == null) {\n            lfuitemmap = new hashmap<string, integer>();\n            joblfumap.putifabsent(jobid, lfuitemmap);   \n        }\n        //ä¸é¢å¼å§éåæ§è¡å¨å°åéå\n        for (string address: addresslist) {\n            // å¦ææ¯ç¬¬ä¸æ¬¡ä½¿ç¨ï¼æèä½¿ç¨æ¬¡æ°å¤ªå¤äºï¼å°±æ´æ°ä½¿ç¨æ¬¡æ°\n            if (!lfuitemmap.containskey(address) || lfuitemmap.get(address) >1000000 ) {\n      \t\t\t// è¿éä½¿ç¨éæºæ°çåå : ä¸ºäºé¿åç¬¬ä¸æ¬¡è´è½½åè¡¡æ¶å¾å¤å®æ¶ä»»å¡é½éæ©äºåä¸å°æºå¨ï¼\n                // ä½¿ç¨éæºæ°é¿åè¿ä¸ªæåµã\n                lfuitemmap.put(address, new random().nextint(addresslist.size()));\n            }\n        }\n        // å¼å§åæ­¥ipå°å\n        //å¤æ­ææ²¡æè¿æçipå°å\n        list<string> delkeys = new arraylist<>();\n        for (string existkey: lfuitemmap.keyset()) {\n            if (!addresslist.contains(existkey)) {\n                delkeys.add(existkey);\n            }\n        }\n        //å¦ææå°±æè¿æçipå°åä»lfuitemmapä¸­ç§»é¤\n        if (delkeys.size() > 0) {\n            for (string delkey: delkeys) {\n                lfuitemmap.remove(delkey);\n            }\n        } \n        // ä¸é¢å°±å¼å§éæ©å·ä½çæ§è¡å¨æ¥æ§è¡å®æ¶ä»»å¡äºï¼ælfuitemmapä¸­çæ°æ®è½¬ç§»å°lfuitemlistä¸­\n        list<map.entry<string, integer>> lfuitemlist \n            = new arraylist<map.entry<string, integer>>(lfuitemmap.entryset());\n        \n        // å°lfuitemlistä¸­çæ°æ®æç§æ§è¡å¨çä½¿ç¨æ¬¡æ°åæåº\n        collections.sort(lfuitemlist, new comparator<map.entry<string, integer>>() {\n            @override\n            public int compare(map.entry<string, integer> o1, map.entry<string, integer> o2) {\n                return o1.getvalue().compareto(o2.getvalue());\n            }\n        });\n        // è·åå°çç¬¬ä¸ä¸ªå°±æ¯ä½¿ç¨æ¬¡æ°æå°çæ§è¡å¨\n        map.entry<string, integer> addressitem = lfuitemlist.get(0);\n        string minaddress = addressitem.getkey();\n        //å ä¸ºè¦æ¯ç¨å®äºï¼æä»¥ææ§è¡å¨çä½¿ç¨æ¬¡æ°å 1\n        addressitem.setvalue(addressitem.getvalue() + 1);\n        //è¿åæ§è¡å¨å°å\n        return addressitem.getkey();\n    }\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        string address = get(jobid, addresslist);\n        return new returnt<string>(address);\n    }\n\n}\n\n\n\n# 7. hash\n\nè¿ä¸ªææ²¡æçæï¼ç­å°çæäºåè¯´å§\n\n// todo\n\npublic class executorrouteconsistenthash extends executorrouter {\n\n    private static int virtual_node_num = 100;\n\n    private static long hash(string key) {\n        messagedigest md5;\n        try {\n            md5 = messagedigest.getinstance("md5");\n        } catch (nosuchalgorithmexception e) {\n            throw new runtimeexception("md5 not supported", e);\n        }\n        md5.reset();\n        byte[] keybytes = null;\n        try {\n            keybytes = key.getbytes("utf-8");\n        } catch (unsupportedencodingexception e) {\n            throw new runtimeexception("unknown string :" + key, e);\n        }\n        md5.update(keybytes);\n        byte[] digest = md5.digest();\n        long hashcode = ((long) (digest[3] & 0xff) << 24)\n                | ((long) (digest[2] & 0xff) << 16)\n                | ((long) (digest[1] & 0xff) << 8)\n                | (digest[0] & 0xff);\n        long truncatehashcode = hashcode & 0xffffffffl;\n        return truncatehashcode;\n    }\n\n\n    public string hashjob(int jobid, list<string> addresslist) {\n        treemap<long, string> addressring = new treemap<long, string>();\n        for (string address: addresslist) {\n            for (int i = 0; i < virtual_node_num; i++) {\n                long addresshash = hash("shard-" + address + "-node-" + i);\n                addressring.put(addresshash, address);\n            }\n        }\n        long jobhash = hash(string.valueof(jobid));\n        sortedmap<long, string> lastring = addressring.tailmap(jobhash);\n        if (!lastring.isempty()) {\n            return lastring.get(lastring.firstkey());\n        }\n        return addressring.firstentry().getvalue();\n    }\n\n    @override\n    public returnt<string> route(triggerparam triggerparam, list<string> addresslist) {\n        string address = hashjob(triggerparam.getjobid(), addresslist);\n        return new returnt<string>(address);\n    }\n\n}\n\n\n\n# 8. å¿ç¢è½¬ç§»\n\nè§åææ ï¼å¦æè¯¥ ipå°å æ­£å¨æ§è¡è¯¥å®æ¶ä»»å¡ï¼é£ä¹æ­¤æ¬¡è´è½½åè¡¡å°±ä¸ä½¿ç¨è¿ä¸ªipã\n\næä¹ç¥éè¯¥ ipå°å æ¯å¦å¨æ§è¡è¯¥å®æ¶ä»»å¡å¢ï¼åæ¶æ¯é®åã\n\nxxl-job ä¸ºä»»å¡åéäºçº¿ç¨ï¼ä¹å°±æ¯ä¸ä¸ªçº¿ç¨ä¸é¨è´è´£ä¸ç±»å®æ¶ä»»å¡ï¼é£ä¹æä»¬åªéè¦ç»è¯¥ipå°åæå¡å¨åéæ¶æ¯ï¼è¯¢é® è¯¥å®æ¶ä»»å¡idå¯¹åºççº¿ç¨æ¯å¦å¨å·¥ä½ä¸­ï¼å¦ææ²¡æå¨å·¥ä½ä¸­ï¼å¯ä»¥å°æ­¤ä»»å¡åéç»å®ï¼å¦æå¨å·¥ä½ä¸­ï¼é£å°±ä¸ææ°ä»äºï¼ç»§ç»­è¯¢é®ä¸ä¸ä¸ªipã\n\npublic class executorroutebusyover extends executorrouter {\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        stringbuffer idlebeatresultsb = new stringbuffer();\n        // éåipå°å,æ¨ä¸ªè¯¢é®\n        for (string address : addresslist) {\n            returnt<string> idlebeatresult = null;\n            try {\n                // å¾å°åæå®ipå°ååéæ¶æ¯çå®¢æ·ç«¯\n                executorbiz executorbiz = xxljobscheduler.getexecutorbiz(address);\n                // åå®¢æ·ç«¯åéå¿ç¢æ£æµè¯·æ±ï¼å¤æ­è¯¥æ§è¡å¨çå®æ¶ä»»å¡çº¿ç¨æ¯å¦æ­£å¨æ§è¡å¯¹åºçå®æ¶ä»»å¡\n                // å¦ææ­£å¨æ§è¡ï¼è¯´ææ¯è¾å¿ç¢ï¼å°±ä¸ä½¿ç¨è¯¥å°å\n                idlebeatresult = executorbiz.idlebeat(new idlebeatparam(jobid));\n            } catch (exception e) {\n                logger.error(e.getmessage(), e);\n                idlebeatresult = new returnt<string>(returnt.fail_code, ""+e );\n            }\n            idlebeatresultsb.append( (idlebeatresultsb.length()>0)?"<br><br>":"")\n                    .append(i18nutil.getstring("jobconf_idlebeat") + "ï¼")\n                    .append("<br>addressï¼").append(address)\n                    .append("<br>codeï¼").append(idlebeatresult.getcode())\n                    .append("<br>msgï¼").append(idlebeatresult.getmsg());\n            // å¦æä¸å¿ç¢å°±ç´æ¥ä½¿ç¨è¯¥å°å\n            if (idlebeatresult.getcode() == returnt.success_code) {\n                idlebeatresult.setmsg(idlebeatresultsb.tostring());\n                idlebeatresult.setcontent(address);\n                return idlebeatresult;\n            }\n        }\n        // å¦æå¨é½å¨å¿ç¢ï¼ç´æ¥è¿åfail\n        return new returnt<string>(returnt.fail_code, idlebeatresultsb.tostring());\n    }\n\n}\n\n\n\n# 9. æéè½¬ç§»\n\nè¿ä¸ªç­ç¥æ¯å¿ç¢è½¬ç§»å®¹æå®ç°ï¼æéè½¬ç§»å°±æ¯çç è¯¥ipå°åè½ä¸è½ç¨ï¼å¦æå®æ²¡æä¸çº¿å°±å¯ä»¥ä½¿ç¨ï¼å¦æä¸çº¿äºè¯å®ä¸è½ä½¿ç¨ãåªéè¦åæ¶æ¯é®é®å¯¹åºipçæ§è¡å¨ã\n\npublic class executorroutefailover extends executorrouter {\n\n    @override\n    public returnt<string> route(int jobid, list<string> addresslist) {\n        stringbuffer beatresultsb = new stringbuffer();\n        // éåå¾å°çæ§è¡å¨çipå°å\n        for (string address : addresslist) {\n            returnt<string> beatresult = null;\n            try {\n                // å¾å°è®¿é®æ§è¡å¨çå®¢æ·ç«¯\n                executorbiz executorbiz = xxljobscheduler.getexecutorbiz(address);\n                // åæ§è¡å¨åéå¿è·³æ£æµè¯·æ±ï¼çæ§è¡å¨æ¯å¦è¿å¨çº¿\n                beatresult = executorbiz.beat();\n            } catch (exception e) {\n                logger.error(e.getmessage(), e);\n                beatresult = new returnt<string>(returnt.fail_code, ""+e );\n            }\n            beatresultsb.append( (beatresultsb.length()>0)?"<br><br>":"")\n                    .append(i18nutil.getstring("jobconf_beat") + "ï¼")\n                    .append("<br>addressï¼").append(address)\n                    .append("<br>codeï¼").append(beatresult.getcode())\n                    .append("<br>msgï¼").append(beatresult.getmsg());\n            // å¿è·³æ£æµæ²¡é®é¢ï¼å°±ç´æ¥ä½¿ç¨è¯¥æ§è¡å¨\n            if (beatresult.getcode() == returnt.success_code) {\n\n                beatresult.setmsg(beatresultsb.tostring());\n                beatresult.setcontent(address);\n                return beatresult;\n            }\n        }\n        // æææ§è¡å¨é½ä¸è½æ§è¡\n        return new returnt<string>(returnt.fail_code, beatresultsb.tostring());\n    }\n}\n',charsets:{cjk:!0},lastUpdated:"2023/10/30, 14:27:21",lastUpdatedTimestamp:1698647241e3},{title:"4. XXL-JOBæ°æ®åºå­æ®µè®²è§£",frontmatter:{title:"4. XXL-JOBæ°æ®åºå­æ®µè®²è§£",date:"2023-11-20T12:56:32.000Z",permalink:"/pages/ac1d9d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/100.XXL-JOB/4.XXL-JOB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%97%E6%AE%B5%E8%AE%B2%E8%A7%A3.html",relativePath:"02.æç« /91.æ¡æ¶/100.XXL-JOB/4.XXL-JOBæ°æ®åºå­æ®µè®²è§£.md",key:"v-849ebb74",path:"/pages/ac1d9d/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. xxljobinfo",slug:"_1-xxl-job-info",normalizedTitle:"1. xxljobinfo",charIndex:null},{level:2,title:"2. xxljobgroup",slug:"_2-xxl-job-group",normalizedTitle:"2. xxljobgroup",charIndex:null},{level:2,title:"3. xxljobregistry",slug:"_3-xxl-job-registry",normalizedTitle:"3. xxljobregistry",charIndex:null},{level:2,title:"4. xxljoblog",slug:"_4-xxl-job-log",normalizedTitle:"4. xxljoblog",charIndex:null},{level:2,title:"5. xxljoblock",slug:"_5-xxl-job-lock",normalizedTitle:"5. xxljoblock",charIndex:null}],headersStr:"0. åè¨ 1. xxljobinfo 2. xxljobgroup 3. xxljobregistry 4. xxljoblog 5. xxljoblock",content:"# 0. åè¨\n\nXxl-Jobä¸å±å«å¼ è¡¨ï¼\n\n 1. xxl_job_group ï¼æ§è¡å¨ç»\n 2. xxl_job_info ï¼å®æ¶ä»»å¡ä¿¡æ¯\n 3. xxl_job_lock ï¼åå¸å¼é\n 4. xxl_job_log ï¼å®æ¶ä»»å¡æ§è¡æ¥å¿\n 5. xxl_job_log_report ï¼æ§è¡æ¥å¿ç»è®¡\n 6. xxl_job_logglue ï¼glueæ¨¡å¼çæ¥å¿\n 7. xxl_job_registry ï¼æ§è¡å¨çæ³¨åä¿¡æ¯\n 8. xxl_job_user ï¼ç¨æ·ä¿¡æ¯\n\nä¸ä¼å¨é¨æ¶åï¼å¶ä¸­ xxl_job_logglueãxxl_job_userãxxl_job_log_report ä¸ä¼è®²è§£ã\n\n\n# 1. xxl_job_info\n\nè¿å¼ è¡¨æ¯å®æ¶ä»»å¡çä¿¡æ¯è¡¨ï¼å­æ®µå¦ä¸ï¼\n\n\n\n * id ï¼è¯¥ä»»å¡çid\n * job_group ï¼è¯¥ä»»å¡å³èçæ§è¡å¨ç»\n * job_desc ï¼è¯¥ä»»å¡çæè¿°\n * alarm_email ï¼åè­¦é®ç®±\n * schedule_type ï¼è°åº¦ç±»åï¼cornæ¨¡å¼ãåºå®éç\n * schedule_conf ï¼è°åº¦éç½®ï¼cornæ¨¡å¼ä¸ï¼è¯¥å¼ä¸ºcronè¡¨è¾¾å¼\n * misfire_strategy ï¼ä»»å¡è¿æç­ç¥ï¼åå¦æ§è¡å¨å®æºä»»å¡æ²¡æè®¡æ¶å¤çæä¹åã\n * executor_handler ï¼å®æ¶ä»»å¡çåç§°\n * executor_param ï¼å®æ¶ä»»å¡çåæ°\n * executor_block_strategy ï¼å®æ¶ä»»å¡é»å¡ç­ç¥\n * executor_timeout ï¼å®æ¶ä»»å¡çè¶æ¶æ¶é´\n * executor_fail_retry_count ï¼å®æ¶ä»»å¡å¤±è´¥éè¯æ¬¡æ°\n * trigger_status ï¼ä»»å¡çç¶æï¼0-åæ­¢ï¼1-è¿è¡\n * trigger_last_time ï¼ä¸æ¬¡è°åº¦æ¶é´\n * trigger_next_time ï¼ä¸æ¬¡è°åº¦æ¶é´\n\nå¼å¾æ³¨æçæ¯ï¼å¨ xxl-job ä¸­å®æ¶ä»»å¡å¹¶æ²¡æè·æ§è¡å¨ç´æ¥å³èï¼èæ¯è·æ§è¡å¨ç»å³èã\n\næ§è¡å¨ç»ä¹å°±æ¯ xxl_job_groupè¡¨ãæ¯ä¸ä¸ªæ§è¡å¨ç»ä¸­é½æ1~nå°æ§è¡å¨ï¼å®æ¶ä»»å¡çæ§è¡è¿ç¨ï¼\n\n 1. éè¿ trigger_next_time æ¥å°5ç§åå°è¦æ§è¡çä»»å¡ï¼å¦ææå®äºæ§è¡å¨é£ä¹ç´æ¥æ§è¡ã\n 2. å¦ææ²¡ææå®æ§è¡å¨ï¼éè¿ job_group æ¥å°è´è´£è¯¥ä»»å¡çæ§è¡å¨ç»\n 3. éè¿æ§è¡å¨ç»æ¿å°è´è´£è¯¥ä»»å¡çæææ§è¡å¨ï¼éè¿è´è½½åè¡¡éåºä¸ä¸ªæ§è¡å¨å»æ§è¡ä»»å¡ã\n\n\n# 2. xxl_job_group\n\n\n\n * id ï¼è¯¥æ§è¡å¨ç»çid\n * app_name ï¼æ§è¡å¨ç»çapp_nameï¼å¯ä¸æ è¯ï¼å¦xxl-job-executor-sample\n * title ï¼æ§è¡å¨ç»çnameï¼å¦ç¤ºä¾æ§è¡å¨\n * address_type ï¼æ§è¡å¨ç»çæ³¨åæ¹å¼ï¼æå¨/èªå¨\n * address_list ï¼æ§è¡å¨ç»çæææ§è¡å¨IPï¼ä»¥éå·éå¼\n * update_time ï¼æ´æ°æ¶é´\n\nè¯·ä¸è¦å° app_name ä¸ title æ··ä¸ºä¸è°ï¼app_name æ¯ title æ´å éè¦ãä½ å¯ä»¥ç¿»ç¿»æä»¬ä¹åä¸ºæ§è¡å¨åçéç½®ï¼ä¸ä¸ªæ§è¡å¨å¯ä»¥ä¸éç½® title ä½æ¯ä¸å®è¦éç½® app_nameï¼å ä¸ºæ§è¡å¨éè¿ app_name æè½æ¾å°å®å±äºåªä¸ªæ§è¡å¨ç»ã\n\næ§è¡å¨çæ³¨åæµç¨ï¼\n\n 1. éè¿ app_name æ¾å°æ§è¡å¨ç»\n 2. å°èªå·±çIPå å¥è¯¥æ§è¡å¨ç»ç address_list å­æ®µ\n 3. çä¸ªæ¬å¿µ\n\n\n# 3. xxl_job_registry\n\n\n\nè¿ä¸ªè¡¨æ¯æ§è¡å¨çæ³¨åä¿¡æ¯ã\n\n * id ï¼æ³¨åä¿¡æ¯id\n * registry_group ï¼è¿ä¸ªæ§è¡å¨æ³¨åä¿¡æ¯æ¯å±äºåªä¸ªæ§è¡å¨ç»\n * registry_key ï¼æ§è¡å¨ç»ç app_name\n * registry_value ï¼è¯¥æ§è¡å¨çIPå°å\n * update_time ï¼è¯¥æ§è¡å¨çä¸ä¸æ¬¡çæ³¨åæ¶é´\n\nè¿ä¸ªè¡¨ç»´æ¤ç xxl_job ä½ç³»çå¿è·³æºå¶ï¼æä»¬æä¹ç¥éæä¸ªæ§è¡å¨æ¯å¦è¿æ´»çï¼éè¿æ¥éè¿ä¸ªè¡¨å°±å¯ä»¥ã\n\nxxl_job è§å®æ§è¡å¨è¦æ¯30sç»è°åº¦ä¸­å¿åéå¿è·³ä¿¡æ¯ï¼å¿è·³ä¿¡æ¯åéåä¼æ´æ° xxl_job_registry ç update_time å­æ®µï¼å¦æä¸æ¬¡æ²¡åéï¼ä¹å°±æ¯ update_time å­æ®µçæ¶é´è·ç¦»ç°å¨å·²ç» 90s äºï¼è®¤å®æ­¤æ§è¡å¨æ­»äº¡ï¼å°æ­¤æ§è¡å¨ç§»é¤ã\n\n\n# 4. xxl_job_log\n\n\n\n * id ï¼æ¥å¿id\n * job_group ï¼è´è´£æ­¤ä»»å¡çæ§è¡å¨ç»\n * executor_address ï¼è´è´£æ§è¡æ­¤ä»»å¡çæ§è¡å¨å°å\n * executor_handler ï¼æ­¤ä»»å¡çåç§°ãå°±æ¯ @XxlJob() æ³¨è§£éçé£ä¸ªã\n * executor_param ï¼ä»»å¡åæ°\n * executor_sharding_param ï¼åçåæ°\n * executor_fail_retry ï¼å¤±è´¥éè¯æ¬¡æ°\n * trigger_code ï¼è°åº¦ç»æ\n * handle_code ï¼æ§è¡ç»æ\n\nxxl-job è§å®ä¸ä¸ªä»»å¡çæ§è¡æä¸¤ç§ç¶æ ï¼è°åº¦ç»æãæ§è¡ç»æã\n\nè°åº¦ä¸­å¿åæ§è¡å¨æ¯éè¿ HTTP éä¿¡çï¼è¿ä¸ª HTTP æ¶æ¯åéåºå»ç®æ¯è°åº¦æåï¼æ¶æ¯è¢«æ§è¡å¨æ¶å°å¹¶æ§è¡å®æç®æ¯æ§è¡æåã\n\nå¦æè°åº¦ä¸­å¿å®æºï¼é£ä¹è°åº¦ç»æå°±æ¯å¤±è´¥ãå¦ææ§è¡å¨å®æºï¼é£ä¹æ§è¡ç»æå°±æ¯å¤±è´¥ãxxl-jobå¯ä»¥éè¿è¿ä¸¤ä¸ªå­æ®µå¤§æ¦å¤æ­å¤±è´¥ç±»åãä¾å¦ ï¼ä¸ä¸ªä»»å¡10åéåå°±è°åº¦æåäºï¼ç°å¨è¿æ²¡ææ§è¡æåï¼å¹¶ä¸æ§è¡å¨æ³¨åä¿¡æ¯å·²ç»è¶è¿90sï¼é£ä¹è¿ä¸ªæ§è¡å¨å¿ç¶å®æºäºã\n\n\n# 5. xxl_job_lock\n\n\n\næ²¡éï¼è¿ä¸ªè¡¨åªæä¸ä¸ªå­æ®µï¼è¿ä¸ªå­æ®µåªæä¸æ¡ä¿¡æ¯ã\n\nxxl-job çæè°åå¸å¼å°±æ¯é å®å®ç°çã\n\nä½ æ³åï¼å¦ææ§è¡å¨æå¾å¤ä¸ªï¼é£ä¹è°åº¦ä¸­å¿å¯ä»¥ä½¿ç¨è´è½½åè¡¡æéåºä¸ä¸ªã\n\nä½æ¯å¦æè°åº¦ä¸­å¿æå¾å¤ä¸ªå¢ï¼è°æ¥è´è´£âæéâè¿ä¸ªéè¦çäºæå¢ï¼é£ä¹å°±è¦æ¢åå¸å¼éï¼è°æ¢å°è°è°åº¦ã\n\nselect lock_name from xxl_job_lock for update\n\n\nå¦ä¸sqlè¯­å¥å°±å¯ä»¥å®ç°æ¢å åå¸å¼éåè½ãæ¯ä¸ä¸ªè°åº¦ä¸­å¿çæ¯ä¸æ¬¡è°åº¦åé½ä¼æ§è¡è¿ä¸ªsqlãæ¢å°äºå°±è°åº¦ï¼æ²¡æ¢å°å°±ç®äº~",normalizedContent:"# 0. åè¨\n\nxxl-jobä¸å±å«å¼ è¡¨ï¼\n\n 1. xxl_job_group ï¼æ§è¡å¨ç»\n 2. xxl_job_info ï¼å®æ¶ä»»å¡ä¿¡æ¯\n 3. xxl_job_lock ï¼åå¸å¼é\n 4. xxl_job_log ï¼å®æ¶ä»»å¡æ§è¡æ¥å¿\n 5. xxl_job_log_report ï¼æ§è¡æ¥å¿ç»è®¡\n 6. xxl_job_logglue ï¼glueæ¨¡å¼çæ¥å¿\n 7. xxl_job_registry ï¼æ§è¡å¨çæ³¨åä¿¡æ¯\n 8. xxl_job_user ï¼ç¨æ·ä¿¡æ¯\n\nä¸ä¼å¨é¨æ¶åï¼å¶ä¸­ xxl_job_logglueãxxl_job_userãxxl_job_log_report ä¸ä¼è®²è§£ã\n\n\n# 1. xxl_job_info\n\nè¿å¼ è¡¨æ¯å®æ¶ä»»å¡çä¿¡æ¯è¡¨ï¼å­æ®µå¦ä¸ï¼\n\n\n\n * id ï¼è¯¥ä»»å¡çid\n * job_group ï¼è¯¥ä»»å¡å³èçæ§è¡å¨ç»\n * job_desc ï¼è¯¥ä»»å¡çæè¿°\n * alarm_email ï¼åè­¦é®ç®±\n * schedule_type ï¼è°åº¦ç±»åï¼cornæ¨¡å¼ãåºå®éç\n * schedule_conf ï¼è°åº¦éç½®ï¼cornæ¨¡å¼ä¸ï¼è¯¥å¼ä¸ºcronè¡¨è¾¾å¼\n * misfire_strategy ï¼ä»»å¡è¿æç­ç¥ï¼åå¦æ§è¡å¨å®æºä»»å¡æ²¡æè®¡æ¶å¤çæä¹åã\n * executor_handler ï¼å®æ¶ä»»å¡çåç§°\n * executor_param ï¼å®æ¶ä»»å¡çåæ°\n * executor_block_strategy ï¼å®æ¶ä»»å¡é»å¡ç­ç¥\n * executor_timeout ï¼å®æ¶ä»»å¡çè¶æ¶æ¶é´\n * executor_fail_retry_count ï¼å®æ¶ä»»å¡å¤±è´¥éè¯æ¬¡æ°\n * trigger_status ï¼ä»»å¡çç¶æï¼0-åæ­¢ï¼1-è¿è¡\n * trigger_last_time ï¼ä¸æ¬¡è°åº¦æ¶é´\n * trigger_next_time ï¼ä¸æ¬¡è°åº¦æ¶é´\n\nå¼å¾æ³¨æçæ¯ï¼å¨ xxl-job ä¸­å®æ¶ä»»å¡å¹¶æ²¡æè·æ§è¡å¨ç´æ¥å³èï¼èæ¯è·æ§è¡å¨ç»å³èã\n\næ§è¡å¨ç»ä¹å°±æ¯ xxl_job_groupè¡¨ãæ¯ä¸ä¸ªæ§è¡å¨ç»ä¸­é½æ1~nå°æ§è¡å¨ï¼å®æ¶ä»»å¡çæ§è¡è¿ç¨ï¼\n\n 1. éè¿ trigger_next_time æ¥å°5ç§åå°è¦æ§è¡çä»»å¡ï¼å¦ææå®äºæ§è¡å¨é£ä¹ç´æ¥æ§è¡ã\n 2. å¦ææ²¡ææå®æ§è¡å¨ï¼éè¿ job_group æ¥å°è´è´£è¯¥ä»»å¡çæ§è¡å¨ç»\n 3. éè¿æ§è¡å¨ç»æ¿å°è´è´£è¯¥ä»»å¡çæææ§è¡å¨ï¼éè¿è´è½½åè¡¡éåºä¸ä¸ªæ§è¡å¨å»æ§è¡ä»»å¡ã\n\n\n# 2. xxl_job_group\n\n\n\n * id ï¼è¯¥æ§è¡å¨ç»çid\n * app_name ï¼æ§è¡å¨ç»çapp_nameï¼å¯ä¸æ è¯ï¼å¦xxl-job-executor-sample\n * title ï¼æ§è¡å¨ç»çnameï¼å¦ç¤ºä¾æ§è¡å¨\n * address_type ï¼æ§è¡å¨ç»çæ³¨åæ¹å¼ï¼æå¨/èªå¨\n * address_list ï¼æ§è¡å¨ç»çæææ§è¡å¨ipï¼ä»¥éå·éå¼\n * update_time ï¼æ´æ°æ¶é´\n\nè¯·ä¸è¦å° app_name ä¸ title æ··ä¸ºä¸è°ï¼app_name æ¯ title æ´å éè¦ãä½ å¯ä»¥ç¿»ç¿»æä»¬ä¹åä¸ºæ§è¡å¨åçéç½®ï¼ä¸ä¸ªæ§è¡å¨å¯ä»¥ä¸éç½® title ä½æ¯ä¸å®è¦éç½® app_nameï¼å ä¸ºæ§è¡å¨éè¿ app_name æè½æ¾å°å®å±äºåªä¸ªæ§è¡å¨ç»ã\n\næ§è¡å¨çæ³¨åæµç¨ï¼\n\n 1. éè¿ app_name æ¾å°æ§è¡å¨ç»\n 2. å°èªå·±çipå å¥è¯¥æ§è¡å¨ç»ç address_list å­æ®µ\n 3. çä¸ªæ¬å¿µ\n\n\n# 3. xxl_job_registry\n\n\n\nè¿ä¸ªè¡¨æ¯æ§è¡å¨çæ³¨åä¿¡æ¯ã\n\n * id ï¼æ³¨åä¿¡æ¯id\n * registry_group ï¼è¿ä¸ªæ§è¡å¨æ³¨åä¿¡æ¯æ¯å±äºåªä¸ªæ§è¡å¨ç»\n * registry_key ï¼æ§è¡å¨ç»ç app_name\n * registry_value ï¼è¯¥æ§è¡å¨çipå°å\n * update_time ï¼è¯¥æ§è¡å¨çä¸ä¸æ¬¡çæ³¨åæ¶é´\n\nè¿ä¸ªè¡¨ç»´æ¤ç xxl_job ä½ç³»çå¿è·³æºå¶ï¼æä»¬æä¹ç¥éæä¸ªæ§è¡å¨æ¯å¦è¿æ´»çï¼éè¿æ¥éè¿ä¸ªè¡¨å°±å¯ä»¥ã\n\nxxl_job è§å®æ§è¡å¨è¦æ¯30sç»è°åº¦ä¸­å¿åéå¿è·³ä¿¡æ¯ï¼å¿è·³ä¿¡æ¯åéåä¼æ´æ° xxl_job_registry ç update_time å­æ®µï¼å¦æä¸æ¬¡æ²¡åéï¼ä¹å°±æ¯ update_time å­æ®µçæ¶é´è·ç¦»ç°å¨å·²ç» 90s äºï¼è®¤å®æ­¤æ§è¡å¨æ­»äº¡ï¼å°æ­¤æ§è¡å¨ç§»é¤ã\n\n\n# 4. xxl_job_log\n\n\n\n * id ï¼æ¥å¿id\n * job_group ï¼è´è´£æ­¤ä»»å¡çæ§è¡å¨ç»\n * executor_address ï¼è´è´£æ§è¡æ­¤ä»»å¡çæ§è¡å¨å°å\n * executor_handler ï¼æ­¤ä»»å¡çåç§°ãå°±æ¯ @xxljob() æ³¨è§£éçé£ä¸ªã\n * executor_param ï¼ä»»å¡åæ°\n * executor_sharding_param ï¼åçåæ°\n * executor_fail_retry ï¼å¤±è´¥éè¯æ¬¡æ°\n * trigger_code ï¼è°åº¦ç»æ\n * handle_code ï¼æ§è¡ç»æ\n\nxxl-job è§å®ä¸ä¸ªä»»å¡çæ§è¡æä¸¤ç§ç¶æ ï¼è°åº¦ç»æãæ§è¡ç»æã\n\nè°åº¦ä¸­å¿åæ§è¡å¨æ¯éè¿ http éä¿¡çï¼è¿ä¸ª http æ¶æ¯åéåºå»ç®æ¯è°åº¦æåï¼æ¶æ¯è¢«æ§è¡å¨æ¶å°å¹¶æ§è¡å®æç®æ¯æ§è¡æåã\n\nå¦æè°åº¦ä¸­å¿å®æºï¼é£ä¹è°åº¦ç»æå°±æ¯å¤±è´¥ãå¦ææ§è¡å¨å®æºï¼é£ä¹æ§è¡ç»æå°±æ¯å¤±è´¥ãxxl-jobå¯ä»¥éè¿è¿ä¸¤ä¸ªå­æ®µå¤§æ¦å¤æ­å¤±è´¥ç±»åãä¾å¦ ï¼ä¸ä¸ªä»»å¡10åéåå°±è°åº¦æåäºï¼ç°å¨è¿æ²¡ææ§è¡æåï¼å¹¶ä¸æ§è¡å¨æ³¨åä¿¡æ¯å·²ç»è¶è¿90sï¼é£ä¹è¿ä¸ªæ§è¡å¨å¿ç¶å®æºäºã\n\n\n# 5. xxl_job_lock\n\n\n\næ²¡éï¼è¿ä¸ªè¡¨åªæä¸ä¸ªå­æ®µï¼è¿ä¸ªå­æ®µåªæä¸æ¡ä¿¡æ¯ã\n\nxxl-job çæè°åå¸å¼å°±æ¯é å®å®ç°çã\n\nä½ æ³åï¼å¦ææ§è¡å¨æå¾å¤ä¸ªï¼é£ä¹è°åº¦ä¸­å¿å¯ä»¥ä½¿ç¨è´è½½åè¡¡æéåºä¸ä¸ªã\n\nä½æ¯å¦æè°åº¦ä¸­å¿æå¾å¤ä¸ªå¢ï¼è°æ¥è´è´£âæéâè¿ä¸ªéè¦çäºæå¢ï¼é£ä¹å°±è¦æ¢åå¸å¼éï¼è°æ¢å°è°è°åº¦ã\n\nselect lock_name from xxl_job_lock for update\n\n\nå¦ä¸sqlè¯­å¥å°±å¯ä»¥å®ç°æ¢å åå¸å¼éåè½ãæ¯ä¸ä¸ªè°åº¦ä¸­å¿çæ¯ä¸æ¬¡è°åº¦åé½ä¼æ§è¡è¿ä¸ªsqlãæ¢å°äºå°±è°åº¦ï¼æ²¡æ¢å°å°±ç®äº~",charsets:{cjk:!0},lastUpdated:"2023/11/20, 13:00:13",lastUpdatedTimestamp:1700456413e3},{title:"6. æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶",frontmatter:{title:"6. æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶",date:"2023-11-23T20:16:07.000Z",permalink:"/pages/a25535/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/100.XXL-JOB/6.%E6%89%A7%E8%A1%8C%E5%99%A8%E7%AB%AF%E7%9A%84%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6.html",relativePath:"02.æç« /91.æ¡æ¶/100.XXL-JOB/6.æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶.md",key:"v-18bfcd63",path:"/pages/a25535/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. XxlJobHelper",slug:"_1-xxljobhelper",normalizedTitle:"1. xxljobhelper",charIndex:285},{level:2,title:"2. XxlJobFileAppender",slug:"_2-xxljobfileappender",normalizedTitle:"2. xxljobfileappender",charIndex:1968},{level:2,title:"3. æ»ç»",slug:"_3-æ»ç»",normalizedTitle:"3. æ»ç»",charIndex:11660}],headersStr:"0. åè¨ 1. XxlJobHelper 2. XxlJobFileAppender 3. æ»ç»",content:'# 0. åè¨\n\nä¸ç¥ä¸è§ä¸ä¸ç¯æç« å°±åäº1wå­ï¼é£ä¹è¿ä¸ç¯å°±æ´ç¹ç®åçã\n\nä¸ºä»ä¹æç« çåå­å«å æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶å¢ï¼ååååä½ åºè¯¥çå°äºï¼è°åº¦ä¸­å¿åæ§è¡å¨çæ¥å¿è®°å½æ¹å¼æ¯æªç¶ä¸åçã\n\n * è°åº¦ä¸­å¿ ï¼å°æ¥å¿è®°å½å°æ°æ®åºï¼å¯ä»¥å¨webç«¯æ¾ç¤ºç»å¼åäººåçã\n * æ§è¡å¨ ï¼å°æ¥å¿è®°å½å°æ¬å°æä»¶å¤¹ä¸­\n\nä¸è¬æ¥è¯´ï¼åºç°bugé¦åçwebç«¯ä»æ°æ®åºé xxl_job_log è¡¨ä¸­æ¥åºçæ¥å¿ï¼åçæ§è¡å¨ç«¯è®°å½çæ¥å¿æä»¶ãå¦æè¿æ¯æ¾ä¸åºbugï¼å°±åªè½æ±å©å½~~\n\næ§è¡å¨çæ¥å¿ç»ä»¶è¦å°ä¸è¥¿è®°å½å°æä»¶ä¸­ï¼æä»¥é½æ¯æä»¶æä½ï¼è¿ä¸ªä¸è¥¿çæ¯æ²¡å¥è¯´çï¼è¿ä¸ç« å½ä¸ªä¹å­çå§\n\n\n# 1. XxlJobHelper\n\nåè§å°äºæä»¬çèæåï¼è¿ä¸ªå·¥å·ç±»å¨åé¢å·²ç»åºç°è¿ä¸¤æ¬¡äº\n\n 1. å¨å®æ¶ä»»å¡åé¨ä½¿ç¨ XxlJobHelper.log() è®°å½æ¥å¿\n 2. å¨ä»»å¡æ§è¡è¿ç¨ä¸­ææ XxlJobContext ï¼å¹¶æä¾æ¹å XxlJobContext çAPI\n\nè¿ä¸ç« æä»¬çéä»ç»ä¸ä¸å®è®°å½æ¥å¿æ¯å¦ä½å®ç°çãå¶å®ä¹æ¯è°å«äººçAPIã\n\npublic static boolean log(String appendLogPattern, Object ... appendLogArguments) {\n\n    FormattingTuple ft = MessageFormatter.arrayFormat(appendLogPattern, appendLogArguments);\n    String appendLog = ft.getMessage();\n\n    StackTraceElement callInfo = new Throwable().getStackTrace()[1];\n    return logDetail(callInfo, appendLog);\n}\n\nprivate static boolean logDetail(StackTraceElement callInfo, String appendLog) {\n    XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n    if (xxlJobContext == null) {\n        return false;\n    }\n    // æ¼æ¥æ¥å¿\n    StringBuffer stringBuffer = new StringBuffer();\n    stringBuffer.append(DateUtil.formatDateTime(new Date())).append(" ")\n        .append("["+ callInfo.getClassName() + "#" + callInfo.getMethodName() +"]").append("-")\n        .append("["+ callInfo.getLineNumber() +"]").append("-")\n        .append("["+ Thread.currentThread().getName() +"]").append(" ")\n        .append(appendLog!=null?appendLog:"");\n    String formatAppendLog = stringBuffer.toString();\n\n    // è·åæ¥å¿æä»¶å\n    String logFileName = xxlJobContext.getJobLogFileName();\n\t// è°ç¨ XxlJobFileAppender.appendLog() åæ¥å¿\n    if (logFileName!=null && logFileName.trim().length()>0) {\n        XxlJobFileAppender.appendLog(logFileName, formatAppendLog);\n        return true;\n    } else {\n        logger.info(">>>>>>>>>>> {}", formatAppendLog);\n        return false;\n    }\n}\n\n\nä»ä¸é¢ä»£ç çæ§è¡æµç¨å¯ä»¥çåº ï¼log -> logDetail -> XxlJobFileAppender.appendLog()\n\nä»åå­å¯ä»¥çåºæ¥ï¼XxlJobFileAppender.appendLog() çåè½æ¯ç»­åæä»¶ã\n\n\n# 2. XxlJobFileAppender\n\nè¿ä¸ªç±»å¶å®å¨ä¸ä¸ç« ä¸­åºç°è¿ï¼å¨ä»»å¡æ§è¡ä¹åæè¿æ ·ä¸æ®µä»£ç ï¼\n\nXxlJobFileAppender.makeLogFileName(Date, logId);\n\n\nä¹å°±æ¯æ ¹æ®ä»å¤©çæ¶é´åè¿ä¸ªè°åº¦åæ°çææ¥å¿æä»¶çåå­\n\n> æ³¨ ï¼è°åº¦åæ°ä¸è¯æå·²ç»å¨ä¸æè§£éè¿ï¼æç§°ä¸ä¸ªä»»å¡çä¸æ¬¡æ§è¡ä¸ºä¸ä¸ªè°åº¦åæ°\n> \n> å¦æä¸ä¸ªä»»å¡ä¸ä¸ªå°æ¶æ§è¡ä¸æ¬¡ï¼é£ä¹è¿ä¸å¤©å®ä¼äº§ç24ä¸ªè°åº¦åæ°ã\n\nå¨ xxl-job ä¸­ï¼æ¯ä¸ä¸ªè°åº¦åæ°å¨æ§è¡åé½è¦åå»ºç¬å±äºå®çæ¥å¿æä»¶ï¼å¹¶æ¾å¨ç¨æ·éç½®å¥½çæ¥å¿æä»¶å¤¹ä¸ï¼å·ä½çè·¯å¾å®ä¾å¦ä¸ï¼\n\n\\data\\applogs\\xxl-job\\jobhandler\\2023-11-20\\24.log\n\n\næä»¥ä½ä¸ºæ§è¡å¨ç«¯çæ¥å¿ç»ä»¶ï¼XxlJobFileAppender çä¸¤å¤§éè¦ä»»å¡å°±æ¯\n\n 1. çææ¥å¿æä»¶å¹¶è¿åæ¥å¿æä»¶çåå­\n    \n    å¨æ­¤å¤è¡¥åä¸ä¸ï¼JobThreadä¼å°æ¥å¿åå­å­å¥ XxlJobContext\n\n 2. æ ¹æ® XxlJobContextä¸­çæ¥å¿æä»¶å ä»¥åç¨æ·ä¼ å¥çæ¥å¿åå®¹è®°å½æ¥å¿\n\né¦åï¼xxl-job è¦å°å­å¨æææ¥å¿æä»¶çæ¥å¿æä»¶å¤¹åå»ºåºæ¥ã\n\npublic class XxlJobFileAppender {\n\tprivate static Logger logger = LoggerFactory.getLogger(XxlJobFileAppender.class);\n\t// æ¥å¿æä»¶æ ¹è·¯å¾ï¼é»è®¤æ¯/data/applogs/xxl-job/jobhandlerï¼å¯éç½®\n\tprivate static String logBasePath = "/data/applogs/xxl-job/jobhandler";\n    \n    public static String getLogPath() {\n\t\treturn logBasePath;\n\t}\n    // ä¼ å¥çåæ°æ¯ç¨æ·æå®çæä»¶å¤¹å\n    public static void initLogPath(String logPath){\n\t\t// å¦æä¸ä¸ºç©ºè¯´æç¨æ·æå®äºï¼ä½¿ç¨ä»æå®çã\n\t\tif (logPath != null && logPath.trim().length() > 0) {\n\t\t\tlogBasePath = logPath;\n\t\t}\n\t\t// å¼å§åå»ºæä»¶å¤¹\n\t\tFile logPathDir = new File(logBasePath);\n\t\tif (!logPathDir.exists()) {\n\t\t\tlogPathDir.mkdirs();\n\t\t}\n\t\tlogBasePath = logPathDir.getPath();\n\t}\n}\n\n\n * å¦æä¼ å¥çlogPathä¸ç©ºå°±ç¨è¿ä¸ª\n * å¦ææ­¤æä»¶å¤¹ä¸å­å¨å°±åå»º\n\n> ä½ ä¸å®å¾çæï¼å¦æè®©æåæå°±ç´æ¥å¨ logBasePath ä¸é¢å ä¸ä¸ª @Valueæ³¨è§£ è¯»åSpringéç½®æä»¶ä¸­çéç½®ï¼åªè¿éè¦ä¼ å¥åãå¯¹ï¼ä½ è¯´çæ¯ä¸ç§æ¹æ¡ï¼ä½æ¯ä¸ºä»ä¹ä¸è¿æ ·åå¢ï¼æèä¸ä¸ã\n\næ¥ä¸æ¥æ¯çææ¥å¿æä»¶åçä»£ç ï¼éè¦ä¼ å¥æ¥æåæ¥å¿idã\n\npublic class XxlJobFileAppender {\n\tprivate static Logger logger = LoggerFactory.getLogger(XxlJobFileAppender.class);\n\t// æ¥å¿æä»¶æ ¹è·¯å¾ï¼é»è®¤æ¯/data/applogs/xxl-job/jobhandlerï¼å¯éç½®\n\tprivate static String logBasePath = "/data/applogs/xxl-job/jobhandler";\n    \n    public static String getLogPath() {\n\t\treturn logBasePath;\n\t}\n    // ä¼ å¥çåæ°æ¯ç¨æ·æå®çæä»¶å¤¹å\n    public static void initLogPath(String logPath){\n\t\t// å¦æä¸ä¸ºç©ºè¯´æç¨æ·æå®äºï¼ä½¿ç¨ä»æå®çã\n\t\tif (logPath!=null && logPath.trim().length()>0) {\n\t\t\tlogBasePath = logPath;\n\t\t}\n\t\t// å¼å§åå»ºæä»¶å¤¹\n\t\tFile logPathDir = new File(logBasePath);\n\t\tif (!logPathDir.exists()) {\n\t\t\tlogPathDir.mkdirs();\n\t\t}\n\t\tlogBasePath = logPathDir.getPath();\n\t}\n    // æ ¹æ®æ¥æåæ¥å¿idçæå¯¹åºä»»å¡çæ§è¡çæ¥å¿\n    // çæçè·¯å¾ä¸º: /yyyy-MM-dd/logId.log\n\tpublic static String makeLogFileName(Date triggerDate, long logId) {\n\t\t// ææ¥ææ ¼å¼åä¸ä¸\n\t\tSimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");\t\n        // æ²¡ææä»¶å¤¹å°±åå»ºä¸ä¸ª\n\t\tFile logFilePath = new File(getLogPath(), sdf.format(triggerDate));\n\t\tif (!logFilePath.exists()) {\n\t\t\tlogFilePath.mkdir();\n\t\t}\n\n        // æ¼æ¥æä»¶å\n\t\t// filePath/yyyy-MM-dd/9999.log\n\t\tString logFileName = logFilePath.getPath()\n\t\t\t\t.concat(File.separator)\n\t\t\t\t.concat(String.valueOf(logId))\n\t\t\t\t.concat(".log");\n\t\treturn logFileName;\n\t}\n}\n\n\næç»çæçæä»¶åå¯è½ä¸º ï¼\\data\\applogs\\xxl-job\\jobhandler\\2023-11-20\\24.log\n\n> æè ï¼ä¸ºä»ä¹æ¥å¿æä»¶ä½¿ç¨ logId å½åèä¸ç¨ jobIdï¼\n> \n> å¦ææçé®å¯ä»¥è¯¢é®æå~ä¹å¯ä»¥å¨githubé¾æ¥æissueã\n\næ¥ä¸æ¥å°±æ¯è®°å½æ¥å¿ï¼ç°å¨æ¥è¯´ä¸ä¸ä¸ºå¥è®°å½æ¥å¿éè¦è¿è¡ç»­åå¢ï¼å ä¸ºè®°å½æ¥å¿è¿éè¦å¨æ§è¡ä»»å¡åè®°å½ãæ§è¡ä»»å¡åè®°å½ãæä»¥å¿é¡»ç»­å\n\nå¦ä¸ä¸ºæªåç JobThread æ§è¡ä»»å¡ååçé»è¾ï¼ä¸å±æä¸å¤è®°å½æ¥å¿çä»£ç ã\n\n\n\n> show me code\n\npublic static void appendLog(String logFileName, String appendLog) {\n    // log file\n    if (logFileName==null || logFileName.trim().length()==0) {\n        return;\n    }\n    File logFile = new File(logFileName);\n\n    if (!logFile.exists()) {\n        try {\n            logFile.createNewFile();\n        } catch (IOException e) {\n            logger.error(e.getMessage(), e);\n            return;\n        }\n    }\n\n    // log\n    if (appendLog == null) {\n        appendLog = "";\n    }\n    appendLog += "\\r\\n";\n\n    // append file content\n    FileOutputStream fos = null;\n    try {\n        fos = new FileOutputStream(logFile, true);\n        fos.write(appendLog.getBytes("utf-8"));\n        fos.flush();\n    } catch (Exception e) {\n        logger.error(e.getMessage(), e);\n    } finally {\n        if (fos != null) {\n            try {\n                fos.close();\n            } catch (IOException e) {\n                logger.error(e.getMessage(), e);\n            }\n        }\n    }\n\n}\n\n\nè¿åºè¯¥ä¸éè¦è®²å§ï¼é¤äº fos = new FileOutputStream(logFile, true) è¿ä¸ªtrueä»£è¡¨ç»­åï¼å¶ä»çæ²¡å¥äºã\n\né¤äºåå¥ï¼è¿è¦æè¯»åï¼è¿ä¸ªè¯»åæ¯è¦è¢«è°åº¦ä¸­å¿ä½¿ç¨çï¼ä¹å°±æ¯webç«¯å¯è½è¦çï¼æä»¥æä»¬è¦å°è£ä¸ä¸ªç±»æ¾è¿äºæ°æ®ï¼\n\npublic class LogResult implements Serializable {\n    private static final long serialVersionUID = 42L;\n\n    /**\n     * æ¥å¿å¼å§çè¡æ°\n     */\n    private int fromLineNum;\n\n    /**\n     * æ¥å¿ç»æçè¡æ°\n     */\n    private int toLineNum;\n\n    /**\n     * æ¥å¿åå®¹\n     */\n    private String logContent;\n\n    /**\n     * æ¯å¦ä¸ºç»å°¾\n     */\n    private boolean isEnd;\n}\n\n\næ¥ä¸æ¥å°±æ¯å°æä»¶ä¸­çåå®¹è¯»åç» LogResultã\n\npublic static LogResult readLog(String logFileName, int fromLineNum){\n\n    // valid log file\n    if (logFileName==null || logFileName.trim().length()==0) {\n        return new LogResult(fromLineNum, 0, "readLog fail, logFile not found", true);\n    }\n    File logFile = new File(logFileName);\n\n    if (!logFile.exists()) {\n        return new LogResult(fromLineNum, 0, "readLog fail, logFile not exists", true);\n    }\n\n    // read file\n    StringBuffer logContentBuffer = new StringBuffer();\n    int toLineNum = 0;\n    LineNumberReader reader = null;\n    try {\n        //reader = new LineNumberReader(new FileReader(logFile));\n        reader = new LineNumberReader(new InputStreamReader(new FileInputStream(logFile), "utf-8"));\n        String line = null;\n\n        while ((line = reader.readLine())!=null) {\n            toLineNum = reader.getLineNumber();\t\t// [from, to], start as 1\n            if (toLineNum >= fromLineNum) {\n                logContentBuffer.append(line).append("\\n");\n            }\n        }\n    } catch (IOException e) {\n        logger.error(e.getMessage(), e);\n    } finally {\n        if (reader != null) {\n            try {\n                reader.close();\n            } catch (IOException e) {\n                logger.error(e.getMessage(), e);\n            }\n        }\n    }\n\n    // result\n    LogResult logResult = new LogResult(fromLineNum, toLineNum, logContentBuffer.toString(), false);\n    return logResult;\n\n}\n\n\né£ä¹æ´ä½çä»£ç ï¼\n\npublic class XxlJobFileAppender {\n\tprivate static Logger logger = LoggerFactory.getLogger(XxlJobFileAppender.class);\n\t// æ¥å¿æä»¶æ ¹è·¯å¾ï¼é»è®¤æ¯/data/applogs/xxl-job/jobhandlerï¼å¯éç½®\n\tprivate static String logBasePath = "/data/applogs/xxl-job/jobhandler";\n    \n    public static String getLogPath() {\n\t\treturn logBasePath;\n\t}\n    // ä¼ å¥çåæ°æ¯ç¨æ·æå®çæä»¶å¤¹å\n    public static void initLogPath(String logPath){\n\t\t// å¦æä¸ä¸ºç©ºè¯´æç¨æ·æå®äºï¼ä½¿ç¨ä»æå®çã\n\t\tif (logPath!=null && logPath.trim().length()>0) {\n\t\t\tlogBasePath = logPath;\n\t\t}\n\t\t// å¼å§åå»ºæä»¶å¤¹\n\t\tFile logPathDir = new File(logBasePath);\n\t\tif (!logPathDir.exists()) {\n\t\t\tlogPathDir.mkdirs();\n\t\t}\n\t\tlogBasePath = logPathDir.getPath();\n\t}\n    // æ ¹æ®æ¥æåæ¥å¿idçæå¯¹åºä»»å¡çæ§è¡çæ¥å¿\n    // çæçè·¯å¾ä¸º: /yyyy-MM-dd/logId.log\n\tpublic static String makeLogFileName(Date triggerDate, long logId) {\n\t\t// ææ¥ææ ¼å¼åä¸ä¸\n\t\tSimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");\t\n        // æ²¡ææä»¶å¤¹å°±åå»ºä¸ä¸ª\n\t\tFile logFilePath = new File(getLogPath(), sdf.format(triggerDate));\n\t\tif (!logFilePath.exists()) {\n\t\t\tlogFilePath.mkdir();\n\t\t}\n\n        // æ¼æ¥æä»¶å\n\t\t// filePath/yyyy-MM-dd/9999.log\n\t\tString logFileName = logFilePath.getPath()\n\t\t\t\t.concat(File.separator)\n\t\t\t\t.concat(String.valueOf(logId))\n\t\t\t\t.concat(".log");\n\t\treturn logFileName;\n\t}\n    public static void appendLog(String logFileName, String appendLog) {\n        // log file\n        if (logFileName==null || logFileName.trim().length()==0) {\n            return;\n        }\n        File logFile = new File(logFileName);\n\n        if (!logFile.exists()) {\n            try {\n                logFile.createNewFile();\n            } catch (IOException e) {\n                logger.error(e.getMessage(), e);\n                return;\n            }\n        }\n\n        // log\n        if (appendLog == null) {\n            appendLog = "";\n        }\n        appendLog += "\\r\\n";\n\n        // append file content\n        FileOutputStream fos = null;\n        try {\n            fos = new FileOutputStream(logFile, true);\n            fos.write(appendLog.getBytes("utf-8"));\n            fos.flush();\n        } catch (Exception e) {\n            logger.error(e.getMessage(), e);\n        } finally {\n            if (fos != null) {\n                try {\n                    fos.close();\n                } catch (IOException e) {\n                    logger.error(e.getMessage(), e);\n                }\n            }\n        }\n\n    }\n    public static LogResult readLog(String logFileName, int fromLineNum){\n\n        // valid log file\n        if (logFileName==null || logFileName.trim().length()==0) {\n            return new LogResult(fromLineNum, 0, "readLog fail, logFile not found", true);\n        }\n        File logFile = new File(logFileName);\n\n        if (!logFile.exists()) {\n            return new LogResult(fromLineNum, 0, "readLog fail, logFile not exists", true);\n        }\n\n        // read file\n        StringBuffer logContentBuffer = new StringBuffer();\n        int toLineNum = 0;\n        LineNumberReader reader = null;\n        try {\n            //reader = new LineNumberReader(new FileReader(logFile));\n            reader = new LineNumberReader(new InputStreamReader(new FileInputStream(logFile), "utf-8"));\n            String line = null;\n\n            while ((line = reader.readLine())!=null) {\n                toLineNum = reader.getLineNumber();\t\t// [from, to], start as 1\n                if (toLineNum >= fromLineNum) {\n                    logContentBuffer.append(line).append("\\n");\n                }\n            }\n        } catch (IOException e) {\n            logger.error(e.getMessage(), e);\n        } finally {\n            if (reader != null) {\n                try {\n                    reader.close();\n                } catch (IOException e) {\n                    logger.error(e.getMessage(), e);\n                }\n            }\n        }\n\n        // result\n        LogResult logResult = new LogResult(fromLineNum, toLineNum, logContentBuffer.toString(), false);\n        return logResult;\n\n    }\n}\n\n\n\n# 3. æ»ç»\n\nè°ç¨é»è¾ ï¼\n\n 1. è°åº¦ä¸­å¿æ¥å°å°è¦æ§è¡çä»»å¡ï¼çææ¥å¿æ°æ®å­å¥æ°æ®åºï¼æ­¤æ¶å·²ç»æäºæ¥å¿idï¼å°ä¿¡æ¯å°è£ä¸ºè°åº¦åæ°åç»æ§è¡å¨\n\n 2. æ§è¡å¨æ¿å°è°åº¦åæ°æ¾å¥é»å¡éåä¸­ç­å¾æ§è¡ï¼ååºåæ­£å¼å¼å§æ§è¡é»è¾ ï¼\n    \n    * ç»æ­¤è°åº¦åæ°çæä¸ä¸ªæ¥å¿æä»¶ï¼ä¾å¦æä»¶åä¸º2023-11-20/24.logï¼\n    * åå»ºä¸ä¸ª XxlJobContextï¼ä¸é¨æ¾æ°æ®\n    * å°æ¥å¿åå­å­å¥ XxlJobContext\n\n 3. ä½¿ç¨ XxlJobHelper.log() è®°å½ä»»å¡æ§è¡è¿ç¨ä¸­çæ¥å¿ï¼XxlJobHelper é¦åä½¿ç¨ xxlJobContext.getJobLogFileName() æ¿å°æ¥å¿æä»¶åï¼åéè¿ appendLog(String logFileName, String appendLog) å°æ¥å¿ç»­åå¥æä»¶ã',normalizedContent:'# 0. åè¨\n\nä¸ç¥ä¸è§ä¸ä¸ç¯æç« å°±åäº1wå­ï¼é£ä¹è¿ä¸ç¯å°±æ´ç¹ç®åçã\n\nä¸ºä»ä¹æç« çåå­å«å æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶å¢ï¼ååååä½ åºè¯¥çå°äºï¼è°åº¦ä¸­å¿åæ§è¡å¨çæ¥å¿è®°å½æ¹å¼æ¯æªç¶ä¸åçã\n\n * è°åº¦ä¸­å¿ ï¼å°æ¥å¿è®°å½å°æ°æ®åºï¼å¯ä»¥å¨webç«¯æ¾ç¤ºç»å¼åäººåçã\n * æ§è¡å¨ ï¼å°æ¥å¿è®°å½å°æ¬å°æä»¶å¤¹ä¸­\n\nä¸è¬æ¥è¯´ï¼åºç°bugé¦åçwebç«¯ä»æ°æ®åºé xxl_job_log è¡¨ä¸­æ¥åºçæ¥å¿ï¼åçæ§è¡å¨ç«¯è®°å½çæ¥å¿æä»¶ãå¦æè¿æ¯æ¾ä¸åºbugï¼å°±åªè½æ±å©å½~~\n\næ§è¡å¨çæ¥å¿ç»ä»¶è¦å°ä¸è¥¿è®°å½å°æä»¶ä¸­ï¼æä»¥é½æ¯æä»¶æä½ï¼è¿ä¸ªä¸è¥¿çæ¯æ²¡å¥è¯´çï¼è¿ä¸ç« å½ä¸ªä¹å­çå§\n\n\n# 1. xxljobhelper\n\nåè§å°äºæä»¬çèæåï¼è¿ä¸ªå·¥å·ç±»å¨åé¢å·²ç»åºç°è¿ä¸¤æ¬¡äº\n\n 1. å¨å®æ¶ä»»å¡åé¨ä½¿ç¨ xxljobhelper.log() è®°å½æ¥å¿\n 2. å¨ä»»å¡æ§è¡è¿ç¨ä¸­ææ xxljobcontext ï¼å¹¶æä¾æ¹å xxljobcontext çapi\n\nè¿ä¸ç« æä»¬çéä»ç»ä¸ä¸å®è®°å½æ¥å¿æ¯å¦ä½å®ç°çãå¶å®ä¹æ¯è°å«äººçapiã\n\npublic static boolean log(string appendlogpattern, object ... appendlogarguments) {\n\n    formattingtuple ft = messageformatter.arrayformat(appendlogpattern, appendlogarguments);\n    string appendlog = ft.getmessage();\n\n    stacktraceelement callinfo = new throwable().getstacktrace()[1];\n    return logdetail(callinfo, appendlog);\n}\n\nprivate static boolean logdetail(stacktraceelement callinfo, string appendlog) {\n    xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n    if (xxljobcontext == null) {\n        return false;\n    }\n    // æ¼æ¥æ¥å¿\n    stringbuffer stringbuffer = new stringbuffer();\n    stringbuffer.append(dateutil.formatdatetime(new date())).append(" ")\n        .append("["+ callinfo.getclassname() + "#" + callinfo.getmethodname() +"]").append("-")\n        .append("["+ callinfo.getlinenumber() +"]").append("-")\n        .append("["+ thread.currentthread().getname() +"]").append(" ")\n        .append(appendlog!=null?appendlog:"");\n    string formatappendlog = stringbuffer.tostring();\n\n    // è·åæ¥å¿æä»¶å\n    string logfilename = xxljobcontext.getjoblogfilename();\n\t// è°ç¨ xxljobfileappender.appendlog() åæ¥å¿\n    if (logfilename!=null && logfilename.trim().length()>0) {\n        xxljobfileappender.appendlog(logfilename, formatappendlog);\n        return true;\n    } else {\n        logger.info(">>>>>>>>>>> {}", formatappendlog);\n        return false;\n    }\n}\n\n\nä»ä¸é¢ä»£ç çæ§è¡æµç¨å¯ä»¥çåº ï¼log -> logdetail -> xxljobfileappender.appendlog()\n\nä»åå­å¯ä»¥çåºæ¥ï¼xxljobfileappender.appendlog() çåè½æ¯ç»­åæä»¶ã\n\n\n# 2. xxljobfileappender\n\nè¿ä¸ªç±»å¶å®å¨ä¸ä¸ç« ä¸­åºç°è¿ï¼å¨ä»»å¡æ§è¡ä¹åæè¿æ ·ä¸æ®µä»£ç ï¼\n\nxxljobfileappender.makelogfilename(date, logid);\n\n\nä¹å°±æ¯æ ¹æ®ä»å¤©çæ¶é´åè¿ä¸ªè°åº¦åæ°çææ¥å¿æä»¶çåå­\n\n> æ³¨ ï¼è°åº¦åæ°ä¸è¯æå·²ç»å¨ä¸æè§£éè¿ï¼æç§°ä¸ä¸ªä»»å¡çä¸æ¬¡æ§è¡ä¸ºä¸ä¸ªè°åº¦åæ°\n> \n> å¦æä¸ä¸ªä»»å¡ä¸ä¸ªå°æ¶æ§è¡ä¸æ¬¡ï¼é£ä¹è¿ä¸å¤©å®ä¼äº§ç24ä¸ªè°åº¦åæ°ã\n\nå¨ xxl-job ä¸­ï¼æ¯ä¸ä¸ªè°åº¦åæ°å¨æ§è¡åé½è¦åå»ºç¬å±äºå®çæ¥å¿æä»¶ï¼å¹¶æ¾å¨ç¨æ·éç½®å¥½çæ¥å¿æä»¶å¤¹ä¸ï¼å·ä½çè·¯å¾å®ä¾å¦ä¸ï¼\n\n\\data\\applogs\\xxl-job\\jobhandler\\2023-11-20\\24.log\n\n\næä»¥ä½ä¸ºæ§è¡å¨ç«¯çæ¥å¿ç»ä»¶ï¼xxljobfileappender çä¸¤å¤§éè¦ä»»å¡å°±æ¯\n\n 1. çææ¥å¿æä»¶å¹¶è¿åæ¥å¿æä»¶çåå­\n    \n    å¨æ­¤å¤è¡¥åä¸ä¸ï¼jobthreadä¼å°æ¥å¿åå­å­å¥ xxljobcontext\n\n 2. æ ¹æ® xxljobcontextä¸­çæ¥å¿æä»¶å ä»¥åç¨æ·ä¼ å¥çæ¥å¿åå®¹è®°å½æ¥å¿\n\né¦åï¼xxl-job è¦å°å­å¨æææ¥å¿æä»¶çæ¥å¿æä»¶å¤¹åå»ºåºæ¥ã\n\npublic class xxljobfileappender {\n\tprivate static logger logger = loggerfactory.getlogger(xxljobfileappender.class);\n\t// æ¥å¿æä»¶æ ¹è·¯å¾ï¼é»è®¤æ¯/data/applogs/xxl-job/jobhandlerï¼å¯éç½®\n\tprivate static string logbasepath = "/data/applogs/xxl-job/jobhandler";\n    \n    public static string getlogpath() {\n\t\treturn logbasepath;\n\t}\n    // ä¼ å¥çåæ°æ¯ç¨æ·æå®çæä»¶å¤¹å\n    public static void initlogpath(string logpath){\n\t\t// å¦æä¸ä¸ºç©ºè¯´æç¨æ·æå®äºï¼ä½¿ç¨ä»æå®çã\n\t\tif (logpath != null && logpath.trim().length() > 0) {\n\t\t\tlogbasepath = logpath;\n\t\t}\n\t\t// å¼å§åå»ºæä»¶å¤¹\n\t\tfile logpathdir = new file(logbasepath);\n\t\tif (!logpathdir.exists()) {\n\t\t\tlogpathdir.mkdirs();\n\t\t}\n\t\tlogbasepath = logpathdir.getpath();\n\t}\n}\n\n\n * å¦æä¼ å¥çlogpathä¸ç©ºå°±ç¨è¿ä¸ª\n * å¦ææ­¤æä»¶å¤¹ä¸å­å¨å°±åå»º\n\n> ä½ ä¸å®å¾çæï¼å¦æè®©æåæå°±ç´æ¥å¨ logbasepath ä¸é¢å ä¸ä¸ª @valueæ³¨è§£ è¯»åspringéç½®æä»¶ä¸­çéç½®ï¼åªè¿éè¦ä¼ å¥åãå¯¹ï¼ä½ è¯´çæ¯ä¸ç§æ¹æ¡ï¼ä½æ¯ä¸ºä»ä¹ä¸è¿æ ·åå¢ï¼æèä¸ä¸ã\n\næ¥ä¸æ¥æ¯çææ¥å¿æä»¶åçä»£ç ï¼éè¦ä¼ å¥æ¥æåæ¥å¿idã\n\npublic class xxljobfileappender {\n\tprivate static logger logger = loggerfactory.getlogger(xxljobfileappender.class);\n\t// æ¥å¿æä»¶æ ¹è·¯å¾ï¼é»è®¤æ¯/data/applogs/xxl-job/jobhandlerï¼å¯éç½®\n\tprivate static string logbasepath = "/data/applogs/xxl-job/jobhandler";\n    \n    public static string getlogpath() {\n\t\treturn logbasepath;\n\t}\n    // ä¼ å¥çåæ°æ¯ç¨æ·æå®çæä»¶å¤¹å\n    public static void initlogpath(string logpath){\n\t\t// å¦æä¸ä¸ºç©ºè¯´æç¨æ·æå®äºï¼ä½¿ç¨ä»æå®çã\n\t\tif (logpath!=null && logpath.trim().length()>0) {\n\t\t\tlogbasepath = logpath;\n\t\t}\n\t\t// å¼å§åå»ºæä»¶å¤¹\n\t\tfile logpathdir = new file(logbasepath);\n\t\tif (!logpathdir.exists()) {\n\t\t\tlogpathdir.mkdirs();\n\t\t}\n\t\tlogbasepath = logpathdir.getpath();\n\t}\n    // æ ¹æ®æ¥æåæ¥å¿idçæå¯¹åºä»»å¡çæ§è¡çæ¥å¿\n    // çæçè·¯å¾ä¸º: /yyyy-mm-dd/logid.log\n\tpublic static string makelogfilename(date triggerdate, long logid) {\n\t\t// ææ¥ææ ¼å¼åä¸ä¸\n\t\tsimpledateformat sdf = new simpledateformat("yyyy-mm-dd");\t\n        // æ²¡ææä»¶å¤¹å°±åå»ºä¸ä¸ª\n\t\tfile logfilepath = new file(getlogpath(), sdf.format(triggerdate));\n\t\tif (!logfilepath.exists()) {\n\t\t\tlogfilepath.mkdir();\n\t\t}\n\n        // æ¼æ¥æä»¶å\n\t\t// filepath/yyyy-mm-dd/9999.log\n\t\tstring logfilename = logfilepath.getpath()\n\t\t\t\t.concat(file.separator)\n\t\t\t\t.concat(string.valueof(logid))\n\t\t\t\t.concat(".log");\n\t\treturn logfilename;\n\t}\n}\n\n\næç»çæçæä»¶åå¯è½ä¸º ï¼\\data\\applogs\\xxl-job\\jobhandler\\2023-11-20\\24.log\n\n> æè ï¼ä¸ºä»ä¹æ¥å¿æä»¶ä½¿ç¨ logid å½åèä¸ç¨ jobidï¼\n> \n> å¦ææçé®å¯ä»¥è¯¢é®æå~ä¹å¯ä»¥å¨githubé¾æ¥æissueã\n\næ¥ä¸æ¥å°±æ¯è®°å½æ¥å¿ï¼ç°å¨æ¥è¯´ä¸ä¸ä¸ºå¥è®°å½æ¥å¿éè¦è¿è¡ç»­åå¢ï¼å ä¸ºè®°å½æ¥å¿è¿éè¦å¨æ§è¡ä»»å¡åè®°å½ãæ§è¡ä»»å¡åè®°å½ãæä»¥å¿é¡»ç»­å\n\nå¦ä¸ä¸ºæªåç jobthread æ§è¡ä»»å¡ååçé»è¾ï¼ä¸å±æä¸å¤è®°å½æ¥å¿çä»£ç ã\n\n\n\n> show me code\n\npublic static void appendlog(string logfilename, string appendlog) {\n    // log file\n    if (logfilename==null || logfilename.trim().length()==0) {\n        return;\n    }\n    file logfile = new file(logfilename);\n\n    if (!logfile.exists()) {\n        try {\n            logfile.createnewfile();\n        } catch (ioexception e) {\n            logger.error(e.getmessage(), e);\n            return;\n        }\n    }\n\n    // log\n    if (appendlog == null) {\n        appendlog = "";\n    }\n    appendlog += "\\r\\n";\n\n    // append file content\n    fileoutputstream fos = null;\n    try {\n        fos = new fileoutputstream(logfile, true);\n        fos.write(appendlog.getbytes("utf-8"));\n        fos.flush();\n    } catch (exception e) {\n        logger.error(e.getmessage(), e);\n    } finally {\n        if (fos != null) {\n            try {\n                fos.close();\n            } catch (ioexception e) {\n                logger.error(e.getmessage(), e);\n            }\n        }\n    }\n\n}\n\n\nè¿åºè¯¥ä¸éè¦è®²å§ï¼é¤äº fos = new fileoutputstream(logfile, true) è¿ä¸ªtrueä»£è¡¨ç»­åï¼å¶ä»çæ²¡å¥äºã\n\né¤äºåå¥ï¼è¿è¦æè¯»åï¼è¿ä¸ªè¯»åæ¯è¦è¢«è°åº¦ä¸­å¿ä½¿ç¨çï¼ä¹å°±æ¯webç«¯å¯è½è¦çï¼æä»¥æä»¬è¦å°è£ä¸ä¸ªç±»æ¾è¿äºæ°æ®ï¼\n\npublic class logresult implements serializable {\n    private static final long serialversionuid = 42l;\n\n    /**\n     * æ¥å¿å¼å§çè¡æ°\n     */\n    private int fromlinenum;\n\n    /**\n     * æ¥å¿ç»æçè¡æ°\n     */\n    private int tolinenum;\n\n    /**\n     * æ¥å¿åå®¹\n     */\n    private string logcontent;\n\n    /**\n     * æ¯å¦ä¸ºç»å°¾\n     */\n    private boolean isend;\n}\n\n\næ¥ä¸æ¥å°±æ¯å°æä»¶ä¸­çåå®¹è¯»åç» logresultã\n\npublic static logresult readlog(string logfilename, int fromlinenum){\n\n    // valid log file\n    if (logfilename==null || logfilename.trim().length()==0) {\n        return new logresult(fromlinenum, 0, "readlog fail, logfile not found", true);\n    }\n    file logfile = new file(logfilename);\n\n    if (!logfile.exists()) {\n        return new logresult(fromlinenum, 0, "readlog fail, logfile not exists", true);\n    }\n\n    // read file\n    stringbuffer logcontentbuffer = new stringbuffer();\n    int tolinenum = 0;\n    linenumberreader reader = null;\n    try {\n        //reader = new linenumberreader(new filereader(logfile));\n        reader = new linenumberreader(new inputstreamreader(new fileinputstream(logfile), "utf-8"));\n        string line = null;\n\n        while ((line = reader.readline())!=null) {\n            tolinenum = reader.getlinenumber();\t\t// [from, to], start as 1\n            if (tolinenum >= fromlinenum) {\n                logcontentbuffer.append(line).append("\\n");\n            }\n        }\n    } catch (ioexception e) {\n        logger.error(e.getmessage(), e);\n    } finally {\n        if (reader != null) {\n            try {\n                reader.close();\n            } catch (ioexception e) {\n                logger.error(e.getmessage(), e);\n            }\n        }\n    }\n\n    // result\n    logresult logresult = new logresult(fromlinenum, tolinenum, logcontentbuffer.tostring(), false);\n    return logresult;\n\n}\n\n\né£ä¹æ´ä½çä»£ç ï¼\n\npublic class xxljobfileappender {\n\tprivate static logger logger = loggerfactory.getlogger(xxljobfileappender.class);\n\t// æ¥å¿æä»¶æ ¹è·¯å¾ï¼é»è®¤æ¯/data/applogs/xxl-job/jobhandlerï¼å¯éç½®\n\tprivate static string logbasepath = "/data/applogs/xxl-job/jobhandler";\n    \n    public static string getlogpath() {\n\t\treturn logbasepath;\n\t}\n    // ä¼ å¥çåæ°æ¯ç¨æ·æå®çæä»¶å¤¹å\n    public static void initlogpath(string logpath){\n\t\t// å¦æä¸ä¸ºç©ºè¯´æç¨æ·æå®äºï¼ä½¿ç¨ä»æå®çã\n\t\tif (logpath!=null && logpath.trim().length()>0) {\n\t\t\tlogbasepath = logpath;\n\t\t}\n\t\t// å¼å§åå»ºæä»¶å¤¹\n\t\tfile logpathdir = new file(logbasepath);\n\t\tif (!logpathdir.exists()) {\n\t\t\tlogpathdir.mkdirs();\n\t\t}\n\t\tlogbasepath = logpathdir.getpath();\n\t}\n    // æ ¹æ®æ¥æåæ¥å¿idçæå¯¹åºä»»å¡çæ§è¡çæ¥å¿\n    // çæçè·¯å¾ä¸º: /yyyy-mm-dd/logid.log\n\tpublic static string makelogfilename(date triggerdate, long logid) {\n\t\t// ææ¥ææ ¼å¼åä¸ä¸\n\t\tsimpledateformat sdf = new simpledateformat("yyyy-mm-dd");\t\n        // æ²¡ææä»¶å¤¹å°±åå»ºä¸ä¸ª\n\t\tfile logfilepath = new file(getlogpath(), sdf.format(triggerdate));\n\t\tif (!logfilepath.exists()) {\n\t\t\tlogfilepath.mkdir();\n\t\t}\n\n        // æ¼æ¥æä»¶å\n\t\t// filepath/yyyy-mm-dd/9999.log\n\t\tstring logfilename = logfilepath.getpath()\n\t\t\t\t.concat(file.separator)\n\t\t\t\t.concat(string.valueof(logid))\n\t\t\t\t.concat(".log");\n\t\treturn logfilename;\n\t}\n    public static void appendlog(string logfilename, string appendlog) {\n        // log file\n        if (logfilename==null || logfilename.trim().length()==0) {\n            return;\n        }\n        file logfile = new file(logfilename);\n\n        if (!logfile.exists()) {\n            try {\n                logfile.createnewfile();\n            } catch (ioexception e) {\n                logger.error(e.getmessage(), e);\n                return;\n            }\n        }\n\n        // log\n        if (appendlog == null) {\n            appendlog = "";\n        }\n        appendlog += "\\r\\n";\n\n        // append file content\n        fileoutputstream fos = null;\n        try {\n            fos = new fileoutputstream(logfile, true);\n            fos.write(appendlog.getbytes("utf-8"));\n            fos.flush();\n        } catch (exception e) {\n            logger.error(e.getmessage(), e);\n        } finally {\n            if (fos != null) {\n                try {\n                    fos.close();\n                } catch (ioexception e) {\n                    logger.error(e.getmessage(), e);\n                }\n            }\n        }\n\n    }\n    public static logresult readlog(string logfilename, int fromlinenum){\n\n        // valid log file\n        if (logfilename==null || logfilename.trim().length()==0) {\n            return new logresult(fromlinenum, 0, "readlog fail, logfile not found", true);\n        }\n        file logfile = new file(logfilename);\n\n        if (!logfile.exists()) {\n            return new logresult(fromlinenum, 0, "readlog fail, logfile not exists", true);\n        }\n\n        // read file\n        stringbuffer logcontentbuffer = new stringbuffer();\n        int tolinenum = 0;\n        linenumberreader reader = null;\n        try {\n            //reader = new linenumberreader(new filereader(logfile));\n            reader = new linenumberreader(new inputstreamreader(new fileinputstream(logfile), "utf-8"));\n            string line = null;\n\n            while ((line = reader.readline())!=null) {\n                tolinenum = reader.getlinenumber();\t\t// [from, to], start as 1\n                if (tolinenum >= fromlinenum) {\n                    logcontentbuffer.append(line).append("\\n");\n                }\n            }\n        } catch (ioexception e) {\n            logger.error(e.getmessage(), e);\n        } finally {\n            if (reader != null) {\n                try {\n                    reader.close();\n                } catch (ioexception e) {\n                    logger.error(e.getmessage(), e);\n                }\n            }\n        }\n\n        // result\n        logresult logresult = new logresult(fromlinenum, tolinenum, logcontentbuffer.tostring(), false);\n        return logresult;\n\n    }\n}\n\n\n\n# 3. æ»ç»\n\nè°ç¨é»è¾ ï¼\n\n 1. è°åº¦ä¸­å¿æ¥å°å°è¦æ§è¡çä»»å¡ï¼çææ¥å¿æ°æ®å­å¥æ°æ®åºï¼æ­¤æ¶å·²ç»æäºæ¥å¿idï¼å°ä¿¡æ¯å°è£ä¸ºè°åº¦åæ°åç»æ§è¡å¨\n\n 2. æ§è¡å¨æ¿å°è°åº¦åæ°æ¾å¥é»å¡éåä¸­ç­å¾æ§è¡ï¼ååºåæ­£å¼å¼å§æ§è¡é»è¾ ï¼\n    \n    * ç»æ­¤è°åº¦åæ°çæä¸ä¸ªæ¥å¿æä»¶ï¼ä¾å¦æä»¶åä¸º2023-11-20/24.logï¼\n    * åå»ºä¸ä¸ª xxljobcontextï¼ä¸é¨æ¾æ°æ®\n    * å°æ¥å¿åå­å­å¥ xxljobcontext\n\n 3. ä½¿ç¨ xxljobhelper.log() è®°å½ä»»å¡æ§è¡è¿ç¨ä¸­çæ¥å¿ï¼xxljobhelper é¦åä½¿ç¨ xxljobcontext.getjoblogfilename() æ¿å°æ¥å¿æä»¶åï¼åéè¿ appendlog(string logfilename, string appendlog) å°æ¥å¿ç»­åå¥æä»¶ã',charsets:{cjk:!0},lastUpdated:"2023/11/23, 20:17:49",lastUpdatedTimestamp:1700741869e3},{title:"Nacos",frontmatter:{title:"Nacos",date:"2023-10-30T14:30:05.000Z",permalink:"/pages/243013/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/20.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/10.Nacos.html",relativePath:"02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/10.Nacos.md",key:"v-55669653",path:"/pages/243013/",headers:[{level:2,title:"0. Nacoså®è£é¨ç½²",slug:"_0-nacoså®è£é¨ç½²",normalizedTitle:"0. nacoså®è£é¨ç½²",charIndex:2},{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:1103},{level:2,title:"2. Nacosæå¡åç° å¥é¨æ¡ä¾",slug:"_2-nacosæå¡åç°-å¥é¨æ¡ä¾",normalizedTitle:"2. nacosæå¡åç° å¥é¨æ¡ä¾",charIndex:1416},{level:3,title:"2.1 çæ¬éæ©",slug:"_2-1-çæ¬éæ©",normalizedTitle:"2.1 çæ¬éæ©",charIndex:1519},{level:3,title:"2.2 åå»ºç¶å·¥ç¨",slug:"_2-2-åå»ºç¶å·¥ç¨",normalizedTitle:"2.2 åå»ºç¶å·¥ç¨",charIndex:2831},{level:3,title:"2.3 DOMAINå¯¹è±¡å±",slug:"_2-3-domainå¯¹è±¡å±",normalizedTitle:"2.3 domainå¯¹è±¡å±",charIndex:4736},{level:3,title:"2.4 æå¡æä¾è",slug:"_2-4-æå¡æä¾è",normalizedTitle:"2.4 æå¡æä¾è",charIndex:5920},{level:3,title:"2.5 æå¡æ¶è´¹è",slug:"_2-5-æå¡æ¶è´¹è",normalizedTitle:"2.5 æå¡æ¶è´¹è",charIndex:8387},{level:3,title:"2.6 è¿è¡",slug:"_2-6-è¿è¡",normalizedTitle:"2.6 è¿è¡",charIndex:11178},{level:2,title:"3. Nacosæå¡åç° é¢åæ¨¡å",slug:"_3-nacosæå¡åç°-é¢åæ¨¡å",normalizedTitle:"3. nacosæå¡åç° é¢åæ¨¡å",charIndex:11397}],headersStr:"0. Nacoså®è£é¨ç½² 1. ç®è¿° 2. Nacosæå¡åç° å¥é¨æ¡ä¾ 2.1 çæ¬éæ© 2.2 åå»ºç¶å·¥ç¨ 2.3 DOMAINå¯¹è±¡å± 2.4 æå¡æä¾è 2.5 æå¡æ¶è´¹è 2.6 è¿è¡ 3. Nacosæå¡åç° é¢åæ¨¡å",content:'# 0. Nacoså®è£é¨ç½²\n\nNacos å®ç½ï¼https://nacos.io/zh-cn/index.html\n\nNacosçæå¾ï¼\n\n\n\nå¤ªä¹±äºçä¸æï¼ç´æ¥æ¥å®è£ã\n\nNacosæºç å°å ï¼https://github.com/alibaba/nacos\n\nä¸è½½ 2.0.3 çæ¬ï¼ç¹å»ä¸è½½ï¼https://github.com/alibaba/nacos/releases/download/2.0.3/nacos-server-2.0.3.zip\n\n\n\nä¸å±æåä¸ªï¼æä»¬ä¸è½½çæ¯ç¬¬äºä¸ªï¼è¿ä¸ªé¾æ¥ä¸­åªæä¸äºéç½®æä»¶ãèæ¬ãsqlæä»¶åä¸ä¸ª jaråï¼è¿ä¸ªjaråå°±æ¯Nacosæåå¥½çã\n\nåä¸¤ä¸ªæ¯æºç ï¼ä¸è¦ä¸è½½æºç ï¼åå­¦å°±çæºç ä¸å¤ªç°å®ã\n\nè§£ååå¦ä¸ï¼\n\n\n\n- bin : åå§æåµä¸åªæè¿è¡èæ¬ã\n  - shutdown.cmd \n  - shutdown.sh \n  - startup.cmd \n  - startup.sh\n  ä»¥åç¹å»startup.cmdå°±å¯ä»¥è¿è¡ãä¸è¿å¨æ­¤ä¹åéè¦æ¹ä¸ªä¸è¥¿ãè¿è¡ä¹åè¿ä¸ªæä»¶å°±ä¼å¤ä¸äºæ¥å¿ç®å½ãå·¥ä½ç®å½ã\n  \n- conf :éç½®æä»¶ãsqlæä»¶ï¼ç¹å» startup.cmd åä¼è¯»åæ­¤å¤çéç½®æä»¶ã\n  - application.properties : Nacosç»å½æ¯ä¸ä¸ªSpringBooté¡¹ç®ï¼éè¦éç½®æä»¶ã\n  - nacos-mysql.sql : Nacosè¿è¡éè¦çéç½®ã\n\n\nåªä»ç»äºä¸¤ä¸ªéè¦ä½¿ç¨çæä»¶å¤¹ãç°å¨æä»¬è¿ä¸è½ç¹å» startup.cmd è¿è¡\n\n 1. å¨æ°æ®åºæ°å»º nacos åºã\n 2. å° conf / nacos-mysql.sql çæ°æ®å¯¼å¥ï¼ä¸å±æ12å¼ è¡¨ã\n\n\n\n 3. ä¿®æ¹ conf / application.properties æä»¶ï¼å°æ°æ®åºæ¹æèªå·±çã\n\n\n\n 4. ä¿®æ¹ bin / startup.cmdï¼å°è¿è¡æ¨¡å¼æ¹ä¸ºåæºè¿è¡ã\n\n\n\nä¹åç¹å» startup.cmd å³å¯è¿è¡ãè¿è¡æ¶å¯è½éè¦ç¹å» åè½¦é®ï¼ä¸æå°æ¥å¿çæ¶åå°±ç¹ä¸ä¸åè½¦ï¼ç´å°åºç°å¦ä¸çé¢ï¼\n\n\n\næåè®¿é® Nacos webçé¢ï¼http://localhost:8848/nacos/\n\nç¨æ·å ï¼nacos\n\nå¯ç  ï¼nacos\n\n\n\nå¦æçæ¬ä¸ä¸æ ·ï¼webçé¢ä¹å¯è½ä¸ä¸æ ·ã\n\næ³¨æ\n\nå³é­çæ¶åè¦ä½¿ç¨ ctrl + c å³é­ Nacosï¼å¦æç´æ¥åæå½ä»¤è¡ï¼ä¸æ¬¡è¿è¡å¯è½è·ä¸å¨ã\n\nä½æ¯å¦æä½ ççå¿è®° ctrl + c å³é­ï¼å¹¶å¨ä¸æ¬¡å¼å¯æ¶åºç°å¼å¸¸ï¼å°ä¹åçæ°æ®åºå æï¼éæ°å¯¼å¥å³å¯ã\n\n\n# 1. ç®è¿°\n\nNacos çä¸¤å¤§åè½ ï¼æå¡æ³¨åä¸åç°ãéç½®ä¸­å¿ã\n\næå¡æ³¨åä¸åç° ï¼æä»¬çé¡¹ç®ï¼åªè¦å¼å¥ nacos-discovery ä¾èµï¼å°±ä¼èªå¨æ³¨åå° Nacos Server ç«¯ï¼è¿èå¨webçé¢ç®¡çãåæ¶ï¼ä¸åçæå¡ä¹é´è°ç¨ä¹åå¾ç®åèµ·æ¥äºã\n\n> æè ï¼ä¸ºä»ä¹å¼å¥ nacos-discovery ä¾èµåå°±å¯ä»¥èªå¨æ³¨åäºå¢ï¼\n> \n> åå  ï¼nacos-discovery ä¼å Nacos Server ç«¯åéæ¶æ¯ï¼å¶ä¸­åå«äºèªå·±ç IPãæå¡åãå½åç©ºé´ãgroup ç­å³é®ä¿¡æ¯ãNacos Server æ¥æ¶å°åå°å¶æ³¨åå°æ°æ®åºä¸­ï¼æå¼webçé¢å°±å¯ä»¥æ¥è¯¢æ°æ®åºï¼æ¾ç¤ºå·²ç»æ³¨åçæå¡ã\n\n\n\n\n# 2. Nacosæå¡åç° å¥é¨æ¡ä¾\n\næ¬ç« èä¼å¸¦å¤§å®¶æ­å»ºä¸ä¸ª SpringCloud æå¡ï¼ç±äº SpringCloud ä¸ SpringBoot ä¹é´æçæ¬ä¾èµå³ç³»ï¼æä»¥å°½éè·æéæ©ä¸æ ·ççæ¬ã\n\n\n# 2.1 çæ¬éæ©\n\næ³¨ ï¼åä¸ä¸è¦ä¸éè§çæ¬çéæ©ãè¦ä¸ç¶è¿è¡ä¸èµ·æ¥ã\n\nspringboot çæ¬æ¥çå°åï¼https://spring.io/projects/spring-boot#learnopen in new window\n\nspringcloud çæ¬æ¥çå°åï¼https://spring.io/projects/spring-cloud#overviewopen in new window\n\nspringcloud alibaba ççæ¬æ¥çå°å ï¼https://github.com/alibaba/spring-cloud-alibaba/wiki/open in new window\n\nè¯¦ç»çæ¬å¯¹åºä¿¡æ¯æ¥çï¼https://start.spring.io/actuator/info\n\nSPRING CLOUD VERSION          SPRING CLOUD ALIBABA VERSION   SPRING BOOT VERSION\nSpring Cloud Hoxton.SR12      2.2.7.RELEASE                  2.3.12.RELEASE\nSpring Cloud Hoxton.SR8       2.2.4.RELEASE                  2.3.2.RELEASE\nSpring Cloud Greenwich.SR6    2.1.3.RELEASE                  2.1.13.RELEASE\nSpring Cloud Hoxton.SR3       2.2.1.RELEASE                  2.2.5.RELEASE\nSpring Cloud Hoxton.RELEASE   2.2.0.RELEASE                  2.2.X.RELEASE\nSpring Cloud Greenwich        2.1.2.RELEASE                  2.1.X.RELEASE\nSpring Cloud Finchley         2.0.3.RELEASE                  2.0.X.RELEASE\nSpring Cloud Edgware          1.5.1.RELEASE(åæ­¢ç»´æ¤ï¼å»ºè®®åçº§)       1.5.X.RELEASE\n\næç»ççæ¬éæ©ï¼\n\nSPRING CLOUD ALIBABA VERSION   SENTINEL   NACOS   ROCKETMQ   DUBBO    SEATA\n2.2.7.RELEASE                  1.8.1      2.0.3   4.6.1      2.7.13   1.3.0\n\nSpringCloud Alibaba ï¼2.2.7.RELEASE\n\nSpringCloud ï¼Hoxton.SR12\n\nSpringBoot ï¼2.3.12.RELEASE\n\nNacos ï¼2.0.3\n\n\n# 2.2 åå»ºç¶å·¥ç¨\n\n> å·¥ç¨å ï¼cloud-parent\n> \n> æ­¤å·¥ç¨åªè´è´£ç¡®å®ä¾èµçæ¬\n\nå¨ç¶å·¥ç¨éå® SpringBootãSpringCloudãSpringCloud Alibabaççæ¬ã\n\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <groupId>org.example</groupId>\n    <artifactId>Nacos-Learn</artifactId>\n    <version>1.0-SNAPSHOT</version>\n    <name>Archetype - Nacos-Learn</name>\n    <url>http://maven.apache.org</url>\n    \n    <modules>\n        <module>cloud-goods</module>\n        <module>cloud-entity</module>\n        <module>cloud-orders</module>\n    </modules>\n\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>2.3.12.RELEASE</version>\n        <relativePath/>\n    </parent>\n\n    \x3c!-- æåæ¹å¼ä¸ºpom --\x3e\n    <packaging>pom</packaging>\n\n    <properties>\n        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>\n        <java.version>1.8</java.version>\n    </properties>\n\n    <dependencyManagement>\n        <dependencies>\n            <dependency>\n                <groupId>com.alibaba.cloud</groupId>\n                <artifactId>spring-cloud-alibaba-dependencies</artifactId>\n                <version>2.2.7.RELEASE</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n            <dependency>\n                <groupId>org.springframework.cloud</groupId>\n                <artifactId>spring-cloud-dependencies</artifactId>\n                <version>Hoxton.SR12</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencyManagement>\n\n</project>\n\n\n\n# 2.3 DOMAINå¯¹è±¡å±\n\n> å·¥ç¨å ï¼cloud-entiry\n> \n> æ­¤å·¥ç¨ä¸­åªæå®ä½ç±»ï¼å·¥å·ç±»ç­ï¼ä¸éè¦åç¬å¯å¨ï¼ææ éç¼åå¯å¨ç±»åéç½®æä»¶ã\n\npom.xmlï¼\n\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n  <modelVersion>4.0.0</modelVersion>\n  <groupId>org.example</groupId>\n  <artifactId>cloud-entity</artifactId>\n  <version>1.0-SNAPSHOT</version>\n  <name>Archetype - cloud-entity</name>\n  <url>http://maven.apache.org</url>\n    \n  <parent>\n    <groupId>org.example</groupId>\n    <artifactId>Nacos-Learn</artifactId>\n    <version>1.0-SNAPSHOT</version>\n  </parent>\n\n  <properties>\n    <maven.compiler.source>8</maven.compiler.source>\n    <maven.compiler.target>8</maven.compiler.target>\n  </properties>\n\n  <dependencies>\n    <dependency>\n      <groupId>org.projectlombok</groupId>\n      <artifactId>lombok</artifactId>\n    </dependency>\n  </dependencies>\n    \n</project>\n\n\nå®ä½ç±» ï¼\n\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\n\n@Data\n@AllArgsConstructor\n@NoArgsConstructor\npublic class Goods {\n    private String name;\n    private Integer price;\n}\n\n\n\n\n# 2.4 æå¡æä¾è\n\n> å·¥ç¨å ï¼cloud-goods\n> \n> æ­¤å·¥ç¨æä¾ä¸ä¸ª goods æ¥è¯¢æå¡ã\n\npomæä»¶ ï¼\n\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.example</groupId>\n        <artifactId>Nacos-Learn</artifactId>\n        <version>1.0-SNAPSHOT</version>\n    </parent>\n    \n    <artifactId>cloud-goods</artifactId>\n    <name>Archetype - cloud-goods</name>\n    <url>http://maven.apache.org</url>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-actuator</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.example</groupId>\n            <artifactId>cloud-entity</artifactId>\n            <version>1.0-SNAPSHOT</version>\n        </dependency>\n    </dependencies>\n</project>\n\n\n> cloud-goods æ¨¡åä¾èµ cloud-entiry æ¨¡åï¼å®ä»¬é½å±äº cloud-parent çå­æ¨¡åã\n\napplication.ymlï¼\n\nspring:\n  application:\n    name: cloud-goods #æå¡åç§°ï¼å¿é¡»ï¼ä¿è¯å¯ä¸\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848 #æå®nacos-serverçå°å\n        username: nacos\n        password: nacos\nserver:\n  port: 9001\n\n\n> åNacos Serveræ³¨åï¼é¡¹ç®åå°±æ¯æå¡åç§°ãæ²¡ç¨Nacosæ¶å¯ä»¥ä¸æå®ï¼ä½¿ç¨ Nacos å°±å¿é¡»æå®ã\n> \n> spring.cloud.nacos.discovery ååå«å¡«å¥ Nacos Server è¿è¡ ip + port ï¼ç¨æ·ååå¯ç ã\n\nå¯å¨ç±»å æ³¨è§£ï¼\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\nimport org.springframework.cloud.client.discovery.EnableDiscoveryClient;\n\n@SpringBootApplication\n@EnableDiscoveryClient // æå¼å¼å³ï¼å¼å¯æå¡çæ³¨åä¸åç°åè½ã\npublic class GoodsApp {\n    public static void main(String[] args) {\n        SpringApplication.run(GoodsApp.class, args);\n    }\n}\n\n\n> åªæå äº @EnableDiscoveryClient æä¼èªå¨æ³¨ååä¸æå¡åç°ã\n\næ¥è¯¢ååæ¥å£ï¼\n\n@RestController\n@RequestMapping("goods")\npublic class GoodsController {\n\n    @RequestMapping("findById/{id}")\n    public Goods findById(@PathVariable String id){\n\n        System.out.println("id"+id);\n        return  new Goods("å°ç±³", 99);\n    }\n\n}\n\n\n\n# 2.5 æå¡æ¶è´¹è\n\n> å·¥ç¨å ï¼cloud-orders\n> \n> è®¢åæ¨¡åï¼å®è¦è°ç¨ååæ¨¡åï¼è¿è¡ååä¸ååçæ¥è¯¢ã\n\npomä¾èµï¼\n\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n    <modelVersion>4.0.0</modelVersion>\n    <parent>\n        <groupId>org.example</groupId>\n        <artifactId>Nacos-Learn</artifactId>\n        <version>1.0-SNAPSHOT</version>\n    </parent>\n    <artifactId>cloud-orders</artifactId>\n    <name>Archetype - cloud-orders</name>\n    <url>http://maven.apache.org</url>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-web</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-actuator</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>com.alibaba.cloud</groupId>\n            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n        </dependency>\n        <dependency>\n            <groupId>org.example</groupId>\n            <artifactId>cloud-entity</artifactId>\n            <version>1.0-SNAPSHOT</version>\n        </dependency>\n    </dependencies>\n</project>\n\n\napplication.yml ï¼\n\nspring:\n  application:\n    name: cloud-orders  #æå¡çåºç¨åç§°\n  cloud:\n    nacos:\n      discovery: #nacoséç½®\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n\nserver:\n  port: 9002\n\n\n> æ­¤æå¡çåç§°ä¸º cloud-orders\n\nå¯å¨ç±»å æ³¨è§£ï¼\n\n@SpringBootApplication\n@EnableDiscoveryClient\npublic class OrdersApp {\n\n    /**\n     * æ³¨å¥ rest template åéè¯·æ±\n     * @return\n     */\n    @Bean\n    @LoadBalanced\n    public RestTemplate restTemplate() {\n        return new RestTemplate();\n    }\n\n    public static void main(String[] args) {\n        SpringApplication.run(OrdersApp.class, args);\n    }\n}\n\n\næä»¬åå®¹å¨ä¸­æ³¨å¥äº RestTemplateï¼å®æ¯SpringéæHttpClientçå·¥å·ï¼ç¨äºåéHTTPè¯·æ±ã\n\n> æ³¨æ ï¼å¨ RestTemplate ä¸å¿é¡»å  @LoadBalanced æ³¨è§£ï¼å¦åä¼åºç° java.net.UnknownHostException å¼å¸¸ã\n\nå¨ controller ä¸­è°ç¨cloud-goodsä¸­çæå¡ï¼\n\n@Slf4j\n@RestController\n@RequestMapping("/order")\npublic class OrderController {\n\n    @Resource\n    private RestTemplate restTemplate;\n\n    @RequestMapping("save")\n    public Map save() {\n        // ä» cloud-goods æå¡ä¸­è·åååä¿¡æ¯\n        String url = "http://cloud-goods/goods/findById/1";\n        Goods goods = restTemplate.getForObject(url, Goods.class);\n        log.info("Goods: {}", goods);\n        // ä¿å­è®¢å\n        return new HashMap() {\n            {\n                put("code", 200);\n                put("message", "success");\n            }\n        };\n    }\n}\n\n\nä»£ç ä¸­ç url ä¹å¯ä»¥æ¯ http://127.0.0.1:9001/goods/findById/1ï¼ä½æ¯å ä¸ºæä»¬ä½¿ç¨Nacosç®¡çäºæ¨¡åï¼æ¥æäºæå¡åç°çåè½ï¼ ææ ip + port å¯ä»¥ä½¿ç¨æå¡åä»£æ¿ã\n\n\n# 2.6 è¿è¡\n\nè¿è¡ GoodsApp å OrderApp åï¼æå¼Nacos webç«¯ ï¼\n\n\n\nå¯ä»¥çå° cloud-goodsãcloud-order å·²ç»è¢« Nacos ç®¡çãæ­¤æ¶ä½ å¯ä»¥ä½¿ç¨ Postmanåéè¯·æ±ï¼è®¿é® orders é£ä¸ªæ¥å£ï¼å°±å¯ä»¥è·åæ°æ®ã\n\næå¼ Nacos çæ°æ®åºï¼ä½ ä¼åç°å¹¶æ²¡æåºç°è¿ä¸¤ä¸ªæå¡ï¼å ä¸º Nacos ä¼å° å¾®æå¡çæ³¨åæ°æ®ä¿å­å¨åå­ä¸­ï¼ç¸å³ç æå¡éç½®æ°æ® ä¼ä¿å­å¨æ°æ®åºä¸­ã\n\n\n# 3. Nacosæå¡åç° é¢åæ¨¡å\n\næå¡åç°çé¢åæ¨¡åä¸ºï¼namespace > group > serviceãå³ï¼å½åç©ºé´ > ç» > æå¡\n\næä»¬ä½¿ç¨ç cloud-orderãcloud-goods å°±æ¯æä½çº§çserviceãä½æ¯ä¸é¢æä»¬å¹¶æ²¡æä½¿ç¨/éç½® namespaceãgroupã\n\nå ä¸º Nacos æé»è®¤ç namespace å groupã\n\né¢åæ¨¡å               é»è®¤å¼\nnamespace ï¼å½åç©ºé´ï¼   public\ngroup ï¼ç»ï¼          DEFAULT_GROUP\n\næå¼webç«¯çå½åç©ºé´ï¼å³å¯çå°ä¸åçå½åç©ºé´ï¼publicç©ºé´æ¯é»è®¤ä¹æ¯ä¿çï¼ä¸å¯å é¤ã\n\n\n\nå¯ä»¥æ°å»ºå½åç©ºé´ï¼å¦å¾æç¤ºæ¯ææ°å»ºç devã\n\næ°å»ºçnamespaceï¼å½åç©ºé´ï¼å¯ä»¥å¨æ°æ®åºè¡¨ tenant_info ä¸­çå°ã\n\nå¨æå¡åè¡¨ä¸­çæå¡ä¸­ï¼ä¹å°±å¯ä»¥çå°ä¸åçç»ï¼\n\n\n\næä»¥ï¼ä¸ä¸ªæå¡ï¼å®ç âå¨éå®ç±»åâ åºè¯¥ä¸ºï¼namespace.group.serviceã\n\næ¯å¦ public.DEFAULT_GROUP.cloud-orderã\n\n> å½æä»¬æ²¡æå¨ymlæä»¶ä¸­æå® namespace å group æ¶ï¼è¯¥æå¡ä½¿ç¨ä¸é¢çé»è®¤çé¢åæ¨¡åã\n> \n> namespace ï¼public\n> \n> group ï¼DEFAULT_GROUP\n\nå½æä»¬ä¿®æ¹ymléç½®ä¸­ç namespace å group åï¼\n\nserver:\n  port: 9001\n\n\nspring:\n  application:\n    name: cloud-goods # æ³¨åå° Nacos çæå¡åç§°\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        ## namespaceå¡«åçæ¯å½åç©ºé´çidï¼idå¨webç«¯æï¼å¯ä»¥ç´æ¥å¤å¶\n        namespace: 93f4848e-ef28-4b9c-811e-8ef82324a17b\n        group: shangcheng\n\n\nserver:\n  port: 9002\n\n\nspring:\n  application:\n    name: cloud-orders\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        ## namespaceå¡«åçæ¯å½åç©ºé´çidï¼idå¨webç«¯æï¼å¯ä»¥ç´æ¥å¤å¶\n        namespace: 93f4848e-ef28-4b9c-811e-8ef82324a17b\n        group: shangcheng\n\n\næå°è¿ä¸¤ä¸ªæå¡çå½åç©ºé´æ¹ä¸º devï¼åç»åç§°æ¹ä¸º shangchengã\n\n\n\nå¯ä»¥çå°ï¼åæ¬å¨publicå½åç©ºé´ä¸­çæå¡è½¬ç§»å°äºdevãå¹¶ä¸è¿ä¸¤ä¸ªæå¡çgroupä¹åäºã\n\nå¦æä½ åºç°äºè¿ç§æåµï¼\n\n\n\nä¸é¢ä¸¤ä¸ªæ¯åæ¥çå®ä¾ï¼ä¸é¢ä¸¤ä¸ªæ¯ææ°çå®ä¾ãè¿æ¯ä¸ºä»ä¹ï¼\n\n> å¯¹äºæå¡èè¨ï¼éè¦ä»¥ 5s/æ¬¡ çé¢çåæ³¨åä¸­å¿åéå¿è·³ï¼å¦æ 15s é½æ²¡ææ¶å°å¿è·³ï¼ä¼å°æ­¤æå¡æ è®°ä¸ºä¸å¥åº·ï¼å¦æ 30s é½æ²¡ææ¥æ¶å°å¿è·³ï¼æä¼å°æ­¤æå¡å é¤ã\n> \n> ä¸é¢ä¸¤ä¸ªè¢«æ è®°ä¸ºæ©è²çæå¡å°±æ¯ä¸å¥åº·å®ä¾ï¼åæ¶ç±äºæä»¬ä¿®æ¹äºæå¡ç namespace å groupï¼å®ä»¬å·²ç»ä¸æ¯åæ¥çæå¡äºãæä»¥å°±ä¼æåä¸ªã',normalizedContent:'# 0. nacoså®è£é¨ç½²\n\nnacos å®ç½ï¼https://nacos.io/zh-cn/index.html\n\nnacosçæå¾ï¼\n\n\n\nå¤ªä¹±äºçä¸æï¼ç´æ¥æ¥å®è£ã\n\nnacosæºç å°å ï¼https://github.com/alibaba/nacos\n\nä¸è½½ 2.0.3 çæ¬ï¼ç¹å»ä¸è½½ï¼https://github.com/alibaba/nacos/releases/download/2.0.3/nacos-server-2.0.3.zip\n\n\n\nä¸å±æåä¸ªï¼æä»¬ä¸è½½çæ¯ç¬¬äºä¸ªï¼è¿ä¸ªé¾æ¥ä¸­åªæä¸äºéç½®æä»¶ãèæ¬ãsqlæä»¶åä¸ä¸ª jaråï¼è¿ä¸ªjaråå°±æ¯nacosæåå¥½çã\n\nåä¸¤ä¸ªæ¯æºç ï¼ä¸è¦ä¸è½½æºç ï¼åå­¦å°±çæºç ä¸å¤ªç°å®ã\n\nè§£ååå¦ä¸ï¼\n\n\n\n- bin : åå§æåµä¸åªæè¿è¡èæ¬ã\n  - shutdown.cmd \n  - shutdown.sh \n  - startup.cmd \n  - startup.sh\n  ä»¥åç¹å»startup.cmdå°±å¯ä»¥è¿è¡ãä¸è¿å¨æ­¤ä¹åéè¦æ¹ä¸ªä¸è¥¿ãè¿è¡ä¹åè¿ä¸ªæä»¶å°±ä¼å¤ä¸äºæ¥å¿ç®å½ãå·¥ä½ç®å½ã\n  \n- conf :éç½®æä»¶ãsqlæä»¶ï¼ç¹å» startup.cmd åä¼è¯»åæ­¤å¤çéç½®æä»¶ã\n  - application.properties : nacosç»å½æ¯ä¸ä¸ªspringbooté¡¹ç®ï¼éè¦éç½®æä»¶ã\n  - nacos-mysql.sql : nacosè¿è¡éè¦çéç½®ã\n\n\nåªä»ç»äºä¸¤ä¸ªéè¦ä½¿ç¨çæä»¶å¤¹ãç°å¨æä»¬è¿ä¸è½ç¹å» startup.cmd è¿è¡\n\n 1. å¨æ°æ®åºæ°å»º nacos åºã\n 2. å° conf / nacos-mysql.sql çæ°æ®å¯¼å¥ï¼ä¸å±æ12å¼ è¡¨ã\n\n\n\n 3. ä¿®æ¹ conf / application.properties æä»¶ï¼å°æ°æ®åºæ¹æèªå·±çã\n\n\n\n 4. ä¿®æ¹ bin / startup.cmdï¼å°è¿è¡æ¨¡å¼æ¹ä¸ºåæºè¿è¡ã\n\n\n\nä¹åç¹å» startup.cmd å³å¯è¿è¡ãè¿è¡æ¶å¯è½éè¦ç¹å» åè½¦é®ï¼ä¸æå°æ¥å¿çæ¶åå°±ç¹ä¸ä¸åè½¦ï¼ç´å°åºç°å¦ä¸çé¢ï¼\n\n\n\næåè®¿é® nacos webçé¢ï¼http://localhost:8848/nacos/\n\nç¨æ·å ï¼nacos\n\nå¯ç  ï¼nacos\n\n\n\nå¦æçæ¬ä¸ä¸æ ·ï¼webçé¢ä¹å¯è½ä¸ä¸æ ·ã\n\næ³¨æ\n\nå³é­çæ¶åè¦ä½¿ç¨ ctrl + c å³é­ nacosï¼å¦æç´æ¥åæå½ä»¤è¡ï¼ä¸æ¬¡è¿è¡å¯è½è·ä¸å¨ã\n\nä½æ¯å¦æä½ ççå¿è®° ctrl + c å³é­ï¼å¹¶å¨ä¸æ¬¡å¼å¯æ¶åºç°å¼å¸¸ï¼å°ä¹åçæ°æ®åºå æï¼éæ°å¯¼å¥å³å¯ã\n\n\n# 1. ç®è¿°\n\nnacos çä¸¤å¤§åè½ ï¼æå¡æ³¨åä¸åç°ãéç½®ä¸­å¿ã\n\næå¡æ³¨åä¸åç° ï¼æä»¬çé¡¹ç®ï¼åªè¦å¼å¥ nacos-discovery ä¾èµï¼å°±ä¼èªå¨æ³¨åå° nacos server ç«¯ï¼è¿èå¨webçé¢ç®¡çãåæ¶ï¼ä¸åçæå¡ä¹é´è°ç¨ä¹åå¾ç®åèµ·æ¥äºã\n\n> æè ï¼ä¸ºä»ä¹å¼å¥ nacos-discovery ä¾èµåå°±å¯ä»¥èªå¨æ³¨åäºå¢ï¼\n> \n> åå  ï¼nacos-discovery ä¼å nacos server ç«¯åéæ¶æ¯ï¼å¶ä¸­åå«äºèªå·±ç ipãæå¡åãå½åç©ºé´ãgroup ç­å³é®ä¿¡æ¯ãnacos server æ¥æ¶å°åå°å¶æ³¨åå°æ°æ®åºä¸­ï¼æå¼webçé¢å°±å¯ä»¥æ¥è¯¢æ°æ®åºï¼æ¾ç¤ºå·²ç»æ³¨åçæå¡ã\n\n\n\n\n# 2. nacosæå¡åç° å¥é¨æ¡ä¾\n\næ¬ç« èä¼å¸¦å¤§å®¶æ­å»ºä¸ä¸ª springcloud æå¡ï¼ç±äº springcloud ä¸ springboot ä¹é´æçæ¬ä¾èµå³ç³»ï¼æä»¥å°½éè·æéæ©ä¸æ ·ççæ¬ã\n\n\n# 2.1 çæ¬éæ©\n\næ³¨ ï¼åä¸ä¸è¦ä¸éè§çæ¬çéæ©ãè¦ä¸ç¶è¿è¡ä¸èµ·æ¥ã\n\nspringboot çæ¬æ¥çå°åï¼https://spring.io/projects/spring-boot#learnopen in new window\n\nspringcloud çæ¬æ¥çå°åï¼https://spring.io/projects/spring-cloud#overviewopen in new window\n\nspringcloud alibaba ççæ¬æ¥çå°å ï¼https://github.com/alibaba/spring-cloud-alibaba/wiki/open in new window\n\nè¯¦ç»çæ¬å¯¹åºä¿¡æ¯æ¥çï¼https://start.spring.io/actuator/info\n\nspring cloud version          spring cloud alibaba version   spring boot version\nspring cloud hoxton.sr12      2.2.7.release                  2.3.12.release\nspring cloud hoxton.sr8       2.2.4.release                  2.3.2.release\nspring cloud greenwich.sr6    2.1.3.release                  2.1.13.release\nspring cloud hoxton.sr3       2.2.1.release                  2.2.5.release\nspring cloud hoxton.release   2.2.0.release                  2.2.x.release\nspring cloud greenwich        2.1.2.release                  2.1.x.release\nspring cloud finchley         2.0.3.release                  2.0.x.release\nspring cloud edgware          1.5.1.release(åæ­¢ç»´æ¤ï¼å»ºè®®åçº§)       1.5.x.release\n\næç»ççæ¬éæ©ï¼\n\nspring cloud alibaba version   sentinel   nacos   rocketmq   dubbo    seata\n2.2.7.release                  1.8.1      2.0.3   4.6.1      2.7.13   1.3.0\n\nspringcloud alibaba ï¼2.2.7.release\n\nspringcloud ï¼hoxton.sr12\n\nspringboot ï¼2.3.12.release\n\nnacos ï¼2.0.3\n\n\n# 2.2 åå»ºç¶å·¥ç¨\n\n> å·¥ç¨å ï¼cloud-parent\n> \n> æ­¤å·¥ç¨åªè´è´£ç¡®å®ä¾èµçæ¬\n\nå¨ç¶å·¥ç¨éå® springbootãspringcloudãspringcloud alibabaççæ¬ã\n\n<project xmlns="http://maven.apache.org/pom/4.0.0" xmlns:xsi="http://www.w3.org/2001/xmlschema-instance"\n         xsi:schemalocation="http://maven.apache.org/pom/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n    <modelversion>4.0.0</modelversion>\n    <groupid>org.example</groupid>\n    <artifactid>nacos-learn</artifactid>\n    <version>1.0-snapshot</version>\n    <name>archetype - nacos-learn</name>\n    <url>http://maven.apache.org</url>\n    \n    <modules>\n        <module>cloud-goods</module>\n        <module>cloud-entity</module>\n        <module>cloud-orders</module>\n    </modules>\n\n    <parent>\n        <groupid>org.springframework.boot</groupid>\n        <artifactid>spring-boot-starter-parent</artifactid>\n        <version>2.3.12.release</version>\n        <relativepath/>\n    </parent>\n\n    \x3c!-- æåæ¹å¼ä¸ºpom --\x3e\n    <packaging>pom</packaging>\n\n    <properties>\n        <project.build.sourceencoding>utf-8</project.build.sourceencoding>\n        <project.reporting.outputencoding>utf-8</project.reporting.outputencoding>\n        <java.version>1.8</java.version>\n    </properties>\n\n    <dependencymanagement>\n        <dependencies>\n            <dependency>\n                <groupid>com.alibaba.cloud</groupid>\n                <artifactid>spring-cloud-alibaba-dependencies</artifactid>\n                <version>2.2.7.release</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n            <dependency>\n                <groupid>org.springframework.cloud</groupid>\n                <artifactid>spring-cloud-dependencies</artifactid>\n                <version>hoxton.sr12</version>\n                <type>pom</type>\n                <scope>import</scope>\n            </dependency>\n        </dependencies>\n    </dependencymanagement>\n\n</project>\n\n\n\n# 2.3 domainå¯¹è±¡å±\n\n> å·¥ç¨å ï¼cloud-entiry\n> \n> æ­¤å·¥ç¨ä¸­åªæå®ä½ç±»ï¼å·¥å·ç±»ç­ï¼ä¸éè¦åç¬å¯å¨ï¼ææ éç¼åå¯å¨ç±»åéç½®æä»¶ã\n\npom.xmlï¼\n\n<project xmlns="http://maven.apache.org/pom/4.0.0" xmlns:xsi="http://www.w3.org/2001/xmlschema-instance"\n  xsi:schemalocation="http://maven.apache.org/pom/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n  <modelversion>4.0.0</modelversion>\n  <groupid>org.example</groupid>\n  <artifactid>cloud-entity</artifactid>\n  <version>1.0-snapshot</version>\n  <name>archetype - cloud-entity</name>\n  <url>http://maven.apache.org</url>\n    \n  <parent>\n    <groupid>org.example</groupid>\n    <artifactid>nacos-learn</artifactid>\n    <version>1.0-snapshot</version>\n  </parent>\n\n  <properties>\n    <maven.compiler.source>8</maven.compiler.source>\n    <maven.compiler.target>8</maven.compiler.target>\n  </properties>\n\n  <dependencies>\n    <dependency>\n      <groupid>org.projectlombok</groupid>\n      <artifactid>lombok</artifactid>\n    </dependency>\n  </dependencies>\n    \n</project>\n\n\nå®ä½ç±» ï¼\n\nimport lombok.allargsconstructor;\nimport lombok.data;\nimport lombok.noargsconstructor;\n\n\n@data\n@allargsconstructor\n@noargsconstructor\npublic class goods {\n    private string name;\n    private integer price;\n}\n\n\n\n\n# 2.4 æå¡æä¾è\n\n> å·¥ç¨å ï¼cloud-goods\n> \n> æ­¤å·¥ç¨æä¾ä¸ä¸ª goods æ¥è¯¢æå¡ã\n\npomæä»¶ ï¼\n\n<project xmlns="http://maven.apache.org/pom/4.0.0" xmlns:xsi="http://www.w3.org/2001/xmlschema-instance"\n         xsi:schemalocation="http://maven.apache.org/pom/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n    <modelversion>4.0.0</modelversion>\n    <parent>\n        <groupid>org.example</groupid>\n        <artifactid>nacos-learn</artifactid>\n        <version>1.0-snapshot</version>\n    </parent>\n    \n    <artifactid>cloud-goods</artifactid>\n    <name>archetype - cloud-goods</name>\n    <url>http://maven.apache.org</url>\n\n    <dependencies>\n        <dependency>\n            <groupid>org.springframework.boot</groupid>\n            <artifactid>spring-boot-starter-web</artifactid>\n        </dependency>\n        <dependency>\n            <groupid>org.springframework.boot</groupid>\n            <artifactid>spring-boot-starter-actuator</artifactid>\n        </dependency>\n        <dependency>\n            <groupid>com.alibaba.cloud</groupid>\n            <artifactid>spring-cloud-starter-alibaba-nacos-discovery</artifactid>\n        </dependency>\n        <dependency>\n            <groupid>org.example</groupid>\n            <artifactid>cloud-entity</artifactid>\n            <version>1.0-snapshot</version>\n        </dependency>\n    </dependencies>\n</project>\n\n\n> cloud-goods æ¨¡åä¾èµ cloud-entiry æ¨¡åï¼å®ä»¬é½å±äº cloud-parent çå­æ¨¡åã\n\napplication.ymlï¼\n\nspring:\n  application:\n    name: cloud-goods #æå¡åç§°ï¼å¿é¡»ï¼ä¿è¯å¯ä¸\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848 #æå®nacos-serverçå°å\n        username: nacos\n        password: nacos\nserver:\n  port: 9001\n\n\n> ånacos serveræ³¨åï¼é¡¹ç®åå°±æ¯æå¡åç§°ãæ²¡ç¨nacosæ¶å¯ä»¥ä¸æå®ï¼ä½¿ç¨ nacos å°±å¿é¡»æå®ã\n> \n> spring.cloud.nacos.discovery ååå«å¡«å¥ nacos server è¿è¡ ip + port ï¼ç¨æ·ååå¯ç ã\n\nå¯å¨ç±»å æ³¨è§£ï¼\n\nimport org.springframework.boot.springapplication;\nimport org.springframework.boot.autoconfigure.springbootapplication;\nimport org.springframework.cloud.client.discovery.enablediscoveryclient;\n\n@springbootapplication\n@enablediscoveryclient // æå¼å¼å³ï¼å¼å¯æå¡çæ³¨åä¸åç°åè½ã\npublic class goodsapp {\n    public static void main(string[] args) {\n        springapplication.run(goodsapp.class, args);\n    }\n}\n\n\n> åªæå äº @enablediscoveryclient æä¼èªå¨æ³¨ååä¸æå¡åç°ã\n\næ¥è¯¢ååæ¥å£ï¼\n\n@restcontroller\n@requestmapping("goods")\npublic class goodscontroller {\n\n    @requestmapping("findbyid/{id}")\n    public goods findbyid(@pathvariable string id){\n\n        system.out.println("id"+id);\n        return  new goods("å°ç±³", 99);\n    }\n\n}\n\n\n\n# 2.5 æå¡æ¶è´¹è\n\n> å·¥ç¨å ï¼cloud-orders\n> \n> è®¢åæ¨¡åï¼å®è¦è°ç¨ååæ¨¡åï¼è¿è¡ååä¸ååçæ¥è¯¢ã\n\npomä¾èµï¼\n\n<project xmlns="http://maven.apache.org/pom/4.0.0" xmlns:xsi="http://www.w3.org/2001/xmlschema-instance"\n         xsi:schemalocation="http://maven.apache.org/pom/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">\n    <modelversion>4.0.0</modelversion>\n    <parent>\n        <groupid>org.example</groupid>\n        <artifactid>nacos-learn</artifactid>\n        <version>1.0-snapshot</version>\n    </parent>\n    <artifactid>cloud-orders</artifactid>\n    <name>archetype - cloud-orders</name>\n    <url>http://maven.apache.org</url>\n\n    <dependencies>\n        <dependency>\n            <groupid>org.springframework.boot</groupid>\n            <artifactid>spring-boot-starter-web</artifactid>\n        </dependency>\n        <dependency>\n            <groupid>org.springframework.boot</groupid>\n            <artifactid>spring-boot-starter-actuator</artifactid>\n        </dependency>\n        <dependency>\n            <groupid>com.alibaba.cloud</groupid>\n            <artifactid>spring-cloud-starter-alibaba-nacos-discovery</artifactid>\n        </dependency>\n        <dependency>\n            <groupid>org.example</groupid>\n            <artifactid>cloud-entity</artifactid>\n            <version>1.0-snapshot</version>\n        </dependency>\n    </dependencies>\n</project>\n\n\napplication.yml ï¼\n\nspring:\n  application:\n    name: cloud-orders  #æå¡çåºç¨åç§°\n  cloud:\n    nacos:\n      discovery: #nacoséç½®\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n\nserver:\n  port: 9002\n\n\n> æ­¤æå¡çåç§°ä¸º cloud-orders\n\nå¯å¨ç±»å æ³¨è§£ï¼\n\n@springbootapplication\n@enablediscoveryclient\npublic class ordersapp {\n\n    /**\n     * æ³¨å¥ rest template åéè¯·æ±\n     * @return\n     */\n    @bean\n    @loadbalanced\n    public resttemplate resttemplate() {\n        return new resttemplate();\n    }\n\n    public static void main(string[] args) {\n        springapplication.run(ordersapp.class, args);\n    }\n}\n\n\næä»¬åå®¹å¨ä¸­æ³¨å¥äº resttemplateï¼å®æ¯springéæhttpclientçå·¥å·ï¼ç¨äºåéhttpè¯·æ±ã\n\n> æ³¨æ ï¼å¨ resttemplate ä¸å¿é¡»å  @loadbalanced æ³¨è§£ï¼å¦åä¼åºç° java.net.unknownhostexception å¼å¸¸ã\n\nå¨ controller ä¸­è°ç¨cloud-goodsä¸­çæå¡ï¼\n\n@slf4j\n@restcontroller\n@requestmapping("/order")\npublic class ordercontroller {\n\n    @resource\n    private resttemplate resttemplate;\n\n    @requestmapping("save")\n    public map save() {\n        // ä» cloud-goods æå¡ä¸­è·åååä¿¡æ¯\n        string url = "http://cloud-goods/goods/findbyid/1";\n        goods goods = resttemplate.getforobject(url, goods.class);\n        log.info("goods: {}", goods);\n        // ä¿å­è®¢å\n        return new hashmap() {\n            {\n                put("code", 200);\n                put("message", "success");\n            }\n        };\n    }\n}\n\n\nä»£ç ä¸­ç url ä¹å¯ä»¥æ¯ http://127.0.0.1:9001/goods/findbyid/1ï¼ä½æ¯å ä¸ºæä»¬ä½¿ç¨nacosç®¡çäºæ¨¡åï¼æ¥æäºæå¡åç°çåè½ï¼ ææ ip + port å¯ä»¥ä½¿ç¨æå¡åä»£æ¿ã\n\n\n# 2.6 è¿è¡\n\nè¿è¡ goodsapp å orderapp åï¼æå¼nacos webç«¯ ï¼\n\n\n\nå¯ä»¥çå° cloud-goodsãcloud-order å·²ç»è¢« nacos ç®¡çãæ­¤æ¶ä½ å¯ä»¥ä½¿ç¨ postmanåéè¯·æ±ï¼è®¿é® orders é£ä¸ªæ¥å£ï¼å°±å¯ä»¥è·åæ°æ®ã\n\næå¼ nacos çæ°æ®åºï¼ä½ ä¼åç°å¹¶æ²¡æåºç°è¿ä¸¤ä¸ªæå¡ï¼å ä¸º nacos ä¼å° å¾®æå¡çæ³¨åæ°æ®ä¿å­å¨åå­ä¸­ï¼ç¸å³ç æå¡éç½®æ°æ® ä¼ä¿å­å¨æ°æ®åºä¸­ã\n\n\n# 3. nacosæå¡åç° é¢åæ¨¡å\n\næå¡åç°çé¢åæ¨¡åä¸ºï¼namespace > group > serviceãå³ï¼å½åç©ºé´ > ç» > æå¡\n\næä»¬ä½¿ç¨ç cloud-orderãcloud-goods å°±æ¯æä½çº§çserviceãä½æ¯ä¸é¢æä»¬å¹¶æ²¡æä½¿ç¨/éç½® namespaceãgroupã\n\nå ä¸º nacos æé»è®¤ç namespace å groupã\n\né¢åæ¨¡å               é»è®¤å¼\nnamespace ï¼å½åç©ºé´ï¼   public\ngroup ï¼ç»ï¼          default_group\n\næå¼webç«¯çå½åç©ºé´ï¼å³å¯çå°ä¸åçå½åç©ºé´ï¼publicç©ºé´æ¯é»è®¤ä¹æ¯ä¿çï¼ä¸å¯å é¤ã\n\n\n\nå¯ä»¥æ°å»ºå½åç©ºé´ï¼å¦å¾æç¤ºæ¯ææ°å»ºç devã\n\næ°å»ºçnamespaceï¼å½åç©ºé´ï¼å¯ä»¥å¨æ°æ®åºè¡¨ tenant_info ä¸­çå°ã\n\nå¨æå¡åè¡¨ä¸­çæå¡ä¸­ï¼ä¹å°±å¯ä»¥çå°ä¸åçç»ï¼\n\n\n\næä»¥ï¼ä¸ä¸ªæå¡ï¼å®ç âå¨éå®ç±»åâ åºè¯¥ä¸ºï¼namespace.group.serviceã\n\næ¯å¦ public.default_group.cloud-orderã\n\n> å½æä»¬æ²¡æå¨ymlæä»¶ä¸­æå® namespace å group æ¶ï¼è¯¥æå¡ä½¿ç¨ä¸é¢çé»è®¤çé¢åæ¨¡åã\n> \n> namespace ï¼public\n> \n> group ï¼default_group\n\nå½æä»¬ä¿®æ¹ymléç½®ä¸­ç namespace å group åï¼\n\nserver:\n  port: 9001\n\n\nspring:\n  application:\n    name: cloud-goods # æ³¨åå° nacos çæå¡åç§°\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        ## namespaceå¡«åçæ¯å½åç©ºé´çidï¼idå¨webç«¯æï¼å¯ä»¥ç´æ¥å¤å¶\n        namespace: 93f4848e-ef28-4b9c-811e-8ef82324a17b\n        group: shangcheng\n\n\nserver:\n  port: 9002\n\n\nspring:\n  application:\n    name: cloud-orders\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        ## namespaceå¡«åçæ¯å½åç©ºé´çidï¼idå¨webç«¯æï¼å¯ä»¥ç´æ¥å¤å¶\n        namespace: 93f4848e-ef28-4b9c-811e-8ef82324a17b\n        group: shangcheng\n\n\næå°è¿ä¸¤ä¸ªæå¡çå½åç©ºé´æ¹ä¸º devï¼åç»åç§°æ¹ä¸º shangchengã\n\n\n\nå¯ä»¥çå°ï¼åæ¬å¨publicå½åç©ºé´ä¸­çæå¡è½¬ç§»å°äºdevãå¹¶ä¸è¿ä¸¤ä¸ªæå¡çgroupä¹åäºã\n\nå¦æä½ åºç°äºè¿ç§æåµï¼\n\n\n\nä¸é¢ä¸¤ä¸ªæ¯åæ¥çå®ä¾ï¼ä¸é¢ä¸¤ä¸ªæ¯ææ°çå®ä¾ãè¿æ¯ä¸ºä»ä¹ï¼\n\n> å¯¹äºæå¡èè¨ï¼éè¦ä»¥ 5s/æ¬¡ çé¢çåæ³¨åä¸­å¿åéå¿è·³ï¼å¦æ 15s é½æ²¡ææ¶å°å¿è·³ï¼ä¼å°æ­¤æå¡æ è®°ä¸ºä¸å¥åº·ï¼å¦æ 30s é½æ²¡ææ¥æ¶å°å¿è·³ï¼æä¼å°æ­¤æå¡å é¤ã\n> \n> ä¸é¢ä¸¤ä¸ªè¢«æ è®°ä¸ºæ©è²çæå¡å°±æ¯ä¸å¥åº·å®ä¾ï¼åæ¶ç±äºæä»¬ä¿®æ¹äºæå¡ç namespace å groupï¼å®ä»¬å·²ç»ä¸æ¯åæ¥çæå¡äºãæä»¥å°±ä¼æåä¸ªã',charsets:{cjk:!0},lastUpdated:"2023/10/30, 14:49:00",lastUpdatedTimestamp:169864854e4},{title:"Ribbon",frontmatter:{title:"Ribbon",date:"2023-10-30T14:34:43.000Z",permalink:"/pages/afe80c/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/20.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/20.Ribbon.html",relativePath:"02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/20.Ribbon.md",key:"v-72a09f4a",path:"/pages/afe80c/",headers:[{level:2,title:"1. Ribbon ç®ä»",slug:"_1-ribbon-ç®ä»",normalizedTitle:"1. ribbon ç®ä»",charIndex:2},{level:2,title:"2. Ribbon ä½¿ç¨",slug:"_2-ribbon-ä½¿ç¨",normalizedTitle:"2. ribbon ä½¿ç¨",charIndex:393},{level:2,title:"3. Ribbon åç",slug:"_3-ribbon-åç",normalizedTitle:"3. ribbon åç",charIndex:1418}],headersStr:"1. Ribbon ç®ä» 2. Ribbon ä½¿ç¨ 3. Ribbon åç",content:'# 1. Ribbon ç®ä»\n\nRibbon æ¯ Netflix åå¸çè´è½½åè¡¡å¨ï¼ä¸º Ribbon éç½®äºæå¡æä¾èçå°ååï¼Ribbonå°±ä¼ä½¿ç¨æç§è´è½½åè¡¡ç®æ³èªå¨å¸®å©æå¡æ¶è´¹èå»è¯·æ±ãRibbon æä¾äºå¾å¤ç§è´è½½åè¡¡ç®æ³ï¼ä¾å¦è½®è¯¢ãéæºç­ï¼å½ç¶ï¼æä»¬ä¹å¯ä»¥ä¸º Ribbon å®ç°èªå®ä¹çè´è½½åè¡¡ç®æ³ã\n\nå¦æåç¬ä½¿ç¨ Ribbon ï¼é£ä¹éè¦å¼å¥ä¾èµï¼\n\n\x3c!--æ·»å ribbonçä¾èµ--\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>\n<dependency>\n\n\n\nä½æ¯å¦æä½¿ç¨äº Nacos å°±ä¸éè¦å¼å¥äºï¼å ä¸º Nacos å·²ç»éæäº Ribbonã\n\n\n# 2. Ribbon ä½¿ç¨\n\nå¨è¿è¡ä¸åæ¨¡åä¹é´çéä¿¡æ¶ï¼æä»¬ç¨å°äº RestTemplate ï¼å½æå¡æä¾èæ¯å¤å®ä¾æ¶ï¼å°±å¯ä»¥ä½¿ç¨ Ribbon è¿è¡è´è½½åè¡¡ãåªéè¦å¨æ³¨å¥ RestTemplate æ¶æ·»å  @LoadBalanced\n\n@Bean\n@LoadBalanced\npublic RestTemplate restTemplate() {\n    return new RestTemplate();\n}\n\n\nå ä¸è¿ä¸ªæ³¨è§£åï¼Ribbonå°±ä¼èªå¨è¿è¡è´è½½åè¡¡ï¼ä½¿ç¨é»è®¤çè´è½½åè¡¡ç®æ³ï¼ï¼ä½¿ç¨éå¸¸ç®åã\n\nRibbon é»è®¤éç¨çè´è½½åè¡¡ç­ç¥æ¯ è½®è¯¢ï¼å¦ææä»¬æ³è¦ä½¿ç¨å¶ä»çç­ç¥å¢ï¼\n\nRibbonä¸å±æ¯æ8ä¸­ç­ç¥ï¼\n\n\n\nä¿®æ¹ Ribbon çç­ç¥æä¸¤ç§æ¹å¼ï¼éç½®æä»¶ãéç½®ç±»ã\n\n 1. éç½®æä»¶\n    \n    å¨ymlä¸­è¿è¡éç½®ï¼\n    \n    cloud-goods: ## æå¡å\n      ribbon:\n        NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule\n    \n\n 2. éç½®ç±»\n    \n    @Configuration\n    public class RibbonRule {\n        @Bean\n        public IRule getRule() {\n            return new RandomRule();\n        }\n    }\n    \n    \n    @SpringBootApplication\n    @EnableDiscoveryClient // æå¼å¼å³ï¼å¼å¯æå¡çæ³¨åä¸åç°åè½ã\n    @RibbonClient(name="cloud-goods", configuration = {RibbonClient.class})\n    public class GoodsApp {\n        public static void main(String[] args) {\n            SpringApplication.run(GoodsApp.class, args);\n        }\n    }\n    \n\nå¯ä»¥çå°ï¼ä¿®æ¹ Ribbon çè´è½½åè¡¡ç­ç¥éè¦æå®ä¸¤ä¸ªå¼ï¼æå¡åãå·ä½çè´è½½ç­ç¥ã\n\n\n# 3. Ribbon åç\n\nå¨ä½¿ç¨ RestTemplate åéè¯·æ±æ¶æ¯è¿æ ·åç ï¼http://order-service/order/getAllOrders ï¼ä½¿ç¨ order-service æ¿ä»£å·ä½ç IP + PORT ï¼å¨åéä¹åè¯å®è¦å°å·ä½ç IP + PORT æ¿ä»£è¿å»ã\n\nç±äº Nacos éæäº Ribbonï¼Ribbon ä¼è·å¾ order-service çå¨é¨å°åï¼å¨åé http://order-service/order/getAllOrders è¯·æ±åï¼Ribbonä¼å¨ order-service çå¨é¨å°åéé¢ä½¿ç¨è´è½½åè¡¡ç­ç¥æéä¸ä¸ªå¡«åæ¿ä»£è¿å»ã\n\nRibbon ç¨äºæ¦æªè¯·æ±çç±»ï¼LoadBalancerInterceptorï¼æ¦æªå¹¶æ¿ä»£IPåï¼ä½¿ç¨ LoadBalancerClientå°è¯·æ±ååºå»ã\n\n',normalizedContent:'# 1. ribbon ç®ä»\n\nribbon æ¯ netflix åå¸çè´è½½åè¡¡å¨ï¼ä¸º ribbon éç½®äºæå¡æä¾èçå°ååï¼ribbonå°±ä¼ä½¿ç¨æç§è´è½½åè¡¡ç®æ³èªå¨å¸®å©æå¡æ¶è´¹èå»è¯·æ±ãribbon æä¾äºå¾å¤ç§è´è½½åè¡¡ç®æ³ï¼ä¾å¦è½®è¯¢ãéæºç­ï¼å½ç¶ï¼æä»¬ä¹å¯ä»¥ä¸º ribbon å®ç°èªå®ä¹çè´è½½åè¡¡ç®æ³ã\n\nå¦æåç¬ä½¿ç¨ ribbon ï¼é£ä¹éè¦å¼å¥ä¾èµï¼\n\n\x3c!--æ·»å ribbonçä¾èµ--\x3e\n<dependency>\n    <groupid>org.springframework.cloud</groupid>\n    <artifactid>spring-cloud-starter-netflix-ribbon</artifactid>\n<dependency>\n\n\n\nä½æ¯å¦æä½¿ç¨äº nacos å°±ä¸éè¦å¼å¥äºï¼å ä¸º nacos å·²ç»éæäº ribbonã\n\n\n# 2. ribbon ä½¿ç¨\n\nå¨è¿è¡ä¸åæ¨¡åä¹é´çéä¿¡æ¶ï¼æä»¬ç¨å°äº resttemplate ï¼å½æå¡æä¾èæ¯å¤å®ä¾æ¶ï¼å°±å¯ä»¥ä½¿ç¨ ribbon è¿è¡è´è½½åè¡¡ãåªéè¦å¨æ³¨å¥ resttemplate æ¶æ·»å  @loadbalanced\n\n@bean\n@loadbalanced\npublic resttemplate resttemplate() {\n    return new resttemplate();\n}\n\n\nå ä¸è¿ä¸ªæ³¨è§£åï¼ribbonå°±ä¼èªå¨è¿è¡è´è½½åè¡¡ï¼ä½¿ç¨é»è®¤çè´è½½åè¡¡ç®æ³ï¼ï¼ä½¿ç¨éå¸¸ç®åã\n\nribbon é»è®¤éç¨çè´è½½åè¡¡ç­ç¥æ¯ è½®è¯¢ï¼å¦ææä»¬æ³è¦ä½¿ç¨å¶ä»çç­ç¥å¢ï¼\n\nribbonä¸å±æ¯æ8ä¸­ç­ç¥ï¼\n\n\n\nä¿®æ¹ ribbon çç­ç¥æä¸¤ç§æ¹å¼ï¼éç½®æä»¶ãéç½®ç±»ã\n\n 1. éç½®æä»¶\n    \n    å¨ymlä¸­è¿è¡éç½®ï¼\n    \n    cloud-goods: ## æå¡å\n      ribbon:\n        nfloadbalancerruleclassname: com.netflix.loadbalancer.randomrule\n    \n\n 2. éç½®ç±»\n    \n    @configuration\n    public class ribbonrule {\n        @bean\n        public irule getrule() {\n            return new randomrule();\n        }\n    }\n    \n    \n    @springbootapplication\n    @enablediscoveryclient // æå¼å¼å³ï¼å¼å¯æå¡çæ³¨åä¸åç°åè½ã\n    @ribbonclient(name="cloud-goods", configuration = {ribbonclient.class})\n    public class goodsapp {\n        public static void main(string[] args) {\n            springapplication.run(goodsapp.class, args);\n        }\n    }\n    \n\nå¯ä»¥çå°ï¼ä¿®æ¹ ribbon çè´è½½åè¡¡ç­ç¥éè¦æå®ä¸¤ä¸ªå¼ï¼æå¡åãå·ä½çè´è½½ç­ç¥ã\n\n\n# 3. ribbon åç\n\nå¨ä½¿ç¨ resttemplate åéè¯·æ±æ¶æ¯è¿æ ·åç ï¼http://order-service/order/getallorders ï¼ä½¿ç¨ order-service æ¿ä»£å·ä½ç ip + port ï¼å¨åéä¹åè¯å®è¦å°å·ä½ç ip + port æ¿ä»£è¿å»ã\n\nç±äº nacos éæäº ribbonï¼ribbon ä¼è·å¾ order-service çå¨é¨å°åï¼å¨åé http://order-service/order/getallorders è¯·æ±åï¼ribbonä¼å¨ order-service çå¨é¨å°åéé¢ä½¿ç¨è´è½½åè¡¡ç­ç¥æéä¸ä¸ªå¡«åæ¿ä»£è¿å»ã\n\nribbon ç¨äºæ¦æªè¯·æ±çç±»ï¼loadbalancerinterceptorï¼æ¦æªå¹¶æ¿ä»£ipåï¼ä½¿ç¨ loadbalancerclientå°è¯·æ±ååºå»ã\n\n',charsets:{cjk:!0},lastUpdated:"2023/10/30, 14:49:07",lastUpdatedTimestamp:1698648547e3},{title:"OpenFeign",frontmatter:{title:"OpenFeign",date:"2023-10-30T14:35:40.000Z",permalink:"/pages/e020ec/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/20.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/30.OpenFeign.html",relativePath:"02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/30.OpenFeign.md",key:"v-0000769a",path:"/pages/e020ec/",headers:[{level:2,title:"1. Feign æ¯ä»ä¹",slug:"_1-feign-æ¯ä»ä¹",normalizedTitle:"1. feign æ¯ä»ä¹",charIndex:2},{level:2,title:"2. OpenFeign æ¯ä»ä¹",slug:"_2-openfeign-æ¯ä»ä¹",normalizedTitle:"2. openfeign æ¯ä»ä¹",charIndex:254},{level:2,title:"3. OpenFeign çä½¿ç¨",slug:"_3-openfeign-çä½¿ç¨",normalizedTitle:"3. openfeign çä½¿ç¨",charIndex:548},{level:2,title:"4. è¯·æ±è¶æ¶æ¶é´",slug:"_4-è¯·æ±è¶æ¶æ¶é´",normalizedTitle:"4. è¯·æ±è¶æ¶æ¶é´",charIndex:2128},{level:2,title:"5. å¼å¯æ¥å¿å¢å¼º",slug:"_5-å¼å¯æ¥å¿å¢å¼º",normalizedTitle:"5. å¼å¯æ¥å¿å¢å¼º",charIndex:2924},{level:2,title:"6. ä½¿ç¨å¶ä» HTTP Client",slug:"_6-ä½¿ç¨å¶ä»-http-client",normalizedTitle:"6. ä½¿ç¨å¶ä» http client",charIndex:4364},{level:2,title:"7. èªå®ä¹ è¯·æ±æ¦æªå¨",slug:"_7-èªå®ä¹-è¯·æ±æ¦æªå¨",normalizedTitle:"7. èªå®ä¹ è¯·æ±æ¦æªå¨",charIndex:5438},{level:2,title:"7. çæ­éçº§",slug:"_7-çæ­éçº§",normalizedTitle:"7. çæ­éçº§",charIndex:6458},{level:2,title:"8. å ç§ä¸åçRPCæ¹æ¡",slug:"_8-å ç§ä¸åçrpcæ¹æ¡",normalizedTitle:"8. å ç§ä¸åçrpcæ¹æ¡",charIndex:6527}],headersStr:"1. Feign æ¯ä»ä¹ 2. OpenFeign æ¯ä»ä¹ 3. OpenFeign çä½¿ç¨ 4. è¯·æ±è¶æ¶æ¶é´ 5. å¼å¯æ¥å¿å¢å¼º 6. ä½¿ç¨å¶ä» HTTP Client 7. èªå®ä¹ è¯·æ±æ¦æªå¨ 7. çæ­éçº§ 8. å ç§ä¸åçRPCæ¹æ¡",content:'# 1. Feign æ¯ä»ä¹\n\nFeign æ¨å¨ä½¿ Java HTTP å®¢æ·ç«¯éä¿¡åå¾æ´å®¹æ\n\nFeign éæäº RibbonãRestTemplate å®ç°äºè´è½½åè¡¡çæ§è¡HTTPè°ç¨ï¼åªä¸è¿å¯¹åæçæ¹å¼ï¼Ribbon + RestTemplateï¼è¿è¡äºå°è£ï¼å¼åèä¸éè¦æå¨ä½¿ç¨ RestTemplate è°ç¨æå¡ï¼èæ¯å®ä¹ä¸ä¸ªæ¥å£ï¼å¨è¿ä¸ªæ¥å£ä¸­æ æ³¨ä¸ä¸ªæ³¨è§£å³å¯å®ææå¡è°ç¨ï¼è¿æ ·æ´å é¢åæ¥å£ç¼ç¨ï¼ç®åäºå¼åã\n\nä½éæ¾çæ¯ Feign å·²ç»åæ­¢è¿­ä»£äºãOpenFeign ææ¯ä»å¤©çéç¹ã\n\n\n# 2. OpenFeign æ¯ä»ä¹\n\nç®åæ¥è¯´ï¼OpenFeign ä½¿ SpringCloud å¨ Feign çåºç¡ä¸æ¯æäº SpringMVC çæ³¨è§£ï¼å¦ @RequestMapping...\n\nOpenFeign ç @FeignClient å¯ä»¥è§£æ SpringMVC ç @RequestMapping æ³¨è§£ä¸çæ¥å£ï¼å¹¶éè¿å¨æä»£ççæ¹å¼äº§çå®ç°ç±»ï¼å®ç°ç±»ä¸­åè´è½½åè¡¡å¹¶è°ç¨æå¡ã\n\n> å®ç½ï¼https://docs.spring.io/spring-cloud-openfeign/docs/2.2.10.BUILD-SNAPSHOT/reference/html\n\n\n# 3. OpenFeign çä½¿ç¨\n\næ¥çä¹å Nacos çä¸¤ä¸ªé¡¹ç®ï¼cloud-goodsãcloud-orders æ¥å®æï¼å¨ cloud-orders ä¸­è¿ç¨è°ç¨äº cloud-goods çæå¡ãç°å¨æä»¬å°å®ä» RestTemplate æ¹ä¸º OpenFeignã\n\nç» cloud-orders æ·»å ä¾èµï¼\n\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-openfeign</artifactId>\n</dependency>\n\n\nå¨å¯å¨ç±»å ä¸æ³¨è§£ï¼@EnableFeignClients(basePackages = "xxx")\n\n@SpringBootApplication\n@EnableDiscoveryClient\n@EnableFeignClients(basePackages = "com.xiaohe.orders.api")\npublic class OrdersApp {\n    public static void main(String[] args) {\n        SpringApplication.run(OrdersApp.class, args);\n    }\n}\n\n\nå¨cloud-ordersé¡¹ç®ç com.xiaohe.orders.api åä¸åå»ºæ å° cloud-goods æå¡çæ¥å£ï¼\n\npackage com.xiaohe.orders.api;\n\nimport com.xiaohe.entity.Goods;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.RequestMapping;\n\n@FeignClient("cloud-goods") // æå®æå¡å\n@RequestMapping("/goods") // è¯·æ±è·¯å¾\npublic interface GoodsAPI {\n    @RequestMapping("/findById/{id}")\n    public Goods findById(@PathVariable("id") String id);\n}\n\n\nå¨controllerä¸­è°ç¨è¿ç¨æå¡ï¼\n\n@Slf4j\n@RestController\n@RequestMapping("/order")\npublic class OrderController {\n    @Resource\n    private GoodsAPI goodsAPI;\n\n\n    @RequestMapping("/save")\n    public Map save() {\n        // ä» cloud-goods æå¡ä¸­è·åååä¿¡æ¯\n        Goods goods = goodsAPI.findById("1");\n\n        return new HashMap() {\n            {\n                put("code", 200);\n                put("message", "success");\n                put("goods", goods);\n            }\n        };\n    }\n}\n\n\n\n# 4. è¯·æ±è¶æ¶æ¶é´\n\nç±äº OpenFeign æ¯åé HTTP è¯·æ±çå·¥å·ï¼HTTP è¯·æ±æ¯æè¶æ¶æ¶é´çï¼é»è®¤åå«æ¯è¿æ¥è¶æ¶æ¶é´10ç§ãè¯»è¶æ¶æ¶é´60ç§\n\nä½æ¯åå ä¸º OpenFeign éæäº Ribbon ï¼Ribbon çé»è®¤è¶æ¶è¿æ¥æ¶é´ãè¯»è¶æ¶æ¶é´é½æ¯æ¯1ç§ã\n\nå¨æä»¬æ²¡æç» OpenFeign æå® è¿æ¥è¶æ¶æ¶é´ãè¯»è¶æ¶æ¶é´ çæåµä¸ï¼å®é»è®¤ä½¿ç¨ Ribbon çï¼åªè¦è¢«è°ç¨çæå¡é£éæ§è¡è¶è¿äº1sï¼æ­¤æ¬¡è¯·æ±å°±ä¼æ¥éã1så®å¨æ¯å¤ªåå¼ºäºï¼æä»¥æä»¬è¦åç¬ç» OpenFeign æå®è¶æ¶æ¶é´ã\n\n 1. è®¾ç½®å¨é¨æ¥å£çè¶æ¶æ¶é´\n    \n    feign:\n      client:\n        config:\n          ## default è®¾ç½®çå¨å±è¶æ¶æ¶é´ï¼æå®æå¡åç§°å¯ä»¥è®¾ç½®åä¸ªæå¡çè¶æ¶æ¶é´\n          default:\n            connectTimeout: 5000\n            readTimeout: 5000\n    \n\n 2. ç»æä¸ªè°ç¨æå¡åç¬è®¾ç½®è¶æ¶æ¶é´ï¼\n    \n    feign:\n      client:\n        config:\n          ## default è®¾ç½®çå¨å±è¶æ¶æ¶é´ï¼æå®æå¡åç§°å¯ä»¥è®¾ç½®åä¸ªæå¡çè¶æ¶æ¶é´ : 5s\n          default:\n            connectTimeout: 5000\n            readTimeout: 5000\n          ## ä¸ºserviceCè¿ä¸ªæå¡åç¬éç½®è¶æ¶æ¶é´ : 30s\n          serviceC:\n            connectTimeout: 30000\n            readTimeout: 30000\n    \n\n\n# 5. å¼å¯æ¥å¿å¢å¼º\n\nOpenFeign æä¾äºæ¥å¿å¢å¼ºåè½ï¼é»è®¤å³é­ï¼ä¸è¿å¼åèå¨è°è¯é¶æ®µå¯ä»¥èªå·±éç½® OpenFeign çæ¥å¿çº§å«ã\n\nå¦æä¸å¼å¯ï¼åèµ·è¯·æ±çæ¶åä¸ä¼ææ¥å¿ï¼å¦æå¼å¯äºï¼å°±ä¼æå°æ­¤æ¬¡è¯·æ±çurlãè¯·æ±å¤´ãååºå¤´ç­ä¿¡æ¯ã\n\nOpenFeign çæ¥å¿çº§å«å¦ä¸ï¼\n\n 1. NONE ï¼é»è®¤ï¼ä¸æ¾ç¤ºä»»ä½æ¥å¿\n 2. BASIC ï¼ä»ä»è®°å½è¯·æ±æ¹æ³ãURLãååºç¶æç ãæ§è¡æ¶é´\n 3. HEADERS ï¼é¤äº BASIC çä¿¡æ¯ä¹å¤ï¼è¿è®°å½è¯·æ±å¤´ãååºå¤´çä¿¡æ¯ã\n 4. FULL ï¼é¤äº HEADERS çä¿¡æ¯ä¹å¤ï¼è¿è®°å½è¯·æ±åååºçæ­£æååæ°æ®ã\n\néç½®å¦ä½å¼å¯ï¼OpenFeignæä¾ä¸¤ç§å¼å¯æ¹å¼ ï¼å¨å±éç½®åå±é¨éç½®ã\n\n 1. å¨å±éç½®ï¼å äº @Configuration æ³¨è§£è¡¨ç¤ºå¨å±éç½®ï¼å¯¹æææå¡èµ·ä½ç¨\n    \n    import feign.Logger;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    \n    @Configuration\n    public class FeignConfig {\n    \n        @Bean\n        public Logger.Level feignLoggerLevel(){\n            return Logger.Level.FULL;\n        }\n    }\n    \n\n 2. å±é¨éç½® ï¼éç½®ç±»ä¸ä¸å  @Configurationï¼å¹¶ä¸å¨ä½¿ç¨èç @FeignClient ä¸­ç configuration åéæå®ä½¿ç¨è¿ä¸ªéç½®ç±»ã\n    \n    import feign.Logger; // å¯¼åä¸è¦å¯¼éäº\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.context.annotation.Configuration;\n    // è¿éæ²¡æå  @Configurationï¼ä»£è¡¨è¿æ¯æä¸ä¸ªæå¡ä¸ç¨çéç½®ç±»\n    public class GoodsFeignConfig {\n        @Bean\n        public Logger.Level feignLoggerLevel(){\n            return Logger.Level.HEADERS;\n        }\n    }\n    \n    \n    // æå®æå¡åãéç½®ç±»\n    @FeignClient(name = "cloud-goods", configuration = GoodsFeignConfig.class) \n    @RequestMapping("/goods") // è·¯å¾\n    public interface GoodsAPI {\n        @RequestMapping("/findById/{id}")\n        public Goods findById(@PathVariable("id") String id);\n    }\n    \n\n\n# 6. ä½¿ç¨å¶ä» HTTP Client\n\nOpenFeign ä½¿ç¨çHttpå®¢æ·ç«¯æ¯ JDK èªå¸¦ç HTTPURLConnectionï¼å®æ²¡æè¿æ¥æ± ï¼æ§è½åæçä¹æ¯è¾ä½ã\n\næä»¬å¯ä»¥æ¢æå¶ä»ç HTTP Clientï¼æ¯å¦ OkHttpãApacheHttpClientã\n\n 1. ä½¿ç¨ ApacheHttpClient\n    \n    æ·»å ä¾èµï¼\n    \n    \x3c!--     ä½¿ç¨Apache HttpClientæ¿æ¢Feignåçhttpclient--\x3e\n        <dependency>\n          <groupId>org.apache.httpcomponents</groupId>\n          <artifactId>httpclient</artifactId>\n        </dependency>\n        \n        <dependency>\n          <groupId>io.github.openfeign</groupId>\n          <artifactId>feign-httpclient</artifactId>\n        </dependency>\n    \n    \n    æ·»å éç½®ï¼\n    \n    feign:\n      client:\n        httpclient:\n          # å¼å¯ Http Client\n          enabled: true\n    \n\n 2. ä½¿ç¨ OkHttp\n    \n    æ·»å ä¾èµï¼\n    \n    <dependency>\n        <groupId>io.github.openfeign</groupId>\n        <artifactId>feign-okhttp</artifactId>\n    </dependency>\n    \n    \n    æ·»å éç½®;\n    \n    feign: \n      ## ç¦æ­¢ä½¿ç¨èªå¸¦ç http client\n      httpclient:\n        enabled: false\n      # Okhttpåæ°éç½®\n      okhttp:\n        enabled: true\n        max-connections: 200 # é»è®¤å¼\n        max-connections-per-route: 50 # é»è®¤å¼\n    \n\n\n# 7. èªå®ä¹ è¯·æ±æ¦æªå¨\n\nè¯·æ±æ¦æªå¨æ¯ç¨æ¥æ¦æªè¯·æ±çï¼ä»ä¹æåµä¸è¦æ¦æªæä»¬ååºå»çè¯·æ±å¢ï¼æ¯å¦æçHttpè¯·æ±å¤´ä¸­éè¦æºå¸¦æ°æ®ã\n\nä¸ä¸ªæå¸¸ç¨çåºæ¯å°±æ¯è¯·æ±å¤´ä¸­æºå¸¦tokenãcloud-orders è°ç¨ cloud-goodsï¼å¦æ cloud-goods éè¦éªè¯èº«ä»½ä¿¡æ¯ï¼ä¹å°±æ¯éè¦tokenï¼æä»¬é»è®¤ååºçè¯·æ±å¯æ²¡ætokenï¼è¿æ¶åå°±éè¦æè¯·æ±æ¦æªä¸æ¥ï¼æ token å¡è¿å»ã\n\nè¿ä¸ªæ¥å£æ¯ RequestInterceptorï¼ä¸ç®¡æ¯ç´æ¥ä»¥ Bean çæ¾å¥æ³¨å¥ï¼è¿æ¯å®ç°ä¸ä¸åæ³¨å¥ï¼åªè¦å®¹å¨ä¸­æè¿ä¸ªç±»å°±å¯ä»¥å¯¹è¯·æ±è¿è¡æ¦æªã\n\n@Slf4j\n@Configuration\npublic class OpenFeignConfig {\n    \n    @Bean\n    public RequestInterceptor requestInterceptor() {\n        \n        return requestTemplate -> {\n\n            String token;\n            // è¯·æ±æ¹\n            ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();\n            if (ObjUtil.isEmpty(requestAttributes)) {\n                return;\n            } else {\n                // è·åè¯·æ±æ¹token\n                HttpServletRequest request = requestAttributes.getRequest();\n                token = request.getHeader("Authorization");\n            }\n            // è¢«è¯·æ±æ¹è®¾ç½®tokenï¼å®ç°tokenä¸­è½¬\n            requestTemplate.header("Authorization", token);\n        };\n    }\n    \n}\n\n\n\n# 7. çæ­éçº§\n\nOpenFeign é»è®¤ä½¿ç¨ Hystrix è¿è¡çæ­éçº§ï¼ä½æ¯ææ³ç¨ Sentinel æä¹åï¼è¯·è§ä¸ä¸ç« ã\n\n\n# 8. å ç§ä¸åçRPCæ¹æ¡\n\n 1. OpenFeign ï¼\n    * åºäº HTTPåè®®ï¼Restfulé£æ ¼ï¼ ç rpcè¯·æ±å·¥å·ï¼æ°æ®éå¸¸æ¯ json æ ¼å¼\n    * ç±äºéæäº Ribbon ï¼å¯ä»¥è¿è¡è´è½½åè¡¡\n    * æå¡å®¹é ï¼æ¯æå¤ç§å®¹éï¼é»è®¤ä½¿ç¨ Hsytrixï¼ä¹éæäº Sentinel\n    * æ§è½ ï¼ä¸è¬\n 2. Dubbo ï¼\n    * åºäºèªå®ä¹çäºè¿å¶rpcåè®®\n    * æ¯æåç§è´è½½åè¡¡ç­ç¥\n    * æå¡å®¹éï¼æ¯æå¤ç§å®¹é\n    * æ§è½ï¼è¾å¥½\n 3. gRPC\n    * åºäº HTTP/2 åè®®ï¼æ¯æå¤ç§æ°æ®åºååæ ¼å¼ï¼å¦Protocol Buffersã\n    * æ¯æå¤ç§è´è½½åè¡¡ç­ç¥\n    * æå¡å®¹éï¼æ¯æå¤ç§å®¹éï¼å¦è¶æ¶ãéè¯ååæ¶ç­ç¹æ§\n    * æ§è½ ï¼å¾å¥½\n\n> éæ©æ¡æ¶åºæ ¹æ®å·ä½éæ±åé¡¹ç®ç¹ç¹æ¥å³å®ãOpenFeignéåç®åçRESTfulæå¡ï¼Dubboéåå¤§è§æ¨¡åå¸å¼ç³»ç»ï¼ègRPCéåé«æ§è½ãè·¨è¯­è¨çå¾®æå¡ãç¼ç é¾åº¦åæ§è½æ¹é¢ä¹éæ ¹æ®å¢éææ¯æ åé¡¹ç®éæ±æ¥èèã\n\nç¼ç é¾åº¦ï¼\n\nOpenFeignç¸å¯¹è¾å®¹æä¸æï¼ç¹å«éåJavaå¼åèï¼å ä¸ºå®ä¸Springæ¡æ¶éæå¾å¾å¥½ãRESTfulæå¡çå¼åéå¸¸æ¯è¾ç´è§ã\n\nDubboå¨éç½®åæ²»çæ¹é¢å¯è½æ´å¤æä¸äºï¼ä½æä¾äºæ´å¤çåè½ï¼å¦æå¡æ³¨åãå¨æä»£çç­ãéè¦æ´å¤çéç½®åç®¡çã\n\ngRPCä½¿ç¨Protocol Buffersæ¥å®ä¹æå¡æ¥å£åæ¶æ¯ï¼è¿å¯è½éè¦ä¸äºå­¦ä¹ ææ¬ãä½ä¸æ¦ææ¡ï¼å®æä¾äºå¼ºå¤§çIDLæ¯æï¼å¯ä»¥çæå®¢æ·ç«¯åæå¡ç«¯çä»£ç ï¼åå°äºæå¨ç¼ç çå·¥ä½ã',normalizedContent:'# 1. feign æ¯ä»ä¹\n\nfeign æ¨å¨ä½¿ java http å®¢æ·ç«¯éä¿¡åå¾æ´å®¹æ\n\nfeign éæäº ribbonãresttemplate å®ç°äºè´è½½åè¡¡çæ§è¡httpè°ç¨ï¼åªä¸è¿å¯¹åæçæ¹å¼ï¼ribbon + resttemplateï¼è¿è¡äºå°è£ï¼å¼åèä¸éè¦æå¨ä½¿ç¨ resttemplate è°ç¨æå¡ï¼èæ¯å®ä¹ä¸ä¸ªæ¥å£ï¼å¨è¿ä¸ªæ¥å£ä¸­æ æ³¨ä¸ä¸ªæ³¨è§£å³å¯å®ææå¡è°ç¨ï¼è¿æ ·æ´å é¢åæ¥å£ç¼ç¨ï¼ç®åäºå¼åã\n\nä½éæ¾çæ¯ feign å·²ç»åæ­¢è¿­ä»£äºãopenfeign ææ¯ä»å¤©çéç¹ã\n\n\n# 2. openfeign æ¯ä»ä¹\n\nç®åæ¥è¯´ï¼openfeign ä½¿ springcloud å¨ feign çåºç¡ä¸æ¯æäº springmvc çæ³¨è§£ï¼å¦ @requestmapping...\n\nopenfeign ç @feignclient å¯ä»¥è§£æ springmvc ç @requestmapping æ³¨è§£ä¸çæ¥å£ï¼å¹¶éè¿å¨æä»£ççæ¹å¼äº§çå®ç°ç±»ï¼å®ç°ç±»ä¸­åè´è½½åè¡¡å¹¶è°ç¨æå¡ã\n\n> å®ç½ï¼https://docs.spring.io/spring-cloud-openfeign/docs/2.2.10.build-snapshot/reference/html\n\n\n# 3. openfeign çä½¿ç¨\n\næ¥çä¹å nacos çä¸¤ä¸ªé¡¹ç®ï¼cloud-goodsãcloud-orders æ¥å®æï¼å¨ cloud-orders ä¸­è¿ç¨è°ç¨äº cloud-goods çæå¡ãç°å¨æä»¬å°å®ä» resttemplate æ¹ä¸º openfeignã\n\nç» cloud-orders æ·»å ä¾èµï¼\n\n<dependency>\n    <groupid>org.springframework.cloud</groupid>\n    <artifactid>spring-cloud-starter-openfeign</artifactid>\n</dependency>\n\n\nå¨å¯å¨ç±»å ä¸æ³¨è§£ï¼@enablefeignclients(basepackages = "xxx")\n\n@springbootapplication\n@enablediscoveryclient\n@enablefeignclients(basepackages = "com.xiaohe.orders.api")\npublic class ordersapp {\n    public static void main(string[] args) {\n        springapplication.run(ordersapp.class, args);\n    }\n}\n\n\nå¨cloud-ordersé¡¹ç®ç com.xiaohe.orders.api åä¸åå»ºæ å° cloud-goods æå¡çæ¥å£ï¼\n\npackage com.xiaohe.orders.api;\n\nimport com.xiaohe.entity.goods;\nimport org.springframework.cloud.openfeign.feignclient;\nimport org.springframework.web.bind.annotation.pathvariable;\nimport org.springframework.web.bind.annotation.requestmapping;\n\n@feignclient("cloud-goods") // æå®æå¡å\n@requestmapping("/goods") // è¯·æ±è·¯å¾\npublic interface goodsapi {\n    @requestmapping("/findbyid/{id}")\n    public goods findbyid(@pathvariable("id") string id);\n}\n\n\nå¨controllerä¸­è°ç¨è¿ç¨æå¡ï¼\n\n@slf4j\n@restcontroller\n@requestmapping("/order")\npublic class ordercontroller {\n    @resource\n    private goodsapi goodsapi;\n\n\n    @requestmapping("/save")\n    public map save() {\n        // ä» cloud-goods æå¡ä¸­è·åååä¿¡æ¯\n        goods goods = goodsapi.findbyid("1");\n\n        return new hashmap() {\n            {\n                put("code", 200);\n                put("message", "success");\n                put("goods", goods);\n            }\n        };\n    }\n}\n\n\n\n# 4. è¯·æ±è¶æ¶æ¶é´\n\nç±äº openfeign æ¯åé http è¯·æ±çå·¥å·ï¼http è¯·æ±æ¯æè¶æ¶æ¶é´çï¼é»è®¤åå«æ¯è¿æ¥è¶æ¶æ¶é´10ç§ãè¯»è¶æ¶æ¶é´60ç§\n\nä½æ¯åå ä¸º openfeign éæäº ribbon ï¼ribbon çé»è®¤è¶æ¶è¿æ¥æ¶é´ãè¯»è¶æ¶æ¶é´é½æ¯æ¯1ç§ã\n\nå¨æä»¬æ²¡æç» openfeign æå® è¿æ¥è¶æ¶æ¶é´ãè¯»è¶æ¶æ¶é´ çæåµä¸ï¼å®é»è®¤ä½¿ç¨ ribbon çï¼åªè¦è¢«è°ç¨çæå¡é£éæ§è¡è¶è¿äº1sï¼æ­¤æ¬¡è¯·æ±å°±ä¼æ¥éã1så®å¨æ¯å¤ªåå¼ºäºï¼æä»¥æä»¬è¦åç¬ç» openfeign æå®è¶æ¶æ¶é´ã\n\n 1. è®¾ç½®å¨é¨æ¥å£çè¶æ¶æ¶é´\n    \n    feign:\n      client:\n        config:\n          ## default è®¾ç½®çå¨å±è¶æ¶æ¶é´ï¼æå®æå¡åç§°å¯ä»¥è®¾ç½®åä¸ªæå¡çè¶æ¶æ¶é´\n          default:\n            connecttimeout: 5000\n            readtimeout: 5000\n    \n\n 2. ç»æä¸ªè°ç¨æå¡åç¬è®¾ç½®è¶æ¶æ¶é´ï¼\n    \n    feign:\n      client:\n        config:\n          ## default è®¾ç½®çå¨å±è¶æ¶æ¶é´ï¼æå®æå¡åç§°å¯ä»¥è®¾ç½®åä¸ªæå¡çè¶æ¶æ¶é´ : 5s\n          default:\n            connecttimeout: 5000\n            readtimeout: 5000\n          ## ä¸ºservicecè¿ä¸ªæå¡åç¬éç½®è¶æ¶æ¶é´ : 30s\n          servicec:\n            connecttimeout: 30000\n            readtimeout: 30000\n    \n\n\n# 5. å¼å¯æ¥å¿å¢å¼º\n\nopenfeign æä¾äºæ¥å¿å¢å¼ºåè½ï¼é»è®¤å³é­ï¼ä¸è¿å¼åèå¨è°è¯é¶æ®µå¯ä»¥èªå·±éç½® openfeign çæ¥å¿çº§å«ã\n\nå¦æä¸å¼å¯ï¼åèµ·è¯·æ±çæ¶åä¸ä¼ææ¥å¿ï¼å¦æå¼å¯äºï¼å°±ä¼æå°æ­¤æ¬¡è¯·æ±çurlãè¯·æ±å¤´ãååºå¤´ç­ä¿¡æ¯ã\n\nopenfeign çæ¥å¿çº§å«å¦ä¸ï¼\n\n 1. none ï¼é»è®¤ï¼ä¸æ¾ç¤ºä»»ä½æ¥å¿\n 2. basic ï¼ä»ä»è®°å½è¯·æ±æ¹æ³ãurlãååºç¶æç ãæ§è¡æ¶é´\n 3. headers ï¼é¤äº basic çä¿¡æ¯ä¹å¤ï¼è¿è®°å½è¯·æ±å¤´ãååºå¤´çä¿¡æ¯ã\n 4. full ï¼é¤äº headers çä¿¡æ¯ä¹å¤ï¼è¿è®°å½è¯·æ±åååºçæ­£æååæ°æ®ã\n\néç½®å¦ä½å¼å¯ï¼openfeignæä¾ä¸¤ç§å¼å¯æ¹å¼ ï¼å¨å±éç½®åå±é¨éç½®ã\n\n 1. å¨å±éç½®ï¼å äº @configuration æ³¨è§£è¡¨ç¤ºå¨å±éç½®ï¼å¯¹æææå¡èµ·ä½ç¨\n    \n    import feign.logger;\n    import org.springframework.context.annotation.bean;\n    import org.springframework.context.annotation.configuration;\n    \n    @configuration\n    public class feignconfig {\n    \n        @bean\n        public logger.level feignloggerlevel(){\n            return logger.level.full;\n        }\n    }\n    \n\n 2. å±é¨éç½® ï¼éç½®ç±»ä¸ä¸å  @configurationï¼å¹¶ä¸å¨ä½¿ç¨èç @feignclient ä¸­ç configuration åéæå®ä½¿ç¨è¿ä¸ªéç½®ç±»ã\n    \n    import feign.logger; // å¯¼åä¸è¦å¯¼éäº\n    import org.springframework.context.annotation.bean;\n    import org.springframework.context.annotation.configuration;\n    // è¿éæ²¡æå  @configurationï¼ä»£è¡¨è¿æ¯æä¸ä¸ªæå¡ä¸ç¨çéç½®ç±»\n    public class goodsfeignconfig {\n        @bean\n        public logger.level feignloggerlevel(){\n            return logger.level.headers;\n        }\n    }\n    \n    \n    // æå®æå¡åãéç½®ç±»\n    @feignclient(name = "cloud-goods", configuration = goodsfeignconfig.class) \n    @requestmapping("/goods") // è·¯å¾\n    public interface goodsapi {\n        @requestmapping("/findbyid/{id}")\n        public goods findbyid(@pathvariable("id") string id);\n    }\n    \n\n\n# 6. ä½¿ç¨å¶ä» http client\n\nopenfeign ä½¿ç¨çhttpå®¢æ·ç«¯æ¯ jdk èªå¸¦ç httpurlconnectionï¼å®æ²¡æè¿æ¥æ± ï¼æ§è½åæçä¹æ¯è¾ä½ã\n\næä»¬å¯ä»¥æ¢æå¶ä»ç http clientï¼æ¯å¦ okhttpãapachehttpclientã\n\n 1. ä½¿ç¨ apachehttpclient\n    \n    æ·»å ä¾èµï¼\n    \n    \x3c!--     ä½¿ç¨apache httpclientæ¿æ¢feignåçhttpclient--\x3e\n        <dependency>\n          <groupid>org.apache.httpcomponents</groupid>\n          <artifactid>httpclient</artifactid>\n        </dependency>\n        \n        <dependency>\n          <groupid>io.github.openfeign</groupid>\n          <artifactid>feign-httpclient</artifactid>\n        </dependency>\n    \n    \n    æ·»å éç½®ï¼\n    \n    feign:\n      client:\n        httpclient:\n          # å¼å¯ http client\n          enabled: true\n    \n\n 2. ä½¿ç¨ okhttp\n    \n    æ·»å ä¾èµï¼\n    \n    <dependency>\n        <groupid>io.github.openfeign</groupid>\n        <artifactid>feign-okhttp</artifactid>\n    </dependency>\n    \n    \n    æ·»å éç½®;\n    \n    feign: \n      ## ç¦æ­¢ä½¿ç¨èªå¸¦ç http client\n      httpclient:\n        enabled: false\n      # okhttpåæ°éç½®\n      okhttp:\n        enabled: true\n        max-connections: 200 # é»è®¤å¼\n        max-connections-per-route: 50 # é»è®¤å¼\n    \n\n\n# 7. èªå®ä¹ è¯·æ±æ¦æªå¨\n\nè¯·æ±æ¦æªå¨æ¯ç¨æ¥æ¦æªè¯·æ±çï¼ä»ä¹æåµä¸è¦æ¦æªæä»¬ååºå»çè¯·æ±å¢ï¼æ¯å¦æçhttpè¯·æ±å¤´ä¸­éè¦æºå¸¦æ°æ®ã\n\nä¸ä¸ªæå¸¸ç¨çåºæ¯å°±æ¯è¯·æ±å¤´ä¸­æºå¸¦tokenãcloud-orders è°ç¨ cloud-goodsï¼å¦æ cloud-goods éè¦éªè¯èº«ä»½ä¿¡æ¯ï¼ä¹å°±æ¯éè¦tokenï¼æä»¬é»è®¤ååºçè¯·æ±å¯æ²¡ætokenï¼è¿æ¶åå°±éè¦æè¯·æ±æ¦æªä¸æ¥ï¼æ token å¡è¿å»ã\n\nè¿ä¸ªæ¥å£æ¯ requestinterceptorï¼ä¸ç®¡æ¯ç´æ¥ä»¥ bean çæ¾å¥æ³¨å¥ï¼è¿æ¯å®ç°ä¸ä¸åæ³¨å¥ï¼åªè¦å®¹å¨ä¸­æè¿ä¸ªç±»å°±å¯ä»¥å¯¹è¯·æ±è¿è¡æ¦æªã\n\n@slf4j\n@configuration\npublic class openfeignconfig {\n    \n    @bean\n    public requestinterceptor requestinterceptor() {\n        \n        return requesttemplate -> {\n\n            string token;\n            // è¯·æ±æ¹\n            servletrequestattributes requestattributes = (servletrequestattributes) requestcontextholder.getrequestattributes();\n            if (objutil.isempty(requestattributes)) {\n                return;\n            } else {\n                // è·åè¯·æ±æ¹token\n                httpservletrequest request = requestattributes.getrequest();\n                token = request.getheader("authorization");\n            }\n            // è¢«è¯·æ±æ¹è®¾ç½®tokenï¼å®ç°tokenä¸­è½¬\n            requesttemplate.header("authorization", token);\n        };\n    }\n    \n}\n\n\n\n# 7. çæ­éçº§\n\nopenfeign é»è®¤ä½¿ç¨ hystrix è¿è¡çæ­éçº§ï¼ä½æ¯ææ³ç¨ sentinel æä¹åï¼è¯·è§ä¸ä¸ç« ã\n\n\n# 8. å ç§ä¸åçrpcæ¹æ¡\n\n 1. openfeign ï¼\n    * åºäº httpåè®®ï¼restfulé£æ ¼ï¼ ç rpcè¯·æ±å·¥å·ï¼æ°æ®éå¸¸æ¯ json æ ¼å¼\n    * ç±äºéæäº ribbon ï¼å¯ä»¥è¿è¡è´è½½åè¡¡\n    * æå¡å®¹é ï¼æ¯æå¤ç§å®¹éï¼é»è®¤ä½¿ç¨ hsytrixï¼ä¹éæäº sentinel\n    * æ§è½ ï¼ä¸è¬\n 2. dubbo ï¼\n    * åºäºèªå®ä¹çäºè¿å¶rpcåè®®\n    * æ¯æåç§è´è½½åè¡¡ç­ç¥\n    * æå¡å®¹éï¼æ¯æå¤ç§å®¹é\n    * æ§è½ï¼è¾å¥½\n 3. grpc\n    * åºäº http/2 åè®®ï¼æ¯æå¤ç§æ°æ®åºååæ ¼å¼ï¼å¦protocol buffersã\n    * æ¯æå¤ç§è´è½½åè¡¡ç­ç¥\n    * æå¡å®¹éï¼æ¯æå¤ç§å®¹éï¼å¦è¶æ¶ãéè¯ååæ¶ç­ç¹æ§\n    * æ§è½ ï¼å¾å¥½\n\n> éæ©æ¡æ¶åºæ ¹æ®å·ä½éæ±åé¡¹ç®ç¹ç¹æ¥å³å®ãopenfeignéåç®åçrestfulæå¡ï¼dubboéåå¤§è§æ¨¡åå¸å¼ç³»ç»ï¼ègrpcéåé«æ§è½ãè·¨è¯­è¨çå¾®æå¡ãç¼ç é¾åº¦åæ§è½æ¹é¢ä¹éæ ¹æ®å¢éææ¯æ åé¡¹ç®éæ±æ¥èèã\n\nç¼ç é¾åº¦ï¼\n\nopenfeignç¸å¯¹è¾å®¹æä¸æï¼ç¹å«éåjavaå¼åèï¼å ä¸ºå®ä¸springæ¡æ¶éæå¾å¾å¥½ãrestfulæå¡çå¼åéå¸¸æ¯è¾ç´è§ã\n\ndubboå¨éç½®åæ²»çæ¹é¢å¯è½æ´å¤æä¸äºï¼ä½æä¾äºæ´å¤çåè½ï¼å¦æå¡æ³¨åãå¨æä»£çç­ãéè¦æ´å¤çéç½®åç®¡çã\n\ngrpcä½¿ç¨protocol buffersæ¥å®ä¹æå¡æ¥å£åæ¶æ¯ï¼è¿å¯è½éè¦ä¸äºå­¦ä¹ ææ¬ãä½ä¸æ¦ææ¡ï¼å®æä¾äºå¼ºå¤§çidlæ¯æï¼å¯ä»¥çæå®¢æ·ç«¯åæå¡ç«¯çä»£ç ï¼åå°äºæå¨ç¼ç çå·¥ä½ã',charsets:{cjk:!0},lastUpdated:"2023/10/30, 14:49:17",lastUpdatedTimestamp:1698648557e3},{title:"5. å®æ¶ä»»å¡æ¯å¦ä½æ§è¡ç",frontmatter:{title:"5. å®æ¶ä»»å¡æ¯å¦ä½æ§è¡ç",date:"2023-11-20T12:56:32.000Z",permalink:"/pages/5531a6/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/100.XXL-JOB/5.%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84.html",relativePath:"02.æç« /91.æ¡æ¶/100.XXL-JOB/5.å®æ¶ä»»å¡æ¯å¦ä½æ§è¡ç.md",key:"v-0112e9f6",path:"/pages/5531a6/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. TriggerParam",slug:"_1-triggerparam",normalizedTitle:"1. triggerparam",charIndex:149},{level:2,title:"2. å®ä¹å®æ¶ä»»å¡",slug:"_2-å®ä¹å®æ¶ä»»å¡",normalizedTitle:"2. å®ä¹å®æ¶ä»»å¡",charIndex:1945},{level:2,title:"3. æ¶éå®æ¶ä»»å¡",slug:"_3-æ¶éå®æ¶ä»»å¡",normalizedTitle:"3. æ¶éå®æ¶ä»»å¡",charIndex:3815},{level:2,title:"4. å®æ¶ä»»å¡çæ§è¡",slug:"_4-å®æ¶ä»»å¡çæ§è¡",normalizedTitle:"4. å®æ¶ä»»å¡çæ§è¡",charIndex:18422},{level:2,title:"5. XxlJobContext",slug:"_5-xxljobcontext",normalizedTitle:"5. xxljobcontext",charIndex:29552},{level:2,title:"7. æ§è¡å¨å¯¹ JobThread çç®¡ç",slug:"_7-æ§è¡å¨å¯¹-jobthread-çç®¡ç",normalizedTitle:"7. æ§è¡å¨å¯¹ jobthread çç®¡ç",charIndex:51471},{level:2,title:"7. æ»ç»",slug:"_7-æ»ç»",normalizedTitle:"7. æ»ç»",charIndex:53728}],headersStr:"0. åè¨ 1. TriggerParam 2. å®ä¹å®æ¶ä»»å¡ 3. æ¶éå®æ¶ä»»å¡ 4. å®æ¶ä»»å¡çæ§è¡ 5. XxlJobContext 7. æ§è¡å¨å¯¹ JobThread çç®¡ç 7. æ»ç»",content:'# 0. åè¨\n\nä¸ºä»ä¹ä»æ§è¡å¨å¼å§è®²ï¼å ä¸ºä»ä¸åä¸åä»ä¸åä¸è®²é½æå©æå¼ï¼æéæ©éèä¸å±å®ç°çç»èï¼ç­æ§è¡å¨è®²å®äºåè®²è°åº¦ä¸­å¿ã\n\nç±äºæ²¡æè®²è°åº¦ä¸­å¿ï¼ä½ åªè¦æè°åº¦ä¸­å¿æ³è±¡ä¸ºä¸ä¸ªé»çï¼å®ä¼å°é©¬ä¸å°±æ§è¡çä»»å¡ä»æ°æ®åºä¸­æ¥åºæ¥ï¼ç¶ååé HTTP æ¶æ¯ç»æ§è¡å¨ï¼æ§è¡å¨æ¿å°ä¿¡æ¯åå»æ§è¡ã\n\n\n\n\n# 1. TriggerParam\n\nè°åº¦åæ°ï¼ä»ä¹å«è°åº¦åæ°ï¼å°±æ¯è°åº¦ä¸­å¿ä»æ°æ®åºä¸­æ¥æ¾å°è¦æ§è¡çä»»å¡åï¼å°è¿ä¸ªåæ°åéç»æ§è¡å¨ï¼æ§è¡å¨æ ¹æ®è°åº¦åæ°åçå¼è¿è¡æ§è¡ã\n\nè¿ä¸ªæ¶æ¯åå«ä»ä¹ä¿¡æ¯å¢ï¼\n\npublic class TriggerParam implements Serializable {\n    // ä½¿ç¨äº JDK åºåå\n    private static final long serialVersionUID = 42L;\n\n    /**\n     * ä»»å¡id\n     */\n    private int jobId;\n\n    /**\n     * å®æ¶ä»»å¡å\n     */\n    private String executorHandler;\n\n    /**\n     * å®æ¶ä»»å¡çåæ°\n     */\n    private String executorParams;\n\n    /**\n     * å®æ¶ä»»å¡çé»å¡ç­ç¥                <br></br>\n     * å½ä¸ä¸ªå®æ¶ä»»å¡æ³è¦æ§è¡ï¼ä½æ¯è´è´£è¯¥ä»»å¡ççº¿ç¨æ­£å¨å·¥ä½æ¶ä¼ä½¿ç¨è¿ä¸ªé»å¡ç­ç¥å¤æ­\n     */\n    private String executorBlockStrategy;\n\n    /**\n     * ä»»å¡çè¿ææ¶é´          <br></br>\n     * å¦æå¼å¯äºè¿ææ¶é´ï¼æ§è¡ä»»å¡æ¶ä¼é¢å¤åå»ºä¸ä¸ªæ°çº¿ç¨æ§è¡ä»»å¡ï¼\n     * ä¹åççº¿ç¨è´è´£çç£æ°çº¿ç¨æ§è¡ä»»å¡æ¶é´æ¯å¦è¶æ¶\n     */\n    private int executorTimeout;\n\n    /**\n     * è¯¥ä»»å¡å¯¹åºçæ¥å¿çid\n     */\n    private long logId;\n\n    /**\n     * ææ¥å¿çæ¶é´\n     */\n    private long logDateTime;\n\n    /**\n     * è¿è¡æ¨¡å¼\n     */\n    private String glueType;\n\n    /**\n     * ä»£ç ææ¬\n     */\n    private String glueSource;\n\n    /**\n     * ä»£ç ææ¬æ´æ°æ¶é´\n     */\n    private long glueUpdatetime;\n\n    /**\n     * åçç´¢å¼\n     */\n    private int broadcastIndex;\n\n    /**\n     * åçæ»æ°\n     */\n    private int broadcastTotal;\n\n    public int getJobId() {\n        return jobId;\n    }\n}\n\n\nå¶å®å¾å¤åéå¨ææä¹ä¸­ï¼idãexecutorHandlerå¥çå¿é¡»æï¼ä½æ¯ä¸ºä»ä¹æ logId å¢ï¼æ§è¡çæ¶åè· logId æä»ä¹å³ç³»å¢ï¼\n\nå¨ä¸æä¸­æä»¬åæäº xxl-job çæ°æ®åºè¡¨ï¼çéå¼ºè°äº xxl_job_log çä¸¤ä¸ªå­æ®µ ï¼trigger_codeãhandle_code\n\n * trigger_code ï¼æ¯å¦è°åº¦æåï¼ä¹å°±æ¯ HTTPæ¶æ¯åéæåæ²¡æ\n * handle_code ï¼æ¯å¦æ§è¡æåï¼ä¹å°±æ¯å®æ¶ä»»å¡ä»£ç æ§è¡è¿ç¨ä¸­æ¯å¦åºç°äºbug\n\nxxl-job å¨æ¶æ¯åéä¹åï¼ä¼ä¸ºæ¯ä¸æ¬¡æ§è¡çæä¸æ¡æ¥å¿ï¼è¿æ¡æ°æ®å¨æ°æ®åºç xxl_job_log ä¸­ï¼HTTPæ¶æ¯ï¼ä¹å°±æ¯TriggerParam ï¼å°è¾¾æ§è¡å¨æ¶ï¼è¿æ¡logå°±å·²ç»æ trigger_code äºãæä»¥æä»¬è¦å¨æ§è¡çæ¶åè®°å½ä¸äº handle_codeãhandle_messageï¼ç­ä»»å¡æ§è¡å®ååéåè°åº¦ä¸­å¿ï¼è°åº¦ä¸­å¿æ¥æ¶å°è¿æ¡æ¶æ¯åå°±å¯ä»¥è¡¥å¨æ¬æ¬¡æ§è¡çæ¥å¿ã\n\næäº TriggerParam ï¼xxl-job çå·¥ä½æµç¨åä¸º ï¼\n\n * è°åº¦ä¸­å¿ä»æ°æ®åºä¸­æ¥è¯¢å®æ¶ä»»å¡\n * å°ä»»å¡å°è£ä¸º TriggerParam åéç»æ§è¡å¨\n * æ§è¡å¨æ¿å° TriggerParam åæ§è¡å¯¹åºçä»»å¡\n\nç°å¨æä»¬ä¸ç¥éçæ¯ ï¼å®æ¶ä»»å¡ä»¥ä»ä¹å½¢å¼å­å¨äºæ§è¡å¨ãå®æ¶ä»»å¡å¦ä½æ§è¡çãæ¥ä¸æ¥ä¼å·ä½åæè¿ä¸¤ç¹ã\n\n\n# 2. å®ä¹å®æ¶ä»»å¡\n\nå®æ¶ä»»å¡å¨ Xxl-Job ä¸­ä»¥ä»ä¹å½¢å¼å­å¨å¢ï¼è¯å®è¦æä¸ä¸ªç±»å°è£å®ã\n\né¦åï¼æä»¬åå®ä¹æ¥å£ï¼æ¥å£è§å®çæ¯è¡ä¸ºï¼ä¸ä¸ªä»»å¡éè¦æåªäºè¡ä¸ºï¼æ§è¡ãåå§åãéæ¯ã\n\nä½æ¯å¹¶éææä»»å¡é½éè¦åå§åãéæ¯ï¼æä»¥æä»¬å° IJobHandler å®ä¹ä¸ºæ½è±¡ç±»ï¼ç»åå§ååéæ¯æ¹æ³é»è®¤å®ç°ã\n\npublic abstract class IJobHandler {\n\n\tpublic abstract void execute() throws Exception;\n\n\tpublic void init() throws Exception {\n\n\t}\n\n\tpublic void destroy() throws Exception {\n\n\t}\n}\n\n\nä¸ä¸ªæ¹æ³æ³è¦æ§è¡ï¼è¯å®è¦æClasså¯¹è±¡ãMethodæ¹æ³ï¼åæ¶ææ³è®©åè½æ´å ä¸°å¯ï¼äºæ¯ç»æ¯ä¸ä¸ªå®æ¶ä»»å¡å ä¸åå§åæ¹æ³ãéæ¯æ¹æ³ã\n\npublic class MethodJobHandler extends IJobHandler {\n    // beanå¯¹è±¡çclass\n    private final Object target;\n    // éè¦æ§è¡çmethod\n    private final Method method;\n    // åå§ååéæ¯æ¹æ³\n    private Method initMethod;\n    private Method destroyMethod;\n\n    public MethodJobHandler(Object target, Method method, Method initMethod, Method destroyMethod) {\n        this.target = target;\n        this.method = method;\n\n        this.initMethod = initMethod;\n        this.destroyMethod = destroyMethod;\n    }\n\n    @Override\n    public void execute() throws Exception {\n        Class<?>[] paramTypes = method.getParameterTypes();\n        if (paramTypes.length > 0) {\n            method.invoke(target, new Object[paramTypes.length]);       // method-param can not be primitive-types\n        } else {\n            method.invoke(target);\n        }\n    }\n\n    @Override\n    public void init() throws Exception {\n        if(initMethod != null) {\n            initMethod.invoke(target);\n        }\n    }\n\n    @Override\n    public void destroy() throws Exception {\n        if(destroyMethod != null) {\n            destroyMethod.invoke(target);\n        }\n    }\n\n    @Override\n    public String toString() {\n        return super.toString()+"["+ target.getClass() + "#" + method.getName() +"]";\n    }\n}\n\n\nå¶å®ä¸é¢çé»è¾ä¸é¾å¯¹å§ï¼ä¸å±å°±ä¸ä¸ªæ¹æ³ï¼æ§è¡ãåå§åãéæ¯ã\n\n * æ§è¡ ï¼å¦ææ²¡æåæ°ç´æ¥å°± method.invoke(target)\n * åå§å ï¼å¦æåå§åMethodä¸ä¸ºç©ºå°±æ§è¡\n * éæ¯ ï¼å¦æéæ¯Methodä¸ä¸ºç©ºå°±æ§è¡\n\nå½æ³è¦æ§è¡ä¸ä¸ªå®æ¶ä»»å¡çæ¶åï¼åªéè¦å new MethodJobHandlerï¼ç¶åè°ç¨ jobhandler.executor() å°±å¯æ§è¡ã\n\n\n# 3. æ¶éå®æ¶ä»»å¡\n\nåå°è£å®æ¶ä»»å¡å¯ä¸å¤ï¼æä»¬è¿è¦æ¿å°å®æ¶ä»»å¡ï¼ä¹å°±æ¯å­åè°åº¦ä¸­å¿åéæ¥ç TriggerParam æ¾å° MethodJobHandlerï¼æä¹æ¾å¢ï¼é¾éæ¯ä¸æ¬¡æ§è¡ä»»å¡é½éè¦éæ°æ¾åï¼\n\nå«å¿äºï¼ä»£ç è¿è¡ä¹åå°±æ²¡æ³æ´æ¹äºï¼æä»¥æä»¬å¯ä»¥è¶ä»£ç è¿è¡åï¼å°ææå®æ¶ä»»å¡æ¶éèµ·æ¥ï¼å¯ä»¥ç¨ListãMapè¿ç§å®¹å¨è£èµ·æ¥ï¼ä½ æ³è¦ï¼æ²¡é®é¢ï¼æ¿ä»»å¡çå¯ä¸æ è¯ç»ææ¢~~è¯´å°å¯ä¸æ è¯ï¼èªæçä½ è¯å®æ³å°äºMapï¼å ä¸ºå®æ¯ key-value å½¢å¼çï¼æä»¬å¯ä»¥ä½¿ç¨ id-jobHandler ä¹å¯ä»¥ä½¿ç¨ jobName-jobHandler å­æ¾ä»»å¡ï¼è·æä»¬çä¸å¡å®å¨ç¬¦åï¼\n\nåæ¥ççä¹åæä»¬åçå®æ¶ä»»å¡ä»£ç ï¼\n\n@Component\npublic class SampleXxlJob {\n\n    @XxlJob("demoJobHandler")\n    public void demoJobHandler() throws Exception {\n        System.out.println("ç®åä»»å¡å®ä¾æ§è¡äº");\n    }\n}\n\n\nå¦ææ¯ä½ ï¼å¦ä½è·åè¿ä¸ªä»»å¡å¢ï¼ç±äº SampleXxlJob è¿ä¸ªç±»å·²ç»è¢«æ³¨å¥å° Spring å®¹å¨ä¸­äºï¼é£ä¹æä»¬è·å Spring å®¹å¨éåå®¹å¨ä¸­çææBeanï¼å¦ææä¸ª Bean æ @XxlJob è¿ä¸ªæ³¨è§£ï¼é£ä¹è¿ä¸ª Bean + Methodå°±æ¯æä»¬è¦æ¾çå®æ¶ä»»å¡ã\n\nè¯å®è¦ç±æ§è¡å¨åè¿ç§äºæï¼å ä¸ºæä»¬çé¡¹ç®å¼å¥çæ¯æ§è¡å¨ä¾èµï¼æ¢è¨ä¹ï¼æä»¬çé¡¹ç®ç°å¨å°±æ¯ä¸ä¸ªæ§è¡å¨äºã\n\næä»¥æå°è¿ä¸ªâæ¶éå®æ¶ä»»å¡âçç±»å«å XxlJobSpringExecutor\n\nå¨ä»£ç ä¸­éè¦æ¿å° Spring çä¸ä¸æ contextï¼ç¶åå°±å¯ä»¥éè¿ context è·åææçbeanã\n\npublic class XxlJobSpringExecutor implements ApplicationContextAware {\n\n    private static ApplicationContext applicationContext;\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        XxlJobSpringExecutor.applicationContext = applicationContext;\n    }\n\n    public static ApplicationContext getApplicationContext() {\n        return applicationContext;\n    }\n}\n\n\nç°å¨åæä¸ä¸ªæ°é®é¢ï¼ä»ä¹æ¶åå¼å§æ¶éå®æ¶ä»»å¡å¢ï¼Springå®¹å¨åå§ååï¼Springå®¹å¨åå§ååï¼\n\nå¨å®æ¶ä»»å¡ä¸­ï¼æå¯è½ä½¿ç¨ MapperãRedisTemplateãrpc åç§Spring beanå»å®æå·¥ä½ï¼é£è¯å®æ¯ Spring çå®¹å¨åå§åä¹åæ¶éå®æ¶ä»»å¡äºã\n\næä»¥æä»¬è¦å®ç° SmartInitializingSingletonï¼å¨ææåä¾å¯¹è±¡åå¤å¥½ä¹åï¼æä»¬å¼å§æ¶éä»»å¡ã\n\npublic class XxlJobSpringExecutor implements ApplicationContextAware, SmartInitializingSingleton {\n    \n    @Override\n    public void afterSingletonsInstantiated() {\n        // å¨è¿éæ¶éå®æ¶ä»»å¡\n        initJobHandlerMethodRepository(applicationContext);\n    }\n   \n    private static ApplicationContext applicationContext;\n    \n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        XxlJobSpringExecutor.applicationContext = applicationContext;\n    }\n\n    public static ApplicationContext getApplicationContext() {\n        return applicationContext;\n    }\n}\n\n\nåæ¥æèä¸ä¸ªé®é¢ ï¼æ¶éå®æ¶ä»»å¡ï¼æä»¬éè¦æ¶éä»ä¹ä¿¡æ¯ï¼æ§è¡ä¸ä¸ªä»»å¡ï¼æ¢è¨ä¹ï¼æ§è¡ä¸ä¸ªæ¹æ³éè¦ä»ä¹ä¿¡æ¯ï¼\n\n 1. è¢«æ§è¡çæ¹æ³ ï¼method\n 2. åå°æ§è¡ä»»å¡çä»£ç ä¸º ï¼method.invoke(class)ï¼æä»¥è¿éè¦ class å¯¹è±¡ï¼ä¸ä¸ªç±»ä¸­å¯è½æå¤ä¸ªå®æ¶ä»»å¡ï¼ä½æ¯ç®¡å®å¢ï¼æå¤å°æè¦å¤å°ã\n 3. ä¸é¢ä¸¤ä¸ªå±æ§å¯ä»¥å°è£ä¸ºä¸ä¸ª MethodHandlerï¼æ³è¦éè¿å®æ¶ä»»å¡åæ¾å°MethodHandlerï¼æä»¥éè¦æ¿å°å®æ¶ä»»å¡åå­ã\n\nç»è¿ä¸é¢çåæï¼æä»¬åæ­¥å³å®ï¼éå Spring çææbeanï¼å¿é¡»æ¿å°ä»¥ä¸ä¸ä¸ªä¿¡æ¯ï¼\n\n 1. jobName\n 2. class\n 3. method\n\nä¼ªä»£ç åºè¯¥æ¯è¿æ ·ï¼\n\n// è¿ä¸ªMapè´è´£æ¶éææå®æ¶ä»»å¡\nMap<String, MethodJobHandler> jobMap = new ....();\n// å¼å§éåæ¯ä¸ä¸ªBean\nfor (Object bean : springBeans) {\n    // æ¶éè¿ä¸ªbeanä¸­çå®æ¶ä»»å¡\n    Map<XxlJob, Method> map = new Map<>();\n    Method[] methods = bean.getMethods();\n    for (Method method : methods) {\n        if (methodä¸æ@XxlJobæ³¨è§£) {\n            map.put(xxljob, method);\n        }\n    }\n    // å¦æè¿ä¸ªbeanéé¢æ²¡æå®æ¶ä»»å¡å°±ä¸ä¸ä¸ªã\n    if (map.size() <= 0) continue;\n    \n    // éåMapè¿è¡æ³¨åï¼å°å¶æ³¨åå°\n    for (Map.Entry<XxlJob, Method> entry : Map.entrySet()) {\n        MethodHandler handler = new MethodJobHandler(bean.class, entry.value());\n    \tjobMap.put(xxljob.name(), handler);\n    }\n    \n}\n\n\nä½æ¯ xxl-job å¹¶æ²¡æè¿ä¹åï¼å®æ å®æ¶ä»»å¡çæ¶é åå®æ¶ä»»å¡çæ³¨å åå¼è¿è¡ï¼ä¸ºä»ä¹ï¼\n\nä»å¤©ä½ ä½¿ç¨ Spring éæ xxl-job å¯ä»¥ä½¿ç¨ Spring å®¹å¨è¿è¡æ¶éï¼ä½æ¯æå¤©ä½ æ²¡æç¨ xxl-job æä¹åï¼æ¶éæä¹åï¼\n\næä»¥å°è¿ä¸¤æ­¥åå¼è¿è¡ï¼å¯ä»¥åå°éæå¶ä»æ¡æ¶æ¶çå·¥ä½éãé£ä¹å¯»æ¾è¿ä¸æ­¥å°±å¯è½æå¾å¤ç§å®ç°æ¹å¼ï¼ä½æ¯æ³¨åä¸ä¸æ ·ï¼ä¸ç®¡ä½ è·å¤å°æ¡æ¶éæï¼æç»ä½ è¦ç»æ beanãmethodãxxljobæ³¨è§£ï¼è¿ä¸æ ·ä¸è¥¿å°±è¡ã\n\nç±äºæ³¨åä¸éè¦ä¾èµäºä»»ä½æ¡æ¶ï¼ æ¶ééè¦ä¾èµäºSpringï¼èä¸å¡çé»è¾è¯å®æ¯æ¶éä¹ååæ³¨åï¼æä»¥æä»¬å°è¡ä¸ºå®ä¹æè¿æ ·ï¼\n\npublic abstract class XxlJobExecutor {\n    public void æ³¨å(Object bean, Method method, XxlJob xxljob) {\n        // åè½å®ç°\n    }\n}\n\n\npublic abstract class XxlJobSringExecutor extends XxlJobExecutor {\n\tpublic  void æ¶é() {\n        // ä»å®æ¶ä»»å¡ä¸­æ¾åºææå®æ¶ä»»å¡\n        Map<XxlJob, Method> map = new Map<>();\n        Method[] methods = bean.getMethods();\n        for (Method method : methods) {\n            if (methodä¸æ@XxlJobæ³¨è§£) {\n                map.put(xxljob, method);\n            }\n        }\n        // å¦æè¿ä¸ªbeanéé¢æ²¡æå®æ¶ä»»å¡å°±ä¸ä¸ä¸ªã\n        if (map.size() <= 0) continue;\n\n        // è°ç¨ä»ç¶ç±»ç»§æ¿è¿æ¥çæ³¨åæ¹æ³è¿è¡æ³¨åã\n        for (Map.Entry<XxlJob, Method> entry : Map.entrys()) {\n        \tæ³¨å(bean, entry.key, entry.value);\n    \t}\n    }\n}\n\n\nåæ¥çä¸ä¸ XxlJobSpringExecutor ä¸­æ¶éå®æ¶ä»»å¡çä»£ç ï¼ä»£ç å¤ä½æ¯ä¸é¾ï¼\n\nprivate void initJobHandlerMethodRepository(ApplicationContext applicationContext) {\n        // å®¹å¨å¤ç©º\n        if (applicationContext == null) {\n            return;\n        }\n        // æ¿å°ææbeanå¯¹è±¡çåå­\n    \t// getBeanNamesForTypeæä¸ä¸ªåæ°:\n    \t// type : ç±»å\n    \t// includeNonSingletons : æ¯å¦åå«å¤å®ä¾å¯¹è±¡\n    \t// allowEagerInit : æ¯å¦åå«æå è½½å¯¹è±¡\n        String[] beanDefinitionNames = applicationContext.getBeanNamesForType(Object.class, false, true);\n        for (String beanDefinitionName : beanDefinitionNames) {\n\n            // éè¿nameæ¿å°beanå¯¹è±¡\n            Object bean = null;\n            Lazy onBean = applicationContext.findAnnotationOnBean(beanDefinitionName, Lazy.class);\n            if (onBean!=null){\n                logger.debug("xxl-job annotation scan, skip @Lazy Bean:{}", beanDefinitionName);\n                continue;\n            }else {\n                bean = applicationContext.getBean(beanDefinitionName);\n            }\n\n            // è¿ä¸ªMapç¨äºæ¶éå®æ¶ä»»å¡ï¼è¿ä¸ªMapä»£è¡¨å½åéåçbeanä¸­ææçå®æ¶ä»»å¡ã\n            // Method : å®æ¶ä»»å¡æ¹æ³\n            // XxlJob : è¿ä¸ªå®æ¶ä»»å¡çæ³¨è§£ï¼éè¿ XxlJobå¯ä»¥å¾å°å®æ¶ä»»å¡çåå­\n            Map<Method, XxlJob> annotatedMethods = null;   \n            try {\n                annotatedMethods = MethodIntrospector.selectMethods(bean.getClass(),\n                        new MethodIntrospector.MetadataLookup<XxlJob>() {\n                            @Override\n                            public XxlJob inspect(Method method) {\n                                return AnnotatedElementUtils.findMergedAnnotation(method, XxlJob.class);\n                            }\n                        });\n            } catch (Throwable ex) {\n                logger.error("xxl-job method-jobhandler resolve error for bean[" + beanDefinitionName + "].", ex);\n            }\n            // å¦æè¿ä¸ªBeanä¸­æ²¡æå®æ¶ä»»å¡ï¼è·³è¿\n            if (annotatedMethods==null || annotatedMethods.isEmpty()) {\n                continue;\n            }\n\n            // å·²ç»æ¶éå°è¯¥Beançææå®æ¶ä»»å¡ï¼è¦æå®ç»ä¸æ¾å¨ä¸ä¸ªå°æ¹\n            // registJobHandler\n            for (Map.Entry<Method, XxlJob> methodXxlJobEntry : annotatedMethods.entrySet()) {\n                Method executeMethod = methodXxlJobEntry.getKey();\n                XxlJob xxlJob = methodXxlJobEntry.getValue();\n                // regist\n                registJobHandler(xxlJob, bean, executeMethod);\n            }\n\n        }\n    }\n\n\n 1. æ¿å°ææ Bean å¯¹è±¡çåå­ï¼éååå­ï¼æ ¹æ®åå­è·åBeanå¯¹è±¡\n 2. ä½¿ç¨ Spring æä¾çå·¥å·ç±» MethodIntrospector.selectMethods æ¥çä¸ä¸ªç±»ä¸­ææ²¡æå äº @XxlJob æ³¨è§£çæ¹æ³\n 3. å¦ææï¼å°±å°è¿äºæ¹æ³æç§ method:xxljob çå½¢å¼å°è£è¿ Map ä¸­ã\n 4. å°è¿ä¸ª Bean ä¸­ææå®æ¶ä»»å¡æ³¨åå°æä¸ªå°æ¹ï¼ä»¥ä¾¿ä½¿ç¨\n 5. å¼å§éåä¸ä¸ä¸ª Beanï¼éå¤ä¸è¿°æ­¥éª¤\n\nåçç XxlJobExecutor ä¸­ æ³¨åä»»å¡çé»è¾ ï¼\n\npublic class XxlJobExecutor {\n    // å­æ¾ MethodJobHandler çMapå®¹å¨\n    // key : å®æ¶ä»»å¡çåå­\n    private static ConcurrentMap<String, IJobHandler> jobHandlerRepository = new ConcurrentHashMap<String, IJobHandler>();\n    public static IJobHandler registJobHandler(String name, IJobHandler jobHandler){\n        logger.info(">>>>>>>>>>> xxl-job register jobhandler success, name:{}, jobHandler:{}", name, jobHandler);\n        return jobHandlerRepository.put(name, jobHandler);\n    }\n    protected void registJobHandler(XxlJob xxlJob, Object bean, Method executeMethod){\n        if (xxlJob == null) {\n            return;\n        }\n\n        String name = xxlJob.value();\n        //make and simplify the variables since they\'ll be called several times later\n        Class<?> clazz = bean.getClass();\n        String methodName = executeMethod.getName();\n        if (name.trim().length() == 0) {\n            throw new RuntimeException("xxl-job method-jobhandler name invalid, for[" + clazz + "#" + methodName + "] .");\n        }\n        if (loadJobHandler(name) != null) {\n            throw new RuntimeException("xxl-job jobhandler[" + name + "] naming conflicts.");\n        }\n\n        executeMethod.setAccessible(true);\n\n        // init and destroy\n        Method initMethod = null;\n        Method destroyMethod = null;\n\n        if (xxlJob.init().trim().length() > 0) {\n            try {\n                initMethod = clazz.getDeclaredMethod(xxlJob.init());\n                initMethod.setAccessible(true);\n            } catch (NoSuchMethodException e) {\n                throw new RuntimeException("xxl-job method-jobhandler initMethod invalid, for[" + clazz + "#" + methodName + "] .");\n            }\n        }\n        if (xxlJob.destroy().trim().length() > 0) {\n            try {\n                destroyMethod = clazz.getDeclaredMethod(xxlJob.destroy());\n                destroyMethod.setAccessible(true);\n            } catch (NoSuchMethodException e) {\n                throw new RuntimeException("xxl-job method-jobhandler destroyMethod invalid, for[" + clazz + "#" + methodName + "] .");\n            }\n        }\n\n        // registry jobhandler\n        registJobHandler(name, new MethodJobHandler(bean, executeMethod, initMethod, destroyMethod));\n\n    }\n}\n\n\nregistJobHandler(XxlJob xxlJob, Object bean, Method executeMethod)\n\n 1. xxlJob ï¼å®æ¶ä»»å¡å¤´ä¸çæ³¨è§£ï¼å«æè¯¥ä»»å¡çåå­ãåå§åæ¹æ³ãéæ¯æ¹æ³\n 2. bean ï¼è¯¥ä»»å¡æ¹æ³å±äºåªä¸ªç±»ï¼éè¦éè¿å®æ¿å° class\n 3. executorMethod ï¼å®æ¶ä»»å¡çæ¹æ³\n\nè¿ä¸ªæ¹æ³çæ»æµç¨ï¼\n\n 1. æ ¹æ®ä¼ å¥çåæ°è·åå®æ¶ä»»å¡ç åå­ãclasså¯¹è±¡ãæ¹æ³å\n 2. æ£æ¥åæ°ï¼å¹¶ä¸æ ¹æ®å®æ¶ä»»å¡çåå­å¤æ­æ¯å¦å·²ç»åºç°è¿ï¼ä¸åè®¸ä»»å¡åéå¤\n 3. å¦æåå§åæ¹æ³ãéæ¯æ¹æ³ä¸ä¸ºç©ºï¼å¾å°è¿ä¸¤ä¸ªæ¹æ³\n 4. å° classå¯¹è±¡ãå®æ¶ä»»å¡æ¹æ³ãåå§åæ¹æ³ãéæ¯æ¹æ³ å°è£ä¸º MethodJobHandler ï¼å¹¶ä¸ä»¥æ¹æ³åä¸º key æ¾å¥ Map\n\nä»¥åå°±å¯ä»¥éè¿å®æ¶ä»»å¡çåç§°æ¥æ¾å° MethodJobHandlerï¼ä½¿ç¨ execute() æ¥æ§è¡ã\n\npublic static IJobHandler loadJobHandler(String name){\n    return jobHandlerRepository.get(name);\n}\n\n\né£ä¹ç°å¨ æ¶éå®æ¶ä»»å¡çæµç¨ä¸ºï¼\n\n 1. XxlJobSpringExecutor æ¾å°å äº @XxlJob æ³¨è§£çæ¹æ³\n 2. æ³¨åå° XxlJobExecutor ç Map ä¸­ã\n\næåï¼ä¸å®æ´ä»£ç ï¼\n\npublic class XxlJobSpringExecutor extends XxlJobExecutor implements ApplicationContextAware, SmartInitializingSingleton, DisposableBean {\n    @Override\n    public void afterSingletonsInstantiated() {\n        // å¨è¿éæ¶éå®æ¶ä»»å¡\n        initJobHandlerMethodRepository(applicationContext);\n    }\n   \n    private static ApplicationContext applicationContext;\n    \n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        XxlJobSpringExecutor.applicationContext = applicationContext;\n    }\n\n    public static ApplicationContext getApplicationContext() {\n        return applicationContext;\n    }\n    private void initJobHandlerMethodRepository(ApplicationContext applicationContext) {\n        if (applicationContext == null) {\n            return;\n        }\n        // init job handler from method\n        String[] beanDefinitionNames = applicationContext.getBeanNamesForType(Object.class, false, true);\n        for (String beanDefinitionName : beanDefinitionNames) {\n\n            // get bean\n            Object bean = null;\n            Lazy onBean = applicationContext.findAnnotationOnBean(beanDefinitionName, Lazy.class);\n            if (onBean!=null){\n                logger.debug("xxl-job annotation scan, skip @Lazy Bean:{}", beanDefinitionName);\n                continue;\n            }else {\n                bean = applicationContext.getBean(beanDefinitionName);\n            }\n\n            // filter method\n            Map<Method, XxlJob> annotatedMethods = null;   // referred to ï¼org.springframework.context.event.EventListenerMethodProcessor.processBean\n            try {\n                annotatedMethods = MethodIntrospector.selectMethods(bean.getClass(),\n                        new MethodIntrospector.MetadataLookup<XxlJob>() {\n                            @Override\n                            public XxlJob inspect(Method method) {\n                                return AnnotatedElementUtils.findMergedAnnotation(method, XxlJob.class);\n                            }\n                        });\n            } catch (Throwable ex) {\n                logger.error("xxl-job method-jobhandler resolve error for bean[" + beanDefinitionName + "].", ex);\n            }\n            if (annotatedMethods==null || annotatedMethods.isEmpty()) {\n                continue;\n            }\n\n            // generate and regist method job handler\n            for (Map.Entry<Method, XxlJob> methodXxlJobEntry : annotatedMethods.entrySet()) {\n                Method executeMethod = methodXxlJobEntry.getKey();\n                XxlJob xxlJob = methodXxlJobEntry.getValue();\n                // regist\n                registJobHandler(xxlJob, bean, executeMethod);\n            }\n\n        }\n    }\n}\n\n\npublic class XxlJobExecutor {\n    // å­æ¾ MethodJobHandler çMapå®¹å¨\n    // key : å®æ¶ä»»å¡çåå­\n    private static ConcurrentMap<String, IJobHandler> jobHandlerRepository = new ConcurrentHashMap<String, IJobHandler>();\n    public static IJobHandler loadJobHandler(String name){\n    \treturn jobHandlerRepository.get(name);\n\t}\n\n    protected void registJobHandler(XxlJob xxlJob, Object bean, Method executeMethod){\n        if (xxlJob == null) {\n            return;\n        }\n\n        String name = xxlJob.value();\n        //make and simplify the variables since they\'ll be called several times later\n        Class<?> clazz = bean.getClass();\n        String methodName = executeMethod.getName();\n        if (name.trim().length() == 0) {\n            throw new RuntimeException("xxl-job method-jobhandler name invalid, for[" + clazz + "#" + methodName + "] .");\n        }\n        if (loadJobHandler(name) != null) {\n            throw new RuntimeException("xxl-job jobhandler[" + name + "] naming conflicts.");\n        }\n\n        executeMethod.setAccessible(true);\n\n        // init and destroy\n        Method initMethod = null;\n        Method destroyMethod = null;\n\n        if (xxlJob.init().trim().length() > 0) {\n            try {\n                initMethod = clazz.getDeclaredMethod(xxlJob.init());\n                initMethod.setAccessible(true);\n            } catch (NoSuchMethodException e) {\n                throw new RuntimeException("xxl-job method-jobhandler initMethod invalid, for[" + clazz + "#" + methodName + "] .");\n            }\n        }\n        if (xxlJob.destroy().trim().length() > 0) {\n            try {\n                destroyMethod = clazz.getDeclaredMethod(xxlJob.destroy());\n                destroyMethod.setAccessible(true);\n            } catch (NoSuchMethodException e) {\n                throw new RuntimeException("xxl-job method-jobhandler destroyMethod invalid, for[" + clazz + "#" + methodName + "] .");\n            }\n        }\n\n        // registry jobhandler\n        registJobHandler(name, new MethodJobHandler(bean, executeMethod, initMethod, destroyMethod));\n\n    }\n    public static IJobHandler registJobHandler(String name, IJobHandler jobHandler){\n        logger.info(">>>>>>>>>>> xxl-job register jobhandler success, name:{}, jobHandler:{}", name, jobHandler);\n        return jobHandlerRepository.put(name, jobHandler);\n    }\n}\n\n\nå¶å®è¿ä¸¤ä¸ªç±»çä»£ç è¿ä¸åå¦æ­¤ï¼æè§å¾ xxl-job ä½ä¸ºä¸ä¸ªå°èç²¾çæ¡æ¶ï¼å®çä»£ç è½ç¶å°ä½æ¯è¯»èµ·æ¥å¾é¾åã\n\næ²¡æéµå¾ª âä¸ä¸ªæ¹æ³å ä¸å±â çè¯å¥½ä¹ æ¯~\n\n\n# 4. å®æ¶ä»»å¡çæ§è¡\n\nç°å¨è®©æä»¬åæä¸ä¸ä½¿ç¨ä»ä¹æ¨¡å¼å»æ§è¡å®æ¶ä»»å¡ï¼åä¸¾ä¸ä¸å¯è½ç¨å°çæ¨¡å¼ï¼\n\n 1. æ¯ä¸æ¬¡æ¥æ¶ TriggerParam é½æ°åå»ºä¸ä¸ªçº¿ç¨å»æ§è¡ã\n 2. ä½¿ç¨çº¿ç¨æ± æ¥æ¶ TriggerParam æ§è¡ã\n 3. ä¸ä¸ªçº¿ç¨è´è´£ä¸ä¸ªä»»å¡ï¼åä¸ä¸ªä»»å¡çTriggerParamé½ç±è¿ä¸ªçº¿ç¨æ¥æ¶å¹¶æ§è¡ã\n\nå¦ææ¯ä½ ï¼å¦ä½éæ©ï¼ä¸åå³å­ï¼xxl-job ä½¿ç¨ç¬¬ä¸ç§æ¨¡å¼æ§è¡å®æ¶ä»»å¡ï¼èä¸å¯¹è¿ç§æ¨¡å¼è¿è¡äºæ¹è£ ï¼\n\n> xxl-job æ¯ä»¥æ¯ä¸ªçº¿ç¨è´è´£æä¸ä¸ªä»»å¡çæ§è¡ï¼å¯¹äºä¸¤ç§é¢ççä»»å¡ ï¼\n> \n>  1. æ§è¡ç¹å«é¢ç¹çä»»å¡\n>     \n>     xxl-job å¯¹çº¿ç¨è¿è¡äºå°è£ï¼æ¯ä¸ä¸ªçº¿ç¨åé¨é½æä¸ä¸ªé»å¡éåï¼ææ TriggerParam é½ä¼è¿å¥è´è´£å¯¹åºä»»å¡ççº¿ç¨çé»å¡éåä¸­ç­å¾æ§è¡ã\n> \n>  2. æ§è¡ä¸é¢ç¹çä»»å¡\n>     \n>     çº¿ç¨å¹¶ä¸æ¯ä¸ç´é½å¨å·¥ä½ï¼å®æ¯å¾ªç¯ä»é»å¡éåä¸­å TriggerParamï¼å¦æ 3ç§éåä¸å°å°±è¿å¥ä¸ä¸æ¬¡å¾ªç¯ï¼åæ¶è®°å½è¿æ¯ç¬¬å æ¬¡æ æå¾ªç¯ï¼å¦æè¶è¿30æ¬¡ï¼å°±å°çº¿ç¨éæ¯ãé²æ­¢çº¿ç¨æ²¡äºå¹²åå èµæºã\n\næ ¹æ®ä¸é¢çæè¿°ï¼çæµä¸ä¸ xxl-job å°è£ççº¿ç¨éè¦åªäºåé ï¼\n\né»å¡éåãæ æå¾ªç¯æ¬¡æ°ãçº¿ç¨æ¯å¦è¿å¨å·¥ä½çæ å¿ãçº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡çæ å¿ãä»»å¡æ§è¡éè¦ç\n\npublic class JobThread extends Thread{\n    private static Logger logger = LoggerFactory.getLogger(JobThread.class);\n\t// æ­¤æ¶è¿ä¸ªçº¿ç¨è´è´£çå®æ¶ä»»å¡çid\n\tprivate int jobId;\n    // è¯¥å®æ¶ä»»å¡ç MethodJobHandler\n\tprivate IJobHandler handler;\n    // æä»»å¡æ¶å°±ä¼æ¾å°è¿ä¸ªé»å¡éåä¸­\n\tprivate LinkedBlockingQueue<TriggerParam> triggerQueue;\n    // é²æ­¢éå¤è°åº¦\n    private Set<Long> triggerLogIdSet;\t\t\n\t// è¯¥çº¿ç¨æ¯å¦è¿å¨å·¥ä½\n\tprivate volatile boolean toStop = false;\n    // è¯¥çº¿ç¨åæ­¢çåå æ¯ä»ä¹ï¼æå¯è½æ¯é¿æ¶é´æ²¡æä»»å¡ï¼æå¯è½æ¯å¼åäººåæå¨å³é­å®æ¶ä»»å¡\n\tprivate String stopReason;\n\t// çº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡ï¼"æ­£å¨è¿è¡"ä¸åæ¬çº¿ç¨å¾ªç¯ãé»å¡ç­å¾ä»»å¡å°æ¥ï¼èæ¯ççæ­£æ­£çæ­£å¨è¿è¡ä»»å¡\n    private boolean running = false;    \n    // çº¿ç¨æ æå¾ªç¯æ¬¡æ°\n\tprivate int idleTimes = 0;\n    \n    public JobThread(int jobId, IJobHandler handler) {\n\t\tthis.jobId = jobId;\n\t\tthis.handler = handler;\n\t\tthis.triggerQueue = new LinkedBlockingQueue<TriggerParam>();\n\t\tthis.triggerLogIdSet = Collections.synchronizedSet(new HashSet<Long>());\n\n\t\tthis.setName("xxl-job, JobThread-"+jobId+"-"+System.currentTimeMillis());\n\t}\n}\n\n\n 1. ä¸é¢æä¸ä¸ª triggerLogIdSetï¼å¶å®è¿ä¸ªåéå¾é¾ç¨ä¸ï¼æä»¥è¿éåä¸è¯´äºã\n\n 2. toStop å running æä»ä¹åºå«å¢ï¼\n    \n    toStop ï¼æ­¤çº¿ç¨æ¯å¦è¿å¨è¿è¡\n    \n    running ï¼æ­¤çº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡\n    \n    å®ä¿©çåºå« æä»¬é¦åè¦é»å¡çä»éåä¸­åå¼ï¼è¿æ¶ toStop = falseï¼running = falseï¼å ä¸ºçº¿ç¨ç¡®å®å¨è¿è¡ï¼ä½æ¯æ²¡æåå°ä»»å¡ã\n    \n    ä»éåä¸­ååº TriggerParam åï¼ toStop = falseï¼running = trueï¼å ä¸ºç°å¨å·²ç»å¯ä»¥å¼å§è¿è¡ä»»å¡äºã\n\npublic class JobThread extends Thread{\n    private static Logger logger = LoggerFactory.getLogger(JobThread.class);\n\t// æ­¤æ¶è¿ä¸ªçº¿ç¨è´è´£çå®æ¶ä»»å¡çid\n\tprivate int jobId;\n    // è¯¥å®æ¶ä»»å¡ç MethodJobHandler\n\tprivate IJobHandler handler;\n    // æä»»å¡æ¶å°±ä¼æ¾å°è¿ä¸ªé»å¡éåä¸­\n\tprivate LinkedBlockingQueue<TriggerParam> triggerQueue;\n    // é²æ­¢éå¤è°åº¦\n    private Set<Long> triggerLogIdSet;\t\t\n\t// è¯¥çº¿ç¨æ¯å¦è¿å¨å·¥ä½\n\tprivate volatile boolean toStop = false;\n    // è¯¥çº¿ç¨åæ­¢çåå æ¯ä»ä¹ï¼æå¯è½æ¯é¿æ¶é´æ²¡æä»»å¡ï¼æå¯è½æ¯å¼åäººåæå¨å³é­å®æ¶ä»»å¡\n\tprivate String stopReason;\n\t// çº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡ï¼"æ­£å¨è¿è¡"ä¸åæ¬çº¿ç¨å¾ªç¯ãé»å¡ç­å¾ä»»å¡å°æ¥ï¼èæ¯ççæ­£æ­£çæ­£å¨è¿è¡ä»»å¡\n    private boolean running = false;    \n    // çº¿ç¨æ æå¾ªç¯æ¬¡æ°\n\tprivate int idleTimes = 0;\t\t\t\n\n\n\tpublic JobThread(int jobId, IJobHandler handler) {\n\t\tthis.jobId = jobId;\n\t\tthis.handler = handler;\n\t\tthis.triggerQueue = new LinkedBlockingQueue<TriggerParam>();\n\t\tthis.triggerLogIdSet = Collections.synchronizedSet(new HashSet<Long>());\n\n\t\tthis.setName("xxl-job, JobThread-"+jobId+"-"+System.currentTimeMillis());\n\t}\n    // è°åº¦ä¸­å¿ä»æ°æ®åºä¸­æ¥åºå°è¦æ§è¡çä»»å¡ï¼å°è¿ä¸ªä»»å¡åéç»æ§è¡å¨\n    // æ§è¡å¨æ¶å°æ¶æ¯åå°è¿æ¬¡æ§è¡æ¾å¥éåä¸­ç­å¾æ§è¡\n    public ReturnT<String> pushTriggerQueue(TriggerParam triggerParam) {\n\t\t// avoid repeat\n\t\tif (triggerLogIdSet.contains(triggerParam.getLogId())) {\n\t\t\tlogger.info(">>>>>>>>>>> repeate trigger job, logId:{}", triggerParam.getLogId());\n\t\t\treturn new ReturnT<String>(ReturnT.FAIL_CODE, "repeate trigger job, logId:" + triggerParam.getLogId());\n\t\t}\n\n\t\ttriggerLogIdSet.add(triggerParam.getLogId());\n\t\ttriggerQueue.add(triggerParam);\n        return ReturnT.SUCCESS;\n\t}\n    // çº¿ç¨æ¯å¦å¨å·¥ä½ï¼æèéåä¸­æ¯å¦æä»»å¡ç­å¾æ§è¡\n    public boolean isRunningOrHasQueue() {\n        return running || triggerQueue.size()>0;\n    }\n\n    @Override\n\tpublic void run() {\n\t\t// æä¸å®ç°\n\t}\n}\n\n\nè¿ä¸ªpushTriggerParam æ²¡å¹²å¥äºï¼æ éå°±æ¯å¤æ­ä¸ä¸æ¯å¦éå¤è°åº¦ï¼ç¶åå°triggerParamæ¾å¥é»å¡éåã\n\nrunæ¹æ³ææ¯éå¤´æï¼\n\n@Override\npublic void run() {\n\n    // init\n    try {\n        handler.init();\n    } catch (Throwable e) {\n        logger.error(e.getMessage(), e);\n    }\n\n    // \n    while(!toStop){\n        running = false;\n        idleTimes++;\n\n        TriggerParam triggerParam = null;\n        try {\n            triggerParam = triggerQueue.poll(3L, TimeUnit.SECONDS);\n            if (triggerParam != null) {\n                running = true;\n                idleTimes = 0;\n                triggerLogIdSet.remove(triggerParam.getLogId());\n                // æå°æ¥å¿ï¼è¡¨ç¤ºä»»å¡å°è¦æ§è¡\n                XxlJobHelper.log("<br>----------- xxl-job job execute start -----------<br>----------- Param:" + xxlJobContext.getJobParam());\n                // æ§è¡ä»»å¡!!!\n                handler.execute();\n            } else {\n                if (idleTimes > 30) {\n                    if(triggerQueue.size() == 0) {\t\n                        // å°æ­¤çº¿ç¨åæ­¢ï¼æèè¯´ç§»é¤\n                        XxlJobExecutor.removeJobThread(jobId, "excutor idel times over limit.");\n                    }\n                }\n            }\n        } catch (Throwable e) {\n            if (toStop) {\n                XxlJobHelper.log("<br>----------- JobThread toStop, stopReason:" + stopReason);\n            }\n\n            // handle result\n            StringWriter stringWriter = new StringWriter();\n            e.printStackTrace(new PrintWriter(stringWriter));\n            String errorMsg = stringWriter.toString();\n\n            XxlJobHelper.handleFail(errorMsg);\n\n            XxlJobHelper.log("<br>----------- JobThread Exception:" + errorMsg + "<br>----------- xxl-job job execute end(error) -----------");\n        } finally {\n            if(triggerParam != null) {\n                // callback handler info\n                if (!toStop) {\n                    // commonm\n                    TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        triggerParam.getLogId(),\n                        triggerParam.getLogDateTime(),\n                        XxlJobContext.getXxlJobContext().getHandleCode(),\n                        XxlJobContext.getXxlJobContext().getHandleMsg() )\n                                                      );\n                } else {\n                    // is killed\n                    TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        triggerParam.getLogId(),\n                        triggerParam.getLogDateTime(),\n                        XxlJobContext.HANDLE_CODE_FAIL,\n                        stopReason + " [job running, killed]" )\n                                                      );\n                }\n            }\n        }\n    }\n    // destroy\n    try {\n        handler.destroy();\n    } catch (Throwable e) {\n        logger.error(e.getMessage(), e);\n    }\n    logger.info(">>>>>>>>>>> xxl-job JobThread stoped, hashCode:{}", Thread.currentThread());\n}\n\n\næºä»£ç å¶å®æºå¤æçï¼èä¸å¾å¤ä¸è¥¿ç°å¨æ²¡æè®²å°ï¼æä»¥æå åäºå¾å¤ï¼ç­ä¼è¡¥ä¸ã\n\n 1. æ§è¡åå§åæ¹æ³ï¼è¿å¥å¾ªç¯\n\n 2. æ¯æ¬¡å¾ªç¯é½å° idleTimes å ä¸ï¼ä»é»å¡éåä¸­åå¼ï¼æå¤ç­å¾ä¸ç§ï¼å¦æè¶è¿äºå°±è¯´æç°å¨æ²¡æä»»å¡ï¼åæ¬¡å¾ªç¯ï¼å¦ææ æå¾ªç¯ 30 æ¬¡ï¼å°±ä¼è§¦å XxlJobExecutor.removeJobThread å°æ­¤çº¿ç¨åæ­¢å¹¶ç§»é¤ã\n\n 3. å¦æä»é»å¡éåä¸­åå°äºå¼ï¼å° idleTimesç½®ä¸º0ï¼å¹¶å° running = true è¡¨ç¤ºä»ç°å¨å¼å§è¦æ§è¡ä»»å¡äº\n    \n    æå°ä¸ä¸æ¥å¿ï¼ä½¿ç¨ handler.execute() æ§è¡ä»»å¡ã\n\n 4. å¦æåºç°å¼å¸¸ï¼é¤äºæå°æ¥å¿ä¹å¤ï¼æ§è¡äº XxlJobHelper.handleFail(errorMsg) è¿å¥è¯ï¼è®°ä½å®ï¼ç­ä¼è¯´\n\n 5. å¨ finally åä¸­è°ç¨ TriggerCallbackThread.pushCallBack() å°ä»»å¡æ§è¡çç»æåè°ç»è°åº¦ä¸­å¿ï¼è¿ä¸ªæä¸ä¸è¯´ï¼åé¢çç« èä¼å®åã\n\nä½æ¯ç°å¨å®æ¶ä»»å¡çæ§è¡åè½è¿ä¸å®åï¼æä»¬ä¹åä½¿ç¨çæ¶åæ¯æ è¶æ¶æ¶é´ è¿ä¸ªåè½çï¼è¿ä¸ªåè½è¯¥å¦ä½å®ç°ï¼æä»¬å¯ä»¥æ°åå»ºä¸ä¸ªçº¿ç¨ï¼å°å®æ¶ä»»å¡åè£ä¸ºä¸ä¸ª FutureTaskï¼å¨æ§è¡çæ¶å future.get(seconds)ï¼å¦ææ§è¡è¶æ¶ï¼å°±ä¼åºç°è¶æ¶å¼å¸¸ï¼æä»¬å°å¶æè·å°±å¯ä»¥äºã\n\næ·»å äºè¶æ¶æ¶é´åè½çä»£ç ï¼\n\n@Override\npublic void run() {\n\n    // init\n    try {\n        handler.init();\n    } catch (Throwable e) {\n        logger.error(e.getMessage(), e);\n    }\n\n    // execute\n    while(!toStop){\n        running = false;\n        idleTimes++;\n\n        TriggerParam triggerParam = null;\n        try {\n            triggerParam = triggerQueue.poll(3L, TimeUnit.SECONDS);\n            if (triggerParam!=null) {\n                running = true;\n                idleTimes = 0;\n                triggerLogIdSet.remove(triggerParam.getLogId());\n                // æå°æ¥å¿ï¼è¡¨ç¤ºä»»å¡å°è¦æ§è¡\n                XxlJobHelper.log("<br>----------- xxl-job job execute start -----------<br>----------- Param:" + xxlJobContext.getJobParam());\n                if (triggerParam.getExecutorTimeout() > 0) {\n                    // limit timeout\n                    Thread futureThread = null;\n                    try {\n                        FutureTask<Boolean> futureTask = new FutureTask<Boolean>(new Callable<Boolean>() {\n                            @Override\n                            public Boolean call() throws Exception {\n                                handler.execute();\n                                return true;\n                            }\n                        });\n                        futureThread = new Thread(futureTask);\n                        futureThread.start();\n\n                        Boolean tempResult = futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);\n                    } catch (TimeoutException e) {\n\n                        XxlJobHelper.log("<br>----------- xxl-job job execute timeout");\n                        XxlJobHelper.log(e);\n                    } finally {\n                        futureThread.interrupt();\n                    }\n                } else {\n                    // just execute\n                    handler.execute();\n                }\n            } else {\n                if (idleTimes > 30) {\n                    if(triggerQueue.size() == 0) {\t\n                        XxlJobExecutor.removeJobThread(jobId, "excutor idel times over limit.");\n                    }\n                }\n            }\n        } catch (Throwable e) {\n            if (toStop) {\n                XxlJobHelper.log("<br>----------- JobThread toStop, stopReason:" + stopReason);\n            }\n\n            // handle result\n            StringWriter stringWriter = new StringWriter();\n            e.printStackTrace(new PrintWriter(stringWriter));\n            String errorMsg = stringWriter.toString();\n\n            XxlJobHelper.handleFail(errorMsg);\n\n            XxlJobHelper.log("<br>----------- JobThread Exception:" + errorMsg + "<br>----------- xxl-job job execute end(error) -----------");\n        } finally {\n            if(triggerParam != null) {\n                // callback handler info\n                if (!toStop) {\n                    // commonm\n                    TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        triggerParam.getLogId(),\n                        triggerParam.getLogDateTime(),\n                        XxlJobContext.getXxlJobContext().getHandleCode(),\n                        XxlJobContext.getXxlJobContext().getHandleMsg() )\n                                                      );\n                } else {\n                    // is killed\n                    TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        triggerParam.getLogId(),\n                        triggerParam.getLogDateTime(),\n                        XxlJobContext.HANDLE_CODE_FAIL,\n                        stopReason + " [job running, killed]" )\n                                                      );\n                }\n            }\n        }\n    }\n    // destroy\n    try {\n        handler.destroy();\n    } catch (Throwable e) {\n        logger.error(e.getMessage(), e);\n    }\n    logger.info(">>>>>>>>>>> xxl-job JobThread stoped, hashCode:{}", Thread.currentThread());\n}\n\n\nå¯ä»¥çå°è¿ä¸ªå¾ªç¯å¶å®å¾å®¹æåä¸æ¥ï¼æä»¬åªéè¦å° toStop è®¾ç½®ä¸º trueï¼è¿ä¸ªå¤çº¿ç¨çå¾ªç¯å°±ä¼åæ­¢ã\n\npublic void toStop(String stopReason) {\n    toStop = true;\n    this.stopReason = stopReason;\n}\n\n\n\n# 5. XxlJobContext\n\nå¨ä¸é¢çä»£ç ä¸­ï¼XxlJobContext å XxlJobHelper åºç°äºå¾å¤æ¬¡ï¼XxlJobHelper æä»¬å¨åæå·²ç»è¯ç¨äºï¼å°±æ¯è®°å½æ¥å¿çåï¼ä½æ¯å®ä¸ä»ä»å¯ä»¥è®°å½æ¥å¿ï¼è¿å¯ä»¥ä¿®æ¹ XxlJobContext çç¶æï¼é£ä¹ XxlJobContext æ¯ä»ä¹å¢ï¼\n\nåªè¦æ¶å Context çé½æ¯ä¸ä¸æï¼XxlJobContext ä¹ä¸ä¾å¤ï¼æå«å®ä»»å¡ä¸ä¸æï¼ä½¿ç¨ Context çä½ç¨å°±æ¯æä»¬å¯ä»¥å°æäºä¿¡æ¯ç´æ¥æ¾éé¢ï¼æ³ç¨çæ¶åç´æ¥ XxlJobContext.getXXX() æ¿åºæ¥ï¼èä¸æ¯å°ä¿¡æ¯ä½ä¸ºæ¹æ³çåæ°ä¼ æ¥ä¼ å»çã\n\npublic class XxlJobContext {\n\n    public static final int HANDLE_CODE_SUCCESS = 200;\n    public static final int HANDLE_CODE_FAIL = 500;\n    public static final int HANDLE_CODE_TIMEOUT = 502;\n\n    // ---------------------- base info ----------------------\n\n    /**\n     * ä»»å¡id\n     */\n    private final long jobId;\n\n    /**\n     * ä»»å¡åæ°\n     */\n    private final String jobParam;\n\n    /**\n     * ä»»å¡æ¥å¿æä»¶çæä»¶å\n     */\n    private final String jobLogFileName;\n\n    /**\n     * åçç´¢å¼\n     */\n    private final int shardIndex;\n\n    /**\n     * åçæ»æ°\n     */\n    private final int shardTotal;\n\n    /**\n     * handleCodeï¼æ§è¡ç»æ\n     *\n     *      200 : success\n     *      500 : fail\n     *      502 : timeout\n     *\n     */\n    private int handleCode;\n\n    /**\n     * æ§è¡ä¿¡æ¯\n     */\n    private String handleMsg;\n    \n    private static InheritableThreadLocal<XxlJobContext> contextHolder = new InheritableThreadLocal<XxlJobContext>(); \n\n    public static void setXxlJobContext(XxlJobContext xxlJobContext){\n        contextHolder.set(xxlJobContext);\n    }\n\n    public static XxlJobContext getXxlJobContext(){\n        return contextHolder.get();\n    }\n\n}\n\n\né¤äºä¸äºåºæ¬ä¿¡æ¯ä»¥å¤ï¼XxlJobContext æä¾äº setXxlJobContext çæ¹æ³ï¼å° XxlJobContext æ¾å° ThreadLocal ä¸­ï¼è¿ä¸ª InheritableThreadLocal ç»§æ¿èª ThreadLocalï¼ä½ç¨æ¯å¯ä»¥ä¿è¯ç¶å­çº¿ç¨å±ç¨æ°æ®ã\n\né£ä¹å®ä»ä¹æ¶ååå»ºï¼å¿ç¶æ¯æä»»å¡æ§è¡çæ¶ååå»ºã\n\næ³è¦æ´æ¹ XxlJobContext çæ°æ®å¶å®ä¹æºéº»ç¦ç\n\nXxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\nxxlJobContext.setHandlerMsg("xxxxxx");\n\n\næ³è¦ä¿®æ¹ XxlJobContext ä¸­ç handle_codeãhandle_Msg éè¦ä¸¤è¡ä»£ç ï¼æºéº»ç¦çã\n\næä»¥ XxlJobHelper ç»æä»¬å°è£äºä¸ä¸ï¼æ¯å¦è·åå½åæ­£å¨æ§è¡çä»»å¡çåæ°ãè·åå½åæ­£å¨æ§è¡çä»»å¡çè°åº¦ä¿¡æ¯ãè®¾ç½®å½åæ­£å¨æ§è¡çä»»å¡çæ§è¡ç»æ...\n\npublic class XxlJobHelper {\n\n    // ---------------------- base info ----------------------\n\n    /**\n     * current JobId\n     *\n     * @return\n     */\n    public static long getJobId() {\n        XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n        if (xxlJobContext == null) {\n            return -1;\n        }\n\n        return xxlJobContext.getJobId();\n    }\n\n    /**\n     * current JobParam\n     *\n     * @return\n     */\n    public static String getJobParam() {\n        XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n        if (xxlJobContext == null) {\n            return null;\n        }\n\n        return xxlJobContext.getJobParam();\n    }\n\n    // ---------------------- for log ----------------------\n\n    /**\n     * current JobLogFileName\n     *\n     * @return\n     */\n    public static String getJobLogFileName() {\n        XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n        if (xxlJobContext == null) {\n            return null;\n        }\n\n        return xxlJobContext.getJobLogFileName();\n    }\n\n    public static int getShardIndex() {\n        XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n        if (xxlJobContext == null) {\n            return -1;\n        }\n\n        return xxlJobContext.getShardIndex();\n    }\n\n    /**\n     * current ShardTotal\n     *\n     * @return\n     */\n    public static int getShardTotal() {\n        XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n        if (xxlJobContext == null) {\n            return -1;\n        }\n\n        return xxlJobContext.getShardTotal();\n    }\n    public static boolean handleSuccess(){\n        return handleResult(XxlJobContext.HANDLE_CODE_SUCCESS, null);\n    }\n    public static boolean handleSuccess(String handleMsg) {\n        return handleResult(XxlJobContext.HANDLE_CODE_SUCCESS, handleMsg);\n    }\n    public static boolean handleFail(){\n        return handleResult(XxlJobContext.HANDLE_CODE_FAIL, null);\n    }\n\n    /**\n     * handle fail with log msg\n     *\n     * @param handleMsg\n     * @return\n     */\n    public static boolean handleFail(String handleMsg) {\n        return handleResult(XxlJobContext.HANDLE_CODE_FAIL, handleMsg);\n    }\n\n    /**\n     * handle timeout\n     *\n     * @return\n     */\n    public static boolean handleTimeout(){\n        return handleResult(XxlJobContext.HANDLE_CODE_TIMEOUT, null);\n    }\n\n    /**\n     * handle timeout with log msg\n     *\n     * @param handleMsg\n     * @return\n     */\n    public static boolean handleTimeout(String handleMsg){\n        return handleResult(XxlJobContext.HANDLE_CODE_TIMEOUT, handleMsg);\n    }\n\n    /**\n     * @param handleCode\n     *\n     *      200 : success\n     *      500 : fail\n     *      502 : timeout\n     *\n     * @param handleMsg\n     * @return\n     */\n    public static boolean handleResult(int handleCode, String handleMsg) {\n        XxlJobContext xxlJobContext = XxlJobContext.getXxlJobContext();\n        if (xxlJobContext == null) {\n            return false;\n        }\n\n        xxlJobContext.setHandleCode(handleCode);\n        if (handleMsg != null) {\n            xxlJobContext.setHandleMsg(handleMsg);\n        }\n        return true;\n    }\n\n}\n\n\nè¿ä»£ç æå°±ä¸ç»è®²äºï¼æ éå°±æ¯è·å XxlJobContextï¼set/get å¥çãä½ å°±è®°ä½ï¼ä½¿ç¨ XxlJobContext å¯ä»¥è·åå½åæ­£å¨æ§è¡çä»»å¡çä¿¡æ¯ï¼è XxlJobHelper æä¾äºä¾¿äºæä½å®çAPIã\n\nç°å¨å¯ä»¥è´´ JobThread#run çå¨é¨ä»£ç äº\n\n@Override\npublic void run() {\n\n    // init\n    try {\n        handler.init();\n    } catch (Throwable e) {\n        logger.error(e.getMessage(), e);\n    }\n\n    // execute\n    while(!toStop){\n        running = false;\n        idleTimes++;\n\n        TriggerParam triggerParam = null;\n        try {\n            triggerParam = triggerQueue.poll(3L, TimeUnit.SECONDS);\n            if (triggerParam!=null) {\n                running = true;\n                idleTimes = 0;\n                triggerLogIdSet.remove(triggerParam.getLogId());\n\t\t\t\t// çææ¥å¿æä»¶ï¼è¿ä¸ªä»¥åä¼è¯´\n                String logFileName = XxlJobFileAppender.makeLogFileName(new Date(triggerParam.getLogDateTime()), triggerParam.getLogId());\n                \n                // ä»»å¡ååå¤å¼å§æ§è¡ï¼æ¯åå»º XxlJobContext çå¤§å¥½æ¶æºå\n                XxlJobContext xxlJobContext = new XxlJobContext(\n                    triggerParam.getJobId(),\n                    triggerParam.getExecutorParams(),\n                    logFileName,\n                    triggerParam.getBroadcastIndex(),\n                    triggerParam.getBroadcastTotal()\n                );\n\n                // å° XxlJobContext æ¾å¥ ThreadLocal\n                XxlJobContext.setXxlJobContext(xxlJobContext);\n\n                // æå°æ¥å¿ï¼å¼å§æ§è¡!\n                XxlJobHelper.log("<br>----------- xxl-job job execute start -----------<br>----------- Param:" + xxlJobContext.getJobParam());\n\t\t\t\t// å¦æè®¾ç½®äºè¶æ¶æ¶é´ï¼å¼å¯æ°çº¿ç¨ï¼åè£ä¸º FutureTask æ§è¡ãè¶æ¶å°±ç»æ\n                if (triggerParam.getExecutorTimeout() > 0) {\n                    // limit timeout\n                    Thread futureThread = null;\n                    try {\n                        FutureTask<Boolean> futureTask = new FutureTask<Boolean>(new Callable<Boolean>() {\n                            @Override\n                            public Boolean call() throws Exception {\n\t\t\t\t\t\t\t\t// ç±äºæ¯å¼å¯æ°çº¿ç¨æ§è¡ï¼æä»¥è¦éæ°è®¾ç½®ä¸ä¸ã\n                                XxlJobContext.setXxlJobContext(xxlJobContext);\n\t\t\t\t\t\t\t\t// å¼å§æ§è¡\n                                handler.execute();\n                                // å¦æè½æ§è¡å®è¿åtrue\n                                return true;\n                            }\n                        });\n                        futureThread = new Thread(futureTask);\n                        futureThread.start();\n\t\t\t\t\t\t// getç»æï¼æå®æ¶é´ågetä¸å°å°±æåºå¼å¸¸ã\n                        Boolean tempResult = futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);\n                    } catch (TimeoutException e) {\n\n                        XxlJobHelper.log("<br>----------- xxl-job job execute timeout");\n                        XxlJobHelper.log(e);\n\n                        // æè·å¼å¸¸ä¹åé¤äºè®°å½æ¥å¿ï¼è¿è¦å°timeoutè®°å½å¨contextä¸­ã\n                        XxlJobHelper.handleTimeout("job execute timeout ");\n                    } finally {\n                        futureThread.interrupt();\n                    }\n                } else {\n                    // just execute\n                    handler.execute();\n                }\n\n                // èµ°å°è¿éå¦æ handler_code è¿æ¯ <= 0ï¼åªè½è¯´è¿ä¸ªä»»å¡ä¸¢å¤±äº\n                if (XxlJobContext.getXxlJobContext().getHandleCode() <= 0) {\n                    XxlJobHelper.handleFail("job handle result lost.");\n                } else {\n                    // å¦åè¿ä¸ªä»»å¡å°±æ¯æåäºãå ä¸ºä¸ä¸åºç°å¼å¸¸ä¼è¢«catchå°æ ¹æ¬ä¸ä¼èµ°å°è¿é\n                    String tempHandleMsg = XxlJobContext.getXxlJobContext().getHandleMsg();\n                    tempHandleMsg = (tempHandleMsg!=null&&tempHandleMsg.length()>50000)\n                        ?tempHandleMsg.substring(0, 50000).concat("...")\n                        :tempHandleMsg;\n                    XxlJobContext.getXxlJobContext().setHandleMsg(tempHandleMsg);\n                }\n                // æå°æ¥å¿\n                XxlJobHelper.log("<br>----------- xxl-job job execute end(finish) -----------<br>----------- Result: handleCode="\n                                 + XxlJobContext.getXxlJobContext().getHandleCode()\n                                 + ", handleMsg = "\n                                 + XxlJobContext.getXxlJobContext().getHandleMsg()\n                                );\n\n            } else {\n                // å¦ææ²¡æå¨éåä¸­ååºä»»å¡ï¼å¹¶ä¸å·²ç»æ æå¾ªç¯äº30æ¬¡ (ä¹å°±æ¯90s)ï¼å°çº¿ç¨éæ¯\n                if (idleTimes > 30) {\n                    // åæ¬¡éå¤å¤æ­ï¼é¿åå¹¶åæåµ\n                    if(triggerQueue.size() == 0) {\t\n                        XxlJobExecutor.removeJobThread(jobId, "excutor idel times over limit.");\n                    }\n                }\n            }\n        } catch (Throwable e) {\n            if (toStop) {\n                XxlJobHelper.log("<br>----------- JobThread toStop, stopReason:" + stopReason);\n            }\n\n            // handle result\n            StringWriter stringWriter = new StringWriter();\n            e.printStackTrace(new PrintWriter(stringWriter));\n            String errorMsg = stringWriter.toString();\n\t\t\t// å¦æåºç°å¼å¸¸ï¼å°ä»»å¡è®¾ç½®ä¸ºå¤±è´¥ï¼å¹¶å¡«ä¸å¤±è´¥ä¿¡æ¯\n            XxlJobHelper.handleFail(errorMsg);\n\n            XxlJobHelper.log("<br>----------- JobThread Exception:" + errorMsg + "<br>----------- xxl-job job execute end(error) -----------");\n        } finally {\n            // å°æ­¤ä»»å¡çæ§è¡ç»æåéç»è°åº¦ä¸­å¿ï¼è¿ä¸ªåä¸ç®¡ã\n            if(triggerParam != null) {\n                // callback handler info\n                if (!toStop) {\n                    // commonm\n                    TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        triggerParam.getLogId(),\n                        triggerParam.getLogDateTime(),\n                        XxlJobContext.getXxlJobContext().getHandleCode(),\n                        XxlJobContext.getXxlJobContext().getHandleMsg() )\n                                                      );\n                } else {\n                    // is killed\n                    TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        triggerParam.getLogId(),\n                        triggerParam.getLogDateTime(),\n                        XxlJobContext.HANDLE_CODE_FAIL,\n                        stopReason + " [job running, killed]" )\n                                                      );\n                }\n            }\n        }\n    }\n\n    // è½èµ°å°è¿éï¼è¯´æ toStopåéè¢«è®¾ç½®ä¸ºtrueäºï¼æä»¥ä¸ä¸¤ç§å¯è½:\n    // 1. å¼åäººåæå¨å³é­å®æ¶ä»»å¡\n    // 2. ä»»å¡å¾ä¹æ²¡ææ§è¡ï¼è§¦åäº XxlJobExecutor.removeJobThread()å°çº¿ç¨ç§»é¤\n    // ç°å¨è¦å¤æ­éåä¸­æ¯å¦è¿æå¼ï¼å¦ææ¯å ä¸ºç¬¬äºç§æåµèµ°åºçwhileå¾ªç¯ï¼æ ¹æ¬ä¸ä¼èµ°ä¸é¢çé»è¾\n    // å¦æå®æ¶ä»»å¡å³é­äºï¼å°ææè¿ä¸ªä»»å¡æ²¡æ§è¡ç"æ¬¡æ°"å¨é¨ååºæ¥åéç»è°åº¦ä¸­å¿ï¼åè¯å¼åäººåè¿äºæ²¡æ§è¡ã\n    while(triggerQueue !=null && triggerQueue.size()>0){\n        TriggerParam triggerParam = triggerQueue.poll();\n        if (triggerParam!=null) {\n            // is killed\n            TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                triggerParam.getLogId(),\n                triggerParam.getLogDateTime(),\n                XxlJobContext.HANDLE_CODE_FAIL,\n                stopReason + " [job not executed, in the job queue, killed.]")\n                                              );\n        }\n    }\n\n    // destroy\n    try {\n        handler.destroy();\n    } catch (Throwable e) {\n        logger.error(e.getMessage(), e);\n    }\n\n    logger.info(">>>>>>>>>>> xxl-job JobThread stoped, hashCode:{}", Thread.currentThread());\n}\n\n\nè¿éæ¾åºå¨é¨ JobThread çä»£ç ï¼ï¼ççå¯ä»¥ä¸è½½æºç å»çï¼å¨è¿éçä¸è½ ctrl ç¹å»ï¼é¾åï¼\n\nä¸ºäºæ¹ä¾¿éè¯»ï¼æå° å¤æ­æ¯å¦æè¶æ¶æ¶é´ é£æ®µé»è¾å°è£ä¸ºäº doExecutor æ¹æ³ï¼å¸æä½ è½çè§£ã\n\npublic class JobThread extends Thread {\n    private static Logger logger = LoggerFactory.getLogger(JobThread.class);\n\n    /**\n     * å®æ¶ä»»å¡çid\n     */\n    private int jobId;\n\n    /**\n     * æ­¤ä»»å¡ç»å®çå¯¹è±¡\n     */\n    private IJobHandler handler;\n\n    /**\n     * åå«éè¦è¢«æ§è¡çå®æ¶ä»»å¡(è§¦åå¨åæ°)\n     */\n    private LinkedBlockingQueue<TriggerParam> triggerQueue;\n\n    /**\n     * æ­£å¨è°åº¦çä»»å¡çæ¥å¿idéå(çº¿ç¨å®å¨)\n     */\n    private Set<Long> triggerLogIdSet;\n\n    /**\n     * è¯¥ç»ä»¶æ¯å¦ç»æï¼å¦æè¿ä¸ªç»ä»¶ç»æï¼è¯´æè¯¥çº¿ç¨æ­£å¨è´è´£çå®æ¶ä»»å¡è¢«åæ¶äº\n     */\n    private volatile boolean toStop = false;\n\n    /**\n     * è¯¥ä»»å¡è¢«åæ¶çåå \n     */\n    private String stopReason;\n\n    /**\n     * è¯¥çº¿ç¨æ¯å¦æ­£å¨è¿è¡(æ­£å¨è¿è¡ä»»å¡ï¼å¦æåªæ¯ç­å¾ä»éåä¸­åä»»å¡ä¸ç®è¿è¡ä¸­)\n     */\n    private boolean running = false;\n\n    /**\n     * ç©ºè½¬æ¬¡æ°ï¼è¾¾å°ä¸å®æ¬¡æ°ä¾¿éæ¯è¯¥çº¿ç¨ï¼è¿é»å¡é½ä¸è®©å®é»å¡\n     */\n    private int idleTimes = 0;\n\n    public JobThread(int jobId, IJobHandler handler) {\n        this.jobId = jobId;\n        this.handler = handler;\n        this.triggerQueue = new LinkedBlockingQueue<>();\n        this.triggerLogIdSet = Collections.synchronizedSet(new HashSet<>());\n        this.setName("xxl-job, JobThread - " + jobId + " - " + System.currentTimeMillis());\n    }\n\n    /**\n     * è°åº¦åæ°æ¾å¥è°åº¦éå\n     *\n     * @param triggerParam\n     */\n    public Result pushTriggerQueue(TriggerParam triggerParam) {\n        // å¦ææ¥å¿idéåä¸­åå«æ­¤è°åº¦åæ°ï¼è¯´æå¯è½éå¤è°åº¦äº\n        if (triggerLogIdSet.contains(triggerParam.getLogId())) {\n            logger.info(">>>>>>>>>>>> repeate trigger job, logId: {}", triggerParam.getLogId());\n            return Result.error("repeate trigger job, logId:" + triggerParam.getLogId());\n        }\n        triggerLogIdSet.add(triggerParam.getLogId());\n        triggerQueue.add(triggerParam);\n        return Result.success();\n    }\n\n    /**\n     * å¤æ­è¯¥çº¿ç¨æ¯å¦æ­£å¨å¿ç¢ï¼æ­£å¨è¿è¡ä»»å¡ãé»å¡éåä¸­æè°åº¦åæ°ç­å¾æ§è¡ ä»£è¡¨å¿ç¢\n     */\n    public boolean isRunningOrHasQueue() {\n        return running || !triggerQueue.isEmpty();\n    }\n\n    @Override\n    public void run() {\n        // æ§è¡åå§åæ¹æ³\n        runInitMethod();\n        // å¼å§æ§è¡\n        while (!toStop) {\n            // åè¿å¥å¾ªç¯ä¸ç®æ§è¡ï¼å¾å°è°åº¦åæ°æç®æ§è¡\n            running = false;\n            idleTimes += 1;\n            TriggerParam triggerParam = null;\n            try {\n                triggerParam = triggerQueue.poll(3L, TimeUnit.SECONDS);\n                if (triggerParam == null) {\n                    // å¦æé»å¡3sæ²¡æè°åº¦åæ°ï¼å¹¶ä¸ç°å¨å·²ç»å¾ªç¯äº30æ¬¡ï¼éåä¸­è¿æ¯æ²¡ææ°æ®ï¼å¾ï¼éæ¯çº¿ç¨\n                    if (idleTimes > 30 && triggerQueue.isEmpty()) {\n                        // è°ç¨XxlJobExecutor.removeJobThread() å»éæ¯çº¿ç¨\n                        XxlJobExecutor.removeJobThread(jobId, "å¤ªä¹ä¸æ§è¡ï¼çº¿ç¨éæ¯äº");\n                    }\n                } else {\n                    // è°åº¦åæ°ä¸ä¸ºç©ºï¼å°runningæ¹ä¸ºtrue, ç©ºè½¬æ¬¡æ°æ¹ä¸º0\n                    running = true;\n                    idleTimes = 0;\n                    triggerLogIdSet.remove(triggerParam.getLogId());\n                    String logFileName = XxlJobFileAppender.makeLogFileName(new Date(triggerParam.getLogDateTime()), triggerParam.getLogId());\n                    XxlJobContext xxlJobContext = new XxlJobContext(\n                            triggerParam.getJobId(),\n                            triggerParam.getExecutorParams(),\n                            logFileName,\n                            triggerParam.getBroadcastIndex(),\n                            triggerParam.getBroadcastTotal()\n                    );\n                    XxlJobContext.setXxlJobContext(xxlJobContext);\n                    // è®°å½æ¥å¿ï¼å¼å§æ§è¡\n                    XxlJobHelper.log("<br>----------- xxl-job job execute start -----------<br>----------- Param:" + xxlJobContext.getJobParam());\n                    // æ§è¡å®æ¶ä»»å¡ï¼æ ¹æ®æ¯å¦è®¾ç½®è¶æ¶æ¶é´æ¥æ§è¡ã\n                    // å¦ææ²¡æè®¾ç½®è¶æ¶æ¶é´å°±ç´æ¥æ§è¡ã å¦æè®¾ç½®äºè¶æ¶æ¶é´å°±å¼å¯å­çº¿ç¨ï¼ä½¿ç¨ FutureTask æ§è¡ã\n                    doExecute(triggerParam, xxlJobContext);\n\n                    // å¤æ­æ§è¡ç»æ\n                    if (XxlJobContext.getXxlJobContext().getHandleCode() <= 0) {\n                        XxlJobHelper.handleFail("job handle result lost.");\n                    } else {\n                        // å¦ææ§è¡ç»æå¤§äº0ï¼ä¸ç®¡æåè¿æ¯å¤±è´¥å°±ç´æ¥è®°å½æ¶æ¯ï¼ç­åè°çº¿ç¨å»åè°ãå¦ææ§è¡æåäºhandleMsgä¸ºç©º\n                        String tempHandleMsg = XxlJobContext.getXxlJobContext().getHandleMsg();\n                        tempHandleMsg = (tempHandleMsg != null && tempHandleMsg.length() > 50000) ? tempHandleMsg.substring(0, 50000).concat("...") : tempHandleMsg;\n                        XxlJobContext.getXxlJobContext().setHandleMsg(tempHandleMsg);\n                    }\n                    // åè°çæ§è¡ç»æå±ä¸ç®¡ï¼ç°å¨çæ§è¡ç»æåè®°å½æ¥å¿\n                    XxlJobHelper.log("<br>------------ xxl-job job execute end(finish)-------------<br>------------- Result: handleCode=" +\n                            XxlJobContext.getXxlJobContext().getHandleCode() +\n                            ", handleMsg = " +\n                            XxlJobContext.getXxlJobContext().getHandleMsg()\n                    );\n                }\n            } catch (Exception e) {\n                if (toStop) {\n                    // å¦æçº¿ç¨åæ­¢äºï¼è®°å½åæ­¢åå ãå¼å¸¸\n                    XxlJobHelper.log("<br>----------- JobThread toStop, stopReason:" + stopReason);\n                    StringWriter stringWriter = new StringWriter();\n                    e.printStackTrace(new PrintWriter(stringWriter));\n                    String errorMessage = stringWriter.toString();\n                    // å°XxlJobContextä¸­ä»»å¡çæ§è¡ç¶ææ¹ä¸ºå¤±è´¥\n                    XxlJobHelper.handleFail(errorMessage);\n                    XxlJobHelper.log("<br>----------- JobThread Exception:" + errorMessage +\n                            "<br>----------- xxl-job job execute end(error)");\n                }\n            } finally {\n                // å¨finallyä¸­æ§è¡å°æ¥å¿åè°ç»è°åº¦ä¸­å¿çæä½\n                if (triggerParam != null) {\n                    // å¦æçº¿ç¨æ²¡æåæ­¢ï¼ä¸ç®¡ä»»å¡æ§è¡æåè¿æ¯å¤±è´¥ï¼åè°ç»è°åº¦ä¸­å¿å³å¯ã\n                    // å¦æçº¿ç¨è¢«ç»æ­¢äºï¼å°stopReasonåéç»è°åº¦ä¸­å¿\n                    if (!toStop) {\n                        TriggerCallbackThread.pushCallback(new HandlerCallbackParam(\n                                triggerParam.getLogId(),\n                                triggerParam.getLogDateTime(),\n                                XxlJobContext.getXxlJobContext().getHandleCode(),\n                                XxlJobContext.getXxlJobContext().getHandleMsg()\n                        ));\n                    } else {\n                        TriggerCallbackThread.pushCallback(new HandlerCallbackParam(\n                                triggerParam.getLogId(),\n                                triggerParam.getLogDateTime(),\n                                XxlJobContext.HANDLE_CODE_FAIL,\n                                stopReason + "[job running, killed]"\n                        ));\n                    }\n                }\n            }\n\n        }\n\n        // éåºwhileå¾ªç¯ï¼æåå°éåä¸­æ²¡æ¥å¾åæ§è¡çæ°æ®æ¿åºæ¥åè°åå»ï¼åè¯è°åº¦ä¸­å¿è¿äºæ°æ®æ²¡ææ§è¡\n        while (triggerQueue != null && !triggerQueue.isEmpty()) {\n            TriggerParam triggerParam = triggerQueue.poll();\n            if (triggerParam == null) {\n                continue;\n            }\n            TriggerCallbackThread.pushCallback(new HandlerCallbackParam(\n                    triggerParam.getLogId(),\n                    triggerParam.getLogDateTime(),\n                    XxlJobContext.HANDLE_CODE_FAIL,\n                    stopReason + " [job not executed, in the job queue, killed.]"\n            ));\n        }\n        // æ§è¡éæ¯æ¹æ³\n        runDestroyMethod();\n    }\n\n    private void runInitMethod() {\n        try {\n            handler.init();\n        } catch (Exception e) {\n            logger.error(e.getMessage(), e);\n        }\n    }\n\n    private void runDestroyMethod() {\n        try {\n            handler.destroy();\n        } catch (Exception e) {\n            logger.error(e.getMessage(), e);\n        }\n    }\n\n    /**\n     * æ§è¡å®æ¶ä»»å¡ï¼æ ¹æ®æ¯å¦è®¾ç½®è¶æ¶æ¶é´æ¥æ§è¡ã\n     * å¦æè®¾ç½®äºè¶æ¶æ¶é´å°±å¼å¯å­çº¿ç¨ï¼ä½¿ç¨ FutureTask æ§è¡ã\n     * å¦ææ²¡æè®¾ç½®è¶æ¶æ¶é´å°±ç´æ¥æ§è¡\n     *\n     * @param triggerParam\n     * @param xxlJobContext\n     */\n    private void doExecute(TriggerParam triggerParam, XxlJobContext xxlJobContext) throws Exception {\n        // æ²¡æè®¾ç½®è¶æ¶æ¶é´ï¼ç´æ¥æ§è¡ï¼è®¾ç½®äºè¶æ¶æ¶é´ï¼å¼å¯å­çº¿ç¨æ§è¡ï¼æ­¤çº¿ç¨çç£å­çº¿ç¨æ§è¡\n        if (triggerParam.getExecutorTimeout() == 0) {\n            try {\n                handler.execute();\n            } catch (Exception e) {\n                XxlJobHelper.log("<br>-------------- xxl-job job execute timeout");\n                XxlJobHelper.log(e);\n                XxlJobHelper.handleFail("job execute fail, exception message: " + e.getMessage());\n            }\n        } else {\n            Thread futureThread = null;\n            try {\n                FutureTask<Boolean> futureTask = new FutureTask<>(new Callable<Boolean>() {\n                    @Override\n                    public Boolean call() throws Exception {\n                        XxlJobContext.setXxlJobContext(xxlJobContext);\n                        handler.execute();\n                        return true;\n                    }\n                });\n                // åå»ºå¹¶å¯å¨çº¿ç¨ï¼getç»æï¼å¦ææå®æ¶é´getä¸å°ï¼è¯´æè¶æ¶\n                futureThread = new Thread(futureTask);\n                futureThread.start();\n                Boolean tempResult = futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);\n            } catch (TimeoutException e) {\n                XxlJobHelper.log("<br>-------------- xxl-job job execute timeout");\n                XxlJobHelper.log(e);\n                // å°è¶æ¶è®¾ç½®å° XxlJobContext ä¸­\n                XxlJobHelper.handleTimeout("job execute timeout");\n            } finally {\n                futureThread.interrupt();\n            }\n        }\n    }\n\n    public void toStop(String stopReason) {\n        toStop = true;\n        this.stopReason = stopReason;\n    }\n\n\n    public IJobHandler getHandler() {\n        return handler;\n    }\n\n}\n\n\n\n# 7. æ§è¡å¨å¯¹ JobThread çç®¡ç\n\nJobThread å®æle ï¼ç°å¨æ¥æ³æ³æä¹å° TriggerParam æ¾å¥é»å¡éåå§ï¼JobThread æä¾äº API ï¼pushTriggerQueue.\n\næä¹è°åº¦å®å¢ï¼å¦ä½ç¥éè´è´£æä¸ªä»»å¡ççº¿ç¨æ¯å¦å­å¨å¢ï¼å¦ä½å°çº¿ç¨éæ¯å¢ï¼è°æ¥è°ç¨ toStop() æ¹æ³å¢ï¼ï¼\n\nè¿äºé½æ¯é®é¢å¾è§£å³çé®é¢ãä¸é¢ä»ç» MethodJobHandler æ¶å° MethodJobHandler æ¶éèµ·æ¥æ¾å¥ Map ä¸­ï¼é£ä¹ JobThread ä¹å¯ä»¥æ¶éèµ·æ¥è¿è¡ç»ä¸çç®¡çåï¼ç¨ jobId-JobThread è¿ç§ key-value å½¢å¼å°çº¿ç¨å°è£è¿ Map ä¸­ï¼è°åº¦ä¸­å¿ä¼ å¥ TriggerParam åï¼éè¿ jobId æ¾å°è´è´£è¯¥ä»»å¡ççº¿ç¨ï¼è°ç¨ pushTriggerQueue å° TriggerParam æ¾å¥éåç­å¾æ§è¡ãé£ä¹ç±è°æ¥ç®¡çè¿ä¸ªè£ JobThread ç Map å¢ï¼è¯å®æ¯æ§è¡å¨ï¼æä»¥å°è¿ä¸ª Map æ¾å¥ XxlJobExecutor ä¸­ã\n\n// å­æ¾ JobThreadçº¿ç¨ çMap\nprivate static ConcurrentHashMap<Integer, JobThread> jobThreadRepository = new ConcurrentHashMap<>();\n\n// æ ¹æ®ä»»å¡idè·åå¯¹åºçº¿ç¨\npublic static JobThread loadJobThread(int jobId) {\n    return jobThreadRepository.get(jobId);\n}\n\n// æ³¨åæ°ä»»å¡\npublic static JobThread registJobThread(int jobId, IJobHandler handler, String removeOldReason) {\n    JobThread newJobThread = new JobThread(jobId, handler);\n    newJobThread.start();\n    JobThread oldJobThread = jobThreadRepository.put(jobId, newJobThread);\n    // å¦æä»»å¡ä¹åæ³¨åè¿ï¼å¯è½æ¯webç«¯æ´æ¹äºä»»å¡ãå°æ§çº¿ç¨åæ­¢ã\n    if (oldJobThread != null) {\n        oldJobThread.toStop(removeOldReason);\n        oldJobThread.interrupt();\n    }\n    return newJobThread;\n}\n\n// éæ¯çº¿ç¨\npublic static JobThread removeJobThread(int jobId, String removeReason) {\n    JobThread oldJobThread = jobThreadRepository.remove(jobId);\n    if (oldJobThread != null) {\n        oldJobThread.toStop(removeReason);\n        oldJobThread.interrupt();\n    }\n    return oldJobThread;\n}\n\n\nè¯´ä¸ä¸ä¸ºå¥åæ­¢çº¿ç¨çæ¶åä¸ä»è¦è°ç¨ toStop æ¹æ³ï¼è¿è¦è°ç¨ interrupt æ¹æ³å¢ï¼\n\n 1. çº¿ç¨ä¸­ä½¿ç¨ while(!toStop){} çå½¢å¼è¿è¡æ éå¾ªç¯ï¼æä»¥æ³è¦åæ­¢è¿ä¸ªçº¿ç¨è¯å®è¦è®©çº¿ç¨éåºå¾ªç¯ï¼è°ç¨ toStop æ¹æ³ä¼å° toStop = true\n 2. å¨ JobThread.run() æ¹æ³ä¸­ï¼æ é»å¡çä»éåä¸­åå¼ çæ­¥éª¤å­å¨ï¼å¦ææ³è¦è®©çº¿ç¨åæ­¢å·¥ä½ï¼è¯å®è¦è®©çº¿ç¨åéåºé»å¡ç¶æåéåºå¾ªç¯ï¼æä»¥è°ç¨ interrupt çº¯ç²¹æ¯ä¸è®©çº¿ç¨é»å¡è¿ä¹é¿æ¶é´ã\n\nè¡¥å¨äºå¯¹äº JobThread çç®¡çï¼ç°å¨çæ§è¡å¨æ§è¡ä»»å¡çæµç¨å°±å¾æ¸æ°äºï¼\n\n 1. æ§è¡å¨æ¥æ¶å°æ¥èªè°åº¦ä¸­å¿ç TriggerParam\n\n 2. show me codeï¼\n    \n    JobThread thread = XxlJobExecutor.loadJobThread(triggerPara.getJobId());\n    if (thread == null) {\n        thread = XxlJobExecutor.registJobThread(è¿éåä¸è¯´);\n    }\n    thread.pushTriggerQueue(triggerParam);\n    \n\n 3. è°åº¦åæ°æ¾å¥éååå°±ä¼ç­å¾ååºæ§è¡ãè¿ä¸ªæ­¥éª¤å¯ä»¥åè JobThread çä»£ç \n\næåï¼æ¥çç thread = XxlJobExecutor.registJobThread(è¿éåä¸è¯´) è¿ä¸æ­¥ï¼æ³è¦æ³¨åçº¿ç¨ï¼å°±å¿é¡»æ¿å° MethodJobHandlerï¼æä¹æ¿å°ï¼TriggerParam ä¸­æ ä»»å¡åï¼æä»¬ä¹åå°ææ ä»»å¡å-JobHandler çé®å¼å¯¹å°è£å° XxlJobExecutor çä¸ä¸ª Map ä¸­äºï¼æä»¥å¯ä»¥åéè¿é£ä¸ª Map è·å MethodJobHandler åè¿è¡æ°å»ºçº¿ç¨ã\n\n\n# 7. æ»ç»\n\næ¾ä¸é¢æ¶åå°çå¨é¨ä»£ç ï¼\n\n@Configuration\npublic class XxlJobSpringExecutor extends XxlJobExecutor implements ApplicationContextAware, SmartInitializingSingleton, DisposableBean {\n    private static Logger logger = LoggerFactory.getLogger(XxlJobSpringExecutor.class);\n\n    private static ApplicationContext applicationContext;\n\n    @Override\n    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {\n        XxlJobSpringExecutor.applicationContext = applicationContext;\n    }\n\n    @Override\n    public void afterSingletonsInstantiated() {\n        try {\n            initJobHandlerMethodRepository(applicationContext);\n            super.start();\n        } catch (Exception e) {\n            logger.error(e.getMessage());\n        }\n    }\n\n    @Override\n    public void destroy() throws Exception {\n        super.stop();\n    }\n\n    private void initJobHandlerMethodRepository(ApplicationContext applicationContext) throws NoSuchMethodException {\n        if (applicationContext == null) return;\n        String[] beanDefinitionNames = applicationContext.getBeanNamesForType(Object.class, false, true);\n        for (String beanDefinitionName : beanDefinitionNames) {\n            Object bean = applicationContext.getBean(beanDefinitionName);\n            Map<Method, XxlJob> annotatedMethods = null;\n            try {\n                annotatedMethods = MethodIntrospector.selectMethods(bean.getClass(),\n                        new MethodIntrospector.MetadataLookup<XxlJob>() {\n                            @Override\n                            public XxlJob inspect(Method method) {\n                                return AnnotatedElementUtils.findMergedAnnotation(method, XxlJob.class);\n                            }\n                        }\n                );\n\n            } catch (Exception e) {\n                // è®°å½æ¥å¿ï¼ä»£ç å¤ªé¿å°±ä¸æ¾äº\n            }\n            if (CollectionUtil.isEmpty(annotatedMethods)) {\n                continue;\n            }\n            // å°å®æ¶ä»»å¡æ³¨åä¸ºJobHandler\n            for (Map.Entry<Method, XxlJob> methodXxlJobEntry : annotatedMethods.entrySet()) {\n                Method method = methodXxlJobEntry.getKey();\n                XxlJob value = methodXxlJobEntry.getValue();\n                registJobHandler(value, bean, method);\n            }\n\n        }\n\n    }\n\n    public static ApplicationContext getApplicationContext() {\n        return applicationContext;\n    }\n}\n\n\npublic class XxlJobExecutor {\n    private static final Logger logger = LoggerFactory.getLogger(XxlJobExecutor.class);\n        // ---------------------- job handler repository ----------------------\n    private static ConcurrentMap<String, IJobHandler> jobHandlerRepository = new ConcurrentHashMap<String, IJobHandler>();\n    public static IJobHandler loadJobHandler(String name){\n        return jobHandlerRepository.get(name);\n    }\n    public static IJobHandler registJobHandler(String name, IJobHandler jobHandler){\n        return jobHandlerRepository.put(name, jobHandler);\n    }\n    protected void registJobHandler(XxlJob xxlJob, Object bean, Method executeMethod){\n        if (xxlJob == null) {\n            return;\n        }\n\n        String name = xxlJob.value();\n        \n        Class<?> clazz = bean.getClass();\n        String methodName = executeMethod.getName();\n        if (name.trim().length() == 0) {\n            throw new RuntimeException("xxl-job method-jobhandler name invalid, for[" + clazz + "#" + methodName + "] .");\n        }\n        if (loadJobHandler(name) != null) {\n            throw new RuntimeException("xxl-job jobhandler[" + name + "] naming conflicts.");\n        }\n\n        executeMethod.setAccessible(true);\n\n        // init and destroy\n        Method initMethod = null;\n        Method destroyMethod = null;\n\n        if (xxlJob.init().trim().length() > 0) {\n            try {\n                initMethod = clazz.getDeclaredMethod(xxlJob.init());\n                initMethod.setAccessible(true);\n            } catch (NoSuchMethodException e) {\n                throw new RuntimeException("xxl-job method-jobhandler initMethod invalid, for[" + clazz + "#" + methodName + "] .");\n            }\n        }\n        if (xxlJob.destroy().trim().length() > 0) {\n            try {\n                destroyMethod = clazz.getDeclaredMethod(xxlJob.destroy());\n                destroyMethod.setAccessible(true);\n            } catch (NoSuchMethodException e) {\n                throw new RuntimeException("xxl-job method-jobhandler destroyMethod invalid, for[" + clazz + "#" + methodName + "] .");\n            }\n        }\n\n        // registry jobhandler\n        registJobHandler(name, new MethodJobHandler(bean, executeMethod, initMethod, destroyMethod));\n\n    }\n\n\n    // ---------------------- job thread repository ----------------------\n    private static ConcurrentMap<Integer, JobThread> jobThreadRepository = new ConcurrentHashMap<Integer, JobThread>();\n    public static JobThread registJobThread(int jobId, IJobHandler handler, String removeOldReason){\n        JobThread newJobThread = new JobThread(jobId, handler);\n        newJobThread.start();\n        \n\n        JobThread oldJobThread = jobThreadRepository.put(jobId, newJobThread);\t\n        if (oldJobThread != null) {\n            oldJobThread.toStop(removeOldReason);\n            oldJobThread.interrupt();\n        }\n\n        return newJobThread;\n    }\n\n    public static JobThread removeJobThread(int jobId, String removeOldReason){\n        JobThread oldJobThread = jobThreadRepository.remove(jobId);\n        if (oldJobThread != null) {\n            oldJobThread.toStop(removeOldReason);\n            oldJobThread.interrupt();\n\n            return oldJobThread;\n        }\n        return null;\n    }\n\n    public static JobThread loadJobThread(int jobId){\n        return jobThreadRepository.get(jobId);\n    }\n}\n\n\npublic class TriggerParam implements Serializable {\n    private static final long serialVersionUID = 42L;\n\n    /**\n     * ä»»å¡id\n     */\n    private int jobId;\n\n    /**\n     * å®æ¶ä»»å¡åå­\n     */\n    private String executorHandler;\n\n    /**\n     * å®æ¶ä»»å¡çåæ°\n     */\n    private String executorParams;\n\n    /**\n     * å®æ¶ä»»å¡çé»å¡ç­ç¥                <br></br>\n     * å½ä¸ä¸ªå®æ¶ä»»å¡æ³è¦æ§è¡ï¼ä½æ¯è´è´£è¯¥ä»»å¡ççº¿ç¨æ­£å¨å·¥ä½æ¶ä¼ä½¿ç¨è¿ä¸ªé»å¡ç­ç¥å¤æ­\n     */\n    private String executorBlockStrategy;\n\n    /**\n     * ä»»å¡çè¿ææ¶é´          <br></br>\n     * å¦æå¼å¯äºè¿ææ¶é´ï¼æ§è¡ä»»å¡æ¶ä¼é¢å¤åå»ºä¸ä¸ªæ°çº¿ç¨æ§è¡ä»»å¡ï¼\n     * ä¹åççº¿ç¨è´è´£çç£æ°çº¿ç¨æ§è¡ä»»å¡æ¶é´æ¯å¦è¶æ¶\n     */\n    private int executorTimeout;\n\n    /**\n     * è¯¥ä»»å¡å¯¹åºçæ¥å¿çid\n     */\n    private long logId;\n\n    /**\n     * ææ¥å¿çæ¶é´\n     */\n    private long logDateTime;\n\n    /**\n     * è¿è¡æ¨¡å¼\n     */\n    private String glueType;\n\n    /**\n     * ä»£ç ææ¬\n     */\n    private String glueSource;\n\n    /**\n     * ä»£ç ææ¬æ´æ°æ¶é´\n     */\n    private long glueUpdatetime;\n\n    /**\n     * åçç´¢å¼\n     */\n    private int broadcastIndex;\n\n    /**\n     * åçæ»æ°\n     */\n    private int broadcastTotal;\n}\n\n\npackage com.xxl.job.core.thread;\n\nimport com.xxl.job.core.biz.model.HandleCallbackParam;\nimport com.xxl.job.core.biz.model.ReturnT;\nimport com.xxl.job.core.biz.model.TriggerParam;\nimport com.xxl.job.core.context.XxlJobContext;\nimport com.xxl.job.core.context.XxlJobHelper;\nimport com.xxl.job.core.executor.XxlJobExecutor;\nimport com.xxl.job.core.handler.IJobHandler;\nimport com.xxl.job.core.log.XxlJobFileAppender;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.io.PrintWriter;\nimport java.io.StringWriter;\nimport java.util.Collections;\nimport java.util.Date;\nimport java.util.HashSet;\nimport java.util.Set;\nimport java.util.concurrent.*;\n\n\n/**\n * handler thread\n * @author xuxueli 2016-1-16 19:52:47\n */\npublic class JobThread extends Thread{\n\tprivate static Logger logger = LoggerFactory.getLogger(JobThread.class);\n\n\tprivate int jobId;\n\tprivate IJobHandler handler;\n\tprivate LinkedBlockingQueue<TriggerParam> triggerQueue;\n\tprivate Set<Long> triggerLogIdSet;\t\t\n\n\tprivate volatile boolean toStop = false;\n\tprivate String stopReason;\n\n    private boolean running = false;    \n\tprivate int idleTimes = 0;\t\t\t\n\n\n\tpublic JobThread(int jobId, IJobHandler handler) {\n\t\tthis.jobId = jobId;\n\t\tthis.handler = handler;\n\t\tthis.triggerQueue = new LinkedBlockingQueue<TriggerParam>();\n\t\tthis.triggerLogIdSet = Collections.synchronizedSet(new HashSet<Long>());\n\n\t\t// assign job thread name\n\t\tthis.setName("xxl-job, JobThread-"+jobId+"-"+System.currentTimeMillis());\n\t}\n\tpublic IJobHandler getHandler() {\n\t\treturn handler;\n\t}\n\n    /**\n     * new trigger to queue\n     *\n     * @param triggerParam\n     * @return\n     */\n\tpublic ReturnT<String> pushTriggerQueue(TriggerParam triggerParam) {\n\t\t// avoid repeat\n\t\tif (triggerLogIdSet.contains(triggerParam.getLogId())) {\n\t\t\tlogger.info(">>>>>>>>>>> repeate trigger job, logId:{}", triggerParam.getLogId());\n\t\t\treturn new ReturnT<String>(ReturnT.FAIL_CODE, "repeate trigger job, logId:" + triggerParam.getLogId());\n\t\t}\n\n\t\ttriggerLogIdSet.add(triggerParam.getLogId());\n\t\ttriggerQueue.add(triggerParam);\n        return ReturnT.SUCCESS;\n\t}\n\n    /**\n     * kill job thread\n     *\n     * @param stopReason\n     */\n\tpublic void toStop(String stopReason) {\n\t\t/**\n\t\t * Thread.interruptåªæ¯æç»æ­¢çº¿ç¨çé»å¡ç¶æ(waitãjoinãsleep)ï¼\n\t\t * å¨é»å¡åºæåºInterruptedExceptionå¼å¸¸,ä½æ¯å¹¶ä¸ä¼ç»æ­¢è¿è¡ççº¿ç¨æ¬èº«ï¼\n\t\t * æä»¥éè¦æ³¨æï¼æ­¤å¤å½»åºéæ¯æ¬çº¿ç¨ï¼éè¦éè¿å±äº«åéæ¹å¼ï¼\n\t\t */\n\t\tthis.toStop = true;\n\t\tthis.stopReason = stopReason;\n\t}\n\n    /**\n     * is running job\n     * @return\n     */\n    public boolean isRunningOrHasQueue() {\n        return running || triggerQueue.size()>0;\n    }\n\n    @Override\n\tpublic void run() {\n\n    \t// init\n    \ttry {\n\t\t\thandler.init();\n\t\t} catch (Throwable e) {\n    \t\tlogger.error(e.getMessage(), e);\n\t\t}\n\n\t\t// execute\n\t\twhile(!toStop){\n\t\t\trunning = false;\n\t\t\tidleTimes++;\n\n            TriggerParam triggerParam = null;\n            try {\n\t\t\t\t// to check toStop signal, we need cycle, so wo cannot use queue.take(), instand of poll(timeout)\n\t\t\t\ttriggerParam = triggerQueue.poll(3L, TimeUnit.SECONDS);\n\t\t\t\tif (triggerParam!=null) {\n\t\t\t\t\trunning = true;\n\t\t\t\t\tidleTimes = 0;\n\t\t\t\t\ttriggerLogIdSet.remove(triggerParam.getLogId());\n\n\t\t\t\t\t// log filename, like "logPath/yyyy-MM-dd/9999.log"\n\t\t\t\t\tString logFileName = XxlJobFileAppender.makeLogFileName(new Date(triggerParam.getLogDateTime()), triggerParam.getLogId());\n\t\t\t\t\tXxlJobContext xxlJobContext = new XxlJobContext(\n\t\t\t\t\t\t\ttriggerParam.getJobId(),\n\t\t\t\t\t\t\ttriggerParam.getExecutorParams(),\n\t\t\t\t\t\t\tlogFileName,\n\t\t\t\t\t\t\ttriggerParam.getBroadcastIndex(),\n\t\t\t\t\t\t\ttriggerParam.getBroadcastTotal());\n\n\t\t\t\t\t// init job context\n\t\t\t\t\tXxlJobContext.setXxlJobContext(xxlJobContext);\n\n\t\t\t\t\t// execute\n\t\t\t\t\tXxlJobHelper.log("<br>----------- xxl-job job execute start -----------<br>----------- Param:" + xxlJobContext.getJobParam());\n\n\t\t\t\t\tif (triggerParam.getExecutorTimeout() > 0) {\n\t\t\t\t\t\t// limit timeout\n\t\t\t\t\t\tThread futureThread = null;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tFutureTask<Boolean> futureTask = new FutureTask<Boolean>(new Callable<Boolean>() {\n\t\t\t\t\t\t\t\t@Override\n\t\t\t\t\t\t\t\tpublic Boolean call() throws Exception {\n\n\t\t\t\t\t\t\t\t\t// init job context\n\t\t\t\t\t\t\t\t\tXxlJobContext.setXxlJobContext(xxlJobContext);\n\n\t\t\t\t\t\t\t\t\thandler.execute();\n\t\t\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfutureThread = new Thread(futureTask);\n\t\t\t\t\t\t\tfutureThread.start();\n\n\t\t\t\t\t\t\tBoolean tempResult = futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);\n\t\t\t\t\t\t} catch (TimeoutException e) {\n\n\t\t\t\t\t\t\tXxlJobHelper.log("<br>----------- xxl-job job execute timeout");\n\t\t\t\t\t\t\tXxlJobHelper.log(e);\n\n\t\t\t\t\t\t\t// handle result\n\t\t\t\t\t\t\tXxlJobHelper.handleTimeout("job execute timeout ");\n\t\t\t\t\t\t} finally {\n\t\t\t\t\t\t\tfutureThread.interrupt();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// just execute\n\t\t\t\t\t\thandler.execute();\n\t\t\t\t\t}\n\n\t\t\t\t\t// valid execute handle data\n\t\t\t\t\tif (XxlJobContext.getXxlJobContext().getHandleCode() <= 0) {\n\t\t\t\t\t\tXxlJobHelper.handleFail("job handle result lost.");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tString tempHandleMsg = XxlJobContext.getXxlJobContext().getHandleMsg();\n\t\t\t\t\t\ttempHandleMsg = (tempHandleMsg!=null&&tempHandleMsg.length()>50000)\n\t\t\t\t\t\t\t\t?tempHandleMsg.substring(0, 50000).concat("...")\n\t\t\t\t\t\t\t\t:tempHandleMsg;\n\t\t\t\t\t\tXxlJobContext.getXxlJobContext().setHandleMsg(tempHandleMsg);\n\t\t\t\t\t}\n\t\t\t\t\tXxlJobHelper.log("<br>----------- xxl-job job execute end(finish) -----------<br>----------- Result: handleCode="\n\t\t\t\t\t\t\t+ XxlJobContext.getXxlJobContext().getHandleCode()\n\t\t\t\t\t\t\t+ ", handleMsg = "\n\t\t\t\t\t\t\t+ XxlJobContext.getXxlJobContext().getHandleMsg()\n\t\t\t\t\t);\n\n\t\t\t\t} else {\n\t\t\t\t\tif (idleTimes > 30) {\n\t\t\t\t\t\tif(triggerQueue.size() == 0) {\t\n\t\t\t\t\t\t\tXxlJobExecutor.removeJobThread(jobId, "excutor idel times over limit.");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (Throwable e) {\n\t\t\t\tif (toStop) {\n\t\t\t\t\tXxlJobHelper.log("<br>----------- JobThread toStop, stopReason:" + stopReason);\n\t\t\t\t}\n\n\t\t\t\t// handle result\n\t\t\t\tStringWriter stringWriter = new StringWriter();\n\t\t\t\te.printStackTrace(new PrintWriter(stringWriter));\n\t\t\t\tString errorMsg = stringWriter.toString();\n\n\t\t\t\tXxlJobHelper.handleFail(errorMsg);\n\n\t\t\t\tXxlJobHelper.log("<br>----------- JobThread Exception:" + errorMsg + "<br>----------- xxl-job job execute end(error) -----------");\n\t\t\t} finally {\n                if(triggerParam != null) {\n                    // callback handler info\n                    if (!toStop) {\n                        // commonm\n                        TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        \t\ttriggerParam.getLogId(),\n\t\t\t\t\t\t\t\ttriggerParam.getLogDateTime(),\n\t\t\t\t\t\t\t\tXxlJobContext.getXxlJobContext().getHandleCode(),\n\t\t\t\t\t\t\t\tXxlJobContext.getXxlJobContext().getHandleMsg() )\n\t\t\t\t\t\t);\n                    } else {\n                        // is killed\n                        TriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n                        \t\ttriggerParam.getLogId(),\n\t\t\t\t\t\t\t\ttriggerParam.getLogDateTime(),\n\t\t\t\t\t\t\t\tXxlJobContext.HANDLE_CODE_FAIL,\n\t\t\t\t\t\t\t\tstopReason + " [job running, killed]" )\n\t\t\t\t\t\t);\n                    }\n                }\n            }\n        }\n\n\t\t// callback trigger request in queue\n\t\twhile(triggerQueue !=null && triggerQueue.size()>0){\n\t\t\tTriggerParam triggerParam = triggerQueue.poll();\n\t\t\tif (triggerParam!=null) {\n\t\t\t\t// is killed\n\t\t\t\tTriggerCallbackThread.pushCallBack(new HandleCallbackParam(\n\t\t\t\t\t\ttriggerParam.getLogId(),\n\t\t\t\t\t\ttriggerParam.getLogDateTime(),\n\t\t\t\t\t\tXxlJobContext.HANDLE_CODE_FAIL,\n\t\t\t\t\t\tstopReason + " [job not executed, in the job queue, killed.]")\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// destroy\n\t\ttry {\n\t\t\thandler.destroy();\n\t\t} catch (Throwable e) {\n\t\t\tlogger.error(e.getMessage(), e);\n\t\t}\n\n\t\t\n\t}\n}\n',normalizedContent:'# 0. åè¨\n\nä¸ºä»ä¹ä»æ§è¡å¨å¼å§è®²ï¼å ä¸ºä»ä¸åä¸åä»ä¸åä¸è®²é½æå©æå¼ï¼æéæ©éèä¸å±å®ç°çç»èï¼ç­æ§è¡å¨è®²å®äºåè®²è°åº¦ä¸­å¿ã\n\nç±äºæ²¡æè®²è°åº¦ä¸­å¿ï¼ä½ åªè¦æè°åº¦ä¸­å¿æ³è±¡ä¸ºä¸ä¸ªé»çï¼å®ä¼å°é©¬ä¸å°±æ§è¡çä»»å¡ä»æ°æ®åºä¸­æ¥åºæ¥ï¼ç¶ååé http æ¶æ¯ç»æ§è¡å¨ï¼æ§è¡å¨æ¿å°ä¿¡æ¯åå»æ§è¡ã\n\n\n\n\n# 1. triggerparam\n\nè°åº¦åæ°ï¼ä»ä¹å«è°åº¦åæ°ï¼å°±æ¯è°åº¦ä¸­å¿ä»æ°æ®åºä¸­æ¥æ¾å°è¦æ§è¡çä»»å¡åï¼å°è¿ä¸ªåæ°åéç»æ§è¡å¨ï¼æ§è¡å¨æ ¹æ®è°åº¦åæ°åçå¼è¿è¡æ§è¡ã\n\nè¿ä¸ªæ¶æ¯åå«ä»ä¹ä¿¡æ¯å¢ï¼\n\npublic class triggerparam implements serializable {\n    // ä½¿ç¨äº jdk åºåå\n    private static final long serialversionuid = 42l;\n\n    /**\n     * ä»»å¡id\n     */\n    private int jobid;\n\n    /**\n     * å®æ¶ä»»å¡å\n     */\n    private string executorhandler;\n\n    /**\n     * å®æ¶ä»»å¡çåæ°\n     */\n    private string executorparams;\n\n    /**\n     * å®æ¶ä»»å¡çé»å¡ç­ç¥                <br></br>\n     * å½ä¸ä¸ªå®æ¶ä»»å¡æ³è¦æ§è¡ï¼ä½æ¯è´è´£è¯¥ä»»å¡ççº¿ç¨æ­£å¨å·¥ä½æ¶ä¼ä½¿ç¨è¿ä¸ªé»å¡ç­ç¥å¤æ­\n     */\n    private string executorblockstrategy;\n\n    /**\n     * ä»»å¡çè¿ææ¶é´          <br></br>\n     * å¦æå¼å¯äºè¿ææ¶é´ï¼æ§è¡ä»»å¡æ¶ä¼é¢å¤åå»ºä¸ä¸ªæ°çº¿ç¨æ§è¡ä»»å¡ï¼\n     * ä¹åççº¿ç¨è´è´£çç£æ°çº¿ç¨æ§è¡ä»»å¡æ¶é´æ¯å¦è¶æ¶\n     */\n    private int executortimeout;\n\n    /**\n     * è¯¥ä»»å¡å¯¹åºçæ¥å¿çid\n     */\n    private long logid;\n\n    /**\n     * ææ¥å¿çæ¶é´\n     */\n    private long logdatetime;\n\n    /**\n     * è¿è¡æ¨¡å¼\n     */\n    private string gluetype;\n\n    /**\n     * ä»£ç ææ¬\n     */\n    private string gluesource;\n\n    /**\n     * ä»£ç ææ¬æ´æ°æ¶é´\n     */\n    private long glueupdatetime;\n\n    /**\n     * åçç´¢å¼\n     */\n    private int broadcastindex;\n\n    /**\n     * åçæ»æ°\n     */\n    private int broadcasttotal;\n\n    public int getjobid() {\n        return jobid;\n    }\n}\n\n\nå¶å®å¾å¤åéå¨ææä¹ä¸­ï¼idãexecutorhandlerå¥çå¿é¡»æï¼ä½æ¯ä¸ºä»ä¹æ logid å¢ï¼æ§è¡çæ¶åè· logid æä»ä¹å³ç³»å¢ï¼\n\nå¨ä¸æä¸­æä»¬åæäº xxl-job çæ°æ®åºè¡¨ï¼çéå¼ºè°äº xxl_job_log çä¸¤ä¸ªå­æ®µ ï¼trigger_codeãhandle_code\n\n * trigger_code ï¼æ¯å¦è°åº¦æåï¼ä¹å°±æ¯ httpæ¶æ¯åéæåæ²¡æ\n * handle_code ï¼æ¯å¦æ§è¡æåï¼ä¹å°±æ¯å®æ¶ä»»å¡ä»£ç æ§è¡è¿ç¨ä¸­æ¯å¦åºç°äºbug\n\nxxl-job å¨æ¶æ¯åéä¹åï¼ä¼ä¸ºæ¯ä¸æ¬¡æ§è¡çæä¸æ¡æ¥å¿ï¼è¿æ¡æ°æ®å¨æ°æ®åºç xxl_job_log ä¸­ï¼httpæ¶æ¯ï¼ä¹å°±æ¯triggerparam ï¼å°è¾¾æ§è¡å¨æ¶ï¼è¿æ¡logå°±å·²ç»æ trigger_code äºãæä»¥æä»¬è¦å¨æ§è¡çæ¶åè®°å½ä¸äº handle_codeãhandle_messageï¼ç­ä»»å¡æ§è¡å®ååéåè°åº¦ä¸­å¿ï¼è°åº¦ä¸­å¿æ¥æ¶å°è¿æ¡æ¶æ¯åå°±å¯ä»¥è¡¥å¨æ¬æ¬¡æ§è¡çæ¥å¿ã\n\næäº triggerparam ï¼xxl-job çå·¥ä½æµç¨åä¸º ï¼\n\n * è°åº¦ä¸­å¿ä»æ°æ®åºä¸­æ¥è¯¢å®æ¶ä»»å¡\n * å°ä»»å¡å°è£ä¸º triggerparam åéç»æ§è¡å¨\n * æ§è¡å¨æ¿å° triggerparam åæ§è¡å¯¹åºçä»»å¡\n\nç°å¨æä»¬ä¸ç¥éçæ¯ ï¼å®æ¶ä»»å¡ä»¥ä»ä¹å½¢å¼å­å¨äºæ§è¡å¨ãå®æ¶ä»»å¡å¦ä½æ§è¡çãæ¥ä¸æ¥ä¼å·ä½åæè¿ä¸¤ç¹ã\n\n\n# 2. å®ä¹å®æ¶ä»»å¡\n\nå®æ¶ä»»å¡å¨ xxl-job ä¸­ä»¥ä»ä¹å½¢å¼å­å¨å¢ï¼è¯å®è¦æä¸ä¸ªç±»å°è£å®ã\n\né¦åï¼æä»¬åå®ä¹æ¥å£ï¼æ¥å£è§å®çæ¯è¡ä¸ºï¼ä¸ä¸ªä»»å¡éè¦æåªäºè¡ä¸ºï¼æ§è¡ãåå§åãéæ¯ã\n\nä½æ¯å¹¶éææä»»å¡é½éè¦åå§åãéæ¯ï¼æä»¥æä»¬å° ijobhandler å®ä¹ä¸ºæ½è±¡ç±»ï¼ç»åå§ååéæ¯æ¹æ³é»è®¤å®ç°ã\n\npublic abstract class ijobhandler {\n\n\tpublic abstract void execute() throws exception;\n\n\tpublic void init() throws exception {\n\n\t}\n\n\tpublic void destroy() throws exception {\n\n\t}\n}\n\n\nä¸ä¸ªæ¹æ³æ³è¦æ§è¡ï¼è¯å®è¦æclasså¯¹è±¡ãmethodæ¹æ³ï¼åæ¶ææ³è®©åè½æ´å ä¸°å¯ï¼äºæ¯ç»æ¯ä¸ä¸ªå®æ¶ä»»å¡å ä¸åå§åæ¹æ³ãéæ¯æ¹æ³ã\n\npublic class methodjobhandler extends ijobhandler {\n    // beanå¯¹è±¡çclass\n    private final object target;\n    // éè¦æ§è¡çmethod\n    private final method method;\n    // åå§ååéæ¯æ¹æ³\n    private method initmethod;\n    private method destroymethod;\n\n    public methodjobhandler(object target, method method, method initmethod, method destroymethod) {\n        this.target = target;\n        this.method = method;\n\n        this.initmethod = initmethod;\n        this.destroymethod = destroymethod;\n    }\n\n    @override\n    public void execute() throws exception {\n        class<?>[] paramtypes = method.getparametertypes();\n        if (paramtypes.length > 0) {\n            method.invoke(target, new object[paramtypes.length]);       // method-param can not be primitive-types\n        } else {\n            method.invoke(target);\n        }\n    }\n\n    @override\n    public void init() throws exception {\n        if(initmethod != null) {\n            initmethod.invoke(target);\n        }\n    }\n\n    @override\n    public void destroy() throws exception {\n        if(destroymethod != null) {\n            destroymethod.invoke(target);\n        }\n    }\n\n    @override\n    public string tostring() {\n        return super.tostring()+"["+ target.getclass() + "#" + method.getname() +"]";\n    }\n}\n\n\nå¶å®ä¸é¢çé»è¾ä¸é¾å¯¹å§ï¼ä¸å±å°±ä¸ä¸ªæ¹æ³ï¼æ§è¡ãåå§åãéæ¯ã\n\n * æ§è¡ ï¼å¦ææ²¡æåæ°ç´æ¥å°± method.invoke(target)\n * åå§å ï¼å¦æåå§åmethodä¸ä¸ºç©ºå°±æ§è¡\n * éæ¯ ï¼å¦æéæ¯methodä¸ä¸ºç©ºå°±æ§è¡\n\nå½æ³è¦æ§è¡ä¸ä¸ªå®æ¶ä»»å¡çæ¶åï¼åªéè¦å new methodjobhandlerï¼ç¶åè°ç¨ jobhandler.executor() å°±å¯æ§è¡ã\n\n\n# 3. æ¶éå®æ¶ä»»å¡\n\nåå°è£å®æ¶ä»»å¡å¯ä¸å¤ï¼æä»¬è¿è¦æ¿å°å®æ¶ä»»å¡ï¼ä¹å°±æ¯å­åè°åº¦ä¸­å¿åéæ¥ç triggerparam æ¾å° methodjobhandlerï¼æä¹æ¾å¢ï¼é¾éæ¯ä¸æ¬¡æ§è¡ä»»å¡é½éè¦éæ°æ¾åï¼\n\nå«å¿äºï¼ä»£ç è¿è¡ä¹åå°±æ²¡æ³æ´æ¹äºï¼æä»¥æä»¬å¯ä»¥è¶ä»£ç è¿è¡åï¼å°ææå®æ¶ä»»å¡æ¶éèµ·æ¥ï¼å¯ä»¥ç¨listãmapè¿ç§å®¹å¨è£èµ·æ¥ï¼ä½ æ³è¦ï¼æ²¡é®é¢ï¼æ¿ä»»å¡çå¯ä¸æ è¯ç»ææ¢~~è¯´å°å¯ä¸æ è¯ï¼èªæçä½ è¯å®æ³å°äºmapï¼å ä¸ºå®æ¯ key-value å½¢å¼çï¼æä»¬å¯ä»¥ä½¿ç¨ id-jobhandler ä¹å¯ä»¥ä½¿ç¨ jobname-jobhandler å­æ¾ä»»å¡ï¼è·æä»¬çä¸å¡å®å¨ç¬¦åï¼\n\nåæ¥ççä¹åæä»¬åçå®æ¶ä»»å¡ä»£ç ï¼\n\n@component\npublic class samplexxljob {\n\n    @xxljob("demojobhandler")\n    public void demojobhandler() throws exception {\n        system.out.println("ç®åä»»å¡å®ä¾æ§è¡äº");\n    }\n}\n\n\nå¦ææ¯ä½ ï¼å¦ä½è·åè¿ä¸ªä»»å¡å¢ï¼ç±äº samplexxljob è¿ä¸ªç±»å·²ç»è¢«æ³¨å¥å° spring å®¹å¨ä¸­äºï¼é£ä¹æä»¬è·å spring å®¹å¨éåå®¹å¨ä¸­çææbeanï¼å¦ææä¸ª bean æ @xxljob è¿ä¸ªæ³¨è§£ï¼é£ä¹è¿ä¸ª bean + methodå°±æ¯æä»¬è¦æ¾çå®æ¶ä»»å¡ã\n\nè¯å®è¦ç±æ§è¡å¨åè¿ç§äºæï¼å ä¸ºæä»¬çé¡¹ç®å¼å¥çæ¯æ§è¡å¨ä¾èµï¼æ¢è¨ä¹ï¼æä»¬çé¡¹ç®ç°å¨å°±æ¯ä¸ä¸ªæ§è¡å¨äºã\n\næä»¥æå°è¿ä¸ªâæ¶éå®æ¶ä»»å¡âçç±»å«å xxljobspringexecutor\n\nå¨ä»£ç ä¸­éè¦æ¿å° spring çä¸ä¸æ contextï¼ç¶åå°±å¯ä»¥éè¿ context è·åææçbeanã\n\npublic class xxljobspringexecutor implements applicationcontextaware {\n\n    private static applicationcontext applicationcontext;\n\n    @override\n    public void setapplicationcontext(applicationcontext applicationcontext) throws beansexception {\n        xxljobspringexecutor.applicationcontext = applicationcontext;\n    }\n\n    public static applicationcontext getapplicationcontext() {\n        return applicationcontext;\n    }\n}\n\n\nç°å¨åæä¸ä¸ªæ°é®é¢ï¼ä»ä¹æ¶åå¼å§æ¶éå®æ¶ä»»å¡å¢ï¼springå®¹å¨åå§ååï¼springå®¹å¨åå§ååï¼\n\nå¨å®æ¶ä»»å¡ä¸­ï¼æå¯è½ä½¿ç¨ mapperãredistemplateãrpc åç§spring beanå»å®æå·¥ä½ï¼é£è¯å®æ¯ spring çå®¹å¨åå§åä¹åæ¶éå®æ¶ä»»å¡äºã\n\næä»¥æä»¬è¦å®ç° smartinitializingsingletonï¼å¨ææåä¾å¯¹è±¡åå¤å¥½ä¹åï¼æä»¬å¼å§æ¶éä»»å¡ã\n\npublic class xxljobspringexecutor implements applicationcontextaware, smartinitializingsingleton {\n    \n    @override\n    public void aftersingletonsinstantiated() {\n        // å¨è¿éæ¶éå®æ¶ä»»å¡\n        initjobhandlermethodrepository(applicationcontext);\n    }\n   \n    private static applicationcontext applicationcontext;\n    \n\n    @override\n    public void setapplicationcontext(applicationcontext applicationcontext) throws beansexception {\n        xxljobspringexecutor.applicationcontext = applicationcontext;\n    }\n\n    public static applicationcontext getapplicationcontext() {\n        return applicationcontext;\n    }\n}\n\n\nåæ¥æèä¸ä¸ªé®é¢ ï¼æ¶éå®æ¶ä»»å¡ï¼æä»¬éè¦æ¶éä»ä¹ä¿¡æ¯ï¼æ§è¡ä¸ä¸ªä»»å¡ï¼æ¢è¨ä¹ï¼æ§è¡ä¸ä¸ªæ¹æ³éè¦ä»ä¹ä¿¡æ¯ï¼\n\n 1. è¢«æ§è¡çæ¹æ³ ï¼method\n 2. åå°æ§è¡ä»»å¡çä»£ç ä¸º ï¼method.invoke(class)ï¼æä»¥è¿éè¦ class å¯¹è±¡ï¼ä¸ä¸ªç±»ä¸­å¯è½æå¤ä¸ªå®æ¶ä»»å¡ï¼ä½æ¯ç®¡å®å¢ï¼æå¤å°æè¦å¤å°ã\n 3. ä¸é¢ä¸¤ä¸ªå±æ§å¯ä»¥å°è£ä¸ºä¸ä¸ª methodhandlerï¼æ³è¦éè¿å®æ¶ä»»å¡åæ¾å°methodhandlerï¼æä»¥éè¦æ¿å°å®æ¶ä»»å¡åå­ã\n\nç»è¿ä¸é¢çåæï¼æä»¬åæ­¥å³å®ï¼éå spring çææbeanï¼å¿é¡»æ¿å°ä»¥ä¸ä¸ä¸ªä¿¡æ¯ï¼\n\n 1. jobname\n 2. class\n 3. method\n\nä¼ªä»£ç åºè¯¥æ¯è¿æ ·ï¼\n\n// è¿ä¸ªmapè´è´£æ¶éææå®æ¶ä»»å¡\nmap<string, methodjobhandler> jobmap = new ....();\n// å¼å§éåæ¯ä¸ä¸ªbean\nfor (object bean : springbeans) {\n    // æ¶éè¿ä¸ªbeanä¸­çå®æ¶ä»»å¡\n    map<xxljob, method> map = new map<>();\n    method[] methods = bean.getmethods();\n    for (method method : methods) {\n        if (methodä¸æ@xxljobæ³¨è§£) {\n            map.put(xxljob, method);\n        }\n    }\n    // å¦æè¿ä¸ªbeanéé¢æ²¡æå®æ¶ä»»å¡å°±ä¸ä¸ä¸ªã\n    if (map.size() <= 0) continue;\n    \n    // éåmapè¿è¡æ³¨åï¼å°å¶æ³¨åå°\n    for (map.entry<xxljob, method> entry : map.entryset()) {\n        methodhandler handler = new methodjobhandler(bean.class, entry.value());\n    \tjobmap.put(xxljob.name(), handler);\n    }\n    \n}\n\n\nä½æ¯ xxl-job å¹¶æ²¡æè¿ä¹åï¼å®æ å®æ¶ä»»å¡çæ¶é åå®æ¶ä»»å¡çæ³¨å åå¼è¿è¡ï¼ä¸ºä»ä¹ï¼\n\nä»å¤©ä½ ä½¿ç¨ spring éæ xxl-job å¯ä»¥ä½¿ç¨ spring å®¹å¨è¿è¡æ¶éï¼ä½æ¯æå¤©ä½ æ²¡æç¨ xxl-job æä¹åï¼æ¶éæä¹åï¼\n\næä»¥å°è¿ä¸¤æ­¥åå¼è¿è¡ï¼å¯ä»¥åå°éæå¶ä»æ¡æ¶æ¶çå·¥ä½éãé£ä¹å¯»æ¾è¿ä¸æ­¥å°±å¯è½æå¾å¤ç§å®ç°æ¹å¼ï¼ä½æ¯æ³¨åä¸ä¸æ ·ï¼ä¸ç®¡ä½ è·å¤å°æ¡æ¶éæï¼æç»ä½ è¦ç»æ beanãmethodãxxljobæ³¨è§£ï¼è¿ä¸æ ·ä¸è¥¿å°±è¡ã\n\nç±äºæ³¨åä¸éè¦ä¾èµäºä»»ä½æ¡æ¶ï¼ æ¶ééè¦ä¾èµäºspringï¼èä¸å¡çé»è¾è¯å®æ¯æ¶éä¹ååæ³¨åï¼æä»¥æä»¬å°è¡ä¸ºå®ä¹æè¿æ ·ï¼\n\npublic abstract class xxljobexecutor {\n    public void æ³¨å(object bean, method method, xxljob xxljob) {\n        // åè½å®ç°\n    }\n}\n\n\npublic abstract class xxljobsringexecutor extends xxljobexecutor {\n\tpublic  void æ¶é() {\n        // ä»å®æ¶ä»»å¡ä¸­æ¾åºææå®æ¶ä»»å¡\n        map<xxljob, method> map = new map<>();\n        method[] methods = bean.getmethods();\n        for (method method : methods) {\n            if (methodä¸æ@xxljobæ³¨è§£) {\n                map.put(xxljob, method);\n            }\n        }\n        // å¦æè¿ä¸ªbeanéé¢æ²¡æå®æ¶ä»»å¡å°±ä¸ä¸ä¸ªã\n        if (map.size() <= 0) continue;\n\n        // è°ç¨ä»ç¶ç±»ç»§æ¿è¿æ¥çæ³¨åæ¹æ³è¿è¡æ³¨åã\n        for (map.entry<xxljob, method> entry : map.entrys()) {\n        \tæ³¨å(bean, entry.key, entry.value);\n    \t}\n    }\n}\n\n\nåæ¥çä¸ä¸ xxljobspringexecutor ä¸­æ¶éå®æ¶ä»»å¡çä»£ç ï¼ä»£ç å¤ä½æ¯ä¸é¾ï¼\n\nprivate void initjobhandlermethodrepository(applicationcontext applicationcontext) {\n        // å®¹å¨å¤ç©º\n        if (applicationcontext == null) {\n            return;\n        }\n        // æ¿å°ææbeanå¯¹è±¡çåå­\n    \t// getbeannamesfortypeæä¸ä¸ªåæ°:\n    \t// type : ç±»å\n    \t// includenonsingletons : æ¯å¦åå«å¤å®ä¾å¯¹è±¡\n    \t// alloweagerinit : æ¯å¦åå«æå è½½å¯¹è±¡\n        string[] beandefinitionnames = applicationcontext.getbeannamesfortype(object.class, false, true);\n        for (string beandefinitionname : beandefinitionnames) {\n\n            // éè¿nameæ¿å°beanå¯¹è±¡\n            object bean = null;\n            lazy onbean = applicationcontext.findannotationonbean(beandefinitionname, lazy.class);\n            if (onbean!=null){\n                logger.debug("xxl-job annotation scan, skip @lazy bean:{}", beandefinitionname);\n                continue;\n            }else {\n                bean = applicationcontext.getbean(beandefinitionname);\n            }\n\n            // è¿ä¸ªmapç¨äºæ¶éå®æ¶ä»»å¡ï¼è¿ä¸ªmapä»£è¡¨å½åéåçbeanä¸­ææçå®æ¶ä»»å¡ã\n            // method : å®æ¶ä»»å¡æ¹æ³\n            // xxljob : è¿ä¸ªå®æ¶ä»»å¡çæ³¨è§£ï¼éè¿ xxljobå¯ä»¥å¾å°å®æ¶ä»»å¡çåå­\n            map<method, xxljob> annotatedmethods = null;   \n            try {\n                annotatedmethods = methodintrospector.selectmethods(bean.getclass(),\n                        new methodintrospector.metadatalookup<xxljob>() {\n                            @override\n                            public xxljob inspect(method method) {\n                                return annotatedelementutils.findmergedannotation(method, xxljob.class);\n                            }\n                        });\n            } catch (throwable ex) {\n                logger.error("xxl-job method-jobhandler resolve error for bean[" + beandefinitionname + "].", ex);\n            }\n            // å¦æè¿ä¸ªbeanä¸­æ²¡æå®æ¶ä»»å¡ï¼è·³è¿\n            if (annotatedmethods==null || annotatedmethods.isempty()) {\n                continue;\n            }\n\n            // å·²ç»æ¶éå°è¯¥beançææå®æ¶ä»»å¡ï¼è¦æå®ç»ä¸æ¾å¨ä¸ä¸ªå°æ¹\n            // registjobhandler\n            for (map.entry<method, xxljob> methodxxljobentry : annotatedmethods.entryset()) {\n                method executemethod = methodxxljobentry.getkey();\n                xxljob xxljob = methodxxljobentry.getvalue();\n                // regist\n                registjobhandler(xxljob, bean, executemethod);\n            }\n\n        }\n    }\n\n\n 1. æ¿å°ææ bean å¯¹è±¡çåå­ï¼éååå­ï¼æ ¹æ®åå­è·åbeanå¯¹è±¡\n 2. ä½¿ç¨ spring æä¾çå·¥å·ç±» methodintrospector.selectmethods æ¥çä¸ä¸ªç±»ä¸­ææ²¡æå äº @xxljob æ³¨è§£çæ¹æ³\n 3. å¦ææï¼å°±å°è¿äºæ¹æ³æç§ method:xxljob çå½¢å¼å°è£è¿ map ä¸­ã\n 4. å°è¿ä¸ª bean ä¸­ææå®æ¶ä»»å¡æ³¨åå°æä¸ªå°æ¹ï¼ä»¥ä¾¿ä½¿ç¨\n 5. å¼å§éåä¸ä¸ä¸ª beanï¼éå¤ä¸è¿°æ­¥éª¤\n\nåçç xxljobexecutor ä¸­ æ³¨åä»»å¡çé»è¾ ï¼\n\npublic class xxljobexecutor {\n    // å­æ¾ methodjobhandler çmapå®¹å¨\n    // key : å®æ¶ä»»å¡çåå­\n    private static concurrentmap<string, ijobhandler> jobhandlerrepository = new concurrenthashmap<string, ijobhandler>();\n    public static ijobhandler registjobhandler(string name, ijobhandler jobhandler){\n        logger.info(">>>>>>>>>>> xxl-job register jobhandler success, name:{}, jobhandler:{}", name, jobhandler);\n        return jobhandlerrepository.put(name, jobhandler);\n    }\n    protected void registjobhandler(xxljob xxljob, object bean, method executemethod){\n        if (xxljob == null) {\n            return;\n        }\n\n        string name = xxljob.value();\n        //make and simplify the variables since they\'ll be called several times later\n        class<?> clazz = bean.getclass();\n        string methodname = executemethod.getname();\n        if (name.trim().length() == 0) {\n            throw new runtimeexception("xxl-job method-jobhandler name invalid, for[" + clazz + "#" + methodname + "] .");\n        }\n        if (loadjobhandler(name) != null) {\n            throw new runtimeexception("xxl-job jobhandler[" + name + "] naming conflicts.");\n        }\n\n        executemethod.setaccessible(true);\n\n        // init and destroy\n        method initmethod = null;\n        method destroymethod = null;\n\n        if (xxljob.init().trim().length() > 0) {\n            try {\n                initmethod = clazz.getdeclaredmethod(xxljob.init());\n                initmethod.setaccessible(true);\n            } catch (nosuchmethodexception e) {\n                throw new runtimeexception("xxl-job method-jobhandler initmethod invalid, for[" + clazz + "#" + methodname + "] .");\n            }\n        }\n        if (xxljob.destroy().trim().length() > 0) {\n            try {\n                destroymethod = clazz.getdeclaredmethod(xxljob.destroy());\n                destroymethod.setaccessible(true);\n            } catch (nosuchmethodexception e) {\n                throw new runtimeexception("xxl-job method-jobhandler destroymethod invalid, for[" + clazz + "#" + methodname + "] .");\n            }\n        }\n\n        // registry jobhandler\n        registjobhandler(name, new methodjobhandler(bean, executemethod, initmethod, destroymethod));\n\n    }\n}\n\n\nregistjobhandler(xxljob xxljob, object bean, method executemethod)\n\n 1. xxljob ï¼å®æ¶ä»»å¡å¤´ä¸çæ³¨è§£ï¼å«æè¯¥ä»»å¡çåå­ãåå§åæ¹æ³ãéæ¯æ¹æ³\n 2. bean ï¼è¯¥ä»»å¡æ¹æ³å±äºåªä¸ªç±»ï¼éè¦éè¿å®æ¿å° class\n 3. executormethod ï¼å®æ¶ä»»å¡çæ¹æ³\n\nè¿ä¸ªæ¹æ³çæ»æµç¨ï¼\n\n 1. æ ¹æ®ä¼ å¥çåæ°è·åå®æ¶ä»»å¡ç åå­ãclasså¯¹è±¡ãæ¹æ³å\n 2. æ£æ¥åæ°ï¼å¹¶ä¸æ ¹æ®å®æ¶ä»»å¡çåå­å¤æ­æ¯å¦å·²ç»åºç°è¿ï¼ä¸åè®¸ä»»å¡åéå¤\n 3. å¦æåå§åæ¹æ³ãéæ¯æ¹æ³ä¸ä¸ºç©ºï¼å¾å°è¿ä¸¤ä¸ªæ¹æ³\n 4. å° classå¯¹è±¡ãå®æ¶ä»»å¡æ¹æ³ãåå§åæ¹æ³ãéæ¯æ¹æ³ å°è£ä¸º methodjobhandler ï¼å¹¶ä¸ä»¥æ¹æ³åä¸º key æ¾å¥ map\n\nä»¥åå°±å¯ä»¥éè¿å®æ¶ä»»å¡çåç§°æ¥æ¾å° methodjobhandlerï¼ä½¿ç¨ execute() æ¥æ§è¡ã\n\npublic static ijobhandler loadjobhandler(string name){\n    return jobhandlerrepository.get(name);\n}\n\n\né£ä¹ç°å¨ æ¶éå®æ¶ä»»å¡çæµç¨ä¸ºï¼\n\n 1. xxljobspringexecutor æ¾å°å äº @xxljob æ³¨è§£çæ¹æ³\n 2. æ³¨åå° xxljobexecutor ç map ä¸­ã\n\næåï¼ä¸å®æ´ä»£ç ï¼\n\npublic class xxljobspringexecutor extends xxljobexecutor implements applicationcontextaware, smartinitializingsingleton, disposablebean {\n    @override\n    public void aftersingletonsinstantiated() {\n        // å¨è¿éæ¶éå®æ¶ä»»å¡\n        initjobhandlermethodrepository(applicationcontext);\n    }\n   \n    private static applicationcontext applicationcontext;\n    \n\n    @override\n    public void setapplicationcontext(applicationcontext applicationcontext) throws beansexception {\n        xxljobspringexecutor.applicationcontext = applicationcontext;\n    }\n\n    public static applicationcontext getapplicationcontext() {\n        return applicationcontext;\n    }\n    private void initjobhandlermethodrepository(applicationcontext applicationcontext) {\n        if (applicationcontext == null) {\n            return;\n        }\n        // init job handler from method\n        string[] beandefinitionnames = applicationcontext.getbeannamesfortype(object.class, false, true);\n        for (string beandefinitionname : beandefinitionnames) {\n\n            // get bean\n            object bean = null;\n            lazy onbean = applicationcontext.findannotationonbean(beandefinitionname, lazy.class);\n            if (onbean!=null){\n                logger.debug("xxl-job annotation scan, skip @lazy bean:{}", beandefinitionname);\n                continue;\n            }else {\n                bean = applicationcontext.getbean(beandefinitionname);\n            }\n\n            // filter method\n            map<method, xxljob> annotatedmethods = null;   // referred to ï¼org.springframework.context.event.eventlistenermethodprocessor.processbean\n            try {\n                annotatedmethods = methodintrospector.selectmethods(bean.getclass(),\n                        new methodintrospector.metadatalookup<xxljob>() {\n                            @override\n                            public xxljob inspect(method method) {\n                                return annotatedelementutils.findmergedannotation(method, xxljob.class);\n                            }\n                        });\n            } catch (throwable ex) {\n                logger.error("xxl-job method-jobhandler resolve error for bean[" + beandefinitionname + "].", ex);\n            }\n            if (annotatedmethods==null || annotatedmethods.isempty()) {\n                continue;\n            }\n\n            // generate and regist method job handler\n            for (map.entry<method, xxljob> methodxxljobentry : annotatedmethods.entryset()) {\n                method executemethod = methodxxljobentry.getkey();\n                xxljob xxljob = methodxxljobentry.getvalue();\n                // regist\n                registjobhandler(xxljob, bean, executemethod);\n            }\n\n        }\n    }\n}\n\n\npublic class xxljobexecutor {\n    // å­æ¾ methodjobhandler çmapå®¹å¨\n    // key : å®æ¶ä»»å¡çåå­\n    private static concurrentmap<string, ijobhandler> jobhandlerrepository = new concurrenthashmap<string, ijobhandler>();\n    public static ijobhandler loadjobhandler(string name){\n    \treturn jobhandlerrepository.get(name);\n\t}\n\n    protected void registjobhandler(xxljob xxljob, object bean, method executemethod){\n        if (xxljob == null) {\n            return;\n        }\n\n        string name = xxljob.value();\n        //make and simplify the variables since they\'ll be called several times later\n        class<?> clazz = bean.getclass();\n        string methodname = executemethod.getname();\n        if (name.trim().length() == 0) {\n            throw new runtimeexception("xxl-job method-jobhandler name invalid, for[" + clazz + "#" + methodname + "] .");\n        }\n        if (loadjobhandler(name) != null) {\n            throw new runtimeexception("xxl-job jobhandler[" + name + "] naming conflicts.");\n        }\n\n        executemethod.setaccessible(true);\n\n        // init and destroy\n        method initmethod = null;\n        method destroymethod = null;\n\n        if (xxljob.init().trim().length() > 0) {\n            try {\n                initmethod = clazz.getdeclaredmethod(xxljob.init());\n                initmethod.setaccessible(true);\n            } catch (nosuchmethodexception e) {\n                throw new runtimeexception("xxl-job method-jobhandler initmethod invalid, for[" + clazz + "#" + methodname + "] .");\n            }\n        }\n        if (xxljob.destroy().trim().length() > 0) {\n            try {\n                destroymethod = clazz.getdeclaredmethod(xxljob.destroy());\n                destroymethod.setaccessible(true);\n            } catch (nosuchmethodexception e) {\n                throw new runtimeexception("xxl-job method-jobhandler destroymethod invalid, for[" + clazz + "#" + methodname + "] .");\n            }\n        }\n\n        // registry jobhandler\n        registjobhandler(name, new methodjobhandler(bean, executemethod, initmethod, destroymethod));\n\n    }\n    public static ijobhandler registjobhandler(string name, ijobhandler jobhandler){\n        logger.info(">>>>>>>>>>> xxl-job register jobhandler success, name:{}, jobhandler:{}", name, jobhandler);\n        return jobhandlerrepository.put(name, jobhandler);\n    }\n}\n\n\nå¶å®è¿ä¸¤ä¸ªç±»çä»£ç è¿ä¸åå¦æ­¤ï¼æè§å¾ xxl-job ä½ä¸ºä¸ä¸ªå°èç²¾çæ¡æ¶ï¼å®çä»£ç è½ç¶å°ä½æ¯è¯»èµ·æ¥å¾é¾åã\n\næ²¡æéµå¾ª âä¸ä¸ªæ¹æ³å ä¸å±â çè¯å¥½ä¹ æ¯~\n\n\n# 4. å®æ¶ä»»å¡çæ§è¡\n\nç°å¨è®©æä»¬åæä¸ä¸ä½¿ç¨ä»ä¹æ¨¡å¼å»æ§è¡å®æ¶ä»»å¡ï¼åä¸¾ä¸ä¸å¯è½ç¨å°çæ¨¡å¼ï¼\n\n 1. æ¯ä¸æ¬¡æ¥æ¶ triggerparam é½æ°åå»ºä¸ä¸ªçº¿ç¨å»æ§è¡ã\n 2. ä½¿ç¨çº¿ç¨æ± æ¥æ¶ triggerparam æ§è¡ã\n 3. ä¸ä¸ªçº¿ç¨è´è´£ä¸ä¸ªä»»å¡ï¼åä¸ä¸ªä»»å¡çtriggerparamé½ç±è¿ä¸ªçº¿ç¨æ¥æ¶å¹¶æ§è¡ã\n\nå¦ææ¯ä½ ï¼å¦ä½éæ©ï¼ä¸åå³å­ï¼xxl-job ä½¿ç¨ç¬¬ä¸ç§æ¨¡å¼æ§è¡å®æ¶ä»»å¡ï¼èä¸å¯¹è¿ç§æ¨¡å¼è¿è¡äºæ¹è£ ï¼\n\n> xxl-job æ¯ä»¥æ¯ä¸ªçº¿ç¨è´è´£æä¸ä¸ªä»»å¡çæ§è¡ï¼å¯¹äºä¸¤ç§é¢ççä»»å¡ ï¼\n> \n>  1. æ§è¡ç¹å«é¢ç¹çä»»å¡\n>     \n>     xxl-job å¯¹çº¿ç¨è¿è¡äºå°è£ï¼æ¯ä¸ä¸ªçº¿ç¨åé¨é½æä¸ä¸ªé»å¡éåï¼ææ triggerparam é½ä¼è¿å¥è´è´£å¯¹åºä»»å¡ççº¿ç¨çé»å¡éåä¸­ç­å¾æ§è¡ã\n> \n>  2. æ§è¡ä¸é¢ç¹çä»»å¡\n>     \n>     çº¿ç¨å¹¶ä¸æ¯ä¸ç´é½å¨å·¥ä½ï¼å®æ¯å¾ªç¯ä»é»å¡éåä¸­å triggerparamï¼å¦æ 3ç§éåä¸å°å°±è¿å¥ä¸ä¸æ¬¡å¾ªç¯ï¼åæ¶è®°å½è¿æ¯ç¬¬å æ¬¡æ æå¾ªç¯ï¼å¦æè¶è¿30æ¬¡ï¼å°±å°çº¿ç¨éæ¯ãé²æ­¢çº¿ç¨æ²¡äºå¹²åå èµæºã\n\næ ¹æ®ä¸é¢çæè¿°ï¼çæµä¸ä¸ xxl-job å°è£ççº¿ç¨éè¦åªäºåé ï¼\n\né»å¡éåãæ æå¾ªç¯æ¬¡æ°ãçº¿ç¨æ¯å¦è¿å¨å·¥ä½çæ å¿ãçº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡çæ å¿ãä»»å¡æ§è¡éè¦ç\n\npublic class jobthread extends thread{\n    private static logger logger = loggerfactory.getlogger(jobthread.class);\n\t// æ­¤æ¶è¿ä¸ªçº¿ç¨è´è´£çå®æ¶ä»»å¡çid\n\tprivate int jobid;\n    // è¯¥å®æ¶ä»»å¡ç methodjobhandler\n\tprivate ijobhandler handler;\n    // æä»»å¡æ¶å°±ä¼æ¾å°è¿ä¸ªé»å¡éåä¸­\n\tprivate linkedblockingqueue<triggerparam> triggerqueue;\n    // é²æ­¢éå¤è°åº¦\n    private set<long> triggerlogidset;\t\t\n\t// è¯¥çº¿ç¨æ¯å¦è¿å¨å·¥ä½\n\tprivate volatile boolean tostop = false;\n    // è¯¥çº¿ç¨åæ­¢çåå æ¯ä»ä¹ï¼æå¯è½æ¯é¿æ¶é´æ²¡æä»»å¡ï¼æå¯è½æ¯å¼åäººåæå¨å³é­å®æ¶ä»»å¡\n\tprivate string stopreason;\n\t// çº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡ï¼"æ­£å¨è¿è¡"ä¸åæ¬çº¿ç¨å¾ªç¯ãé»å¡ç­å¾ä»»å¡å°æ¥ï¼èæ¯ççæ­£æ­£çæ­£å¨è¿è¡ä»»å¡\n    private boolean running = false;    \n    // çº¿ç¨æ æå¾ªç¯æ¬¡æ°\n\tprivate int idletimes = 0;\n    \n    public jobthread(int jobid, ijobhandler handler) {\n\t\tthis.jobid = jobid;\n\t\tthis.handler = handler;\n\t\tthis.triggerqueue = new linkedblockingqueue<triggerparam>();\n\t\tthis.triggerlogidset = collections.synchronizedset(new hashset<long>());\n\n\t\tthis.setname("xxl-job, jobthread-"+jobid+"-"+system.currenttimemillis());\n\t}\n}\n\n\n 1. ä¸é¢æä¸ä¸ª triggerlogidsetï¼å¶å®è¿ä¸ªåéå¾é¾ç¨ä¸ï¼æä»¥è¿éåä¸è¯´äºã\n\n 2. tostop å running æä»ä¹åºå«å¢ï¼\n    \n    tostop ï¼æ­¤çº¿ç¨æ¯å¦è¿å¨è¿è¡\n    \n    running ï¼æ­¤çº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡\n    \n    å®ä¿©çåºå« æä»¬é¦åè¦é»å¡çä»éåä¸­åå¼ï¼è¿æ¶ tostop = falseï¼running = falseï¼å ä¸ºçº¿ç¨ç¡®å®å¨è¿è¡ï¼ä½æ¯æ²¡æåå°ä»»å¡ã\n    \n    ä»éåä¸­ååº triggerparam åï¼ tostop = falseï¼running = trueï¼å ä¸ºç°å¨å·²ç»å¯ä»¥å¼å§è¿è¡ä»»å¡äºã\n\npublic class jobthread extends thread{\n    private static logger logger = loggerfactory.getlogger(jobthread.class);\n\t// æ­¤æ¶è¿ä¸ªçº¿ç¨è´è´£çå®æ¶ä»»å¡çid\n\tprivate int jobid;\n    // è¯¥å®æ¶ä»»å¡ç methodjobhandler\n\tprivate ijobhandler handler;\n    // æä»»å¡æ¶å°±ä¼æ¾å°è¿ä¸ªé»å¡éåä¸­\n\tprivate linkedblockingqueue<triggerparam> triggerqueue;\n    // é²æ­¢éå¤è°åº¦\n    private set<long> triggerlogidset;\t\t\n\t// è¯¥çº¿ç¨æ¯å¦è¿å¨å·¥ä½\n\tprivate volatile boolean tostop = false;\n    // è¯¥çº¿ç¨åæ­¢çåå æ¯ä»ä¹ï¼æå¯è½æ¯é¿æ¶é´æ²¡æä»»å¡ï¼æå¯è½æ¯å¼åäººåæå¨å³é­å®æ¶ä»»å¡\n\tprivate string stopreason;\n\t// çº¿ç¨æ¯å¦æ­£å¨è¿è¡ä»»å¡ï¼"æ­£å¨è¿è¡"ä¸åæ¬çº¿ç¨å¾ªç¯ãé»å¡ç­å¾ä»»å¡å°æ¥ï¼èæ¯ççæ­£æ­£çæ­£å¨è¿è¡ä»»å¡\n    private boolean running = false;    \n    // çº¿ç¨æ æå¾ªç¯æ¬¡æ°\n\tprivate int idletimes = 0;\t\t\t\n\n\n\tpublic jobthread(int jobid, ijobhandler handler) {\n\t\tthis.jobid = jobid;\n\t\tthis.handler = handler;\n\t\tthis.triggerqueue = new linkedblockingqueue<triggerparam>();\n\t\tthis.triggerlogidset = collections.synchronizedset(new hashset<long>());\n\n\t\tthis.setname("xxl-job, jobthread-"+jobid+"-"+system.currenttimemillis());\n\t}\n    // è°åº¦ä¸­å¿ä»æ°æ®åºä¸­æ¥åºå°è¦æ§è¡çä»»å¡ï¼å°è¿ä¸ªä»»å¡åéç»æ§è¡å¨\n    // æ§è¡å¨æ¶å°æ¶æ¯åå°è¿æ¬¡æ§è¡æ¾å¥éåä¸­ç­å¾æ§è¡\n    public returnt<string> pushtriggerqueue(triggerparam triggerparam) {\n\t\t// avoid repeat\n\t\tif (triggerlogidset.contains(triggerparam.getlogid())) {\n\t\t\tlogger.info(">>>>>>>>>>> repeate trigger job, logid:{}", triggerparam.getlogid());\n\t\t\treturn new returnt<string>(returnt.fail_code, "repeate trigger job, logid:" + triggerparam.getlogid());\n\t\t}\n\n\t\ttriggerlogidset.add(triggerparam.getlogid());\n\t\ttriggerqueue.add(triggerparam);\n        return returnt.success;\n\t}\n    // çº¿ç¨æ¯å¦å¨å·¥ä½ï¼æèéåä¸­æ¯å¦æä»»å¡ç­å¾æ§è¡\n    public boolean isrunningorhasqueue() {\n        return running || triggerqueue.size()>0;\n    }\n\n    @override\n\tpublic void run() {\n\t\t// æä¸å®ç°\n\t}\n}\n\n\nè¿ä¸ªpushtriggerparam æ²¡å¹²å¥äºï¼æ éå°±æ¯å¤æ­ä¸ä¸æ¯å¦éå¤è°åº¦ï¼ç¶åå°triggerparamæ¾å¥é»å¡éåã\n\nrunæ¹æ³ææ¯éå¤´æï¼\n\n@override\npublic void run() {\n\n    // init\n    try {\n        handler.init();\n    } catch (throwable e) {\n        logger.error(e.getmessage(), e);\n    }\n\n    // \n    while(!tostop){\n        running = false;\n        idletimes++;\n\n        triggerparam triggerparam = null;\n        try {\n            triggerparam = triggerqueue.poll(3l, timeunit.seconds);\n            if (triggerparam != null) {\n                running = true;\n                idletimes = 0;\n                triggerlogidset.remove(triggerparam.getlogid());\n                // æå°æ¥å¿ï¼è¡¨ç¤ºä»»å¡å°è¦æ§è¡\n                xxljobhelper.log("<br>----------- xxl-job job execute start -----------<br>----------- param:" + xxljobcontext.getjobparam());\n                // æ§è¡ä»»å¡!!!\n                handler.execute();\n            } else {\n                if (idletimes > 30) {\n                    if(triggerqueue.size() == 0) {\t\n                        // å°æ­¤çº¿ç¨åæ­¢ï¼æèè¯´ç§»é¤\n                        xxljobexecutor.removejobthread(jobid, "excutor idel times over limit.");\n                    }\n                }\n            }\n        } catch (throwable e) {\n            if (tostop) {\n                xxljobhelper.log("<br>----------- jobthread tostop, stopreason:" + stopreason);\n            }\n\n            // handle result\n            stringwriter stringwriter = new stringwriter();\n            e.printstacktrace(new printwriter(stringwriter));\n            string errormsg = stringwriter.tostring();\n\n            xxljobhelper.handlefail(errormsg);\n\n            xxljobhelper.log("<br>----------- jobthread exception:" + errormsg + "<br>----------- xxl-job job execute end(error) -----------");\n        } finally {\n            if(triggerparam != null) {\n                // callback handler info\n                if (!tostop) {\n                    // commonm\n                    triggercallbackthread.pushcallback(new handlecallbackparam(\n                        triggerparam.getlogid(),\n                        triggerparam.getlogdatetime(),\n                        xxljobcontext.getxxljobcontext().gethandlecode(),\n                        xxljobcontext.getxxljobcontext().gethandlemsg() )\n                                                      );\n                } else {\n                    // is killed\n                    triggercallbackthread.pushcallback(new handlecallbackparam(\n                        triggerparam.getlogid(),\n                        triggerparam.getlogdatetime(),\n                        xxljobcontext.handle_code_fail,\n                        stopreason + " [job running, killed]" )\n                                                      );\n                }\n            }\n        }\n    }\n    // destroy\n    try {\n        handler.destroy();\n    } catch (throwable e) {\n        logger.error(e.getmessage(), e);\n    }\n    logger.info(">>>>>>>>>>> xxl-job jobthread stoped, hashcode:{}", thread.currentthread());\n}\n\n\næºä»£ç å¶å®æºå¤æçï¼èä¸å¾å¤ä¸è¥¿ç°å¨æ²¡æè®²å°ï¼æä»¥æå åäºå¾å¤ï¼ç­ä¼è¡¥ä¸ã\n\n 1. æ§è¡åå§åæ¹æ³ï¼è¿å¥å¾ªç¯\n\n 2. æ¯æ¬¡å¾ªç¯é½å° idletimes å ä¸ï¼ä»é»å¡éåä¸­åå¼ï¼æå¤ç­å¾ä¸ç§ï¼å¦æè¶è¿äºå°±è¯´æç°å¨æ²¡æä»»å¡ï¼åæ¬¡å¾ªç¯ï¼å¦ææ æå¾ªç¯ 30 æ¬¡ï¼å°±ä¼è§¦å xxljobexecutor.removejobthread å°æ­¤çº¿ç¨åæ­¢å¹¶ç§»é¤ã\n\n 3. å¦æä»é»å¡éåä¸­åå°äºå¼ï¼å° idletimesç½®ä¸º0ï¼å¹¶å° running = true è¡¨ç¤ºä»ç°å¨å¼å§è¦æ§è¡ä»»å¡äº\n    \n    æå°ä¸ä¸æ¥å¿ï¼ä½¿ç¨ handler.execute() æ§è¡ä»»å¡ã\n\n 4. å¦æåºç°å¼å¸¸ï¼é¤äºæå°æ¥å¿ä¹å¤ï¼æ§è¡äº xxljobhelper.handlefail(errormsg) è¿å¥è¯ï¼è®°ä½å®ï¼ç­ä¼è¯´\n\n 5. å¨ finally åä¸­è°ç¨ triggercallbackthread.pushcallback() å°ä»»å¡æ§è¡çç»æåè°ç»è°åº¦ä¸­å¿ï¼è¿ä¸ªæä¸ä¸è¯´ï¼åé¢çç« èä¼å®åã\n\nä½æ¯ç°å¨å®æ¶ä»»å¡çæ§è¡åè½è¿ä¸å®åï¼æä»¬ä¹åä½¿ç¨çæ¶åæ¯æ è¶æ¶æ¶é´ è¿ä¸ªåè½çï¼è¿ä¸ªåè½è¯¥å¦ä½å®ç°ï¼æä»¬å¯ä»¥æ°åå»ºä¸ä¸ªçº¿ç¨ï¼å°å®æ¶ä»»å¡åè£ä¸ºä¸ä¸ª futuretaskï¼å¨æ§è¡çæ¶å future.get(seconds)ï¼å¦ææ§è¡è¶æ¶ï¼å°±ä¼åºç°è¶æ¶å¼å¸¸ï¼æä»¬å°å¶æè·å°±å¯ä»¥äºã\n\næ·»å äºè¶æ¶æ¶é´åè½çä»£ç ï¼\n\n@override\npublic void run() {\n\n    // init\n    try {\n        handler.init();\n    } catch (throwable e) {\n        logger.error(e.getmessage(), e);\n    }\n\n    // execute\n    while(!tostop){\n        running = false;\n        idletimes++;\n\n        triggerparam triggerparam = null;\n        try {\n            triggerparam = triggerqueue.poll(3l, timeunit.seconds);\n            if (triggerparam!=null) {\n                running = true;\n                idletimes = 0;\n                triggerlogidset.remove(triggerparam.getlogid());\n                // æå°æ¥å¿ï¼è¡¨ç¤ºä»»å¡å°è¦æ§è¡\n                xxljobhelper.log("<br>----------- xxl-job job execute start -----------<br>----------- param:" + xxljobcontext.getjobparam());\n                if (triggerparam.getexecutortimeout() > 0) {\n                    // limit timeout\n                    thread futurethread = null;\n                    try {\n                        futuretask<boolean> futuretask = new futuretask<boolean>(new callable<boolean>() {\n                            @override\n                            public boolean call() throws exception {\n                                handler.execute();\n                                return true;\n                            }\n                        });\n                        futurethread = new thread(futuretask);\n                        futurethread.start();\n\n                        boolean tempresult = futuretask.get(triggerparam.getexecutortimeout(), timeunit.seconds);\n                    } catch (timeoutexception e) {\n\n                        xxljobhelper.log("<br>----------- xxl-job job execute timeout");\n                        xxljobhelper.log(e);\n                    } finally {\n                        futurethread.interrupt();\n                    }\n                } else {\n                    // just execute\n                    handler.execute();\n                }\n            } else {\n                if (idletimes > 30) {\n                    if(triggerqueue.size() == 0) {\t\n                        xxljobexecutor.removejobthread(jobid, "excutor idel times over limit.");\n                    }\n                }\n            }\n        } catch (throwable e) {\n            if (tostop) {\n                xxljobhelper.log("<br>----------- jobthread tostop, stopreason:" + stopreason);\n            }\n\n            // handle result\n            stringwriter stringwriter = new stringwriter();\n            e.printstacktrace(new printwriter(stringwriter));\n            string errormsg = stringwriter.tostring();\n\n            xxljobhelper.handlefail(errormsg);\n\n            xxljobhelper.log("<br>----------- jobthread exception:" + errormsg + "<br>----------- xxl-job job execute end(error) -----------");\n        } finally {\n            if(triggerparam != null) {\n                // callback handler info\n                if (!tostop) {\n                    // commonm\n                    triggercallbackthread.pushcallback(new handlecallbackparam(\n                        triggerparam.getlogid(),\n                        triggerparam.getlogdatetime(),\n                        xxljobcontext.getxxljobcontext().gethandlecode(),\n                        xxljobcontext.getxxljobcontext().gethandlemsg() )\n                                                      );\n                } else {\n                    // is killed\n                    triggercallbackthread.pushcallback(new handlecallbackparam(\n                        triggerparam.getlogid(),\n                        triggerparam.getlogdatetime(),\n                        xxljobcontext.handle_code_fail,\n                        stopreason + " [job running, killed]" )\n                                                      );\n                }\n            }\n        }\n    }\n    // destroy\n    try {\n        handler.destroy();\n    } catch (throwable e) {\n        logger.error(e.getmessage(), e);\n    }\n    logger.info(">>>>>>>>>>> xxl-job jobthread stoped, hashcode:{}", thread.currentthread());\n}\n\n\nå¯ä»¥çå°è¿ä¸ªå¾ªç¯å¶å®å¾å®¹æåä¸æ¥ï¼æä»¬åªéè¦å° tostop è®¾ç½®ä¸º trueï¼è¿ä¸ªå¤çº¿ç¨çå¾ªç¯å°±ä¼åæ­¢ã\n\npublic void tostop(string stopreason) {\n    tostop = true;\n    this.stopreason = stopreason;\n}\n\n\n\n# 5. xxljobcontext\n\nå¨ä¸é¢çä»£ç ä¸­ï¼xxljobcontext å xxljobhelper åºç°äºå¾å¤æ¬¡ï¼xxljobhelper æä»¬å¨åæå·²ç»è¯ç¨äºï¼å°±æ¯è®°å½æ¥å¿çåï¼ä½æ¯å®ä¸ä»ä»å¯ä»¥è®°å½æ¥å¿ï¼è¿å¯ä»¥ä¿®æ¹ xxljobcontext çç¶æï¼é£ä¹ xxljobcontext æ¯ä»ä¹å¢ï¼\n\nåªè¦æ¶å context çé½æ¯ä¸ä¸æï¼xxljobcontext ä¹ä¸ä¾å¤ï¼æå«å®ä»»å¡ä¸ä¸æï¼ä½¿ç¨ context çä½ç¨å°±æ¯æä»¬å¯ä»¥å°æäºä¿¡æ¯ç´æ¥æ¾éé¢ï¼æ³ç¨çæ¶åç´æ¥ xxljobcontext.getxxx() æ¿åºæ¥ï¼èä¸æ¯å°ä¿¡æ¯ä½ä¸ºæ¹æ³çåæ°ä¼ æ¥ä¼ å»çã\n\npublic class xxljobcontext {\n\n    public static final int handle_code_success = 200;\n    public static final int handle_code_fail = 500;\n    public static final int handle_code_timeout = 502;\n\n    // ---------------------- base info ----------------------\n\n    /**\n     * ä»»å¡id\n     */\n    private final long jobid;\n\n    /**\n     * ä»»å¡åæ°\n     */\n    private final string jobparam;\n\n    /**\n     * ä»»å¡æ¥å¿æä»¶çæä»¶å\n     */\n    private final string joblogfilename;\n\n    /**\n     * åçç´¢å¼\n     */\n    private final int shardindex;\n\n    /**\n     * åçæ»æ°\n     */\n    private final int shardtotal;\n\n    /**\n     * handlecodeï¼æ§è¡ç»æ\n     *\n     *      200 : success\n     *      500 : fail\n     *      502 : timeout\n     *\n     */\n    private int handlecode;\n\n    /**\n     * æ§è¡ä¿¡æ¯\n     */\n    private string handlemsg;\n    \n    private static inheritablethreadlocal<xxljobcontext> contextholder = new inheritablethreadlocal<xxljobcontext>(); \n\n    public static void setxxljobcontext(xxljobcontext xxljobcontext){\n        contextholder.set(xxljobcontext);\n    }\n\n    public static xxljobcontext getxxljobcontext(){\n        return contextholder.get();\n    }\n\n}\n\n\né¤äºä¸äºåºæ¬ä¿¡æ¯ä»¥å¤ï¼xxljobcontext æä¾äº setxxljobcontext çæ¹æ³ï¼å° xxljobcontext æ¾å° threadlocal ä¸­ï¼è¿ä¸ª inheritablethreadlocal ç»§æ¿èª threadlocalï¼ä½ç¨æ¯å¯ä»¥ä¿è¯ç¶å­çº¿ç¨å±ç¨æ°æ®ã\n\né£ä¹å®ä»ä¹æ¶ååå»ºï¼å¿ç¶æ¯æä»»å¡æ§è¡çæ¶ååå»ºã\n\næ³è¦æ´æ¹ xxljobcontext çæ°æ®å¶å®ä¹æºéº»ç¦ç\n\nxxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\nxxljobcontext.sethandlermsg("xxxxxx");\n\n\næ³è¦ä¿®æ¹ xxljobcontext ä¸­ç handle_codeãhandle_msg éè¦ä¸¤è¡ä»£ç ï¼æºéº»ç¦çã\n\næä»¥ xxljobhelper ç»æä»¬å°è£äºä¸ä¸ï¼æ¯å¦è·åå½åæ­£å¨æ§è¡çä»»å¡çåæ°ãè·åå½åæ­£å¨æ§è¡çä»»å¡çè°åº¦ä¿¡æ¯ãè®¾ç½®å½åæ­£å¨æ§è¡çä»»å¡çæ§è¡ç»æ...\n\npublic class xxljobhelper {\n\n    // ---------------------- base info ----------------------\n\n    /**\n     * current jobid\n     *\n     * @return\n     */\n    public static long getjobid() {\n        xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n        if (xxljobcontext == null) {\n            return -1;\n        }\n\n        return xxljobcontext.getjobid();\n    }\n\n    /**\n     * current jobparam\n     *\n     * @return\n     */\n    public static string getjobparam() {\n        xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n        if (xxljobcontext == null) {\n            return null;\n        }\n\n        return xxljobcontext.getjobparam();\n    }\n\n    // ---------------------- for log ----------------------\n\n    /**\n     * current joblogfilename\n     *\n     * @return\n     */\n    public static string getjoblogfilename() {\n        xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n        if (xxljobcontext == null) {\n            return null;\n        }\n\n        return xxljobcontext.getjoblogfilename();\n    }\n\n    public static int getshardindex() {\n        xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n        if (xxljobcontext == null) {\n            return -1;\n        }\n\n        return xxljobcontext.getshardindex();\n    }\n\n    /**\n     * current shardtotal\n     *\n     * @return\n     */\n    public static int getshardtotal() {\n        xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n        if (xxljobcontext == null) {\n            return -1;\n        }\n\n        return xxljobcontext.getshardtotal();\n    }\n    public static boolean handlesuccess(){\n        return handleresult(xxljobcontext.handle_code_success, null);\n    }\n    public static boolean handlesuccess(string handlemsg) {\n        return handleresult(xxljobcontext.handle_code_success, handlemsg);\n    }\n    public static boolean handlefail(){\n        return handleresult(xxljobcontext.handle_code_fail, null);\n    }\n\n    /**\n     * handle fail with log msg\n     *\n     * @param handlemsg\n     * @return\n     */\n    public static boolean handlefail(string handlemsg) {\n        return handleresult(xxljobcontext.handle_code_fail, handlemsg);\n    }\n\n    /**\n     * handle timeout\n     *\n     * @return\n     */\n    public static boolean handletimeout(){\n        return handleresult(xxljobcontext.handle_code_timeout, null);\n    }\n\n    /**\n     * handle timeout with log msg\n     *\n     * @param handlemsg\n     * @return\n     */\n    public static boolean handletimeout(string handlemsg){\n        return handleresult(xxljobcontext.handle_code_timeout, handlemsg);\n    }\n\n    /**\n     * @param handlecode\n     *\n     *      200 : success\n     *      500 : fail\n     *      502 : timeout\n     *\n     * @param handlemsg\n     * @return\n     */\n    public static boolean handleresult(int handlecode, string handlemsg) {\n        xxljobcontext xxljobcontext = xxljobcontext.getxxljobcontext();\n        if (xxljobcontext == null) {\n            return false;\n        }\n\n        xxljobcontext.sethandlecode(handlecode);\n        if (handlemsg != null) {\n            xxljobcontext.sethandlemsg(handlemsg);\n        }\n        return true;\n    }\n\n}\n\n\nè¿ä»£ç æå°±ä¸ç»è®²äºï¼æ éå°±æ¯è·å xxljobcontextï¼set/get å¥çãä½ å°±è®°ä½ï¼ä½¿ç¨ xxljobcontext å¯ä»¥è·åå½åæ­£å¨æ§è¡çä»»å¡çä¿¡æ¯ï¼è xxljobhelper æä¾äºä¾¿äºæä½å®çapiã\n\nç°å¨å¯ä»¥è´´ jobthread#run çå¨é¨ä»£ç äº\n\n@override\npublic void run() {\n\n    // init\n    try {\n        handler.init();\n    } catch (throwable e) {\n        logger.error(e.getmessage(), e);\n    }\n\n    // execute\n    while(!tostop){\n        running = false;\n        idletimes++;\n\n        triggerparam triggerparam = null;\n        try {\n            triggerparam = triggerqueue.poll(3l, timeunit.seconds);\n            if (triggerparam!=null) {\n                running = true;\n                idletimes = 0;\n                triggerlogidset.remove(triggerparam.getlogid());\n\t\t\t\t// çææ¥å¿æä»¶ï¼è¿ä¸ªä»¥åä¼è¯´\n                string logfilename = xxljobfileappender.makelogfilename(new date(triggerparam.getlogdatetime()), triggerparam.getlogid());\n                \n                // ä»»å¡ååå¤å¼å§æ§è¡ï¼æ¯åå»º xxljobcontext çå¤§å¥½æ¶æºå\n                xxljobcontext xxljobcontext = new xxljobcontext(\n                    triggerparam.getjobid(),\n                    triggerparam.getexecutorparams(),\n                    logfilename,\n                    triggerparam.getbroadcastindex(),\n                    triggerparam.getbroadcasttotal()\n                );\n\n                // å° xxljobcontext æ¾å¥ threadlocal\n                xxljobcontext.setxxljobcontext(xxljobcontext);\n\n                // æå°æ¥å¿ï¼å¼å§æ§è¡!\n                xxljobhelper.log("<br>----------- xxl-job job execute start -----------<br>----------- param:" + xxljobcontext.getjobparam());\n\t\t\t\t// å¦æè®¾ç½®äºè¶æ¶æ¶é´ï¼å¼å¯æ°çº¿ç¨ï¼åè£ä¸º futuretask æ§è¡ãè¶æ¶å°±ç»æ\n                if (triggerparam.getexecutortimeout() > 0) {\n                    // limit timeout\n                    thread futurethread = null;\n                    try {\n                        futuretask<boolean> futuretask = new futuretask<boolean>(new callable<boolean>() {\n                            @override\n                            public boolean call() throws exception {\n\t\t\t\t\t\t\t\t// ç±äºæ¯å¼å¯æ°çº¿ç¨æ§è¡ï¼æä»¥è¦éæ°è®¾ç½®ä¸ä¸ã\n                                xxljobcontext.setxxljobcontext(xxljobcontext);\n\t\t\t\t\t\t\t\t// å¼å§æ§è¡\n                                handler.execute();\n                                // å¦æè½æ§è¡å®è¿åtrue\n                                return true;\n                            }\n                        });\n                        futurethread = new thread(futuretask);\n                        futurethread.start();\n\t\t\t\t\t\t// getç»æï¼æå®æ¶é´ågetä¸å°å°±æåºå¼å¸¸ã\n                        boolean tempresult = futuretask.get(triggerparam.getexecutortimeout(), timeunit.seconds);\n                    } catch (timeoutexception e) {\n\n                        xxljobhelper.log("<br>----------- xxl-job job execute timeout");\n                        xxljobhelper.log(e);\n\n                        // æè·å¼å¸¸ä¹åé¤äºè®°å½æ¥å¿ï¼è¿è¦å°timeoutè®°å½å¨contextä¸­ã\n                        xxljobhelper.handletimeout("job execute timeout ");\n                    } finally {\n                        futurethread.interrupt();\n                    }\n                } else {\n                    // just execute\n                    handler.execute();\n                }\n\n                // èµ°å°è¿éå¦æ handler_code è¿æ¯ <= 0ï¼åªè½è¯´è¿ä¸ªä»»å¡ä¸¢å¤±äº\n                if (xxljobcontext.getxxljobcontext().gethandlecode() <= 0) {\n                    xxljobhelper.handlefail("job handle result lost.");\n                } else {\n                    // å¦åè¿ä¸ªä»»å¡å°±æ¯æåäºãå ä¸ºä¸ä¸åºç°å¼å¸¸ä¼è¢«catchå°æ ¹æ¬ä¸ä¼èµ°å°è¿é\n                    string temphandlemsg = xxljobcontext.getxxljobcontext().gethandlemsg();\n                    temphandlemsg = (temphandlemsg!=null&&temphandlemsg.length()>50000)\n                        ?temphandlemsg.substring(0, 50000).concat("...")\n                        :temphandlemsg;\n                    xxljobcontext.getxxljobcontext().sethandlemsg(temphandlemsg);\n                }\n                // æå°æ¥å¿\n                xxljobhelper.log("<br>----------- xxl-job job execute end(finish) -----------<br>----------- result: handlecode="\n                                 + xxljobcontext.getxxljobcontext().gethandlecode()\n                                 + ", handlemsg = "\n                                 + xxljobcontext.getxxljobcontext().gethandlemsg()\n                                );\n\n            } else {\n                // å¦ææ²¡æå¨éåä¸­ååºä»»å¡ï¼å¹¶ä¸å·²ç»æ æå¾ªç¯äº30æ¬¡ (ä¹å°±æ¯90s)ï¼å°çº¿ç¨éæ¯\n                if (idletimes > 30) {\n                    // åæ¬¡éå¤å¤æ­ï¼é¿åå¹¶åæåµ\n                    if(triggerqueue.size() == 0) {\t\n                        xxljobexecutor.removejobthread(jobid, "excutor idel times over limit.");\n                    }\n                }\n            }\n        } catch (throwable e) {\n            if (tostop) {\n                xxljobhelper.log("<br>----------- jobthread tostop, stopreason:" + stopreason);\n            }\n\n            // handle result\n            stringwriter stringwriter = new stringwriter();\n            e.printstacktrace(new printwriter(stringwriter));\n            string errormsg = stringwriter.tostring();\n\t\t\t// å¦æåºç°å¼å¸¸ï¼å°ä»»å¡è®¾ç½®ä¸ºå¤±è´¥ï¼å¹¶å¡«ä¸å¤±è´¥ä¿¡æ¯\n            xxljobhelper.handlefail(errormsg);\n\n            xxljobhelper.log("<br>----------- jobthread exception:" + errormsg + "<br>----------- xxl-job job execute end(error) -----------");\n        } finally {\n            // å°æ­¤ä»»å¡çæ§è¡ç»æåéç»è°åº¦ä¸­å¿ï¼è¿ä¸ªåä¸ç®¡ã\n            if(triggerparam != null) {\n                // callback handler info\n                if (!tostop) {\n                    // commonm\n                    triggercallbackthread.pushcallback(new handlecallbackparam(\n                        triggerparam.getlogid(),\n                        triggerparam.getlogdatetime(),\n                        xxljobcontext.getxxljobcontext().gethandlecode(),\n                        xxljobcontext.getxxljobcontext().gethandlemsg() )\n                                                      );\n                } else {\n                    // is killed\n                    triggercallbackthread.pushcallback(new handlecallbackparam(\n                        triggerparam.getlogid(),\n                        triggerparam.getlogdatetime(),\n                        xxljobcontext.handle_code_fail,\n                        stopreason + " [job running, killed]" )\n                                                      );\n                }\n            }\n        }\n    }\n\n    // è½èµ°å°è¿éï¼è¯´æ tostopåéè¢«è®¾ç½®ä¸ºtrueäºï¼æä»¥ä¸ä¸¤ç§å¯è½:\n    // 1. å¼åäººåæå¨å³é­å®æ¶ä»»å¡\n    // 2. ä»»å¡å¾ä¹æ²¡ææ§è¡ï¼è§¦åäº xxljobexecutor.removejobthread()å°çº¿ç¨ç§»é¤\n    // ç°å¨è¦å¤æ­éåä¸­æ¯å¦è¿æå¼ï¼å¦ææ¯å ä¸ºç¬¬äºç§æåµèµ°åºçwhileå¾ªç¯ï¼æ ¹æ¬ä¸ä¼èµ°ä¸é¢çé»è¾\n    // å¦æå®æ¶ä»»å¡å³é­äºï¼å°ææè¿ä¸ªä»»å¡æ²¡æ§è¡ç"æ¬¡æ°"å¨é¨ååºæ¥åéç»è°åº¦ä¸­å¿ï¼åè¯å¼åäººåè¿äºæ²¡æ§è¡ã\n    while(triggerqueue !=null && triggerqueue.size()>0){\n        triggerparam triggerparam = triggerqueue.poll();\n        if (triggerparam!=null) {\n            // is killed\n            triggercallbackthread.pushcallback(new handlecallbackparam(\n                triggerparam.getlogid(),\n                triggerparam.getlogdatetime(),\n                xxljobcontext.handle_code_fail,\n                stopreason + " [job not executed, in the job queue, killed.]")\n                                              );\n        }\n    }\n\n    // destroy\n    try {\n        handler.destroy();\n    } catch (throwable e) {\n        logger.error(e.getmessage(), e);\n    }\n\n    logger.info(">>>>>>>>>>> xxl-job jobthread stoped, hashcode:{}", thread.currentthread());\n}\n\n\nè¿éæ¾åºå¨é¨ jobthread çä»£ç ï¼ï¼ççå¯ä»¥ä¸è½½æºç å»çï¼å¨è¿éçä¸è½ ctrl ç¹å»ï¼é¾åï¼\n\nä¸ºäºæ¹ä¾¿éè¯»ï¼æå° å¤æ­æ¯å¦æè¶æ¶æ¶é´ é£æ®µé»è¾å°è£ä¸ºäº doexecutor æ¹æ³ï¼å¸æä½ è½çè§£ã\n\npublic class jobthread extends thread {\n    private static logger logger = loggerfactory.getlogger(jobthread.class);\n\n    /**\n     * å®æ¶ä»»å¡çid\n     */\n    private int jobid;\n\n    /**\n     * æ­¤ä»»å¡ç»å®çå¯¹è±¡\n     */\n    private ijobhandler handler;\n\n    /**\n     * åå«éè¦è¢«æ§è¡çå®æ¶ä»»å¡(è§¦åå¨åæ°)\n     */\n    private linkedblockingqueue<triggerparam> triggerqueue;\n\n    /**\n     * æ­£å¨è°åº¦çä»»å¡çæ¥å¿idéå(çº¿ç¨å®å¨)\n     */\n    private set<long> triggerlogidset;\n\n    /**\n     * è¯¥ç»ä»¶æ¯å¦ç»æï¼å¦æè¿ä¸ªç»ä»¶ç»æï¼è¯´æè¯¥çº¿ç¨æ­£å¨è´è´£çå®æ¶ä»»å¡è¢«åæ¶äº\n     */\n    private volatile boolean tostop = false;\n\n    /**\n     * è¯¥ä»»å¡è¢«åæ¶çåå \n     */\n    private string stopreason;\n\n    /**\n     * è¯¥çº¿ç¨æ¯å¦æ­£å¨è¿è¡(æ­£å¨è¿è¡ä»»å¡ï¼å¦æåªæ¯ç­å¾ä»éåä¸­åä»»å¡ä¸ç®è¿è¡ä¸­)\n     */\n    private boolean running = false;\n\n    /**\n     * ç©ºè½¬æ¬¡æ°ï¼è¾¾å°ä¸å®æ¬¡æ°ä¾¿éæ¯è¯¥çº¿ç¨ï¼è¿é»å¡é½ä¸è®©å®é»å¡\n     */\n    private int idletimes = 0;\n\n    public jobthread(int jobid, ijobhandler handler) {\n        this.jobid = jobid;\n        this.handler = handler;\n        this.triggerqueue = new linkedblockingqueue<>();\n        this.triggerlogidset = collections.synchronizedset(new hashset<>());\n        this.setname("xxl-job, jobthread - " + jobid + " - " + system.currenttimemillis());\n    }\n\n    /**\n     * è°åº¦åæ°æ¾å¥è°åº¦éå\n     *\n     * @param triggerparam\n     */\n    public result pushtriggerqueue(triggerparam triggerparam) {\n        // å¦ææ¥å¿idéåä¸­åå«æ­¤è°åº¦åæ°ï¼è¯´æå¯è½éå¤è°åº¦äº\n        if (triggerlogidset.contains(triggerparam.getlogid())) {\n            logger.info(">>>>>>>>>>>> repeate trigger job, logid: {}", triggerparam.getlogid());\n            return result.error("repeate trigger job, logid:" + triggerparam.getlogid());\n        }\n        triggerlogidset.add(triggerparam.getlogid());\n        triggerqueue.add(triggerparam);\n        return result.success();\n    }\n\n    /**\n     * å¤æ­è¯¥çº¿ç¨æ¯å¦æ­£å¨å¿ç¢ï¼æ­£å¨è¿è¡ä»»å¡ãé»å¡éåä¸­æè°åº¦åæ°ç­å¾æ§è¡ ä»£è¡¨å¿ç¢\n     */\n    public boolean isrunningorhasqueue() {\n        return running || !triggerqueue.isempty();\n    }\n\n    @override\n    public void run() {\n        // æ§è¡åå§åæ¹æ³\n        runinitmethod();\n        // å¼å§æ§è¡\n        while (!tostop) {\n            // åè¿å¥å¾ªç¯ä¸ç®æ§è¡ï¼å¾å°è°åº¦åæ°æç®æ§è¡\n            running = false;\n            idletimes += 1;\n            triggerparam triggerparam = null;\n            try {\n                triggerparam = triggerqueue.poll(3l, timeunit.seconds);\n                if (triggerparam == null) {\n                    // å¦æé»å¡3sæ²¡æè°åº¦åæ°ï¼å¹¶ä¸ç°å¨å·²ç»å¾ªç¯äº30æ¬¡ï¼éåä¸­è¿æ¯æ²¡ææ°æ®ï¼å¾ï¼éæ¯çº¿ç¨\n                    if (idletimes > 30 && triggerqueue.isempty()) {\n                        // è°ç¨xxljobexecutor.removejobthread() å»éæ¯çº¿ç¨\n                        xxljobexecutor.removejobthread(jobid, "å¤ªä¹ä¸æ§è¡ï¼çº¿ç¨éæ¯äº");\n                    }\n                } else {\n                    // è°åº¦åæ°ä¸ä¸ºç©ºï¼å°runningæ¹ä¸ºtrue, ç©ºè½¬æ¬¡æ°æ¹ä¸º0\n                    running = true;\n                    idletimes = 0;\n                    triggerlogidset.remove(triggerparam.getlogid());\n                    string logfilename = xxljobfileappender.makelogfilename(new date(triggerparam.getlogdatetime()), triggerparam.getlogid());\n                    xxljobcontext xxljobcontext = new xxljobcontext(\n                            triggerparam.getjobid(),\n                            triggerparam.getexecutorparams(),\n                            logfilename,\n                            triggerparam.getbroadcastindex(),\n                            triggerparam.getbroadcasttotal()\n                    );\n                    xxljobcontext.setxxljobcontext(xxljobcontext);\n                    // è®°å½æ¥å¿ï¼å¼å§æ§è¡\n                    xxljobhelper.log("<br>----------- xxl-job job execute start -----------<br>----------- param:" + xxljobcontext.getjobparam());\n                    // æ§è¡å®æ¶ä»»å¡ï¼æ ¹æ®æ¯å¦è®¾ç½®è¶æ¶æ¶é´æ¥æ§è¡ã\n                    // å¦ææ²¡æè®¾ç½®è¶æ¶æ¶é´å°±ç´æ¥æ§è¡ã å¦æè®¾ç½®äºè¶æ¶æ¶é´å°±å¼å¯å­çº¿ç¨ï¼ä½¿ç¨ futuretask æ§è¡ã\n                    doexecute(triggerparam, xxljobcontext);\n\n                    // å¤æ­æ§è¡ç»æ\n                    if (xxljobcontext.getxxljobcontext().gethandlecode() <= 0) {\n                        xxljobhelper.handlefail("job handle result lost.");\n                    } else {\n                        // å¦ææ§è¡ç»æå¤§äº0ï¼ä¸ç®¡æåè¿æ¯å¤±è´¥å°±ç´æ¥è®°å½æ¶æ¯ï¼ç­åè°çº¿ç¨å»åè°ãå¦ææ§è¡æåäºhandlemsgä¸ºç©º\n                        string temphandlemsg = xxljobcontext.getxxljobcontext().gethandlemsg();\n                        temphandlemsg = (temphandlemsg != null && temphandlemsg.length() > 50000) ? temphandlemsg.substring(0, 50000).concat("...") : temphandlemsg;\n                        xxljobcontext.getxxljobcontext().sethandlemsg(temphandlemsg);\n                    }\n                    // åè°çæ§è¡ç»æå±ä¸ç®¡ï¼ç°å¨çæ§è¡ç»æåè®°å½æ¥å¿\n                    xxljobhelper.log("<br>------------ xxl-job job execute end(finish)-------------<br>------------- result: handlecode=" +\n                            xxljobcontext.getxxljobcontext().gethandlecode() +\n                            ", handlemsg = " +\n                            xxljobcontext.getxxljobcontext().gethandlemsg()\n                    );\n                }\n            } catch (exception e) {\n                if (tostop) {\n                    // å¦æçº¿ç¨åæ­¢äºï¼è®°å½åæ­¢åå ãå¼å¸¸\n                    xxljobhelper.log("<br>----------- jobthread tostop, stopreason:" + stopreason);\n                    stringwriter stringwriter = new stringwriter();\n                    e.printstacktrace(new printwriter(stringwriter));\n                    string errormessage = stringwriter.tostring();\n                    // å°xxljobcontextä¸­ä»»å¡çæ§è¡ç¶ææ¹ä¸ºå¤±è´¥\n                    xxljobhelper.handlefail(errormessage);\n                    xxljobhelper.log("<br>----------- jobthread exception:" + errormessage +\n                            "<br>----------- xxl-job job execute end(error)");\n                }\n            } finally {\n                // å¨finallyä¸­æ§è¡å°æ¥å¿åè°ç»è°åº¦ä¸­å¿çæä½\n                if (triggerparam != null) {\n                    // å¦æçº¿ç¨æ²¡æåæ­¢ï¼ä¸ç®¡ä»»å¡æ§è¡æåè¿æ¯å¤±è´¥ï¼åè°ç»è°åº¦ä¸­å¿å³å¯ã\n                    // å¦æçº¿ç¨è¢«ç»æ­¢äºï¼å°stopreasonåéç»è°åº¦ä¸­å¿\n                    if (!tostop) {\n                        triggercallbackthread.pushcallback(new handlercallbackparam(\n                                triggerparam.getlogid(),\n                                triggerparam.getlogdatetime(),\n                                xxljobcontext.getxxljobcontext().gethandlecode(),\n                                xxljobcontext.getxxljobcontext().gethandlemsg()\n                        ));\n                    } else {\n                        triggercallbackthread.pushcallback(new handlercallbackparam(\n                                triggerparam.getlogid(),\n                                triggerparam.getlogdatetime(),\n                                xxljobcontext.handle_code_fail,\n                                stopreason + "[job running, killed]"\n                        ));\n                    }\n                }\n            }\n\n        }\n\n        // éåºwhileå¾ªç¯ï¼æåå°éåä¸­æ²¡æ¥å¾åæ§è¡çæ°æ®æ¿åºæ¥åè°åå»ï¼åè¯è°åº¦ä¸­å¿è¿äºæ°æ®æ²¡ææ§è¡\n        while (triggerqueue != null && !triggerqueue.isempty()) {\n            triggerparam triggerparam = triggerqueue.poll();\n            if (triggerparam == null) {\n                continue;\n            }\n            triggercallbackthread.pushcallback(new handlercallbackparam(\n                    triggerparam.getlogid(),\n                    triggerparam.getlogdatetime(),\n                    xxljobcontext.handle_code_fail,\n                    stopreason + " [job not executed, in the job queue, killed.]"\n            ));\n        }\n        // æ§è¡éæ¯æ¹æ³\n        rundestroymethod();\n    }\n\n    private void runinitmethod() {\n        try {\n            handler.init();\n        } catch (exception e) {\n            logger.error(e.getmessage(), e);\n        }\n    }\n\n    private void rundestroymethod() {\n        try {\n            handler.destroy();\n        } catch (exception e) {\n            logger.error(e.getmessage(), e);\n        }\n    }\n\n    /**\n     * æ§è¡å®æ¶ä»»å¡ï¼æ ¹æ®æ¯å¦è®¾ç½®è¶æ¶æ¶é´æ¥æ§è¡ã\n     * å¦æè®¾ç½®äºè¶æ¶æ¶é´å°±å¼å¯å­çº¿ç¨ï¼ä½¿ç¨ futuretask æ§è¡ã\n     * å¦ææ²¡æè®¾ç½®è¶æ¶æ¶é´å°±ç´æ¥æ§è¡\n     *\n     * @param triggerparam\n     * @param xxljobcontext\n     */\n    private void doexecute(triggerparam triggerparam, xxljobcontext xxljobcontext) throws exception {\n        // æ²¡æè®¾ç½®è¶æ¶æ¶é´ï¼ç´æ¥æ§è¡ï¼è®¾ç½®äºè¶æ¶æ¶é´ï¼å¼å¯å­çº¿ç¨æ§è¡ï¼æ­¤çº¿ç¨çç£å­çº¿ç¨æ§è¡\n        if (triggerparam.getexecutortimeout() == 0) {\n            try {\n                handler.execute();\n            } catch (exception e) {\n                xxljobhelper.log("<br>-------------- xxl-job job execute timeout");\n                xxljobhelper.log(e);\n                xxljobhelper.handlefail("job execute fail, exception message: " + e.getmessage());\n            }\n        } else {\n            thread futurethread = null;\n            try {\n                futuretask<boolean> futuretask = new futuretask<>(new callable<boolean>() {\n                    @override\n                    public boolean call() throws exception {\n                        xxljobcontext.setxxljobcontext(xxljobcontext);\n                        handler.execute();\n                        return true;\n                    }\n                });\n                // åå»ºå¹¶å¯å¨çº¿ç¨ï¼getç»æï¼å¦ææå®æ¶é´getä¸å°ï¼è¯´æè¶æ¶\n                futurethread = new thread(futuretask);\n                futurethread.start();\n                boolean tempresult = futuretask.get(triggerparam.getexecutortimeout(), timeunit.seconds);\n            } catch (timeoutexception e) {\n                xxljobhelper.log("<br>-------------- xxl-job job execute timeout");\n                xxljobhelper.log(e);\n                // å°è¶æ¶è®¾ç½®å° xxljobcontext ä¸­\n                xxljobhelper.handletimeout("job execute timeout");\n            } finally {\n                futurethread.interrupt();\n            }\n        }\n    }\n\n    public void tostop(string stopreason) {\n        tostop = true;\n        this.stopreason = stopreason;\n    }\n\n\n    public ijobhandler gethandler() {\n        return handler;\n    }\n\n}\n\n\n\n# 7. æ§è¡å¨å¯¹ jobthread çç®¡ç\n\njobthread å®æle ï¼ç°å¨æ¥æ³æ³æä¹å° triggerparam æ¾å¥é»å¡éåå§ï¼jobthread æä¾äº api ï¼pushtriggerqueue.\n\næä¹è°åº¦å®å¢ï¼å¦ä½ç¥éè´è´£æä¸ªä»»å¡ççº¿ç¨æ¯å¦å­å¨å¢ï¼å¦ä½å°çº¿ç¨éæ¯å¢ï¼è°æ¥è°ç¨ tostop() æ¹æ³å¢ï¼ï¼\n\nè¿äºé½æ¯é®é¢å¾è§£å³çé®é¢ãä¸é¢ä»ç» methodjobhandler æ¶å° methodjobhandler æ¶éèµ·æ¥æ¾å¥ map ä¸­ï¼é£ä¹ jobthread ä¹å¯ä»¥æ¶éèµ·æ¥è¿è¡ç»ä¸çç®¡çåï¼ç¨ jobid-jobthread è¿ç§ key-value å½¢å¼å°çº¿ç¨å°è£è¿ map ä¸­ï¼è°åº¦ä¸­å¿ä¼ å¥ triggerparam åï¼éè¿ jobid æ¾å°è´è´£è¯¥ä»»å¡ççº¿ç¨ï¼è°ç¨ pushtriggerqueue å° triggerparam æ¾å¥éåç­å¾æ§è¡ãé£ä¹ç±è°æ¥ç®¡çè¿ä¸ªè£ jobthread ç map å¢ï¼è¯å®æ¯æ§è¡å¨ï¼æä»¥å°è¿ä¸ª map æ¾å¥ xxljobexecutor ä¸­ã\n\n// å­æ¾ jobthreadçº¿ç¨ çmap\nprivate static concurrenthashmap<integer, jobthread> jobthreadrepository = new concurrenthashmap<>();\n\n// æ ¹æ®ä»»å¡idè·åå¯¹åºçº¿ç¨\npublic static jobthread loadjobthread(int jobid) {\n    return jobthreadrepository.get(jobid);\n}\n\n// æ³¨åæ°ä»»å¡\npublic static jobthread registjobthread(int jobid, ijobhandler handler, string removeoldreason) {\n    jobthread newjobthread = new jobthread(jobid, handler);\n    newjobthread.start();\n    jobthread oldjobthread = jobthreadrepository.put(jobid, newjobthread);\n    // å¦æä»»å¡ä¹åæ³¨åè¿ï¼å¯è½æ¯webç«¯æ´æ¹äºä»»å¡ãå°æ§çº¿ç¨åæ­¢ã\n    if (oldjobthread != null) {\n        oldjobthread.tostop(removeoldreason);\n        oldjobthread.interrupt();\n    }\n    return newjobthread;\n}\n\n// éæ¯çº¿ç¨\npublic static jobthread removejobthread(int jobid, string removereason) {\n    jobthread oldjobthread = jobthreadrepository.remove(jobid);\n    if (oldjobthread != null) {\n        oldjobthread.tostop(removereason);\n        oldjobthread.interrupt();\n    }\n    return oldjobthread;\n}\n\n\nè¯´ä¸ä¸ä¸ºå¥åæ­¢çº¿ç¨çæ¶åä¸ä»è¦è°ç¨ tostop æ¹æ³ï¼è¿è¦è°ç¨ interrupt æ¹æ³å¢ï¼\n\n 1. çº¿ç¨ä¸­ä½¿ç¨ while(!tostop){} çå½¢å¼è¿è¡æ éå¾ªç¯ï¼æä»¥æ³è¦åæ­¢è¿ä¸ªçº¿ç¨è¯å®è¦è®©çº¿ç¨éåºå¾ªç¯ï¼è°ç¨ tostop æ¹æ³ä¼å° tostop = true\n 2. å¨ jobthread.run() æ¹æ³ä¸­ï¼æ é»å¡çä»éåä¸­åå¼ çæ­¥éª¤å­å¨ï¼å¦ææ³è¦è®©çº¿ç¨åæ­¢å·¥ä½ï¼è¯å®è¦è®©çº¿ç¨åéåºé»å¡ç¶æåéåºå¾ªç¯ï¼æä»¥è°ç¨ interrupt çº¯ç²¹æ¯ä¸è®©çº¿ç¨é»å¡è¿ä¹é¿æ¶é´ã\n\nè¡¥å¨äºå¯¹äº jobthread çç®¡çï¼ç°å¨çæ§è¡å¨æ§è¡ä»»å¡çæµç¨å°±å¾æ¸æ°äºï¼\n\n 1. æ§è¡å¨æ¥æ¶å°æ¥èªè°åº¦ä¸­å¿ç triggerparam\n\n 2. show me codeï¼\n    \n    jobthread thread = xxljobexecutor.loadjobthread(triggerpara.getjobid());\n    if (thread == null) {\n        thread = xxljobexecutor.registjobthread(è¿éåä¸è¯´);\n    }\n    thread.pushtriggerqueue(triggerparam);\n    \n\n 3. è°åº¦åæ°æ¾å¥éååå°±ä¼ç­å¾ååºæ§è¡ãè¿ä¸ªæ­¥éª¤å¯ä»¥åè jobthread çä»£ç \n\næåï¼æ¥çç thread = xxljobexecutor.registjobthread(è¿éåä¸è¯´) è¿ä¸æ­¥ï¼æ³è¦æ³¨åçº¿ç¨ï¼å°±å¿é¡»æ¿å° methodjobhandlerï¼æä¹æ¿å°ï¼triggerparam ä¸­æ ä»»å¡åï¼æä»¬ä¹åå°ææ ä»»å¡å-jobhandler çé®å¼å¯¹å°è£å° xxljobexecutor çä¸ä¸ª map ä¸­äºï¼æä»¥å¯ä»¥åéè¿é£ä¸ª map è·å methodjobhandler åè¿è¡æ°å»ºçº¿ç¨ã\n\n\n# 7. æ»ç»\n\næ¾ä¸é¢æ¶åå°çå¨é¨ä»£ç ï¼\n\n@configuration\npublic class xxljobspringexecutor extends xxljobexecutor implements applicationcontextaware, smartinitializingsingleton, disposablebean {\n    private static logger logger = loggerfactory.getlogger(xxljobspringexecutor.class);\n\n    private static applicationcontext applicationcontext;\n\n    @override\n    public void setapplicationcontext(applicationcontext applicationcontext) throws beansexception {\n        xxljobspringexecutor.applicationcontext = applicationcontext;\n    }\n\n    @override\n    public void aftersingletonsinstantiated() {\n        try {\n            initjobhandlermethodrepository(applicationcontext);\n            super.start();\n        } catch (exception e) {\n            logger.error(e.getmessage());\n        }\n    }\n\n    @override\n    public void destroy() throws exception {\n        super.stop();\n    }\n\n    private void initjobhandlermethodrepository(applicationcontext applicationcontext) throws nosuchmethodexception {\n        if (applicationcontext == null) return;\n        string[] beandefinitionnames = applicationcontext.getbeannamesfortype(object.class, false, true);\n        for (string beandefinitionname : beandefinitionnames) {\n            object bean = applicationcontext.getbean(beandefinitionname);\n            map<method, xxljob> annotatedmethods = null;\n            try {\n                annotatedmethods = methodintrospector.selectmethods(bean.getclass(),\n                        new methodintrospector.metadatalookup<xxljob>() {\n                            @override\n                            public xxljob inspect(method method) {\n                                return annotatedelementutils.findmergedannotation(method, xxljob.class);\n                            }\n                        }\n                );\n\n            } catch (exception e) {\n                // è®°å½æ¥å¿ï¼ä»£ç å¤ªé¿å°±ä¸æ¾äº\n            }\n            if (collectionutil.isempty(annotatedmethods)) {\n                continue;\n            }\n            // å°å®æ¶ä»»å¡æ³¨åä¸ºjobhandler\n            for (map.entry<method, xxljob> methodxxljobentry : annotatedmethods.entryset()) {\n                method method = methodxxljobentry.getkey();\n                xxljob value = methodxxljobentry.getvalue();\n                registjobhandler(value, bean, method);\n            }\n\n        }\n\n    }\n\n    public static applicationcontext getapplicationcontext() {\n        return applicationcontext;\n    }\n}\n\n\npublic class xxljobexecutor {\n    private static final logger logger = loggerfactory.getlogger(xxljobexecutor.class);\n        // ---------------------- job handler repository ----------------------\n    private static concurrentmap<string, ijobhandler> jobhandlerrepository = new concurrenthashmap<string, ijobhandler>();\n    public static ijobhandler loadjobhandler(string name){\n        return jobhandlerrepository.get(name);\n    }\n    public static ijobhandler registjobhandler(string name, ijobhandler jobhandler){\n        return jobhandlerrepository.put(name, jobhandler);\n    }\n    protected void registjobhandler(xxljob xxljob, object bean, method executemethod){\n        if (xxljob == null) {\n            return;\n        }\n\n        string name = xxljob.value();\n        \n        class<?> clazz = bean.getclass();\n        string methodname = executemethod.getname();\n        if (name.trim().length() == 0) {\n            throw new runtimeexception("xxl-job method-jobhandler name invalid, for[" + clazz + "#" + methodname + "] .");\n        }\n        if (loadjobhandler(name) != null) {\n            throw new runtimeexception("xxl-job jobhandler[" + name + "] naming conflicts.");\n        }\n\n        executemethod.setaccessible(true);\n\n        // init and destroy\n        method initmethod = null;\n        method destroymethod = null;\n\n        if (xxljob.init().trim().length() > 0) {\n            try {\n                initmethod = clazz.getdeclaredmethod(xxljob.init());\n                initmethod.setaccessible(true);\n            } catch (nosuchmethodexception e) {\n                throw new runtimeexception("xxl-job method-jobhandler initmethod invalid, for[" + clazz + "#" + methodname + "] .");\n            }\n        }\n        if (xxljob.destroy().trim().length() > 0) {\n            try {\n                destroymethod = clazz.getdeclaredmethod(xxljob.destroy());\n                destroymethod.setaccessible(true);\n            } catch (nosuchmethodexception e) {\n                throw new runtimeexception("xxl-job method-jobhandler destroymethod invalid, for[" + clazz + "#" + methodname + "] .");\n            }\n        }\n\n        // registry jobhandler\n        registjobhandler(name, new methodjobhandler(bean, executemethod, initmethod, destroymethod));\n\n    }\n\n\n    // ---------------------- job thread repository ----------------------\n    private static concurrentmap<integer, jobthread> jobthreadrepository = new concurrenthashmap<integer, jobthread>();\n    public static jobthread registjobthread(int jobid, ijobhandler handler, string removeoldreason){\n        jobthread newjobthread = new jobthread(jobid, handler);\n        newjobthread.start();\n        \n\n        jobthread oldjobthread = jobthreadrepository.put(jobid, newjobthread);\t\n        if (oldjobthread != null) {\n            oldjobthread.tostop(removeoldreason);\n            oldjobthread.interrupt();\n        }\n\n        return newjobthread;\n    }\n\n    public static jobthread removejobthread(int jobid, string removeoldreason){\n        jobthread oldjobthread = jobthreadrepository.remove(jobid);\n        if (oldjobthread != null) {\n            oldjobthread.tostop(removeoldreason);\n            oldjobthread.interrupt();\n\n            return oldjobthread;\n        }\n        return null;\n    }\n\n    public static jobthread loadjobthread(int jobid){\n        return jobthreadrepository.get(jobid);\n    }\n}\n\n\npublic class triggerparam implements serializable {\n    private static final long serialversionuid = 42l;\n\n    /**\n     * ä»»å¡id\n     */\n    private int jobid;\n\n    /**\n     * å®æ¶ä»»å¡åå­\n     */\n    private string executorhandler;\n\n    /**\n     * å®æ¶ä»»å¡çåæ°\n     */\n    private string executorparams;\n\n    /**\n     * å®æ¶ä»»å¡çé»å¡ç­ç¥                <br></br>\n     * å½ä¸ä¸ªå®æ¶ä»»å¡æ³è¦æ§è¡ï¼ä½æ¯è´è´£è¯¥ä»»å¡ççº¿ç¨æ­£å¨å·¥ä½æ¶ä¼ä½¿ç¨è¿ä¸ªé»å¡ç­ç¥å¤æ­\n     */\n    private string executorblockstrategy;\n\n    /**\n     * ä»»å¡çè¿ææ¶é´          <br></br>\n     * å¦æå¼å¯äºè¿ææ¶é´ï¼æ§è¡ä»»å¡æ¶ä¼é¢å¤åå»ºä¸ä¸ªæ°çº¿ç¨æ§è¡ä»»å¡ï¼\n     * ä¹åççº¿ç¨è´è´£çç£æ°çº¿ç¨æ§è¡ä»»å¡æ¶é´æ¯å¦è¶æ¶\n     */\n    private int executortimeout;\n\n    /**\n     * è¯¥ä»»å¡å¯¹åºçæ¥å¿çid\n     */\n    private long logid;\n\n    /**\n     * ææ¥å¿çæ¶é´\n     */\n    private long logdatetime;\n\n    /**\n     * è¿è¡æ¨¡å¼\n     */\n    private string gluetype;\n\n    /**\n     * ä»£ç ææ¬\n     */\n    private string gluesource;\n\n    /**\n     * ä»£ç ææ¬æ´æ°æ¶é´\n     */\n    private long glueupdatetime;\n\n    /**\n     * åçç´¢å¼\n     */\n    private int broadcastindex;\n\n    /**\n     * åçæ»æ°\n     */\n    private int broadcasttotal;\n}\n\n\npackage com.xxl.job.core.thread;\n\nimport com.xxl.job.core.biz.model.handlecallbackparam;\nimport com.xxl.job.core.biz.model.returnt;\nimport com.xxl.job.core.biz.model.triggerparam;\nimport com.xxl.job.core.context.xxljobcontext;\nimport com.xxl.job.core.context.xxljobhelper;\nimport com.xxl.job.core.executor.xxljobexecutor;\nimport com.xxl.job.core.handler.ijobhandler;\nimport com.xxl.job.core.log.xxljobfileappender;\nimport org.slf4j.logger;\nimport org.slf4j.loggerfactory;\n\nimport java.io.printwriter;\nimport java.io.stringwriter;\nimport java.util.collections;\nimport java.util.date;\nimport java.util.hashset;\nimport java.util.set;\nimport java.util.concurrent.*;\n\n\n/**\n * handler thread\n * @author xuxueli 2016-1-16 19:52:47\n */\npublic class jobthread extends thread{\n\tprivate static logger logger = loggerfactory.getlogger(jobthread.class);\n\n\tprivate int jobid;\n\tprivate ijobhandler handler;\n\tprivate linkedblockingqueue<triggerparam> triggerqueue;\n\tprivate set<long> triggerlogidset;\t\t\n\n\tprivate volatile boolean tostop = false;\n\tprivate string stopreason;\n\n    private boolean running = false;    \n\tprivate int idletimes = 0;\t\t\t\n\n\n\tpublic jobthread(int jobid, ijobhandler handler) {\n\t\tthis.jobid = jobid;\n\t\tthis.handler = handler;\n\t\tthis.triggerqueue = new linkedblockingqueue<triggerparam>();\n\t\tthis.triggerlogidset = collections.synchronizedset(new hashset<long>());\n\n\t\t// assign job thread name\n\t\tthis.setname("xxl-job, jobthread-"+jobid+"-"+system.currenttimemillis());\n\t}\n\tpublic ijobhandler gethandler() {\n\t\treturn handler;\n\t}\n\n    /**\n     * new trigger to queue\n     *\n     * @param triggerparam\n     * @return\n     */\n\tpublic returnt<string> pushtriggerqueue(triggerparam triggerparam) {\n\t\t// avoid repeat\n\t\tif (triggerlogidset.contains(triggerparam.getlogid())) {\n\t\t\tlogger.info(">>>>>>>>>>> repeate trigger job, logid:{}", triggerparam.getlogid());\n\t\t\treturn new returnt<string>(returnt.fail_code, "repeate trigger job, logid:" + triggerparam.getlogid());\n\t\t}\n\n\t\ttriggerlogidset.add(triggerparam.getlogid());\n\t\ttriggerqueue.add(triggerparam);\n        return returnt.success;\n\t}\n\n    /**\n     * kill job thread\n     *\n     * @param stopreason\n     */\n\tpublic void tostop(string stopreason) {\n\t\t/**\n\t\t * thread.interruptåªæ¯æç»æ­¢çº¿ç¨çé»å¡ç¶æ(waitãjoinãsleep)ï¼\n\t\t * å¨é»å¡åºæåºinterruptedexceptionå¼å¸¸,ä½æ¯å¹¶ä¸ä¼ç»æ­¢è¿è¡ççº¿ç¨æ¬èº«ï¼\n\t\t * æä»¥éè¦æ³¨æï¼æ­¤å¤å½»åºéæ¯æ¬çº¿ç¨ï¼éè¦éè¿å±äº«åéæ¹å¼ï¼\n\t\t */\n\t\tthis.tostop = true;\n\t\tthis.stopreason = stopreason;\n\t}\n\n    /**\n     * is running job\n     * @return\n     */\n    public boolean isrunningorhasqueue() {\n        return running || triggerqueue.size()>0;\n    }\n\n    @override\n\tpublic void run() {\n\n    \t// init\n    \ttry {\n\t\t\thandler.init();\n\t\t} catch (throwable e) {\n    \t\tlogger.error(e.getmessage(), e);\n\t\t}\n\n\t\t// execute\n\t\twhile(!tostop){\n\t\t\trunning = false;\n\t\t\tidletimes++;\n\n            triggerparam triggerparam = null;\n            try {\n\t\t\t\t// to check tostop signal, we need cycle, so wo cannot use queue.take(), instand of poll(timeout)\n\t\t\t\ttriggerparam = triggerqueue.poll(3l, timeunit.seconds);\n\t\t\t\tif (triggerparam!=null) {\n\t\t\t\t\trunning = true;\n\t\t\t\t\tidletimes = 0;\n\t\t\t\t\ttriggerlogidset.remove(triggerparam.getlogid());\n\n\t\t\t\t\t// log filename, like "logpath/yyyy-mm-dd/9999.log"\n\t\t\t\t\tstring logfilename = xxljobfileappender.makelogfilename(new date(triggerparam.getlogdatetime()), triggerparam.getlogid());\n\t\t\t\t\txxljobcontext xxljobcontext = new xxljobcontext(\n\t\t\t\t\t\t\ttriggerparam.getjobid(),\n\t\t\t\t\t\t\ttriggerparam.getexecutorparams(),\n\t\t\t\t\t\t\tlogfilename,\n\t\t\t\t\t\t\ttriggerparam.getbroadcastindex(),\n\t\t\t\t\t\t\ttriggerparam.getbroadcasttotal());\n\n\t\t\t\t\t// init job context\n\t\t\t\t\txxljobcontext.setxxljobcontext(xxljobcontext);\n\n\t\t\t\t\t// execute\n\t\t\t\t\txxljobhelper.log("<br>----------- xxl-job job execute start -----------<br>----------- param:" + xxljobcontext.getjobparam());\n\n\t\t\t\t\tif (triggerparam.getexecutortimeout() > 0) {\n\t\t\t\t\t\t// limit timeout\n\t\t\t\t\t\tthread futurethread = null;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tfuturetask<boolean> futuretask = new futuretask<boolean>(new callable<boolean>() {\n\t\t\t\t\t\t\t\t@override\n\t\t\t\t\t\t\t\tpublic boolean call() throws exception {\n\n\t\t\t\t\t\t\t\t\t// init job context\n\t\t\t\t\t\t\t\t\txxljobcontext.setxxljobcontext(xxljobcontext);\n\n\t\t\t\t\t\t\t\t\thandler.execute();\n\t\t\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfuturethread = new thread(futuretask);\n\t\t\t\t\t\t\tfuturethread.start();\n\n\t\t\t\t\t\t\tboolean tempresult = futuretask.get(triggerparam.getexecutortimeout(), timeunit.seconds);\n\t\t\t\t\t\t} catch (timeoutexception e) {\n\n\t\t\t\t\t\t\txxljobhelper.log("<br>----------- xxl-job job execute timeout");\n\t\t\t\t\t\t\txxljobhelper.log(e);\n\n\t\t\t\t\t\t\t// handle result\n\t\t\t\t\t\t\txxljobhelper.handletimeout("job execute timeout ");\n\t\t\t\t\t\t} finally {\n\t\t\t\t\t\t\tfuturethread.interrupt();\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// just execute\n\t\t\t\t\t\thandler.execute();\n\t\t\t\t\t}\n\n\t\t\t\t\t// valid execute handle data\n\t\t\t\t\tif (xxljobcontext.getxxljobcontext().gethandlecode() <= 0) {\n\t\t\t\t\t\txxljobhelper.handlefail("job handle result lost.");\n\t\t\t\t\t} else {\n\t\t\t\t\t\tstring temphandlemsg = xxljobcontext.getxxljobcontext().gethandlemsg();\n\t\t\t\t\t\ttemphandlemsg = (temphandlemsg!=null&&temphandlemsg.length()>50000)\n\t\t\t\t\t\t\t\t?temphandlemsg.substring(0, 50000).concat("...")\n\t\t\t\t\t\t\t\t:temphandlemsg;\n\t\t\t\t\t\txxljobcontext.getxxljobcontext().sethandlemsg(temphandlemsg);\n\t\t\t\t\t}\n\t\t\t\t\txxljobhelper.log("<br>----------- xxl-job job execute end(finish) -----------<br>----------- result: handlecode="\n\t\t\t\t\t\t\t+ xxljobcontext.getxxljobcontext().gethandlecode()\n\t\t\t\t\t\t\t+ ", handlemsg = "\n\t\t\t\t\t\t\t+ xxljobcontext.getxxljobcontext().gethandlemsg()\n\t\t\t\t\t);\n\n\t\t\t\t} else {\n\t\t\t\t\tif (idletimes > 30) {\n\t\t\t\t\t\tif(triggerqueue.size() == 0) {\t\n\t\t\t\t\t\t\txxljobexecutor.removejobthread(jobid, "excutor idel times over limit.");\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (throwable e) {\n\t\t\t\tif (tostop) {\n\t\t\t\t\txxljobhelper.log("<br>----------- jobthread tostop, stopreason:" + stopreason);\n\t\t\t\t}\n\n\t\t\t\t// handle result\n\t\t\t\tstringwriter stringwriter = new stringwriter();\n\t\t\t\te.printstacktrace(new printwriter(stringwriter));\n\t\t\t\tstring errormsg = stringwriter.tostring();\n\n\t\t\t\txxljobhelper.handlefail(errormsg);\n\n\t\t\t\txxljobhelper.log("<br>----------- jobthread exception:" + errormsg + "<br>----------- xxl-job job execute end(error) -----------");\n\t\t\t} finally {\n                if(triggerparam != null) {\n                    // callback handler info\n                    if (!tostop) {\n                        // commonm\n                        triggercallbackthread.pushcallback(new handlecallbackparam(\n                        \t\ttriggerparam.getlogid(),\n\t\t\t\t\t\t\t\ttriggerparam.getlogdatetime(),\n\t\t\t\t\t\t\t\txxljobcontext.getxxljobcontext().gethandlecode(),\n\t\t\t\t\t\t\t\txxljobcontext.getxxljobcontext().gethandlemsg() )\n\t\t\t\t\t\t);\n                    } else {\n                        // is killed\n                        triggercallbackthread.pushcallback(new handlecallbackparam(\n                        \t\ttriggerparam.getlogid(),\n\t\t\t\t\t\t\t\ttriggerparam.getlogdatetime(),\n\t\t\t\t\t\t\t\txxljobcontext.handle_code_fail,\n\t\t\t\t\t\t\t\tstopreason + " [job running, killed]" )\n\t\t\t\t\t\t);\n                    }\n                }\n            }\n        }\n\n\t\t// callback trigger request in queue\n\t\twhile(triggerqueue !=null && triggerqueue.size()>0){\n\t\t\ttriggerparam triggerparam = triggerqueue.poll();\n\t\t\tif (triggerparam!=null) {\n\t\t\t\t// is killed\n\t\t\t\ttriggercallbackthread.pushcallback(new handlecallbackparam(\n\t\t\t\t\t\ttriggerparam.getlogid(),\n\t\t\t\t\t\ttriggerparam.getlogdatetime(),\n\t\t\t\t\t\txxljobcontext.handle_code_fail,\n\t\t\t\t\t\tstopreason + " [job not executed, in the job queue, killed.]")\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// destroy\n\t\ttry {\n\t\t\thandler.destroy();\n\t\t} catch (throwable e) {\n\t\t\tlogger.error(e.getmessage(), e);\n\t\t}\n\n\t\t\n\t}\n}\n',charsets:{cjk:!0},lastUpdated:"2023/11/29, 16:01:58",lastUpdatedTimestamp:1701244918e3},{title:"Springäºå¡",frontmatter:{title:"Springäºå¡",date:"2023-11-02T21:11:42.000Z",permalink:"/pages/b4dd7e/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/5.Spring/100.Spring%E4%BA%8B%E5%8A%A1.html",relativePath:"02.æç« /91.æ¡æ¶/5.Spring/100.Springäºå¡.md",key:"v-40abcda6",path:"/pages/b4dd7e/",headers:[{level:2,title:"1. Spring å®ç°äºå¡çæ¹å¼",slug:"_1-spring-å®ç°äºå¡çæ¹å¼",normalizedTitle:"1. spring å®ç°äºå¡çæ¹å¼",charIndex:2},{level:3,title:"1.1 ç¼ç¨å¼äºå¡",slug:"_1-1-ç¼ç¨å¼äºå¡",normalizedTitle:"1.1 ç¼ç¨å¼äºå¡",charIndex:166},{level:3,title:"1.2 å£°æå¼äºå¡",slug:"_1-2-å£°æå¼äºå¡",normalizedTitle:"1.2 å£°æå¼äºå¡",charIndex:1054},{level:2,title:"2. Spring äºå¡ä¼ æ­è¡ä¸º",slug:"_2-spring-äºå¡ä¼ æ­è¡ä¸º",normalizedTitle:"2. spring äºå¡ä¼ æ­è¡ä¸º",charIndex:1291},{level:3,title:"2.1 REQUIREDï¼éè¦ï¼",slug:"_2-1-required-éè¦",normalizedTitle:"2.1 requiredï¼éè¦ï¼",charIndex:2189},{level:3,title:"2.2 REQUIRES_NEWï¼éè¦æ°çï¼",slug:"_2-2-requires-new-éè¦æ°ç",normalizedTitle:"2.2 requires_newï¼éè¦æ°çï¼",charIndex:2402},{level:3,title:"2.3 SUPPORTS ï¼æ¯æï¼",slug:"_2-3-supports-æ¯æ",normalizedTitle:"2.3 supports ï¼æ¯æï¼",charIndex:2546},{level:3,title:"2.4 NOT_SUPPORTEDï¼ä¸æ¯æï¼",slug:"_2-4-not-supported-ä¸æ¯æ",normalizedTitle:"2.4 not_supportedï¼ä¸æ¯æï¼",charIndex:2724},{level:3,title:"2.5 MANDATORY ï¼å¼ºå¶ï¼",slug:"_2-5-mandatory-å¼ºå¶",normalizedTitle:"2.5 mandatory ï¼å¼ºå¶ï¼",charIndex:2856},{level:3,title:"2.6 NEVERï¼ä»ä¸ï¼",slug:"_2-6-never-ä»ä¸",normalizedTitle:"2.6 neverï¼ä»ä¸ï¼",charIndex:3024},{level:3,title:"2.7 NESTEDï¼åµå¥çï¼",slug:"_2-7-nested-åµå¥ç",normalizedTitle:"2.7 nestedï¼åµå¥çï¼",charIndex:3188},{level:2,title:"3. Spring äºå¡çéç¦»çº§å«",slug:"_3-spring-äºå¡çéç¦»çº§å«",normalizedTitle:"3. spring äºå¡çéç¦»çº§å«",charIndex:3408}],headersStr:"1. Spring å®ç°äºå¡çæ¹å¼ 1.1 ç¼ç¨å¼äºå¡ 1.2 å£°æå¼äºå¡ 2. Spring äºå¡ä¼ æ­è¡ä¸º 2.1 REQUIREDï¼éè¦ï¼ 2.2 REQUIRES_NEWï¼éè¦æ°çï¼ 2.3 SUPPORTS ï¼æ¯æï¼ 2.4 NOT_SUPPORTEDï¼ä¸æ¯æï¼ 2.5 MANDATORY ï¼å¼ºå¶ï¼ 2.6 NEVERï¼ä»ä¸ï¼ 2.7 NESTEDï¼åµå¥çï¼ 3. Spring äºå¡çéç¦»çº§å«",content:"# 1. Spring å®ç°äºå¡çæ¹å¼\n\n 1. ç¼ç¨å¼äºå¡\n    \n    éè¿ TransactionTemplate æè TreasactionManager æå¨ç®¡çäºå¡ã\n\n 2. å£°æå¼äºå¡\n    \n    éè¿ @Transactional æ³¨è§£ æ XMLéç½®çå½¢å¼å£°æäºå¡ãå®éä¸æ¯éè¿AOPå®æã\n\n\n# 1.1 ç¼ç¨å¼äºå¡\n\néè¿ç¡¬ç¼ç çæ¹å¼ä½¿ç¨ Spring ä¸­æä¾çæ½è±¡äºå¡ API æ¥æ§å¶äºå¡ã\n\nSpring ä½¿ç¨æ¨¡æ¿æ¹æ³å¯¹å¶å°è£ä¸ºæä»¬æä¾äºäºå¡æ¨¡æ¿ç±» ï¼TranscationTemplate æ¹ä¾¿æä»¬ä½¿ç¨\n\n@Service\npublic class TransactionalService {\n    \n    @Autowired\n    private TransactionTemplate transactionTemplate;\n \n    public void performTransactionalOperation() {\n        transactionTemplate.execute(new TransactionCallback<Void>() {\n            public Void doInTransaction(TransactionStatus status) {\n                // å¨è¿éæ§è¡äºå¡æä½\n                userMapper.add(user);\n                userMapper.delete(user);\n                // å¯ä»¥è¿è¡æ°æ®åºæä½ãè°ç¨å¶ä»éè¦äºå¡æ¯æçæ¹æ³ç­\n \t\t\t\t\n                return null;\n            }\n        });\n    }\n}\n\n\nå¨ä¸è¿°ç¤ºä¾ä¸­ï¼æä»¬éè¿ execute() æ¹æ³æ¥æ§è¡äºå¡æä½ãTransactionCallback ç doInTransaction() æ¹æ³ä¸­çä»£ç å°å¨äºå¡çä¸ä¸æä¸­æ§è¡ã\n\nå¦æå¨ doInTransaction() ä¸­åçäºæªæè·çå¼å¸¸ï¼äºå¡å°ä¼è¢«åæ»ï¼å¹¶åå°äºå¡çèµ·ç¹ãå¦æ doInTransaction() æ­£å¸¸æ§è¡ï¼äºå¡å°è¢«æäº¤ã\n\nè¿ä¹æ¯ä¸ºå¥æä»¬å äº @Transactional æ³¨è§£åï¼æè·çå¼å¸¸ä¸è¦èªå·±è§£å³äºãå¦æèªå·±è§£å³äºï¼Springçäºå¡ç®¡çå°±ä¸çæäºã\n\n\n# 1.2 å£°æå¼äºå¡\n\nè¿ä¸ªæ´ç®åäºãå¨éè¦äºå¡çå°æ¹å ä¸ @Transactionalï¼å å¨æ¹æ³ä¸ï¼è¿ä¸ªæ¹æ³æäºå¡ï¼å å¨ç±»ä¸ï¼ç±»ä¸­çæææ¹æ³é½æäºå¡ã\n\n@Service\n@Transactional\npublic class UserService {\n    \n    public String addUser() {\n        \n    }\n    \n    public String deleteUser(){\n        \n    }\n}\n\n\n\n# 2. Spring äºå¡ä¼ æ­è¡ä¸º\n\näºå¡ä¼ æ­è¡ä¸ºæ¯ä¸ºäºè§£å³ä¸å¡å±æ¹æ³ä¹é´äºç¸è°ç¨çäºå¡é®é¢ã\n\nå½äºå¡è¢«å¦ä¸ä¸ªäºå¡æ¹æ³è°ç¨æ¶ï¼å¿é¡»æå®äºå¡è¯¥å¦ä½ä¼ æ­ãä¾å¦ï¼æ¹æ³å¯è½ç»§ç»­å¨ç°æäºå¡ä¸­è¿è¡ï¼ä¹å¯è½å¼å¯ä¸ä¸ªæ°äºå¡ï¼å¹¶å¨æ°äºå¡ä¸­è¿è¡ã\n\nä¸¾ä¸ªä¾å­ ï¼\n\n@Service\nClass A {\n    @Autowired\n    B b;\n    @Transactional(propagation = Propagation.xxx)\n    public void aMethod {\n\n        b.bMethod();\n    }\n}\n\n@Service\nClass B {\n    @Transactional(propagation = Propagation.xxx)\n    public void bMethod {\n       // do something\n    }\n}\n\n\næä»¬å¨ A ç±»ç aMethod() ä¸­è°ç¨äº B ç±»ç bMethod() æ¹æ³ï¼è¿ä¸ªæ¶åå°±æ¶åå°ä¸å¡å±æ¹æ³ä¹é´çäºç¸è°ç¨çäºå¡é®é¢ãå¦æ B ç±»ç bMethod() è¦åæ»ï¼å¦ä½éç½®äºå¡çä¼ æ­æºå¶æè½è®© aMethod() ä¹è·çåæ»å¢ï¼\n\nå¨ Spring ç TranscationDefinition ç±»ä¸­å®ä¹äºå ä¸ªå¸¸éï¼ä»£è¡¨ç Spring æ¯æçäºå¡ä¼ æ­æºå¶ã\n\npublic interface TransactionDefinition {\n    int PROPAGATION_REQUIRED = 0;\n    int PROPAGATION_SUPPORTS = 1;\n    int PROPAGATION_MANDATORY = 2;\n    int PROPAGATION_REQUIRES_NEW = 3;\n    int PROPAGATION_NOT_SUPPORTED = 4;\n    int PROPAGATION_NEVER = 5;\n    int PROPAGATION_NESTED = 6;\n    // å¶ä»å±æ§ä¸åå±ç¤º\n}\n\n\n\n# 2.1 REQUIREDï¼éè¦ï¼\n\né»è®¤çäºå¡ä¼ æ­è¡ä¸ºï¼ä¹æ¯æä»¬å¹³æ¶ä½¿ç¨æå¤çäºå¡ä¼ æ­è¡ä¸ºã\n\nå¦æå½åå­å¨äºå¡ï¼å å¥å½åäºå¡ãå¦æä¸å­å¨ï¼æ°å»ºäºå¡ã\n\n * å¦æ aMethod() æ²¡æå¼å¯äºå¡çè¯ï¼bMethodä¼å¼å¯ä¸ä¸ªæ°äºå¡ï¼æ§è¡å®å°±ç»æ\n * å¦æ aMethod() å¼å¯äºå¡äºï¼bMethod() å å¥è¯¥äºå¡ãä¸ç®¡æ¯ aMethod() åºç°å¼å¸¸ï¼è¿æ¯ bMethod() åºç°å¼å¸¸ï¼ä¸¤ä¸ªæ¹æ³é½åæ»ã\n\n\n# 2.2 REQUIRES_NEWï¼éè¦æ°çï¼\n\nåå»ºä¸ä¸ªæ°äºå¡ï¼å¦æå½åå­å¨äºå¡ï¼åæå½åäºå¡æèµ·ã\n\nä¹å°±æ¯è¯´ä¸ç®¡å¤é¨æ¹æ³æ¯å¦å¼å¯äºå¡ï¼ä½¿ç¨è¿ä¸ªä¼ æ­æºå¶çæ¹æ³é½ä¼å¼å¯ä¸ä¸ªæ°äºå¡ãaMethod() å bMethod() è¿ä¿©æ¹æ³çæ§è¡å°±æ²¡å¥å³ç³»äºï¼åèªä¸å½±ååèªçæ§è¡æåµã\n\n\n# 2.3 SUPPORTS ï¼æ¯æï¼\n\nå¦æå½åå­å¨äºå¡ï¼åå å¥å½åäºå¡ï¼å¦æå½åæ²¡æäºå¡ï¼æä¹ä¸ç¨äºå¡äºã\n\nå¦æ aMethod() ä¸­æäºå¡ï¼å bMethod() å å¥å° aMethod() ä¸­ï¼å¦æ aMethod() åéï¼bMethod() è·çåéã\n\nå¦æ aMethod() ä¸­æ²¡æäºå¡ï¼bMethod() ä¹ä»¥æ äºå¡æ¹å¼è¿è¡ã\n\n\n# 2.4 NOT_SUPPORTEDï¼ä¸æ¯æï¼\n\nä»¥éäºå¡çæ¹æ³è¿è¡ï¼å¦æå½åå­å¨äºå¡ï¼æèµ·å½åäºå¡ã\n\nå¦æ aMethod() ä¸­æäºå¡ï¼åæèµ·å®ï¼bMethod() ä»¥éäºå¡æ¹æ³è¿è¡ã\n\nå¦æ aMethod() ä¸­æ²¡æäºå¡ï¼ä¸ç®¡ï¼ä»¥éäºå¡æ¹æ³è¿è¡ã\n\n\n# 2.5 MANDATORY ï¼å¼ºå¶ï¼\n\nå½åå­å¨äºå¡ï¼å å¥å½åäºå¡ï¼å½åæ²¡æäºå¡ï¼æåºå¼å¸¸ã\n\nå¦æ aMethod() ä¸­æäºå¡ï¼å bMethod() å å¥å° aMethod() ä¸­ï¼å¦æ aMethod() åéï¼bMethod() è·çåéã\n\nå¦æ aMethod() ä¸­æ²¡æäºå¡ï¼bMethod() ç´æ¥æåºå¼å¸¸ã\n\n\n# 2.6 NEVERï¼ä»ä¸ï¼\n\nå¦æå½åæ²¡æäºå¡ï¼å°±ä»¥éäºå¡æ¹æ³è¿è¡ï¼å¦ææï¼æåºå¼å¸¸\n\nè¿ä¸ªä¼ æ­è¡ä¸ºè· NOT_SUPPORT æç¹åï¼ä¸è¿è¿ä¸ªå¨æäºå¡çæåµä¸ä¼æåºå¼å¸¸ã\n\nå¦æ aMethod() æäºå¡ï¼bMethod() æåºå¼å¸¸ã\n\nå¦æ aMethod() æ²¡æäºå¡ï¼bMethod() ä»¥éäºå¡æ¹æ³è¿è¡ã\n\n\n# 2.7 NESTEDï¼åµå¥çï¼\n\nå¦æå½åå­å¨äºå¡ï¼å¼å¯ä¸ä¸ªå­äºå¡ï¼å¦æå½åæ²¡äºå¡ï¼å¼å¯ä¸ä¸ªæ°äºå¡ã\n\nä»ä¹æ¯å­äºå¡ï¼ç¶äºå¡åæ»å­äºå¡å¿é¡»åæ»ï¼å­äºå¡åæ»ç¶äºå¡ä¸å¿åæ»ã\n\nå¦æ aMethod() æäºå¡ï¼bMethod() å¼å¯ä¸ä¸ªå­äºå¡ãaMethod() åæ» bMethod() ä¹åæ»ï¼bMethod() åæ» aMethod() ä¸åæ»ã\n\nå¦æ aMethod() æ²¡æäºå¡ï¼bMethod() æ°å»ºä¸ä¸ªäºå¡è¿è¡ã\n\n\n# 3. Spring äºå¡çéç¦»çº§å«\n\n**éç¦»çº§å«ï¼**ä¸»è¦è§£å³å¤ä¸ªåæ¶è¿è¡ä¸è®¿é®æ°æ®åºæ°æ®ç¸åçäºå¡å¸¦æ¥çå¹¶åé®é¢ãå¨æ°æ®åºä¸­äºå¡çéç¦»æ§æ¯è¿æ ·å®ä¹çï¼æ°æ®åºç³»ç»å¿é¡»å·æéç¦»å¹¶åè¿è¡åä¸ªäºå¡çè½åï¼ä½¿ä»ä»¬ä¸ä¼äºç¸å½±åï¼é¿åäº§çå¹¶åé®é¢ã\n\nSpringçæ¥å£TransactionDefinitionä¸­å®ä¹äºè¡¨ç¤ºéç¦»çº§å«çå¸¸éï¼å½ç¶å¶å®ä¸»è¦è¿æ¯å¯¹åºæ°æ®åºçäºå¡éç¦»çº§å«ï¼\n\n 1. ISOLATION_DEFAULTï¼ä½¿ç¨åç«¯æ°æ®åºé»è®¤çéç¦»çå«ï¼MySQL é»è®¤å¯éå¤è¯»ï¼Oracle é»è®¤è¯»å·²æäº¤ã\n\n 2. ISOLATION_READ_UNCOMMITTEDï¼è¯»æªæäº¤\n\n 3. ISOLATION_READ_COMMITTEDï¼è¯»å·²æäº¤\n\n 4. ISOLATION_REPEATABLE_READï¼å¯éå¤è¯»\n\n 5. ISOLATION_SERIALIZABLEï¼ä¸²è¡å",normalizedContent:"# 1. spring å®ç°äºå¡çæ¹å¼\n\n 1. ç¼ç¨å¼äºå¡\n    \n    éè¿ transactiontemplate æè treasactionmanager æå¨ç®¡çäºå¡ã\n\n 2. å£°æå¼äºå¡\n    \n    éè¿ @transactional æ³¨è§£ æ xmléç½®çå½¢å¼å£°æäºå¡ãå®éä¸æ¯éè¿aopå®æã\n\n\n# 1.1 ç¼ç¨å¼äºå¡\n\néè¿ç¡¬ç¼ç çæ¹å¼ä½¿ç¨ spring ä¸­æä¾çæ½è±¡äºå¡ api æ¥æ§å¶äºå¡ã\n\nspring ä½¿ç¨æ¨¡æ¿æ¹æ³å¯¹å¶å°è£ä¸ºæä»¬æä¾äºäºå¡æ¨¡æ¿ç±» ï¼transcationtemplate æ¹ä¾¿æä»¬ä½¿ç¨\n\n@service\npublic class transactionalservice {\n    \n    @autowired\n    private transactiontemplate transactiontemplate;\n \n    public void performtransactionaloperation() {\n        transactiontemplate.execute(new transactioncallback<void>() {\n            public void dointransaction(transactionstatus status) {\n                // å¨è¿éæ§è¡äºå¡æä½\n                usermapper.add(user);\n                usermapper.delete(user);\n                // å¯ä»¥è¿è¡æ°æ®åºæä½ãè°ç¨å¶ä»éè¦äºå¡æ¯æçæ¹æ³ç­\n \t\t\t\t\n                return null;\n            }\n        });\n    }\n}\n\n\nå¨ä¸è¿°ç¤ºä¾ä¸­ï¼æä»¬éè¿ execute() æ¹æ³æ¥æ§è¡äºå¡æä½ãtransactioncallback ç dointransaction() æ¹æ³ä¸­çä»£ç å°å¨äºå¡çä¸ä¸æä¸­æ§è¡ã\n\nå¦æå¨ dointransaction() ä¸­åçäºæªæè·çå¼å¸¸ï¼äºå¡å°ä¼è¢«åæ»ï¼å¹¶åå°äºå¡çèµ·ç¹ãå¦æ dointransaction() æ­£å¸¸æ§è¡ï¼äºå¡å°è¢«æäº¤ã\n\nè¿ä¹æ¯ä¸ºå¥æä»¬å äº @transactional æ³¨è§£åï¼æè·çå¼å¸¸ä¸è¦èªå·±è§£å³äºãå¦æèªå·±è§£å³äºï¼springçäºå¡ç®¡çå°±ä¸çæäºã\n\n\n# 1.2 å£°æå¼äºå¡\n\nè¿ä¸ªæ´ç®åäºãå¨éè¦äºå¡çå°æ¹å ä¸ @transactionalï¼å å¨æ¹æ³ä¸ï¼è¿ä¸ªæ¹æ³æäºå¡ï¼å å¨ç±»ä¸ï¼ç±»ä¸­çæææ¹æ³é½æäºå¡ã\n\n@service\n@transactional\npublic class userservice {\n    \n    public string adduser() {\n        \n    }\n    \n    public string deleteuser(){\n        \n    }\n}\n\n\n\n# 2. spring äºå¡ä¼ æ­è¡ä¸º\n\näºå¡ä¼ æ­è¡ä¸ºæ¯ä¸ºäºè§£å³ä¸å¡å±æ¹æ³ä¹é´äºç¸è°ç¨çäºå¡é®é¢ã\n\nå½äºå¡è¢«å¦ä¸ä¸ªäºå¡æ¹æ³è°ç¨æ¶ï¼å¿é¡»æå®äºå¡è¯¥å¦ä½ä¼ æ­ãä¾å¦ï¼æ¹æ³å¯è½ç»§ç»­å¨ç°æäºå¡ä¸­è¿è¡ï¼ä¹å¯è½å¼å¯ä¸ä¸ªæ°äºå¡ï¼å¹¶å¨æ°äºå¡ä¸­è¿è¡ã\n\nä¸¾ä¸ªä¾å­ ï¼\n\n@service\nclass a {\n    @autowired\n    b b;\n    @transactional(propagation = propagation.xxx)\n    public void amethod {\n\n        b.bmethod();\n    }\n}\n\n@service\nclass b {\n    @transactional(propagation = propagation.xxx)\n    public void bmethod {\n       // do something\n    }\n}\n\n\næä»¬å¨ a ç±»ç amethod() ä¸­è°ç¨äº b ç±»ç bmethod() æ¹æ³ï¼è¿ä¸ªæ¶åå°±æ¶åå°ä¸å¡å±æ¹æ³ä¹é´çäºç¸è°ç¨çäºå¡é®é¢ãå¦æ b ç±»ç bmethod() è¦åæ»ï¼å¦ä½éç½®äºå¡çä¼ æ­æºå¶æè½è®© amethod() ä¹è·çåæ»å¢ï¼\n\nå¨ spring ç transcationdefinition ç±»ä¸­å®ä¹äºå ä¸ªå¸¸éï¼ä»£è¡¨ç spring æ¯æçäºå¡ä¼ æ­æºå¶ã\n\npublic interface transactiondefinition {\n    int propagation_required = 0;\n    int propagation_supports = 1;\n    int propagation_mandatory = 2;\n    int propagation_requires_new = 3;\n    int propagation_not_supported = 4;\n    int propagation_never = 5;\n    int propagation_nested = 6;\n    // å¶ä»å±æ§ä¸åå±ç¤º\n}\n\n\n\n# 2.1 requiredï¼éè¦ï¼\n\né»è®¤çäºå¡ä¼ æ­è¡ä¸ºï¼ä¹æ¯æä»¬å¹³æ¶ä½¿ç¨æå¤çäºå¡ä¼ æ­è¡ä¸ºã\n\nå¦æå½åå­å¨äºå¡ï¼å å¥å½åäºå¡ãå¦æä¸å­å¨ï¼æ°å»ºäºå¡ã\n\n * å¦æ amethod() æ²¡æå¼å¯äºå¡çè¯ï¼bmethodä¼å¼å¯ä¸ä¸ªæ°äºå¡ï¼æ§è¡å®å°±ç»æ\n * å¦æ amethod() å¼å¯äºå¡äºï¼bmethod() å å¥è¯¥äºå¡ãä¸ç®¡æ¯ amethod() åºç°å¼å¸¸ï¼è¿æ¯ bmethod() åºç°å¼å¸¸ï¼ä¸¤ä¸ªæ¹æ³é½åæ»ã\n\n\n# 2.2 requires_newï¼éè¦æ°çï¼\n\nåå»ºä¸ä¸ªæ°äºå¡ï¼å¦æå½åå­å¨äºå¡ï¼åæå½åäºå¡æèµ·ã\n\nä¹å°±æ¯è¯´ä¸ç®¡å¤é¨æ¹æ³æ¯å¦å¼å¯äºå¡ï¼ä½¿ç¨è¿ä¸ªä¼ æ­æºå¶çæ¹æ³é½ä¼å¼å¯ä¸ä¸ªæ°äºå¡ãamethod() å bmethod() è¿ä¿©æ¹æ³çæ§è¡å°±æ²¡å¥å³ç³»äºï¼åèªä¸å½±ååèªçæ§è¡æåµã\n\n\n# 2.3 supports ï¼æ¯æï¼\n\nå¦æå½åå­å¨äºå¡ï¼åå å¥å½åäºå¡ï¼å¦æå½åæ²¡æäºå¡ï¼æä¹ä¸ç¨äºå¡äºã\n\nå¦æ amethod() ä¸­æäºå¡ï¼å bmethod() å å¥å° amethod() ä¸­ï¼å¦æ amethod() åéï¼bmethod() è·çåéã\n\nå¦æ amethod() ä¸­æ²¡æäºå¡ï¼bmethod() ä¹ä»¥æ äºå¡æ¹å¼è¿è¡ã\n\n\n# 2.4 not_supportedï¼ä¸æ¯æï¼\n\nä»¥éäºå¡çæ¹æ³è¿è¡ï¼å¦æå½åå­å¨äºå¡ï¼æèµ·å½åäºå¡ã\n\nå¦æ amethod() ä¸­æäºå¡ï¼åæèµ·å®ï¼bmethod() ä»¥éäºå¡æ¹æ³è¿è¡ã\n\nå¦æ amethod() ä¸­æ²¡æäºå¡ï¼ä¸ç®¡ï¼ä»¥éäºå¡æ¹æ³è¿è¡ã\n\n\n# 2.5 mandatory ï¼å¼ºå¶ï¼\n\nå½åå­å¨äºå¡ï¼å å¥å½åäºå¡ï¼å½åæ²¡æäºå¡ï¼æåºå¼å¸¸ã\n\nå¦æ amethod() ä¸­æäºå¡ï¼å bmethod() å å¥å° amethod() ä¸­ï¼å¦æ amethod() åéï¼bmethod() è·çåéã\n\nå¦æ amethod() ä¸­æ²¡æäºå¡ï¼bmethod() ç´æ¥æåºå¼å¸¸ã\n\n\n# 2.6 neverï¼ä»ä¸ï¼\n\nå¦æå½åæ²¡æäºå¡ï¼å°±ä»¥éäºå¡æ¹æ³è¿è¡ï¼å¦ææï¼æåºå¼å¸¸\n\nè¿ä¸ªä¼ æ­è¡ä¸ºè· not_support æç¹åï¼ä¸è¿è¿ä¸ªå¨æäºå¡çæåµä¸ä¼æåºå¼å¸¸ã\n\nå¦æ amethod() æäºå¡ï¼bmethod() æåºå¼å¸¸ã\n\nå¦æ amethod() æ²¡æäºå¡ï¼bmethod() ä»¥éäºå¡æ¹æ³è¿è¡ã\n\n\n# 2.7 nestedï¼åµå¥çï¼\n\nå¦æå½åå­å¨äºå¡ï¼å¼å¯ä¸ä¸ªå­äºå¡ï¼å¦æå½åæ²¡äºå¡ï¼å¼å¯ä¸ä¸ªæ°äºå¡ã\n\nä»ä¹æ¯å­äºå¡ï¼ç¶äºå¡åæ»å­äºå¡å¿é¡»åæ»ï¼å­äºå¡åæ»ç¶äºå¡ä¸å¿åæ»ã\n\nå¦æ amethod() æäºå¡ï¼bmethod() å¼å¯ä¸ä¸ªå­äºå¡ãamethod() åæ» bmethod() ä¹åæ»ï¼bmethod() åæ» amethod() ä¸åæ»ã\n\nå¦æ amethod() æ²¡æäºå¡ï¼bmethod() æ°å»ºä¸ä¸ªäºå¡è¿è¡ã\n\n\n# 3. spring äºå¡çéç¦»çº§å«\n\n**éç¦»çº§å«ï¼**ä¸»è¦è§£å³å¤ä¸ªåæ¶è¿è¡ä¸è®¿é®æ°æ®åºæ°æ®ç¸åçäºå¡å¸¦æ¥çå¹¶åé®é¢ãå¨æ°æ®åºä¸­äºå¡çéç¦»æ§æ¯è¿æ ·å®ä¹çï¼æ°æ®åºç³»ç»å¿é¡»å·æéç¦»å¹¶åè¿è¡åä¸ªäºå¡çè½åï¼ä½¿ä»ä»¬ä¸ä¼äºç¸å½±åï¼é¿åäº§çå¹¶åé®é¢ã\n\nspringçæ¥å£transactiondefinitionä¸­å®ä¹äºè¡¨ç¤ºéç¦»çº§å«çå¸¸éï¼å½ç¶å¶å®ä¸»è¦è¿æ¯å¯¹åºæ°æ®åºçäºå¡éç¦»çº§å«ï¼\n\n 1. isolation_defaultï¼ä½¿ç¨åç«¯æ°æ®åºé»è®¤çéç¦»çå«ï¼mysql é»è®¤å¯éå¤è¯»ï¼oracle é»è®¤è¯»å·²æäº¤ã\n\n 2. isolation_read_uncommittedï¼è¯»æªæäº¤\n\n 3. isolation_read_committedï¼è¯»å·²æäº¤\n\n 4. isolation_repeatable_readï¼å¯éå¤è¯»\n\n 5. isolation_serializableï¼ä¸²è¡å",charsets:{cjk:!0},lastUpdated:"2023/11/03, 18:29:13",lastUpdatedTimestamp:1699007353e3},{title:"Sentinel",frontmatter:{title:"Sentinel",date:"2023-10-30T14:36:24.000Z",permalink:"/pages/a7a70b/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/20.%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/40.Sentinel.html",relativePath:"02.æç« /91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/40.Sentinel.md",key:"v-7512a88a",path:"/pages/a7a70b/",headers:[{level:2,title:"1. æå¡éªå´©æåº",slug:"_1-æå¡éªå´©æåº",normalizedTitle:"1. æå¡éªå´©æåº",charIndex:2},{level:2,title:"2. åºå¯¹æå¡éªå´©",slug:"_2-åºå¯¹æå¡éªå´©",normalizedTitle:"2. åºå¯¹æå¡éªå´©",charIndex:293},{level:3,title:"2.1 éæµ",slug:"_2-1-éæµ",normalizedTitle:"2.1 éæµ",charIndex:307},{level:3,title:"2.2 è±å£æ¨¡å¼",slug:"_2-2-è±å£æ¨¡å¼",normalizedTitle:"2.2 è±å£æ¨¡å¼",charIndex:421},{level:3,title:"2.3 æ­è·¯å¨",slug:"_2-3-æ­è·¯å¨",normalizedTitle:"2.3 æ­è·¯å¨",charIndex:601},{level:2,title:"3. Sentinel ç®ä»",slug:"_3-sentinel-ç®ä»",normalizedTitle:"3. sentinel ç®ä»",charIndex:760},{level:2,title:"4. Sentinel å®è£",slug:"_4-sentinel-å®è£",normalizedTitle:"4. sentinel å®è£",charIndex:961},{level:3,title:"4.1 å®è£éç½®",slug:"_4-1-å®è£éç½®",normalizedTitle:"4.1 å®è£éç½®",charIndex:980},{level:3,title:"4.2 å®æ¶çæ§",slug:"_4-2-å®æ¶çæ§",normalizedTitle:"4.2 å®æ¶çæ§",charIndex:2545},{level:3,title:"4.3 ç°ç¹é¾è·¯",slug:"_4-3-ç°ç¹é¾è·¯",normalizedTitle:"4.3 ç°ç¹é¾è·¯",charIndex:2604},{level:2,title:"5. Sentinel æµéæ§å¶",slug:"_5-sentinel-æµéæ§å¶",normalizedTitle:"5. sentinel æµéæ§å¶",charIndex:2730},{level:3,title:"5.1 åºäº QPS çæµéæ§å¶",slug:"_5-1-åºäº-qps-çæµéæ§å¶",normalizedTitle:"5.1 åºäº qps çæµéæ§å¶",charIndex:2751},{level:3,title:"5.2 åºäºçº¿ç¨æ°çæµéæ§å¶",slug:"_5-2-åºäºçº¿ç¨æ°çæµéæ§å¶",normalizedTitle:"5.2 åºäºçº¿ç¨æ°çæµéæ§å¶",charIndex:2867},{level:3,title:"5.3 æµæ§æ¨¡å¼",slug:"_5-3-æµæ§æ¨¡å¼",normalizedTitle:"5.3 æµæ§æ¨¡å¼",charIndex:3066},{level:3,title:"5.4 æµæ§ææ",slug:"_5-4-æµæ§ææ",normalizedTitle:"5.4 æµæ§ææ",charIndex:3319},{level:3,title:"5.5 ç­ç¹éæµ",slug:"_5-5-ç­ç¹éæµ",normalizedTitle:"5.5 ç­ç¹éæµ",charIndex:3724},{level:3,title:"5.6 æ¥æºéæµ",slug:"_5-6-æ¥æºéæµ",normalizedTitle:"5.6 æ¥æºéæµ",charIndex:4202},{level:2,title:"6. Sentinel çæ­éçº§",slug:"_6-sentinel-çæ­éçº§",normalizedTitle:"6. sentinel çæ­éçº§",charIndex:4346},{level:3,title:"6.1 OpenFeign æ´å Sentinel",slug:"_6-1-openfeign-æ´å-sentinel",normalizedTitle:"6.1 openfeign æ´å sentinel",charIndex:4732},{level:3,title:"6.2 çæ­éçº§",slug:"_6-2-çæ­éçº§",normalizedTitle:"6.2 çæ­éçº§",charIndex:6495}],headersStr:"1. æå¡éªå´©æåº 2. åºå¯¹æå¡éªå´© 2.1 éæµ 2.2 è±å£æ¨¡å¼ 2.3 æ­è·¯å¨ 3. Sentinel ç®ä» 4. Sentinel å®è£ 4.1 å®è£éç½® 4.2 å®æ¶çæ§ 4.3 ç°ç¹é¾è·¯ 5. Sentinel æµéæ§å¶ 5.1 åºäº QPS çæµéæ§å¶ 5.2 åºäºçº¿ç¨æ°çæµéæ§å¶ 5.3 æµæ§æ¨¡å¼ 5.4 æµæ§ææ 5.5 ç­ç¹éæµ 5.6 æ¥æºéæµ 6. Sentinel çæ­éçº§ 6.1 OpenFeign æ´å Sentinel 6.2 çæ­éçº§",content:'# 1. æå¡éªå´©æåº\n\nå¨å¾®æå¡åä¸ªæ¨¡åä¹é´ç»å¸¸äºç¸è°ç¨ï¼åå¦ä¸ä¸ªè°ç¨é¾ä¸º ï¼C/D -> B -> A\n\n\n\nä¸å¼å§ A æ¯æ­£å¸¸çï¼éçæ¶é´çæ¨ç§»ï¼A åºç°äºä¸å¯åç¶çbugï¼å¯¼è´ B è°ç¨ A å¤±è´¥ï¼è¿èå¯¼è´ C å D ä¹å¤±è´¥ï¼æåï¼ç±äº A åºç°çéè¯¯ï¼C -> B -> A å D -> B -> A è¿ä¸¤æ¡è°ç¨é¾é½æ æ³ä½¿ç¨ï¼è¿å°±å«åéªå´©ã\n\nè¿æè¿ç§æåµï¼\n\næå¡ A è°ç¨ B æ­£å¸¸ï¼ä½æ¯è°ç¨ C é»å¡ï¼æ¶é´é¿äºï¼é»å¡å¨ A å¤ççº¿ç¨å°±åå¾å¤äºï¼ä¼å° A çèµæºèå°½å¯¼è´ A ä¸å¯ç¨ã\n\nè¿æç§æåµï¼è¯·æ±ï¼ä¹å°±æ¯æµéå¤ªå¤§äºï¼æå¡æ æ³æ¿åï¼å¯¼è´è¯·æ±æå¡å¨å®æºã\n\n\n# 2. åºå¯¹æå¡éªå´©\n\n\n# 2.1 éæµ\n\nç»è¿æµè¯ï¼åç°æä¸ªè¯·æ±è½å¤æ¿åçæå¤§ QPSï¼æ¯ç§æµéæ°ï¼ æ¯ 1000ï¼é£æä»¬å°±æè¿ä¸ªè¯·æ±ç QPS éå¼è®¾ç½®ä¸º800ï¼è¶è¿äºè¿ä¸ªéå¼ï¼è¯·æ±ç´æ¥è¿åè¢«éæµçéè¯¯ï¼æèè¿åå¶ä»æç¤ºä¿¡æ¯ãå¹¿åãåå...\n\n\n# 2.2 è±å£æ¨¡å¼\n\nè±å£æ¨¡å¼åé´äºç°å®çæ´»ä¸­çè¹è±ç»æï¼å¦æä¸æ¡è¹æ²¡æå°è¹ä½éå¼ï¼ä¸æ¦æ¼æ°´æ´æ¡è¹å°±ä¼æ²ãå¦æå°è¹ä½åä¸ºå¤ä¸ªè±å£ï¼ä¸ä¸ªå°æ¹æ¼æ°´ï¼è¹ä¸è³äºç´æ¥æ²ã\n\n\n\næä»¬å¯ä»¥è®°å½ä½¿ç¨çº¿ç¨æ± è´è´£åä¸ªä¸å¡çè¿ç¨è°ç¨ï¼A è°ç¨ B ãA è°ç¨ Cï¼é½æå¤å ç¨ 10 ä¸ªçº¿ç¨ï¼é£ä¹å¦æ C å®æºå¯¼è´ A dè°ç¨ C çæ¶åé»å¡ï¼æå¤æ¶è 10 ä¸ªçº¿ç¨çèµæºã\n\n\n# 2.3 æ­è·¯å¨\n\nç±»ä¼¼äºé«ä¸­ç©ççµè·¯å¾ï¼\n\n\n\nå½æµéè¿å¤ï¼æèè¿ç¨è°ç¨å¤±è´¥è¿å¤çæåµä¸ï¼æä»¬å°æ­è·¯å¨æå¼ï¼è¿æ ·è¯·æ±å°±æ æ³å°è¾¾ä¸æ¸¸ã\n\næ­è·¯å¨è¯å®ä¸è½æ°¸è¿å³é­ï¼å¨ä¸å®æ¶é´åï¼å¯ä»¥è¯æ¢æ§çæå¼ï¼è®©ä¸ä¸ªæµéè¿å»è¯è¯ä¸æ¸¸æå¡æ¯å¦æ­£å¸¸ï¼å¦ææ­£å¸¸ï¼å³é­æ­è·¯å¨ï¼è®©ä¸æ¸¸æä¾æå¡ï¼å¦æä¸æ­£å¸¸ï¼æå¼æ­è·¯å¨ï¼ä¸è®©è¯·æ±è¿å»ã\n\n\n\n\n# 3. Sentinel ç®ä»\n\nè±ç¹æ¶é´å¹å¹ Sentinel ççé¼ã\n\n> å®ç½ ï¼https://sentinelguard.io/zh-cn/\n\nSentinel æ¯ä»¥æµéä¸ºåå¥ç¹ï¼ä»æµéæ§å¶ãçæ­éçº§ãç³»ç»è´è½½ä¿æ¤ç­å¤ä¸ªç»´åº¦ä¿æ¤æå¡çç¨³å®æ§ã\n\nSentinel çç¹å¾ï¼\n\n 1. ä¸°å¯çåºç¨åºæ¯\n 2. å®å¤çå®æ¶çæ§\n 3. å¹¿æ³çå¼åçæ\n 4. å®åç SPI æ©å±ç¹\n\n\n\n\n# 4. Sentinel å®è£\n\n\n# 4.1 å®è£éç½®\n\nä¸ºäºåä¸è¿° NacosãRibbonãOpenFeign éæï¼Sentinelä½¿ç¨1.8.1çæ¬ã\n\nSPRING CLOUD ALIBABA VERSION   SENTINEL   NACOS   ROCKETMQ   SEATA\n2.2.7.RELEASE                  1.8.1      2.0.3   4.6.1      1.3.0\n\nç¹å»ä¸è½½ ï¼https://github.com/alibaba/Sentinel/releases/download/1.8.1/sentinel-dashboard-1.8.1.jar\n\nå¯ä»¥çå°ï¼ä¸è½½çæ¯ä¸ä¸ª jar åï¼ä½¿ç¨Javaè¿è¡çï¼å®å¶å®æ¯ä¸ä¸ª SpringBoot é¡¹ç®ãæä»¬å¯ä»¥æå®ç¨æ·åãå¯ç ...\n\nä½æ¯å¨æ­¤å¤å°±ç¨é»è®¤çãå®ç½ææå®è¿è¡ç«¯å£ãç¨æ·åãå¯ç çå½ä»¤ã\n\nå¨cmdå½ä»¤è¡ä¸­è¾å¥ä»¥ä¸å½ä»¤å¯å¨ Sentinel\n\n## javaççæ¬å¾æ¯ 1.8 å¦\njava -jar sentinel-dashboard-1.8.1.jar\n\n\nè¿è¡åè®¿é® http://localhost:8080 å³å¯æå¼ Sentinel æ§å¶å°ãç¨æ·åãå¯ç é½ä¸º sentinel\n\n\n\nç»éè¿å»ä¹åå¥ä¹æ²¡æï¼å ä¸ºå®æ¯è§¦åå¼çï¼ç­ä¼åä¸ªè¯·æ±å°±æäºã\n\nç»§ç»­ä½¿ç¨ä¸æä¸­ç cloud-ordersãcloud-goodsï¼\n\nç»å®ä¿©é½å ä¸ sentinel ä¾èµï¼\n\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\n</dependency>\n\n\néç½® Sentinel dashboard å°å\n\ncloud-goods ï¼\n\nserver:\n  port: 9001\nspring:\n  application:\n    name: cloud-goods\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        namespace: dev\n    sentinel:\n      transport:\n        dashboard: localhost:8080\n\n\ncloud-ordersï¼\n\nserver:\n  port: 9002\n\nspring:\n  # ä½¿ç¨æµè¯ç¯å¢çéç½®æä»¶ï¼å½ç¶ä¹å¯ä»¥ä¸ä½¿ç¨\n  profiles:\n    active: test\n  application:\n    name: cloud-orders\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        namespace: dev\n    sentinel:\n      transport:\n        dashboard: localhost:8080\n\n\nå¯å¨é¡¹ç®åï¼è®¿é®ä¹ååçä¸¤ä¸ªæ¥å£ï¼\n\nhttp://localhost:9001/goods/findById/1\nhttp://localhost:9002/order/save\n\n\næå¼ Sentinel æ§å¶å°ï¼å°±å¯ä»¥çå°è¿ä¸¤ä¸ªæå¡:\n\n\n\n\n# 4.2 å®æ¶çæ§\n\nè¿ä¸ªæ²¡å¥å¥½è¯´çï¼å¨è¿éå¯ä»¥æ¥çç»è¿æå¡çææè¯·æ±ï¼ä¼ä»¥æçº¿å¾ä»¥åè¡¨æ ¼çå½¢å¼å±ç°åºæ¥ï¼\n\n\n\n\n# 4.3 ç°ç¹é¾è·¯\n\n> ç°ç¹é¾è·¯ ï¼åå¦ä¸ä¸ªè¯·æ±çè®¿é®è·¯å¾ä¸º ï¼A -> B ãé£ä¹ç§° A -> B ä¸ºä¸ä¸ªé¾è·¯ã\n\n\n\nå¨ç°ç¹é¾è·¯ä¸­å¯ä»¥æ·»å æµæ§è§åï¼ç¹å»æ·»å å³å¯ã\n\n\n\nå½æä»¬è¦ç»ä¸ä¸ªèµæºè¿è¡æµéæ§å¶æ¶ï¼ä¼åç°æè¿äºéé¡¹ï¼æå¼é«çº§éé¡¹åï¼\n\n\n# 5. Sentinel æµéæ§å¶\n\n\n# 5.1 åºäº QPS çæµéæ§å¶\n\nè¿ä¸ªéå¸¸å¥½çè§£ï¼QPS ï¼ä¸ä¸ªæ¥å£æ¯ç§çè®¿é®æ°éã\n\nå¦æå° /goods/gindById/{id} è¿ä¸ªèµæºç QPS è®¾ç½®ä¸º2ï¼ä¹å°±æ¯ 1s æå¤è®¿é®ä¸¤æ¬¡ï¼å¤äºå°±éæµä¸è®©è®¿é®ã\n\n\n\n\n# 5.2 åºäºçº¿ç¨æ°çæµéæ§å¶\n\nç»æä¸ªæ¥å£åéçº¿ç¨ï¼è¿ä¸ªæ¥å£æå¤åªæä¸¤ä¸ªçº¿ç¨åæ¶å¤çï¼è½å¤çå¤å°å®å¨çæ§è½ã\n\n\n\nçº¿ç¨éç¦»çå®ç°æ¹å¼æä¸¤ç§ï¼\n\n 1. çº¿ç¨æ± éç¦»\n    \n    æ¯æä¸»å¨è¶æ¶ï¼æ¯æå¼æ­¥è°ç¨ã\n    \n    çº¿ç¨çå¼éå¤§ã\n\n 2. ä¿¡å·ééç¦» ï¼Sentinel é»è®¤éç¨ï¼\n    \n    è½»éï¼æ é¢å¤å¼é\n    \n    ä¸æ¯æä¸»å¨è¶æ¶ä¸æ¯æå¼æ­¥è°ç¨\n\n\n\n\n# 5.3 æµæ§æ¨¡å¼\n\næµæ§æ¨¡å¼ä¸å±æä¸ä¸ªå¼ï¼\n\n 1. ç´æ¥ ï¼å¯¹äºèµæºåç´æ¥éæµï¼è¾¾å°éå¼åéæµèµæºåãè¿ç§éæµç®åç´æ¥ã\n\n 2. å³è ï¼ä¸¤ä¸ªèµæºè¿è¡å³èï¼ç´æ¥èµæºç QPS è¾¾å°éå¼åï¼éæµå³èèµæºã\n    \n    ä¸è¬éç¨äºä¸¤ä¸ªæç«äºå³ç³»çèµæºï¼å¹¶ä¸å³èèµæºçä¼åçº§ä½äºç´æ¥èµæºã\n    \n    \n\n 3. é¾è·¯ ï¼ä¸¤ä¸ªèµæºæ¯ä¸ä¸ªé¾è·¯ï¼A è°ç¨ Bï¼å¦æ B è¾¾å°éå¼ï¼éæµ A å Bã\n    \n    éç¨äºè°ç¨é¾ï¼å¦æä¸æ¸¸æå¡è¾¾å°éå¼ï¼ä¸æ¸¸ä¹è¿è¡éæµã\n    \n    \n\n\n# 5.4 æµæ§ææ\n\nè¾¾å°æµæ§éå¼åçææãæä¸ç§æ¨¡å¼ï¼\n\n 1. å¿«éå¤±è´¥\n    \n    ä¸æ£æï¼ä¸æ¦è¾¾å°éå¼ï¼ç´æ¥è¿åå¤±è´¥ä¿¡æ¯\n\n 2. Warm Up\n    \n    é¢ç­ï¼å·å¯å¨ï¼æ¹å¼ã\n    \n    å½ç³»ç»é¿æå¤äºä½æ°´ä½æµéçæåµä¸ï¼ä½æµéçªç¶å¢å æ¶ï¼å¯è½ä¼å°ç³»ç»æåå°é«æ°´ä½ï¼ç¬é´æç³»ç»åå®ãéè¿é¢ç­æ¹å¼ï¼è®©éè¿çæµéç¼æ¢å¢å ï¼å¨ä¸å®æ¶é´åéæ¸å¢å å°éå¼ä¸éï¼ç»å·ç³»ç»ä¸ä¸ªé¢ç­çæ¶é´ï¼é¿åå·ç³»ç»è¢«åå®ãé»è®¤ä»¥ QPS / 3ä¸ºéå¼ï¼ç»è¿ä¸æ®µæ¶é´åï¼éå¼æ¢æ¢ä¸åå° QPSã\n    \n    \n\n 3. æéç­å¾\n    \n    åéæéï¼ä¸¥æ ¼æ§å¶è¯·æ±éè¿çé´éæ¶é´ï¼è®©è¯·æ±åééè¿ï¼å¯¹åºçæ¯æ¼æ¡¶ç®æ³ãè¯¦ç»ææ¡£å¯ä»¥åè æµéæ§å¶ - åéå¨æ¨¡å¼ï¼å·ä½çä¾å­å¯ä»¥åè§ PaceFlowDemoopenã\n    \n    è¿ç§æ¨¡å¼ä¸»è¦ç¨äºå¤çé´éæ§çªåçæµéã\n    \n    \n\n\n# 5.5 ç­ç¹éæµ\n\nSentinel ä¹å¯ä»¥å¯¹ç­ç¹ key åéæµãç­ç¹å³ç»å¸¸è®¿é®çæ°æ®ï¼ç­ç¹åæ°éæµä¼ç»è®¡ä¼ å¥åæ°ä¸­çç­ç¹åæ°ï¼å¹¶æ ¹æ®éç½®çéæµéå¼ä¸æ¨¡å¼å¯¹åå«ç­ç¹åæ°çè¯·æ±è¿è¡éå¶ã\n\nè¿æ¯ä½¿ç¨ http://localhost:9001/findById/{id} åä¾å­ï¼å¦ææå¯¹ id ä¸º 13 çåååäºç§ææ´»å¨ï¼ä¸ºäºé²æ­¢å®å¤ªè¿ç«çï¼å°±å¯ä»¥ä½¿ç¨ Sentinel å¯¹ http://localhost:9001/findById/13 çè¯·æ±åéæµï¼å¯¹äºå¶ä»idååçæ¥è¯¢ï¼æä¸ç®¡ã\n\n\n\néè¦æ³¨æçå°±æ¯ä¸ä¸ªåæ°ï¼åæ°ç´¢å¼ãåæºéå¼ãç»è®¡æ¶é¿ã\n\nè¿æ ·ä¼å¯¹ææ id åéå¶ï¼ä¸ç®¡ä½ æ¯ä»ä¹ idï¼3såçæµéå¿é¡»å¨10ä»¥åã\n\nä½æ¯å¦æææ³ç» id=20 çåæ°åä¸ä¸ªä¾å¤å¢ï¼å«ç id æ¯ 3ç§å10æ¬¡ï¼ææ³è®© id=20 3ç§å66æ¬¡å¢ï¼\n\nåæ·»å ååç¹å»ç¼è¾ï¼å°±å¯ä»¥å¨ âé«çº§éé¡¹â ä¸­æ·»å ä¾å¤é¡¹ã\n\n\n\n> éè¦æ³¨æçæ¯ï¼ç­ç¹éæµçä¾å¤é¡¹ä¸è½åæ¹åç»è®¡çªå£æ¶é¿ï¼æä»¥å¹³æ¶åçæ¶åæå¥½åæ 1s ï¼å°±å¯ä»¥ç´æ¥æç§ QPS ç®äºã\n\n\n# 5.6 æ¥æºéæµ\n\néå¯¹æ¥æºéæµ\n\n\n\nå¯¹äº cloud-goods ä¸­ç /goods/findByIdï¼åªè¦æ¯æ¥èª cloud-orders çè¯·æ±ï¼æ¯ç§åªè½æä¸ä¸ªã\n\nä½æ¯è¿ç§éæµä¸è¦å¤§éä½¿ç¨ï¼ç±äºéè¦ä¸ºæ¯ä¸ªèµæºçè°ç¨æ¥æºåç»è®¡ï¼å¤§éä½¿ç¨ä¼å ç¨å¾å¤åå­ãå®æ¹ä¹ç»åºäºæç¤ºã\n\n\n# 6. Sentinel çæ­éçº§\n\né¤äºæµéæ§å¶å¤ï¼å¯¹è°ç¨é¾è·¯ä¸­ä¸ç¨³å®çèµæºè¿è¡çæ­éçº§ä¹æ¯ä¿éé«å¯ç¨çéè¦æªæ½ä¹ä¸ã\n\n> çæ­è·éæµæä»ä¹åºå«ï¼\n> \n> éæµæ¯é¢é²æµéå¤ªå¤§å¯¼è´æå¡ä¸å¯ç¨ã\n> \n> çæ­æ¯ä¸ä¸ææå¡å ä¸ºåç§åå å®æºï¼ä¿æ¤æ´ä¸ªé¾è·¯è¿å¯ä»¥æä¾æå¡ã\n\nä¸ä¸ªæå¡ç»å¸¸ä¼è°ç¨å¶ä»æ¨¡åï¼å¯è½æ¯å¦å¤ä¸ä¸ªæå¡ãæ°æ®åºãä¸æ¹APIç­ãä¸ä¸è¢«è°ç¨æå¡åºéæç¸åºå¤ªæ¢ï¼æ´æ¡é¾è·¯å°±ä¼æ æ³ååºï¼ä½æ¯çæ­å¯ä»¥ä¿è¯å½è°ç¨æ¹æ æ³è°ç¨æå¡æ¶ï¼ä½¿ç¨ä¸ä¸ªé»è®¤å¼ï¼ä¿æ¤è°ç¨æ¹æ­£å¸¸æä¾æå¡ã\n\nç®èè¨ä¹ï¼çæ­æ¯å¯¹è°ç¨æ¹çä¿æ¤ã\n\nçæ­éçº§çåçæ¯æ­è·¯å¨ï¼ä¹å°±æ¯ä¸è¿°çç©ççµè·¯çå¼å³ã\n\n\n\n 1. ä¸å¼å§æ¯æ­£å¸¸è¯·æ±ï¼ç´å°è¾¾å°çæ­éå¼ï¼æ­è·¯å¨æå¼ï¼æå¡å½¢ææ­è·¯ï¼æå¡å¼å§çæ­ã\n 2. çæ­æ¶é´ç»æåï¼å°è¯æ¾å¿ä¸æ¬¡è¯·æ±ãå¦æå¤±è´¥ï¼ç»§ç»­è¿è¡çæ­ãå¦ææåï¼å³é­æ­è·¯å¨ï¼æå¡ç»æçæ­ã\n\n\n# 6.1 OpenFeign æ´å Sentinel\n\nSentinel æ¯å¯¹è°ç¨èçä¿æ¤ï¼é£æä»¬è¯å®è¦å¨è°ç¨èåºç¼åä»£ç ï¼åæ¶ï¼OpenFeign æä¾äºå¯¹ Sentinel çéæï¼æä»¥åªéè¦å¨ç¼åä»£ç çæ¶åæç§æ­¥éª¤æ¥ï¼å°±å¯ä»¥å®ç° Sentinel ççæ­éçº§ã\n\ncloud-orders è°ç¨äº cloud-goods çæå¡ï¼é£ä¹ cloud-orders å°±æ¯è°ç¨æ¹ï¼æä»¬æ³è¦ä¿æ¤å®ã\n\n 1. cloud-orders æ·»å éç½®ï¼\n    \n    server:\n      port: 9002\n    spring:\n      application:\n        name: cloud-orders\n      cloud:\n        nacos:\n          discovery:\n            server-addr: localhost:8848\n            username: nacos\n            password: nacos\n            namespace: dev\n        sentinel:\n          transport:\n            dashboard: localhost:8080\n    feign:\n      sentinel:\n        enabled: true\n    \n\n 2. ç¼åè§¦åçæ­åçé»è¾ï¼\n    \n    æä¸¤ç§æ¹æ¡ï¼FallbackClassãFallbackFactoryï¼ç±äº FallbackClass æ æ³å¯¹è¿ç¨è°ç¨çå¼å¸¸ååºå¤çï¼æä»¥æä»¬ä½¿ç¨ å®ç°FallbackFactoryçæ¹å¼ãæ³¨æï¼è¿ä¸ªå®ç°ç±»è¦æ³¨å¥å®¹å¨ã\n    \n    @Slf4j\n    @Component\n    public class GoodsAPIClientFallbackFactory implements FallbackFactory<GoodsAPI> {\n        @Override\n        public GoodsAPI create(Throwable throwable) {\n            // å½çæ­éçº§è¢«è§¦åæ¶æ§è¡è¿ä¸ªæ¹æ³ï¼æä»¬å¨æ­¤å¤è¿åç»åç«¯ä¸ä¸ªé»è®¤å¼æèåå¥½çæ¥é\n            return new GoodsAPI() {\n                @Override\n                public Goods findById(String id) {\n                    log.error("è¿ç¨è°ç¨ findById éè¯¯ï¼message : {}, id: {}", throwable.getMessage(), id);\n                    return new Goods();\n                }\n            };\n        }\n    }\n    \n\n 3. å¨å¯¹åºç è¿ç¨è°ç¨æ¥å£ä¸æå®ä¸è¿°çæ­éçº§å¤çç±»ã\n    \n    @FeignClient(name = "cloud-goods", fallbackFactory = GoodsAPIClientFallbackFactory.class)\n    @RequestMapping("/goods") // è·¯å¾\n    public interface GoodsAPI {\n        @RequestMapping("/findById/{id}")\n        public Goods findById(@PathVariable("id") String id);\n    }\n    \n\nç°å¨æä»¬å·²ç»ç¡®è®¤å¥½ ä¸ä¸ cloud-goods è¾¾å°äºçæ­æ¡ä»¶ï¼cloud-orders è¯¥å¦ä½å¤çäºï¼ä½æ¯è¿ä¸ªâçæ­æ¡ä»¶â è¯¥å¦ä½æå®å¢ï¼è¯å®æ¯éè¿ Sentinel å®¢æ·ç«¯å~\n\nSentinel çæ­éçº§ç­ç¥æä¸ç§ï¼\n\n 1. æ¢è°ç¨æ¯ä¾\n 2. å¼å¸¸æ¯ä¾\n 3. å¼å¸¸æ°é\n\n\n# 6.2 çæ­éçº§\n\n\n\n * èµæºå ï¼æ·»å çæ­éçº§çèµæº\n * æå¤§RT ï¼RTï¼return timeï¼ï¼æå¤§ååºæ¶é´ã\n * æ¯ä¾éå¼ ï¼åå¼ä¸º 0 å° 1 ä¹é´çå°æ°ã\n * çæ­æ¶é¿ ï¼åæ¬¡å¤äºçæ­çæ¶é´\n * æå°è¯·æ±æ° ï¼çæ­è§¦åçæå°è¯·æ±æ°ï¼è¯·æ±ä¹¦å°äºè¯¥å¼æ¶ï¼å³ä½¿è¾¾å°äºçæ­ç­ç¥è§å®å¼ä¹ä¸è§¦åçæ­ã\n * ç»è®¡æ¶é¿ ï¼ä¸è¬ä¸º 1sã1min\n * çæ­ç­ç¥ ï¼ä½¿ç¨ä»ä¹æ ·ççæ­ç­ç¥ï¼è¾¾å°è¯¥ç­ç¥å°±è§¦åçæ­ã\n   * æ¢è°ç¨æ¯ä¾ ï¼ååºæ¶é´è¶è¿æå¤§RTçç§°ä¸ºæ¢è°ç¨ã\n   * å¼å¸¸æ¯ä¾ ï¼å¼å¸¸è¯·æ± / å¨é¨è¯·æ± çæ¯ä¾ã\n   * å¼å¸¸æ° ï¼å¼å¸¸æ°éã\n\nä¸¾ä¸ªä¾å­ï¼\n\n\n\nçæ­ç­ç¥ä¸ºæ¢è°ç¨ï¼å¨ 1000msï¼ä¹å°±æ¯ 1s åï¼å¦æè¯·æ±æ°éå¤§äº5ï¼å¹¶ä¸å¨é¨æ¢è°ç¨ï¼å¨é¨è¯·æ±ææ¶èæ¶é´é½è¶è¿ 200msï¼ï¼è¾¾å°çæ­æ¯ä¾éå¼ï¼è§¦åçæ­ï¼çæ­ 5s ã5s åå°è¯åéä¸æ¬¡è¯·æ±ï¼æ ¹æ®è¯·æ±ç»ææ¥å³å®æ¯å¦å³é­çæ­ã',normalizedContent:'# 1. æå¡éªå´©æåº\n\nå¨å¾®æå¡åä¸ªæ¨¡åä¹é´ç»å¸¸äºç¸è°ç¨ï¼åå¦ä¸ä¸ªè°ç¨é¾ä¸º ï¼c/d -> b -> a\n\n\n\nä¸å¼å§ a æ¯æ­£å¸¸çï¼éçæ¶é´çæ¨ç§»ï¼a åºç°äºä¸å¯åç¶çbugï¼å¯¼è´ b è°ç¨ a å¤±è´¥ï¼è¿èå¯¼è´ c å d ä¹å¤±è´¥ï¼æåï¼ç±äº a åºç°çéè¯¯ï¼c -> b -> a å d -> b -> a è¿ä¸¤æ¡è°ç¨é¾é½æ æ³ä½¿ç¨ï¼è¿å°±å«åéªå´©ã\n\nè¿æè¿ç§æåµï¼\n\næå¡ a è°ç¨ b æ­£å¸¸ï¼ä½æ¯è°ç¨ c é»å¡ï¼æ¶é´é¿äºï¼é»å¡å¨ a å¤ççº¿ç¨å°±åå¾å¤äºï¼ä¼å° a çèµæºèå°½å¯¼è´ a ä¸å¯ç¨ã\n\nè¿æç§æåµï¼è¯·æ±ï¼ä¹å°±æ¯æµéå¤ªå¤§äºï¼æå¡æ æ³æ¿åï¼å¯¼è´è¯·æ±æå¡å¨å®æºã\n\n\n# 2. åºå¯¹æå¡éªå´©\n\n\n# 2.1 éæµ\n\nç»è¿æµè¯ï¼åç°æä¸ªè¯·æ±è½å¤æ¿åçæå¤§ qpsï¼æ¯ç§æµéæ°ï¼ æ¯ 1000ï¼é£æä»¬å°±æè¿ä¸ªè¯·æ±ç qps éå¼è®¾ç½®ä¸º800ï¼è¶è¿äºè¿ä¸ªéå¼ï¼è¯·æ±ç´æ¥è¿åè¢«éæµçéè¯¯ï¼æèè¿åå¶ä»æç¤ºä¿¡æ¯ãå¹¿åãåå...\n\n\n# 2.2 è±å£æ¨¡å¼\n\nè±å£æ¨¡å¼åé´äºç°å®çæ´»ä¸­çè¹è±ç»æï¼å¦æä¸æ¡è¹æ²¡æå°è¹ä½éå¼ï¼ä¸æ¦æ¼æ°´æ´æ¡è¹å°±ä¼æ²ãå¦æå°è¹ä½åä¸ºå¤ä¸ªè±å£ï¼ä¸ä¸ªå°æ¹æ¼æ°´ï¼è¹ä¸è³äºç´æ¥æ²ã\n\n\n\næä»¬å¯ä»¥è®°å½ä½¿ç¨çº¿ç¨æ± è´è´£åä¸ªä¸å¡çè¿ç¨è°ç¨ï¼a è°ç¨ b ãa è°ç¨ cï¼é½æå¤å ç¨ 10 ä¸ªçº¿ç¨ï¼é£ä¹å¦æ c å®æºå¯¼è´ a dè°ç¨ c çæ¶åé»å¡ï¼æå¤æ¶è 10 ä¸ªçº¿ç¨çèµæºã\n\n\n# 2.3 æ­è·¯å¨\n\nç±»ä¼¼äºé«ä¸­ç©ççµè·¯å¾ï¼\n\n\n\nå½æµéè¿å¤ï¼æèè¿ç¨è°ç¨å¤±è´¥è¿å¤çæåµä¸ï¼æä»¬å°æ­è·¯å¨æå¼ï¼è¿æ ·è¯·æ±å°±æ æ³å°è¾¾ä¸æ¸¸ã\n\næ­è·¯å¨è¯å®ä¸è½æ°¸è¿å³é­ï¼å¨ä¸å®æ¶é´åï¼å¯ä»¥è¯æ¢æ§çæå¼ï¼è®©ä¸ä¸ªæµéè¿å»è¯è¯ä¸æ¸¸æå¡æ¯å¦æ­£å¸¸ï¼å¦ææ­£å¸¸ï¼å³é­æ­è·¯å¨ï¼è®©ä¸æ¸¸æä¾æå¡ï¼å¦æä¸æ­£å¸¸ï¼æå¼æ­è·¯å¨ï¼ä¸è®©è¯·æ±è¿å»ã\n\n\n\n\n# 3. sentinel ç®ä»\n\nè±ç¹æ¶é´å¹å¹ sentinel ççé¼ã\n\n> å®ç½ ï¼https://sentinelguard.io/zh-cn/\n\nsentinel æ¯ä»¥æµéä¸ºåå¥ç¹ï¼ä»æµéæ§å¶ãçæ­éçº§ãç³»ç»è´è½½ä¿æ¤ç­å¤ä¸ªç»´åº¦ä¿æ¤æå¡çç¨³å®æ§ã\n\nsentinel çç¹å¾ï¼\n\n 1. ä¸°å¯çåºç¨åºæ¯\n 2. å®å¤çå®æ¶çæ§\n 3. å¹¿æ³çå¼åçæ\n 4. å®åç spi æ©å±ç¹\n\n\n\n\n# 4. sentinel å®è£\n\n\n# 4.1 å®è£éç½®\n\nä¸ºäºåä¸è¿° nacosãribbonãopenfeign éæï¼sentinelä½¿ç¨1.8.1çæ¬ã\n\nspring cloud alibaba version   sentinel   nacos   rocketmq   seata\n2.2.7.release                  1.8.1      2.0.3   4.6.1      1.3.0\n\nç¹å»ä¸è½½ ï¼https://github.com/alibaba/sentinel/releases/download/1.8.1/sentinel-dashboard-1.8.1.jar\n\nå¯ä»¥çå°ï¼ä¸è½½çæ¯ä¸ä¸ª jar åï¼ä½¿ç¨javaè¿è¡çï¼å®å¶å®æ¯ä¸ä¸ª springboot é¡¹ç®ãæä»¬å¯ä»¥æå®ç¨æ·åãå¯ç ...\n\nä½æ¯å¨æ­¤å¤å°±ç¨é»è®¤çãå®ç½ææå®è¿è¡ç«¯å£ãç¨æ·åãå¯ç çå½ä»¤ã\n\nå¨cmdå½ä»¤è¡ä¸­è¾å¥ä»¥ä¸å½ä»¤å¯å¨ sentinel\n\n## javaççæ¬å¾æ¯ 1.8 å¦\njava -jar sentinel-dashboard-1.8.1.jar\n\n\nè¿è¡åè®¿é® http://localhost:8080 å³å¯æå¼ sentinel æ§å¶å°ãç¨æ·åãå¯ç é½ä¸º sentinel\n\n\n\nç»éè¿å»ä¹åå¥ä¹æ²¡æï¼å ä¸ºå®æ¯è§¦åå¼çï¼ç­ä¼åä¸ªè¯·æ±å°±æäºã\n\nç»§ç»­ä½¿ç¨ä¸æä¸­ç cloud-ordersãcloud-goodsï¼\n\nç»å®ä¿©é½å ä¸ sentinel ä¾èµï¼\n\n<dependency>\n    <groupid>com.alibaba.cloud</groupid>\n    <artifactid>spring-cloud-starter-alibaba-sentinel</artifactid>\n</dependency>\n\n\néç½® sentinel dashboard å°å\n\ncloud-goods ï¼\n\nserver:\n  port: 9001\nspring:\n  application:\n    name: cloud-goods\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        namespace: dev\n    sentinel:\n      transport:\n        dashboard: localhost:8080\n\n\ncloud-ordersï¼\n\nserver:\n  port: 9002\n\nspring:\n  # ä½¿ç¨æµè¯ç¯å¢çéç½®æä»¶ï¼å½ç¶ä¹å¯ä»¥ä¸ä½¿ç¨\n  profiles:\n    active: test\n  application:\n    name: cloud-orders\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        username: nacos\n        password: nacos\n        namespace: dev\n    sentinel:\n      transport:\n        dashboard: localhost:8080\n\n\nå¯å¨é¡¹ç®åï¼è®¿é®ä¹ååçä¸¤ä¸ªæ¥å£ï¼\n\nhttp://localhost:9001/goods/findbyid/1\nhttp://localhost:9002/order/save\n\n\næå¼ sentinel æ§å¶å°ï¼å°±å¯ä»¥çå°è¿ä¸¤ä¸ªæå¡:\n\n\n\n\n# 4.2 å®æ¶çæ§\n\nè¿ä¸ªæ²¡å¥å¥½è¯´çï¼å¨è¿éå¯ä»¥æ¥çç»è¿æå¡çææè¯·æ±ï¼ä¼ä»¥æçº¿å¾ä»¥åè¡¨æ ¼çå½¢å¼å±ç°åºæ¥ï¼\n\n\n\n\n# 4.3 ç°ç¹é¾è·¯\n\n> ç°ç¹é¾è·¯ ï¼åå¦ä¸ä¸ªè¯·æ±çè®¿é®è·¯å¾ä¸º ï¼a -> b ãé£ä¹ç§° a -> b ä¸ºä¸ä¸ªé¾è·¯ã\n\n\n\nå¨ç°ç¹é¾è·¯ä¸­å¯ä»¥æ·»å æµæ§è§åï¼ç¹å»æ·»å å³å¯ã\n\n\n\nå½æä»¬è¦ç»ä¸ä¸ªèµæºè¿è¡æµéæ§å¶æ¶ï¼ä¼åç°æè¿äºéé¡¹ï¼æå¼é«çº§éé¡¹åï¼\n\n\n# 5. sentinel æµéæ§å¶\n\n\n# 5.1 åºäº qps çæµéæ§å¶\n\nè¿ä¸ªéå¸¸å¥½çè§£ï¼qps ï¼ä¸ä¸ªæ¥å£æ¯ç§çè®¿é®æ°éã\n\nå¦æå° /goods/gindbyid/{id} è¿ä¸ªèµæºç qps è®¾ç½®ä¸º2ï¼ä¹å°±æ¯ 1s æå¤è®¿é®ä¸¤æ¬¡ï¼å¤äºå°±éæµä¸è®©è®¿é®ã\n\n\n\n\n# 5.2 åºäºçº¿ç¨æ°çæµéæ§å¶\n\nç»æä¸ªæ¥å£åéçº¿ç¨ï¼è¿ä¸ªæ¥å£æå¤åªæä¸¤ä¸ªçº¿ç¨åæ¶å¤çï¼è½å¤çå¤å°å®å¨çæ§è½ã\n\n\n\nçº¿ç¨éç¦»çå®ç°æ¹å¼æä¸¤ç§ï¼\n\n 1. çº¿ç¨æ± éç¦»\n    \n    æ¯æä¸»å¨è¶æ¶ï¼æ¯æå¼æ­¥è°ç¨ã\n    \n    çº¿ç¨çå¼éå¤§ã\n\n 2. ä¿¡å·ééç¦» ï¼sentinel é»è®¤éç¨ï¼\n    \n    è½»éï¼æ é¢å¤å¼é\n    \n    ä¸æ¯æä¸»å¨è¶æ¶ä¸æ¯æå¼æ­¥è°ç¨\n\n\n\n\n# 5.3 æµæ§æ¨¡å¼\n\næµæ§æ¨¡å¼ä¸å±æä¸ä¸ªå¼ï¼\n\n 1. ç´æ¥ ï¼å¯¹äºèµæºåç´æ¥éæµï¼è¾¾å°éå¼åéæµèµæºåãè¿ç§éæµç®åç´æ¥ã\n\n 2. å³è ï¼ä¸¤ä¸ªèµæºè¿è¡å³èï¼ç´æ¥èµæºç qps è¾¾å°éå¼åï¼éæµå³èèµæºã\n    \n    ä¸è¬éç¨äºä¸¤ä¸ªæç«äºå³ç³»çèµæºï¼å¹¶ä¸å³èèµæºçä¼åçº§ä½äºç´æ¥èµæºã\n    \n    \n\n 3. é¾è·¯ ï¼ä¸¤ä¸ªèµæºæ¯ä¸ä¸ªé¾è·¯ï¼a è°ç¨ bï¼å¦æ b è¾¾å°éå¼ï¼éæµ a å bã\n    \n    éç¨äºè°ç¨é¾ï¼å¦æä¸æ¸¸æå¡è¾¾å°éå¼ï¼ä¸æ¸¸ä¹è¿è¡éæµã\n    \n    \n\n\n# 5.4 æµæ§ææ\n\nè¾¾å°æµæ§éå¼åçææãæä¸ç§æ¨¡å¼ï¼\n\n 1. å¿«éå¤±è´¥\n    \n    ä¸æ£æï¼ä¸æ¦è¾¾å°éå¼ï¼ç´æ¥è¿åå¤±è´¥ä¿¡æ¯\n\n 2. warm up\n    \n    é¢ç­ï¼å·å¯å¨ï¼æ¹å¼ã\n    \n    å½ç³»ç»é¿æå¤äºä½æ°´ä½æµéçæåµä¸ï¼ä½æµéçªç¶å¢å æ¶ï¼å¯è½ä¼å°ç³»ç»æåå°é«æ°´ä½ï¼ç¬é´æç³»ç»åå®ãéè¿é¢ç­æ¹å¼ï¼è®©éè¿çæµéç¼æ¢å¢å ï¼å¨ä¸å®æ¶é´åéæ¸å¢å å°éå¼ä¸éï¼ç»å·ç³»ç»ä¸ä¸ªé¢ç­çæ¶é´ï¼é¿åå·ç³»ç»è¢«åå®ãé»è®¤ä»¥ qps / 3ä¸ºéå¼ï¼ç»è¿ä¸æ®µæ¶é´åï¼éå¼æ¢æ¢ä¸åå° qpsã\n    \n    \n\n 3. æéç­å¾\n    \n    åéæéï¼ä¸¥æ ¼æ§å¶è¯·æ±éè¿çé´éæ¶é´ï¼è®©è¯·æ±åééè¿ï¼å¯¹åºçæ¯æ¼æ¡¶ç®æ³ãè¯¦ç»ææ¡£å¯ä»¥åè æµéæ§å¶ - åéå¨æ¨¡å¼ï¼å·ä½çä¾å­å¯ä»¥åè§ paceflowdemoopenã\n    \n    è¿ç§æ¨¡å¼ä¸»è¦ç¨äºå¤çé´éæ§çªåçæµéã\n    \n    \n\n\n# 5.5 ç­ç¹éæµ\n\nsentinel ä¹å¯ä»¥å¯¹ç­ç¹ key åéæµãç­ç¹å³ç»å¸¸è®¿é®çæ°æ®ï¼ç­ç¹åæ°éæµä¼ç»è®¡ä¼ å¥åæ°ä¸­çç­ç¹åæ°ï¼å¹¶æ ¹æ®éç½®çéæµéå¼ä¸æ¨¡å¼å¯¹åå«ç­ç¹åæ°çè¯·æ±è¿è¡éå¶ã\n\nè¿æ¯ä½¿ç¨ http://localhost:9001/findbyid/{id} åä¾å­ï¼å¦ææå¯¹ id ä¸º 13 çåååäºç§ææ´»å¨ï¼ä¸ºäºé²æ­¢å®å¤ªè¿ç«çï¼å°±å¯ä»¥ä½¿ç¨ sentinel å¯¹ http://localhost:9001/findbyid/13 çè¯·æ±åéæµï¼å¯¹äºå¶ä»idååçæ¥è¯¢ï¼æä¸ç®¡ã\n\n\n\néè¦æ³¨æçå°±æ¯ä¸ä¸ªåæ°ï¼åæ°ç´¢å¼ãåæºéå¼ãç»è®¡æ¶é¿ã\n\nè¿æ ·ä¼å¯¹ææ id åéå¶ï¼ä¸ç®¡ä½ æ¯ä»ä¹ idï¼3såçæµéå¿é¡»å¨10ä»¥åã\n\nä½æ¯å¦æææ³ç» id=20 çåæ°åä¸ä¸ªä¾å¤å¢ï¼å«ç id æ¯ 3ç§å10æ¬¡ï¼ææ³è®© id=20 3ç§å66æ¬¡å¢ï¼\n\nåæ·»å ååç¹å»ç¼è¾ï¼å°±å¯ä»¥å¨ âé«çº§éé¡¹â ä¸­æ·»å ä¾å¤é¡¹ã\n\n\n\n> éè¦æ³¨æçæ¯ï¼ç­ç¹éæµçä¾å¤é¡¹ä¸è½åæ¹åç»è®¡çªå£æ¶é¿ï¼æä»¥å¹³æ¶åçæ¶åæå¥½åæ 1s ï¼å°±å¯ä»¥ç´æ¥æç§ qps ç®äºã\n\n\n# 5.6 æ¥æºéæµ\n\néå¯¹æ¥æºéæµ\n\n\n\nå¯¹äº cloud-goods ä¸­ç /goods/findbyidï¼åªè¦æ¯æ¥èª cloud-orders çè¯·æ±ï¼æ¯ç§åªè½æä¸ä¸ªã\n\nä½æ¯è¿ç§éæµä¸è¦å¤§éä½¿ç¨ï¼ç±äºéè¦ä¸ºæ¯ä¸ªèµæºçè°ç¨æ¥æºåç»è®¡ï¼å¤§éä½¿ç¨ä¼å ç¨å¾å¤åå­ãå®æ¹ä¹ç»åºäºæç¤ºã\n\n\n# 6. sentinel çæ­éçº§\n\né¤äºæµéæ§å¶å¤ï¼å¯¹è°ç¨é¾è·¯ä¸­ä¸ç¨³å®çèµæºè¿è¡çæ­éçº§ä¹æ¯ä¿éé«å¯ç¨çéè¦æªæ½ä¹ä¸ã\n\n> çæ­è·éæµæä»ä¹åºå«ï¼\n> \n> éæµæ¯é¢é²æµéå¤ªå¤§å¯¼è´æå¡ä¸å¯ç¨ã\n> \n> çæ­æ¯ä¸ä¸ææå¡å ä¸ºåç§åå å®æºï¼ä¿æ¤æ´ä¸ªé¾è·¯è¿å¯ä»¥æä¾æå¡ã\n\nä¸ä¸ªæå¡ç»å¸¸ä¼è°ç¨å¶ä»æ¨¡åï¼å¯è½æ¯å¦å¤ä¸ä¸ªæå¡ãæ°æ®åºãä¸æ¹apiç­ãä¸ä¸è¢«è°ç¨æå¡åºéæç¸åºå¤ªæ¢ï¼æ´æ¡é¾è·¯å°±ä¼æ æ³ååºï¼ä½æ¯çæ­å¯ä»¥ä¿è¯å½è°ç¨æ¹æ æ³è°ç¨æå¡æ¶ï¼ä½¿ç¨ä¸ä¸ªé»è®¤å¼ï¼ä¿æ¤è°ç¨æ¹æ­£å¸¸æä¾æå¡ã\n\nç®èè¨ä¹ï¼çæ­æ¯å¯¹è°ç¨æ¹çä¿æ¤ã\n\nçæ­éçº§çåçæ¯æ­è·¯å¨ï¼ä¹å°±æ¯ä¸è¿°çç©ççµè·¯çå¼å³ã\n\n\n\n 1. ä¸å¼å§æ¯æ­£å¸¸è¯·æ±ï¼ç´å°è¾¾å°çæ­éå¼ï¼æ­è·¯å¨æå¼ï¼æå¡å½¢ææ­è·¯ï¼æå¡å¼å§çæ­ã\n 2. çæ­æ¶é´ç»æåï¼å°è¯æ¾å¿ä¸æ¬¡è¯·æ±ãå¦æå¤±è´¥ï¼ç»§ç»­è¿è¡çæ­ãå¦ææåï¼å³é­æ­è·¯å¨ï¼æå¡ç»æçæ­ã\n\n\n# 6.1 openfeign æ´å sentinel\n\nsentinel æ¯å¯¹è°ç¨èçä¿æ¤ï¼é£æä»¬è¯å®è¦å¨è°ç¨èåºç¼åä»£ç ï¼åæ¶ï¼openfeign æä¾äºå¯¹ sentinel çéæï¼æä»¥åªéè¦å¨ç¼åä»£ç çæ¶åæç§æ­¥éª¤æ¥ï¼å°±å¯ä»¥å®ç° sentinel ççæ­éçº§ã\n\ncloud-orders è°ç¨äº cloud-goods çæå¡ï¼é£ä¹ cloud-orders å°±æ¯è°ç¨æ¹ï¼æä»¬æ³è¦ä¿æ¤å®ã\n\n 1. cloud-orders æ·»å éç½®ï¼\n    \n    server:\n      port: 9002\n    spring:\n      application:\n        name: cloud-orders\n      cloud:\n        nacos:\n          discovery:\n            server-addr: localhost:8848\n            username: nacos\n            password: nacos\n            namespace: dev\n        sentinel:\n          transport:\n            dashboard: localhost:8080\n    feign:\n      sentinel:\n        enabled: true\n    \n\n 2. ç¼åè§¦åçæ­åçé»è¾ï¼\n    \n    æä¸¤ç§æ¹æ¡ï¼fallbackclassãfallbackfactoryï¼ç±äº fallbackclass æ æ³å¯¹è¿ç¨è°ç¨çå¼å¸¸ååºå¤çï¼æä»¥æä»¬ä½¿ç¨ å®ç°fallbackfactoryçæ¹å¼ãæ³¨æï¼è¿ä¸ªå®ç°ç±»è¦æ³¨å¥å®¹å¨ã\n    \n    @slf4j\n    @component\n    public class goodsapiclientfallbackfactory implements fallbackfactory<goodsapi> {\n        @override\n        public goodsapi create(throwable throwable) {\n            // å½çæ­éçº§è¢«è§¦åæ¶æ§è¡è¿ä¸ªæ¹æ³ï¼æä»¬å¨æ­¤å¤è¿åç»åç«¯ä¸ä¸ªé»è®¤å¼æèåå¥½çæ¥é\n            return new goodsapi() {\n                @override\n                public goods findbyid(string id) {\n                    log.error("è¿ç¨è°ç¨ findbyid éè¯¯ï¼message : {}, id: {}", throwable.getmessage(), id);\n                    return new goods();\n                }\n            };\n        }\n    }\n    \n\n 3. å¨å¯¹åºç è¿ç¨è°ç¨æ¥å£ä¸æå®ä¸è¿°çæ­éçº§å¤çç±»ã\n    \n    @feignclient(name = "cloud-goods", fallbackfactory = goodsapiclientfallbackfactory.class)\n    @requestmapping("/goods") // è·¯å¾\n    public interface goodsapi {\n        @requestmapping("/findbyid/{id}")\n        public goods findbyid(@pathvariable("id") string id);\n    }\n    \n\nç°å¨æä»¬å·²ç»ç¡®è®¤å¥½ ä¸ä¸ cloud-goods è¾¾å°äºçæ­æ¡ä»¶ï¼cloud-orders è¯¥å¦ä½å¤çäºï¼ä½æ¯è¿ä¸ªâçæ­æ¡ä»¶â è¯¥å¦ä½æå®å¢ï¼è¯å®æ¯éè¿ sentinel å®¢æ·ç«¯å~\n\nsentinel çæ­éçº§ç­ç¥æä¸ç§ï¼\n\n 1. æ¢è°ç¨æ¯ä¾\n 2. å¼å¸¸æ¯ä¾\n 3. å¼å¸¸æ°é\n\n\n# 6.2 çæ­éçº§\n\n\n\n * èµæºå ï¼æ·»å çæ­éçº§çèµæº\n * æå¤§rt ï¼rtï¼return timeï¼ï¼æå¤§ååºæ¶é´ã\n * æ¯ä¾éå¼ ï¼åå¼ä¸º 0 å° 1 ä¹é´çå°æ°ã\n * çæ­æ¶é¿ ï¼åæ¬¡å¤äºçæ­çæ¶é´\n * æå°è¯·æ±æ° ï¼çæ­è§¦åçæå°è¯·æ±æ°ï¼è¯·æ±ä¹¦å°äºè¯¥å¼æ¶ï¼å³ä½¿è¾¾å°äºçæ­ç­ç¥è§å®å¼ä¹ä¸è§¦åçæ­ã\n * ç»è®¡æ¶é¿ ï¼ä¸è¬ä¸º 1sã1min\n * çæ­ç­ç¥ ï¼ä½¿ç¨ä»ä¹æ ·ççæ­ç­ç¥ï¼è¾¾å°è¯¥ç­ç¥å°±è§¦åçæ­ã\n   * æ¢è°ç¨æ¯ä¾ ï¼ååºæ¶é´è¶è¿æå¤§rtçç§°ä¸ºæ¢è°ç¨ã\n   * å¼å¸¸æ¯ä¾ ï¼å¼å¸¸è¯·æ± / å¨é¨è¯·æ± çæ¯ä¾ã\n   * å¼å¸¸æ° ï¼å¼å¸¸æ°éã\n\nä¸¾ä¸ªä¾å­ï¼\n\n\n\nçæ­ç­ç¥ä¸ºæ¢è°ç¨ï¼å¨ 1000msï¼ä¹å°±æ¯ 1s åï¼å¦æè¯·æ±æ°éå¤§äº5ï¼å¹¶ä¸å¨é¨æ¢è°ç¨ï¼å¨é¨è¯·æ±ææ¶èæ¶é´é½è¶è¿ 200msï¼ï¼è¾¾å°çæ­æ¯ä¾éå¼ï¼è§¦åçæ­ï¼çæ­ 5s ã5s åå°è¯åéä¸æ¬¡è¯·æ±ï¼æ ¹æ®è¯·æ±ç»ææ¥å³å®æ¯å¦å³é­çæ­ã',charsets:{cjk:!0},lastUpdated:"2023/10/30, 14:49:23",lastUpdatedTimestamp:1698648563e3},{title:"1. Sentinelä¸­çä¸äºæ¦å¿µä¸æ ¸å¿ç±»è§£æ",frontmatter:{title:"1. Sentinelä¸­çä¸äºæ¦å¿µä¸æ ¸å¿ç±»è§£æ",date:"2023-11-29T16:08:05.000Z",permalink:"/pages/3d8a71/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/60.Sentinel/3.%20Sentinel%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5.html",relativePath:"02.æç« /91.æ¡æ¶/60.Sentinel/3. Sentinelä¸­çä¸äºæ¦å¿µ.md",key:"v-fa2c9a0c",path:"/pages/3d8a71/",headers:[{level:2,title:"1. èµæº ResourceWrapper",slug:"_1-èµæº-resourcewrapper",normalizedTitle:"1. èµæº resourcewrapper",charIndex:2},{level:2,title:"2. èç¹ Node",slug:"_2-èç¹-node",normalizedTitle:"2. èç¹ node",charIndex:1108},{level:3,title:"2.1 ç»è®¡èç¹ ï¼StatisticNode",slug:"_2-1-ç»è®¡èç¹-statisticnode",normalizedTitle:"2.1 ç»è®¡èç¹ ï¼statisticnode",charIndex:3038},{level:3,title:"2.2 æ®éèç¹ ï¼DefaultNode",slug:"_2-2-æ®éèç¹-defaultnode",normalizedTitle:"2.2 æ®éèç¹ ï¼defaultnode",charIndex:4148},{level:3,title:"2.3 å¥å£èç¹ ï¼EntranceNode",slug:"_2-3-å¥å£èç¹-entrancenode",normalizedTitle:"2.3 å¥å£èç¹ ï¼entrancenode",charIndex:6021},{level:3,title:"2.4 å¨å±èç¹ ï¼ClusterNode",slug:"_2-4-å¨å±èç¹-clusternode",normalizedTitle:"2.4 å¨å±èç¹ ï¼clusternode",charIndex:6521},{level:2,title:"3. æ ¹èç¹ Constants.ROOT",slug:"_3-æ ¹èç¹-constants-root",normalizedTitle:"3. æ ¹èç¹ constants.root",charIndex:8175},{level:2,title:"4. Entry",slug:"_4-entry",normalizedTitle:"4. entry",charIndex:9275},{level:2,title:"5. ä¸ä¸æ Context",slug:"_5-ä¸ä¸æ-context",normalizedTitle:"5. ä¸ä¸æ context",charIndex:12323},{level:3,title:"5.1 Context çåå»º",slug:"_5-1-context-çåå»º",normalizedTitle:"5.1 context çåå»º",charIndex:13674},{level:2,title:"6. ææ§½ ProcessorSlot",slug:"_6-ææ§½-processorslot",normalizedTitle:"6. ææ§½ processorslot",charIndex:18477}],headersStr:"1. èµæº ResourceWrapper 2. èç¹ Node 2.1 ç»è®¡èç¹ ï¼StatisticNode 2.2 æ®éèç¹ ï¼DefaultNode 2.3 å¥å£èç¹ ï¼EntranceNode 2.4 å¨å±èç¹ ï¼ClusterNode 3. æ ¹èç¹ Constants.ROOT 4. Entry 5. ä¸ä¸æ Context 5.1 Context çåå»º 6. ææ§½ ProcessorSlot",content:'# 1. èµæº ResourceWrapper\n\næ³è¦åéæµãçæ­ï¼ç®æ æ¯è°ï¼è¯å®æ¯èµæºãèµæºå¯ä»¥æ¯ä¸ä¸ªæ¹æ³ãä¸æ®µä»£ç ãä¸ä¸ªæ¥å£...\n\nSentinel ç»è®¡çæ°æ®ä»¥èµæºä¸ºç»´åº¦ï¼èµæºä½¿ç¨ ResourceWrapper è¡¨ç¤º\n\npublic abstract class ResourceWrapper {\n\t// èµæºå\n    protected final String name;\n\t// èç¹ç±»åï¼è¿å¥ææµåº\n    protected final EntryType entryType;\n    // èµæºç±»åï¼æ¯å¦MVCãDubboãgrpc..\n    protected final int resourceType;\n}\n\n\n * name ï¼èµæºå\n * entryType ï¼æ­¤èµæºè¡¨ç¤ºçèç¹çç±»åï¼å³æµå¥æµéè¿æ¯æµåºæµéï¼éä¿ä¸ç¹è¯´å°±æ¯åèµ·è¯·æ±è¿æ¯æ¥æ¶è¯·æ±ã\n * resourceType ï¼èµæºç±»åï¼Sentinel éæäºå¾å¤æ¡æ¶ï¼ä¸åçèµæºä¹é´è¿ä¼ç¸äºè°ç¨ï¼æä»¥è¦åæ¸æ¥ã\n\nEntryType æ¯ä¸ä¸ªæä¸¾ç±» ï¼\n\npublic enum EntryType {\n    IN("IN"),\n    OUT("OUT");\n}\n\n\nSentinel1.8.1 æ¯æç resourceType æä»¥ä¸å ç§ ï¼\n\npublic final class ResourceTypeConstants {\n\n    public static final int COMMON = 0;\n    public static final int COMMON_WEB = 1;\n    public static final int COMMON_RPC = 2;\n    public static final int COMMON_API_GATEWAY = 3;\n    public static final int COMMON_DB_SQL = 4;\n\n    private ResourceTypeConstants() {}\n}\n\n\n * COMMON ï¼ä¸éæä»»ä½æ¡æ¶\n * COMMON_WEB ï¼éæwebåºç¨çæ¥å£\n * COMMON_RPC ï¼rpcæ¥å£\n * COMMON_API_GATEWAY ï¼ç¨äº API GateWay ç½å³\n * COMMON_DB_SQL ï¼æ°æ®åºSQLæä½\n\nç»¼ä¸æè¿°ï¼Sentinel ä¸­çèµæºå¯è½çç±»åæ\n\n * è¿å¥ç¨åºçwebè¯·æ±\n * ç¨åºååºçrpcè¯·æ±\n * ç¨åºååºçsqlæä½\n * .......\n\n\n# 2. èç¹ Node\n\nSentinel ä¸­çæ¯ä¸ä¸ªèµæºé½å¯ä»¥æä¸ºä¸ä¸ª Nodeï¼è³äºæä¸ºåªä¸ä¸ª Node è¦çä½¿ç¨æåµã\n\nNode ä½ä¸º Sentinel ä¸­ææå®æ¶ç»è®¡æ°æ®çæ¥å£ï¼å®å®ä¹äºä¸ä¸ªèç¹æéè¦æä¾çåé¡¹ææ æ°æ®ç»è®¡åè½ï¼ä¸ºå¤é¨å±è½ç»è®¡æ°æ®çå®ç°ã\n\npublic interface Node extends OccupySupport, DebugSupport {\n    long totalRequest(); // è·åæ»çè¯·æ±æ°\n    long totalPass(); // è·åéè¿çè¯·æ±æ»æ°\n    long totalSuccess(); // è·åæåçè¯·æ±æ»æ°\n    long blockRequest(); // è·åè¢« Sentinel æç»çè¯·æ±æ»æ°\n    long totalException(); // è·åå¼å¸¸æ»æ°\n    double passQps(); // éè¿ QPS\n    double blockQps(); // æç» QPS\n    double totalQps(); // æ» qps\n    double successQps(); // æå qps\n    // æå¤§æåæ»æ° QPSï¼ä¾å¦ç§çº§æ»å¨çªå£çæ°ç»å¤§å°é»è®¤éç½®ä¸º 2ï¼ååæ°ç»ä¸­æå¤§ï¼\n    double maxSuccessQps(); \n    double exceptionQps(); // å¼å¸¸ QPS\n    double avgRt(); // å¹³åèæ¶\n    double minRt(); // æå°èæ¶\n    int curThreadNum(); // å½åå¹¶åå ç¨ççº¿ç¨æ°\n    double previousBlockQps(); // åä¸ä¸ªæ¶é´çªå£çè¢«æç» qps\n    double previousPassQps(); // åä¸ä¸ªæ¶é´çªå£çéè¿ qps\n    Map<Long, MetricNode> metrics(); \n    List<MetricNode> rawMetricsInMin(Predicate<Long> timePredicate);\n    void addPassRequest(int count); // æ·»å éè¿è¯·æ±æ°\n    void addRtAndSuccess(long rt, int success); // æ·»å æåè¯·æ±æ°ï¼å¹¶ä¸æ·»å å¤çæåçèæ¶\n    void increaseBlockQps(int count); // æ·»å è¢«æç»çè¯·æ±æ°\n    void increaseExceptionQps(int count); // æ·»å å¼å¸¸è¯·æ±æ°\n    void increaseThreadNum(); // èªå¢å ç¨çº¿ç¨\n    void decreaseThreadNum(); // èªåå ç¨çº¿ç¨\n    void reset(); // éç½®æ»å¨çªå£\n}\n\n\nä¸ºå¥ Node æ¯ä¸ä¸ªæ¥å£èä¸æ¯å®ç°ç±»ï¼å ä¸ºè¦å° Sentinel ä¸­ç âèç¹â æç§ç±»ååºåå¼ã\n\næ¯å¦æä¸ä¸ªèµæº ï¼aãbãc\n\nè¿ä¸ä¸ªèµæºæä»¥ä¸è°ç¨é¾ ï¼\n\na -> b -> c\n\nb -> c -> a\n\na -> b -> a\n\nå¨ä¸ä¸ªè°ç¨é¾ä¸­ï¼åä¸ä¸ªèç¹åå½äºä¸åçè§è²ï¼æ¯å¦ç¬¬ä¸ä¸ªè°ç¨é¾ä¸­ï¼a æ¢æ¯å¥å£èç¹ä¹æ¯æ®éèç¹ã\n\næä»¬ç»å®èµ·å ï¼å¥å£aãæ®éa\n\nåæ¶å¦æè¦ç»è®¡ âaâ è¿ä¸ªèµæºçæ»è®¿é®éæä¹åï¼é¾éè¦å°å¨é¨çå¥å£aãæ®éa ä¸ä¸ªä¸ä¸ªéåç¸å ï¼\n\nä¸ï¼åå»ºä¸ä¸ªå¨å± a ï¼æµéè¿å¥ å¥å£aãæ®éaæ¶å°ä¸ä»å°å¯¹åºçèç¹æµéå ä¸ï¼è¿å°å¨å±açæ°æ®ä¹å ä¸\n\nç°å¨æäºä¸ç§èç¹ï¼å®ä»¬é½æ¯ Node çå­ç±»ï¼\n\n * å¥å£èç¹ EntranceNode\n * æ®éèç¹ DefaultNode\n * å¨å±èç¹ ClusterNode\n\nSentinel å°è¿ä¸ç§èç¹çå±åå±æ§ ï¼ç»è®¡æ°æ®åè½ æ½ååºæ¥ä½ä¸ºå®ä»¬ä¸ä¸ªçç¶ç±» ï¼StatisticNodeãå³ç³»å¾å¦ä¸ï¼\n\n\n\n * Node ï¼æ½è±¡ç±»ï¼æä¾è§è\n * StatisticNode ï¼æä¾äºç»è®¡æ°æ®çåè½ã\n * DefaultNode ï¼æ®éèç¹\n * EntranceNode ï¼å¥å£èç¹\n * ClusterNode ï¼å¨å±èç¹ï¼ä¸ä¸ªèµæºåªè½æä¸ä¸ªå¨å±èç¹ã\n\nä¸ä¸ªèµæºå¯è½æå¤ä¸ªå¥å£èç¹ææ®éèç¹ï¼ä½æ¯åªè½æä¸ä¸ªå¨å±èç¹ãClusterNode ä¸ DefaultNode çå³ç³»æ¯ä¸å¯¹å¤ã\n\næ¥ä¸æ¥è¯¦ç»ä»ç»åç§ç±»åç Node\n\n\n# 2.1 ç»è®¡èç¹ ï¼StatisticNode\n\npublic class StatisticNode implements Node {\n    // ç§çº§æ»å¨çªå£ï¼2 ä¸ªæ¶é´çªå£å¤§å°ä¸º 500 æ¯«ç§ç Bucket\n    private transient volatile Metric rollingCounterInSecond = new ArrayMetric(2,1000);\n    // åéçº§æ»å¨çªå£ï¼60 ä¸ª Bucket æ°ç»ï¼æ¯ä¸ª Bucket ç»è®¡çæ¶é´çªå£å¤§å°ä¸º 1 ç§\n    private transient Metric rollingCounterInMinute = new ArrayMetric(60, 60 * 1000, false);\n    \n    // ç»è®¡å¹¶åä½¿ç¨ççº¿ç¨æ°ï¼å¯ä»¥æ ¹æ®çº¿ç¨æ°éæµã\n    private LongAdder curThreadNum = new LongAdder();\n    \n    // å®ç°äºä» Node ç»§æ¿è¿æ¥çå¶ä»ç»è®¡æ¹æ³ï¼è¿éåä¸¾å ä¸ªç®åç\n    \n    // ä¸åéåæåæ¾å¿çå¨é¨è¯·æ±æ°é\n    @Override\n    public long totalPass() {\n        return rollingCounterInMinute.pass();\n    }\n    \n    // æåæ¾è¡äºä¸ä¸ªè¯·æ±ï¼å ä¸ã\n    @Override\n    public void addPassRequest(int count) {\n        rollingCounterInSecond.addPass(count);\n        rollingCounterInMinute.addPass(count);\n    }\n\n    // ããããããå¶ä»çå°±ä¸æ¾äºï¼StatisticNodeå®ç°äºNodeçæææ½è±¡æ¹æ³ã\n}\n\n\nå¨ä¸è¬æåµä¸ï¼Sentinel ä½¿ç¨æ»å¨çªå£ç®æ³ç»è®¡ç»è¿æ¯ä¸ä¸ª Node çèµæºãæ»å¨çªå£ç®æ³ä¼å¨ä»¥åçæç« ä»ç»å°ã\n\néè¿å®ç° Node è§å®çæ¹æ³ï¼StatisticNode æä¾äºç»è®¡ç§çº§ãåéçº§æåè¯·æ±æ°ãå¤±è´¥è¯·æ±æ°ç­ç­åè½ã\n\nå½ç¶äºï¼ç°å¨ä¸ä¼è¿äºå¾æ­£å¸¸ï¼ä½ åªéè¦ç¥éï¼StatisticNode å¯ä»¥ç»è®¡æµéï¼ææç»§æ¿å®ç Node ï¼ä¹å°±æ¯ ClusterNodeãDefaultNodeãEntranceNode ä¹é½å¯ä»¥ç»è®¡æµéã\n\næ³¨æ ï¼StatisticNode åªæä¾ç»è®¡æ°æ®çåè½ï¼å®ä¸è¡¨ç¤ºä»»ä½èµæºã\n\n\n# 2.2 æ®éèç¹ ï¼DefaultNode\n\npublic class DefaultNode extends StatisticNode {\n\n    // è¿ä¸ªèç¹è¡¨ç¤ºçèµæº\n    private ResourceWrapper id;\n\n    // è¿ä¸ªèç¹çå¨é¨å­èç¹\n    private volatile Set<Node> childList = new HashSet<>();\n\t\n    // è¯¥èç¹å¯¹åºç ClusterNode\n    private ClusterNode clusterNode;\n\n\n    @Override\n    public void increaseBlockQps(int count) {\n        super.increaseBlockQps(count);\n        this.clusterNode.increaseBlockQps(count);\n    }\n\n    @Override\n    public void increaseExceptionQps(int count) {\n        super.increaseExceptionQps(count);\n        this.clusterNode.increaseExceptionQps(count);\n    }\n\n    @Override\n    public void addRtAndSuccess(long rt, int successCount) {\n        super.addRtAndSuccess(rt, successCount);\n        this.clusterNode.addRtAndSuccess(rt, successCount);\n    }\n\n    @Override\n    public void increaseThreadNum() {\n        super.increaseThreadNum();\n        this.clusterNode.increaseThreadNum();\n    }\n\n    @Override\n    public void decreaseThreadNum() {\n        super.decreaseThreadNum();\n        this.clusterNode.decreaseThreadNum();\n    }\n\n    @Override\n    public void addPassRequest(int count) {\n        super.addPassRequest(count);\n        this.clusterNode.addPassRequest(count);\n    }\n\n    public void printDefaultNode() {\n        visitTree(0, this);\n    }\n}\n\n\n * id ï¼è¿ä¸ªèç¹è¡¨ç¤ºçèµæºã\n * childList ï¼è¿ä¸ªèç¹çå¨é¨å­èç¹\n * clusterNode ï¼è¯¥èç¹å¯¹åºç ClusterNodeã\n\nèµæºä¸ DefaultNode ä¹é´æ¯ä¸å¯¹å¤çå³ç³»ãèµæºä¸ClusterNodeä¹é´æ¯ä¸å¯¹ä¸çå³ç³»ã\n\nä¸ä¸ª DefaultNode å¯ä»¥æå¤ä¸ªå­èç¹å½¢æå¦ä¸çç»æ ï¼\n\nï¼å¶å®æé¡¶ç«¯ç A ä¸æ¯ DefaultNodeï¼è¿éåªæ¯åä¸ä¸ªæ¯å»ï¼\n\n\n\nå¤ä¸ª DefaultNode å°±å½¢æäºä¸æ£µæ \n\næ³¨ ï¼äºè§£ Sentinel çå°±è½çåºæ¥è¿é¢æ è¿æå¾å¤ç¼ºé·ï¼ä½æ¯ç°å¨åªæ¯åä¸ä¸ªæ¯å»ã\n\nåæ¶ï¼éè¿æºç ä½ å¯è½çåºæ¥äºï¼DefaultNode å¨æ§è¡æ¾è¡è¯·æ±æ¹æ³æ¶å¦ä¸ï¼\n\n@Override\npublic void addRtAndSuccess(long rt, int successCount) {\n    super.addRtAndSuccess(rt, successCount);\n    this.clusterNode.addRtAndSuccess(rt, successCount);\n}\n\n\nåç»èªå·±çæ°æ®è®°å½ä¸ä¸ï¼åç»èªå·±æå±ç ClusterNode è®°å½ä¸ä¸ï¼è·å±ä»¬ä¹åè¯´çä¸æ ·ã\n\nåæ¬¡æé ï¼ææèç¹ç»è®¡æ°æ®æ¶é½è¦ä½¿ç¨ä» StatisticNode ç»§æ¿è¿æ¥çæ¹æ³ã\n\n\n# 2.3 å¥å£èç¹ ï¼EntranceNode\n\nå¥å£èç¹æ²¡æåéï¼åè½è¢« StatisticNode å®ç°äºï¼åéè¢« DefaultNode æ¥æäºï¼EntranceNode å°±ç¹å«ç®æ´äºï¼\n\npublic class EntranceNode extends DefaultNode {\n\n    public EntranceNode(ResourceWrapper id, ClusterNode clusterNode) {\n        super(id, clusterNode);\n    }\n}\n\n\nEntranceNode ä¸ DefaultNode çåºå«æ¯éå StatisticNode çæ¹æ³ä¸ä¸æ ·ã\n\nå¨è¿éå¯ä»¥å§éä¸ä¸ ï¼EntranceNode é½æ¯å·²ç»è§å®å¥½çèç¹ï¼å½åæ¹å¼æ ¹æ®éæçæ¡æ¶ååãæ¯å¦\n\n * ä¸éæä»»ä½æ¡æ¶æ¶ï¼EntranceNode.name = "sentinel_default_context"\n * éæSpring MVC æ¶ï¼EntranceNode.name = "sentinel_spring_web_context"\n\n\n# 2.4 å¨å±èç¹ ï¼ClusterNode\n\npublic class ClusterNode extends StatisticNode {\n\t// èç¹åï¼å³èµæºåï¼å¶å®åºè¯¥ä½¿ç¨ ResourceWrapperçï¼ä¸ç¥éè¿éä¸ºå¥ç¨äºString\n    private final String name;\n    // èµæºç±»å\n    private final int resourceType;\n\n    // ç»´æ¤æ¯ä¸ªè°ç¨æ¥æºçææ æ°æ®ç»è®¡æ°æ®ï¼StatisticNodeï¼\n    // å¨ ClusterNode é¨åä¼å·ä½è¯´ã\n    private Map<String, StatisticNode> originCountMap = new HashMap<>();\n    \n\t// æ§å¶å¹¶åä¿®æ¹ originCountMap ç¨çé\n    private final ReentrantLock lock = new ReentrantLock();\n}\n\n\n * name ï¼èµæºåï¼å¶å®åºè¯¥ä½¿ç¨ ResourceWrapperçï¼ä¸ç¥éè¿éä¸ºå¥ç¨äºString\n * resourceType ï¼èµæºç±»å\n * originCountMap ï¼ ç»´æ¤æ¯ä¸ªè°ç¨æ¥æºçææ æ°æ®ç»è®¡æ°æ®ï¼StatisticNodeï¼\n * lock ï¼æ§å¶å¹¶åä¿®æ¹ originCountMap ç¨çé\n\nå¶å®å®è¿æä¸ä¸ªæ¹æ³ç¨æ¥æä½ originCountMap ï¼\n\npublic Node getOrCreateOriginNode(String origin) {\n    StatisticNode statisticNode = originCountMap.get(origin);\n    if (statisticNode == null) {\n        lock.lock();\n        try {\n            statisticNode = originCountMap.get(origin);\n            if (statisticNode == null) {\n                statisticNode = new StatisticNode();\n                HashMap<String, StatisticNode> newMap = new HashMap<>(originCountMap.size() + 1);\n                newMap.putAll(originCountMap);\n                newMap.put(origin, statisticNode);\n                originCountMap = newMap;\n            }\n        } finally {\n            lock.unlock();\n        }\n    }\n    return statisticNode;\n}\n\n\nå·ä½æ¯å¥ææå¢ï¼è¯·çè¿ä¸ªå¾ï¼\n\n\n\nspringmvc æ¡æ¶ä¸­ç /hello1 éè¿ grpc è¿ç¨è°ç¨äº /hello2ï¼é£ä¹å¨ç»è®¡ /hello2 æ¶æ¯ä¸æ¯è¦æ æ¸æ¥ origin æ¯ hello1ï¼\n\næä»¥å°±éè¿ origin åå»ºä¸ä¸ª hello1 èç¹ï¼æ¾å¨ hello2 ç ClusterNode ç Map ä¸­ï¼æ³¨æï¼æ¾å¥çèç¹ç±»åä¸º StatisticNodeï¼ä¹å°±è¯´æè¿ä¸ªèç¹æ²¡æå®éæä¹ï¼åªè´è´£ç»è®¡ä¸ä¸æµéï¼æ¹ä¾¿åâæ¥æºéæµãå³èéæµâã\n\nå½ç¨æ·è¦å /hello1->/hello2 çæ¥æºéæµæ¶ï¼å° hello2 çæµéååºæ¥ï¼åå° hello2å¯¹åºç ClusterNode ä¸­ç»è®¡ç hello1 çæ°æ®ååºæ¥å°±å¯ä»¥å¤æ­æ¯å¦éæµäºã\n\n\n# 3. æ ¹èç¹ Constants.ROOT\n\nå¶å®æ´ä¸ªç¨åºç å¥å£èç¹æ¯åºå®çï¼å®å­æ¾å¨å¸¸éç±» Constants ä¸­ã\n\npublic final class Constants {\n    // é»è®¤contextçåç§°\n    public final static String CONTEXT_DEFAULT_NAME = "sentinel_default_context";\n    \n    // æ ¹èç¹\n    public final static DefaultNode ROOT = new EntranceNode(\n        new StringResourceWrapper(ROOT_ID, EntryType.IN),\n        new ClusterNode(ROOT_ID, ResourceTypeConstants.COMMON)\n    );\n    \n    // æ ¹èç¹å¯¹åºçå¨å±èç¹\n    public final static ClusterNode ENTRY_NODE = new ClusterNode(\n        TOTAL_IN_RESOURCE_NAME, \n        ResourceTypeConstants.COMMON\n    );\n\n}\n\n\næ ¹èç¹çç¬¬ä¸å±å­èç¹ï¼å³ EntranceNode ä¹æ¯åºå®çï¼è¿ä¸ªå¨åé¢å·²ç»å§éäº\n\nä¹å°±æ¯è¯´ï¼æ ¹èç¹åç¬¬ä¸å±èç¹é½æ¯åºå®çãåªæä»ç¬¬äºå±èç¹å¼å§ææ¯æä»¬çã\n\nï¼ä¸é¢æè¯´ç âç¬¬ä¸å±â æ¯æROOTèç¹ä¸çç¬¬ä¸å±ï¼åç»­å¨æå° EntranceNode æ¶é½ä¼æ âç¬¬ä¸å±â ä»£ç§°ï¼è¯·ä¸è¦è®¤ä¸ºæè¯´çç¬¬ä¸å±æ¯ROOTðï¼\n\néªè¯ä¸ä¸ï¼æä»¬ä¸éæä»»ä½ç¯å¢ï¼é£ä¹ ROOT ä¸ç¬¬ä¸ä¸ª EntranceNode å°±ä¸å®æ¯ sentinel_default_contextã\n\nå° abc å½ä½èµæºçè¯ï¼abcå°±ä¼æ¯ sentinel_default_context çå­èç¹ï¼\n\n\n\nï¼ä½¿ç¨ sentinel-demo/sentinel-demo-basic/flow/FlowQpsDemo æµè¯ç±»ï¼\n\néæäº web mvc æ¶ï¼ROOT çå­èç¹å°±æä¿©äºï¼\n\n\n\n(ä½¿ç¨ sentinel-demo/sentinel-demo-spring-webmvc/WebMvcTestController æµè¯ç±»ï¼éè¦èªå·±å ä¸ Constants.ROOT å» debug)\n\næ´æ°ä¸ä¸èç¹æ ï¼\n\n\n\nè¿æ ·åçå¥½å¤æ¯éæå¶ä»ç¯å¢æ¶å¾æ¹ä¾¿ï¼åå¤å°±æ¯ä¸å¥½çè§£\n\n\n# 4. Entry\n\nå¨è®¤è¯ èµæº å èç¹ ä¹åå°±è¯¥ Entry äºï¼Entryæ¯ç± èç¹+å¤çå¨é¾ ç»æã\n\nSentinel æä¾çæ¯éæµãçæ­åè½ï¼å·ä½æ¥è¯´å°±æ¯ç­ç¹éæµãç³»ç»éæµãæ¥æºéæµ.... è¿äºåè½éè¿è´£ä»»é¾æ¨¡å¼ç»æäºä¸ä¸ªå¤çå¨é¾ï¼ç±äºæ¯ä¸ä¸ªèµæºé½éè¦è¿è¡å¤æ­ï¼æ¯ä¸ä¸ªèµæºè¦çéæµè§åé½æå·®å«ï¼æä»¥æ¯ä¸ä¸ªèµæºé½è¦èµ°ä¸éå¤çå¨é¾ï¼Sentinel ä½¿ç¨ Entry å° èç¹åå¤çå¨é¾ å°è£èµ·æ¥ã\n\nå¨ Sentinel ä¸­ï¼å¤çå¨é¾ä¹å¯ä»¥ç§°ä¸ºè´£ä»»é¾ã\n\nå¬èµ·æ¥æ¯ä¸æ¯ç¹å«éº»ç¦ï¼ç¡®å®ï¼è¦åå°æ¯ä¸ä¸ªèµæºé½è¿è¡éæµç¡®å®ç¹å«éº»ç¦ã\n\npublic abstract class Entry implements AutoCloseable {\n    // åå»ºæ¶é´\n    private long createTime;\n    // å½åèç¹ï¼DefaultNodeï¼\n    private Node curNode;\n    // æ¥æºèç¹\n    private Node originNode;\n    // éè¯¯\n    private Throwable error;\n    // èµæºid\n    protected ResourceWrapper resourceWrapper;\n}\n\n\nCtEntry æ¯ Entry çç´æ¥å­ç±»ï¼åé¢åææºç æ¶ï¼æä»¬æè¯´ Entry çæ CtEntryãCtEntry ä¸­å£°æçå­æ®µä¿¡æ¯å¦ä¸ä»£ç æç¤ºã\n\nclass CtEntry extends Entry {\n    // å½å Entry æåçç¶ Entry\n    protected Entry parent = null;\n    // ç¶ Entry æåå½å Entry\n    protected Entry child = null;\n    // å½åèµæºç ProcessorSlotChainï¼è´£ä»»é¾æ¨¡å¼ï¼ä¹å°±æ¯å¾å¤æ¦æªå¨\n    protected ProcessorSlot<Object> chain;\n    // å½åä¸ä¸æ\n    protected Context context;\n}\n\n\nä¸ºå¥ Entry è¦å parentãchild å³ç³» ï¼å¨ Node ç« èä¸­æä»¬ä»ç»äºï¼å¤ä¸ª DefaultNode å¯ä»¥ç»ææ ï¼æä»¬ä¸æ¬¡åªéè¦ç»è®¡å½åä¸æ¡é¾è·¯ç Nodeï¼ä¹å°±æ¯ä¸ä¸ªé¾è¡¨ï¼æä»¥è¿ä¸ª parent å child å¶å®ä¹å¯ä»¥ç§°ä½ pre å nextã\n\n> æä¸ä¸ªç¹å«éè¦æ³¨æçç¹ ï¼å¥å£èç¹ï¼å³ EntranceNode ä¸ä¼è¢«å°è£ä¸º Entryã\n\nEntry æ¯ä¸æ¬¡è°ç¨å½¢æçè°ç¨é¾ä¸çèç¹ã\n\nè¿å¼ å¾æè¿°äºå¤ä¸ª Node çå³ç³»\n\n\n\nç°å¨æä»¬å° A -> B -> F è¿æ¡è°ç¨é¾æ¥ç»ä¸ä¸ Entry\n\n\n\nï¼å¤ä¸ªEntryæ¯ååé¾è¡¨ï¼å¤ä¸ªNodeæ¯æ ï¼\n\n> è¿éè¯·ä½ åæ¸ å¤çå¨é¾ å è°ç¨é¾ çåºå«ã\n> \n>  * æ¯ä¸ä¸ª Entry ç± Node + å¤çå¨é¾ ç»æ\n> \n>  * å¤ä¸ª Entry ç»æä¸ä¸ªè°ç¨é¾\n\nEntryæ¯å¥æ¶ååå»ºçãæä¹åå»ºçå¢ï¼ææçèµæºé½è¦å°è£ä¸º Entryï¼ç¶åå¨Entryåé¨çå¤çå¨é¾ä¸­å°è£ä¸ºNodeæå¨æ ä¸ã\n\nè°ç¨ SphU.entry(String entryName) å³å¯åå»º Entryãå¦æéæäºå¶ä»æ¡æ¶ï¼æ¯å¦SpringMVCï¼å¯ä»¥ä½¿ç¨AOPåå»ºã\n\nSphU.entry(String) æç»æ§è¡çå¦ä¸æ¹æ³ï¼\n\nprivate Entry entryWithPriority(ResourceWrapper resourceWrapper, \n                                int count, \n                                boolean prioritized, \n                                Object... args) throws BlockException {\n    // è·åå½åä¸ä¸æ\n    Context context = ContextUtil.getContext();\n    if (context instanceof NullContext) {\n        return new CtEntry(resourceWrapper, null, context);\n    }\n\t// å¦æ Context ä¸ºç©ºï¼ä½¿ç¨é»è®¤ Context. (å³nameä¸º sentinel_default_context çContext)\n    if (context == null) {\n        context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME);\n    }\n\n    // \n    if (!Constants.ON) {\n        return new CtEntry(resourceWrapper, null, context);\n    }\n\t// å è½½è°ç¨é¾\n    ProcessorSlot<Object> chain = lookProcessChain(resourceWrapper);\n\n    // å¦æå è½½çè´£ä»»é¾ä¸ºç©º\n    if (chain == null) {\n        return new CtEntry(resourceWrapper, null, context);\n    }\n\t// æ­£å¸¸æåµä¸ä¸é¢çä»£ç é½ä¸ä¼èµ°å°ï¼è¿éä¼çæ­£åå»ºä¸ä¸ª CtEntry.\n    Entry e = new CtEntry(resourceWrapper, chain, context, count, args);\n    try {\n        // å¼å§æ§è¡æ´ä¸ªè´£ä»»é¾\n        chain.entry(context, resourceWrapper, null, count, prioritized, args);\n    } catch (BlockException e1) {\n        e.exit(count, args);\n        throw e1;\n    } catch (Throwable e1) {\n        RecordLog.info("Sentinel unexpected exception", e1);\n    }\n    return e;\n}\n\n\nç°å¨ä¸ç¥éContextæ²¡äºï¼ä¸é¢å°±æ¯ãå¶å®ç´å° new CtEntry() ææ¯éç¹ï¼newåºEntryåç´æ¥æ§è¡ å¤çå¨é¾ï¼å¤çå¨é¾ä¸­æå¾å¤ä¸ªå¤çå¨ï¼æç»è®¡èµæºçãéæµçãçæ­ç...å¦æå¨å¤çå¨é¾çæ§è¡è¿ç¨ä¸­åºç°è¢«éæµãçæ­çå¼å¸¸ï¼å°±ä¼è¢«è¿ä¸ª BlockException æè·ä¸¢åºãä¸¢åºä¹åè¯å®è¦å° Entry éæ¯ã\n\n> Entry ä¸ Node çåºå«æ¯å¥å¢ï¼\n> \n> Nodeæå»ºä¹ååºæ¬ä¸ä¼å¨äºï¼é¤éç¨åºéå¯å®æºå¥çã\n> \n> Entryæ¯æ¬¡è¯·æ±é½ä¼æå»ºãå¤ä¸ªEntryå°±ç»æäºä¸æ¬¡è°ç¨é¾\n\n\n# 5. ä¸ä¸æ Context\n\nå¾å¤æ¡æ¶é½æä¸ä¸ªä¸ä¸æå¯¹è±¡ï¼Sentinel ä¹ä¸ä¾å¤ãSentinel ç ContextUtil ä½¿ç¨ ThreadLocal ææ Contextï¼Context å­å¨çä¿¡æ¯åæ¬ ï¼\n\npublic class Context {\n    // Contextçname\n    private final String name;\n    // æ­¤æ¬¡æ§è¡çå¥å£èç¹ï¼é½æ¯åºå®çROOTä¸çç¬¬ä¸å±èç¹ã\n    private DefaultNode entranceNode;\n    // ç°å¨æ§è¡å°åªä¸ªEntryäºã\n    private Entry curEntry;\n    private String origin = "";\n    \n    // æä»¬ä¸è®¨è®ºå¼æ­¥çæåµ\n    // private final boolean async;\n}\n\n\n * nameï¼Context çåç§°ã\n\n * entranceNodeï¼å½åè°ç¨æ çå¥å£èç¹ï¼ç±»åä¸º EntranceNodeãè¿ä¸ªNodeæ¯è¾åºå®ï¼é½æ¯ç¬¬ä¸å±èç¹ã\n   \n   è¿ä¸ªèç¹è½ç¶ä¼å¨ context ä¸­ï¼ä½å®ä¸ä¼å¨ Entry ä¸­ï¼å ä¸ºä¸åä¸æ§è¡ï¼åªåä¸ç»è®¡ã\n\n * curEntryï¼å½å Entryï¼CtEntryï¼ï¼åå«å½åæ§è¡ç node\n\n * originï¼è°ç¨æ¥æºçåç§°ï¼å³æå¡æ¶è´¹èçåç§°æèæå¡æ¶è´¹èçæ¥æº IPï¼åå³äºæå¡æ¶è´¹èæ¯å¦ä½¿ç¨ Sentinelï¼ç± Sentinel ééå±ä¼ éè¿æ¥ãä¾å¦ï¼æå¡æä¾èæ¯ Spring MVC åºç¨ï¼ä¸æå¡æä¾èä½¿ç¨ Sentinel ç Web MVC ééï¼é£ä¹ Sentinel ä¼å°è¯ä»è¯·æ±å¤´è·åâS-userâï¼å¦ææå¡æ¶è´¹èæå¨è¯·æ±å¤´ä¼ éè¿ä¸ªåæ°ï¼é£ä¹å°±è½å¤è·åå°ã\n\npublic class ContextUtil {\n    // ææ Context\n    private static ThreadLocal<Context> contextHolder = new ThreadLocal<>();\n    // ææææ EntranceNodeï¼å³ææç¬¬ä¸å±Node.\n    // å¯è½åå«ç: defaultãmvcãokhttpãgrpcãdubbo...\n    private static volatile Map<String, DefaultNode> contextNameNodeMap = new HashMap<>();\n    // å¦æå½åç¯å¢(mvcãdubboãgrpc) è¿æ²¡ææç¬¬ä¸å±èç¹æ³¨åå° contextNameNodeMapï¼é£ä¹å°±å éå¼å§æ³¨å\n    private static final ReentrantLock LOCK = new ReentrantLock();\n}\n\n\nè¿éè¦çéè¯´ä¸ä¸ contextNameNodeMapã\n\nContextUtil ä¼å°ææç¬¬ä¸å±èç¹å­å¨å¨ contextNameNodeMap ä¸­ï¼ä»åå­ä¹å¯ä»¥çåºæ¥è¿ä¸ªMapéé¢å­å¨çæ¯ä»¥ context.name å½åç node\n\n\n# 5.1 Context çåå»º\n\nå½ ContextUtil ç±»å è½½çæ¶åä¼æ§è¡éæä»£ç åï¼åå§åä¸ä¸ªé»è®¤çEntranceNode ï¼sentinel_default_context æ¾å¥ contextNameNodeMap ä¸­ã\n\nstatic {\n    // Cache the entrance node for default context.\n    initDefaultContext();\n}\n\nprivate static void initDefaultContext() {\n    String defaultContextName = Constants.CONTEXT_DEFAULT_NAME;\n    EntranceNode node = new EntranceNode(new StringResourceWrapper(defaultContextName, EntryType.IN), null);\n    // å°æ­¤å¥å£èç¹æå¨ ROOT ä¸é¢ã\n    Constants.ROOT.addChild(node);\n    contextNameNodeMap.put(defaultContextName, node);\n}\n\n\næä»¥å¨åä»£ç çæ¶å contextNameNodeMap ä¸­å°±å·²ç»æäºä¸ä¸ª EntranceNode äºãå½ç¶è¿æ¯é¢å¤è¯äºï¼æä»¬è¦è¯´çæ¯ Context çåå»ºãè½ç¶æå®äº EntranceNode ä½æ¯å¹¶æªç» EntranceNode åå»º Entryï¼æä»¥ EntranceNode ä¸ä¼åä¸æ§è¡ã\n\nContextUtil.enter(String contextName) å¯ä»¥åå»ºä¸ä¸ª Context\n\n// æ¾å¼åå»º Context\nContextUtil.enter("sentinel_default_context");\nEntry entry = null;\ntry {\n     // åå»ºèµæºå¯¹åºç entry\n     entry = SphU.entry("/user/get", EntryType.IN);\n     // æ§è¡ä¸å¡æ¹æ³\n     return doBusiness();\n} catch (Exception e) {\n     if (!(e instanceof BlockException)) {\n          Tracer.trace(e);\n     }\n     throw e;\n} finally {\n     if (entry != null) {\n         // éæ¯æ­¤entry, ä¼å° Context.curEntryæ¹ä¸ºentry.parent\n         entry.exit(1);\n     }\n     // éæ¯ Context\n     ContextUtil.exit();\n}\n\n\nContext é½æ¯ç± ContextUtil æ¾å¼åå»ºï¼ ContextUtil.enter(String contextName) æç»æ§è¡çé»è¾ ï¼\n\n// name : ContextName, Contextçåç§°\n// origin : æ¥æºï¼æ¯å¦éè¿ rpcè°ç¨æ¶ï¼rpcæå¡æä¾èçoriginå°±æ¯æå¡è°ç¨è\nprotected static Context trueEnter(String name, String origin) {\n    // ä» ContextHolder ä¸­å Contextï¼å¦æåä¸å°å°±åå»ºã\n    // è¿éä¹æ¯æä»¬ç¬¬ä¸ä¸ªçå° Sentinel ä½¿ç¨åéæ£æ¥éæºå¶ï¼åé¢è¿ä¼æå¾å¤æ¬¡ã\n    Context context = contextHolder.get();\n    if (context == null) {\n        // contextNameNodeMap æ¯æ¥æç¬¬ä¸å±èç¹çMap\n        // æ¯å¦ sentinel_default_context - EntranceNode\n        Map<String, DefaultNode> localCacheNameMap = contextNameNodeMap;\n        \n        // å¦ææ ¹æ®context name æ æ³æ¾å°ç¬¬ä¸å±Nodeï¼è¯´æå½åç¯å¢(mvcãdubboãgrpc...) è¿æ²¡ææç¬¬ä¸å±èç¹æ³¨åå° contextNameNodeMap\n    \t// é£ä¹å°±å éå¼å§æ³¨å\n        DefaultNode node = localCacheNameMap.get(name);\n        // ç¬¬ä¸æ¬¡æ£æ¥\n        if (node == null) {\n            // å¦æç¬¬ä¸å±èç¹å¤ªå¤äºï¼è¿åä¸ä¸ª NullContext\n            if (localCacheNameMap.size() > Constants.MAX_CONTEXT_NAME_SIZE) {\n                setNullContext();\n                return NULL_CONTEXT;\n            } else {\n                // å é\n                LOCK.lock();\n                try {\n                    node = contextNameNodeMap.get(name);\n                    // ç¬¬äºæ¬¡\n                    if (node == null) {\n                        if (contextNameNodeMap.size() > Constants.MAX_CONTEXT_NAME_SIZE) {\n                            setNullContext();\n                            return NULL_CONTEXT;\n                        } else {\n                            // è¿ä¸ªèç¹è¯å®æ¯å¥å£èç¹\n                            node = new EntranceNode(new StringResourceWrapper(name, EntryType.IN), null);\n                            // å°å¥å£èç¹å å¥å°ROOTä¸é¢\n                            Constants.ROOT.addChild(node);\n\t\t\t\t\t\t\t// æ¿æ¢æ´æ°ä¸ä¸contextNameNodeMap\n                            Map<String, DefaultNode> newMap = new HashMap<>(contextNameNodeMap.size() + 1);\n                            newMap.putAll(contextNameNodeMap);\n                            newMap.put(name, node);\n                            contextNameNodeMap = newMap;\n                        }\n                    }\n                } finally {\n                    LOCK.unlock();\n                }\n            }\n        }\n        // ä¸é¢çé»è¾æ¯åå»ºROOTä¸çç¬¬ä¸å±èç¹ï¼ä¸ç®¡æ¯å¦éè¦åå»º EntranceNode ï¼åæ­£Context æ¯ä¸å®è¦çã\n        context = new Context(node, name);\n        // ä¸è¬æ¥è¯´ origin ä¸ºç©ºï¼ä½æ¯åè¢«è°ç¨çrpcæå¡ï¼originå°±æ¯è°ç¨æ¥æº\n        context.setOrigin(origin);\n        // å°æ­¤contextè®¾ç½®å° ContextHolderä¸­\n        contextHolder.set(context);\n    }\n\n    return context;\n}\n\n\nåå»ºContextä»æ´ä½ä¸çå°±ä¸¤æ­¥ ï¼\n\n * å¦æè¿ä¸ªcontextæ²¡æå¨ mapä¸­æ³¨åè¿ï¼å°±æ³¨åä¸ä¸\n * åå»ºcontextï¼æå®æ­¤ Context ç EntranceNode\n\néå¤ï¼åå»º context æ¶å¹¶æ²¡æç» EntranceNode åå»ºå¯¹åºç Entry å¦ï¼æä»¥ EntranceNode ä¸ä¼åä¸æ§è¡ã\n\néæ springmvcæ¡æ¶æ¶ï¼Sentinel å¨ HandlerInterceptor ä¸­åå»º Context ï¼ç¸åºçä»£ç å¨ sentinel-adapter/sentinel-spring-webmvc-adapterä¸­\n\n@Override\npublic boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n    // éè¿å­ç±»çå®ç°ï¼è·åèµæºåï¼å¦ "/user/{id}"\n    String resourceName = getResourceName(request);\n    // å¯¹èµæºåè¿è¡å¤ç©ºå¥çæä½ï¼çç¥æç´æ¥è¿å¥æ ¸å¿ä»£ç \n\n    // è§£æè°ç¨æ¥æº\n    String origin = parseOrigin(request);\n    // è·åcontext name, å¼å§åå»ºä¸ä¸æ\n    String contextName = "sentinel_spring_web_context";\n    ContextUtil.enter(contextName, origin);\n    // åå»ºEntry\n    Entry entry = SphU.entry(resourceName, ResourceTypeConstants.COMMON_WEB, EntryType.IN);\n    // å°entryæ¾å¥è¯·æ±åä¸­ï¼ä»¥ä¾¿å¨ afterCompletion ä¸­ä½¿ç¨\n    request.setAttribute(baseWebMvcConfig.getRequestAttributeName(), entry);\n    return true;\n}\n\n\næ»ç»ä¸ä¸ ï¼\n\n * ROOT å¹¶ä¸åä¸ Context çæå»ºï¼ä¹ä¸åä¸Entryçæ§è¡ã\n * EntranceNode åä¸ Context çåå»ºï¼ä½æ¯ EntranceNode ä¸ä¼åä¸ Entry çæ§è¡\n * Entry æ¯è°ç¨é¾\n\nç°å¨æä»¬çNodeæ å°±å¯ä»¥åä¸ºè¿æ · ï¼\n\n\n\n\n# 6. ææ§½ ProcessorSlot\n\nProcessorSlot ç´è¯å°±æ¯å¤çå¨ææ§½ï¼æ¯ Sentinel å®ç°éæµéçº§ãçæ­éçº§ãç³»ç»èªéåºéçº§ç­åè½çåå¥ç¹ãSentinel æä¾ç ProcessorSlot å¯ä»¥åä¸ºä¸¤ç±»ï¼ä¸ç±»æ¯è¾å©å®æèµæºææ æ°æ®ç»è®¡çåå¥ç¹ï¼ä¸ç±»æ¯å®ç°éçº§åè½çåå¥ç¹ã\n\nè¾å©èµæºææ æ°æ®ç»è®¡ç ProcessorSlotï¼\n\n * NodeSelectorSlotï¼ä¸ºå½åèµæºåå»º DefaultNodeï¼å¹¶ä¸å° DefaultNode èµå¼ç» Context.curEntry.curNodeï¼\n   \n   å¦ææ­¤ DefaultNode æ¯å½åè°ç¨é¾è·¯ä¸ç¬¬äºä¸ªNodeï¼å ä¸ºç¬¬ä¸ä¸ª Node æ¯åºå®çï¼ï¼å°è¯¥ DefaultNode æ·»å å°ç Context.entranceNode çå­èç¹ï¼å¦åæ·»å å° Context.curEntry.parent çå­èç¹ï¼childListï¼ãæç¹æ½è±¡ï¼æä»¬å¨åæ NodeSelectorSlot æºç æ¶åè¯¦ç»ä»ç»ã\n\n * ClusterBuilderSlotï¼å¦æå½åèµæºæªåå»º ClusterNodeï¼åä¸ºèµæºåå»º ClusterNodeï¼å° ClusterNode èµå¼ç»å½åèµæºç DefaultNode.clusterNodeï¼å¦æè°ç¨æ¥æºï¼originï¼ä¸ä¸ºç©ºï¼åä¸ºè°ç¨æ¥æºåå»º StatisticNodeï¼ç¨äºå®ç°æè°ç¨æ¥æºç»è®¡èµæºçææ æ°æ®ï¼ClusterNode æææ¯ä¸ªè°ç¨æ¥æºç StatisticNodeã\n\n * StatisticSlotï¼è¿æ¯ Sentinel æä¸ºéè¦çç±»ä¹ä¸ï¼ç¨äºå®ç°ææ æ°æ®ç»è®¡ãåæ¯è°ç¨åç»­ç ProcessorSlot#entry å¤æ­æ¯å¦æ¾è¡è¯·æ±ï¼åæ ¹æ®å¤æ­ç»æè¿è¡ç¸åºçææ æ°æ®ç»è®¡æä½ã\n\nå®ç°éçº§åè½ç ProcessorSlotï¼\n\n * AuthoritySlotï¼å®ç°é»ç½ååéçº§\n * SystemSlotï¼å®ç°ç³»ç»èªéåºéçº§\n * FlowSlotï¼å®ç°éæµéçº§\n * DegradeSlotï¼å®ç°çæ­éçº§\n\nSentinel ä½¿ç¨è´£ä»»é¾æ¨¡å¼å°è¿äºææ§½ç»æäºæ¦æªå¨é¾æ¡ï¼ä¹åæä»¬ç§° ProcessorSlot ä¸ºæ¦æªå¨ï¼ç°å¨è¦æ¹å£ä¸ºææ§½äº\n\n * ProcessorSlot ï¼ææ§½ï¼æ¯ä¸ä¸ªææ§½æä¸åçåè½ï¼æ¯å¦ç³»ç»éæµãé»ç½ååéæµãçæ­éçº§ã\n * ProcessorSlotChain ï¼åå«å¤´ææ§½åå°¾ææ§½ï¼å°ææææ§½ç»æææ§½é¾æ§è¡ã\n\nå³äºæ¯ä¸ª ProcessorSlot æ¯å¦ä½ç»æé¾è¡¨ãå¦ä½å®ç°çåè½ï¼å°å¨åç»­æç« è¯¦ç»åæã',normalizedContent:'# 1. èµæº resourcewrapper\n\næ³è¦åéæµãçæ­ï¼ç®æ æ¯è°ï¼è¯å®æ¯èµæºãèµæºå¯ä»¥æ¯ä¸ä¸ªæ¹æ³ãä¸æ®µä»£ç ãä¸ä¸ªæ¥å£...\n\nsentinel ç»è®¡çæ°æ®ä»¥èµæºä¸ºç»´åº¦ï¼èµæºä½¿ç¨ resourcewrapper è¡¨ç¤º\n\npublic abstract class resourcewrapper {\n\t// èµæºå\n    protected final string name;\n\t// èç¹ç±»åï¼è¿å¥ææµåº\n    protected final entrytype entrytype;\n    // èµæºç±»åï¼æ¯å¦mvcãdubboãgrpc..\n    protected final int resourcetype;\n}\n\n\n * name ï¼èµæºå\n * entrytype ï¼æ­¤èµæºè¡¨ç¤ºçèç¹çç±»åï¼å³æµå¥æµéè¿æ¯æµåºæµéï¼éä¿ä¸ç¹è¯´å°±æ¯åèµ·è¯·æ±è¿æ¯æ¥æ¶è¯·æ±ã\n * resourcetype ï¼èµæºç±»åï¼sentinel éæäºå¾å¤æ¡æ¶ï¼ä¸åçèµæºä¹é´è¿ä¼ç¸äºè°ç¨ï¼æä»¥è¦åæ¸æ¥ã\n\nentrytype æ¯ä¸ä¸ªæä¸¾ç±» ï¼\n\npublic enum entrytype {\n    in("in"),\n    out("out");\n}\n\n\nsentinel1.8.1 æ¯æç resourcetype æä»¥ä¸å ç§ ï¼\n\npublic final class resourcetypeconstants {\n\n    public static final int common = 0;\n    public static final int common_web = 1;\n    public static final int common_rpc = 2;\n    public static final int common_api_gateway = 3;\n    public static final int common_db_sql = 4;\n\n    private resourcetypeconstants() {}\n}\n\n\n * common ï¼ä¸éæä»»ä½æ¡æ¶\n * common_web ï¼éæwebåºç¨çæ¥å£\n * common_rpc ï¼rpcæ¥å£\n * common_api_gateway ï¼ç¨äº api gateway ç½å³\n * common_db_sql ï¼æ°æ®åºsqlæä½\n\nç»¼ä¸æè¿°ï¼sentinel ä¸­çèµæºå¯è½çç±»åæ\n\n * è¿å¥ç¨åºçwebè¯·æ±\n * ç¨åºååºçrpcè¯·æ±\n * ç¨åºååºçsqlæä½\n * .......\n\n\n# 2. èç¹ node\n\nsentinel ä¸­çæ¯ä¸ä¸ªèµæºé½å¯ä»¥æä¸ºä¸ä¸ª nodeï¼è³äºæä¸ºåªä¸ä¸ª node è¦çä½¿ç¨æåµã\n\nnode ä½ä¸º sentinel ä¸­ææå®æ¶ç»è®¡æ°æ®çæ¥å£ï¼å®å®ä¹äºä¸ä¸ªèç¹æéè¦æä¾çåé¡¹ææ æ°æ®ç»è®¡åè½ï¼ä¸ºå¤é¨å±è½ç»è®¡æ°æ®çå®ç°ã\n\npublic interface node extends occupysupport, debugsupport {\n    long totalrequest(); // è·åæ»çè¯·æ±æ°\n    long totalpass(); // è·åéè¿çè¯·æ±æ»æ°\n    long totalsuccess(); // è·åæåçè¯·æ±æ»æ°\n    long blockrequest(); // è·åè¢« sentinel æç»çè¯·æ±æ»æ°\n    long totalexception(); // è·åå¼å¸¸æ»æ°\n    double passqps(); // éè¿ qps\n    double blockqps(); // æç» qps\n    double totalqps(); // æ» qps\n    double successqps(); // æå qps\n    // æå¤§æåæ»æ° qpsï¼ä¾å¦ç§çº§æ»å¨çªå£çæ°ç»å¤§å°é»è®¤éç½®ä¸º 2ï¼ååæ°ç»ä¸­æå¤§ï¼\n    double maxsuccessqps(); \n    double exceptionqps(); // å¼å¸¸ qps\n    double avgrt(); // å¹³åèæ¶\n    double minrt(); // æå°èæ¶\n    int curthreadnum(); // å½åå¹¶åå ç¨ççº¿ç¨æ°\n    double previousblockqps(); // åä¸ä¸ªæ¶é´çªå£çè¢«æç» qps\n    double previouspassqps(); // åä¸ä¸ªæ¶é´çªå£çéè¿ qps\n    map<long, metricnode> metrics(); \n    list<metricnode> rawmetricsinmin(predicate<long> timepredicate);\n    void addpassrequest(int count); // æ·»å éè¿è¯·æ±æ°\n    void addrtandsuccess(long rt, int success); // æ·»å æåè¯·æ±æ°ï¼å¹¶ä¸æ·»å å¤çæåçèæ¶\n    void increaseblockqps(int count); // æ·»å è¢«æç»çè¯·æ±æ°\n    void increaseexceptionqps(int count); // æ·»å å¼å¸¸è¯·æ±æ°\n    void increasethreadnum(); // èªå¢å ç¨çº¿ç¨\n    void decreasethreadnum(); // èªåå ç¨çº¿ç¨\n    void reset(); // éç½®æ»å¨çªå£\n}\n\n\nä¸ºå¥ node æ¯ä¸ä¸ªæ¥å£èä¸æ¯å®ç°ç±»ï¼å ä¸ºè¦å° sentinel ä¸­ç âèç¹â æç§ç±»ååºåå¼ã\n\næ¯å¦æä¸ä¸ªèµæº ï¼aãbãc\n\nè¿ä¸ä¸ªèµæºæä»¥ä¸è°ç¨é¾ ï¼\n\na -> b -> c\n\nb -> c -> a\n\na -> b -> a\n\nå¨ä¸ä¸ªè°ç¨é¾ä¸­ï¼åä¸ä¸ªèç¹åå½äºä¸åçè§è²ï¼æ¯å¦ç¬¬ä¸ä¸ªè°ç¨é¾ä¸­ï¼a æ¢æ¯å¥å£èç¹ä¹æ¯æ®éèç¹ã\n\næä»¬ç»å®èµ·å ï¼å¥å£aãæ®éa\n\nåæ¶å¦æè¦ç»è®¡ âaâ è¿ä¸ªèµæºçæ»è®¿é®éæä¹åï¼é¾éè¦å°å¨é¨çå¥å£aãæ®éa ä¸ä¸ªä¸ä¸ªéåç¸å ï¼\n\nä¸ï¼åå»ºä¸ä¸ªå¨å± a ï¼æµéè¿å¥ å¥å£aãæ®éaæ¶å°ä¸ä»å°å¯¹åºçèç¹æµéå ä¸ï¼è¿å°å¨å±açæ°æ®ä¹å ä¸\n\nç°å¨æäºä¸ç§èç¹ï¼å®ä»¬é½æ¯ node çå­ç±»ï¼\n\n * å¥å£èç¹ entrancenode\n * æ®éèç¹ defaultnode\n * å¨å±èç¹ clusternode\n\nsentinel å°è¿ä¸ç§èç¹çå±åå±æ§ ï¼ç»è®¡æ°æ®åè½ æ½ååºæ¥ä½ä¸ºå®ä»¬ä¸ä¸ªçç¶ç±» ï¼statisticnodeãå³ç³»å¾å¦ä¸ï¼\n\n\n\n * node ï¼æ½è±¡ç±»ï¼æä¾è§è\n * statisticnode ï¼æä¾äºç»è®¡æ°æ®çåè½ã\n * defaultnode ï¼æ®éèç¹\n * entrancenode ï¼å¥å£èç¹\n * clusternode ï¼å¨å±èç¹ï¼ä¸ä¸ªèµæºåªè½æä¸ä¸ªå¨å±èç¹ã\n\nä¸ä¸ªèµæºå¯è½æå¤ä¸ªå¥å£èç¹ææ®éèç¹ï¼ä½æ¯åªè½æä¸ä¸ªå¨å±èç¹ãclusternode ä¸ defaultnode çå³ç³»æ¯ä¸å¯¹å¤ã\n\næ¥ä¸æ¥è¯¦ç»ä»ç»åç§ç±»åç node\n\n\n# 2.1 ç»è®¡èç¹ ï¼statisticnode\n\npublic class statisticnode implements node {\n    // ç§çº§æ»å¨çªå£ï¼2 ä¸ªæ¶é´çªå£å¤§å°ä¸º 500 æ¯«ç§ç bucket\n    private transient volatile metric rollingcounterinsecond = new arraymetric(2,1000);\n    // åéçº§æ»å¨çªå£ï¼60 ä¸ª bucket æ°ç»ï¼æ¯ä¸ª bucket ç»è®¡çæ¶é´çªå£å¤§å°ä¸º 1 ç§\n    private transient metric rollingcounterinminute = new arraymetric(60, 60 * 1000, false);\n    \n    // ç»è®¡å¹¶åä½¿ç¨ççº¿ç¨æ°ï¼å¯ä»¥æ ¹æ®çº¿ç¨æ°éæµã\n    private longadder curthreadnum = new longadder();\n    \n    // å®ç°äºä» node ç»§æ¿è¿æ¥çå¶ä»ç»è®¡æ¹æ³ï¼è¿éåä¸¾å ä¸ªç®åç\n    \n    // ä¸åéåæåæ¾å¿çå¨é¨è¯·æ±æ°é\n    @override\n    public long totalpass() {\n        return rollingcounterinminute.pass();\n    }\n    \n    // æåæ¾è¡äºä¸ä¸ªè¯·æ±ï¼å ä¸ã\n    @override\n    public void addpassrequest(int count) {\n        rollingcounterinsecond.addpass(count);\n        rollingcounterinminute.addpass(count);\n    }\n\n    // ããããããå¶ä»çå°±ä¸æ¾äºï¼statisticnodeå®ç°äºnodeçæææ½è±¡æ¹æ³ã\n}\n\n\nå¨ä¸è¬æåµä¸ï¼sentinel ä½¿ç¨æ»å¨çªå£ç®æ³ç»è®¡ç»è¿æ¯ä¸ä¸ª node çèµæºãæ»å¨çªå£ç®æ³ä¼å¨ä»¥åçæç« ä»ç»å°ã\n\néè¿å®ç° node è§å®çæ¹æ³ï¼statisticnode æä¾äºç»è®¡ç§çº§ãåéçº§æåè¯·æ±æ°ãå¤±è´¥è¯·æ±æ°ç­ç­åè½ã\n\nå½ç¶äºï¼ç°å¨ä¸ä¼è¿äºå¾æ­£å¸¸ï¼ä½ åªéè¦ç¥éï¼statisticnode å¯ä»¥ç»è®¡æµéï¼ææç»§æ¿å®ç node ï¼ä¹å°±æ¯ clusternodeãdefaultnodeãentrancenode ä¹é½å¯ä»¥ç»è®¡æµéã\n\næ³¨æ ï¼statisticnode åªæä¾ç»è®¡æ°æ®çåè½ï¼å®ä¸è¡¨ç¤ºä»»ä½èµæºã\n\n\n# 2.2 æ®éèç¹ ï¼defaultnode\n\npublic class defaultnode extends statisticnode {\n\n    // è¿ä¸ªèç¹è¡¨ç¤ºçèµæº\n    private resourcewrapper id;\n\n    // è¿ä¸ªèç¹çå¨é¨å­èç¹\n    private volatile set<node> childlist = new hashset<>();\n\t\n    // è¯¥èç¹å¯¹åºç clusternode\n    private clusternode clusternode;\n\n\n    @override\n    public void increaseblockqps(int count) {\n        super.increaseblockqps(count);\n        this.clusternode.increaseblockqps(count);\n    }\n\n    @override\n    public void increaseexceptionqps(int count) {\n        super.increaseexceptionqps(count);\n        this.clusternode.increaseexceptionqps(count);\n    }\n\n    @override\n    public void addrtandsuccess(long rt, int successcount) {\n        super.addrtandsuccess(rt, successcount);\n        this.clusternode.addrtandsuccess(rt, successcount);\n    }\n\n    @override\n    public void increasethreadnum() {\n        super.increasethreadnum();\n        this.clusternode.increasethreadnum();\n    }\n\n    @override\n    public void decreasethreadnum() {\n        super.decreasethreadnum();\n        this.clusternode.decreasethreadnum();\n    }\n\n    @override\n    public void addpassrequest(int count) {\n        super.addpassrequest(count);\n        this.clusternode.addpassrequest(count);\n    }\n\n    public void printdefaultnode() {\n        visittree(0, this);\n    }\n}\n\n\n * id ï¼è¿ä¸ªèç¹è¡¨ç¤ºçèµæºã\n * childlist ï¼è¿ä¸ªèç¹çå¨é¨å­èç¹\n * clusternode ï¼è¯¥èç¹å¯¹åºç clusternodeã\n\nèµæºä¸ defaultnode ä¹é´æ¯ä¸å¯¹å¤çå³ç³»ãèµæºä¸clusternodeä¹é´æ¯ä¸å¯¹ä¸çå³ç³»ã\n\nä¸ä¸ª defaultnode å¯ä»¥æå¤ä¸ªå­èç¹å½¢æå¦ä¸çç»æ ï¼\n\nï¼å¶å®æé¡¶ç«¯ç a ä¸æ¯ defaultnodeï¼è¿éåªæ¯åä¸ä¸ªæ¯å»ï¼\n\n\n\nå¤ä¸ª defaultnode å°±å½¢æäºä¸æ£µæ \n\næ³¨ ï¼äºè§£ sentinel çå°±è½çåºæ¥è¿é¢æ è¿æå¾å¤ç¼ºé·ï¼ä½æ¯ç°å¨åªæ¯åä¸ä¸ªæ¯å»ã\n\nåæ¶ï¼éè¿æºç ä½ å¯è½çåºæ¥äºï¼defaultnode å¨æ§è¡æ¾è¡è¯·æ±æ¹æ³æ¶å¦ä¸ï¼\n\n@override\npublic void addrtandsuccess(long rt, int successcount) {\n    super.addrtandsuccess(rt, successcount);\n    this.clusternode.addrtandsuccess(rt, successcount);\n}\n\n\nåç»èªå·±çæ°æ®è®°å½ä¸ä¸ï¼åç»èªå·±æå±ç clusternode è®°å½ä¸ä¸ï¼è·å±ä»¬ä¹åè¯´çä¸æ ·ã\n\nåæ¬¡æé ï¼ææèç¹ç»è®¡æ°æ®æ¶é½è¦ä½¿ç¨ä» statisticnode ç»§æ¿è¿æ¥çæ¹æ³ã\n\n\n# 2.3 å¥å£èç¹ ï¼entrancenode\n\nå¥å£èç¹æ²¡æåéï¼åè½è¢« statisticnode å®ç°äºï¼åéè¢« defaultnode æ¥æäºï¼entrancenode å°±ç¹å«ç®æ´äºï¼\n\npublic class entrancenode extends defaultnode {\n\n    public entrancenode(resourcewrapper id, clusternode clusternode) {\n        super(id, clusternode);\n    }\n}\n\n\nentrancenode ä¸ defaultnode çåºå«æ¯éå statisticnode çæ¹æ³ä¸ä¸æ ·ã\n\nå¨è¿éå¯ä»¥å§éä¸ä¸ ï¼entrancenode é½æ¯å·²ç»è§å®å¥½çèç¹ï¼å½åæ¹å¼æ ¹æ®éæçæ¡æ¶ååãæ¯å¦\n\n * ä¸éæä»»ä½æ¡æ¶æ¶ï¼entrancenode.name = "sentinel_default_context"\n * éæspring mvc æ¶ï¼entrancenode.name = "sentinel_spring_web_context"\n\n\n# 2.4 å¨å±èç¹ ï¼clusternode\n\npublic class clusternode extends statisticnode {\n\t// èç¹åï¼å³èµæºåï¼å¶å®åºè¯¥ä½¿ç¨ resourcewrapperçï¼ä¸ç¥éè¿éä¸ºå¥ç¨äºstring\n    private final string name;\n    // èµæºç±»å\n    private final int resourcetype;\n\n    // ç»´æ¤æ¯ä¸ªè°ç¨æ¥æºçææ æ°æ®ç»è®¡æ°æ®ï¼statisticnodeï¼\n    // å¨ clusternode é¨åä¼å·ä½è¯´ã\n    private map<string, statisticnode> origincountmap = new hashmap<>();\n    \n\t// æ§å¶å¹¶åä¿®æ¹ origincountmap ç¨çé\n    private final reentrantlock lock = new reentrantlock();\n}\n\n\n * name ï¼èµæºåï¼å¶å®åºè¯¥ä½¿ç¨ resourcewrapperçï¼ä¸ç¥éè¿éä¸ºå¥ç¨äºstring\n * resourcetype ï¼èµæºç±»å\n * origincountmap ï¼ ç»´æ¤æ¯ä¸ªè°ç¨æ¥æºçææ æ°æ®ç»è®¡æ°æ®ï¼statisticnodeï¼\n * lock ï¼æ§å¶å¹¶åä¿®æ¹ origincountmap ç¨çé\n\nå¶å®å®è¿æä¸ä¸ªæ¹æ³ç¨æ¥æä½ origincountmap ï¼\n\npublic node getorcreateoriginnode(string origin) {\n    statisticnode statisticnode = origincountmap.get(origin);\n    if (statisticnode == null) {\n        lock.lock();\n        try {\n            statisticnode = origincountmap.get(origin);\n            if (statisticnode == null) {\n                statisticnode = new statisticnode();\n                hashmap<string, statisticnode> newmap = new hashmap<>(origincountmap.size() + 1);\n                newmap.putall(origincountmap);\n                newmap.put(origin, statisticnode);\n                origincountmap = newmap;\n            }\n        } finally {\n            lock.unlock();\n        }\n    }\n    return statisticnode;\n}\n\n\nå·ä½æ¯å¥ææå¢ï¼è¯·çè¿ä¸ªå¾ï¼\n\n\n\nspringmvc æ¡æ¶ä¸­ç /hello1 éè¿ grpc è¿ç¨è°ç¨äº /hello2ï¼é£ä¹å¨ç»è®¡ /hello2 æ¶æ¯ä¸æ¯è¦æ æ¸æ¥ origin æ¯ hello1ï¼\n\næä»¥å°±éè¿ origin åå»ºä¸ä¸ª hello1 èç¹ï¼æ¾å¨ hello2 ç clusternode ç map ä¸­ï¼æ³¨æï¼æ¾å¥çèç¹ç±»åä¸º statisticnodeï¼ä¹å°±è¯´æè¿ä¸ªèç¹æ²¡æå®éæä¹ï¼åªè´è´£ç»è®¡ä¸ä¸æµéï¼æ¹ä¾¿åâæ¥æºéæµãå³èéæµâã\n\nå½ç¨æ·è¦å /hello1->/hello2 çæ¥æºéæµæ¶ï¼å° hello2 çæµéååºæ¥ï¼åå° hello2å¯¹åºç clusternode ä¸­ç»è®¡ç hello1 çæ°æ®ååºæ¥å°±å¯ä»¥å¤æ­æ¯å¦éæµäºã\n\n\n# 3. æ ¹èç¹ constants.root\n\nå¶å®æ´ä¸ªç¨åºç å¥å£èç¹æ¯åºå®çï¼å®å­æ¾å¨å¸¸éç±» constants ä¸­ã\n\npublic final class constants {\n    // é»è®¤contextçåç§°\n    public final static string context_default_name = "sentinel_default_context";\n    \n    // æ ¹èç¹\n    public final static defaultnode root = new entrancenode(\n        new stringresourcewrapper(root_id, entrytype.in),\n        new clusternode(root_id, resourcetypeconstants.common)\n    );\n    \n    // æ ¹èç¹å¯¹åºçå¨å±èç¹\n    public final static clusternode entry_node = new clusternode(\n        total_in_resource_name, \n        resourcetypeconstants.common\n    );\n\n}\n\n\næ ¹èç¹çç¬¬ä¸å±å­èç¹ï¼å³ entrancenode ä¹æ¯åºå®çï¼è¿ä¸ªå¨åé¢å·²ç»å§éäº\n\nä¹å°±æ¯è¯´ï¼æ ¹èç¹åç¬¬ä¸å±èç¹é½æ¯åºå®çãåªæä»ç¬¬äºå±èç¹å¼å§ææ¯æä»¬çã\n\nï¼ä¸é¢æè¯´ç âç¬¬ä¸å±â æ¯ærootèç¹ä¸çç¬¬ä¸å±ï¼åç»­å¨æå° entrancenode æ¶é½ä¼æ âç¬¬ä¸å±â ä»£ç§°ï¼è¯·ä¸è¦è®¤ä¸ºæè¯´çç¬¬ä¸å±æ¯rootðï¼\n\néªè¯ä¸ä¸ï¼æä»¬ä¸éæä»»ä½ç¯å¢ï¼é£ä¹ root ä¸ç¬¬ä¸ä¸ª entrancenode å°±ä¸å®æ¯ sentinel_default_contextã\n\nå° abc å½ä½èµæºçè¯ï¼abcå°±ä¼æ¯ sentinel_default_context çå­èç¹ï¼\n\n\n\nï¼ä½¿ç¨ sentinel-demo/sentinel-demo-basic/flow/flowqpsdemo æµè¯ç±»ï¼\n\néæäº web mvc æ¶ï¼root çå­èç¹å°±æä¿©äºï¼\n\n\n\n(ä½¿ç¨ sentinel-demo/sentinel-demo-spring-webmvc/webmvctestcontroller æµè¯ç±»ï¼éè¦èªå·±å ä¸ constants.root å» debug)\n\næ´æ°ä¸ä¸èç¹æ ï¼\n\n\n\nè¿æ ·åçå¥½å¤æ¯éæå¶ä»ç¯å¢æ¶å¾æ¹ä¾¿ï¼åå¤å°±æ¯ä¸å¥½çè§£\n\n\n# 4. entry\n\nå¨è®¤è¯ èµæº å èç¹ ä¹åå°±è¯¥ entry äºï¼entryæ¯ç± èç¹+å¤çå¨é¾ ç»æã\n\nsentinel æä¾çæ¯éæµãçæ­åè½ï¼å·ä½æ¥è¯´å°±æ¯ç­ç¹éæµãç³»ç»éæµãæ¥æºéæµ.... è¿äºåè½éè¿è´£ä»»é¾æ¨¡å¼ç»æäºä¸ä¸ªå¤çå¨é¾ï¼ç±äºæ¯ä¸ä¸ªèµæºé½éè¦è¿è¡å¤æ­ï¼æ¯ä¸ä¸ªèµæºè¦çéæµè§åé½æå·®å«ï¼æä»¥æ¯ä¸ä¸ªèµæºé½è¦èµ°ä¸éå¤çå¨é¾ï¼sentinel ä½¿ç¨ entry å° èç¹åå¤çå¨é¾ å°è£èµ·æ¥ã\n\nå¨ sentinel ä¸­ï¼å¤çå¨é¾ä¹å¯ä»¥ç§°ä¸ºè´£ä»»é¾ã\n\nå¬èµ·æ¥æ¯ä¸æ¯ç¹å«éº»ç¦ï¼ç¡®å®ï¼è¦åå°æ¯ä¸ä¸ªèµæºé½è¿è¡éæµç¡®å®ç¹å«éº»ç¦ã\n\npublic abstract class entry implements autocloseable {\n    // åå»ºæ¶é´\n    private long createtime;\n    // å½åèç¹ï¼defaultnodeï¼\n    private node curnode;\n    // æ¥æºèç¹\n    private node originnode;\n    // éè¯¯\n    private throwable error;\n    // èµæºid\n    protected resourcewrapper resourcewrapper;\n}\n\n\nctentry æ¯ entry çç´æ¥å­ç±»ï¼åé¢åææºç æ¶ï¼æä»¬æè¯´ entry çæ ctentryãctentry ä¸­å£°æçå­æ®µä¿¡æ¯å¦ä¸ä»£ç æç¤ºã\n\nclass ctentry extends entry {\n    // å½å entry æåçç¶ entry\n    protected entry parent = null;\n    // ç¶ entry æåå½å entry\n    protected entry child = null;\n    // å½åèµæºç processorslotchainï¼è´£ä»»é¾æ¨¡å¼ï¼ä¹å°±æ¯å¾å¤æ¦æªå¨\n    protected processorslot<object> chain;\n    // å½åä¸ä¸æ\n    protected context context;\n}\n\n\nä¸ºå¥ entry è¦å parentãchild å³ç³» ï¼å¨ node ç« èä¸­æä»¬ä»ç»äºï¼å¤ä¸ª defaultnode å¯ä»¥ç»ææ ï¼æä»¬ä¸æ¬¡åªéè¦ç»è®¡å½åä¸æ¡é¾è·¯ç nodeï¼ä¹å°±æ¯ä¸ä¸ªé¾è¡¨ï¼æä»¥è¿ä¸ª parent å child å¶å®ä¹å¯ä»¥ç§°ä½ pre å nextã\n\n> æä¸ä¸ªç¹å«éè¦æ³¨æçç¹ ï¼å¥å£èç¹ï¼å³ entrancenode ä¸ä¼è¢«å°è£ä¸º entryã\n\nentry æ¯ä¸æ¬¡è°ç¨å½¢æçè°ç¨é¾ä¸çèç¹ã\n\nè¿å¼ å¾æè¿°äºå¤ä¸ª node çå³ç³»\n\n\n\nç°å¨æä»¬å° a -> b -> f è¿æ¡è°ç¨é¾æ¥ç»ä¸ä¸ entry\n\n\n\nï¼å¤ä¸ªentryæ¯ååé¾è¡¨ï¼å¤ä¸ªnodeæ¯æ ï¼\n\n> è¿éè¯·ä½ åæ¸ å¤çå¨é¾ å è°ç¨é¾ çåºå«ã\n> \n>  * æ¯ä¸ä¸ª entry ç± node + å¤çå¨é¾ ç»æ\n> \n>  * å¤ä¸ª entry ç»æä¸ä¸ªè°ç¨é¾\n\nentryæ¯å¥æ¶ååå»ºçãæä¹åå»ºçå¢ï¼ææçèµæºé½è¦å°è£ä¸º entryï¼ç¶åå¨entryåé¨çå¤çå¨é¾ä¸­å°è£ä¸ºnodeæå¨æ ä¸ã\n\nè°ç¨ sphu.entry(string entryname) å³å¯åå»º entryãå¦æéæäºå¶ä»æ¡æ¶ï¼æ¯å¦springmvcï¼å¯ä»¥ä½¿ç¨aopåå»ºã\n\nsphu.entry(string) æç»æ§è¡çå¦ä¸æ¹æ³ï¼\n\nprivate entry entrywithpriority(resourcewrapper resourcewrapper, \n                                int count, \n                                boolean prioritized, \n                                object... args) throws blockexception {\n    // è·åå½åä¸ä¸æ\n    context context = contextutil.getcontext();\n    if (context instanceof nullcontext) {\n        return new ctentry(resourcewrapper, null, context);\n    }\n\t// å¦æ context ä¸ºç©ºï¼ä½¿ç¨é»è®¤ context. (å³nameä¸º sentinel_default_context çcontext)\n    if (context == null) {\n        context = internalcontextutil.internalenter(constants.context_default_name);\n    }\n\n    // \n    if (!constants.on) {\n        return new ctentry(resourcewrapper, null, context);\n    }\n\t// å è½½è°ç¨é¾\n    processorslot<object> chain = lookprocesschain(resourcewrapper);\n\n    // å¦æå è½½çè´£ä»»é¾ä¸ºç©º\n    if (chain == null) {\n        return new ctentry(resourcewrapper, null, context);\n    }\n\t// æ­£å¸¸æåµä¸ä¸é¢çä»£ç é½ä¸ä¼èµ°å°ï¼è¿éä¼çæ­£åå»ºä¸ä¸ª ctentry.\n    entry e = new ctentry(resourcewrapper, chain, context, count, args);\n    try {\n        // å¼å§æ§è¡æ´ä¸ªè´£ä»»é¾\n        chain.entry(context, resourcewrapper, null, count, prioritized, args);\n    } catch (blockexception e1) {\n        e.exit(count, args);\n        throw e1;\n    } catch (throwable e1) {\n        recordlog.info("sentinel unexpected exception", e1);\n    }\n    return e;\n}\n\n\nç°å¨ä¸ç¥écontextæ²¡äºï¼ä¸é¢å°±æ¯ãå¶å®ç´å° new ctentry() ææ¯éç¹ï¼newåºentryåç´æ¥æ§è¡ å¤çå¨é¾ï¼å¤çå¨é¾ä¸­æå¾å¤ä¸ªå¤çå¨ï¼æç»è®¡èµæºçãéæµçãçæ­ç...å¦æå¨å¤çå¨é¾çæ§è¡è¿ç¨ä¸­åºç°è¢«éæµãçæ­çå¼å¸¸ï¼å°±ä¼è¢«è¿ä¸ª blockexception æè·ä¸¢åºãä¸¢åºä¹åè¯å®è¦å° entry éæ¯ã\n\n> entry ä¸ node çåºå«æ¯å¥å¢ï¼\n> \n> nodeæå»ºä¹ååºæ¬ä¸ä¼å¨äºï¼é¤éç¨åºéå¯å®æºå¥çã\n> \n> entryæ¯æ¬¡è¯·æ±é½ä¼æå»ºãå¤ä¸ªentryå°±ç»æäºä¸æ¬¡è°ç¨é¾\n\n\n# 5. ä¸ä¸æ context\n\nå¾å¤æ¡æ¶é½æä¸ä¸ªä¸ä¸æå¯¹è±¡ï¼sentinel ä¹ä¸ä¾å¤ãsentinel ç contextutil ä½¿ç¨ threadlocal ææ contextï¼context å­å¨çä¿¡æ¯åæ¬ ï¼\n\npublic class context {\n    // contextçname\n    private final string name;\n    // æ­¤æ¬¡æ§è¡çå¥å£èç¹ï¼é½æ¯åºå®çrootä¸çç¬¬ä¸å±èç¹ã\n    private defaultnode entrancenode;\n    // ç°å¨æ§è¡å°åªä¸ªentryäºã\n    private entry curentry;\n    private string origin = "";\n    \n    // æä»¬ä¸è®¨è®ºå¼æ­¥çæåµ\n    // private final boolean async;\n}\n\n\n * nameï¼context çåç§°ã\n\n * entrancenodeï¼å½åè°ç¨æ çå¥å£èç¹ï¼ç±»åä¸º entrancenodeãè¿ä¸ªnodeæ¯è¾åºå®ï¼é½æ¯ç¬¬ä¸å±èç¹ã\n   \n   è¿ä¸ªèç¹è½ç¶ä¼å¨ context ä¸­ï¼ä½å®ä¸ä¼å¨ entry ä¸­ï¼å ä¸ºä¸åä¸æ§è¡ï¼åªåä¸ç»è®¡ã\n\n * curentryï¼å½å entryï¼ctentryï¼ï¼åå«å½åæ§è¡ç node\n\n * originï¼è°ç¨æ¥æºçåç§°ï¼å³æå¡æ¶è´¹èçåç§°æèæå¡æ¶è´¹èçæ¥æº ipï¼åå³äºæå¡æ¶è´¹èæ¯å¦ä½¿ç¨ sentinelï¼ç± sentinel ééå±ä¼ éè¿æ¥ãä¾å¦ï¼æå¡æä¾èæ¯ spring mvc åºç¨ï¼ä¸æå¡æä¾èä½¿ç¨ sentinel ç web mvc ééï¼é£ä¹ sentinel ä¼å°è¯ä»è¯·æ±å¤´è·åâs-userâï¼å¦ææå¡æ¶è´¹èæå¨è¯·æ±å¤´ä¼ éè¿ä¸ªåæ°ï¼é£ä¹å°±è½å¤è·åå°ã\n\npublic class contextutil {\n    // ææ context\n    private static threadlocal<context> contextholder = new threadlocal<>();\n    // ææææ entrancenodeï¼å³ææç¬¬ä¸å±node.\n    // å¯è½åå«ç: defaultãmvcãokhttpãgrpcãdubbo...\n    private static volatile map<string, defaultnode> contextnamenodemap = new hashmap<>();\n    // å¦æå½åç¯å¢(mvcãdubboãgrpc) è¿æ²¡ææç¬¬ä¸å±èç¹æ³¨åå° contextnamenodemapï¼é£ä¹å°±å éå¼å§æ³¨å\n    private static final reentrantlock lock = new reentrantlock();\n}\n\n\nè¿éè¦çéè¯´ä¸ä¸ contextnamenodemapã\n\ncontextutil ä¼å°ææç¬¬ä¸å±èç¹å­å¨å¨ contextnamenodemap ä¸­ï¼ä»åå­ä¹å¯ä»¥çåºæ¥è¿ä¸ªmapéé¢å­å¨çæ¯ä»¥ context.name å½åç node\n\n\n# 5.1 context çåå»º\n\nå½ contextutil ç±»å è½½çæ¶åä¼æ§è¡éæä»£ç åï¼åå§åä¸ä¸ªé»è®¤çentrancenode ï¼sentinel_default_context æ¾å¥ contextnamenodemap ä¸­ã\n\nstatic {\n    // cache the entrance node for default context.\n    initdefaultcontext();\n}\n\nprivate static void initdefaultcontext() {\n    string defaultcontextname = constants.context_default_name;\n    entrancenode node = new entrancenode(new stringresourcewrapper(defaultcontextname, entrytype.in), null);\n    // å°æ­¤å¥å£èç¹æå¨ root ä¸é¢ã\n    constants.root.addchild(node);\n    contextnamenodemap.put(defaultcontextname, node);\n}\n\n\næä»¥å¨åä»£ç çæ¶å contextnamenodemap ä¸­å°±å·²ç»æäºä¸ä¸ª entrancenode äºãå½ç¶è¿æ¯é¢å¤è¯äºï¼æä»¬è¦è¯´çæ¯ context çåå»ºãè½ç¶æå®äº entrancenode ä½æ¯å¹¶æªç» entrancenode åå»º entryï¼æä»¥ entrancenode ä¸ä¼åä¸æ§è¡ã\n\ncontextutil.enter(string contextname) å¯ä»¥åå»ºä¸ä¸ª context\n\n// æ¾å¼åå»º context\ncontextutil.enter("sentinel_default_context");\nentry entry = null;\ntry {\n     // åå»ºèµæºå¯¹åºç entry\n     entry = sphu.entry("/user/get", entrytype.in);\n     // æ§è¡ä¸å¡æ¹æ³\n     return dobusiness();\n} catch (exception e) {\n     if (!(e instanceof blockexception)) {\n          tracer.trace(e);\n     }\n     throw e;\n} finally {\n     if (entry != null) {\n         // éæ¯æ­¤entry, ä¼å° context.curentryæ¹ä¸ºentry.parent\n         entry.exit(1);\n     }\n     // éæ¯ context\n     contextutil.exit();\n}\n\n\ncontext é½æ¯ç± contextutil æ¾å¼åå»ºï¼ contextutil.enter(string contextname) æç»æ§è¡çé»è¾ ï¼\n\n// name : contextname, contextçåç§°\n// origin : æ¥æºï¼æ¯å¦éè¿ rpcè°ç¨æ¶ï¼rpcæå¡æä¾èçoriginå°±æ¯æå¡è°ç¨è\nprotected static context trueenter(string name, string origin) {\n    // ä» contextholder ä¸­å contextï¼å¦æåä¸å°å°±åå»ºã\n    // è¿éä¹æ¯æä»¬ç¬¬ä¸ä¸ªçå° sentinel ä½¿ç¨åéæ£æ¥éæºå¶ï¼åé¢è¿ä¼æå¾å¤æ¬¡ã\n    context context = contextholder.get();\n    if (context == null) {\n        // contextnamenodemap æ¯æ¥æç¬¬ä¸å±èç¹çmap\n        // æ¯å¦ sentinel_default_context - entrancenode\n        map<string, defaultnode> localcachenamemap = contextnamenodemap;\n        \n        // å¦ææ ¹æ®context name æ æ³æ¾å°ç¬¬ä¸å±nodeï¼è¯´æå½åç¯å¢(mvcãdubboãgrpc...) è¿æ²¡ææç¬¬ä¸å±èç¹æ³¨åå° contextnamenodemap\n    \t// é£ä¹å°±å éå¼å§æ³¨å\n        defaultnode node = localcachenamemap.get(name);\n        // ç¬¬ä¸æ¬¡æ£æ¥\n        if (node == null) {\n            // å¦æç¬¬ä¸å±èç¹å¤ªå¤äºï¼è¿åä¸ä¸ª nullcontext\n            if (localcachenamemap.size() > constants.max_context_name_size) {\n                setnullcontext();\n                return null_context;\n            } else {\n                // å é\n                lock.lock();\n                try {\n                    node = contextnamenodemap.get(name);\n                    // ç¬¬äºæ¬¡\n                    if (node == null) {\n                        if (contextnamenodemap.size() > constants.max_context_name_size) {\n                            setnullcontext();\n                            return null_context;\n                        } else {\n                            // è¿ä¸ªèç¹è¯å®æ¯å¥å£èç¹\n                            node = new entrancenode(new stringresourcewrapper(name, entrytype.in), null);\n                            // å°å¥å£èç¹å å¥å°rootä¸é¢\n                            constants.root.addchild(node);\n\t\t\t\t\t\t\t// æ¿æ¢æ´æ°ä¸ä¸contextnamenodemap\n                            map<string, defaultnode> newmap = new hashmap<>(contextnamenodemap.size() + 1);\n                            newmap.putall(contextnamenodemap);\n                            newmap.put(name, node);\n                            contextnamenodemap = newmap;\n                        }\n                    }\n                } finally {\n                    lock.unlock();\n                }\n            }\n        }\n        // ä¸é¢çé»è¾æ¯åå»ºrootä¸çç¬¬ä¸å±èç¹ï¼ä¸ç®¡æ¯å¦éè¦åå»º entrancenode ï¼åæ­£context æ¯ä¸å®è¦çã\n        context = new context(node, name);\n        // ä¸è¬æ¥è¯´ origin ä¸ºç©ºï¼ä½æ¯åè¢«è°ç¨çrpcæå¡ï¼originå°±æ¯è°ç¨æ¥æº\n        context.setorigin(origin);\n        // å°æ­¤contextè®¾ç½®å° contextholderä¸­\n        contextholder.set(context);\n    }\n\n    return context;\n}\n\n\nåå»ºcontextä»æ´ä½ä¸çå°±ä¸¤æ­¥ ï¼\n\n * å¦æè¿ä¸ªcontextæ²¡æå¨ mapä¸­æ³¨åè¿ï¼å°±æ³¨åä¸ä¸\n * åå»ºcontextï¼æå®æ­¤ context ç entrancenode\n\néå¤ï¼åå»º context æ¶å¹¶æ²¡æç» entrancenode åå»ºå¯¹åºç entry å¦ï¼æä»¥ entrancenode ä¸ä¼åä¸æ§è¡ã\n\néæ springmvcæ¡æ¶æ¶ï¼sentinel å¨ handlerinterceptor ä¸­åå»º context ï¼ç¸åºçä»£ç å¨ sentinel-adapter/sentinel-spring-webmvc-adapterä¸­\n\n@override\npublic boolean prehandle(httpservletrequest request, httpservletresponse response, object handler) throws exception {\n    // éè¿å­ç±»çå®ç°ï¼è·åèµæºåï¼å¦ "/user/{id}"\n    string resourcename = getresourcename(request);\n    // å¯¹èµæºåè¿è¡å¤ç©ºå¥çæä½ï¼çç¥æç´æ¥è¿å¥æ ¸å¿ä»£ç \n\n    // è§£æè°ç¨æ¥æº\n    string origin = parseorigin(request);\n    // è·åcontext name, å¼å§åå»ºä¸ä¸æ\n    string contextname = "sentinel_spring_web_context";\n    contextutil.enter(contextname, origin);\n    // åå»ºentry\n    entry entry = sphu.entry(resourcename, resourcetypeconstants.common_web, entrytype.in);\n    // å°entryæ¾å¥è¯·æ±åä¸­ï¼ä»¥ä¾¿å¨ aftercompletion ä¸­ä½¿ç¨\n    request.setattribute(basewebmvcconfig.getrequestattributename(), entry);\n    return true;\n}\n\n\næ»ç»ä¸ä¸ ï¼\n\n * root å¹¶ä¸åä¸ context çæå»ºï¼ä¹ä¸åä¸entryçæ§è¡ã\n * entrancenode åä¸ context çåå»ºï¼ä½æ¯ entrancenode ä¸ä¼åä¸ entry çæ§è¡\n * entry æ¯è°ç¨é¾\n\nç°å¨æä»¬çnodeæ å°±å¯ä»¥åä¸ºè¿æ · ï¼\n\n\n\n\n# 6. ææ§½ processorslot\n\nprocessorslot ç´è¯å°±æ¯å¤çå¨ææ§½ï¼æ¯ sentinel å®ç°éæµéçº§ãçæ­éçº§ãç³»ç»èªéåºéçº§ç­åè½çåå¥ç¹ãsentinel æä¾ç processorslot å¯ä»¥åä¸ºä¸¤ç±»ï¼ä¸ç±»æ¯è¾å©å®æèµæºææ æ°æ®ç»è®¡çåå¥ç¹ï¼ä¸ç±»æ¯å®ç°éçº§åè½çåå¥ç¹ã\n\nè¾å©èµæºææ æ°æ®ç»è®¡ç processorslotï¼\n\n * nodeselectorslotï¼ä¸ºå½åèµæºåå»º defaultnodeï¼å¹¶ä¸å° defaultnode èµå¼ç» context.curentry.curnodeï¼\n   \n   å¦ææ­¤ defaultnode æ¯å½åè°ç¨é¾è·¯ä¸ç¬¬äºä¸ªnodeï¼å ä¸ºç¬¬ä¸ä¸ª node æ¯åºå®çï¼ï¼å°è¯¥ defaultnode æ·»å å°ç context.entrancenode çå­èç¹ï¼å¦åæ·»å å° context.curentry.parent çå­èç¹ï¼childlistï¼ãæç¹æ½è±¡ï¼æä»¬å¨åæ nodeselectorslot æºç æ¶åè¯¦ç»ä»ç»ã\n\n * clusterbuilderslotï¼å¦æå½åèµæºæªåå»º clusternodeï¼åä¸ºèµæºåå»º clusternodeï¼å° clusternode èµå¼ç»å½åèµæºç defaultnode.clusternodeï¼å¦æè°ç¨æ¥æºï¼originï¼ä¸ä¸ºç©ºï¼åä¸ºè°ç¨æ¥æºåå»º statisticnodeï¼ç¨äºå®ç°æè°ç¨æ¥æºç»è®¡èµæºçææ æ°æ®ï¼clusternode æææ¯ä¸ªè°ç¨æ¥æºç statisticnodeã\n\n * statisticslotï¼è¿æ¯ sentinel æä¸ºéè¦çç±»ä¹ä¸ï¼ç¨äºå®ç°ææ æ°æ®ç»è®¡ãåæ¯è°ç¨åç»­ç processorslot#entry å¤æ­æ¯å¦æ¾è¡è¯·æ±ï¼åæ ¹æ®å¤æ­ç»æè¿è¡ç¸åºçææ æ°æ®ç»è®¡æä½ã\n\nå®ç°éçº§åè½ç processorslotï¼\n\n * authorityslotï¼å®ç°é»ç½ååéçº§\n * systemslotï¼å®ç°ç³»ç»èªéåºéçº§\n * flowslotï¼å®ç°éæµéçº§\n * degradeslotï¼å®ç°çæ­éçº§\n\nsentinel ä½¿ç¨è´£ä»»é¾æ¨¡å¼å°è¿äºææ§½ç»æäºæ¦æªå¨é¾æ¡ï¼ä¹åæä»¬ç§° processorslot ä¸ºæ¦æªå¨ï¼ç°å¨è¦æ¹å£ä¸ºææ§½äº\n\n * processorslot ï¼ææ§½ï¼æ¯ä¸ä¸ªææ§½æä¸åçåè½ï¼æ¯å¦ç³»ç»éæµãé»ç½ååéæµãçæ­éçº§ã\n * processorslotchain ï¼åå«å¤´ææ§½åå°¾ææ§½ï¼å°ææææ§½ç»æææ§½é¾æ§è¡ã\n\nå³äºæ¯ä¸ª processorslot æ¯å¦ä½ç»æé¾è¡¨ãå¦ä½å®ç°çåè½ï¼å°å¨åç»­æç« è¯¦ç»åæã',charsets:{cjk:!0},lastUpdated:"2023/12/12, 20:55:52",lastUpdatedTimestamp:1702385752e3},{title:"2. Sentinel è´£ä»»é¾æµç¨",frontmatter:{title:"2. Sentinel è´£ä»»é¾æµç¨",date:"2023-11-29T16:10:15.000Z",permalink:"/pages/51db55/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/60.Sentinel/4.%20Sentinel%20%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%B5%81%E7%A8%8B.html",relativePath:"02.æç« /91.æ¡æ¶/60.Sentinel/4. Sentinel è´£ä»»é¾æµç¨.md",key:"v-d47ce5a2",path:"/pages/51db55/",headers:[{level:2,title:"1. ç®è¿°",slug:"_1-ç®è¿°",normalizedTitle:"1. ç®è¿°",charIndex:2},{level:2,title:"2. ProcessorSlot",slug:"_2-processorslot",normalizedTitle:"2. processorslot",charIndex:635},{level:2,title:"3. ProcessorSlotChain",slug:"_3-processorslotchain",normalizedTitle:"3. processorslotchain",charIndex:3219},{level:2,title:"4. SlotChainBuilder",slug:"_4-slotchainbuilder",normalizedTitle:"4. slotchainbuilder",charIndex:5365},{level:2,title:"5. æ»ç»",slug:"_5-æ»ç»",normalizedTitle:"5. æ»ç»",charIndex:7027},{level:2,title:"6. Sentinel ä¸­ç SPI æºå¶",slug:"_6-sentinel-ä¸­ç-spi-æºå¶",normalizedTitle:"6. sentinel ä¸­ç spi æºå¶",charIndex:7534},{level:3,title:"1. ä»ä¹æ¯ SPI",slug:"_1-ä»ä¹æ¯-spi",normalizedTitle:"1. ä»ä¹æ¯ spi",charIndex:7560},{level:3,title:"2. ä½¿ç¨JavaçSPIæºå¶",slug:"_2-ä½¿ç¨javaçspiæºå¶",normalizedTitle:"2. ä½¿ç¨javaçspiæºå¶",charIndex:8338},{level:3,title:"3. Sentinel ä½¿ç¨ SPI æºå¶åäºä»ä¹",slug:"_3-sentinel-ä½¿ç¨-spi-æºå¶åäºä»ä¹",normalizedTitle:"3. sentinel ä½¿ç¨ spi æºå¶åäºä»ä¹",charIndex:9280}],headersStr:"1. ç®è¿° 2. ProcessorSlot 3. ProcessorSlotChain 4. SlotChainBuilder 5. æ»ç» 6. Sentinel ä¸­ç SPI æºå¶ 1. ä»ä¹æ¯ SPI 2. ä½¿ç¨JavaçSPIæºå¶ 3. Sentinel ä½¿ç¨ SPI æºå¶åäºä»ä¹",content:'# 1. ç®è¿°\n\nå¨ä¸ä¸ç¯ä¸­è¯¦ç»ä»ç»äº Sentinel ä¸­çå ä¸ªæ ¸å¿ç±»ï¼åç®åè¯´äºä¸ä¸ Sentinel çææ§½ã\n\nè¿ä¸ç¯ä¼ç¨å¾®è¯¦ç»çè®²è§£ææ§½ï¼ä¼ä»æ´ä½ä¹å°±æ¯è´£ä»»é¾æ¨¡å¼å¥æä»ç» Sentinel å·¥ä½çæµç¨ï¼ä½ä¸ä¼åç¬è®²è§£æä¸ä¸ªææ§½çç¨å¤ã\n\nåå¿ä¸ä¸ä¸ä¸ç¯æå³ææ§½ ProcessorSlot çç¥è¯ç¹ ï¼\n\nSentinel ä½¿ç¨ è´£ä»»é¾æ¨¡å¼å°ææç ProcessorSlot æç§ä¸å®çé¡ºåºä¸²æä¸ä¸ªé¾è¡¨ãProcessorSlot å±åä¸ºä¸¤ç±»ï¼\n\n 1. ç»è®¡æ°æ®ï¼è¿ç§ ProcessorSlor æ¯æä¸¥æ ¼çé¡ºåºåºåçï¼ä¸è½æ´æ¹ã\n    \n    NodeSelectorSlot\n    \n    ClusterBuilderSlot\n    \n    StatisticSlot\n\n 2. éæµ/çæ­ï¼è¿ç§ ProcessorSlot æ²¡æä¸¥æ ¼ä¸¥æ ¼çé¡ºåºè¦æ±ï¼å¯ä»¥æéè°æ´ã\n    \n    AuthoritySlot\n    \n    SystemSlot\n    \n    FlowSlot\n    \n    DegradeSlot\n\nProcessorSlotChain ï¼åå«ProcessorSlotå¤´èç¹åå°¾èç¹ï¼å¯ä»¥è§¦åæ´ä¸ªææ§½é¾çæ§è¡ã\n\nSlotChainBuilder ï¼å° ProcessorSlot ç»è£èµ·æ¥å½¢æ ProcessorSlotChain å¹¶è¿åç»ç¨æ·ã\n\næ¥ä¸æ¥è¯¦ç»è¯´è¯´ Sentinel çå·¥ä½æµç¨\n\n\n# 2. ProcessorSlot\n\nProcessorSlot æ¯ä¸ä¸ªæ¥å£\n\npublic interface ProcessorSlot<T> {\n\n  \t// å®ç°èªå·±çä¸å¡æ¹æ³\n    void entry(Context context, ResourceWrapper resourceWrapper, T param, int count, boolean prioritized, Object... args) throws Throwable;\n\n    // è§¦åä¸ä¸ä¸ªslotçä¸å¡æ¹æ³\n    void fireEntry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, boolean prioritized, Object... args) throws Throwable;\n\n\t// å®ç°èªå·±çéåºæ¹æ³\n    void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args);\n\n    // è§¦åä¸ä¸ä¸ªslotçéåºæ¹æ³\n    void fireExit(Context context, ResourceWrapper resourceWrapper, int count, Object... args);\n}\n\n\n * context ï¼å½åè°ç¨é¾è·¯ä¸ä¸æ\n * resourceWrapper ï¼èµæº\n * param ï¼æ³ååæ°ï¼ä¸è¬ç¨äºä¼ é DefaultNode\n * count ï¼ç³è¯·è®¿é®èµæºçæ°éï¼æ¯å¦è®¿é®éãå ç¨çº¿ç¨æ°éï¼count ä¸è¬ä¸º1\n * prioritized ï¼æ¯å¦å¯¹è¯·æ±è¿è¡ä¼åçº§æåºï¼ä¸è¬ä¸ºfalse\n * args ï¼è°ç¨æ¹æ³çåæ°ï¼ç¨äºå®ç°ç­ç¹åæ°éæµ\n\nè¿éä½ å°±ä¼æäºçæï¼æç§è´£ä»»é¾æ¨¡å¼ï¼ProcessorChain åºè¯¥æä¸ä¸ª next åéç¨äºä¸²èµ·æ¥ææ ProcessorChain åï¼ä½æ¯æ­¤å¤å¹¶æ²¡æï¼èä¸ä¹æ²¡ææä¾æ·»å ä¸ä¸ä¸ªslotãè§¦åä¸ä¸ä¸ªslotè¿äºæ¹æ³ï¼ä¸è¦æï¼å¶å®è¿äºä¸è¥¿å¨ ProcessorSlot çå®ç°ç±»ä¸­ ï¼AbstractLinkedProcessorSlot\n\nä¹æä»¥è½å¤å°ææç ProcessorSlot æé æä¸ä¸ª ProcessorSlotChainï¼è¿æ¯ä¾èµ AbstractLinkedProcessorSlot ç±»ã\n\næ¯ä¸ª AbstractLinkedProcessorSlot ç±»é½æä¸ä¸ªæåä¸ä¸ä¸ª AbstractLinkedProcessorSlot çå­æ®µï¼æ­£æ¯è¿ä¸ªå­æ®µå° ProcessorSlot ä¸²æä¸æ¡ååé¾è¡¨ãAbstractLinkedProcessorSlot é¨åæºç å¦ä¸ã\n\npublic abstract class AbstractLinkedProcessorSlot<T> implements ProcessorSlot<T> {\n    // å½åèç¹çä¸ä¸ä¸ªèç¹\n    private AbstractLinkedProcessorSlot<?> next = null;\n\n    public void setNext(AbstractLinkedProcessorSlot<?> next) {\n        this.next = next;\n    }\n    @Override\n    public void fireEntry(Context context, \n                          ResourceWrapper resourceWrapper, \n                          Object obj, \n                          int count, \n                          boolean prioritized, \n                          Object... args) throws Throwable {\n        if (next != null) {\n            T t = (T) obj; \n            // è°ç¨ä¸ä¸ä¸ª ProcessorSlot ç entry æ¹æ³\n            next.entry(context,resourceWrapper,t,count,prioritized,args);\n        }\n    }\n}\n\n\nå¯ä»¥çå°ï¼ä¸ä»æä¾äº setNext() æ¹æ³ç¨äºæ·»å æ­¤slotçä¸ä¸ä¸ªslotï¼è¿æä¾äº fireEntry() è§¦åä¸ä¸ä¸ªslotã\n\nå°æ¶åæä»¬å®ç°çæ¶ååªéè¦è¿æ ·ï¼\n\npublic class MySlot extends AbstractLinkedProcessorSlot<DefaultNode> {\n\n    @Override\n    public void entry(Context context, \n                      ResourceWrapper resourceWrapper, \n                      DefaultNode node, \n                      int count, \n                      boolean prioritized, \n                      Object... args) throws Throwable {\n        // æ§è¡èªå·±çä¸å¡æ¹æ³...\n        \n        \n        // æ§è¡ç»æï¼è§¦åä¸ä¸ä¸ªslotçä¸å¡æ¹æ³\n        fireEntry(context, resourceWrapper, node, count, prioritized, args);\n    }\n}\n\n\n\n# 3. ProcessorSlotChain\n\næ ¹æ®è´£ä»»é¾æ¨¡å¼çä¸è¬å®ç°æ¹å¼ï¼è¿ä¸ª Chain ä¼ææææçslotï¼Sentinel çå®ç°æ¹å¼æ¯ææå¤´èç¹åå°¾èç¹ã\n\nï¼OkHttpçå®ç°æ¹å¼æ¯æææ´ä¸ªListï¼\n\npublic class DefaultProcessorSlotChain extends ProcessorSlotChain {\n\n    // èæå¤´èç¹\n    AbstractLinkedProcessorSlot<?> first = new AbstractLinkedProcessorSlot<Object>() {\n\t\t// å¯ä»¥çå°å¤´èç¹å¹¶æ²¡æèªå·±çä¸å¡éè¦å®ç°ï¼æä»¥ç´æ¥è°ç¨ fireEntry è§¦ånext.entry\n        @Override\n        public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, boolean prioritized, Object... args)\n            throws Throwable {\n            super.fireEntry(context, resourceWrapper, t, count, prioritized, args);\n        }\n\n        @Override\n        public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {\n            super.fireExit(context, resourceWrapper, count, args);\n        }\n\n    };\n    // å°¾èç¹\n    AbstractLinkedProcessorSlot<?> end = first;\n\n    // å¤´ææ³\n    @Override\n    public void addFirst(AbstractLinkedProcessorSlot<?> protocolProcessor) {\n        protocolProcessor.setNext(first.getNext());\n        first.setNext(protocolProcessor);\n        if (end == first) {\n            end = protocolProcessor;\n        }\n    }\n\n    // å°¾ææ³\n    @Override\n    public void addLast(AbstractLinkedProcessorSlot<?> protocolProcessor) {\n        end.setNext(protocolProcessor);\n        end = protocolProcessor;\n    }\n\n    @Override\n    public void setNext(AbstractLinkedProcessorSlot<?> next) {\n        addLast(next);\n    }\n\n    @Override\n    public AbstractLinkedProcessorSlot<?> getNext() {\n        return first.getNext();\n    }\n\t// entryæ¹æ³ï¼è°ç¨ first.transformEntry()ï¼æç»è°ç¨å° first.entryï¼\n    // first.entryæ²¡æèªå·±çä¸å¡ï¼ç´æ¥è§¦åfirst.next.entry()\n    @Override\n    public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, boolean prioritized, Object... args)\n        throws Throwable {\n        first.transformEntry(context, resourceWrapper, t, count, prioritized, args);\n    }\n\n    @Override\n    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {\n        first.exit(context, resourceWrapper, count, args);\n    }\n}\n\n\nä½¿ç¨ ProcessorSlotChain.entry() å³å¯è§¦åæ´ä¸ªé¾æ¡ã\n\n\n# 4. SlotChainBuilder\n\næ ¹æ®è´£ä»»é¾æ¨¡å¼çä¸è¬å®ç°æ¹å¼ï¼æé  slot é¾æ¡è¿ä»¶äºä¸ä¼æ´é²ç»ç¨æ·çï¼æä»¥ Sentintl ä½¿ç¨ SlotChainBuilder æé  ProcessorSlotChain å¹¶è¿åã\n\n@Spi(isDefault = true)\npublic class DefaultSlotChainBuilder implements SlotChainBuilder {\n\n    @Override\n    public ProcessorSlotChain build() {\n        ProcessorSlotChain chain = new DefaultProcessorSlotChain();\n\n        List<ProcessorSlot> sortedSlotList = SpiLoader.of(ProcessorSlot.class).loadInstanceListSorted();\n        for (ProcessorSlot slot : sortedSlotList) {\n            if (!(slot instanceof AbstractLinkedProcessorSlot)) {\n                RecordLog.warn("The ProcessorSlot(" + slot.getClass().getCanonicalName() + ") is not an instance of AbstractLinkedProcessorSlot, can\'t be added into ProcessorSlotChain");\n                continue;\n            }\n            chain.addLast((AbstractLinkedProcessorSlot<?>) slot);\n        }\n\n        return chain;\n    }\n}\n\n\nä½æ¯æç¼ä¸çæ²¡è¿ä¹ç®åï¼å¹¶æ²¡ææä»¬æ³è±¡ç new äºå¾å¤ slot ç¶åä¸ä¸ªä¸ä¸ª add è¿å»ï¼èæ¯ä½¿ç¨ SpiLoader å è½½ãè¿æ¯ Java SPI æºå¶ï¼æä»¬å¨ä¸é¢ä¼ä»ç»ï¼è¿éå°±ä¸éä¸ç¹ä¸ä¸ªä¸ä¸ªnewåºæ¥ð\n\nææå¨ new çåï¼æºç éé¢æ²¡æ\n\npublic class DefaultSlotChainBuilder implements SlotChainBuilder {\n    @Override\n    public ProcessorSlotChain build() {\n        ProcessorSlotChain chain = new DefaultProcessorSlotChain();\n        \n        chain.addLast(new NodeSelectorSlot());\n        chain.addLast(new ClusterBuilderSlot());\n        chain.addLast(new LogSlot());\n        chain.addLast(new StatisticSlot());\n        chain.addLast(new AuthoritySlot());\n        chain.addLast(new SystemSlot());\n        chain.addLast(new FlowSlot());\n        chain.addLast(new DegradeSlot());\n        chain.addLast(new DefaultCircuitBreakerSlot());\n        \n        return chain;\n    }\n}\n\n\n\n# 5. æ»ç»\n\n 1. ProcessorSlotChain ï¼\n    * firstSlot ï¼first.entryæ¹æ³ç´æ¥è°ç¨fireEntryæ¹æ³\n    * endSlot\n    * entry() ï¼è°ç¨firstSlotçentryæ¹æ³\n 2. ProcessorSlot\n    * nextSlot\n    * entry() ï¼æ§è¡å®èªå·±çä¸å¡åæ§è¡ fireEntry()\n    * fireEntry() ï¼æ§è¡ next.entry()\n\næ»æµç¨ ï¼\n\n 1. ä½¿ç¨ SlotChainBuilder åå»º ProcessorSlotChain\n 2. ä½¿ç¨ ProcessorSlotChain.entry() æ¹æ³å¯ä»¥æ§è¡æ´æ¡ææ§½é¾ ï¼\n    * è°ç¨ firstSlot.entryï¼firstSlot.entry() ä¸­ç´æ¥æ§è¡ fireEntry æ¹æ³å»æ§è¡ä¸ä¸ä¸ª slot.entry()\n 3. ä¸ä¸ä¸ª slot.entry() æ§è¡å®èªå·±çä¸å¡æ¹æ³åï¼è°ç¨ fireEntry() å»æ§è¡ä¸ä¸ä¸ª slot.entry()\n 4. ....\n 5. ....\n\n\n# 6. Sentinel ä¸­ç SPI æºå¶\n\n\n# 1. ä»ä¹æ¯ SPI\n\nSPI å¨ç§°æ¯ Service Provider Interfaceï¼ç´è¯å°±æ¯æå¡æä¾èæ¥å£ï¼æ¯ä¸ç§æå¡åç°æºå¶ï¼æ¯ Java çä¸ä¸ªåç½®æ åï¼åè®¸ä¸åçå¼åèå»å®ç°æä¸ªç¹å®çæå¡ãSPI çæ¬è´¨æ¯å°æ¥å£å®ç°ç±»çå¨éå®åéç½®å¨æä»¶ä¸­ï¼ç±æå¡å è½½å¨è¯»åéç½®æä»¶ï¼å è½½å®ç°ç±»ï¼å®ç°å¨è¿è¡æ¶å¨ææ¿æ¢æ¥å£çå®ç°ç±»ã\n\nä½¿ç¨ SPI æºå¶è½å¤å®ç°æéç½®å è½½æ¥å£çå®ç°ç±»ï¼SPI æºå¶å¨é¿éå¼æºçé¡¹ç®ä¸­è¢«å¹¿æ³ä½¿ç¨ï¼ä¾å¦ DubboãRocketMQãä»¥åæ¬æä»ç»ç SentinelãRocketMQ ä¸ Sentinel ä½¿ç¨çé½æ¯ Java æä¾ç SPI æºå¶ï¼è Dubbo åæ¯ä½¿ç¨èªå®ç°çä¸å¥ SPIï¼ä¸ Java SPI çéç½®æ¹å¼ä¸åï¼Dubbo SPI ä½¿ç¨ Key-Value æ¹å¼éç½®ï¼ç®çæ¯å®ç°èªéåºæ©å±æºå¶ã\n\nJava ç SPI æºå¶æä¾äº ServiceLoader.load(Class<?> clazz) ç¨äºå è½½æå®ç±»çå®ç°ç±»ãå®å è½½æä»¶çè·¯å¾ä¸ºï¼\n\nresource/META-INF/services/${æ¥å£çå¨éå®ç±»å}.\n\nå¨æä»¶ä¸­ä¹è¦å¡«æ¥å£çå®ç°ç±»çå¨éå®ç±»åï¼Javaå°å¨é¨çå®ç°ç±»è¿åç»ç¨æ· ï¼\n\ncom.xiaohe.xxxxxx\n\n\nServiceLoader<T> services = ServiceLoader.load(Class<T> clazz);\n\n\nå è½½æ­¥éª¤ä¸º ï¼\n\n * æå® ServiceLoader.load(Class clazz)\n * éè¿ clazz æ¿å°æ¥å£çå¨éå®ç±»åï¼å» resource/META-INF/servicesç®å½ä¸å¯»æ¾å¯¹åºå¨éå®ç±»åçæä»¶\n * è¯»åè¯¥æä»¶çå¨é¨åå®¹ï¼æ¯ä¸ä¸ªåå®¹ä»¥æ¢è¡ç¬¦åéï¼\n * ä»¥éåçå½¢å¼è¿åç»ç¨æ·\n\n\n# 2. ä½¿ç¨JavaçSPIæºå¶\n\nåè®¾æå¾å¤ç§ç»å½æ¹å¼ï¼æä»¥ç»å½æ¥å£ï¼\n\npublic interface LoginService{\n  void login(String username,String password);\n}\n\n\næä¸¤ä¸ªå®ç°ç±»ï¼\n\npublic class ShiroLogin implements LoginService{\n    @Override\n    public void login(String username, String password) {\n        System.out.println("è§¦å Shiro çç»å½åè½");\n    }\n}\n\n\npublic class SpringSecurityLogin implements LoginService{\n    @Override\n    public void login(String username, String password) {\n        System.out.println("è§¦å SpringSecurity çç»å½åè½");\n    }\n}\n\n\nå¨ resource/META-INF/services ç®å½ä¸åå»ºåä¸º com.xiaohe.spi.LoginService ï¼æ¥å£å¨éå®ç±»åï¼çæä»¶ï¼æä»¶ä¸­å¡«å¥ï¼\n\ncom.xiaohe.spi.SpringSecurityLogin\n\n\næä¸ºåªå è½½ SpringSecurityLogin çç»éæ¹å¼ãå½ç¶ä¹å¯ä»¥å¡«å¥½å ä¸ªï¼å¤ä¸ªä¹é´ä½¿ç¨æ¢è¡åå¼ã\n\nç¼åæµè¯ç±»ï¼\n\npublic static void main(String[] args) {\n    ServiceLoader<LoginService> services = ServiceLoader.load(LoginService.class);\n    \n    services.forEach(loginService -> {\n        loginService.login("å°æ", "123");\n    });\n}\n\n\næå° ï¼\n\nè§¦å SpringSecurity çç»å½åè½\n\n\n\n# 3. Sentinel ä½¿ç¨ SPI æºå¶åäºä»ä¹\n\næ³ç¥éåªéä½¿ç¨å°äº SPIï¼æå¥½çæ¹å¼å°±æ¯å» resource/META-INF/servicesç®å½ä¸æ¥çæå¤å°ä»¥å¨éå®ç±»åå½åçæä»¶ï¼Sentinel1.8.1 çæ¬æä¸ä¸ªï¼\n\n\n\nç¬¬ä¸ä¸ªæ²¡è§è¿ææ¶ä¸è¯´ï¼ä½æ¯ç¬¬äºä¸ªåç¬¬ä¸ä¸ªå°±å¾ææ¾äºå§ã\n\nä½¿ç¨SPIæºå¶å è½½ ProcessorSlot çç®ç ï¼å¯ä»¥å¨æä»¶ä¸­èªå®ä¹ slot çæ§è¡é¡ºåºã\n\nä½¿ç¨SPIæºå¶å è½½ ProcessorSlotChain çç®ç ï¼å¯ä»¥å¨ä»£ç ä¸­èªå®ä¹ slot çæ§è¡é¡ºåºã\n\nåæ¥ç¥ä¸ç¼ Sentinel ä¸­ DefaultSlotChainBuilder æå»º ProcessorSlotChain çè¿ç¨ ï¼\n\n@Spi(isDefault = true)\npublic class DefaultSlotChainBuilder implements SlotChainBuilder {\n\n    @Override\n    public ProcessorSlotChain build() {\n        ProcessorSlotChain chain = new DefaultProcessorSlotChain();\n\n        List<ProcessorSlot> sortedSlotList = SpiLoader.of(ProcessorSlot.class).loadInstanceListSorted();\n        for (ProcessorSlot slot : sortedSlotList) {\n            // ææ slot å¿é¡»æ¯ AbstractLinkedProcessorSlot çå­ç±»\n            if (!(slot instanceof AbstractLinkedProcessorSlot)) {\n                // ææ¥å¿çä»£ç æå äº\n                continue;\n            }\n            chain.addLast((AbstractLinkedProcessorSlot<?>) slot);\n        }\n\n        return chain;\n    }\n}\n\n\nåæ¥çç resource/META-INF/services/ProcessorSlot æä»¶ä¸­çåå®¹ ï¼\n\ncom.alibaba.csp.sentinel.slots.nodeselector.NodeSelectorSlot\ncom.alibaba.csp.sentinel.slots.clusterbuilder.ClusterBuilderSlot\ncom.alibaba.csp.sentinel.slots.logger.LogSlot\ncom.alibaba.csp.sentinel.slots.statistic.StatisticSlot\ncom.alibaba.csp.sentinel.slots.block.authority.AuthoritySlot\ncom.alibaba.csp.sentinel.slots.system.SystemSlot\ncom.alibaba.csp.sentinel.slots.block.flow.FlowSlot\ncom.alibaba.csp.sentinel.slots.block.degrade.DegradeSlot\ncom.alibaba.csp.sentinel.slots.block.degrade.DefaultCircuitBreakerSlot\n\n\nè·æä¹åæå¨ new çæ§è¡é¡ºåºä¸æ ·ãåç»­æç« å°±ä¼å¯¹è¿äº slot æ¨ä¸ªè®²è§£ã',normalizedContent:'# 1. ç®è¿°\n\nå¨ä¸ä¸ç¯ä¸­è¯¦ç»ä»ç»äº sentinel ä¸­çå ä¸ªæ ¸å¿ç±»ï¼åç®åè¯´äºä¸ä¸ sentinel çææ§½ã\n\nè¿ä¸ç¯ä¼ç¨å¾®è¯¦ç»çè®²è§£ææ§½ï¼ä¼ä»æ´ä½ä¹å°±æ¯è´£ä»»é¾æ¨¡å¼å¥æä»ç» sentinel å·¥ä½çæµç¨ï¼ä½ä¸ä¼åç¬è®²è§£æä¸ä¸ªææ§½çç¨å¤ã\n\nåå¿ä¸ä¸ä¸ä¸ç¯æå³ææ§½ processorslot çç¥è¯ç¹ ï¼\n\nsentinel ä½¿ç¨ è´£ä»»é¾æ¨¡å¼å°ææç processorslot æç§ä¸å®çé¡ºåºä¸²æä¸ä¸ªé¾è¡¨ãprocessorslot å±åä¸ºä¸¤ç±»ï¼\n\n 1. ç»è®¡æ°æ®ï¼è¿ç§ processorslor æ¯æä¸¥æ ¼çé¡ºåºåºåçï¼ä¸è½æ´æ¹ã\n    \n    nodeselectorslot\n    \n    clusterbuilderslot\n    \n    statisticslot\n\n 2. éæµ/çæ­ï¼è¿ç§ processorslot æ²¡æä¸¥æ ¼ä¸¥æ ¼çé¡ºåºè¦æ±ï¼å¯ä»¥æéè°æ´ã\n    \n    authorityslot\n    \n    systemslot\n    \n    flowslot\n    \n    degradeslot\n\nprocessorslotchain ï¼åå«processorslotå¤´èç¹åå°¾èç¹ï¼å¯ä»¥è§¦åæ´ä¸ªææ§½é¾çæ§è¡ã\n\nslotchainbuilder ï¼å° processorslot ç»è£èµ·æ¥å½¢æ processorslotchain å¹¶è¿åç»ç¨æ·ã\n\næ¥ä¸æ¥è¯¦ç»è¯´è¯´ sentinel çå·¥ä½æµç¨\n\n\n# 2. processorslot\n\nprocessorslot æ¯ä¸ä¸ªæ¥å£\n\npublic interface processorslot<t> {\n\n  \t// å®ç°èªå·±çä¸å¡æ¹æ³\n    void entry(context context, resourcewrapper resourcewrapper, t param, int count, boolean prioritized, object... args) throws throwable;\n\n    // è§¦åä¸ä¸ä¸ªslotçä¸å¡æ¹æ³\n    void fireentry(context context, resourcewrapper resourcewrapper, object obj, int count, boolean prioritized, object... args) throws throwable;\n\n\t// å®ç°èªå·±çéåºæ¹æ³\n    void exit(context context, resourcewrapper resourcewrapper, int count, object... args);\n\n    // è§¦åä¸ä¸ä¸ªslotçéåºæ¹æ³\n    void fireexit(context context, resourcewrapper resourcewrapper, int count, object... args);\n}\n\n\n * context ï¼å½åè°ç¨é¾è·¯ä¸ä¸æ\n * resourcewrapper ï¼èµæº\n * param ï¼æ³ååæ°ï¼ä¸è¬ç¨äºä¼ é defaultnode\n * count ï¼ç³è¯·è®¿é®èµæºçæ°éï¼æ¯å¦è®¿é®éãå ç¨çº¿ç¨æ°éï¼count ä¸è¬ä¸º1\n * prioritized ï¼æ¯å¦å¯¹è¯·æ±è¿è¡ä¼åçº§æåºï¼ä¸è¬ä¸ºfalse\n * args ï¼è°ç¨æ¹æ³çåæ°ï¼ç¨äºå®ç°ç­ç¹åæ°éæµ\n\nè¿éä½ å°±ä¼æäºçæï¼æç§è´£ä»»é¾æ¨¡å¼ï¼processorchain åºè¯¥æä¸ä¸ª next åéç¨äºä¸²èµ·æ¥ææ processorchain åï¼ä½æ¯æ­¤å¤å¹¶æ²¡æï¼èä¸ä¹æ²¡ææä¾æ·»å ä¸ä¸ä¸ªslotãè§¦åä¸ä¸ä¸ªslotè¿äºæ¹æ³ï¼ä¸è¦æï¼å¶å®è¿äºä¸è¥¿å¨ processorslot çå®ç°ç±»ä¸­ ï¼abstractlinkedprocessorslot\n\nä¹æä»¥è½å¤å°ææç processorslot æé æä¸ä¸ª processorslotchainï¼è¿æ¯ä¾èµ abstractlinkedprocessorslot ç±»ã\n\næ¯ä¸ª abstractlinkedprocessorslot ç±»é½æä¸ä¸ªæåä¸ä¸ä¸ª abstractlinkedprocessorslot çå­æ®µï¼æ­£æ¯è¿ä¸ªå­æ®µå° processorslot ä¸²æä¸æ¡ååé¾è¡¨ãabstractlinkedprocessorslot é¨åæºç å¦ä¸ã\n\npublic abstract class abstractlinkedprocessorslot<t> implements processorslot<t> {\n    // å½åèç¹çä¸ä¸ä¸ªèç¹\n    private abstractlinkedprocessorslot<?> next = null;\n\n    public void setnext(abstractlinkedprocessorslot<?> next) {\n        this.next = next;\n    }\n    @override\n    public void fireentry(context context, \n                          resourcewrapper resourcewrapper, \n                          object obj, \n                          int count, \n                          boolean prioritized, \n                          object... args) throws throwable {\n        if (next != null) {\n            t t = (t) obj; \n            // è°ç¨ä¸ä¸ä¸ª processorslot ç entry æ¹æ³\n            next.entry(context,resourcewrapper,t,count,prioritized,args);\n        }\n    }\n}\n\n\nå¯ä»¥çå°ï¼ä¸ä»æä¾äº setnext() æ¹æ³ç¨äºæ·»å æ­¤slotçä¸ä¸ä¸ªslotï¼è¿æä¾äº fireentry() è§¦åä¸ä¸ä¸ªslotã\n\nå°æ¶åæä»¬å®ç°çæ¶ååªéè¦è¿æ ·ï¼\n\npublic class myslot extends abstractlinkedprocessorslot<defaultnode> {\n\n    @override\n    public void entry(context context, \n                      resourcewrapper resourcewrapper, \n                      defaultnode node, \n                      int count, \n                      boolean prioritized, \n                      object... args) throws throwable {\n        // æ§è¡èªå·±çä¸å¡æ¹æ³...\n        \n        \n        // æ§è¡ç»æï¼è§¦åä¸ä¸ä¸ªslotçä¸å¡æ¹æ³\n        fireentry(context, resourcewrapper, node, count, prioritized, args);\n    }\n}\n\n\n\n# 3. processorslotchain\n\næ ¹æ®è´£ä»»é¾æ¨¡å¼çä¸è¬å®ç°æ¹å¼ï¼è¿ä¸ª chain ä¼ææææçslotï¼sentinel çå®ç°æ¹å¼æ¯ææå¤´èç¹åå°¾èç¹ã\n\nï¼okhttpçå®ç°æ¹å¼æ¯æææ´ä¸ªlistï¼\n\npublic class defaultprocessorslotchain extends processorslotchain {\n\n    // èæå¤´èç¹\n    abstractlinkedprocessorslot<?> first = new abstractlinkedprocessorslot<object>() {\n\t\t// å¯ä»¥çå°å¤´èç¹å¹¶æ²¡æèªå·±çä¸å¡éè¦å®ç°ï¼æä»¥ç´æ¥è°ç¨ fireentry è§¦ånext.entry\n        @override\n        public void entry(context context, resourcewrapper resourcewrapper, object t, int count, boolean prioritized, object... args)\n            throws throwable {\n            super.fireentry(context, resourcewrapper, t, count, prioritized, args);\n        }\n\n        @override\n        public void exit(context context, resourcewrapper resourcewrapper, int count, object... args) {\n            super.fireexit(context, resourcewrapper, count, args);\n        }\n\n    };\n    // å°¾èç¹\n    abstractlinkedprocessorslot<?> end = first;\n\n    // å¤´ææ³\n    @override\n    public void addfirst(abstractlinkedprocessorslot<?> protocolprocessor) {\n        protocolprocessor.setnext(first.getnext());\n        first.setnext(protocolprocessor);\n        if (end == first) {\n            end = protocolprocessor;\n        }\n    }\n\n    // å°¾ææ³\n    @override\n    public void addlast(abstractlinkedprocessorslot<?> protocolprocessor) {\n        end.setnext(protocolprocessor);\n        end = protocolprocessor;\n    }\n\n    @override\n    public void setnext(abstractlinkedprocessorslot<?> next) {\n        addlast(next);\n    }\n\n    @override\n    public abstractlinkedprocessorslot<?> getnext() {\n        return first.getnext();\n    }\n\t// entryæ¹æ³ï¼è°ç¨ first.transformentry()ï¼æç»è°ç¨å° first.entryï¼\n    // first.entryæ²¡æèªå·±çä¸å¡ï¼ç´æ¥è§¦åfirst.next.entry()\n    @override\n    public void entry(context context, resourcewrapper resourcewrapper, object t, int count, boolean prioritized, object... args)\n        throws throwable {\n        first.transformentry(context, resourcewrapper, t, count, prioritized, args);\n    }\n\n    @override\n    public void exit(context context, resourcewrapper resourcewrapper, int count, object... args) {\n        first.exit(context, resourcewrapper, count, args);\n    }\n}\n\n\nä½¿ç¨ processorslotchain.entry() å³å¯è§¦åæ´ä¸ªé¾æ¡ã\n\n\n# 4. slotchainbuilder\n\næ ¹æ®è´£ä»»é¾æ¨¡å¼çä¸è¬å®ç°æ¹å¼ï¼æé  slot é¾æ¡è¿ä»¶äºä¸ä¼æ´é²ç»ç¨æ·çï¼æä»¥ sentintl ä½¿ç¨ slotchainbuilder æé  processorslotchain å¹¶è¿åã\n\n@spi(isdefault = true)\npublic class defaultslotchainbuilder implements slotchainbuilder {\n\n    @override\n    public processorslotchain build() {\n        processorslotchain chain = new defaultprocessorslotchain();\n\n        list<processorslot> sortedslotlist = spiloader.of(processorslot.class).loadinstancelistsorted();\n        for (processorslot slot : sortedslotlist) {\n            if (!(slot instanceof abstractlinkedprocessorslot)) {\n                recordlog.warn("the processorslot(" + slot.getclass().getcanonicalname() + ") is not an instance of abstractlinkedprocessorslot, can\'t be added into processorslotchain");\n                continue;\n            }\n            chain.addlast((abstractlinkedprocessorslot<?>) slot);\n        }\n\n        return chain;\n    }\n}\n\n\nä½æ¯æç¼ä¸çæ²¡è¿ä¹ç®åï¼å¹¶æ²¡ææä»¬æ³è±¡ç new äºå¾å¤ slot ç¶åä¸ä¸ªä¸ä¸ª add è¿å»ï¼èæ¯ä½¿ç¨ spiloader å è½½ãè¿æ¯ java spi æºå¶ï¼æä»¬å¨ä¸é¢ä¼ä»ç»ï¼è¿éå°±ä¸éä¸ç¹ä¸ä¸ªä¸ä¸ªnewåºæ¥ð\n\nææå¨ new çåï¼æºç éé¢æ²¡æ\n\npublic class defaultslotchainbuilder implements slotchainbuilder {\n    @override\n    public processorslotchain build() {\n        processorslotchain chain = new defaultprocessorslotchain();\n        \n        chain.addlast(new nodeselectorslot());\n        chain.addlast(new clusterbuilderslot());\n        chain.addlast(new logslot());\n        chain.addlast(new statisticslot());\n        chain.addlast(new authorityslot());\n        chain.addlast(new systemslot());\n        chain.addlast(new flowslot());\n        chain.addlast(new degradeslot());\n        chain.addlast(new defaultcircuitbreakerslot());\n        \n        return chain;\n    }\n}\n\n\n\n# 5. æ»ç»\n\n 1. processorslotchain ï¼\n    * firstslot ï¼first.entryæ¹æ³ç´æ¥è°ç¨fireentryæ¹æ³\n    * endslot\n    * entry() ï¼è°ç¨firstslotçentryæ¹æ³\n 2. processorslot\n    * nextslot\n    * entry() ï¼æ§è¡å®èªå·±çä¸å¡åæ§è¡ fireentry()\n    * fireentry() ï¼æ§è¡ next.entry()\n\næ»æµç¨ ï¼\n\n 1. ä½¿ç¨ slotchainbuilder åå»º processorslotchain\n 2. ä½¿ç¨ processorslotchain.entry() æ¹æ³å¯ä»¥æ§è¡æ´æ¡ææ§½é¾ ï¼\n    * è°ç¨ firstslot.entryï¼firstslot.entry() ä¸­ç´æ¥æ§è¡ fireentry æ¹æ³å»æ§è¡ä¸ä¸ä¸ª slot.entry()\n 3. ä¸ä¸ä¸ª slot.entry() æ§è¡å®èªå·±çä¸å¡æ¹æ³åï¼è°ç¨ fireentry() å»æ§è¡ä¸ä¸ä¸ª slot.entry()\n 4. ....\n 5. ....\n\n\n# 6. sentinel ä¸­ç spi æºå¶\n\n\n# 1. ä»ä¹æ¯ spi\n\nspi å¨ç§°æ¯ service provider interfaceï¼ç´è¯å°±æ¯æå¡æä¾èæ¥å£ï¼æ¯ä¸ç§æå¡åç°æºå¶ï¼æ¯ java çä¸ä¸ªåç½®æ åï¼åè®¸ä¸åçå¼åèå»å®ç°æä¸ªç¹å®çæå¡ãspi çæ¬è´¨æ¯å°æ¥å£å®ç°ç±»çå¨éå®åéç½®å¨æä»¶ä¸­ï¼ç±æå¡å è½½å¨è¯»åéç½®æä»¶ï¼å è½½å®ç°ç±»ï¼å®ç°å¨è¿è¡æ¶å¨ææ¿æ¢æ¥å£çå®ç°ç±»ã\n\nä½¿ç¨ spi æºå¶è½å¤å®ç°æéç½®å è½½æ¥å£çå®ç°ç±»ï¼spi æºå¶å¨é¿éå¼æºçé¡¹ç®ä¸­è¢«å¹¿æ³ä½¿ç¨ï¼ä¾å¦ dubboãrocketmqãä»¥åæ¬æä»ç»ç sentinelãrocketmq ä¸ sentinel ä½¿ç¨çé½æ¯ java æä¾ç spi æºå¶ï¼è dubbo åæ¯ä½¿ç¨èªå®ç°çä¸å¥ spiï¼ä¸ java spi çéç½®æ¹å¼ä¸åï¼dubbo spi ä½¿ç¨ key-value æ¹å¼éç½®ï¼ç®çæ¯å®ç°èªéåºæ©å±æºå¶ã\n\njava ç spi æºå¶æä¾äº serviceloader.load(class<?> clazz) ç¨äºå è½½æå®ç±»çå®ç°ç±»ãå®å è½½æä»¶çè·¯å¾ä¸ºï¼\n\nresource/meta-inf/services/${æ¥å£çå¨éå®ç±»å}.\n\nå¨æä»¶ä¸­ä¹è¦å¡«æ¥å£çå®ç°ç±»çå¨éå®ç±»åï¼javaå°å¨é¨çå®ç°ç±»è¿åç»ç¨æ· ï¼\n\ncom.xiaohe.xxxxxx\n\n\nserviceloader<t> services = serviceloader.load(class<t> clazz);\n\n\nå è½½æ­¥éª¤ä¸º ï¼\n\n * æå® serviceloader.load(class clazz)\n * éè¿ clazz æ¿å°æ¥å£çå¨éå®ç±»åï¼å» resource/meta-inf/servicesç®å½ä¸å¯»æ¾å¯¹åºå¨éå®ç±»åçæä»¶\n * è¯»åè¯¥æä»¶çå¨é¨åå®¹ï¼æ¯ä¸ä¸ªåå®¹ä»¥æ¢è¡ç¬¦åéï¼\n * ä»¥éåçå½¢å¼è¿åç»ç¨æ·\n\n\n# 2. ä½¿ç¨javaçspiæºå¶\n\nåè®¾æå¾å¤ç§ç»å½æ¹å¼ï¼æä»¥ç»å½æ¥å£ï¼\n\npublic interface loginservice{\n  void login(string username,string password);\n}\n\n\næä¸¤ä¸ªå®ç°ç±»ï¼\n\npublic class shirologin implements loginservice{\n    @override\n    public void login(string username, string password) {\n        system.out.println("è§¦å shiro çç»å½åè½");\n    }\n}\n\n\npublic class springsecuritylogin implements loginservice{\n    @override\n    public void login(string username, string password) {\n        system.out.println("è§¦å springsecurity çç»å½åè½");\n    }\n}\n\n\nå¨ resource/meta-inf/services ç®å½ä¸åå»ºåä¸º com.xiaohe.spi.loginservice ï¼æ¥å£å¨éå®ç±»åï¼çæä»¶ï¼æä»¶ä¸­å¡«å¥ï¼\n\ncom.xiaohe.spi.springsecuritylogin\n\n\næä¸ºåªå è½½ springsecuritylogin çç»éæ¹å¼ãå½ç¶ä¹å¯ä»¥å¡«å¥½å ä¸ªï¼å¤ä¸ªä¹é´ä½¿ç¨æ¢è¡åå¼ã\n\nç¼åæµè¯ç±»ï¼\n\npublic static void main(string[] args) {\n    serviceloader<loginservice> services = serviceloader.load(loginservice.class);\n    \n    services.foreach(loginservice -> {\n        loginservice.login("å°æ", "123");\n    });\n}\n\n\næå° ï¼\n\nè§¦å springsecurity çç»å½åè½\n\n\n\n# 3. sentinel ä½¿ç¨ spi æºå¶åäºä»ä¹\n\næ³ç¥éåªéä½¿ç¨å°äº spiï¼æå¥½çæ¹å¼å°±æ¯å» resource/meta-inf/servicesç®å½ä¸æ¥çæå¤å°ä»¥å¨éå®ç±»åå½åçæä»¶ï¼sentinel1.8.1 çæ¬æä¸ä¸ªï¼\n\n\n\nç¬¬ä¸ä¸ªæ²¡è§è¿ææ¶ä¸è¯´ï¼ä½æ¯ç¬¬äºä¸ªåç¬¬ä¸ä¸ªå°±å¾ææ¾äºå§ã\n\nä½¿ç¨spiæºå¶å è½½ processorslot çç®ç ï¼å¯ä»¥å¨æä»¶ä¸­èªå®ä¹ slot çæ§è¡é¡ºåºã\n\nä½¿ç¨spiæºå¶å è½½ processorslotchain çç®ç ï¼å¯ä»¥å¨ä»£ç ä¸­èªå®ä¹ slot çæ§è¡é¡ºåºã\n\nåæ¥ç¥ä¸ç¼ sentinel ä¸­ defaultslotchainbuilder æå»º processorslotchain çè¿ç¨ ï¼\n\n@spi(isdefault = true)\npublic class defaultslotchainbuilder implements slotchainbuilder {\n\n    @override\n    public processorslotchain build() {\n        processorslotchain chain = new defaultprocessorslotchain();\n\n        list<processorslot> sortedslotlist = spiloader.of(processorslot.class).loadinstancelistsorted();\n        for (processorslot slot : sortedslotlist) {\n            // ææ slot å¿é¡»æ¯ abstractlinkedprocessorslot çå­ç±»\n            if (!(slot instanceof abstractlinkedprocessorslot)) {\n                // ææ¥å¿çä»£ç æå äº\n                continue;\n            }\n            chain.addlast((abstractlinkedprocessorslot<?>) slot);\n        }\n\n        return chain;\n    }\n}\n\n\nåæ¥çç resource/meta-inf/services/processorslot æä»¶ä¸­çåå®¹ ï¼\n\ncom.alibaba.csp.sentinel.slots.nodeselector.nodeselectorslot\ncom.alibaba.csp.sentinel.slots.clusterbuilder.clusterbuilderslot\ncom.alibaba.csp.sentinel.slots.logger.logslot\ncom.alibaba.csp.sentinel.slots.statistic.statisticslot\ncom.alibaba.csp.sentinel.slots.block.authority.authorityslot\ncom.alibaba.csp.sentinel.slots.system.systemslot\ncom.alibaba.csp.sentinel.slots.block.flow.flowslot\ncom.alibaba.csp.sentinel.slots.block.degrade.degradeslot\ncom.alibaba.csp.sentinel.slots.block.degrade.defaultcircuitbreakerslot\n\n\nè·æä¹åæå¨ new çæ§è¡é¡ºåºä¸æ ·ãåç»­æç« å°±ä¼å¯¹è¿äº slot æ¨ä¸ªè®²è§£ã',charsets:{cjk:!0},lastUpdated:"2023/12/11, 23:11:06",lastUpdatedTimestamp:1702307466e3},{title:"3. Sentinel - NodeSelectorSlot",frontmatter:{title:"3. Sentinel - NodeSelectorSlot",date:"2023-12-11T22:10:14.000Z",permalink:"/pages/f4866d/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/60.Sentinel/5.%20Sentinel%20-%20NodeSelectorSlot.html",relativePath:"02.æç« /91.æ¡æ¶/60.Sentinel/5. Sentinel - NodeSelectorSlot.md",key:"v-6f97f076",path:"/pages/f4866d/",headers:[{level:2,title:"0. åè¨",slug:"_0-åè¨",normalizedTitle:"0. åè¨",charIndex:2},{level:2,title:"1. æºç ",slug:"_1-æºç ",normalizedTitle:"1. æºç ",charIndex:190},{level:2,title:"2. mapçç¨å¤",slug:"_2-mapçç¨å¤",normalizedTitle:"2. mapçç¨å¤",charIndex:2225},{level:2,title:"3. å° Node æå¨æ ä¸",slug:"_3-å°-node-æå¨æ ä¸",normalizedTitle:"3. å° node æå¨æ ä¸",charIndex:3578},{level:2,title:"4. Nodeæ çæå»º",slug:"_4-nodeæ çæå»º",normalizedTitle:"4. nodeæ çæå»º",charIndex:4239},{level:2,title:"5. æ»ç»",slug:"_5-æ»ç»",normalizedTitle:"5. æ»ç»",charIndex:4403}],headersStr:"0. åè¨ 1. æºç  2. mapçç¨å¤ 3. å° Node æå¨æ ä¸ 4. Nodeæ çæå»º 5. æ»ç»",content:"# 0. åè¨\n\nç°å¨å°±å¼å§ç¬¬ä¸ä¸ª slot çè®²è§£äºï¼ä¸è¬æåµä¸ï¼slot é½å¨ /sentinel-core/com.alibaba.csp.sentinel.slots åä¸ï¼å¦ææä¸å¨çæä¼æ æ³¨ã\n\nNodeSelectorSlot çä½ç½® ï¼ /sentinel-core/com.alibaba.csp.sentinel.slots.nodeselector\n\n\n# 1. æºç \n\nNodeSelectorSlot çæºç ç¹å«å° ï¼\n\n@Spi(isSingleton = false, order = Constants.ORDER_NODE_SELECTOR_SLOT)\npublic class NodeSelectorSlot extends AbstractLinkedProcessorSlot<Object> {\n\n    // key : context.name\n    // value : default node\n    // ç¼å­åä¸èµæºä¸ºä¸åè°ç¨é¾è·¯å¥å£åå»ºç DefaultNode\n    private volatile Map<String, DefaultNode> map = new HashMap<String, DefaultNode>(10);\n\n    @Override\n    public void entry(Context context, \n                      ResourceWrapper resourceWrapper, \n                      Object obj, int count, \n                      boolean prioritized, \n                      Object... args) throws Throwable {\n        // æ ¹æ®context.nameä»mapä¸­æ¿ default node\n        // æ¿ä¸å°è¯´æè¿æ²¡æåå»ºï¼ä½¿ç¨åéæ£æ¥é\n        DefaultNode node = map.get(context.getName());\n        if (node == null) {\n            synchronized (this) {\n                node = map.get(context.getName());\n                if (node == null) {\n                    // åå»ºï¼æ¾å¥ã\n                    node = new DefaultNode(resourceWrapper, null);\n                    HashMap<String, DefaultNode> cacheMap = new HashMap<String, DefaultNode>(map.size());\n                    cacheMap.putAll(map);\n                    cacheMap.put(context.getName(), node);\n                    map = cacheMap;\n                    // æå»ºnodeæ ï¼æ¾å°å¶å­èç¹ä¸ã\n                    ((DefaultNode) context.getLastNode()).addChild(node);\n                }\n            }\n        }\n        // å° context çå½åèç¹è®¾ç½®ä¸º node\n        context.setCurNode(node);\n        // å¼å§å¶ä»çsloté»è¾\n        fireEntry(context, resourceWrapper, node, count, prioritized, args);\n    }\n\n    @Override\n    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {\n        fireExit(context, resourceWrapper, count, args);\n    }\n}\n\n\nentryæ¹æ³çåæ° ï¼\n\n * context ï¼å½åè°ç¨é¾è·¯ä¸ä¸æ\n * resourceWrapper ï¼èµæº\n * param ï¼æ³ååæ°ï¼ä¸è¬ç¨äºä¼ é DefaultNode\n * count ï¼ç³è¯·è®¿é®èµæºçæ°éï¼æ¯å¦è®¿é®éãå ç¨çº¿ç¨æ°éï¼count ä¸è¬ä¸º1\n * prioritized ï¼æ¯å¦å¯¹è¯·æ±è¿è¡ä¼åçº§æåºï¼ä¸è¬ä¸ºfalse\n * args ï¼è°ç¨æ¹æ³çåæ°ï¼ç¨äºå®ç°ç­ç¹åæ°éæµ\n\nä¹åå¶å®å·²ç»ä»ç»è¿åæ°äºï¼è¿éæ¯ä¸ºäºæ°´å­æ°è®©ä½ åå¿ä¸ä¸ã\n\næ´ä¸ªæºç æé¾çè§£çæä¸¤ä¸ªç¹ ï¼\n\n 1. map çç¨å¤\n 2. å°æ­¤nodeæå¨æ ä¸\n\n\n# 2. mapçç¨å¤\n\n// key : context name\n// value : node\nprivate volatile Map<String, DefaultNode> map = new HashMap<String, DefaultNode>(10);\n\n\nå¨ä¹åçä»ç»ä¸­æä»¬å·²ç»ç¥éï¼context.name ä¸è¬é½æ¯æå®çï¼ä¾å¦ sentinel_default_contextãsentinel_spring_web_contextãsentinel_dubbo_context.....\n\nè¿éä¸ºå¥å° Node å¨ Map ä¸­å¯¹åºç key è®¾ç½®ä¸º context.name å¢ï¼\n\nmap å­æ®µæ¯ä¸ä¸ªééæå­æ®µï¼æå³çæ¯ä¸ª NodeSelectorSlot é½æä¸ä¸ª mapãç±äºä¸ä¸ªèµæºå¯¹åºä¸ä¸ª ProcessorSlotChainï¼èä¸ä¸ª ProcessorSlotChain åªåå»ºä¸ä¸ª NodeSelectorSlotï¼å¹¶ä¸ map ç¼å­ DefaultNode ä½¿ç¨ç key å¹¶éèµæº IDï¼èæ¯ Context.nameï¼æä»¥ map çä½ç¨æ¯ç¼å­éå¯¹åä¸èµæºå¨ä¸åè°ç¨é¾è·¯åå»ºç DefaultNodeã\n\né£ä½ è¯´å¦æåä¸ä¸ªè°ç¨é¾ä¸­æä¿©ååçèµæºååï¼ååèµæºä¸ä¼éæ°åå»º Nodeå¦ï¼ä½ çä¸é¢çé»è¾ï¼å¦æ map.get() å°äºå°±ä¸ä¼ç»§ç»­åå»ºäºï¼å¦ææ²¡ægetå°æä¼ç»§ç»­åå»ºã\n\n@Override\npublic void entry(Context context, \n                  ResourceWrapper resourceWrapper, \n                  Object obj, int count, \n                  boolean prioritized, \n                  Object... args) throws Throwable {\n    // æ ¹æ®context.nameä»mapä¸­æ¿ default node\n    // æ¿ä¸å°è¯´æè¿æ²¡æåå»ºï¼ä½¿ç¨åéæ£æ¥é\n    DefaultNode node = map.get(context.getName());\n    if (node == null) {\n        // çç¥ä»£ç ï¼ä½¿ç¨åéæ£æ¥éåå»º node å¹¶æ¾å¥ map\n    }\n    // å° context çå½åèç¹è®¾ç½®ä¸º node\n    context.setCurNode(node);\n    // å¼å§å¶ä»çsloté»è¾\n    fireEntry(context, resourceWrapper, node, count, prioritized, args);\n}\n\n\næ¯å¦ä¼åå»ºåå node çé®é¢ï¼ä½ å¯ä»¥ä½¿ç¨ SentinelResource å£°æä¸ä¸ªååèµæºå°è¯ä¸ä¸ãåæ¶å»ºè®®ä½¿ç¨ sentinel-demo/sentinel-demo-spring-webmvc è¿è¡ debugï¼å ä¸º sentinel-demo-basic ä¸çæµè¯ç±»æ¯å¹¶åçï¼æä»¥ä¸å¥½debugï¼ä¸ç´è§ã\n\n\n# 3. å° Node æå¨æ ä¸\n\n // æå»ºnodeæ ï¼æ¾å°å¶å­èç¹ä¸ã\n((DefaultNode) context.getLastNode()).addChild(node);\n\n\nå°±æ¯è¿æ®µä»£ç ï¼è·å context ä¸­ç last nodeï¼å°æ­¤èç¹å½ä½ last node çå­èç¹ï¼æä»¥åªéè¦ç¥é last node æ¯å¥å°±è¡äºã\n\npublic Node getLastNode() {\n    if (curEntry != null && curEntry.getLastNode() != null) {\n        return curEntry.getLastNode();\n    } else {\n        return entranceNode;\n    }\n}\n\n\n// CtEntry ä¸­ç getLastNode()\n@Override\npublic Node getLastNode() {\n    return parent == null ? null : parent.getCurNode();\n}\n\n\nå¦æå½åæ¯ Entry æ§è¡ä¸­ç¬¬ä¸ä¸ªèµæºï¼é£ä¹å®ç Entry è¯å®æ¯æ²¡æ parent çï¼æä»¥ä¼è¿å entranceNodeãä¹å°±æ¯å°æ­¤Nodeæå¨å¥å£èç¹ä¸ã\n\nå¦æå½åæ¯ Entry æ§è¡ä¸­çç¬¬ n ä¸ªèµæº(n>1)ï¼å®ç Entry ä¸å®æparentï¼ä¼è¿åä¸ä¸ä¸ª Entry çnodeãæ¿å°è¿ä¸ªè°ç¨é¾ä¸æåä¸ä¸ªèç¹ï¼å°æ­¤èç¹æä¸å°±è¡äºã\n\n\n# 4. Nodeæ çæå»º\n\n 1. ROOT ï¼å¸¸éï¼æ©å°±åå»ºå¥½äº\n 2. EntranceNode ï¼ContextUtil å¨åå»º Context æ¶é¡ºå¸¦åå»ºçï¼åä» map ä¸­æ¾ï¼æ²¡æ¾å°å°±åå»ºï¼åå»ºä¹åæå¨ ROOT ä¸ãæ¾å° map ä¸­ã\n 3. DefaultNode ï¼Entryæ§è¡æ¶åå»ºå¹¶æå¨Nodeæ ä¸\n\n\n# 5. æ»ç»\n\nå¶å®åè¿ç¯æç« çæ¶åæèªå·±æ´æµé¼äºç¶ååå»æ¹äºä¹åçæç« ï¼åå¼ºè°ä¸ä¸ ï¼\n\n 1. Context ææ å½åè°ç¨é¾è·¯çå¥å£èç¹ å å½åè°ç¨é¾è·¯Entry\n 2. ä½æ¯å¥å£èç¹å¹¶ä¸åä¸Entryçåå»ºä¸æ§è¡ã",normalizedContent:"# 0. åè¨\n\nç°å¨å°±å¼å§ç¬¬ä¸ä¸ª slot çè®²è§£äºï¼ä¸è¬æåµä¸ï¼slot é½å¨ /sentinel-core/com.alibaba.csp.sentinel.slots åä¸ï¼å¦ææä¸å¨çæä¼æ æ³¨ã\n\nnodeselectorslot çä½ç½® ï¼ /sentinel-core/com.alibaba.csp.sentinel.slots.nodeselector\n\n\n# 1. æºç \n\nnodeselectorslot çæºç ç¹å«å° ï¼\n\n@spi(issingleton = false, order = constants.order_node_selector_slot)\npublic class nodeselectorslot extends abstractlinkedprocessorslot<object> {\n\n    // key : context.name\n    // value : default node\n    // ç¼å­åä¸èµæºä¸ºä¸åè°ç¨é¾è·¯å¥å£åå»ºç defaultnode\n    private volatile map<string, defaultnode> map = new hashmap<string, defaultnode>(10);\n\n    @override\n    public void entry(context context, \n                      resourcewrapper resourcewrapper, \n                      object obj, int count, \n                      boolean prioritized, \n                      object... args) throws throwable {\n        // æ ¹æ®context.nameä»mapä¸­æ¿ default node\n        // æ¿ä¸å°è¯´æè¿æ²¡æåå»ºï¼ä½¿ç¨åéæ£æ¥é\n        defaultnode node = map.get(context.getname());\n        if (node == null) {\n            synchronized (this) {\n                node = map.get(context.getname());\n                if (node == null) {\n                    // åå»ºï¼æ¾å¥ã\n                    node = new defaultnode(resourcewrapper, null);\n                    hashmap<string, defaultnode> cachemap = new hashmap<string, defaultnode>(map.size());\n                    cachemap.putall(map);\n                    cachemap.put(context.getname(), node);\n                    map = cachemap;\n                    // æå»ºnodeæ ï¼æ¾å°å¶å­èç¹ä¸ã\n                    ((defaultnode) context.getlastnode()).addchild(node);\n                }\n            }\n        }\n        // å° context çå½åèç¹è®¾ç½®ä¸º node\n        context.setcurnode(node);\n        // å¼å§å¶ä»çsloté»è¾\n        fireentry(context, resourcewrapper, node, count, prioritized, args);\n    }\n\n    @override\n    public void exit(context context, resourcewrapper resourcewrapper, int count, object... args) {\n        fireexit(context, resourcewrapper, count, args);\n    }\n}\n\n\nentryæ¹æ³çåæ° ï¼\n\n * context ï¼å½åè°ç¨é¾è·¯ä¸ä¸æ\n * resourcewrapper ï¼èµæº\n * param ï¼æ³ååæ°ï¼ä¸è¬ç¨äºä¼ é defaultnode\n * count ï¼ç³è¯·è®¿é®èµæºçæ°éï¼æ¯å¦è®¿é®éãå ç¨çº¿ç¨æ°éï¼count ä¸è¬ä¸º1\n * prioritized ï¼æ¯å¦å¯¹è¯·æ±è¿è¡ä¼åçº§æåºï¼ä¸è¬ä¸ºfalse\n * args ï¼è°ç¨æ¹æ³çåæ°ï¼ç¨äºå®ç°ç­ç¹åæ°éæµ\n\nä¹åå¶å®å·²ç»ä»ç»è¿åæ°äºï¼è¿éæ¯ä¸ºäºæ°´å­æ°è®©ä½ åå¿ä¸ä¸ã\n\næ´ä¸ªæºç æé¾çè§£çæä¸¤ä¸ªç¹ ï¼\n\n 1. map çç¨å¤\n 2. å°æ­¤nodeæå¨æ ä¸\n\n\n# 2. mapçç¨å¤\n\n// key : context name\n// value : node\nprivate volatile map<string, defaultnode> map = new hashmap<string, defaultnode>(10);\n\n\nå¨ä¹åçä»ç»ä¸­æä»¬å·²ç»ç¥éï¼context.name ä¸è¬é½æ¯æå®çï¼ä¾å¦ sentinel_default_contextãsentinel_spring_web_contextãsentinel_dubbo_context.....\n\nè¿éä¸ºå¥å° node å¨ map ä¸­å¯¹åºç key è®¾ç½®ä¸º context.name å¢ï¼\n\nmap å­æ®µæ¯ä¸ä¸ªééæå­æ®µï¼æå³çæ¯ä¸ª nodeselectorslot é½æä¸ä¸ª mapãç±äºä¸ä¸ªèµæºå¯¹åºä¸ä¸ª processorslotchainï¼èä¸ä¸ª processorslotchain åªåå»ºä¸ä¸ª nodeselectorslotï¼å¹¶ä¸ map ç¼å­ defaultnode ä½¿ç¨ç key å¹¶éèµæº idï¼èæ¯ context.nameï¼æä»¥ map çä½ç¨æ¯ç¼å­éå¯¹åä¸èµæºå¨ä¸åè°ç¨é¾è·¯åå»ºç defaultnodeã\n\né£ä½ è¯´å¦æåä¸ä¸ªè°ç¨é¾ä¸­æä¿©ååçèµæºååï¼ååèµæºä¸ä¼éæ°åå»º nodeå¦ï¼ä½ çä¸é¢çé»è¾ï¼å¦æ map.get() å°äºå°±ä¸ä¼ç»§ç»­åå»ºäºï¼å¦ææ²¡ægetå°æä¼ç»§ç»­åå»ºã\n\n@override\npublic void entry(context context, \n                  resourcewrapper resourcewrapper, \n                  object obj, int count, \n                  boolean prioritized, \n                  object... args) throws throwable {\n    // æ ¹æ®context.nameä»mapä¸­æ¿ default node\n    // æ¿ä¸å°è¯´æè¿æ²¡æåå»ºï¼ä½¿ç¨åéæ£æ¥é\n    defaultnode node = map.get(context.getname());\n    if (node == null) {\n        // çç¥ä»£ç ï¼ä½¿ç¨åéæ£æ¥éåå»º node å¹¶æ¾å¥ map\n    }\n    // å° context çå½åèç¹è®¾ç½®ä¸º node\n    context.setcurnode(node);\n    // å¼å§å¶ä»çsloté»è¾\n    fireentry(context, resourcewrapper, node, count, prioritized, args);\n}\n\n\næ¯å¦ä¼åå»ºåå node çé®é¢ï¼ä½ å¯ä»¥ä½¿ç¨ sentinelresource å£°æä¸ä¸ªååèµæºå°è¯ä¸ä¸ãåæ¶å»ºè®®ä½¿ç¨ sentinel-demo/sentinel-demo-spring-webmvc è¿è¡ debugï¼å ä¸º sentinel-demo-basic ä¸çæµè¯ç±»æ¯å¹¶åçï¼æä»¥ä¸å¥½debugï¼ä¸ç´è§ã\n\n\n# 3. å° node æå¨æ ä¸\n\n // æå»ºnodeæ ï¼æ¾å°å¶å­èç¹ä¸ã\n((defaultnode) context.getlastnode()).addchild(node);\n\n\nå°±æ¯è¿æ®µä»£ç ï¼è·å context ä¸­ç last nodeï¼å°æ­¤èç¹å½ä½ last node çå­èç¹ï¼æä»¥åªéè¦ç¥é last node æ¯å¥å°±è¡äºã\n\npublic node getlastnode() {\n    if (curentry != null && curentry.getlastnode() != null) {\n        return curentry.getlastnode();\n    } else {\n        return entrancenode;\n    }\n}\n\n\n// ctentry ä¸­ç getlastnode()\n@override\npublic node getlastnode() {\n    return parent == null ? null : parent.getcurnode();\n}\n\n\nå¦æå½åæ¯ entry æ§è¡ä¸­ç¬¬ä¸ä¸ªèµæºï¼é£ä¹å®ç entry è¯å®æ¯æ²¡æ parent çï¼æä»¥ä¼è¿å entrancenodeãä¹å°±æ¯å°æ­¤nodeæå¨å¥å£èç¹ä¸ã\n\nå¦æå½åæ¯ entry æ§è¡ä¸­çç¬¬ n ä¸ªèµæº(n>1)ï¼å®ç entry ä¸å®æparentï¼ä¼è¿åä¸ä¸ä¸ª entry çnodeãæ¿å°è¿ä¸ªè°ç¨é¾ä¸æåä¸ä¸ªèç¹ï¼å°æ­¤èç¹æä¸å°±è¡äºã\n\n\n# 4. nodeæ çæå»º\n\n 1. root ï¼å¸¸éï¼æ©å°±åå»ºå¥½äº\n 2. entrancenode ï¼contextutil å¨åå»º context æ¶é¡ºå¸¦åå»ºçï¼åä» map ä¸­æ¾ï¼æ²¡æ¾å°å°±åå»ºï¼åå»ºä¹åæå¨ root ä¸ãæ¾å° map ä¸­ã\n 3. defaultnode ï¼entryæ§è¡æ¶åå»ºå¹¶æå¨nodeæ ä¸\n\n\n# 5. æ»ç»\n\nå¶å®åè¿ç¯æç« çæ¶åæèªå·±æ´æµé¼äºç¶ååå»æ¹äºä¹åçæç« ï¼åå¼ºè°ä¸ä¸ ï¼\n\n 1. context ææ å½åè°ç¨é¾è·¯çå¥å£èç¹ å å½åè°ç¨é¾è·¯entry\n 2. ä½æ¯å¥å£èç¹å¹¶ä¸åä¸entryçåå»ºä¸æ§è¡ã",charsets:{cjk:!0},lastUpdated:"2023/12/11, 23:11:06",lastUpdatedTimestamp:1702307466e3},{title:"4. Sentinel - ClusterBuilderSlot",frontmatter:{title:"4. Sentinel - ClusterBuilderSlot",date:"2023-12-11T22:11:03.000Z",permalink:"/pages/df7ccb/"},regularPath:"/02.%E6%96%87%E7%AB%A0/91.%E6%A1%86%E6%9E%B6/60.Sentinel/6.%20Sentinel%20-%20ClusterBuilderSlot.html",relativePath:"02.æç« /91.æ¡æ¶/60.Sentinel/6. Sentinel - ClusterBuilderSlot.md",key:"v-34b36bf8",path:"/pages/df7ccb/",headers:[{level:2,title:"1. åè¨",slug:"_1-åè¨",normalizedTitle:"1. åè¨",charIndex:2},{level:2,title:"2. æºç ",slug:"_2-æºç ",normalizedTitle:"2. æºç ",charIndex:69}],headersStr:"1. åè¨ 2. æºç ",content:'# 1. åè¨\n\nä¸ä¸ç¯æç« è®²è§£äº NodeSelectorSlot å°èç¹æå¨ Node æ ä¸ï¼è¿ç¯è®²ä¸ä¸ä¸ºèç¹åå»ºå¨å±èç¹ã\n\n\n# 2. æºç \n\nä»£ç ç¹å«ç®åï¼ç±äºå¨å±èç¹ä¸ç¨æ¯æ¬¡é½æ°å»ºï¼æä»¥æä»¬ç¨ Map è®°å½å·²ç»åå»ºå¥½çå¨å±èç¹ï¼ç»è¿ ClusterBuilderSlot ç Entry åªéè¦å¤æ­ Map éé¢ææ²¡æåå»ºå¥½çï¼æäºå°±ç¨ï¼æ²¡æå°±åå»ºã\n\n@Spi(isSingleton = false, order = Constants.ORDER_CLUSTER_BUILDER_SLOT)\npublic class ClusterBuilderSlot extends AbstractLinkedProcessorSlot<DefaultNode> {\n\t// ä¿å­å·²åå»ºçå¨å±èç¹\n    private static volatile Map<ResourceWrapper, ClusterNode> clusterNodeMap = new HashMap<>();\n\t// æä½ clusterNodeMap æ¶éè¦å¹¶åå®å¨\n    private static final Object lock = new Object();\n\t// å½å SlotChain çå¨å±èç¹ã\n    private volatile ClusterNode clusterNode = null;\n\n    @Override\n    public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args)\n        throws Throwable {\n        // çæçéæ¹ï¼çæçå³éï¼çæçåéæ£æ¥é\n        if (clusterNode == null) {\n            synchronized (lock) {\n                if (clusterNode == null) {\n                    // Create the cluster node.\n                    clusterNode = new ClusterNode(resourceWrapper.getName(), resourceWrapper.getResourceType());\n                    HashMap<ResourceWrapper, ClusterNode> newMap = new HashMap<>(Math.max(clusterNodeMap.size(), 16));\n                    newMap.putAll(clusterNodeMap);\n                    newMap.put(node.getId(), clusterNode);\n\n                    clusterNodeMap = newMap;\n                }\n            }\n        }\n        // å°å½åéåå°çDefaultNodeçCluæä¸ã\n        node.setClusterNode(clusterNode);\n\t\t// å¦æè¿ä¸ªèç¹æè°ç¨æ¥æºï¼æ¿å°è°ç¨æ¥æºï¼ç»å®åå»ºä¸ä¸ªèç¹ï¼è®¾ç½®ä¸ºæ­¤æ¬¡è°ç¨ç origin node\n        if (!"".equals(context.getOrigin())) {\n            Node originNode = node.getClusterNode().getOrCreateOriginNode(context.getOrigin());\n            context.getCurEntry().setOriginNode(originNode);\n        }\n\t\t// æ§è¡ä¸ä¸ä¸ª slot\n        fireEntry(context, resourceWrapper, node, count, prioritized, args);\n    }\n\n    @Override\n    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {\n        fireExit(context, resourceWrapper, count, args);\n    }\n}\n\n\nå¯ä¸å¯è½æçæçå¯è½æ¯é£ä¸æ®µè®¾ç½® origin node çä»£ç ãä¸¾ä¾è¯´æï¼\n\n\n\nå¦ä¸ï¼hello1è¿ç¨è°ç¨ hello2ï¼è¿æ · hello2 ä¹å°±æäº orginï¼æäº origin å°±è¦ç»å½åæ§è¡çä¸ä¸æ context è®¾ç½®OriginNodeãæä»¥å¨ sentinel_grpc_context è¿ä¸ç«¯ä¼è§£æå° origin = hello1ï¼éè¿è¿ä¸ªåå­æ¿å°å¯¹åºçèç¹ã\n\nå¨åé¢çç« èä¸­å·²ç»è¯´è¿ï¼è¿éå°±ä¸åè¯¦ç»åè¿°äºã\n\npublic class ClusterNode extends StatisticNode {\n    public Node getOrCreateOriginNode(String origin) {\n        StatisticNode statisticNode = originCountMap.get(origin);\n        if (statisticNode == null) {\n            lock.lock();\n            try {\n                statisticNode = originCountMap.get(origin);\n                if (statisticNode == null) {\n                    statisticNode = new StatisticNode();\n                    HashMap<String, StatisticNode> newMap = new HashMap<>(originCountMap.size() + 1);\n                    newMap.putAll(originCountMap);\n                    newMap.put(origin, statisticNode);\n                    originCountMap = newMap;\n                }\n            } finally {\n                lock.unlock();\n            }\n        }\n        return statisticNode;\n\t}\n}\n\n\n\nç¶åä½ ä¼çå°æä¸ä¸ªåé ï¼originCountMapï¼è¿ä¸ªæ¯ ClusterNode åé¨çåéï¼ç¨äºç¼å­ origin ä¸ StatisticNode çæ å°ãç±äºä¸ä¸ª ClusterNode å¯è½æå¤ä¸ª DefaultNodeï¼ä½¿ç¨ Map è®°å½è¿äº origin-StatisticNode é®å¼å¯¹ï¼ä»¥ååæè¿ç§è°ç¨å°±å¯ä»¥ç´æ¥è·åã\n\nprivate Map<String, StatisticNode> originCountMap = new HashMap<>();\n\nprivate final ReentrantLock lock = new ReentrantLock();\n',normalizedContent:'# 1. åè¨\n\nä¸ä¸ç¯æç« è®²è§£äº nodeselectorslot å°èç¹æå¨ node æ ä¸ï¼è¿ç¯è®²ä¸ä¸ä¸ºèç¹åå»ºå¨å±èç¹ã\n\n\n# 2. æºç \n\nä»£ç ç¹å«ç®åï¼ç±äºå¨å±èç¹ä¸ç¨æ¯æ¬¡é½æ°å»ºï¼æä»¥æä»¬ç¨ map è®°å½å·²ç»åå»ºå¥½çå¨å±èç¹ï¼ç»è¿ clusterbuilderslot ç entry åªéè¦å¤æ­ map éé¢ææ²¡æåå»ºå¥½çï¼æäºå°±ç¨ï¼æ²¡æå°±åå»ºã\n\n@spi(issingleton = false, order = constants.order_cluster_builder_slot)\npublic class clusterbuilderslot extends abstractlinkedprocessorslot<defaultnode> {\n\t// ä¿å­å·²åå»ºçå¨å±èç¹\n    private static volatile map<resourcewrapper, clusternode> clusternodemap = new hashmap<>();\n\t// æä½ clusternodemap æ¶éè¦å¹¶åå®å¨\n    private static final object lock = new object();\n\t// å½å slotchain çå¨å±èç¹ã\n    private volatile clusternode clusternode = null;\n\n    @override\n    public void entry(context context, resourcewrapper resourcewrapper, defaultnode node, int count, boolean prioritized, object... args)\n        throws throwable {\n        // çæçéæ¹ï¼çæçå³éï¼çæçåéæ£æ¥é\n        if (clusternode == null) {\n            synchronized (lock) {\n                if (clusternode == null) {\n                    // create the cluster node.\n                    clusternode = new clusternode(resourcewrapper.getname(), resourcewrapper.getresourcetype());\n                    hashmap<resourcewrapper, clusternode> newmap = new hashmap<>(math.max(clusternodemap.size(), 16));\n                    newmap.putall(clusternodemap);\n                    newmap.put(node.getid(), clusternode);\n\n                    clusternodemap = newmap;\n                }\n            }\n        }\n        // å°å½åéåå°çdefaultnodeçcluæä¸ã\n        node.setclusternode(clusternode);\n\t\t// å¦æè¿ä¸ªèç¹æè°ç¨æ¥æºï¼æ¿å°è°ç¨æ¥æºï¼ç»å®åå»ºä¸ä¸ªèç¹ï¼è®¾ç½®ä¸ºæ­¤æ¬¡è°ç¨ç origin node\n        if (!"".equals(context.getorigin())) {\n            node originnode = node.getclusternode().getorcreateoriginnode(context.getorigin());\n            context.getcurentry().setoriginnode(originnode);\n        }\n\t\t// æ§è¡ä¸ä¸ä¸ª slot\n        fireentry(context, resourcewrapper, node, count, prioritized, args);\n    }\n\n    @override\n    public void exit(context context, resourcewrapper resourcewrapper, int count, object... args) {\n        fireexit(context, resourcewrapper, count, args);\n    }\n}\n\n\nå¯ä¸å¯è½æçæçå¯è½æ¯é£ä¸æ®µè®¾ç½® origin node çä»£ç ãä¸¾ä¾è¯´æï¼\n\n\n\nå¦ä¸ï¼hello1è¿ç¨è°ç¨ hello2ï¼è¿æ · hello2 ä¹å°±æäº orginï¼æäº origin å°±è¦ç»å½åæ§è¡çä¸ä¸æ context è®¾ç½®originnodeãæä»¥å¨ sentinel_grpc_context è¿ä¸ç«¯ä¼è§£æå° origin = hello1ï¼éè¿è¿ä¸ªåå­æ¿å°å¯¹åºçèç¹ã\n\nå¨åé¢çç« èä¸­å·²ç»è¯´è¿ï¼è¿éå°±ä¸åè¯¦ç»åè¿°äºã\n\npublic class clusternode extends statisticnode {\n    public node getorcreateoriginnode(string origin) {\n        statisticnode statisticnode = origincountmap.get(origin);\n        if (statisticnode == null) {\n            lock.lock();\n            try {\n                statisticnode = origincountmap.get(origin);\n                if (statisticnode == null) {\n                    statisticnode = new statisticnode();\n                    hashmap<string, statisticnode> newmap = new hashmap<>(origincountmap.size() + 1);\n                    newmap.putall(origincountmap);\n                    newmap.put(origin, statisticnode);\n                    origincountmap = newmap;\n                }\n            } finally {\n                lock.unlock();\n            }\n        }\n        return statisticnode;\n\t}\n}\n\n\n\nç¶åä½ ä¼çå°æä¸ä¸ªåé ï¼origincountmapï¼è¿ä¸ªæ¯ clusternode åé¨çåéï¼ç¨äºç¼å­ origin ä¸ statisticnode çæ å°ãç±äºä¸ä¸ª clusternode å¯è½æå¤ä¸ª defaultnodeï¼ä½¿ç¨ map è®°å½è¿äº origin-statisticnode é®å¼å¯¹ï¼ä»¥ååæè¿ç§è°ç¨å°±å¯ä»¥ç´æ¥è·åã\n\nprivate map<string, statisticnode> origincountmap = new hashmap<>();\n\nprivate final reentrantlock lock = new reentrantlock();\n',charsets:{cjk:!0},lastUpdated:"2023/12/12, 20:57:13",lastUpdatedTimestamp:1702385833e3},{title:"èç³»æ",frontmatter:{title:"èç³»æ",date:"2020-05-12T15:09:57.000Z",permalink:"/pages/1b12ed",sidebar:!1,article:!1},regularPath:"/06.%E8%81%94%E7%B3%BB%E6%88%91/01.%E8%81%94%E7%B3%BB%E6%88%91.html",relativePath:"06.èç³»æ/01.èç³»æ.md",key:"v-c3e06076",path:"/pages/1b12ed/",headersStr:null,content:"å¦ææ¨æ­£å¨éè¯»è¿éçç¬è®°å¹¶åç°æä»ä¹ä¸æçå°æ¹ï¼æèåç°æä»»ä½å°æ¹æé®é¢ï¼æ¨å¯ä»¥éè¿å¦ä¸ä»»ææ¹å¼èç³»æï¼\n\nèç³»æ\n\nQQ: 3175543112\né®ç®±: 3175543112@qq.com",normalizedContent:"å¦ææ¨æ­£å¨éè¯»è¿éçç¬è®°å¹¶åç°æä»ä¹ä¸æçå°æ¹ï¼æèåç°æä»»ä½å°æ¹æé®é¢ï¼æ¨å¯ä»¥éè¿å¦ä¸ä»»ææ¹å¼èç³»æï¼\n\nèç³»æ\n\nqq: 3175543112\né®ç®±: 3175543112@qq.com",charsets:{cjk:!0},lastUpdated:"2023/06/09, 22:41:05",lastUpdatedTimestamp:1686321665e3},{title:"åå®¢æç« ",frontmatter:{archivesPage:!0,title:"åå®¢æç« ",permalink:"/blog/",article:!1},regularPath:"/@pages/archivesPage.html",relativePath:"@pages/archivesPage.md",key:"v-391a0836",path:"/blog/",headersStr:null,content:"",normalizedContent:"",charsets:{},lastUpdated:"2020/05/29, 16:33:54",lastUpdatedTimestamp:1590741234e3},{title:"Home",frontmatter:{home:!0,heroImage:"/img/logo.png",heroText:"ä½",tagline:"ðçåæäº®ï¼å³ä½¿å è½ä¹æ¯å¨ææ²³ä¹é´",actionText:"å¼å§ä½¿ç¨ â",actionLink:"/pages/259a4b/",bannerBg:"none",postList:"none"},regularPath:"/",relativePath:"index.md",key:"v-5f6c1111",path:"/",headersStr:null,content:"èç³»æ",normalizedContent:"èç³»æ",charsets:{cjk:!0},lastUpdated:"2023/06/14, 09:41:46",lastUpdatedTimestamp:1686706906e3}],themeConfig:{nav:[{text:"é¦é¡µ",link:"/"},{text:"æç« ",link:"/pages/259a4b/"},{text:"èç³»æ",link:"/pages/1b12ed/"}],sidebarDepth:2,logo:"/img/logo.png",repo:"https://github.com/2382546457",searchMaxSuggestions:10,lastUpdated:"ä¸æ¬¡æ´æ°",sidebar:{"/02.æç« /":[["00.è¯´æ.md","è¯´æ","/pages/259a4b/"],{title:"Javaåºç¡",collapsable:!0,children:[["01.Javaåºç¡/100.Java NIO.md","Java NIO","/pages/5c396f/"],["01.Javaåºç¡/150.Reactoræ¨¡å¼.md","Reatoræ¨¡å¼","/pages/0c2518/"],["01.Javaåºç¡/300.åæºå®æ¶ä»»å¡çå®ç°.md","åæºå®æ¶ä»»å¡çå®ç°","/pages/d8c9ba/"],["01.Javaåºç¡/1000.Javaå¯¹äºé¶æ·è´çå®ç°.md","Javaå¯¹äºé¶æ·è´çå®ç°","/pages/a5b563/"]]},{title:"MySQL",collapsable:!0,children:[["02.MySQL/01.InnoDB - è¡æ ¼å¼.md","InnoDB - è¡æ ¼å¼","/pages/493ffc/"],["02.MySQL/05.InnoDB - é¡µç»æ.md","InnoDB - é¡µç»æ","/pages/b3086d/"],["02.MySQL/10.InnoDB - B+æ ç´¢å¼.md","InnoDB - B+æ ç´¢å¼","/pages/26e2d2/"],["02.MySQL/15.InnoDB - redo log å undo log.md","InnoDB - redo log å undo log","/pages/495592/"],["02.MySQL/17.InnoDB - Buffer Pool.md","InnoDB - Buffer Pool","/pages/31e077/"],["02.MySQL/20.InnoDB - é.md","InnoDB - é","/pages/2e3013/"]]},{title:"Redis",collapsable:!0,children:[["10.Redis/10.Redisæ°æ®ç»æä¸æ°æ®ç±»å.md","Redisæ°æ®ç»æä¸æ°æ®ç±»å","/pages/77c4c7/"],["10.Redis/20.Redis æä¹åæºå¶.md","Redis æä¹åæºå¶","/pages/4e0b96/"],["10.Redis/30.Redisåå­åæ¶.md","Redisåå­åæ¶","/pages/73749d/"],["10.Redis/40.Redisä¸»ä»éç¾¤åç.md","Redisä¸»ä»éç¾¤åç","/pages/db45e7/"],["10.Redis/50.Rediså¨åµéç¾¤.md","Rediså¨åµéç¾¤","/pages/3743cc/"]]},{title:"æä½ç³»ç»",collapsable:!0,children:[["60.æä½ç³»ç»/10.ç¨æ·æååæ ¸æ.md","ç¨æ·æååæ ¸æ","/pages/c6965c/"],["60.æä½ç³»ç»/20.ç¼å­ä¸è´æ§åè®®ï¼MESI.md","ç¼å­ä¸è´æ§åè®®ï¼MESI","/pages/ee38bc/"],["60.æä½ç³»ç»/110.é¶æ·è´.md","é¶æ·è´","/pages/dbd03e/"]]},{title:"è®¡ç®æºç½ç»",collapsable:!0,children:[["70.è®¡ç®æºç½ç»/4.è®¡ç®æºç½ç»äºå±ç½ç»æ¨¡å.md","è®¡ç®æºç½ç»äºå±ç½ç»æ¨¡å","/pages/71bea1/"],["70.è®¡ç®æºç½ç»/10.TCPãUDPåè®®.md","TCPãUDPåè®®","/pages/424c75/"]]},{title:"Javaå¹¶å",collapsable:!0,children:[["75.Javaå¹¶å/50.CAS.md","CAS","/pages/56d8fa/"],["75.Javaå¹¶å/60.AQSæºç è§£æ.md","AQSæºç è§£æ","/pages/6c8c00/"],["75.Javaå¹¶å/65.ReentrantLock.md","ReentrantLock æºç è§£æ","/pages/5031c2/"],["75.Javaå¹¶å/70.ReentrantReadWriteLock.md","ReentrantReadWriteLock æºç è§£æ","/pages/6cfda5/"],["75.Javaå¹¶å/100.åå­ç±».md","åå­ç±»","/pages/0776e3/"],["75.Javaå¹¶å/200.FutureTaskæºç è§£æ.md","FutureTaskæºç è§£æ","/pages/937dd3/"],["75.Javaå¹¶å/250.FutureTaskä¸­çééå¨æ¨¡å¼.md","FutureTaskä¸­çééå¨æ¨¡å¼","/pages/c1826d/"],["75.Javaå¹¶å/300.çº¿ç¨æ± .md","çº¿ç¨æ± ","/pages/671511/"],["75.Javaå¹¶å/400.çº¿ç¨æ± æºç è§£æ.md","çº¿ç¨æ± æºç è§£æ","/pages/79cb1d/"]]},{title:"ç®æ³",collapsable:!0,children:[["85.ç®æ³/1.è´è½½åè¡¡ç®æ³.md","è´è½½åè¡¡ç®æ³","/pages/97a05f/"],["85.ç®æ³/20.éæµç®æ³.md","éæµç®æ³","/pages/5dba8e/"],["85.ç®æ³/30.ä¸è´æ§åå¸ç®æ³.md","ä¸è´æ§åå¸ç®æ³","/pages/7e25cb/"],["85.ç®æ³/40.éªè±ç®æ³.md","éªè±ç®æ³","/pages/3fe609/"]]},{title:"æ¡æ¶",collapsable:!0,children:[{title:"çè®º",collapsable:!0,children:[["91.æ¡æ¶/1.çè®º/10.CAPçè®º.md","CAPçè®º","/pages/db9f45/"],["91.æ¡æ¶/1.çè®º/20.BASEçè®º.md","BASEçè®º","/pages/793cbb/"],["91.æ¡æ¶/1.çè®º/30.Raftç®æ³.md","Raftç®æ³","/pages/208bb3/"]]},{title:"Spring",collapsable:!0,children:[["91.æ¡æ¶/5.Spring/100.Springäºå¡.md","Springäºå¡","/pages/b4dd7e/"]]},{title:"å¾®æå¡ä¸­é´ä»¶çä½¿ç¨",collapsable:!0,children:[["91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/10.Nacos.md","Nacos","/pages/243013/"],["91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/20.Ribbon.md","Ribbon","/pages/afe80c/"],["91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/30.OpenFeign.md","OpenFeign","/pages/e020ec/"],["91.æ¡æ¶/20.å¾®æå¡ä¸­é´ä»¶çä½¿ç¨/40.Sentinel.md","Sentinel","/pages/a7a70b/"]]},{title:"Sentinel",collapsable:!0,children:[["91.æ¡æ¶/60.Sentinel/3. Sentinelä¸­çä¸äºæ¦å¿µ.md","1. Sentinelä¸­çä¸äºæ¦å¿µä¸æ ¸å¿ç±»è§£æ","/pages/3d8a71/"],["91.æ¡æ¶/60.Sentinel/4. Sentinel è´£ä»»é¾æµç¨.md","2. Sentinel è´£ä»»é¾æµç¨","/pages/51db55/"],["91.æ¡æ¶/60.Sentinel/5. Sentinel - NodeSelectorSlot.md","3. Sentinel - NodeSelectorSlot","/pages/f4866d/"],["91.æ¡æ¶/60.Sentinel/6. Sentinel - ClusterBuilderSlot.md","4. Sentinel - ClusterBuilderSlot","/pages/df7ccb/"]]},{title:"RocketMQ",collapsable:!0,children:[]},{title:"XXL-JOB",collapsable:!0,children:[["91.æ¡æ¶/100.XXL-JOB/1.XXL-JOBçå®è£.md","1. XXL-JOBçå®è£","/pages/bb013b/"],["91.æ¡æ¶/100.XXL-JOB/2.XXL-JOBçä½¿ç¨.md","2. XXL-JOBçä½¿ç¨","/pages/fcb98f/"],["91.æ¡æ¶/100.XXL-JOB/4.XXL-JOBæ°æ®åºå­æ®µè®²è§£.md","4. XXL-JOBæ°æ®åºå­æ®µè®²è§£","/pages/ac1d9d/"],["91.æ¡æ¶/100.XXL-JOB/5.å®æ¶ä»»å¡æ¯å¦ä½æ§è¡ç.md","5. å®æ¶ä»»å¡æ¯å¦ä½æ§è¡ç","/pages/5531a6/"],["91.æ¡æ¶/100.XXL-JOB/6.æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶.md","6. æ§è¡å¨ç«¯çæ¥å¿ç»ä»¶","/pages/a25535/"],["91.æ¡æ¶/100.XXL-JOB/20.XXL-JOBè´è½½åè¡¡ç­ç¥.md","XXL-JOBè´è½½åè¡¡ç­ç¥","/pages/75326c/"]]}]},{title:"å¶ä»",collapsable:!0,children:[["100.å¶ä»/5.å¦ä½å°IPå°åå­å¥MySQL.md","å¦ä½å°IPå°åå­å¥MySQL","/pages/ad5a8e/"],["100.å¶ä»/100.å¸¸ç¨å·¥å·ç±».md","å¸¸ç¨å·¥å·ç±»","/pages/70ea3d/"],["100.å¶ä»/1000.Javaå­¦ä¹ è·¯çº¿.md","Javaå­¦ä¹ è·¯çº¿","/pages/7ca562/"]]},{title:"è¸©å",collapsable:!0,children:[["200.è¸©å/10.xxl job Access token is wrong.md","xxl job Access token is wrong","/pages/65cd6f/"],["200.è¸©å/20.å½éåæ¶éè¦è¿åç»åç«¯ä¸æ®µjsonï¼jsonå·¥å·ä¸åç»ææ¥é.md","å½éåæ¶éè¦è¿åç»åç«¯ä¸æ®µjsonï¼jsonå·¥å·ä¸åç»ææ¥é","/pages/3cac9b/"],["200.è¸©å/30.mpä½¿ç¨@TableFieldæ³¨è§£æªçæåèæ¥é.md","mpä½¿ç¨@TableFieldæ³¨è§£æªçæåèæ¥é","/pages/0e629c/"],["200.è¸©å/40.ä½¿ç¨@Validatedæ³¨è§£è¿è¡åæ°æ ¡éªæ¶æ¥éï¼UnexpectedTypeException.md","ä½¿ç¨@Validatedæ³¨è§£è¿è¡åæ°æ ¡éªæ¶æ¥éï¼UnexpectedTypeException","/pages/e96a9e/"],["200.è¸©å/50.connection.setReadTimeout.md","connection.setReadTimeout","/pages/4e379b/"]]},{title:"å®ä¹ å°ç»",collapsable:!0,children:[["1000.å®ä¹ å°ç»/1.Gitè¸©å.md","Gitè¸©å","/pages/f63fe9/"],["1000.å®ä¹ å°ç»/150.å¼åè§è.md","å¼åè§è","/pages/99f624/"]]}],catalogue:{},"/06.èç³»æ/":[["01.èç³»æ.md","èç³»æ","/pages/1b12ed"]]},updateBar:{showToArticle:!1},pageStyle:"line",category:!1,tag:!1,pageButton:!1,author:{name:"ä½",href:"https://github.com/2382546457"},social:{icons:[{iconClass:"icon-youjian",title:"åé®ä»¶",link:"3175543112@qq.com"},{iconClass:"icon-github",title:"GitHub",link:"https://github.com/2382546457"},{iconClass:"icon-erji",title:"å¬é³ä¹",link:"https://music.163.com/#/playlist?id=755597173"}]},footer:{createYear:2023,copyrightInfo:"ä½ | MIT License"},htmlModules:{}}};var ks=t(94),ws=t(95),Ss=t(11);var js={computed:{$filterPosts(){return this.$site.pages.filter(n=>{const{frontmatter:{pageComponent:e,article:t,home:r}}=n;return!(e||!1===t||!0===r)})},$sortPosts(){return(n=this.$filterPosts).sort((n,e)=>{const t=n.frontmatter.sticky,r=e.frontmatter.sticky;return t&&r?t==r?Object(Ss.a)(n,e):t-r:t&&!r?-1:!t&&r?1:Object(Ss.a)(n,e)}),n;var n},$sortPostsByDate(){return(n=this.$filterPosts).sort((n,e)=>Object(Ss.a)(n,e)),n;var n},$groupPosts(){return function(n){const e={},t={};for(let r=0,o=n.length;r<o;r++){const{frontmatter:{categories:o,tags:a}}=n[r];"array"===Object(Ss.n)(o)&&o.forEach(t=>{t&&(e[t]||(e[t]=[]),e[t].push(n[r]))}),"array"===Object(Ss.n)(a)&&a.forEach(e=>{e&&(t[e]||(t[e]=[]),t[e].push(n[r]))})}return{categories:e,tags:t}}(this.$sortPosts)},$categoriesAndTags(){return function(n){const e=[],t=[];for(let t in n.categories)e.push({key:t,length:n.categories[t].length});for(let e in n.tags)t.push({key:e,length:n.tags[e].length});return{categories:e,tags:t}}(this.$groupPosts)}}};$t.component(ks.default),$t.component(ws.default);function Ts(n){return n.toString().padStart(2,"0")}t(243);$t.component("Badge",()=>Promise.all([t.e(0),t.e(3)]).then(t.bind(null,396))),$t.component("CodeBlock",()=>Promise.resolve().then(t.bind(null,94))),$t.component("CodeGroup",()=>Promise.resolve().then(t.bind(null,95)));t(244);var _s=[({Vue:n,options:e,router:t,siteData:r})=>{r.pages.map(n=>{const{frontmatter:{date:e,author:t}}=n;"string"==typeof e&&"Z"===e.charAt(e.length-1)&&(n.frontmatter.date=function(n){n instanceof Date||(n=new Date(n));return`${n.getUTCFullYear()}-${Ts(n.getUTCMonth()+1)}-${Ts(n.getUTCDate())} ${Ts(n.getUTCHours())}:${Ts(n.getUTCMinutes())}:${Ts(n.getUTCSeconds())}`}(e)),t?n.author=t:r.themeConfig.author&&(n.author=r.themeConfig.author)}),n.mixin(js)},{},({Vue:n})=>{n.mixin({computed:{$dataBlock(){return this.$options.__data__block__}}})},{},{},({router:n})=>{"undefined"!=typeof window&&(window._hmt=window._hmt||[],function(){var n=document.createElement("script");n.src="https://hm.baidu.com/hm.js?01293bffa6c3962016c08ba685c79d78";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)}(),n.afterEach((function(n){_hmt.push(["_trackPageview",n.fullPath])})))}],Cs=[];class Es extends class{constructor(){this.store=new $t({data:{state:{}}})}$get(n){return this.store.state[n]}$set(n,e){$t.set(this.store.state,n,e)}$emit(...n){this.store.$emit(...n)}$on(...n){this.store.$on(...n)}}{}Object.assign(Es.prototype,{getPageAsyncComponent:il,getLayoutAsyncComponent:ll,getAsyncComponent:sl,getVueComponent:cl});var Is={install(n){const e=new Es;n.$vuepress=e,n.prototype.$vuepress=e}};function As(n,e){const t=e.toLowerCase();return n.options.routes.some(n=>n.path.toLowerCase()===t)}var Ps={props:{pageKey:String,slotKey:{type:String,default:"default"}},render(n){const e=this.pageKey||this.$parent.$page.key;return ul("pageKey",e),$t.component(e)||$t.component(e,il(e)),$t.component(e)?n(e):n("")}},Ls={functional:!0,props:{slotKey:String,required:!0},render:(n,{props:e,slots:t})=>n("div",{class:["content__"+e.slotKey]},t()[e.slotKey])},Rs={computed:{openInNewWindowTitle(){return this.$themeLocaleConfig.openNewWindowText||"(opens new window)"}}},Bs=(t(245),t(246),Object(bs.a)(Rs,(function(){var n=this._self._c;return n("span",[n("svg",{staticClass:"icon outbound",attrs:{xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",focusable:"false",x:"0px",y:"0px",viewBox:"0 0 100 100",width:"15",height:"15"}},[n("path",{attrs:{fill:"currentColor",d:"M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"}}),this._v(" "),n("polygon",{attrs:{fill:"currentColor",points:"45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"}})]),this._v(" "),n("span",{staticClass:"sr-only"},[this._v(this._s(this.openInNewWindowTitle))])])}),[],!1,null,null,null).exports),Os={functional:!0,render(n,{parent:e,children:t}){if(e._isMounted)return t;e.$once("hook:mounted",()=>{e.$forceUpdate()})}};$t.config.productionTip=!1,$t.use(Hi),$t.use(Is),$t.mixin(function(n,e,t=$t){!function(n){n.locales&&Object.keys(n.locales).forEach(e=>{n.locales[e].path=e});Object.freeze(n)}(e),t.$vuepress.$set("siteData",e);const r=new(n(t.$vuepress.$get("siteData"))),o=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(r)),a={};return Object.keys(o).reduce((n,e)=>(e.startsWith("$")&&(n[e]=o[e].get),n),a),{computed:a}}(n=>class{setPage(n){this.__page=n}get $site(){return n}get $themeConfig(){return this.$site.themeConfig}get $frontmatter(){return this.$page.frontmatter}get $localeConfig(){const{locales:n={}}=this.$site;let e,t;for(const r in n)"/"===r?t=n[r]:0===this.$page.path.indexOf(r)&&(e=n[r]);return e||t||{}}get $siteTitle(){return this.$localeConfig.title||this.$site.title||""}get $canonicalUrl(){const{canonicalUrl:n}=this.$page.frontmatter;return"string"==typeof n&&n}get $title(){const n=this.$page,{metaTitle:e}=this.$page.frontmatter;if("string"==typeof e)return e;const t=this.$siteTitle,r=n.frontmatter.home?null:n.frontmatter.title||n.title;return t?r?r+" | "+t:t:r||"VuePress"}get $description(){const n=function(n){if(n){const e=n.filter(n=>"description"===n.name)[0];if(e)return e.content}}(this.$page.frontmatter.meta);return n||(this.$page.frontmatter.description||this.$localeConfig.description||this.$site.description||"")}get $lang(){return this.$page.frontmatter.lang||this.$localeConfig.lang||"en-US"}get $localePath(){return this.$localeConfig.path||"/"}get $themeLocaleConfig(){return(this.$site.themeConfig.locales||{})[this.$localePath]||{}}get $page(){return this.__page?this.__page:function(n,e){for(let t=0;t<n.length;t++){const r=n[t];if(r.path.toLowerCase()===e.toLowerCase())return r}return{path:"",frontmatter:{}}}(this.$site.pages,this.$route.path)}},ys)),$t.component("Content",Ps),$t.component("ContentSlotsDistributor",Ls),$t.component("OutboundLink",Bs),$t.component("ClientOnly",Os),$t.component("Layout",ll("Layout")),$t.component("NotFound",ll("NotFound")),$t.prototype.$withBase=function(n){const e=this.$site.base;return"/"===n.charAt(0)?e+n.slice(1):n},window.__VUEPRESS__={version:"1.9.2",hash:"adabe31"},async function(n){const e="undefined"!=typeof window&&window.__VUEPRESS_ROUTER_BASE__?window.__VUEPRESS_ROUTER_BASE__:ys.routerBase||ys.base,t=new Hi({base:e,mode:"history",fallback:!1,routes:vs,scrollBehavior:(n,e,t)=>t||(n.hash?!$t.$vuepress.$get("disableScrollBehavior")&&{selector:decodeURIComponent(n.hash)}:{x:0,y:0})});!function(n){n.beforeEach((e,t,r)=>{if(As(n,e.path))r();else if(/(\/|\.html)$/.test(e.path))if(/\/$/.test(e.path)){const t=e.path.replace(/\/$/,"")+".html";As(n,t)?r(t):r()}else r();else{const t=e.path+"/",o=e.path+".html";As(n,o)?r(o):As(n,t)?r(t):r()}})}(t);const r={};try{await Promise.all(_s.filter(n=>"function"==typeof n).map(e=>e({Vue:$t,options:r,router:t,siteData:ys,isServer:n})))}catch(n){console.error(n)}return{app:new $t(Object.assign(r,{router:t,render:n=>n("div",{attrs:{id:"app"}},[n("RouterView",{ref:"layout"}),n("div",{class:"global-ui"},Cs.map(e=>n(e)))])})),router:t}}(!1).then(({app:n,router:e})=>{e.onReady(()=>{n.$mount("#app")})})}]);