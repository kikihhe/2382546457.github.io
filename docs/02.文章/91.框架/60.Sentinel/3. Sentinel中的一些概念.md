---
title:  1. Sentinelä¸­çš„ä¸€äº›æ¦‚å¿µä¸æ ¸å¿ƒç±»è§£æ
date: 2023-11-29 16:08:05
permalink: /pages/3d8a71/
---
## 1. èµ„æº ResourceWrapper

æƒ³è¦åšé™æµã€ç†”æ–­ï¼Œç›®æ ‡æ˜¯è°ï¼Ÿè‚¯å®šæ˜¯èµ„æºã€‚èµ„æºå¯ä»¥æ˜¯ä¸€ä¸ªæ–¹æ³•ã€ä¸€æ®µä»£ç ã€ä¸€ä¸ªæ¥å£...

Sentinel ç»Ÿè®¡çš„æ•°æ®ä»¥èµ„æºä¸ºç»´åº¦ï¼Œèµ„æºä½¿ç”¨ ResourceWrapper è¡¨ç¤º

```java
public abstract class ResourceWrapper {
	// èµ„æºå
    protected final String name;
	// èŠ‚ç‚¹ç±»å‹ï¼Œè¿›å…¥æˆ–æµå‡º
    protected final EntryType entryType;
    // èµ„æºç±»å‹ï¼Œæ¯”å¦‚MVCã€Dubboã€grpc..
    protected final int resourceType;
}
```

- name ï¼šèµ„æºå
- entryType ï¼šæ­¤èµ„æºè¡¨ç¤ºçš„èŠ‚ç‚¹çš„ç±»å‹ï¼Œå³æµå…¥æµé‡è¿˜æ˜¯æµå‡ºæµé‡ï¼Œé€šä¿—ä¸€ç‚¹è¯´å°±æ˜¯å‘èµ·è¯·æ±‚è¿˜æ˜¯æ¥æ”¶è¯·æ±‚ã€‚
- resourceType ï¼šèµ„æºç±»å‹ï¼ŒSentinel é›†æˆäº†å¾ˆå¤šæ¡†æ¶ï¼Œä¸åŒçš„èµ„æºä¹‹é—´è¿˜ä¼šç›¸äº’è°ƒç”¨ï¼Œæ‰€ä»¥è¦åˆ†æ¸…æ¥šã€‚

EntryType æ˜¯ä¸€ä¸ªæšä¸¾ç±» ï¼š

```java
public enum EntryType {
    IN("IN"),
    OUT("OUT");
}
```

Sentinel1.8.1 æ”¯æŒçš„ resourceType æœ‰ä»¥ä¸‹å‡ ç§ ï¼š

```java
public final class ResourceTypeConstants {

    public static final int COMMON = 0;
    public static final int COMMON_WEB = 1;
    public static final int COMMON_RPC = 2;
    public static final int COMMON_API_GATEWAY = 3;
    public static final int COMMON_DB_SQL = 4;

    private ResourceTypeConstants() {}
}
```

- COMMON ï¼šä¸é›†æˆä»»ä½•æ¡†æ¶
- COMMON_WEB ï¼šé›†æˆwebåº”ç”¨çš„æ¥å£
- COMMON_RPC ï¼šrpcæ¥å£
- COMMON_API_GATEWAY ï¼šç”¨äº API GateWay ç½‘å…³
- COMMON_DB_SQL ï¼šæ•°æ®åº“SQLæ“ä½œ

ç»¼ä¸Šæ‰€è¿°ï¼ŒSentinel ä¸­çš„èµ„æºå¯èƒ½çš„ç±»å‹æœ‰

- è¿›å…¥ç¨‹åºçš„webè¯·æ±‚
- ç¨‹åºå‘å‡ºçš„rpcè¯·æ±‚
- ç¨‹åºå‘å‡ºçš„sqlæ“ä½œ
- .......

## 2. èŠ‚ç‚¹ Node

Sentinel ä¸­çš„æ¯ä¸€ä¸ªèµ„æºéƒ½å¯ä»¥æˆä¸ºä¸€ä¸ª Nodeï¼Œè‡³äºæˆä¸ºå“ªä¸€ä¸ª Node è¦çœ‹ä½¿ç”¨æƒ…å†µã€‚

Node ä½œä¸º Sentinel ä¸­æŒæœ‰å®æ—¶ç»Ÿè®¡æ•°æ®çš„æ¥å£ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªèŠ‚ç‚¹æ‰€éœ€è¦æä¾›çš„å„é¡¹æŒ‡æ ‡æ•°æ®ç»Ÿè®¡åŠŸèƒ½ï¼Œä¸ºå¤–éƒ¨å±è”½ç»Ÿè®¡æ•°æ®çš„å®ç°ã€‚

```java
public interface Node extends OccupySupport, DebugSupport {
    long totalRequest(); // è·å–æ€»çš„è¯·æ±‚æ•°
    long totalPass(); // è·å–é€šè¿‡çš„è¯·æ±‚æ€»æ•°
    long totalSuccess(); // è·å–æˆåŠŸçš„è¯·æ±‚æ€»æ•°
    long blockRequest(); // è·å–è¢« Sentinel æ‹’ç»çš„è¯·æ±‚æ€»æ•°
    long totalException(); // è·å–å¼‚å¸¸æ€»æ•°
    double passQps(); // é€šè¿‡ QPS
    double blockQps(); // æ‹’ç» QPS
    double totalQps(); // æ€» qps
    double successQps(); // æˆåŠŸ qps
    // æœ€å¤§æˆåŠŸæ€»æ•° QPSï¼ˆä¾‹å¦‚ç§’çº§æ»‘åŠ¨çª—å£çš„æ•°ç»„å¤§å°é»˜è®¤é…ç½®ä¸º 2ï¼Œåˆ™å–æ•°ç»„ä¸­æœ€å¤§ï¼‰
    double maxSuccessQps(); 
    double exceptionQps(); // å¼‚å¸¸ QPS
    double avgRt(); // å¹³å‡è€—æ—¶
    double minRt(); // æœ€å°è€—æ—¶
    int curThreadNum(); // å½“å‰å¹¶å‘å ç”¨çš„çº¿ç¨‹æ•°
    double previousBlockQps(); // å‰ä¸€ä¸ªæ—¶é—´çª—å£çš„è¢«æ‹’ç» qps
    double previousPassQps(); // å‰ä¸€ä¸ªæ—¶é—´çª—å£çš„é€šè¿‡ qps
    Map<Long, MetricNode> metrics(); 
    List<MetricNode> rawMetricsInMin(Predicate<Long> timePredicate);
    void addPassRequest(int count); // æ·»åŠ é€šè¿‡è¯·æ±‚æ•°
    void addRtAndSuccess(long rt, int success); // æ·»åŠ æˆåŠŸè¯·æ±‚æ•°ï¼Œå¹¶ä¸”æ·»åŠ å¤„ç†æˆåŠŸçš„è€—æ—¶
    void increaseBlockQps(int count); // æ·»åŠ è¢«æ‹’ç»çš„è¯·æ±‚æ•°
    void increaseExceptionQps(int count); // æ·»åŠ å¼‚å¸¸è¯·æ±‚æ•°
    void increaseThreadNum(); // è‡ªå¢å ç”¨çº¿ç¨‹
    void decreaseThreadNum(); // è‡ªå‡å ç”¨çº¿ç¨‹
    void reset(); // é‡ç½®æ»‘åŠ¨çª—å£
}
```

ä¸ºå•¥ Node æ˜¯ä¸€ä¸ªæ¥å£è€Œä¸æ˜¯å®ç°ç±»ï¼Ÿå› ä¸ºè¦å°† Sentinel ä¸­çš„ â€œèŠ‚ç‚¹â€ æŒ‰ç…§ç±»å‹åŒºåˆ†å¼€ã€‚

æ¯”å¦‚æœ‰ä¸‰ä¸ªèµ„æº ï¼šaã€bã€c

è¿™ä¸‰ä¸ªèµ„æºæœ‰ä»¥ä¸‹è°ƒç”¨é“¾ ï¼š

a -> b -> c

b -> c -> a

a -> b -> a

åœ¨ä¸‰ä¸ªè°ƒç”¨é“¾ä¸­ï¼ŒåŒä¸€ä¸ªèŠ‚ç‚¹å……å½“äº†ä¸åŒçš„è§’è‰²ï¼Œæ¯”å¦‚ç¬¬ä¸‰ä¸ªè°ƒç”¨é“¾ä¸­ï¼Œa æ—¢æ˜¯å…¥å£èŠ‚ç‚¹ä¹Ÿæ˜¯æ™®é€šèŠ‚ç‚¹ã€‚

æˆ‘ä»¬ç»™å®ƒèµ·å ï¼š`å…¥å£a`ã€`æ™®é€ša`

åŒæ—¶å¦‚æœè¦ç»Ÿè®¡ â€œaâ€ è¿™ä¸ªèµ„æºçš„æ€»è®¿é—®é‡æ€ä¹ˆåŠï¼Ÿéš¾é“è¦å°†å…¨éƒ¨çš„`å…¥å£a`ã€`æ™®é€ša` ä¸€ä¸ªä¸€ä¸ªéå†ç›¸åŠ ï¼Ÿ

ä¸ï¼Œåˆ›å»ºä¸€ä¸ª`å…¨å±€ a` ï¼Œæµé‡è¿›å…¥ `å…¥å£a`ã€`æ™®é€ša`æ—¶å°†ä¸ä»…å°†å¯¹åº”çš„èŠ‚ç‚¹æµé‡åŠ ä¸€ï¼Œè¿˜å°†å…¨å±€açš„æ•°æ®ä¹ŸåŠ ä¸€

ç°åœ¨æœ‰äº†ä¸‰ç§èŠ‚ç‚¹ï¼Œå®ƒä»¬éƒ½æ˜¯ Node çš„å­ç±»ï¼š

- å…¥å£èŠ‚ç‚¹ EntranceNode
- æ™®é€šèŠ‚ç‚¹ DefaultNode
- å…¨å±€èŠ‚ç‚¹ ClusterNode

Sentinel å°†è¿™ä¸‰ç§èŠ‚ç‚¹çš„å…±åŒå±æ€§ ï¼š<font color=Blue>ç»Ÿè®¡æ•°æ®</font>åŠŸèƒ½ æŠ½å–å‡ºæ¥ä½œä¸ºå®ƒä»¬ä¸‰ä¸ªçš„çˆ¶ç±» ï¼šStatisticNodeã€‚å…³ç³»å›¾å¦‚ä¸‹ï¼š

![image-20231127200149326](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127200149326.png)

- Node ï¼šæŠ½è±¡ç±»ï¼Œæä¾›è§„èŒƒ
- StatisticNode ï¼šæä¾›äº†ç»Ÿè®¡æ•°æ®çš„åŠŸèƒ½ã€‚
- DefaultNode ï¼šæ™®é€šèŠ‚ç‚¹
- EntranceNode ï¼šå…¥å£èŠ‚ç‚¹
- ClusterNode ï¼šå…¨å±€èŠ‚ç‚¹ï¼Œä¸€ä¸ªèµ„æºåªèƒ½æœ‰ä¸€ä¸ªå…¨å±€èŠ‚ç‚¹ã€‚

ä¸€ä¸ªèµ„æºå¯èƒ½æœ‰å¤šä¸ªå…¥å£èŠ‚ç‚¹æˆ–æ™®é€šèŠ‚ç‚¹ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªå…¨å±€èŠ‚ç‚¹ã€‚ClusterNode ä¸ DefaultNode çš„å…³ç³»æ˜¯ä¸€å¯¹å¤šã€‚

æ¥ä¸‹æ¥è¯¦ç»†ä»‹ç»å„ç§ç±»å‹çš„ Node

### 2.1 ç»Ÿè®¡èŠ‚ç‚¹ ï¼šStatisticNode

```java
public class StatisticNode implements Node {
    // ç§’çº§æ»‘åŠ¨çª—å£ï¼Œ2 ä¸ªæ—¶é—´çª—å£å¤§å°ä¸º 500 æ¯«ç§’çš„ Bucket
    private transient volatile Metric rollingCounterInSecond = new ArrayMetric(2,1000);
    // åˆ†é’Ÿçº§æ»‘åŠ¨çª—å£ï¼Œ60 ä¸ª Bucket æ•°ç»„ï¼Œæ¯ä¸ª Bucket ç»Ÿè®¡çš„æ—¶é—´çª—å£å¤§å°ä¸º 1 ç§’
    private transient Metric rollingCounterInMinute = new ArrayMetric(60, 60 * 1000, false);
    
    // ç»Ÿè®¡å¹¶å‘ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œå¯ä»¥æ ¹æ®çº¿ç¨‹æ•°é™æµã€‚
    private LongAdder curThreadNum = new LongAdder();
    
    // å®ç°äº†ä» Node ç»§æ‰¿è¿‡æ¥çš„å…¶ä»–ç»Ÿè®¡æ–¹æ³•ï¼Œè¿™é‡Œåˆ—ä¸¾å‡ ä¸ªç®€å•çš„
    
    // ä¸€åˆ†é’Ÿå†…æˆåŠŸæ”¾å¿ƒçš„å…¨éƒ¨è¯·æ±‚æ•°é‡
    @Override
    public long totalPass() {
        return rollingCounterInMinute.pass();
    }
    
    // æˆåŠŸæ”¾è¡Œäº†ä¸€ä¸ªè¯·æ±‚ï¼ŒåŠ ä¸Šã€‚
    @Override
    public void addPassRequest(int count) {
        rollingCounterInSecond.addPass(count);
        rollingCounterInMinute.addPass(count);
    }

    // ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å…¶ä»–çš„å°±ä¸æ”¾äº†ï¼ŒStatisticNodeå®ç°äº†Nodeçš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ã€‚
}
```

åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒSentinel ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•ç»Ÿè®¡ç»è¿‡æ¯ä¸€ä¸ª Node çš„èµ„æºã€‚æ»‘åŠ¨çª—å£ç®—æ³•ä¼šåœ¨ä»¥åçš„æ–‡ç« ä»‹ç»åˆ°ã€‚

é€šè¿‡å®ç° Node è§„å®šçš„æ–¹æ³•ï¼ŒStatisticNode æä¾›äº†ç»Ÿè®¡ç§’çº§ã€åˆ†é’Ÿçº§æˆåŠŸè¯·æ±‚æ•°ã€å¤±è´¥è¯·æ±‚æ•°ç­‰ç­‰åŠŸèƒ½ã€‚

å½“ç„¶äº†ï¼Œç°åœ¨ä¸ä¼šè¿™äº›å¾ˆæ­£å¸¸ï¼Œä½ åªéœ€è¦çŸ¥é“ï¼šStatisticNode å¯ä»¥ç»Ÿè®¡æµé‡ï¼Œæ‰€æœ‰ç»§æ‰¿å®ƒçš„ Node ï¼Œä¹Ÿå°±æ˜¯ ClusterNodeã€DefaultNodeã€EntranceNode ä¹Ÿéƒ½å¯ä»¥ç»Ÿè®¡æµé‡ã€‚

æ³¨æ„ ï¼šStatisticNode åªæä¾›ç»Ÿè®¡æ•°æ®çš„åŠŸèƒ½ï¼Œå®ƒä¸è¡¨ç¤ºä»»ä½•èµ„æºã€‚

### 2.2 æ™®é€šèŠ‚ç‚¹ ï¼šDefaultNode

```java
public class DefaultNode extends StatisticNode {

    // è¿™ä¸ªèŠ‚ç‚¹è¡¨ç¤ºçš„èµ„æº
    private ResourceWrapper id;

    // è¿™ä¸ªèŠ‚ç‚¹çš„å…¨éƒ¨å­èŠ‚ç‚¹
    private volatile Set<Node> childList = new HashSet<>();
	
    // è¯¥èŠ‚ç‚¹å¯¹åº”çš„ ClusterNode
    private ClusterNode clusterNode;


    @Override
    public void increaseBlockQps(int count) {
        super.increaseBlockQps(count);
        this.clusterNode.increaseBlockQps(count);
    }

    @Override
    public void increaseExceptionQps(int count) {
        super.increaseExceptionQps(count);
        this.clusterNode.increaseExceptionQps(count);
    }

    @Override
    public void addRtAndSuccess(long rt, int successCount) {
        super.addRtAndSuccess(rt, successCount);
        this.clusterNode.addRtAndSuccess(rt, successCount);
    }

    @Override
    public void increaseThreadNum() {
        super.increaseThreadNum();
        this.clusterNode.increaseThreadNum();
    }

    @Override
    public void decreaseThreadNum() {
        super.decreaseThreadNum();
        this.clusterNode.decreaseThreadNum();
    }

    @Override
    public void addPassRequest(int count) {
        super.addPassRequest(count);
        this.clusterNode.addPassRequest(count);
    }

    public void printDefaultNode() {
        visitTree(0, this);
    }
}
```

- id ï¼šè¿™ä¸ªèŠ‚ç‚¹è¡¨ç¤ºçš„èµ„æºã€‚
- childList ï¼šè¿™ä¸ªèŠ‚ç‚¹çš„å…¨éƒ¨å­èŠ‚ç‚¹
- clusterNode ï¼šè¯¥èŠ‚ç‚¹å¯¹åº”çš„ ClusterNodeã€‚

èµ„æºä¸ DefaultNode ä¹‹é—´æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚èµ„æºä¸ClusterNodeä¹‹é—´æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚

ä¸€ä¸ª DefaultNode å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹å½¢æˆå¦‚ä¸‹çš„ç»“æ„ ï¼š

ï¼ˆå…¶å®æœ€é¡¶ç«¯çš„ A ä¸æ˜¯ DefaultNodeï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªæ¯”å–»ï¼‰

![image-20231127202958197](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127202958197.png)

<font color=Blue>å¤šä¸ª DefaultNode å°±å½¢æˆäº†ä¸€æ£µæ ‘</font>

æ³¨ ï¼šäº†è§£ Sentinel çš„å°±èƒ½çœ‹å‡ºæ¥è¿™é¢—æ ‘è¿˜æœ‰å¾ˆå¤šç¼ºé™·ï¼Œä½†æ˜¯ç°åœ¨åªæ˜¯åšä¸€ä¸ªæ¯”å–»ã€‚

åŒæ—¶ï¼Œé€šè¿‡æºç ä½ å¯èƒ½çœ‹å‡ºæ¥äº†ï¼ŒDefaultNode åœ¨æ‰§è¡Œ`æ”¾è¡Œè¯·æ±‚`æ–¹æ³•æ—¶å¦‚ä¸‹ï¼š

```java
@Override
public void addRtAndSuccess(long rt, int successCount) {
    super.addRtAndSuccess(rt, successCount);
    this.clusterNode.addRtAndSuccess(rt, successCount);
}
```

å…ˆç»™è‡ªå·±çš„æ•°æ®è®°å½•ä¸€ä¸‹ï¼Œå†ç»™è‡ªå·±æ‰€å±çš„ ClusterNode è®°å½•ä¸€ä¸‹ï¼Œè·Ÿå’±ä»¬ä¹‹å‰è¯´çš„ä¸€æ ·ã€‚

å†æ¬¡æé†’ ï¼šæ‰€æœ‰èŠ‚ç‚¹ç»Ÿè®¡æ•°æ®æ—¶éƒ½è¦ä½¿ç”¨ä» StatisticNode ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•ã€‚

### 2.3 å…¥å£èŠ‚ç‚¹ ï¼šEntranceNode

å…¥å£èŠ‚ç‚¹æ²¡æœ‰å˜é‡ï¼ŒåŠŸèƒ½è¢« StatisticNode å®ç°äº†ï¼Œå˜é‡è¢« DefaultNode æ‹¥æœ‰äº†ï¼ŒEntranceNode å°±ç‰¹åˆ«ç®€æ´äº†ï¼š

```java
public class EntranceNode extends DefaultNode {

    public EntranceNode(ResourceWrapper id, ClusterNode clusterNode) {
        super(id, clusterNode);
    }
}
```

EntranceNode ä¸ DefaultNode çš„åŒºåˆ«æ˜¯é‡å†™ StatisticNode çš„æ–¹æ³•ä¸ä¸€æ ·ã€‚

åœ¨è¿™é‡Œå¯ä»¥å‰§é€ä¸€ä¸‹ ï¼šEntranceNode éƒ½æ˜¯å·²ç»è§„å®šå¥½çš„èŠ‚ç‚¹ï¼Œå‘½åæ–¹å¼æ ¹æ®é›†æˆçš„æ¡†æ¶å˜åŒ–ã€‚æ¯”å¦‚

- ä¸é›†æˆä»»ä½•æ¡†æ¶æ—¶ï¼ŒEntranceNode.name = "sentinel_default_context"
- é›†æˆSpring MVC æ—¶ï¼ŒEntranceNode.name = "sentinel_spring_web_context"

### 2.4 å…¨å±€èŠ‚ç‚¹ ï¼šClusterNode

```java
public class ClusterNode extends StatisticNode {
	// èŠ‚ç‚¹åï¼Œå³èµ„æºåï¼Œå…¶å®åº”è¯¥ä½¿ç”¨ ResourceWrapperçš„ï¼Œä¸çŸ¥é“è¿™é‡Œä¸ºå•¥ç”¨äº†String
    private final String name;
    // èµ„æºç±»å‹
    private final int resourceType;

    // ç»´æŠ¤æ¯ä¸ªè°ƒç”¨æ¥æºçš„æŒ‡æ ‡æ•°æ®ç»Ÿè®¡æ•°æ®ï¼ˆStatisticNodeï¼‰
    // åœ¨ ClusterNode éƒ¨åˆ†ä¼šå…·ä½“è¯´ã€‚
    private Map<String, StatisticNode> originCountMap = new HashMap<>();
    
	// æ§åˆ¶å¹¶å‘ä¿®æ”¹ originCountMap ç”¨çš„é”
    private final ReentrantLock lock = new ReentrantLock();
}
```

- name ï¼šèµ„æºåï¼Œå…¶å®åº”è¯¥ä½¿ç”¨ ResourceWrapperçš„ï¼Œä¸çŸ¥é“è¿™é‡Œä¸ºå•¥ç”¨äº†String
- resourceType ï¼šèµ„æºç±»å‹
- originCountMap ï¼š ç»´æŠ¤æ¯ä¸ªè°ƒç”¨æ¥æºçš„æŒ‡æ ‡æ•°æ®ç»Ÿè®¡æ•°æ®ï¼ˆStatisticNodeï¼‰
- lock ï¼šæ§åˆ¶å¹¶å‘ä¿®æ”¹ originCountMap ç”¨çš„é”

å…¶å®å®ƒè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•ç”¨æ¥æ“ä½œ originCountMap ï¼š

```java
public Node getOrCreateOriginNode(String origin) {
    StatisticNode statisticNode = originCountMap.get(origin);
    if (statisticNode == null) {
        lock.lock();
        try {
            statisticNode = originCountMap.get(origin);
            if (statisticNode == null) {
                statisticNode = new StatisticNode();
                HashMap<String, StatisticNode> newMap = new HashMap<>(originCountMap.size() + 1);
                newMap.putAll(originCountMap);
                newMap.put(origin, statisticNode);
                originCountMap = newMap;
            }
        } finally {
            lock.unlock();
        }
    }
    return statisticNode;
}
```

å…·ä½“æ˜¯å•¥æ„æ€å‘¢ï¼Œè¯·çœ‹è¿™ä¸ªå›¾ï¼š

![image-20231130191659639](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231130191659639.png)

springmvc æ¡†æ¶ä¸­çš„ /hello1 é€šè¿‡ grpc è¿œç¨‹è°ƒç”¨äº† /hello2ï¼Œé‚£ä¹ˆåœ¨ç»Ÿè®¡ /hello2 æ—¶æ˜¯ä¸æ˜¯è¦æ ‡æ¸…æ¥š origin æ˜¯ hello1ï¼Ÿ

æ‰€ä»¥å°±é€šè¿‡ origin åˆ›å»ºä¸€ä¸ª hello1 èŠ‚ç‚¹ï¼Œæ”¾åœ¨ hello2 çš„ ClusterNode çš„ Map ä¸­ï¼Œæ³¨æ„ï¼Œæ”¾å…¥çš„èŠ‚ç‚¹ç±»å‹ä¸º StatisticNodeï¼Œä¹Ÿå°±è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œåªè´Ÿè´£ç»Ÿè®¡ä¸€ä¸‹æµé‡ï¼Œæ–¹ä¾¿åšâ€œæ¥æºé™æµã€å…³è”é™æµâ€ã€‚

å½“ç”¨æˆ·è¦åš /hello1->/hello2 çš„æ¥æºé™æµæ—¶ï¼Œå°† hello2 çš„æµé‡å–å‡ºæ¥ï¼Œå†å°† hello2å¯¹åº”çš„ ClusterNode ä¸­ç»Ÿè®¡çš„ hello1 çš„æ•°æ®å–å‡ºæ¥å°±å¯ä»¥åˆ¤æ–­æ˜¯å¦é™æµäº†ã€‚

## 3. æ ¹èŠ‚ç‚¹ Constants.ROOT

å…¶å®<font color=Blue>æ•´ä¸ªç¨‹åºçš„ å…¥å£èŠ‚ç‚¹æ˜¯å›ºå®šçš„</font>ï¼Œå®ƒå­˜æ”¾åœ¨å¸¸é‡ç±» Constants ä¸­ã€‚

```java
public final class Constants {
    // é»˜è®¤contextçš„åç§°
    public final static String CONTEXT_DEFAULT_NAME = "sentinel_default_context";
    
    // æ ¹èŠ‚ç‚¹
    public final static DefaultNode ROOT = new EntranceNode(
        new StringResourceWrapper(ROOT_ID, EntryType.IN),
        new ClusterNode(ROOT_ID, ResourceTypeConstants.COMMON)
    );
    
    // æ ¹èŠ‚ç‚¹å¯¹åº”çš„å…¨å±€èŠ‚ç‚¹
    public final static ClusterNode ENTRY_NODE = new ClusterNode(
        TOTAL_IN_RESOURCE_NAME, 
        ResourceTypeConstants.COMMON
    );

}
```

<font color=Blue>æ ¹èŠ‚ç‚¹çš„**ç¬¬ä¸€å±‚**å­èŠ‚ç‚¹ï¼Œå³ EntranceNode ä¹Ÿæ˜¯å›ºå®šçš„</font>ï¼Œè¿™ä¸ªåœ¨å‰é¢å·²ç»å‰§é€äº†

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ ¹èŠ‚ç‚¹å’Œç¬¬ä¸€å±‚èŠ‚ç‚¹éƒ½æ˜¯å›ºå®šçš„ã€‚åªæœ‰ä»ç¬¬äºŒå±‚èŠ‚ç‚¹å¼€å§‹æ‰æ˜¯æˆ‘ä»¬çš„ã€‚

ï¼ˆä¸Šé¢æˆ‘è¯´çš„ â€œç¬¬ä¸€å±‚â€ æ˜¯æŒ‡ROOTèŠ‚ç‚¹ä¸‹çš„ç¬¬ä¸€å±‚ï¼Œåç»­åœ¨æåˆ° EntranceNode æ—¶éƒ½ä¼šæœ‰ â€œç¬¬ä¸€å±‚â€ ä»£ç§°ï¼Œè¯·ä¸è¦è®¤ä¸ºæˆ‘è¯´çš„ç¬¬ä¸€å±‚æ˜¯ROOTğŸ˜ï¼‰

éªŒè¯ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸é›†æˆä»»ä½•ç¯å¢ƒï¼Œé‚£ä¹ˆ ROOT ä¸‹ç¬¬ä¸€ä¸ª EntranceNode å°±ä¸€å®šæ˜¯ sentinel_default_contextã€‚

å°† `abc` å½“ä½œèµ„æºçš„è¯ï¼Œ`abc`å°±ä¼šæ˜¯ sentinel_default_context çš„å­èŠ‚ç‚¹ï¼š

![image-20231128104421747](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231128104421747.png)

ï¼ˆä½¿ç”¨ sentinel-demo/sentinel-demo-basic/flow/FlowQpsDemo æµ‹è¯•ç±»ï¼‰

é›†æˆäº† web mvc æ—¶ï¼ŒROOT çš„å­èŠ‚ç‚¹å°±æœ‰ä¿©äº†ï¼š

![image-20231130111342368](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231130111342368.png)

(ä½¿ç”¨ sentinel-demo/sentinel-demo-spring-webmvc/WebMvcTestController æµ‹è¯•ç±»ï¼Œéœ€è¦è‡ªå·±åŠ ä¸Š Constants.ROOT å» debug)

æ›´æ–°ä¸€ä¸‹èŠ‚ç‚¹æ ‘ï¼š

![image-20231128104011053](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231128104011053.png)

è¿™æ ·åšçš„å¥½å¤„æ˜¯é›†æˆå…¶ä»–ç¯å¢ƒæ—¶å¾ˆæ–¹ä¾¿ï¼Œåå¤„å°±æ˜¯ä¸å¥½ç†è§£

## 4. Entry

åœ¨è®¤è¯† èµ„æº å’Œ èŠ‚ç‚¹ ä¹‹åå°±è¯¥ Entry äº†ï¼ŒEntryæ˜¯ç”± èŠ‚ç‚¹+å¤„ç†å™¨é“¾ ç»„æˆã€‚

Sentinel æä¾›çš„æ˜¯é™æµã€ç†”æ–­åŠŸèƒ½ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯çƒ­ç‚¹é™æµã€ç³»ç»Ÿé™æµã€æ¥æºé™æµ.... è¿™äº›åŠŸèƒ½é€šè¿‡è´£ä»»é“¾æ¨¡å¼ç»„æˆäº†ä¸€ä¸ªå¤„ç†å™¨é“¾ï¼Œç”±äºæ¯ä¸€ä¸ªèµ„æºéƒ½éœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œæ¯ä¸€ä¸ªèµ„æºè¦çš„é™æµè§„åˆ™éƒ½æœ‰å·®åˆ«ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªèµ„æºéƒ½è¦èµ°ä¸€éå¤„ç†å™¨é“¾ï¼ŒSentinel ä½¿ç”¨ Entry å°† èŠ‚ç‚¹å’Œå¤„ç†å™¨é“¾ å°è£…èµ·æ¥ã€‚

åœ¨ Sentinel ä¸­ï¼Œå¤„ç†å™¨é“¾ä¹Ÿå¯ä»¥ç§°ä¸ºè´£ä»»é“¾ã€‚

å¬èµ·æ¥æ˜¯ä¸æ˜¯ç‰¹åˆ«éº»çƒ¦ï¼Ÿç¡®å®ï¼Œè¦åšåˆ°æ¯ä¸€ä¸ªèµ„æºéƒ½è¿›è¡Œé™æµç¡®å®ç‰¹åˆ«éº»çƒ¦ã€‚

```java
public abstract class Entry implements AutoCloseable {
    // åˆ›å»ºæ—¶é—´
    private long createTime;
    // å½“å‰èŠ‚ç‚¹ï¼ˆDefaultNodeï¼‰
    private Node curNode;
    // æ¥æºèŠ‚ç‚¹
    private Node originNode;
    // é”™è¯¯
    private Throwable error;
    // èµ„æºid
    protected ResourceWrapper resourceWrapper;
}
```

CtEntry æ˜¯ Entry çš„ç›´æ¥å­ç±»ï¼Œåé¢åˆ†ææºç æ—¶ï¼Œæˆ‘ä»¬æ‰€è¯´ Entry çš†æŒ‡ CtEntryã€‚CtEntry ä¸­å£°æ˜çš„å­—æ®µä¿¡æ¯å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

```java
class CtEntry extends Entry {
    // å½“å‰ Entry æŒ‡å‘çš„çˆ¶ Entry
    protected Entry parent = null;
    // çˆ¶ Entry æŒ‡å‘å½“å‰ Entry
    protected Entry child = null;
    // å½“å‰èµ„æºçš„ ProcessorSlotChainï¼Œè´£ä»»é“¾æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å¾ˆå¤šæ‹¦æˆªå™¨
    protected ProcessorSlot<Object> chain;
    // å½“å‰ä¸Šä¸‹æ–‡
    protected Context context;
}
```

ä¸ºå•¥ Entry è¦åˆ† parentã€child å…³ç³» ï¼Ÿåœ¨ Node ç« èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº†ï¼Œå¤šä¸ª DefaultNode å¯ä»¥ç»„æˆæ ‘ï¼Œæˆ‘ä»¬ä¸€æ¬¡åªéœ€è¦ç»Ÿè®¡å½“å‰ä¸€æ¡é“¾è·¯çš„ Nodeï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€ä»¥è¿™ä¸ª parent å’Œ child å…¶å®ä¹Ÿå¯ä»¥ç§°ä½œ pre å’Œ nextã€‚

>æœ‰ä¸€ä¸ªç‰¹åˆ«éœ€è¦æ³¨æ„çš„ç‚¹ ï¼šå…¥å£èŠ‚ç‚¹ï¼Œå³ EntranceNode ä¸ä¼šè¢«å°è£…ä¸º Entryã€‚

<font color=blue>Entry æ˜¯ä¸€æ¬¡è°ƒç”¨å½¢æˆçš„è°ƒç”¨é“¾ä¸Šçš„èŠ‚ç‚¹</font>ã€‚

è¿™å¼ å›¾æè¿°äº†å¤šä¸ª Node çš„å…³ç³»

![image-20231127215501416](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127215501416.png)

ç°åœ¨æˆ‘ä»¬å°† A -> B -> F è¿™æ¡è°ƒç”¨é“¾æ¥ç”»ä¸€ä¸‹ Entry

![image-20231127223419303](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231127223419303.png)

ï¼ˆå¤šä¸ªEntryæ˜¯åŒå‘é“¾è¡¨ï¼Œå¤šä¸ªNodeæ˜¯æ ‘ï¼‰

>è¿™é‡Œè¯·ä½ åˆ†æ¸… å¤„ç†å™¨é“¾ å’Œ è°ƒç”¨é“¾ çš„åŒºåˆ«ã€‚
>
>- æ¯ä¸€ä¸ª Entry ç”± Node + å¤„ç†å™¨é“¾ ç»„æˆ
>
>- å¤šä¸ª Entry ç»„æˆä¸€ä¸ªè°ƒç”¨é“¾

Entryæ˜¯å•¥æ—¶å€™åˆ›å»ºçš„ã€æ€ä¹ˆåˆ›å»ºçš„å‘¢ï¼Ÿæ‰€æœ‰çš„èµ„æºéƒ½è¦å°è£…ä¸º Entryï¼Œç„¶ååœ¨Entryå†…éƒ¨çš„å¤„ç†å™¨é“¾ä¸­å°è£…ä¸ºNodeæŒ‚åœ¨æ ‘ä¸Šã€‚

è°ƒç”¨ SphU.entry(String entryName) å³å¯åˆ›å»º Entryã€‚å¦‚æœé›†æˆäº†å…¶ä»–æ¡†æ¶ï¼Œæ¯”å¦‚SpringMVCï¼Œå¯ä»¥ä½¿ç”¨AOPåˆ›å»ºã€‚

SphU.entry(String) æœ€ç»ˆæ‰§è¡Œçš„å¦‚ä¸‹æ–¹æ³•ï¼š

```java
private Entry entryWithPriority(ResourceWrapper resourceWrapper, 
                                int count, 
                                boolean prioritized, 
                                Object... args) throws BlockException {
    // è·å–å½“å‰ä¸Šä¸‹æ–‡
    Context context = ContextUtil.getContext();
    if (context instanceof NullContext) {
        return new CtEntry(resourceWrapper, null, context);
    }
	// å¦‚æœ Context ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ Context. (å³nameä¸º sentinel_default_context çš„Context)
    if (context == null) {
        context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME);
    }

    // 
    if (!Constants.ON) {
        return new CtEntry(resourceWrapper, null, context);
    }
	// åŠ è½½è°ƒç”¨é“¾
    ProcessorSlot<Object> chain = lookProcessChain(resourceWrapper);

    // å¦‚æœåŠ è½½çš„è´£ä»»é“¾ä¸ºç©º
    if (chain == null) {
        return new CtEntry(resourceWrapper, null, context);
    }
	// æ­£å¸¸æƒ…å†µä¸‹ä¸Šé¢çš„ä»£ç éƒ½ä¸ä¼šèµ°åˆ°ï¼Œè¿™é‡Œä¼šçœŸæ­£åˆ›å»ºä¸€ä¸ª CtEntry.
    Entry e = new CtEntry(resourceWrapper, chain, context, count, args);
    try {
        // å¼€å§‹æ‰§è¡Œæ•´ä¸ªè´£ä»»é“¾
        chain.entry(context, resourceWrapper, null, count, prioritized, args);
    } catch (BlockException e1) {
        e.exit(count, args);
        throw e1;
    } catch (Throwable e1) {
        RecordLog.info("Sentinel unexpected exception", e1);
    }
    return e;
}
```

ç°åœ¨ä¸çŸ¥é“Contextæ²¡äº‹ï¼Œä¸‹é¢å°±æ˜¯ã€‚å…¶å®ç›´åˆ° new CtEntry() æ‰æ˜¯é‡ç‚¹ï¼Œnewå‡ºEntryåç›´æ¥æ‰§è¡Œ å¤„ç†å™¨é“¾ï¼Œå¤„ç†å™¨é“¾ä¸­æœ‰å¾ˆå¤šä¸ªå¤„ç†å™¨ï¼Œæœ‰ç»Ÿè®¡èµ„æºçš„ã€é™æµçš„ã€ç†”æ–­çš„...å¦‚æœåœ¨å¤„ç†å™¨é“¾çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°è¢«é™æµã€ç†”æ–­çš„å¼‚å¸¸ï¼Œå°±ä¼šè¢«è¿™ä¸ª BlockException æ•è·ä¸¢å‡ºã€‚ä¸¢å‡ºä¹‹å‰è‚¯å®šè¦å°† Entry é”€æ¯ã€‚

>Entry ä¸ Node çš„åŒºåˆ«æ˜¯å•¥å‘¢ï¼Ÿ
>
>Nodeæ„å»ºä¹‹ååŸºæœ¬ä¸ä¼šåŠ¨äº†ï¼Œé™¤éç¨‹åºé‡å¯å®•æœºå•¥çš„ã€‚
>
>Entryæ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ„å»ºã€‚å¤šä¸ªEntryå°±ç»„æˆäº†ä¸€æ¬¡è°ƒç”¨é“¾

## 5. ä¸Šä¸‹æ–‡ Context

å¾ˆå¤šæ¡†æ¶éƒ½æœ‰ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒSentinel ä¹Ÿä¸ä¾‹å¤–ã€‚Sentinel çš„ ContextUtil ä½¿ç”¨ ThreadLocal æŒæœ‰ Contextï¼ŒContext å­˜å‚¨çš„ä¿¡æ¯åŒ…æ‹¬ ï¼š

```java
public class Context {
    // Contextçš„name
    private final String name;
    // æ­¤æ¬¡æ‰§è¡Œçš„å…¥å£èŠ‚ç‚¹ï¼Œéƒ½æ˜¯å›ºå®šçš„ROOTä¸‹çš„ç¬¬ä¸€å±‚èŠ‚ç‚¹ã€‚
    private DefaultNode entranceNode;
    // ç°åœ¨æ‰§è¡Œåˆ°å“ªä¸ªEntryäº†ã€‚
    private Entry curEntry;
    private String origin = "";
    
    // æˆ‘ä»¬ä¸è®¨è®ºå¼‚æ­¥çš„æƒ…å†µ
    // private final boolean async;
}
```

- nameï¼šContext çš„åç§°ã€‚

- entranceNodeï¼šå½“å‰è°ƒç”¨æ ‘çš„å…¥å£èŠ‚ç‚¹ï¼Œç±»å‹ä¸º EntranceNodeã€‚è¿™ä¸ªNodeæ¯”è¾ƒå›ºå®šï¼Œéƒ½æ˜¯ç¬¬ä¸€å±‚èŠ‚ç‚¹ã€‚

  è¿™ä¸ªèŠ‚ç‚¹è™½ç„¶ä¼šåœ¨ context ä¸­ï¼Œä½†å®ƒä¸ä¼šåœ¨ Entry ä¸­ï¼Œå› ä¸ºä¸å‚ä¸æ‰§è¡Œï¼Œåªå‚ä¸ç»Ÿè®¡ã€‚

- curEntryï¼šå½“å‰ Entryï¼ˆCtEntryï¼‰ï¼Œå†…å«å½“å‰æ‰§è¡Œçš„ node

- originï¼šè°ƒç”¨æ¥æºçš„åç§°ï¼Œå³æœåŠ¡æ¶ˆè´¹è€…çš„åç§°æˆ–è€…æœåŠ¡æ¶ˆè´¹è€…çš„æ¥æº IPï¼Œå–å†³äºæœåŠ¡æ¶ˆè´¹è€…æ˜¯å¦ä½¿ç”¨ Sentinelï¼Œç”± Sentinel é€‚é…å±‚ä¼ é€’è¿‡æ¥ã€‚ä¾‹å¦‚ï¼šæœåŠ¡æä¾›è€…æ˜¯ Spring MVC åº”ç”¨ï¼Œä¸”æœåŠ¡æä¾›è€…ä½¿ç”¨ Sentinel çš„ Web MVC é€‚é…ï¼Œé‚£ä¹ˆ Sentinel ä¼šå°è¯•ä»è¯·æ±‚å¤´è·å–â€S-userâ€ï¼Œå¦‚æœæœåŠ¡æ¶ˆè´¹è€…æœ‰åœ¨è¯·æ±‚å¤´ä¼ é€’è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿè·å–åˆ°ã€‚

```java
public class ContextUtil {
    // æŒæœ‰ Context
    private static ThreadLocal<Context> contextHolder = new ThreadLocal<>();
    // æŒæœ‰æ‰€æœ‰ EntranceNodeï¼Œå³æ‰€æœ‰ç¬¬ä¸€å±‚Node.
    // å¯èƒ½åŒ…å«çš„: defaultã€mvcã€okhttpã€grpcã€dubbo...
    private static volatile Map<String, DefaultNode> contextNameNodeMap = new HashMap<>();
    // å¦‚æœå½“å‰ç¯å¢ƒ(mvcã€dubboã€grpc) è¿˜æ²¡æœ‰æŠŠç¬¬ä¸€å±‚èŠ‚ç‚¹æ³¨å†Œåˆ° contextNameNodeMapï¼Œé‚£ä¹ˆå°±åŠ é”å¼€å§‹æ³¨å†Œ
    private static final ReentrantLock LOCK = new ReentrantLock();
}
```

è¿™é‡Œè¦ç€é‡è¯´ä¸€ä¸‹ contextNameNodeMapã€‚

ContextUtil ä¼šå°†æ‰€æœ‰ç¬¬ä¸€å±‚èŠ‚ç‚¹å­˜å‚¨åœ¨ contextNameNodeMap ä¸­ï¼Œä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªMapé‡Œé¢å­˜å‚¨çš„æ˜¯ä»¥ context.name å‘½åçš„ node

### 5.1 Context çš„åˆ›å»º

å½“ ContextUtil ç±»åŠ è½½çš„æ—¶å€™ä¼šæ‰§è¡Œé™æ€ä»£ç å—ï¼Œåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤çš„EntranceNode ï¼šsentinel_default_context æ”¾å…¥ contextNameNodeMap ä¸­ã€‚

```java
static {
    // Cache the entrance node for default context.
    initDefaultContext();
}

private static void initDefaultContext() {
    String defaultContextName = Constants.CONTEXT_DEFAULT_NAME;
    EntranceNode node = new EntranceNode(new StringResourceWrapper(defaultContextName, EntryType.IN), null);
    // å°†æ­¤å…¥å£èŠ‚ç‚¹æŒ‚åœ¨ ROOT ä¸‹é¢ã€‚
    Constants.ROOT.addChild(node);
    contextNameNodeMap.put(defaultContextName, node);
}
```

æ‰€ä»¥åœ¨å†™ä»£ç çš„æ—¶å€™ contextNameNodeMap ä¸­å°±å·²ç»æœ‰äº†ä¸€ä¸ª EntranceNode äº†ã€‚å½“ç„¶è¿™æ˜¯é¢˜å¤–è¯äº†ï¼Œæˆ‘ä»¬è¦è¯´çš„æ˜¯ Context çš„åˆ›å»ºã€‚è™½ç„¶æŒ‡å®šäº† EntranceNode ä½†æ˜¯å¹¶æœªç»™ EntranceNode åˆ›å»º Entryï¼Œæ‰€ä»¥ EntranceNode ä¸ä¼šå‚ä¸æ‰§è¡Œã€‚

ContextUtil.enter(String contextName) å¯ä»¥åˆ›å»ºä¸€ä¸ª Context

```java
// æ˜¾å¼åˆ›å»º Context
ContextUtil.enter("sentinel_default_context");
Entry entry = null;
try {
     // åˆ›å»ºèµ„æºå¯¹åº”çš„ entry
     entry = SphU.entry("/user/get", EntryType.IN);
     // æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
     return doBusiness();
} catch (Exception e) {
     if (!(e instanceof BlockException)) {
          Tracer.trace(e);
     }
     throw e;
} finally {
     if (entry != null) {
         // é”€æ¯æ­¤entry, ä¼šå°† Context.curEntryæ”¹ä¸ºentry.parent
         entry.exit(1);
     }
     // é”€æ¯ Context
     ContextUtil.exit();
}
```

Context éƒ½æ˜¯ç”± ContextUtil æ˜¾å¼åˆ›å»ºï¼Œ ContextUtil.enter(String contextName) æœ€ç»ˆæ‰§è¡Œçš„é€»è¾‘ ï¼š

```java
// name : ContextName, Contextçš„åç§°
// origin : æ¥æºï¼Œæ¯”å¦‚é€šè¿‡ rpcè°ƒç”¨æ—¶ï¼ŒrpcæœåŠ¡æä¾›è€…çš„originå°±æ˜¯æœåŠ¡è°ƒç”¨è€…
protected static Context trueEnter(String name, String origin) {
    // ä» ContextHolder ä¸­å– Contextï¼Œå¦‚æœå–ä¸åˆ°å°±åˆ›å»ºã€‚
    // è¿™é‡Œä¹Ÿæ˜¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªçœ‹åˆ° Sentinel ä½¿ç”¨åŒé‡æ£€æŸ¥é”æœºåˆ¶ï¼Œåé¢è¿˜ä¼šæœ‰å¾ˆå¤šæ¬¡ã€‚
    Context context = contextHolder.get();
    if (context == null) {
        // contextNameNodeMap æ˜¯æ‹¥æœ‰ç¬¬ä¸€å±‚èŠ‚ç‚¹çš„Map
        // æ¯”å¦‚ sentinel_default_context - EntranceNode
        Map<String, DefaultNode> localCacheNameMap = contextNameNodeMap;
        
        // å¦‚æœæ ¹æ®context name æ— æ³•æ‰¾åˆ°ç¬¬ä¸€å±‚Nodeï¼Œè¯´æ˜å½“å‰ç¯å¢ƒ(mvcã€dubboã€grpc...) è¿˜æ²¡æœ‰æŠŠç¬¬ä¸€å±‚èŠ‚ç‚¹æ³¨å†Œåˆ° contextNameNodeMap
    	// é‚£ä¹ˆå°±åŠ é”å¼€å§‹æ³¨å†Œ
        DefaultNode node = localCacheNameMap.get(name);
        // ç¬¬ä¸€æ¬¡æ£€æŸ¥
        if (node == null) {
            // å¦‚æœç¬¬ä¸€å±‚èŠ‚ç‚¹å¤ªå¤šäº†ï¼Œè¿”å›ä¸€ä¸ª NullContext
            if (localCacheNameMap.size() > Constants.MAX_CONTEXT_NAME_SIZE) {
                setNullContext();
                return NULL_CONTEXT;
            } else {
                // åŠ é”
                LOCK.lock();
                try {
                    node = contextNameNodeMap.get(name);
                    // ç¬¬äºŒæ¬¡
                    if (node == null) {
                        if (contextNameNodeMap.size() > Constants.MAX_CONTEXT_NAME_SIZE) {
                            setNullContext();
                            return NULL_CONTEXT;
                        } else {
                            // è¿™ä¸ªèŠ‚ç‚¹è‚¯å®šæ˜¯å…¥å£èŠ‚ç‚¹
                            node = new EntranceNode(new StringResourceWrapper(name, EntryType.IN), null);
                            // å°†å…¥å£èŠ‚ç‚¹åŠ å…¥åˆ°ROOTä¸‹é¢
                            Constants.ROOT.addChild(node);
							// æ›¿æ¢æ›´æ–°ä¸€ä¸‹contextNameNodeMap
                            Map<String, DefaultNode> newMap = new HashMap<>(contextNameNodeMap.size() + 1);
                            newMap.putAll(contextNameNodeMap);
                            newMap.put(name, node);
                            contextNameNodeMap = newMap;
                        }
                    }
                } finally {
                    LOCK.unlock();
                }
            }
        }
        // ä¸Šé¢çš„é€»è¾‘æ˜¯åˆ›å»ºROOTä¸‹çš„ç¬¬ä¸€å±‚èŠ‚ç‚¹ï¼Œä¸ç®¡æ˜¯å¦éœ€è¦åˆ›å»º EntranceNode ï¼Œåæ­£Context æ˜¯ä¸€å®šè¦çš„ã€‚
        context = new Context(node, name);
        // ä¸€èˆ¬æ¥è¯´ origin ä¸ºç©ºï¼Œä½†æ˜¯åƒè¢«è°ƒç”¨çš„rpcæœåŠ¡ï¼Œoriginå°±æ˜¯è°ƒç”¨æ¥æº
        context.setOrigin(origin);
        // å°†æ­¤contextè®¾ç½®åˆ° ContextHolderä¸­
        contextHolder.set(context);
    }

    return context;
}
```

åˆ›å»ºContextä»æ•´ä½“ä¸Šçœ‹å°±ä¸¤æ­¥ ï¼š

- å¦‚æœè¿™ä¸ªcontextæ²¡æœ‰åœ¨ mapä¸­æ³¨å†Œè¿‡ï¼Œå°±æ³¨å†Œä¸€ä¸‹
- åˆ›å»ºcontextï¼ŒæŒ‡å®šæ­¤ Context çš„ EntranceNode

é‡å¤ï¼Œåˆ›å»º context æ—¶å¹¶æ²¡æœ‰ç»™ EntranceNode åˆ›å»ºå¯¹åº”çš„ Entry å“¦ï¼Œæ‰€ä»¥ EntranceNode ä¸ä¼šå‚ä¸æ‰§è¡Œã€‚

é›†æˆ springmvcæ¡†æ¶æ—¶ï¼ŒSentinel åœ¨ HandlerInterceptor ä¸­åˆ›å»º Context ï¼šç›¸åº”çš„ä»£ç åœ¨ sentinel-adapter/sentinel-spring-webmvc-adapterä¸­

```java
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    // é€šè¿‡å­ç±»çš„å®ç°ï¼Œè·å–èµ„æºåï¼Œå¦‚ "/user/{id}"
    String resourceName = getResourceName(request);
    // å¯¹èµ„æºåè¿›è¡Œåˆ¤ç©ºå•¥çš„æ“ä½œï¼Œçœç•¥æ‰ç›´æ¥è¿›å…¥æ ¸å¿ƒä»£ç 

    // è§£æè°ƒç”¨æ¥æº
    String origin = parseOrigin(request);
    // è·å–context name, å¼€å§‹åˆ›å»ºä¸Šä¸‹æ–‡
    String contextName = "sentinel_spring_web_context";
    ContextUtil.enter(contextName, origin);
    // åˆ›å»ºEntry
    Entry entry = SphU.entry(resourceName, ResourceTypeConstants.COMMON_WEB, EntryType.IN);
    // å°†entryæ”¾å…¥è¯·æ±‚åŸŸä¸­ï¼Œä»¥ä¾¿åœ¨ afterCompletion ä¸­ä½¿ç”¨
    request.setAttribute(baseWebMvcConfig.getRequestAttributeName(), entry);
    return true;
}
```

æ€»ç»“ä¸€ä¸‹ ï¼š

- ROOT å¹¶ä¸å‚ä¸ Context çš„æ„å»ºï¼Œä¹Ÿä¸å‚ä¸Entryçš„æ‰§è¡Œã€‚
- EntranceNode å‚ä¸ Context çš„åˆ›å»ºï¼Œä½†æ˜¯ EntranceNode ä¸ä¼šå‚ä¸ Entry çš„æ‰§è¡Œ
- Entry æ˜¯è°ƒç”¨é“¾

ç°åœ¨æˆ‘ä»¬çš„Nodeæ ‘å°±å¯ä»¥å˜ä¸ºè¿™æ · ï¼š

![image-20231130145348947](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231130145348947.png)

## 6. æ’æ§½ ProcessorSlot

ProcessorSlot ç›´è¯‘å°±æ˜¯å¤„ç†å™¨æ’æ§½ï¼Œæ˜¯ Sentinel å®ç°é™æµé™çº§ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè‡ªé€‚åº”é™çº§ç­‰åŠŸèƒ½çš„åˆ‡å…¥ç‚¹ã€‚Sentinel æä¾›çš„ ProcessorSlot å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯è¾…åŠ©å®Œæˆèµ„æºæŒ‡æ ‡æ•°æ®ç»Ÿè®¡çš„åˆ‡å…¥ç‚¹ï¼Œä¸€ç±»æ˜¯å®ç°é™çº§åŠŸèƒ½çš„åˆ‡å…¥ç‚¹ã€‚

è¾…åŠ©èµ„æºæŒ‡æ ‡æ•°æ®ç»Ÿè®¡çš„ ProcessorSlotï¼š

- NodeSelectorSlotï¼šä¸ºå½“å‰èµ„æºåˆ›å»º DefaultNodeï¼Œå¹¶ä¸”å°† DefaultNode èµ‹å€¼ç»™ Context.curEntry.curNodeï¼›

  å¦‚æœæ­¤ DefaultNode æ˜¯å½“å‰è°ƒç”¨é“¾è·¯ä¸Šç¬¬äºŒä¸ªNodeï¼ˆå› ä¸ºç¬¬ä¸€ä¸ª Node æ˜¯å›ºå®šçš„ï¼‰ï¼Œå°†è¯¥ DefaultNode æ·»åŠ åˆ°çš„ Context.entranceNode çš„å­èŠ‚ç‚¹ï¼Œå¦åˆ™æ·»åŠ åˆ° Context.curEntry.parent çš„å­èŠ‚ç‚¹ï¼ˆchildListï¼‰ã€‚æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬åœ¨åˆ†æ NodeSelectorSlot æºç æ—¶å†è¯¦ç»†ä»‹ç»ã€‚

- ClusterBuilderSlotï¼šå¦‚æœå½“å‰èµ„æºæœªåˆ›å»º ClusterNodeï¼Œåˆ™ä¸ºèµ„æºåˆ›å»º ClusterNodeï¼›å°† ClusterNode èµ‹å€¼ç»™å½“å‰èµ„æºçš„ DefaultNode.clusterNodeï¼›å¦‚æœè°ƒç”¨æ¥æºï¼ˆoriginï¼‰ä¸ä¸ºç©ºï¼Œåˆ™ä¸ºè°ƒç”¨æ¥æºåˆ›å»º StatisticNodeï¼Œç”¨äºå®ç°æŒ‰è°ƒç”¨æ¥æºç»Ÿè®¡èµ„æºçš„æŒ‡æ ‡æ•°æ®ï¼ŒClusterNode æŒæœ‰æ¯ä¸ªè°ƒç”¨æ¥æºçš„ StatisticNodeã€‚

- StatisticSlotï¼šè¿™æ˜¯ Sentinel æœ€ä¸ºé‡è¦çš„ç±»ä¹‹ä¸€ï¼Œç”¨äºå®ç°æŒ‡æ ‡æ•°æ®ç»Ÿè®¡ã€‚å…ˆæ˜¯è°ƒç”¨åç»­çš„ ProcessorSlot#entry åˆ¤æ–­æ˜¯å¦æ”¾è¡Œè¯·æ±‚ï¼Œå†æ ¹æ®åˆ¤æ–­ç»“æœè¿›è¡Œç›¸åº”çš„æŒ‡æ ‡æ•°æ®ç»Ÿè®¡æ“ä½œã€‚

å®ç°é™çº§åŠŸèƒ½çš„ ProcessorSlotï¼š

- AuthoritySlotï¼šå®ç°é»‘ç™½åå•é™çº§
- SystemSlotï¼šå®ç°ç³»ç»Ÿè‡ªé€‚åº”é™çº§
- FlowSlotï¼šå®ç°é™æµé™çº§
- DegradeSlotï¼šå®ç°ç†”æ–­é™çº§

Sentinel ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼å°†è¿™äº›æ’æ§½ç»„æˆäº†æ‹¦æˆªå™¨é“¾æ¡ï¼Œä¹‹å‰æˆ‘ä»¬ç§° ProcessorSlot ä¸ºæ‹¦æˆªå™¨ï¼Œç°åœ¨è¦æ”¹å£ä¸ºæ’æ§½äº†

- ProcessorSlot ï¼šæ’æ§½ï¼Œæ¯ä¸€ä¸ªæ’æ§½æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç³»ç»Ÿé™æµã€é»‘ç™½åå•é™æµã€ç†”æ–­é™çº§ã€‚
- ProcessorSlotChain ï¼šå†…å«å¤´æ’æ§½å’Œå°¾æ’æ§½ï¼Œå°†æ‰€æœ‰æ’æ§½ç»„æˆæ’æ§½é“¾æ‰§è¡Œã€‚

å…³äºæ¯ä¸ª ProcessorSlot æ˜¯å¦‚ä½•ç»„æˆé“¾è¡¨ã€å¦‚ä½•å®ç°çš„åŠŸèƒ½ï¼Œå°†åœ¨åç»­æ–‡ç« è¯¦ç»†åˆ†æã€‚