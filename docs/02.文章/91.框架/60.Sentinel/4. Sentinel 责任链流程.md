---
title:  2. Sentinel è´£ä»»é“¾æµç¨‹
date: 2023-11-29 16:10:15
permalink: /pages/51db55/
---
## 1. ç®€è¿°

åœ¨ä¸Šä¸€ç¯‡ä¸­è¯¦ç»†ä»‹ç»äº† Sentinel ä¸­çš„å‡ ä¸ªæ ¸å¿ƒç±»ï¼Œåˆç®€å•è¯´äº†ä¸€ä¸‹ Sentinel çš„æ’æ§½ã€‚

è¿™ä¸€ç¯‡ä¼šç¨å¾®è¯¦ç»†çš„è®²è§£æ’æ§½ï¼Œä¼šä»æ•´ä½“ä¹Ÿå°±æ˜¯è´£ä»»é“¾æ¨¡å¼å…¥æ‰‹ä»‹ç» Sentinel å·¥ä½œçš„æµç¨‹ï¼Œä½†ä¸ä¼šå•ç‹¬è®²è§£æŸä¸€ä¸ªæ’æ§½çš„ç”¨å¤„ã€‚

å›å¿†ä¸€ä¸‹ä¸Šä¸€ç¯‡æœ‰å…³æ’æ§½ ProcessorSlot çš„çŸ¥è¯†ç‚¹ ï¼š

Sentinel ä½¿ç”¨ è´£ä»»é“¾æ¨¡å¼å°†æ‰€æœ‰çš„ ProcessorSlot æŒ‰ç…§ä¸€å®šçš„é¡ºåºä¸²æˆä¸€ä¸ªé“¾è¡¨ã€‚ProcessorSlot å…±åˆ†ä¸ºä¸¤ç±»ï¼š

1. ç»Ÿè®¡æ•°æ®ï¼Œè¿™ç§ ProcessorSlor æ˜¯æœ‰ä¸¥æ ¼çš„é¡ºåºåŒºåˆ†çš„ï¼Œä¸èƒ½æ›´æ”¹ã€‚

   NodeSelectorSlot

   ClusterBuilderSlot

   StatisticSlot

2. é™æµ/ç†”æ–­ï¼Œè¿™ç§ ProcessorSlot æ²¡æœ‰ä¸¥æ ¼ä¸¥æ ¼çš„é¡ºåºè¦æ±‚ï¼Œå¯ä»¥æŒ‰éœ€è°ƒæ•´ã€‚

   AuthoritySlot

   SystemSlot

   FlowSlot

   DegradeSlot

ProcessorSlotChain ï¼šå†…å«ProcessorSlotå¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œå¯ä»¥è§¦å‘æ•´ä¸ªæ’æ§½é“¾çš„æ‰§è¡Œã€‚

SlotChainBuilder ï¼šå°† ProcessorSlot ç»„è£…èµ·æ¥å½¢æˆ ProcessorSlotChain å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚

æ¥ä¸‹æ¥è¯¦ç»†è¯´è¯´ Sentinel çš„å·¥ä½œæµç¨‹

## 2. ProcessorSlot

ProcessorSlot æ˜¯ä¸€ä¸ªæ¥å£

```java
public interface ProcessorSlot<T> {

  	// å®ç°è‡ªå·±çš„ä¸šåŠ¡æ–¹æ³•
    void entry(Context context, ResourceWrapper resourceWrapper, T param, int count, boolean prioritized, Object... args) throws Throwable;

    // è§¦å‘ä¸‹ä¸€ä¸ªslotçš„ä¸šåŠ¡æ–¹æ³•
    void fireEntry(Context context, ResourceWrapper resourceWrapper, Object obj, int count, boolean prioritized, Object... args) throws Throwable;

	// å®ç°è‡ªå·±çš„é€€å‡ºæ–¹æ³•
    void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args);

    // è§¦å‘ä¸‹ä¸€ä¸ªslotçš„é€€å‡ºæ–¹æ³•
    void fireExit(Context context, ResourceWrapper resourceWrapper, int count, Object... args);
}
```

- context ï¼šå½“å‰è°ƒç”¨é“¾è·¯ä¸Šä¸‹æ–‡
- resourceWrapper ï¼šèµ„æº
- param ï¼šæ³›å‹å‚æ•°ï¼Œä¸€èˆ¬ç”¨äºä¼ é€’ DefaultNode
- count ï¼šç”³è¯·è®¿é—®èµ„æºçš„æ•°é‡ï¼Œæ¯”å¦‚è®¿é—®é‡ã€å ç”¨çº¿ç¨‹æ•°é‡ï¼Œcount ä¸€èˆ¬ä¸º1
- prioritized ï¼šæ˜¯å¦å¯¹è¯·æ±‚è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œä¸€èˆ¬ä¸ºfalse
- args ï¼šè°ƒç”¨æ–¹æ³•çš„å‚æ•°ï¼Œç”¨äºå®ç°çƒ­ç‚¹å‚æ•°é™æµ

è¿™é‡Œä½ å°±ä¼šæœ‰äº›ç–‘æƒ‘ï¼ŒæŒ‰ç…§è´£ä»»é“¾æ¨¡å¼ï¼ŒProcessorChain åº”è¯¥æœ‰ä¸€ä¸ª next å˜é‡ç”¨äºä¸²èµ·æ¥æ‰€æœ‰ ProcessorChain å•Šï¼Œä½†æ˜¯æ­¤å¤„å¹¶æ²¡æœ‰ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰æä¾›`æ·»åŠ ä¸‹ä¸€ä¸ªslot`ã€`è§¦å‘ä¸‹ä¸€ä¸ªslot`è¿™äº›æ–¹æ³•ï¼Œä¸è¦æ…Œï¼Œå…¶å®è¿™äº›ä¸œè¥¿åœ¨ ProcessorSlot çš„å®ç°ç±»ä¸­ ï¼šAbstractLinkedProcessorSlot

ä¹‹æ‰€ä»¥èƒ½å¤Ÿå°†æ‰€æœ‰çš„ ProcessorSlot æ„é€ æˆä¸€ä¸ª ProcessorSlotChainï¼Œè¿˜æ˜¯ä¾èµ– AbstractLinkedProcessorSlot ç±»ã€‚

æ¯ä¸ª AbstractLinkedProcessorSlot ç±»éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ª AbstractLinkedProcessorSlot çš„å­—æ®µï¼Œæ­£æ˜¯è¿™ä¸ªå­—æ®µå°† ProcessorSlot ä¸²æˆä¸€æ¡å•å‘é“¾è¡¨ã€‚AbstractLinkedProcessorSlot éƒ¨åˆ†æºç å¦‚ä¸‹ã€‚

```java
public abstract class AbstractLinkedProcessorSlot<T> implements ProcessorSlot<T> {
    // å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    private AbstractLinkedProcessorSlot<?> next = null;

    public void setNext(AbstractLinkedProcessorSlot<?> next) {
        this.next = next;
    }
    @Override
    public void fireEntry(Context context, 
                          ResourceWrapper resourceWrapper, 
                          Object obj, 
                          int count, 
                          boolean prioritized, 
                          Object... args) throws Throwable {
        if (next != null) {
            T t = (T) obj; 
            // è°ƒç”¨ä¸‹ä¸€ä¸ª ProcessorSlot çš„ entry æ–¹æ³•
            next.entry(context,resourceWrapper,t,count,prioritized,args);
        }
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸ä»…æä¾›äº† setNext() æ–¹æ³•ç”¨äºæ·»åŠ æ­¤slotçš„ä¸‹ä¸€ä¸ªslotï¼Œè¿˜æä¾›äº† fireEntry() è§¦å‘ä¸‹ä¸€ä¸ªslotã€‚

åˆ°æ—¶å€™æˆ‘ä»¬å®ç°çš„æ—¶å€™åªéœ€è¦è¿™æ ·ï¼š

```java
public class MySlot extends AbstractLinkedProcessorSlot<DefaultNode> {

    @Override
    public void entry(Context context, 
                      ResourceWrapper resourceWrapper, 
                      DefaultNode node, 
                      int count, 
                      boolean prioritized, 
                      Object... args) throws Throwable {
        // æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡æ–¹æ³•...
        
        
        // æ‰§è¡Œç»“æŸï¼Œè§¦å‘ä¸‹ä¸€ä¸ªslotçš„ä¸šåŠ¡æ–¹æ³•
        fireEntry(context, resourceWrapper, node, count, prioritized, args);
    }
}
```

## 3. ProcessorSlotChain

æ ¹æ®è´£ä»»é“¾æ¨¡å¼çš„ä¸€èˆ¬å®ç°æ–¹å¼ï¼Œè¿™ä¸ª Chain ä¼šæŒæœ‰æ‰€æœ‰çš„slotï¼ŒSentinel çš„å®ç°æ–¹å¼æ˜¯æŒæœ‰å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ã€‚

ï¼ˆOkHttpçš„å®ç°æ–¹å¼æ˜¯æŒæœ‰æ•´ä¸ªListï¼‰

```java
public class DefaultProcessorSlotChain extends ProcessorSlotChain {

    // è™šæ‹Ÿå¤´èŠ‚ç‚¹
    AbstractLinkedProcessorSlot<?> first = new AbstractLinkedProcessorSlot<Object>() {
		// å¯ä»¥çœ‹åˆ°å¤´èŠ‚ç‚¹å¹¶æ²¡æœ‰è‡ªå·±çš„ä¸šåŠ¡éœ€è¦å®ç°ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨ fireEntry è§¦å‘next.entry
        @Override
        public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, boolean prioritized, Object... args)
            throws Throwable {
            super.fireEntry(context, resourceWrapper, t, count, prioritized, args);
        }

        @Override
        public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {
            super.fireExit(context, resourceWrapper, count, args);
        }

    };
    // å°¾èŠ‚ç‚¹
    AbstractLinkedProcessorSlot<?> end = first;

    // å¤´æ’æ³•
    @Override
    public void addFirst(AbstractLinkedProcessorSlot<?> protocolProcessor) {
        protocolProcessor.setNext(first.getNext());
        first.setNext(protocolProcessor);
        if (end == first) {
            end = protocolProcessor;
        }
    }

    // å°¾æ’æ³•
    @Override
    public void addLast(AbstractLinkedProcessorSlot<?> protocolProcessor) {
        end.setNext(protocolProcessor);
        end = protocolProcessor;
    }

    @Override
    public void setNext(AbstractLinkedProcessorSlot<?> next) {
        addLast(next);
    }

    @Override
    public AbstractLinkedProcessorSlot<?> getNext() {
        return first.getNext();
    }
	// entryæ–¹æ³•ï¼Œè°ƒç”¨ first.transformEntry()ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° first.entryï¼Œ
    // first.entryæ²¡æœ‰è‡ªå·±çš„ä¸šåŠ¡ï¼Œç›´æ¥è§¦å‘first.next.entry()
    @Override
    public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, boolean prioritized, Object... args)
        throws Throwable {
        first.transformEntry(context, resourceWrapper, t, count, prioritized, args);
    }

    @Override
    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {
        first.exit(context, resourceWrapper, count, args);
    }
}
```

ä½¿ç”¨ ProcessorSlotChain.entry() å³å¯è§¦å‘æ•´ä¸ªé“¾æ¡ã€‚

## 4. SlotChainBuilder

æ ¹æ®è´£ä»»é“¾æ¨¡å¼çš„ä¸€èˆ¬å®ç°æ–¹å¼ï¼Œæ„é€  slot é“¾æ¡è¿™ä»¶äº‹ä¸ä¼šæš´éœ²ç»™ç”¨æˆ·çš„ï¼Œæ‰€ä»¥ Sentintl ä½¿ç”¨ SlotChainBuilder æ„é€  ProcessorSlotChain å¹¶è¿”å›ã€‚

```java
@Spi(isDefault = true)
public class DefaultSlotChainBuilder implements SlotChainBuilder {

    @Override
    public ProcessorSlotChain build() {
        ProcessorSlotChain chain = new DefaultProcessorSlotChain();

        List<ProcessorSlot> sortedSlotList = SpiLoader.of(ProcessorSlot.class).loadInstanceListSorted();
        for (ProcessorSlot slot : sortedSlotList) {
            if (!(slot instanceof AbstractLinkedProcessorSlot)) {
                RecordLog.warn("The ProcessorSlot(" + slot.getClass().getCanonicalName() + ") is not an instance of AbstractLinkedProcessorSlot, can't be added into ProcessorSlotChain");
                continue;
            }
            chain.addLast((AbstractLinkedProcessorSlot<?>) slot);
        }

        return chain;
    }
}
```

ä½†æ˜¯æ‰“çœ¼ä¸€çœ‹æ²¡è¿™ä¹ˆç®€å•ï¼å¹¶æ²¡æœ‰æˆ‘ä»¬æƒ³è±¡çš„ new äº†å¾ˆå¤š slot ç„¶åä¸€ä¸ªä¸€ä¸ª add è¿›å»ï¼Œè€Œæ˜¯ä½¿ç”¨ SpiLoader åŠ è½½ã€‚è¿™æ˜¯ Java SPI æœºåˆ¶ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢ä¼šä»‹ç»ï¼Œè¿™é‡Œå°±ä¸‘é™‹ä¸€ç‚¹ä¸€ä¸ªä¸€ä¸ªnewå‡ºæ¥ğŸ˜

æˆ‘æ‰‹åŠ¨ new çš„å“ˆï¼Œæºç é‡Œé¢æ²¡æœ‰

```java
public class DefaultSlotChainBuilder implements SlotChainBuilder {
    @Override
    public ProcessorSlotChain build() {
        ProcessorSlotChain chain = new DefaultProcessorSlotChain();
        
        chain.addLast(new NodeSelectorSlot());
        chain.addLast(new ClusterBuilderSlot());
        chain.addLast(new LogSlot());
        chain.addLast(new StatisticSlot());
        chain.addLast(new AuthoritySlot());
        chain.addLast(new SystemSlot());
        chain.addLast(new FlowSlot());
        chain.addLast(new DegradeSlot());
        chain.addLast(new DefaultCircuitBreakerSlot());
        
        return chain;
    }
}
```

## 5. æ€»ç»“

1. ProcessorSlotChain ï¼š
   - <font color=Blue>firstSlot</font> ï¼šfirst.entryæ–¹æ³•ç›´æ¥è°ƒç”¨fireEntryæ–¹æ³•
   - <font color=Blue>endSlot</font>
   - <font color=Bule>entry()</font> ï¼šè°ƒç”¨firstSlotçš„entryæ–¹æ³•
2. ProcessorSlot
   - <font color=Blue>nextSlot</font>
   - <font color=Bule>entry()</font> ï¼šæ‰§è¡Œå®Œè‡ªå·±çš„ä¸šåŠ¡åæ‰§è¡Œ fireEntry()
   - <font color=Bule>fireEntry() </font>ï¼šæ‰§è¡Œ next.entry()

æ€»æµç¨‹ ï¼š

1. ä½¿ç”¨ SlotChainBuilder åˆ›å»º ProcessorSlotChain
2. ä½¿ç”¨ ProcessorSlotChain.entry() æ–¹æ³•å¯ä»¥æ‰§è¡Œæ•´æ¡æ’æ§½é“¾ ï¼š
   -  è°ƒç”¨ firstSlot.entryï¼ŒfirstSlot.entry() ä¸­ç›´æ¥æ‰§è¡Œ fireEntry æ–¹æ³•å»æ‰§è¡Œä¸‹ä¸€ä¸ª slot.entry()
3. ä¸‹ä¸€ä¸ª slot.entry() æ‰§è¡Œå®Œè‡ªå·±çš„ä¸šåŠ¡æ–¹æ³•åï¼Œè°ƒç”¨ fireEntry() å»æ‰§è¡Œä¸‹ä¸€ä¸ª slot.entry()
4. ....
5. ....

## 6. Sentinel ä¸­çš„ SPI æœºåˆ¶

### 1. ä»€ä¹ˆæ˜¯ SPI

SPI å…¨ç§°æ˜¯ Service Provider Interfaceï¼Œç›´è¯‘å°±æ˜¯æœåŠ¡æä¾›è€…æ¥å£ï¼Œæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œæ˜¯ Java çš„ä¸€ä¸ªå†…ç½®æ ‡å‡†ï¼Œå…è®¸ä¸åŒçš„å¼€å‘è€…å»å®ç°æŸä¸ªç‰¹å®šçš„æœåŠ¡ã€‚SPI çš„æœ¬è´¨æ˜¯å°†æ¥å£å®ç°ç±»çš„å…¨é™å®šåé…ç½®åœ¨æ–‡ä»¶ä¸­ï¼Œç”±æœåŠ¡åŠ è½½å™¨è¯»å–é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å®ç°ç±»ï¼Œå®ç°åœ¨è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢æ¥å£çš„å®ç°ç±»ã€‚

ä½¿ç”¨ SPI æœºåˆ¶èƒ½å¤Ÿå®ç°æŒ‰é…ç½®åŠ è½½æ¥å£çš„å®ç°ç±»ï¼ŒSPI æœºåˆ¶åœ¨é˜¿é‡Œå¼€æºçš„é¡¹ç›®ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä¾‹å¦‚ Dubboã€RocketMQã€ä»¥åŠæœ¬æ–‡ä»‹ç»çš„ Sentinelã€‚RocketMQ ä¸ Sentinel ä½¿ç”¨çš„éƒ½æ˜¯ Java æä¾›çš„ SPI æœºåˆ¶ï¼Œè€Œ Dubbo åˆ™æ˜¯ä½¿ç”¨è‡ªå®ç°çš„ä¸€å¥— SPIï¼Œä¸ Java SPI çš„é…ç½®æ–¹å¼ä¸åŒï¼ŒDubbo SPI ä½¿ç”¨ Key-Value æ–¹å¼é…ç½®ï¼Œç›®çš„æ˜¯å®ç°è‡ªé€‚åº”æ‰©å±•æœºåˆ¶ã€‚

Java çš„ SPI æœºåˆ¶æä¾›äº† ServiceLoader.load(Class<?> clazz) ç”¨äºåŠ è½½æŒ‡å®šç±»çš„å®ç°ç±»ã€‚å®ƒåŠ è½½æ–‡ä»¶çš„è·¯å¾„ä¸ºï¼š

`resource/META-INF/services/${æ¥å£çš„å…¨é™å®šç±»å}`.

åœ¨æ–‡ä»¶ä¸­ä¹Ÿè¦å¡«æ¥å£çš„å®ç°ç±»çš„å…¨é™å®šç±»åï¼ŒJavaå°†å…¨éƒ¨çš„å®ç°ç±»è¿”å›ç»™ç”¨æˆ· ï¼š

```java
com.xiaohe.xxxxxx
```

```java
ServiceLoader<T> services = ServiceLoader.load(Class<T> clazz);
```

åŠ è½½æ­¥éª¤ä¸º ï¼š

- æŒ‡å®š ServiceLoader.load(Class<T> clazz)
- é€šè¿‡ clazz æ‹¿åˆ°æ¥å£çš„å…¨é™å®šç±»åï¼Œå» `resource/META-INF/services`ç›®å½•ä¸‹å¯»æ‰¾å¯¹åº”å…¨é™å®šç±»åçš„æ–‡ä»¶
- è¯»å–è¯¥æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ï¼ˆæ¯ä¸€ä¸ªå†…å®¹ä»¥æ¢è¡Œç¬¦åˆ†éš”ï¼‰
- ä»¥é›†åˆçš„å½¢å¼è¿”å›ç»™ç”¨æˆ·

### 2. ä½¿ç”¨Javaçš„SPIæœºåˆ¶

å‡è®¾æœ‰å¾ˆå¤šç§ç™»å½•æ–¹å¼ï¼Œæ‰€ä»¥ç™»å½•æ¥å£ï¼š

```java
public interface LoginService{
  void login(String username,String password);
}
```

æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š

```java
public class ShiroLogin implements LoginService{
    @Override
    public void login(String username, String password) {
        System.out.println("è§¦å‘ Shiro çš„ç™»å½•åŠŸèƒ½");
    }
}
```

```java
public class SpringSecurityLogin implements LoginService{
    @Override
    public void login(String username, String password) {
        System.out.println("è§¦å‘ SpringSecurity çš„ç™»å½•åŠŸèƒ½");
    }
}
```

åœ¨ `resource/META-INF/services` ç›®å½•ä¸‹åˆ›å»ºåä¸º `com.xiaohe.spi.LoginService` ï¼ˆæ¥å£å…¨é™å®šç±»åï¼‰çš„æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­å¡«å…¥ï¼š

```markdown
com.xiaohe.spi.SpringSecurityLogin
```

æ„ä¸ºåªåŠ è½½ SpringSecurityLogin çš„ç™»é™†æ–¹å¼ã€‚å½“ç„¶ä¹Ÿå¯ä»¥å¡«å¥½å‡ ä¸ªï¼Œå¤šä¸ªä¹‹é—´ä½¿ç”¨æ¢è¡Œåˆ†å¼€ã€‚

ç¼–å†™æµ‹è¯•ç±»ï¼š

```java
public static void main(String[] args) {
    ServiceLoader<LoginService> services = ServiceLoader.load(LoginService.class);
    
    services.forEach(loginService -> {
        loginService.login("å°æ˜", "123");
    });
}
```

æ‰“å° ï¼š

```markdown
è§¦å‘ SpringSecurity çš„ç™»å½•åŠŸèƒ½
```

### 3. Sentinel ä½¿ç”¨ SPI æœºåˆ¶åšäº†ä»€ä¹ˆ

æƒ³çŸ¥é“å“ªé‡Œä½¿ç”¨åˆ°äº† SPIï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯å» `resource/META-INF/services`ç›®å½•ä¸‹æŸ¥çœ‹æœ‰å¤šå°‘ä»¥å…¨é™å®šç±»åå‘½åçš„æ–‡ä»¶ï¼ŒSentinel1.8.1 ç‰ˆæœ¬æœ‰ä¸‰ä¸ªï¼š

![image-20231128214014089](https://typorehwf.oss-cn-chengdu.aliyuncs.com/image-20231128214014089.png)

ç¬¬ä¸€ä¸ªæ²¡è§è¿‡æš‚æ—¶ä¸è¯´ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå°±å¾ˆæ˜æ˜¾äº†å§ã€‚

ä½¿ç”¨SPIæœºåˆ¶åŠ è½½ ProcessorSlot çš„ç›®çš„ ï¼šå¯ä»¥åœ¨æ–‡ä»¶ä¸­è‡ªå®šä¹‰ slot çš„æ‰§è¡Œé¡ºåºã€‚

ä½¿ç”¨SPIæœºåˆ¶åŠ è½½ ProcessorSlotChain çš„ç›®çš„ ï¼šå¯ä»¥åœ¨ä»£ç ä¸­è‡ªå®šä¹‰ slot çš„æ‰§è¡Œé¡ºåºã€‚

å†æ¥ç¥ä¸€çœ¼ Sentinel ä¸­ DefaultSlotChainBuilder æ„å»º ProcessorSlotChain çš„è¿‡ç¨‹ ï¼š

```java
@Spi(isDefault = true)
public class DefaultSlotChainBuilder implements SlotChainBuilder {

    @Override
    public ProcessorSlotChain build() {
        ProcessorSlotChain chain = new DefaultProcessorSlotChain();

        List<ProcessorSlot> sortedSlotList = SpiLoader.of(ProcessorSlot.class).loadInstanceListSorted();
        for (ProcessorSlot slot : sortedSlotList) {
            // æ‰€æœ‰ slot å¿…é¡»æ˜¯ AbstractLinkedProcessorSlot çš„å­ç±»
            if (!(slot instanceof AbstractLinkedProcessorSlot)) {
                // æ‰“æ—¥å¿—çš„ä»£ç æˆ‘åˆ äº†
                continue;
            }
            chain.addLast((AbstractLinkedProcessorSlot<?>) slot);
        }

        return chain;
    }
}
```

å†æ¥çœ‹çœ‹ `resource/META-INF/services/ProcessorSlot` æ–‡ä»¶ä¸­çš„å†…å®¹ ï¼š

```markdown
com.alibaba.csp.sentinel.slots.nodeselector.NodeSelectorSlot
com.alibaba.csp.sentinel.slots.clusterbuilder.ClusterBuilderSlot
com.alibaba.csp.sentinel.slots.logger.LogSlot
com.alibaba.csp.sentinel.slots.statistic.StatisticSlot
com.alibaba.csp.sentinel.slots.block.authority.AuthoritySlot
com.alibaba.csp.sentinel.slots.system.SystemSlot
com.alibaba.csp.sentinel.slots.block.flow.FlowSlot
com.alibaba.csp.sentinel.slots.block.degrade.DegradeSlot
com.alibaba.csp.sentinel.slots.block.degrade.DefaultCircuitBreakerSlot
```

è·Ÿæˆ‘ä¹‹å‰æ‰‹åŠ¨ new çš„æ‰§è¡Œé¡ºåºä¸€æ ·ã€‚åç»­æ–‡ç« å°±ä¼šå¯¹è¿™äº› slot æŒ¨ä¸ªè®²è§£ã€‚